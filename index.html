<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶Æ‡¶ø‡¶∞‡¶æ‡¶ï‡¶≤ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</title>
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">
    
    <!-- SheetJS CDN for Excel Import -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- FIREBASE SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>

    <style>
        @font-face {
            font-family: 'Kalpurush';
            src: url('fonts/kalpurush.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        :root {
            --bg-main: #e8f5e9; --bg-section: #ffffff; --bg-header: #00695c; --bg-tab-container: var(--bg-main); --bg-tab: #e8f5e9; --bg-tab-active: #ffffff; --bg-input: #f1f8e9; --bg-input-disabled: #f5f5f5; --bg-subtle: #f1f8e9; --bg-scrollable: #ffffff; --bg-hover: #dcedc8; --bg-footer: #00695c; --text-primary: #212121; --text-secondary: #757575; --text-header: #ffffff; --text-tab: #424242; --text-tab-active: #ff9f43; --text-input-disabled: #bdbdbd; --text-footer: #e0f2f1; --text-footer-dev: #b2dfdb; --border-color: #e0e0e0; --border-accent: #ff9f43; --border-tab-active: #ffffff; --paid-color: rgba(46, 213, 115, 0.15); --due-color: rgba(255, 107, 107, 0.15); --paid-text: #27ae60; --due-text: #e74c3c; --not-applicable-color: #f5f5f5; --not-applicable-text: #9e9e9e; --toast-success-bg: #27ae60; --toast-error-bg: #e74c3c; --toast-info-bg: #3498db; --future-text: #6c757d;
        }
        
        body[data-theme='dark'] {
            --bg-main: #121212; --bg-section: #1e1e1e; --bg-header: #1f2b38; --bg-tab-container: #121212; --bg-tab: #2a2a2a; --bg-tab-active: #1e1e1e; --bg-input: #252525; --bg-input-disabled: #3a3a3a; --bg-scrollable: #1e1e1e; --bg-hover: #333333; --bg-footer: #1f2b38; --text-primary: #e8eaed; --text-secondary: #9aa0a6; --text-header: #e8eaed; --text-tab: #e8eaed; --text-tab-active: #ff9f43; --text-input-disabled: #888888; --text-footer: #e8eaed; --text-footer-dev: #9aa0a6; --border-color: #3a3a34; --border-accent: #ff9f43; --border-tab-active: #1e1e1e; --paid-color: #143d26; --due-color: #4a1c21; --paid-text: #a3d9a5; --due-text: #f5c6cb; --not-applicable-color: #2c2c2c; --not-applicable-text: #666666;
        }
        
        html { scroll-behavior: smooth; }
        body {
            margin: 0; padding: 0; font-family: 'Kalpurush', sans-serif; font-size: 16px; background-color: var(--bg-main); color: var(--text-primary); transition: background-color .3s, color .3s; line-height: 1.5;
        }

        /* Login Styles */
        #login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; box-sizing: border-box; background-color: var(--bg-main); }
        .login-box { background-color: var(--bg-section); padding: 25px; border-radius: 5px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; border: 1px solid var(--border-color); }
        .login-box h1 { font-size: 1.3em; margin-bottom: 15px; }
        .login-logo { width: 100px; height: 100px; margin: 0 auto 20px; }
        .input-group { position: relative; margin-bottom: 15px; }
        .input-group input { width: 100%; padding: 12px 15px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 1em; background-color: var(--bg-input); color: var(--text-primary); box-sizing: border-box; }
        .password-toggle-icon { position: absolute; top: 50%; right: 12px; transform: translateY(-50%); cursor: pointer; color: var(--text-secondary); font-size: 1.1em; }
        .login-options { display: flex; justify-content: space-between; align-items: center; font-size: 0.85em; margin-bottom: 20px; }
        .login-button { width: 100%; padding: 12px; border: none; border-radius: 8px; background-color: var(--border-accent); color: white; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: background-color 0.3s; }
        #login-error-msg { color: var(--due-text); margin-top: 10px; min-height: 20px; font-weight: bold; }
        .login-footer { margin-top: 25px; font-size: 0.85em; color: var(--text-secondary); text-align: center; }
        .login-footer .copyright-text { font-size: 0.9em; margin-bottom: 15px; }
        .developer-box { border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; background-color: var(--bg-main); }
        .social-icons { display: flex; justify-content: center; gap: 20px; align-items: center; }
        .social-icons a { display: inline-block; color: var(--text-secondary); transition: color 0.3s, transform 0.3s; }
        .social-icons a:hover { color: var(--border-accent); transform: scale(1.1); }
        .social-icons svg { width: 28px; height: 28px; fill: currentColor; }
        .login-footer .instruction-text { font-size: 0.8em; font-style: italic; margin-top: 12px; margin-bottom: 0; color: var(--text-secondary); }
        .login-footer .developed-by-text { margin-bottom: 8px; font-size: 1.1em; }
        .company-info { display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 15px; }
        .company-logo { width: 40px; height: 40px; object-fit: contain; }
        .company-text { text-align: left; line-height: 1.5; }
        .company-text strong { font-size: 1.2em; color: var(--text-primary); }
        .company-text small { font-size: 0.9em; }

        #app-container { display: flex; flex-direction: column; min-height: 100vh; position: relative; }
        #app-container.hidden { display: none; }
        #center-watermark { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 70vw; max-width: 300px; height: 100vh; background-image: url(images/image2.png); background-size: contain; background-repeat: no-repeat; background-position: center; opacity: .05; z-index: 999; pointer-events: none; }
        body[data-theme=dark] #center-watermark{ filter: invert(1) grayscale(1); opacity: 0.08; }
        
        header { background-color: var(--bg-header); color: var(--text-header); padding: 8px 10px; position: sticky; top: 0; z-index: 1001; box-shadow: 0 2px 5px rgba(0,0,0,0.2); display: flex; flex-direction: column; gap: 8px; }
        .header-top-row, .header-mid-row { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        .branding-info { display: flex; flex-direction: column; }
        .branding-info .institute-name { font-size: 1.1em; font-weight: bold; }
        .branding-info .contact-info { font-size: 0.75em; opacity: 0.8; }
        .header-controls { display: flex; align-items: center; gap: 10px; }
        .mode-controls { display: flex; align-items: center; gap: 5px; background-color: rgba(255,255,255,0.1); padding: 3px 6px; border-radius: 15px; }
        .mode-display { font-size: 0.8em; font-weight: bold; padding: 2px 6px; border-radius: 10px; }
        .mode-display.admin-active { background-color: #c0392b; color: white; }
        .mode-display.assistant-active { background-color: #27ae60; color: white; }
        #btnToggleMode { background: none; border: none; color: white; font-size: 0.8em; cursor: pointer; opacity: 0.9; }
        #year-management-controls { display: flex; align-items: center; gap: 8px; font-size: 0.9em; }
        #yearSelector { padding: 4px 8px; border-radius: 15px; border: 1px solid #5a6a7e; background-color: #334257; color: #e8eaed; font-size: 0.9em; cursor: pointer; -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url("data:image/svg+xml;utf8,<svg fill='white' height='24' viewBox='0 0 24 24' width='24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>"); background-repeat: no-repeat; background-position: right 5px top 50%; padding-right: 20px; }
        .header-nav-buttons { display: flex; overflow-x: auto; gap: 8px; padding-bottom: 5px; }
        .header-nav-buttons::-webkit-scrollbar { height: 4px; }
        .header-nav-buttons::-webkit-scrollbar-thumb { background: #555; border-radius: 2px; }
        .header-nav-buttons button { border: none; cursor: pointer; border-radius: 15px; white-space: nowrap; background-color: var(--border-accent); color: #fff; padding: 6px 12px; font-size: 0.9em; transition: background-color 0.2s ease, transform 0.2s ease; flex-shrink: 0; }
        .header-nav-buttons button:hover { transform: translateY(-2px); }
        
        .global-nav-icons { display: flex; gap: 12px; }
        .nav-icon-svg { width: 22px; height: 22px; cursor: pointer; transition: opacity .2s; }
        .nav-icon-svg path { fill: var(--text-header); }
        .nav-icon-svg.disabled { opacity: 0.4; cursor: not-allowed; }

        .privacy-menu-container { position: relative; }
        .privacy-menu-button { background: 0 0; border: none; color: var(--text-header); font-size: 1.6em; cursor: pointer; padding: 0 8px; line-height: 1; }
        .privacy-dropdown-content { display: none; position: absolute; top: 40px; right: 0; background-color: var(--bg-section); color: var(--text-primary); min-width: 220px; box-shadow: 0 4px 12px rgba(0,0,0,.2); z-index: 10000; border-radius: 8px; border: 1px solid var(--border-color); overflow: hidden; }
        .privacy-dropdown-content.active { display: block; }
        .privacy-dropdown-content h4 { margin: 0; padding: 10px 15px; background-color: var(--bg-tab); border-bottom: 1px solid var(--border-color); font-size: 0.9em; color: var(--text-secondary); }
        .privacy-dropdown-content button { width: 100%; padding: 10px 15px; text-align: left; background: 0 0; border: none; cursor: pointer; font-size: 0.95em; color: var(--text-primary); display: flex; align-items: center; justify-content: space-between; }
        .privacy-dropdown-content button:hover { background-color: var(--bg-hover); }
        .privacy-dropdown-content hr { margin: 5px 0; border: none; border-top: 1px solid var(--border-color); opacity: 0.5; }
        .backup-submenu { display: none; background-color: var(--bg-hover); padding-left: 15px; }
        .backup-submenu.open { display: block; }
        .backup-submenu button { padding-left: 25px; font-size: 0.9em; }
        .arrow-icon { display: inline-block; transition: transform .2s ease-in-out; }
        #btnBackupMenuToggle.open .arrow-icon { transform: rotate(90deg); }

        main { padding: 15px; flex-grow: 1; position: relative; z-index: 1; }
        #breadcrumb-container { padding: 0 5px 10px 5px; font-size: 0.8em; color: var(--text-secondary); flex-wrap: wrap; }
        #breadcrumb-container a { color: var(--text-tab-active); text-decoration: none; }
        #banner-area-placeholder { width: 100%; text-align: center; margin-bottom: 15px; }
        #banner-area-placeholder img { width: 100%; max-height: 200px; object-fit: cover; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,.08); }

        .page-section { background-color: var(--bg-section); padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 1px 4px rgba(0,0,0,.06); border: 1px solid var(--border-color); }
        .page-section.hidden, .admin-only.hidden { display: none; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #dynamic-content-placeholder { animation: fadeIn 0.4s ease-out; }

        #toast-container { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); z-index: 10005; display: flex; flex-direction: column; gap: 8px; width: 90%; max-width: 400px; }
        .toast { padding: 12px 15px; border-radius: 6px; color: #fff; font-size: 0.9em; box-shadow: 0 2px 10px rgba(0,0,0,.2); opacity: 0; transform: translateY(20px); transition: opacity .3s, transform .3s; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success { background-color: var(--toast-success-bg); }
        .toast.error { background-color: var(--toast-error-bg); }
        .toast.info { background-color: var(--toast-info-bg); }

        #loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,.6); z-index: 10006; display: none; align-items: center; justify-content: center; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid var(--border-accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .home-grid, .profile-grid { display: flex; flex-direction: column; gap: 15px; }
        .adikothon { padding: 20px; font-size: 0.95em; line-height: 1.6; text-align: justify;}
        .adikothon h3 { font-size: 1.4em; margin-bottom: 15px; text-align: center; }
        #homeImageSlider { width: 100%; height: auto; max-height: 300px; object-fit: contain; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,.1); transition: opacity 1s ease-in-out; }

        .modal-overlay { display: none; position: fixed; z-index: 10001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,.6); backdrop-filter: blur(4px); align-items: center; justify-content: center; padding: 10px; box-sizing: border-box; }
        .modal-overlay.visible { display: flex; }
        .modal-content { background-color: var(--bg-section); margin: auto; padding: 20px; border: 1px solid var(--border-color); border-radius: 8px; width: 100%; max-width: 600px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 5px 15px rgba(0,0,0,.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 10px; }
        .modal-header h2 { margin: 0; color: var(--text-tab-active); font-size: 1.3em; }
        .close-button { color: var(--text-secondary); font-size: 1.8em; font-weight: 700; border: none; background: 0 0; cursor: pointer; padding: 0 5px; }
        .modal-body { overflow-y: auto; padding-right: 8px; flex-grow: 1; }
        .modal-body .form-group { margin-bottom: 15px; }
        .modal-body .form-group label { display: block; margin-bottom: 5px; font-weight: 700; color: var(--text-secondary); font-size: 0.95em; }
        .modal-body .form-group input, .modal-body .form-group select { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; box-sizing: border-box; background-color: var(--bg-input); color: var(--text-primary); }
        .modal-footer { margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color); text-align: right; }
        .modal-footer button { padding: 8px 15px; border-radius: 6px; }

        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; }
        .dashboard-card { background-color: var(--bg-section); padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,.05); border-left: 4px solid; text-align: center; position: relative; padding-bottom: 35px; border: 1px solid var(--border-color); border-left-width: 4px; }
        .dashboard-card h4 { margin: 0 0 8px 0; color: var(--text-secondary); font-size: 0.9em; }
        .dashboard-card .stat-number { font-size: 1.8em; font-weight: 700; margin: 0; word-break: break-word; }
        .dashboard-card .details-button { position: absolute; bottom: 8px; right: 8px; font-size: 0.8em; padding: 4px 10px; background-color: var(--bg-tab); border: 1px solid var(--border-color); color: var(--text-secondary); border-radius: 4px; cursor: pointer; }
        .card-students { border-color: #007bff; } .card-students .stat-number { color: #007bff; }
        .card-batches { border-color: #6f42c1; } .card-batches .stat-number { color: #6f42c1; }
        .card-collection { border-color: #28a745; } .card-collection .stat-number { color: #28a745; }
        .card-due { border-color: #dc3545; } .card-due .stat-number { color: #dc3545; }
        .card-paid-students { border-color: #17a2b8; } .card-paid-students .stat-number { color: #17a2b8; }
        .card-due-students { border-color: #fd7e14; } .card-due-students .stat-number { color: #fd7e14; }

        .table-responsive-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.95em; }
        th, td { border: 1px solid var(--border-color); padding: 10px; text-align: left; vertical-align: middle; white-space: nowrap; }
        th { background-color: var(--bg-tab); color: var(--text-secondary); font-weight: 700; font-size: 0.9em; }
        td input { width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 3px; box-sizing: border-box; background-color: var(--bg-input); color: var(--text-primary); }
        td input:disabled { background-color: var(--bg-input-disabled); cursor: not-allowed; color: var(--text-input-disabled); }

        .action-button, td button { padding: 6px 10px; margin-right: 5px; border: none; border-radius: 3px; cursor: pointer; transition: opacity 0.2s; font-size: 0.9em; }
        .btn-paid { background-color: #28a745; color: #fff; }
        .btn-due { background-color: #dc3545; color: #fff; }
        .btn-show-doc { background-color: var(--border-accent); color: #fff; }
        .btn-add { background-color: #007bff; color: #fff; margin-top: 10px; }

        .tab-container { display: flex; overflow-x: auto; border-bottom: 2px solid var(--border-accent); background-color: var(--bg-tab-container); gap: 2px; }
        .tab-button { padding: 10px 15px; cursor: pointer; border: none; background-color: var(--bg-tab); border-bottom: 2px solid transparent; font-size: 1em; border-top-left-radius: 4px; border-top-right-radius: 4px; display: flex; align-items: center; gap: 5px; color: var(--text-tab); transition: all 0.2s ease; white-space: nowrap; flex-shrink: 0; }
        .tab-button.active { background-color: var(--bg-tab-active); border: 1px solid var(--border-color); border-bottom: 2px solid var(--border-tab-active); font-weight: 700; color: var(--text-tab-active); border-top: 2px solid var(--border-accent); margin-bottom: -1px; transform: scale(1.05); }
        .tab-content { padding: 15px; border: 1px solid var(--border-color); border-top: none; background-color: var(--bg-section); border-radius: 0 0 8px 8px; }

        .details-grid { display: flex; flex-direction: column; gap: 15px; }
        .yearly-status-container { border: 1px solid var(--border-color); padding: 10px; border-radius: 5px; }
        .yearly-status-chart { display: grid; grid-template-columns: repeat(auto-fit, minmax(70px, 1fr)); gap: 5px; text-align: center; }
        .month-box { padding: 5px; border-radius: 4px; font-size: .8em; font-weight: 700; border: 1px solid var(--border-color); }
        .month-box.paid { background-color: var(--paid-color); color: var(--paid-text); border-color: var(--paid-text); }
        .month-box.due { background-color: var(--due-color); color: var(--due-text); border-color: var(--due-text); }
        .month-box.future { background-color: var(--bg-input-disabled); color: var(--future-text); }
        .month-box.not-applicable { background-color: var(--not-applicable-color); color: var(--not-applicable-text); }

        .payment-filters, .details-list-filters { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center; }
        .payment-filters input, .payment-filters select, .details-list-filters select, .details-list-filters input { padding: 8px; border-radius: 4px; border: 1px solid var(--border-color); background-color: var(--bg-input); color: var(--text-primary); height: 38px; font-size: 0.9em; flex-grow: 1; min-width: 120px; }
        .student-list-header { display: flex; flex-direction: column; align-items: flex-start; gap: 15px; margin-bottom: 15px; }
        .student-list-header h3 { margin: 0; font-size: 1.3em; }
        .default-fee-controls { display: flex; gap: 10px; align-items: center; background-color: var(--bg-tab); padding: 8px 12px; border-radius: 5px; border: 1px solid var(--border-color); flex-wrap: wrap; font-size: 0.9em; }
        
        .profile-card p { display: flex; flex-wrap: wrap; margin: 8px 0; }
        .profile-card strong { min-width: 120px; margin-right: 10px; color: var(--text-secondary); }

        .batch-grid { display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 15px; }
        .batch-card-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background-color: var(--bg-tab); }
        .batch-time { font-size: 1.2em; font-weight: 700; cursor: pointer; color: var(--text-tab-active); }
        .student-action-icons { display: flex; gap: 12px; align-items: center; justify-content: center; }
        .student-delete-icon, .student-edit-icon, .student-transfer-icon { cursor: pointer; font-size: 1.2em; transition: transform 0.2s ease; }
        
        footer { background-color: var(--bg-footer); color: var(--text-footer); text-align: center; padding: 15px; font-size: 0.85em; margin-top: 20px; }
        
        /* Payment Receipt Styles */
        .receipt-controls { flex-direction: column; gap: 10px; align-items: stretch; }
        .payment-receipt { flex-direction: column; max-width: 80mm; width: 100%; min-height: auto; border: 1px solid #000; margin: 10px auto; padding: 10px; font-size: 0.8em; background-image: none; overflow: hidden; box-shadow: none; color: #000; background-color: #fff; }
        .payment-receipt .receipt-content-wrapper { width: 100%; padding: 0; border: none; display: block; }
        .payment-receipt .student-copy, .payment-receipt .office-copy { width: 100%; padding: 0; border: none; display: block; }
        .payment-receipt .office-copy, .payment-receipt .receipt-watermark, .payment-receipt .student-copy-watermark, .payment-receipt .doc-welcome-message, .payment-receipt .receipt-header, .payment-receipt .copy-title, .payment-receipt .authority-seal-area { display: none; }
        .payment-receipt .layout3-header { display: block; text-align: center; margin-bottom: 10px; }
        .payment-receipt .layout3-logo { width: 150px; height: auto; display: block; margin: 0 auto 5px; filter: none; }
        .payment-receipt .layout3-institute-info .institute-name { margin: 0; font-size: 1.2em; margin-bottom: 5px; }
        .payment-receipt .layout3-institute-info .contact-info { font-size: 0.9em; margin: 0; }
        .payment-receipt p { margin: 4px 0; font-size: 1em; }
        .payment-receipt strong { font-weight: 700; }
        .payment-receipt .receipt-details-grid { display: block; margin-bottom: 5px; }
        .payment-receipt .receipt-footer-area { margin-top: 15px; padding-top: 10px; padding-bottom: 10px; position: relative; }
        .payment-receipt .receiver-signature-area { position: relative; margin-top: 30px; text-align: center; }
        .payment-receipt .receiver-signature-area .receiver-name-display { margin-top: 25px; margin-bottom: 2px; min-width: 100px; height: 15px; border-bottom: 1px dashed #000;}
        .payment-receipt .receipt-footer { position: relative; bottom: auto; left: auto; width: auto; margin-top: 20px; text-align: center; font-size: 0.7em; color: #555; }
        .payment-receipt .receipt-token { position: relative; top: auto; right: auto; text-align: center; margin-bottom: 5px; }
        
        .daily-summary-receipt { padding: 15px; font-size: 0.9em; }
        .daily-summary-receipt table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 0.95em; }
        .daily-summary-receipt th, .daily-summary-receipt td { border: none; padding: 4px 2px; border-bottom: 1px dotted #ccc; }
        .daily-summary-receipt th { border-bottom: 1px solid #333; }
        .daily-summary-receipt tbody tr:last-child td { border-bottom: none; }
        
        @media print {
            @page {
                size: 80mm auto;
                margin: 2mm;
            }
            body {
                background-color: #fff !important;
                -webkit-print-color-adjust: exact;
            }
            body * {
                visibility: hidden;
            }
            .printable-area, .printable-area * {
                visibility: visible;
            }
            .printable-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0;
                border: none;
            }
   
            .payment-receipt, .daily-summary-receipt {
                width: 100%; 
                box-shadow: none;
                border: none;
                margin: 0;
                padding: 0;
                color: #000 !important;
            }
            .print-hide {
                display: none !important;
            }
        }
        </style>
</head>
<body data-theme="light">
    
    <div id="login-container">
        <div class="login-box">
            <img src="images/image2.png" alt="Logo" class="login-logo" onerror="this.style.display='none'">
            <h1>‡¶Æ‡¶ø‡¶∞‡¶æ‡¶ï‡¶≤ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶°‡ßá‡¶ü ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶° ‡¶è‡¶ï‡¶æ‡¶°‡ßá‡¶Æ‡¶ø‡¶ï ‡¶á‡¶®‡ßç‡¶∏‡¶ü‡¶ø‡¶ü‡¶ø‡¶â‡¶ü</h1>
            <form id="login-form">
                <div class="input-group">
                    <input type="text" id="username" placeholder="Miracle Username" required>
                </div>
                <div class="input-group">
                    <input type="password" id="password" placeholder="Password" required>
                    <span id="password-toggle" class="password-toggle-icon">üëÅÔ∏è</span>
                </div>
                <div class="login-options">
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="checkbox" id="remember-me"> Remember Me
                    </label>
                </div>
                <button type="submit" class="login-button">Login to Software</button>
                <div id="login-error-msg"></div>
            </form>
            <div class="login-footer">
                <p class="copyright-text">&copy; Copyright by Miracle Cadet & Academic Institute 2026</p>
                <div class="developer-box">
                    <p class="developed-by-text">Developed by,</p>
                    <div class="company-info">
                        <img src="images/image5.png" alt="Bindumatra IT Logo" class="company-logo">
                        <div class="company-text">
                            <strong>‡¶¨‡¶ø‡¶®‡ßç‡¶¶‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞‡¶æ ‡¶Ü‡¶á‡¶ü‡¶ø</strong><br>
                            <small>CEO : Abdullah Al Rafi </small>
                        </div>
                    </div>
                    <div class="social-icons">
                        <a href="mailto:bindumatrait@gmail.com" title="Email Bindumatra IT Solutions" target="_blank">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"></path></svg>
                        </a>
                        <a href="https://www.facebook.com/profile.php?id=61580476801857" title="Facebook Page" target="_blank">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 2.04c-5.5 0-10 4.49-10 10.02 0 5 3.66 9.15 8.44 9.9v-7.02H7.97v-2.89h2.47V9.9c0-2.45 1.44-3.8 3.65-3.8 1.06 0 2.16.19 2.16.19v2.47h-1.27c-1.2 0-1.56.72-1.56 1.5v1.84h2.78l-.45 2.89h-2.33v7.02c4.78-.75 8.44-4.9 8.44-9.9C22 6.53 17.5 2.04 12 2.04z"></path></svg>
                        </a>
                        <a href="https://wa.me/8801745938158" title="Contact on WhatsApp" target="_blank">
                           <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.894 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.886-.001 2.269.655 4.357 1.846 6.167l-1.117 4.082 4.162-1.085zM9.06 7.426c.14-.364.44-1.13.56-1.293.12-.162.28-.192.42-.192.14 0 .28.096.42.364.14.268.56 1.32.62 1.42.06.1.12.18.2.3.08.12.14.24.26.36s.24.22.4.32c.16.1.34.16.5.24.16.08.3.12.42.14.12.02.26 0 .38-.08.12-.08.5-1.25.62-1.47.12-.22.24-.28.4-.28.16 0 .3.04.42.12.12.08.56 1.13.66 1.31.1.18.18.28.2.32.02.04.04.1.02.18s-.08.24-.16.32c-.08.08-.18.1-.28.14s-.2.08-.32.1c-.12.02-.26.02-.4.02s-.68-.08-1.02-.22c-.34-.14-.7-.34-1.08-.62s-.68-.62-.94-.96c-.26-.34-.48-.74-.62-1.18s-.18-.9-.18-1.46c0-.56.08-1.04.22-1.46z"></path></svg>
                        </a>
                    </div>
                    <p class="instruction-text">click the icons to visit</p> 
                </div>
            </div>
        </div>
    </div>
    
    <div id="app-container" class="hidden">
        <div id="center-watermark"></div>
        <div id="toast-container"></div>
        <div id="loader-overlay"><div class="loader"></div></div>
        
        <header>
            <div class="header-top-row">
                <div class="branding-info">
                    <span class="institute-name">‡¶Æ‡¶ø‡¶∞‡¶æ‡¶ï‡¶≤ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶°‡ßá‡¶ü ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶° ‡¶è‡¶ï‡¶æ‡¶°‡ßá‡¶Æ‡¶ø‡¶ï ‡¶á‡¶®‡ßç‡¶∏‡¶ü‡¶ø‡¶ü‡¶ø‡¶â‡¶ü</span>
                    <span class="contact-info">‚òé ‡ß¶‡ßß‡ß´‡ßß‡ß¨‡ß´‡ß©‡ß™‡ß®‡ß©‡ßß</span>
                </div>
                <div class="header-controls">
                    <div class="mode-controls">
                        <span id="currentModeDisplay" class="mode-display">Assistant</span>
                        <button id="btnToggleMode">Admin</button>
                    </div>
                    <div class="privacy-menu-container">
                        <button id="btnPrivacyMenu" class="privacy-menu-button" title="Options">&#8942;</button>
                        <div id="privacyDropdown" class="privacy-dropdown-content">
                            <h4>Settings</h4>
                            <button id="btnToggleYearBar">Hide Year Bar</button>
                            <button id="btnShowHistory">‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button>
                            <button id="btnRecycleBin">‡¶∞‡¶ø‡¶∏‡¶æ‡¶á‡¶ï‡ßá‡¶≤ ‡¶¨‡¶ø‡¶®</button>
                            <button id="btnFindTrnxId">Find Trnx ID</button>
                            <div class="backup-menu-container">
                                <button id="btnBackupMenuToggle">‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ <span class="arrow-icon">‚ñ∂</span></button>
                                <div id="backupSubMenu" class="backup-submenu">
                                    <button id="btnExportData">üíæ Export JSON</button>
                                    <button id="btnImportData">üì§ Import JSON</button>
                                </div>
                            </div>
                            <button id="btnToggleTheme">‡¶•‡¶ø‡¶Æ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® <span id="themeIcon"></span></button>
                            <hr>
                            <h4>About</h4>
                            <button id="btnAboutDeveloper">About Developer</button>
                            <hr>
                            <h4>Privacy</h4>
                            <button id="btnChangePassword" class="admin-only hidden">‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®</button>
                            <button id="btnForgotPassword">‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶≠‡ßÅ‡¶≤‡ßá ‡¶ó‡ßá‡¶õ‡¶ø</button>
                            <button id="btnClearYearData" class="admin-only hidden">‚ö†Ô∏è Clear Year Data</button>
                            <hr>
                            <button id="btnLogout">‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="header-mid-row">
                <div class="global-nav-icons">
                    <span id="btnNavBack" title="Back"><svg class="nav-icon-svg" width="24" height="24" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" fill="currentColor"></path></svg></span>
                    <span id="btnNavForward" title="Forward"><svg class="nav-icon-svg" width="24" height="24" viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z" fill="currentColor"></path></svg></span>
                    <span id="btnNavRefresh" title="Refresh"><svg class="nav-icon-svg" width="24" height="24" viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z" fill="currentColor"></path></svg></span>
                </div>
                <div id="year-management-controls">
                    <select id="yearSelector"></select>
                </div>
            </div>
            <div class="header-nav-buttons">
                <button id="btnHome">‡¶π‡ßã‡¶Æ</button>
                <button id="btnDashboard">‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</button>
                <button id="btnBatch">‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö</button>
                <button id="btnPayment">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü</button>
                <button id="btnStudentDatabase">‡¶õ‡¶æ‡¶§‡ßç‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ‡¶¨‡ßá‡¶∏</button>
                <button id="btnReports">‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü‡¶∏</button>
                <button id="btnExam">‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ</button>
                <button id="btnAttendance">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ü‡ßá‡¶®‡¶°‡ßá‡¶®‡ßç‡¶∏</button>
                <button id="btnSms">SMS</button>
            </div>
        </header>
        
        <input type="file" id="fileImporter" accept=".json" style="display:none">
        <div id="breadcrumb-container"></div>
        <main id="main-content-area">
            <div id="banner-area-placeholder"></div>
            <div id="dynamic-content-placeholder"></div>
        </main>

        <!-- HTML Templates -->
        <template id="template-home"><div class="home-grid"><div class="page-section adikothon-container"><div class="adikothon"><h3>‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶ï‡¶•‡¶æ:</h3><p>‡¶Æ‡¶ø‡¶∞‡¶æ‡¶ï‡¶≤ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶°‡ßá‡¶ü ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶° ‡¶è‡¶ï‡¶æ‡¶°‡ßá‡¶Æ‡¶ø‡¶ï ‡¶á‡¶®‡ßç‡¶∏‡¶ü‡¶ø‡¶ü‡¶ø‡¶â‡¶ü' ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ ‡¶∏‡¶π‡¶æ‡ßü‡¶ï ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶∑‡ßç‡¶†‡¶æ‡¶®‡•§ ‡¶∏‡ßç‡¶¨‡¶ö‡ßç‡¶õ‡¶§‡¶æ ‡¶ì ‡¶ú‡¶¨‡¶æ‡¶¨‡¶¶‡¶ø‡¶π‡¶ø‡¶§‡¶æ‡¶∞ ‡¶Ü‡¶≤‡ßã‡¶ï‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶¨‡¶ø‡¶¨‡ßá‡¶ï ‡¶∏‡ßÉ‡¶∑‡ßç‡¶ü‡¶ø‡¶∞ ‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø‡ßá '‡¶Æ‡¶ø‡¶∞‡¶æ‡¶ï‡¶≤ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶°‡ßá‡¶ü ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶° ‡¶è‡¶ï‡¶æ‡¶°‡ßá‡¶Æ‡¶ø‡¶ï ‡¶á‡¶®‡ßç‡¶∏‡¶ü‡¶ø‡¶ü‡¶ø‡¶â‡¶ü" ‡¶∏‡¶ï‡¶≤ ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶ï‡ßç‡¶∞‡¶Æ ‡¶™‡¶∞‡¶ø‡¶ö‡¶æ‡¶≤‡¶®‡¶æ ‡¶ï‡¶∞‡¶õ‡ßá‡•§ ‡¶è ‡¶∏‡¶Æ‡¶æ‡¶ú‡ßá‡¶∞ ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶Æ‡¶æ‡¶®‡ßÅ‡¶∑‡ßá‡¶∞ ‡¶∏‡ßç‡¶¨‡¶™‡ßç‡¶® ‡¶™‡ßÇ‡¶∞‡¶£‡ßá ‡¶Æ‡¶ø‡¶∞‡¶æ‡¶ï‡¶≤ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶°‡ßá‡¶ü ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶° ‡¶è‡¶ï‡¶æ‡¶°‡ßá‡¶Æ‡¶ø‡¶ï ‡¶á‡¶®‡ßç‡¶∏‡¶ü‡¶ø‡¶ü‡¶ø‡¶â‡¶ü ‡¶è‡¶∞ ‡¶™‡¶ï‡ßç‡¶∑ ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡¶æ‡¶Æ‡¶æ‡¶®‡ßç‡¶Ø ‡¶∏‡¶π‡¶Ø‡ßã‡¶ó‡¶ø‡¶§‡¶æ ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶≤‡ßá '‡¶Æ‡¶ø‡¶∞‡¶æ‡¶ï‡¶≤ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶°‡ßá‡¶ü ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶° ‡¶è‡¶ï‡¶æ‡¶°‡ßá‡¶Æ‡¶ø‡¶ï ‡¶á‡¶®‡ßç‡¶∏‡¶ü‡¶ø‡¶ü‡¶ø‡¶â‡¶ü' ‡¶®‡¶ø‡¶ú‡ßá‡¶ï‡ßá ‡¶ß‡¶®‡ßç‡¶Ø ‡¶Æ‡¶®‡ßá ‡¶ï‡¶∞‡¶¨‡ßá‡•§</p><p>'‡¶∏‡¶¨‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ' ‡¶è‡¶á ‡¶∏‡ßç‡¶≤‡ßã‡¶ó‡¶æ‡¶®‡¶ï‡ßá ‡¶∏‡¶æ‡¶Æ‡¶®‡ßá ‡¶∞‡ßá‡¶ñ‡ßá '‡¶Æ‡¶ø‡¶∞‡¶æ‡¶ï‡¶≤ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶°‡ßá‡¶ü ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶° ‡¶è‡¶ï‡¶æ‡¶°‡ßá‡¶Æ‡¶ø‡¶ï ‡¶á‡¶®‡ßç‡¶∏‡¶ü‡¶ø‡¶ü‡¶ø‡¶â‡¶ü' ‡¶§‡¶æ‡¶∞ ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶® ‡¶•‡ßá‡¶ï‡ßá ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶Æ‡¶æ‡¶®‡ßÅ‡¶∑‡ßá‡¶∞ ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ ‡¶Ö‡¶∞‡ßç‡¶ú‡¶® ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø‡ßá ‡¶¨‡¶ø‡¶≠‡¶ø‡¶®‡ßç‡¶® ‡¶™‡¶¶‡¶ï‡ßç‡¶∑‡ßá‡¶™‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶ß‡ßç‡¶Ø‡¶Æ‡ßá ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶¶‡ßá‡¶∞‡¶ï‡ßá ‡¶™‡ßú‡¶æ‡¶∂‡ßã‡¶®‡¶æ‡¶Æ‡ßÅ‡¶ñ‡ßÄ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶¨‡¶æ‡¶∏‡ßç‡¶§‡¶¨ ‡¶™‡¶¶‡¶ï‡ßç‡¶∑‡ßá‡¶™ ‡¶ó‡ßç‡¶∞‡¶π‡¶£ ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡•§ ‡¶Ü‡¶∞‡ßç‡¶•‡¶ø‡¶ï ‡¶Ö‡¶∏‡ßç‡¶¨‡¶ö‡ßç‡¶õ‡¶≤ ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ ‡¶§‡¶•‡¶æ ‡¶è‡¶§‡¶ø‡¶Æ‡¶¶‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶¨‡¶ø‡¶®‡¶æ ‡¶¨‡ßá‡¶§‡¶®‡ßá ‡¶™‡ßú‡¶æ‡¶≤‡ßá‡¶ñ‡¶æ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶∏‡ßÅ‡¶Ø‡ßã‡¶ó ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶®, ‡¶®‡¶ø‡ßü‡¶Æ‡¶ø‡¶§ ‡¶¨‡ßÉ‡¶§‡ßç‡¶§‡¶ø ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶ï‡¶≤ ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶¶‡ßá‡¶∞‡¶ï‡ßá ‡¶â‡ßé‡¶∏‡¶æ‡¶π ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶®‡¶ø‡ßü‡¶Æ‡¶ø‡¶§ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶Ü‡ßü‡ßã‡¶ú‡¶®, ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø‡¶æ‡ßü‡¶® ‡¶∏‡¶æ‡¶™‡ßá‡¶ï‡ßç‡¶∑‡ßá ‡¶™‡ßÅ‡¶∞‡¶∏‡ßç‡¶ï‡¶æ‡¶∞ ‡¶ò‡ßã‡¶∑‡¶£‡¶æ ‡¶è‡¶¨‡¶Ç ‡¶Ü‡¶®‡ßÅ‡¶∑‡ßç‡¶†‡¶æ‡¶®‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡ßÅ‡¶∞‡¶∏‡ßç‡¶ï‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶®, ‡¶Ø‡¶æ ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶ï‡ßá ‡¶¶‡¶æ‡ßü‡¶ø‡¶§‡ßç‡¶¨‡¶¨‡ßã‡¶ß ‡¶•‡ßá‡¶ï‡ßá ‡¶™‡ßú‡¶æ‡¶∂‡ßã‡¶®‡¶æ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶™‡ßç‡¶∞‡ßá‡¶∞‡¶£‡¶æ ‡¶Ø‡ßã‡¶ó‡¶æ‡ßü‡•§ ‡¶Ö‡¶≠‡¶ø‡¶≠‡¶æ‡¶¨‡¶ï‡¶¶‡ßá‡¶∞ ‡¶∏‡¶ô‡ßç‡¶ó‡ßá ‡¶®‡¶ø‡ßü‡¶Æ‡¶ø‡¶§ ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶ß‡ßç‡¶Ø‡¶Æ‡ßá ‡¶õ‡¶æ‡¶§‡ßç‡¶∞-‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßÄ‡¶∞ ‡¶∏‡¶æ‡¶∞‡ßç‡¶¨‡¶ø‡¶ï ‡¶â‡¶®‡ßç‡¶®‡ßü‡¶®‡ßá ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®‡ßÄ‡ßü ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ ‡¶®‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü‡•§</p><p>‡¶Æ‡¶ø‡¶∞‡¶æ‡¶ï‡¶≤ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶°‡ßá‡¶ü ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶° ‡¶è‡¶ï‡¶æ‡¶°‡ßá‡¶Æ‡¶ø‡¶ï ‡¶á‡¶®‡ßç‡¶∏‡¶ü‡¶ø‡¶ü‡¶ø‡¶â‡¶ü ‡¶è‡¶∞' ‡¶®‡¶ø‡ßü‡¶Æ‡¶ø‡¶§ ‡¶Ö‡¶®‡ßÅ‡¶∂‡ßÄ‡¶≤‡¶® ‡¶è‡¶ï‡¶ú‡¶® ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶∞ ‡¶∏‡ßç‡¶¨‡¶™‡ßç‡¶® ‡¶™‡ßÇ‡¶∞‡¶£‡ßá ‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶∏‡¶π‡¶æ‡ßü‡¶ï ‡¶≠‡ßÇ‡¶Æ‡¶ø‡¶ï‡¶æ ‡¶∞‡¶æ‡¶ñ‡¶¨‡ßá ‡¶¨‡¶≤‡ßá ‡¶Ü‡¶Æ‡¶ø ‡¶¶‡ßÉ‡ßù‡¶≠‡¶æ‡¶¨‡ßá ‡¶¨‡¶ø‡¶∂‡ßç‡¶¨‡¶æ‡¶∏ ‡¶ï‡¶∞‡¶ø‡•§ ‡¶∏‡¶ï‡¶≤‡ßá‡¶∞ ‡¶∏‡¶æ‡¶∞‡ßç‡¶¨‡¶ø‡¶ï ‡¶∏‡ßÅ‡¶∏‡ßç‡¶•‡¶§‡¶æ ‡¶ì ‡¶¶‡ßÄ‡¶∞‡ßç‡¶ò‡¶æ‡¶Ø‡¶º‡ßÅ ‡¶ï‡¶æ‡¶Æ‡¶®‡¶æ ‡¶ï‡¶∞‡¶õ‡¶ø‡•§</p></div></div><div class="page-section image-slider-container"><img id="homeImageSlider" src="images/image3.png" alt="Promotional Image" onerror="this.style.display='none'"></div></div></template>
        <template id="template-dashboard"><div class="page-section"><h2>‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</h2><div class="dashboard-grid"></div></div></template>
        <template id="template-student-database"><div class="page-section"><h2>‡¶õ‡¶æ‡¶§‡ßç‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ‡¶¨‡ßá‡¶∏</h2><p>‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã ‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡¶ï‡ßá ‡¶§‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ, ‡¶∞‡ßã‡¶≤ ‡¶¨‡¶æ ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡ßü‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p><div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;"><input type="search" id="studentDatabaseSearchInput" placeholder="‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶¨‡¶æ ‡¶∞‡ßã‡¶≤ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." style="flex-grow: 1; padding: 12px; font-size: 1em;"><input type="search" id="studentDatabaseContactInput" placeholder="‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." style="flex-grow: 1; padding: 12px; font-size: 1em;"></div><div id="student-search-results"></div></div></template>
        <template id="template-payment"><div class="page-section" style="padding:0; border:none; box-shadow:none; background-color: transparent;"><div class="tab-container" id="payment-class-categories-tabs"></div><div id="payment-tab-contents"></div></div></template>
        <template id="template-payment-history"><div class="page-section"><h2>‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø</h2><div class="tab-container" id="history-tabs"><button class="tab-button active" data-tab="payment">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø</button><button class="tab-button" data-tab="activity">Student Activity</button></div><div id="history-content-area" class="tab-content" style="max-height: 70vh; overflow-y: auto;"></div><button id="btnBackFromHistory" class="action-button" style="margin-top:20px">‡¶π‡ßã‡¶Æ-‡¶™‡ßá‡¶ú‡ßá ‡¶´‡ßá‡¶∞‡¶§ ‡¶Ø‡¶æ‡¶®</button></div></template>
        <template id="template-student-profile"><div class="page-section"><div class="details-header-container" style="display:flex; justify-content:flex-end; align-items:center;margin-bottom:20px; gap: 10px;"><button id="btnEditStudentProfile" class="action-button admin-only hidden" style="background-color:#e67e22;color:#fff">Edit Profile</button><button id="btnGoToPaymentSection" class="action-button" style="background-color:#6f42c1;color:#fff">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡ßá‡¶ï‡¶∂‡¶®</button></div><div class="profile-grid"><div class="profile-card" style="text-align: center; padding-top: 30px;"><img id="profilePagePhoto" src="images/default_avatar.png" alt="Profile Photo" style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 3px solid var(--border-color);" onerror="this.src='images/default_avatar.png'"><h3 id="profileNameHeader" style="margin-top: 15px; font-size: 1.5em;"></h3></div><div><div class="profile-card"><h4>‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶§‡¶•‡ßç‡¶Ø</h4><p><strong>‡¶∞‡ßã‡¶≤:</strong> <span id="profileRoll"></span></p><p><strong>‡¶ï‡ßç‡¶≤‡¶æ‡¶∏:</strong> <span id="profileClass"></span></p><p><strong>‡¶∏‡ßç‡¶ï‡ßÅ‡¶≤:</strong> <span id="profileSchool"></span></p><p><strong>‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó:</strong> <span id="profileParentContact"></span></p><p><strong>‡¶≠‡¶∞‡ßç‡¶§‡¶ø‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</strong> <span id="profileAdmissionDate"></span></p></div><div class="profile-card"><h4>‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö‡¶∏‡¶Æ‡ßÇ‡¶π</h4><div id="student-profile-batches"></div></div></div></div><button id="btnBackToDatabase" class="action-button" style="margin-top:20px">‡¶°‡ßá‡¶ü‡¶æ‡¶¨‡ßá‡¶∏‡ßá ‡¶´‡ßá‡¶∞‡¶§ ‡¶Ø‡¶æ‡¶®</button></div></template>
        <template id="template-batch"><div class="page-section" style="padding:0; border:none; box-shadow:none; background-color: transparent;"><h2>‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h2><div class="tab-container" id="batch-day-tabs"></div><div id="batch-class-subtabs-container" class="tab-content" style="border-top:none;margin-top:0;padding-top:10px"></div></div></template>
        <template id="template-batch-details"><div class="page-section"><div class="student-list-header print-hide"><div><h3 id="batchDetailsHeader">‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö‡ßá‡¶∞ ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶¶‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h3><p><strong>‡¶¶‡¶ø‡¶®:</strong> <span id="batchDetailsDay"></span> | <strong>‡¶ï‡ßç‡¶≤‡¶æ‡¶∏:</strong> <span id="batchDetailsClass"></span> | <strong>‡¶∏‡¶Æ‡ßü:</strong> <span id="batchDetailsTime"></span></p></div><div class="details-list-filters"><input type="search" id="batchStudentSearchInput" class="print-hide" placeholder="‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡ßü‡ßá ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶ï‡¶∞‡ßÅ‡¶®..."><button id="btnBulkImport" class="action-button print-hide">Excel ‡¶•‡ßá‡¶ï‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button><input type="file" id="bulkStudentImportInput" accept=".xlsx" style="display:none;"><button id="btnPrintBatchList" class="action-button print-hide">PDF ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°</button></div></div><hr class="print-hide"><div id="printableBatchDetailsArea" class="printable-area"><div class="details-page-printable-header print-only"><h2 id="printBatchHeaderTitle"></h2><h3 id="printBatchHeaderClass"></h3><p id="printBatchHeaderBatch"></p></div><div class="table-responsive-wrapper"><table><thead><tr><th>‡¶ï‡ßç‡¶∞‡¶Æ‡¶ø‡¶ï ‡¶®‡¶Ç</th><th>‡¶®‡¶æ‡¶Æ</th><th>‡¶∞‡ßã‡¶≤</th><th>‡¶∏‡ßç‡¶ï‡ßÅ‡¶≤‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</th><th>‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</th><th class="print-hide">‡¶è‡¶ï‡¶∂‡¶®</th></tr></thead><tbody id="batchStudentListBody"></tbody></table></div><div class="print-footer"><span class="left-footer-text">&copy; Miracle Cadet & Academic Institute 2026</span><span class="right-footer-text">Software by: ‡¶¨‡¶ø‡¶®‡ßç‡¶¶‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞‡¶æ ‡¶Ü‡¶á‡¶ü‡¶ø</span></div></div><button class="action-button btn-add print-hide" id="btnAddStudentToBatch">+ ‡¶®‡¶§‡ßÅ‡¶® ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button><button id="btnBackToBatchList" class="action-button print-hide" style="margin-top:20px">‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá ‡¶´‡ßá‡¶∞‡¶§ ‡¶Ø‡¶æ‡¶®</button></div></template>
        <template id="template-transfer-modal"><div id="studentTransferModal" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h2 id="transferModalTitle">‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡¶ï‡ßá ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö‡ßá ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶∏‡¶´‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®</h2><span class="close-button">&times;</span></div><div class="modal-body" id="transferBatchListContainer"></div></div></div></template>
        <template id="template-add-student-modal">
            <div id="addStudentModal" class="modal-overlay">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 id="addStudentModalTitle">‡¶®‡¶§‡ßÅ‡¶® ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h2><span class="close-button">&times;</span>
                    </div>
                    <form id="addStudentForm">
                        <div class="modal-body">
                            <div class="form-group" style="text-align: center;">
                                <img id="addStudentImagePreview" src="images/default_avatar.png" alt="Profile Picture" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 2px solid var(--border-color); margin-bottom: 10px;" onerror="this.src='images/default_avatar.png'">
                            </div>
                            <div class="form-group"><label for="studentNameInput">‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ (‡¶Ü‡¶¨‡¶∂‡ßç‡¶Ø‡¶ï)</label><input type="text" id="studentNameInput" required></div>
                            <div class="form-group"><label for="studentSchoolInput">‡¶∏‡ßç‡¶ï‡ßÅ‡¶≤‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</label><input type="text" id="studentSchoolInput"></div>
                            <div class="form-group"><label for="parentContactInput">‡¶Ö‡¶≠‡¶ø‡¶≠‡¶æ‡¶¨‡¶ï‡ßá‡¶∞ ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</label><input type="tel" id="parentContactInput"></div>
                            <div class="form-group">
                                <label>‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶õ‡¶¨‡¶ø (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï, ‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö 300KB)</label>
                                <div style="display: flex; gap: 10px;">
                                    <button type="button" id="selectStudentPhotoBtn" class="action-button" style="flex: 1;"> ‡¶´‡¶æ‡¶á‡¶≤ ‡¶•‡ßá‡¶ï‡ßá ‡¶¶‡¶ø‡¶®</button>
                                    <button type="button" id="takeStudentPhotoBtn" class="action-button" style="flex: 1;">‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶¶‡¶ø‡ßü‡ßá ‡¶§‡ßÅ‡¶≤‡ßÅ‡¶®</button>
                                </div>
                                <input type="file" id="studentPhotoInput" accept="image/png, image/jpeg" style="display: none;">
                            </div>
                            <!-- Start of new admission fee section -->
                            <fieldset style="border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; margin-top: 15px; background-color: var(--bg-main);">
                                <legend style="font-weight: bold; padding: 0 10px; color: var(--text-secondary);">‡¶≠‡¶∞‡ßç‡¶§‡¶ø ‡¶´‡¶ø ‡¶∏‡¶Ç‡¶ï‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶§</legend>
                                <div class="form-group">
                                    <label for="admissionFeeInputModal">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (‡¶ü‡¶æ‡¶ï‡¶æ)</label>
                                    <input type="number" id="admissionFeeInputModal" placeholder="‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶´‡¶ø">
                                </div>
                                <div class="form-group" style="background-color: var(--bg-subtle); padding: 10px; border-radius: 5px;">
                                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 1.1em;">
                                        <input type="checkbox" id="admissionFeeFreeCheckbox" style="width: 20px; height: 20px;"> ‡¶≠‡¶∞‡ßç‡¶§‡¶ø ‡¶´‡¶ø ‡¶´‡ßç‡¶∞‡¶ø
                                    </label>
                                </div>
                                <div class="form-group" id="admissionReceiverGroup">
                                    <label for="admissionReceiverInputModal">‡¶ó‡ßç‡¶∞‡¶π‡¶£‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶®‡¶æ‡¶Æ (‡¶Ü‡¶¨‡¶∂‡ßç‡¶Ø‡¶ï)</label>
                                    <input type="text" id="admissionReceiverInputModal" required>
                                </div>
                            </fieldset>
                            <!-- End of new admission fee section -->
                        </div>
                        <div class="modal-footer"><button type="submit" class="action-button btn-add">‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®</button></div>
                    </form>
                </div>
            </div>
        </template>
        <template id="template-student-payment-details"><div class="page-section"><div class="details-header-container" style="display:flex; align-items: center; gap: 15px; margin-bottom: 10px;"><img id="paymentPagePhoto" src="images/default_avatar.png" alt="Photo" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;" onerror="this.src='images/default_avatar.png'"><div><h3 id="studentNameHeader" style="margin:0;">‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶∞ ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</h3><div id="studentEntryDateDisplay" class="entry-date-info" style="font-size: 0.8em;">‡¶≠‡¶∞‡ßç‡¶§‡¶ø‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ: <span id="entryDateValue">N/A</span></div></div></div><p style="margin: 5px 0;"><strong>‡¶∞‡ßã‡¶≤:</strong> <span id="studentRollDisplay"></span> | <strong>‡¶ï‡ßç‡¶≤‡¶æ‡¶∏:</strong> <span id="studentClassDisplay"></span></p><hr><div class="details-grid"><div class="payment-main-details"><div style="margin-bottom:1rem;"><h4>‡¶≠‡¶∞‡ßç‡¶§‡¶ø ‡¶´‡¶ø:</h4><label>‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£: <input type="number" id="admissionFeeAmount" placeholder="‡¶ü‡¶æ‡¶ï‡¶æ"></label><br><button class="action-button btn-paid" id="btnAdmissionPaid">Paid</button><button class="action-button btn-due" id="btnAdmissionDue">Due</button><button class="action-button btn-show-doc" id="btnShowAdmissionDoc">‡¶∞‡¶∂‡¶ø‡¶¶</button><br><span id="admissionFeeStatus">‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏: ‡¶™‡ßç‡¶∞‡¶Ø‡ßã‡¶ú‡ßç‡¶Ø ‡¶®‡ßü</span> | <span id="admissionReceiverInfo">‡¶ó‡ßç‡¶∞‡¶π‡¶£‡¶ï‡¶æ‡¶∞‡ßÄ: ‡¶™‡ßç‡¶∞‡¶Ø‡ßã‡¶ú‡ßç‡¶Ø ‡¶®‡ßü</span></div><hr><div><h4>‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶´‡¶ø (‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü):</h4><label>‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£: <input type="number" id="defaultMonthlyFeeForStudent" placeholder="‡¶ü‡¶æ‡¶ï‡¶æ"></label><button id="btnSaveDefaultMonthlyFee" class="action-button">‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£</button></div></div><div class="yearly-status-container"><h4>‡¶¨‡¶æ‡¶∞‡ßã ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</h4><div class="yearly-status-chart" id="yearlyStatusChart"></div></div></div><hr><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px; flex-wrap: wrap; gap: 10px;"><h4>‡¶Æ‡¶æ‡¶∏‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶ï ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü:</h4><button id="btnPaySelectedMonths" class="action-button btn-paid">‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§ ‡¶Æ‡¶æ‡¶∏‡¶ó‡ßÅ‡¶≤‡ßã ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button></div><div class="table-responsive-wrapper" style="max-height:400px"><table><thead><tr><th><input type="checkbox" id="selectAllMonthsCheckbox" title="‡¶∏‡¶¨‡¶ó‡ßÅ‡¶≤‡ßã ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®"></th><th>‡¶Æ‡¶æ‡¶∏</th><th>‡¶´‡¶ø</th><th>‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</th><th>‡¶ó‡ßç‡¶∞‡¶π‡¶£‡¶ï‡¶æ‡¶∞‡ßÄ</th><th>‡¶è‡¶ï‡¶∂‡¶®</th></tr></thead><tbody id="monthlyPaymentsTableBody"></tbody></table></div><button id="btnBackToPreviousPage" class="action-button" style="margin-top:20px">‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶™‡ßá‡¶ú‡ßá ‡¶´‡ßá‡¶∞‡¶§ ‡¶Ø‡¶æ‡¶®</button></div></template>
        <template id="template-payment-document"><div class="page-section payment-receipt-page" style="padding: 0;"><div class="receipt-controls print-hide"><button id="btnPrintGeneratedDocument" class="action-button">‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button></div><div class="printable-area"><div class="payment-receipt" id="printable-receipt-area"><div class="layout3-header"><img src="images/miraclelogo.png" alt="Logo" class="layout3-logo" onerror="this.style.display='none'"><div class="layout3-institute-info"><h3 class="institute-name">Miracle Cadet & Academic Institute</h3><p class="contact-info">Contact: 01516534231</p><hr style="border-top: 1px dashed #bbb; margin: 10px 0;"></div></div><div class="receipt-content-wrapper student-copy"><div class="receipt-token">Trnx ID: <span id="docViewTokenNo">N/A</span></div><p><strong>Name:</strong> <span id="docViewStudentName">N/A</span></p><p><strong>School Name:</strong> <span id="docViewStudentSchool">N/A</span></p><p><strong>Roll:</strong> <span id="docViewStudentRoll">N/A</span></p><p><strong>Class:</strong> <span id="docViewClassName">N/A</span></p><p><strong>Batch:</strong> <span id="docViewBatchInfo">N/A</span></p><p><strong>Payment For:</strong> <span id="docViewPaymentMonth">N/A</span></p><p><strong>Amount Paid:</strong> <span id="docViewAmountPaid">N/A</span></p><p><strong>Payment Date:</strong> <span id="docViewPaymentDate">N/A</span></p><div class="receipt-footer-area"><div class="receiver-signature-area"><div id="docViewReceiverName" style="margin-bottom: 20px; font-weight: bold;"></div><div class="receiver-name-display"></div>Authority Signature</div><div class="receipt-footer">Software by: ‡¶¨‡¶ø‡¶®‡ßç‡¶¶‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞‡¶æ ‡¶Ü‡¶á‡¶ü‡¶ø<br>bindumatrait@gmail.com</div></div></div></div></div><button id="btnBackFromDocument" class="action-button print-hide" style="margin-top:20px">‡¶´‡ßá‡¶∞‡¶§ ‡¶Ø‡¶æ‡¶®</button></div></template>
        <template id="template-dashboard-details-page"><div class="page-section"><div class="details-list-controls print-hide"><h2 id="detailsListPageTitle" style="margin: 0;">‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h2><div class="details-list-filters"><select id="detailsPageClassFilter"></select><select id="detailsPageBatchFilter"></select><select id="paymentTypeFilter"><option value="">‡¶∏‡¶¨ ‡¶ß‡¶∞‡¶£‡ßá‡¶∞ ‡¶´‡¶ø</option><option value="‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶´‡¶ø">‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶¨‡ßá‡¶§‡¶®</option><option value="‡¶≠‡¶∞‡ßç‡¶§‡¶ø ‡¶´‡¶ø">‡¶≠‡¶∞‡ßç‡¶§‡¶ø ‡¶´‡¶ø</option></select><button id="btnPrintDetailsList" class="action-button">PDF ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°</button></div></div><hr class="print-hide"><div id="printableDetailsArea" class="printable-area"><div class="details-page-printable-header print-only"><h2 id="printHeaderTitle"></h2><h3 id="printHeaderSubtitle"></h3><p id="printHeaderFilters"></p></div><div class="table-responsive-wrapper"><table><thead><tr><th>‡¶ï‡ßç‡¶∞‡¶Æ‡¶ø‡¶ï ‡¶®‡¶Ç</th><th>‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</th><th>‡¶∞‡ßã‡¶≤</th><th>‡¶ï‡ßç‡¶≤‡¶æ‡¶∏</th><th>‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö</th><th id="headerCol6"> ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ </th><th id="headerCol7"> ‡¶ü‡¶æ‡¶ï‡¶æ / ‡¶Æ‡¶æ‡¶∏ </th></tr></thead><tbody id="detailsPageTableBody"></tbody></table></div><div id="detailsPageSummary" class="details-summary"></div><div class="print-footer"><span class="left-footer-text">&copy; Miracle Cadet & Academic Institute 2026</span><span class="right-footer-text">Software by: ‡¶¨‡¶ø‡¶®‡ßç‡¶¶‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞‡¶æ ‡¶Ü‡¶á‡¶ü‡¶ø</span></div></div><button id="btnBackToDashboard" class="action-button print-hide" style="margin-top:20px">‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°‡ßá ‡¶´‡ßá‡¶∞‡¶§ ‡¶Ø‡¶æ‡¶®</button></div></template>
        <template id="template-reports-page"><div class="page-section"><h2>‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡¶∂‡¶® ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</h2><div class="details-list-controls"><div class="details-list-filters"><label for="reportStartDate">‡¶∂‡ßÅ‡¶∞‡ßÅ‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</label><input type="date" id="reportStartDate"><label for="reportEndDate">‡¶∂‡ßá‡¶∑‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</label><input type="date" id="reportEndDate"><button id="btnGenerateReport" class="action-button btn-add">‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button></div><button id="btnPrintReport" class="action-button" disabled>PDF ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°</button></div><hr><div id="report-results-area" class="printable-area"><div class="details-page-printable-header print-only"><h2>‡¶Æ‡¶ø‡¶∞‡¶æ‡¶ï‡¶≤ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶°‡ßá‡¶ü ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶° ‡¶è‡¶ï‡¶æ‡¶°‡ßá‡¶Æ‡¶ø‡¶ï ‡¶á‡¶®‡ßç‡¶∏‡¶ü‡¶ø‡¶ü‡¶ø‡¶â‡¶ü</h2><h3>‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡¶∂‡¶® ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</h3><p id="printReportHeaderDates"></p></div><div id="report-content"><p style="text-align:center; color: var(--text-secondary);">‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßá "‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®" ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p></div><div class="print-footer"><span class="left-footer-text">&copy; Miracle Cadet & Academic Institute 2026</span><span class="right-footer-text">Software by: ‡¶¨‡¶ø‡¶®‡ßç‡¶¶‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞‡¶æ ‡¶Ü‡¶á‡¶ü‡¶ø</span></div></div></div></template>
        <template id="template-recycle-bin"><div class="page-section"><h2>‡¶∞‡¶ø‡¶∏‡¶æ‡¶á‡¶ï‡ßá‡¶≤ ‡¶¨‡¶ø‡¶®</h2><div class="tab-container" id="recycle-bin-tabs"><button class="tab-button active" data-tab="students">‡¶õ‡¶æ‡¶§‡ßç‡¶∞</button><button class="tab-button" data-tab="mainClassCategories">‡¶ï‡ßç‡¶≤‡¶æ‡¶∏</button><button class="tab-button" data-tab="batchSchedule">‡¶¶‡¶ø‡¶®/‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö</button></div><div id="recycle-bin-content" class="tab-content" style="max-height: 60vh; overflow-y: auto;"></div></div></template>
        <template id="template-about-developer-modal"><div id="aboutDeveloperModal" class="modal-overlay"><div class="modal-content" style="max-width: 95%; padding: 15px; background: var(--bg-main); border-radius: 12px;"><div class="modal-header" style="padding-bottom: 10px; margin-bottom: 10px;"><h2>About the Developer</h2><span class="close-button">&times;</span></div><div class="modal-body" style="padding:0;"><img src="images/Abdullah-Al-Rafi-Digital-Card.png" alt="Developer Digital Card" style="width: 100%; height: auto; border-radius: 8px; display: block;" onerror="this.alt='Image not found.'"></div></div></div></template>
        <template id="template-edit-student-modal"><div id="editStudentModal" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h2 id="editStudentModalTitle">Edit Student Information</h2><span class="close-button">&times;</span></div><form id="editStudentForm"><div class="modal-body"><div class="form-group" style="text-align: center;"><img id="editStudentImagePreview" src="images/default_avatar.png" alt="Profile Picture" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 2px solid var(--border-color); margin-bottom: 10px;" onerror="this.src='images/default_avatar.png'"></div><div class="form-group"><label for="editStudentNameInput">‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ (‡¶Ü‡¶¨‡¶∂‡ßç‡¶Ø‡¶ï)</label><input type="text" id="editStudentNameInput" required></div><div class="form-group"><label for="editStudentRollInput">‡¶∞‡ßã‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</label><input type="text" id="editStudentRollInput"></div><div class="form-group"><label for="editStudentSchoolInput">‡¶∏‡ßç‡¶ï‡ßÅ‡¶≤‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</label><input type="text" id="editStudentSchoolInput"></div><div class="form-group"><label for="editStudentParentContactInput">‡¶Ö‡¶≠‡¶ø‡¶≠‡¶æ‡¶¨‡¶ï‡ßá‡¶∞ ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</label><input type="tel" id="editStudentParentContactInput"></div><div class="form-group"><label>‡¶®‡¶§‡ßÅ‡¶® ‡¶õ‡¶¨‡¶ø ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï, ‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö 300KB)</label><div style="display: flex; gap: 10px;"><button type="button" id="editSelectStudentPhotoBtn" class="action-button" style="flex: 1;"> ‡¶´‡¶æ‡¶á‡¶≤ ‡¶•‡ßá‡¶ï‡ßá ‡¶¶‡¶ø‡¶®</button><button type="button" id="editTakeStudentPhotoBtn" class="action-button" style="flex: 1;">‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶¶‡¶ø‡ßü‡ßá ‡¶§‡ßÅ‡¶≤‡ßÅ‡¶®</button></div><input type="file" id="editStudentPhotoInput" accept="image/png, image/jpeg" style="display: none;"></div></div><div class="modal-footer"><button type="submit" class="action-button btn-add">Save Changes</button></div></form></div></div></template>
        <template id="template-daily-summary-receipt-modal"><div id="dailySummaryModal" class="modal-overlay"><div class="modal-content" style="max-width: 400px; padding: 0;"><div class="printable-area"><div class="payment-receipt daily-summary-receipt"><div class="layout3-header"><img src="images/image2.png" alt="Logo" class="layout3-logo" onerror="this.style.display='none'"><div class="layout3-institute-info"><h3 class="institute-name">‡¶Æ‡¶ø‡¶∞‡¶æ‡¶ï‡¶≤ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶°‡ßá‡¶ü ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶° ‡¶è‡¶ï‡¶æ‡¶°‡ßá‡¶Æ‡¶ø‡¶ï ‡¶á‡¶®‡ßç‡¶∏‡¶ü‡¶ø‡¶ü‡¶ø‡¶â‡¶ü</h3><p class="contact-info">‡¶ú‡¶≤‡ßá‡¶∂‡ßç‡¶¨‡¶∞‡ßÄ‡¶§‡¶≤‡¶æ, ‡¶¨‡¶ó‡ßÅ‡ßú‡¶æ‡•§ ‚òé ‡ß¶‡ßß‡ß´‡ßß‡ß¨‡ß´‡ß©‡ß™‡ß®‡ß©‡ßß</p></div></div><hr style="border-top: 1px dashed #bbb; margin: 10px 0;"><div class="receipt-content-wrapper"><h4 style="text-align: center; margin: 5px 0 10px;">‡¶¶‡ßà‡¶®‡¶ø‡¶ï ‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡¶∂‡¶® ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</h4><p><strong>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</strong> <span id="summaryReceiptDate">N/A</span></p><table><thead><tr><th style="text-align: left;">‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ/‡¶∞‡ßã‡¶≤</th><th style="text-align: right;">‡¶ü‡¶æ‡¶ï‡¶æ</th></tr></thead><tbody id="summaryReceiptTableBody"></tbody></table><hr style="border-top: 1px dashed #bbb; margin: 10px 0;"><p style="text-align: right; font-size: 1.2em; font-weight: bold;"><strong>‡¶Æ‡ßã‡¶ü ‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡¶∂‡¶®:</strong> <span id="summaryReceiptTotal">0</span> ‡¶ü‡¶æ‡¶ï‡¶æ</p><div class="receipt-footer" style="position: relative; margin-top: 20px;">&copy; Miracle Cadet & Academic Institute 2026 <br>Software by: ‡¶¨‡¶ø‡¶®‡ßç‡¶¶‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞‡¶æ ‡¶Ü‡¶á‡¶ü‡¶ø</div></div></div></div><div class="modal-footer print-hide" style="border-top: 1px solid var(--border-color); padding: 10px; background-color: var(--bg-tab);"><button id="btnPrintDailySummary" class="action-button btn-add">‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button><button id="btnCloseDailySummary" class="action-button">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button></div></div></div></template>
        <template id="template-find-trnx-id-page"><div class="page-section"><h2>Find Transaction ID</h2><p>Search for a transaction by its ID or browse the list of all successful transactions for the current year.</p><input type="search" id="trnxIdSearchInput" placeholder="Enter Transaction ID..." value="MCAI-" style="width: 100%; padding: 12px; font-size: 1.1em; margin-bottom: 20px; box-sizing: border-box;"><div id="trnx-results-container" style="max-height: 60vh; overflow-y: auto;"></div></div></template>
        <template id="template-camera-modal"><div id="cameraModal" class="modal-overlay"><div class="modal-content" style="max-width: 640px;"><div class="modal-header"><h2>‡¶õ‡¶¨‡¶ø ‡¶§‡ßÅ‡¶≤‡ßÅ‡¶®</h2><span class="close-button">&times;</span></div><div class="modal-body" style="text-align: center;"><video id="camera-video-feed" width="600" height="450" autoplay playsinline style="border-radius: 8px; background-color: #000; max-width: 100%;"></video><canvas id="camera-canvas" style="display:none;"></canvas></div><div class="modal-footer"><button id="capture-photo-btn" class="action-button btn-add">‡¶õ‡¶¨‡¶ø ‡¶§‡ßÅ‡¶≤‡ßÅ‡¶®</button></div></div></div></template>

        <footer><div class="developer-info">Developed by: ‡¶¨‡¶ø‡¶®‡ßç‡¶¶‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞‡¶æ ‡¶Ü‡¶á‡¶ü‡¶ø<br>‡¶™‡¶ø‡¶ü‡¶ø ‡¶Ü‡¶á ‡¶Æ‡ßã‡ßú, ‡¶¨‡¶ó‡ßÅ‡ßú‡¶æ<br>Whatsapp: 01745938158<br>Mail: bindumatrait@gmail.com</div></footer>
    </div>
    
<script>
// ================================================================== //
//            FIREBASE CONFIGURATION AND INITIALIZATION             //
// ================================================================== //
const firebaseConfig = {
  apiKey: "AIzaSyAnpbv9WhvOqV8nsbmVOQuBhKDF7D9-Ztc",
  authDomain: "miracle-math-online-software.firebaseapp.com",
  projectId: "miracle-math-online-software",
  storageBucket: "miracle-math-online-software.firebasestorage.app",
  messagingSenderId: "27829239296",
  appId: "1:27829239296:web:108d6b86969c95cea2a2e5",
  measurementId: "G-GSVFRCS9NR",
  databaseURL: "https://miracle-math-online-software-default-rtdb.asia-southeast1.firebasedatabase.app"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const credsRef = db.ref('credentials');

// ================================================================== //
//                LOGIN SCRIPT START                                //
// ================================================================== //
document.addEventListener('DOMContentLoaded', () => {
    const REMEMBER_KEY = 'mcth_rem_creds'; 
    const SESSION_KEY = 'mcth_is_logged_in';

    const loginContainer = document.getElementById('login-container');
    const appContainer = document.getElementById('app-container');
    const loginForm = document.getElementById('login-form');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const passwordToggle = document.getElementById('password-toggle');
    const rememberMeCheckbox = document.getElementById('remember-me');
    const errorMsgDiv = document.getElementById('login-error-msg');
    
    if (sessionStorage.getItem(SESSION_KEY) === 'true') {
        loginContainer.style.display = 'none';
        appContainer.classList.remove('hidden');
        firebase.auth().signInAnonymously().then(() => {
            initializeAppLogic();
        }).catch(err => {
            console.error("Anonymous sign-in failed on session restore:", err);
            errorMsgDiv.textContent = 'Authentication session restore failed.';
            loginContainer.style.display = 'flex';
            appContainer.classList.add('hidden');
        });
        return;
    }

    passwordToggle.addEventListener('click', () => {
        const isPassword = passwordInput.type === 'password';
        passwordInput.type = isPassword ? 'text' : 'password';
        passwordToggle.textContent = isPassword ? 'üôà' : 'üëÅÔ∏è';
    });

    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = usernameInput.value;
        const password = passwordInput.value;
        errorMsgDiv.textContent = '';

        try {
            await firebase.auth().signInAnonymously();
            const snapshot = await credsRef.once('value');
            let correctCreds = snapshot.exists() ? snapshot.val() : { username: "ashik'smathhome@602", password: "jaleswaritolamath25" };
            if (!snapshot.exists()) await credsRef.set(correctCreds);

            if (username === correctCreds.username && password === correctCreds.password) {
                if (rememberMeCheckbox.checked) {
                    localStorage.setItem(REMEMBER_KEY, JSON.stringify({ user: username, pass: password }));
                } else {
                    localStorage.removeItem(REMEMBER_KEY);
                }
                sessionStorage.setItem(SESSION_KEY, 'true'); 
                loginContainer.style.display = 'none';
                appContainer.classList.remove('hidden');
                initializeAppLogic();
            } else {
                errorMsgDiv.textContent = '‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ ‡¶¨‡¶æ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡ßü‡•§';
                firebase.auth().signOut();
            }
        } catch (error) {
            console.error("Firebase login error:", error);
            errorMsgDiv.textContent = '‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø ‡¶¨‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶®‡ßá‡¶á‡•§';
            if (firebase.auth().currentUser) firebase.auth().signOut();
        }
    });

    const rememberedCreds = localStorage.getItem(REMEMBER_KEY);
    if (rememberedCreds) {
        try {
            const creds = JSON.parse(rememberedCreds);
            usernameInput.value = creds.user;
            passwordInput.value = creds.pass;
            rememberMeCheckbox.checked = true;
        } catch(e) {
            localStorage.removeItem(REMEMBER_KEY);
        }
    }
});

// ======================================================= //
//          MAIN APPLICATION SCRIPT START                  //
// ======================================================= //
function initializeAppLogic() {
    const mainContentArea = document.getElementById('dynamic-content-placeholder');
    const bannerPlaceholder = document.getElementById('banner-area-placeholder');
    const breadcrumbContainer = document.getElementById('breadcrumb-container');
    const btnHome = document.getElementById('btnHome');
    const btnDashboard = document.getElementById('btnDashboard');
    const btnBatch = document.getElementById('btnBatch');
    const btnPayment = document.getElementById('btnPayment');
    const btnStudentDatabase = document.getElementById('btnStudentDatabase');
    const btnReports = document.getElementById('btnReports');
    const btnExam = document.getElementById('btnExam');
    const btnAttendance = document.getElementById('btnAttendance');
    const btnSms = document.getElementById('btnSms');
    const btnToggleMode = document.getElementById('btnToggleMode');
    const currentModeDisplay = document.getElementById('currentModeDisplay');
    const btnPrivacyMenu = document.getElementById('btnPrivacyMenu');
    const privacyDropdown = document.getElementById('privacyDropdown');
    const btnToggleYearBar = document.getElementById('btnToggleYearBar');
    const btnChangePassword = document.getElementById('btnChangePassword');
    const btnForgotPassword = document.getElementById('btnForgotPassword');
    const btnShowHistory = document.getElementById('btnShowHistory');
    const btnRecycleBin = document.getElementById('btnRecycleBin');
    const btnFindTrnxId = document.getElementById('btnFindTrnxId');
    const btnClearYearData = document.getElementById('btnClearYearData');
    const btnToggleTheme = document.getElementById('btnToggleTheme');
    const btnBackupMenuToggle = document.getElementById('btnBackupMenuToggle');
    const backupSubMenu = document.getElementById('backupSubMenu');
    const btnExportData = document.getElementById('btnExportData');
    const btnImportData = document.getElementById('btnImportData');
    const fileImporter = document.getElementById('fileImporter');
    const btnNavBack = document.getElementById('btnNavBack');
    const btnNavForward = document.getElementById('btnNavForward');
    const btnNavRefresh = document.getElementById('btnNavRefresh');
    const btnLogout = document.getElementById('btnLogout');
    const btnAboutDeveloper = document.getElementById('btnAboutDeveloper');
    let bulkStudentImportInput, btnBulkImport;

    let isAdminMode = sessionStorage.getItem('isAdminMode') === 'true';
    let currentPassword = '';
    let viewedYear = new Date().getFullYear();
    let activeYear = new Date().getFullYear();
    let availableYears = [];
    let dbRef;
    let smsManagementData = {};
    const resetDefaultPassword = 'rafi@602';
    const THEME_KEY = 'gonitAppTheme';
    const YEAR_BAR_HIDDEN_KEY = 'mcth_year_bar_hidden';
    const LAST_RECEIVER_NAME_KEY = 'mcth_last_receiver_name'; 
    let appData = {};
    let isSaving = false; 
    let dataLoaded = false; 

    let currentStudentContext = null;
    let pageHistory = [];
    let historyIndex = -1;
    const BENGALI_MONTHS=["‡¶ú‡¶æ‡¶®‡ßÅ‡ßü‡¶æ‡¶∞‡¶ø","‡¶´‡ßá‡¶¨‡ßç‡¶∞‡ßÅ‡ßü‡¶æ‡¶∞‡¶ø","‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö","‡¶è‡¶™‡ßç‡¶∞‡¶ø‡¶≤","‡¶Æ‡ßá","‡¶ú‡ßÅ‡¶®","‡¶ú‡ßÅ‡¶≤‡¶æ‡¶á","‡¶Ü‡¶ó‡¶∏‡ßç‡¶ü","‡¶∏‡ßá‡¶™‡ßç‡¶ü‡ßá‡¶Æ‡ßç‡¶¨‡¶∞","‡¶Ö‡¶ï‡ßç‡¶ü‡ßã‡¶¨‡¶∞","‡¶®‡¶≠‡ßá‡¶Æ‡ßç‡¶¨‡¶∞","‡¶°‡¶ø‡¶∏‡ßá‡¶Æ‡ßç‡¶¨‡¶∞"];
    
    // UTILITY & HELPER FUNCTIONS
    async function processAndCompressImage(source, targetSizeKB = 300) {
        const MAX_SIZE_BYTES = targetSizeKB * 1024;
        const sourceUrl = (source instanceof Blob || source instanceof File) ? URL.createObjectURL(source) : source;

        return new Promise((resolve, reject) => {
            const img = new Image();
            img.src = sourceUrl;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                let width = img.width;
                let height = img.height;
                const MAX_DIMENSION = 1024;

                if (width > height) {
                    if (width > MAX_DIMENSION) {
                        height *= MAX_DIMENSION / width;
                        width = MAX_DIMENSION;
                    }
                } else {
                    if (height > MAX_DIMENSION) {
                        width *= MAX_DIMENSION / height;
                        height = MAX_DIMENSION;
                    }
                }
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                URL.revokeObjectURL(sourceUrl);

                let quality = 0.9;
                let dataUrl = canvas.toDataURL('image/jpeg', quality);
                while (dataUrl.length * 0.75 > MAX_SIZE_BYTES && quality > 0.1) {
                    quality -= 0.1;
                    dataUrl = canvas.toDataURL('image/jpeg', quality);
                }
                if (dataUrl.length * 0.75 > MAX_SIZE_BYTES) {
                    return reject(new Error(`‡¶õ‡¶¨‡¶ø‡¶ü‡¶ø ${targetSizeKB}KB ‡¶è‡¶∞ ‡¶®‡¶ø‡¶ö‡ßá ‡¶Ü‡¶®‡¶æ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶π‡ßü‡¶®‡¶ø‡•§`));
                }
                resolve(dataUrl);
            };
            img.onerror = error => {
                URL.revokeObjectURL(sourceUrl);
                reject(error);
            };
        });
    }

    let activeCameraStream = null;
    function showCameraModal(onCapture) {
        const modalFragment = cloneTemplate('template-camera-modal');
        if (!modalFragment) {
            showToast('‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶´‡¶ø‡¶ö‡¶æ‡¶∞‡¶ü‡¶ø ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§', 'error');
            return;
        }
        document.body.appendChild(modalFragment);
        const modal = document.getElementById('cameraModal');
        const video = document.getElementById('camera-video-feed');
        const canvas = document.getElementById('camera-canvas');
        const captureBtn = document.getElementById('capture-photo-btn');
        const closeBtn = modal.querySelector('.close-button');

        const stopCamera = () => { if (activeCameraStream) { activeCameraStream.getTracks().forEach(track => track.stop()); activeCameraStream = null; } };
        const closeModal = () => { stopCamera(); modal.remove(); };

        closeBtn.onclick = closeModal;
        modal.onclick = (e) => { if (e.target === modal) closeModal(); };

        navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } })
            .then(stream => { activeCameraStream = stream; video.srcObject = stream; modal.classList.add('visible'); })
            .catch(err => { console.error("Error accessing camera:", err); showToast('‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶™‡¶æ‡¶∞‡¶Æ‡¶ø‡¶∂‡¶® ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§', 'error'); closeModal(); });

        captureBtn.onclick = () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
            canvas.toBlob(blob => { if (onCapture) { onCapture(blob); } closeModal(); }, 'image/jpeg');
        };
    }

    function handleImageError(imgElement) { if (imgElement.src.includes('default_avatar.png')) return; imgElement.src = 'images/default_avatar.png'; }
    function getDbRefForYear(year) { return db.ref(`academicYears/${year}/data`); }
    function paymentIsDue(monthIndex, year) { const now = new Date(); const currentMonthIndex = now.getMonth(); const currentYear = now.getFullYear(); const dueDateThreshold = 10; if (year < currentYear) return true; if (year > currentYear) return false; if (monthIndex < currentMonthIndex) return true; if (monthIndex > currentMonthIndex) return false; return now.getDate() > dueDateThreshold; }
    function isStudentDue(student, year) { if (!student || !student.monthlyPayments) return false; if (student.admissionFee?.status !== 'paid' && student.admissionFee?.amount > 0) return true; const admissionDate = student.createdAt ? new Date(student.createdAt) : new Date(year, 0, 1); for (let i = 0; i < 12; i++) { const monthDate = new Date(year, i, 1); if (monthDate < new Date(admissionDate.getFullYear(), admissionDate.getMonth(), 1)) continue; const monthName = BENGALI_MONTHS[i]; const payment = student.monthlyPayments[monthName]; const defaultFee = student.monthlyFeeDefault || 0; const isMonthCurrentlyDue = paymentIsDue(i, year); if (isMonthCurrentlyDue && ((payment && payment.status !== 'paid' && payment.fee > 0) || (!payment && defaultFee > 0))) { return true; } } return false; }
    function calculateStudentOutstandingAmount(student, year) { let totalDue = 0; if(!student || !student.monthlyPayments) return 0; const admissionDate = student.createdAt ? new Date(student.createdAt) : new Date(year, 0, 1); if (student.admissionFee && student.admissionFee.status !== 'paid' && student.admissionFee.amount > 0) { totalDue += student.admissionFee.amount; } for (let i = 0; i < 12; i++) { const monthDate = new Date(year, i, 1); if (monthDate < new Date(admissionDate.getFullYear(), admissionDate.getMonth(), 1)) continue; const monthName = BENGALI_MONTHS[i]; const payment = student.monthlyPayments[monthName]; const defaultFee = student.monthlyFeeDefault || 0; const isMonthCurrentlyDue = paymentIsDue(i, year); if (isMonthCurrentlyDue) { if (payment && payment.status !== 'paid' && payment.fee > 0) { totalDue += payment.fee; } else if (!payment && defaultFee > 0) { totalDue += defaultFee; } } } return totalDue; }
    function calculateOverdueMonths(student, year) { const overdueMonthsList = []; if(!student || !student.monthlyPayments) return ""; const admissionDate = student.createdAt ? new Date(student.createdAt) : new Date(year, 0, 1); for (let i = 0; i < 12; i++) { const monthDate = new Date(year, i, 1); if (monthDate < new Date(admissionDate.getFullYear(), admissionDate.getMonth(), 1)) continue; const monthName = BENGALI_MONTHS[i]; const payment = student.monthlyPayments[monthName]; const defaultFee = student.monthlyFeeDefault || 0; const isMonthCurrentlyDue = paymentIsDue(i, year); let hasOutstanding = false; if (isMonthCurrentlyDue) { if ((payment && payment.status !== 'paid' && payment.fee > 0) || (!payment && defaultFee > 0)) { hasOutstanding = true; } } if (hasOutstanding) { overdueMonthsList.push(monthName); } } return overdueMonthsList.join(', '); }
    function showToast(message, type = 'info', duration = 3000) { const container = document.getElementById('toast-container'); if (!container) return; const toast = document.createElement('div'); toast.className = `toast ${type}`; toast.textContent = message; container.appendChild(toast); setTimeout(() => toast.classList.add('show'), 10); setTimeout(() => { toast.classList.remove('show'); toast.addEventListener('transitionend', () => toast.remove()); }, duration); }
    function showLoader() { const l = document.getElementById('loader-overlay'); if(l) l.style.display = 'flex'; }
    function hideLoader() { const l = document.getElementById('loader-overlay'); if(l) l.style.display = 'none'; }
    function applyTheme(theme) { const themeIcon = document.getElementById('themeIcon'); document.body.setAttribute('data-theme', theme); if(themeIcon) themeIcon.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô'; }
    function toggleTheme() { const currentTheme = document.body.getAttribute('data-theme') || 'light'; const newTheme = currentTheme === 'light' ? 'dark' : 'light'; localStorage.setItem(THEME_KEY, newTheme); applyTheme(newTheme); }
    
    // FIREBASE DATA HANDLING
    async function getCombinedDataForAllYears() { const academicYearsRef = db.ref('academicYears'); const snapshot = await academicYearsRef.once('value'); if (!snapshot.exists()) return { students: [], activityLog: [], classes: [] }; const yearsData = snapshot.val(); const yearKeys = Object.keys(yearsData); const promises = yearKeys.map(year => getDbRefForYear(year).once('value')); const yearSnapshots = await Promise.all(promises); const combinedData = { students: [], activityLog: [], classes: [] }; yearSnapshots.forEach((yearSnap, index) => { const year = yearKeys[index]; const data = yearSnap.val(); if (data) { if (data.students) { combinedData.students.push(...data.students.map(s => ({ ...s, academicYear: year }))); } if (data.activityLog) { combinedData.activityLog.push(...data.activityLog.map(log => ({ ...log, academicYear: year }))); } if(data.mainClassCategories) { combinedData.classes.push(...data.mainClassCategories); } } }); const uniqueClasses = Array.from(new Map(combinedData.classes.map(item => [item.id, item])).values()); combinedData.classes = uniqueClasses; return combinedData; }
    function getInitialDataStructure() { return { currentPassword: 'ashik@602', mainClassCategories: [ { id: 'c_1', name: '‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡ß¨', defaultMonthlyFee: 300, defaultAdmissionFee: 500 }, { id: 'c_2', name: '‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡ß≠', defaultMonthlyFee: 350, defaultAdmissionFee: 500 }, { id: 'c_3', name: '‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡ßÆ', defaultMonthlyFee: 400, defaultAdmissionFee: 500 }, { id: 'c_4', name: '‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡ßØ', defaultMonthlyFee: 450, defaultAdmissionFee: 600 }, { id: 'c_5', name: '‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡ßß‡ß¶', defaultMonthlyFee: 500, defaultAdmissionFee: 600 }, ], students: [], batchSchedule: [ { id: 'd_1', dayName: '‡¶∂‡¶®‡¶ø‡¶¨‡¶æ‡¶∞', classes: [{ id: 'cs_1', classId: 'c_1', batches: [{ id: 'b_1', time: '‡¶¨‡¶ø‡¶ï‡¶æ‡¶≤ ‡ß™:00 - ‡ß´:00', capacity: 50, studentIds: [] }] }] }, { id: 'd_2', dayName: '‡¶∞‡¶¨‡¶ø‡¶¨‡¶æ‡¶∞', classes: [{ id: 'cs_2', classId: 'c_2', batches: [{ id: 'b_2', time: '‡¶¨‡¶ø‡¶ï‡¶æ‡¶≤ ‡ß™:00 - ‡ß´:00', capacity: 50, studentIds: [] }] }] }, { id: 'd_3', dayName: '‡¶∏‡ßã‡¶Æ‡¶¨‡¶æ‡¶∞', classes: [{ id: 'cs_3', classId: 'c_3', batches: [{ id: 'b_3', time: '‡¶¨‡¶ø‡¶ï‡¶æ‡¶≤ ‡ß™:00 - ‡ß´:00', capacity: 50, studentIds: [] }] }] }, { id: 'd_4', dayName: '‡¶Æ‡¶ô‡ßç‡¶ó‡¶≤‡¶¨‡¶æ‡¶∞', classes: [{ id: 'cs_4', classId: 'c_4', batches: [{ id: 'b_4', time: '‡¶¨‡¶ø‡¶ï‡¶æ‡¶≤ ‡ß´:00 - ‡ß¨:00', capacity: 40, studentIds: [] }] }] }, { id: 'd_5', dayName: '‡¶¨‡ßÅ‡¶ß‡¶¨‡¶æ‡¶∞', classes: [{ id: 'cs_5', classId: 'c_5', batches: [{ id: 'b_5', time: '‡¶¨‡¶ø‡¶ï‡¶æ‡¶≤ ‡ß´:00 - ‡ß¨:00', capacity: 40, studentIds: [] }] }] } ], nextRollNumber: 1, activityLog: [], recycleBin: { students: [], mainClassCategories: [], batchSchedule: [] } }; }
    async function saveAppData() { if (!appData || !dataLoaded || isSaving) return; isSaving = true; try { appData.currentPassword = currentPassword; await dbRef.set(appData); } catch (e) { console.error("Error saving data to Firebase:", e); showToast("‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!", 'error'); } finally { isSaving = false; hideLoader(); } }

    function loadAppData(yearToLoad) {
        showLoader();
        viewedYear = yearToLoad;
        localStorage.setItem('mcth_viewed_year', viewedYear);
    
        if (dbRef && typeof dbRef.off === 'function') {
            dbRef.off();
        }
    
        dbRef = getDbRefForYear(yearToLoad);
    
        dbRef.on('value', (dataSnapshot) => {
            if (isSaving) {
                return;
            }
            
            if (dataSnapshot.exists()) {
                appData = dataSnapshot.val();
                if (!appData.students) appData.students = [];
                if (!appData.mainClassCategories) appData.mainClassCategories = []; 
                if (!appData.batchSchedule) appData.batchSchedule = [];
                if (!appData.recycleBin) appData.recycleBin = { students: [], mainClassCategories: [], batchSchedule: [] };
                if (appData.activityLog && !Array.isArray(appData.activityLog)) {
                    appData.activityLog = Object.values(appData.activityLog);
                } else if (!appData.activityLog) {
                    appData.activityLog = [];
                }

                (appData.students || []).forEach(s => { if (s) { if(!s.createdAt) s.createdAt = new Date(yearToLoad, 0, 1).toISOString(); if (!s.monthlyPayments) s.monthlyPayments = {}; if (!s.admissionFee) s.admissionFee = { amount: 0, status: 'due', receiver: '', date: null, token: null }; } });
                currentPassword = appData.currentPassword || 'ashik@602';
            } else {
                console.log(`No data for year ${yearToLoad}. Initializing...`);
                appData = getInitialDataStructure();
                currentPassword = appData.currentPassword;
                dbRef.set(appData); 
            }
            
            updateYearSelectorUI();

            if (!dataLoaded) {
                dataLoaded = true;
                const sessionState = sessionStorage.getItem('mcth_session_state');
                if (sessionState) {
                    try {
                        const { page, context } = JSON.parse(sessionState);
                        pageHistory = [{ page, context }]; 
                        historyIndex = 0;
                        if(window[page]) {
                           loadPage(window[page], context, true);
                        } else {
                           loadPage(showHomePage, {});
                        }
                    } catch (e) {
                        loadPage(showHomePage, {});
                    }
                } else {
                    loadPage(showHomePage, {});
                }
            } else {
                const currentState = pageHistory[historyIndex];
                if (currentState && window[currentState.page]) {
                    loadPage(window[currentState.page], currentState.context, true); 
                }
            }
            if(dataLoaded) hideLoader();

        }, (error) => { 
            console.error("Firebase read failed: " + error.code, error.message); 
            showToast("‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§ Rules ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§", "error"); 
            hideLoader(); 
        });
    }

    function generateNextRollNumber(){ const roll = appData.nextRollNumber || 1; appData.nextRollNumber = roll + 1; return String(roll).padStart(2, '0'); }
    function generateToken() { return `MCAI-${Math.random().toString(36).substring(2, 7).toUpperCase()}`; }
    function logActivity(message, details = {}) { if (!appData.activityLog) { appData.activityLog = []; } appData.activityLog.unshift({ timestamp: new Date().toISOString(), message, ...details }); if (appData.activityLog.length > 200) appData.activityLog.pop(); }
    function handleExport(){ if (!appData) { showToast('‡¶ï‡ßã‡¶®‡ßã ‡¶°‡ßá‡¶ü‡¶æ ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§', 'error'); return; } try { const dataStr = JSON.stringify(appData, null, 2); const dataBlob = new Blob([dataStr], { type: 'application/json' }); const url = URL.createObjectURL(dataBlob); const link = document.createElement('a'); link.href = url; link.download = `miracle_backup_${viewedYear}_${new Date().toISOString().split('T')[0]}.json`; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url); showToast(`‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶¨‡¶∞‡ßç‡¶∑ ${viewedYear} ‡¶è‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`, 'success'); } catch (e) { console.error('Error exporting data:', e); showToast('‡¶°‡ßá‡¶ü‡¶æ ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', 'error'); } }
    function handleImport(event){ const file = event.target.files[0]; if (!file) return; if (!confirm(`‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶¨‡¶∞‡ßç‡¶∑ (${viewedYear}) ‡¶è‡¶∞ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶°‡ßá‡¶ü‡¶æ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡ßá ‡¶´‡¶æ‡¶á‡¶≤ ‡¶•‡ßá‡¶ï‡ßá ‡¶®‡¶§‡ßÅ‡¶® ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®? ‡¶è‡¶á ‡¶ï‡¶æ‡¶ú‡¶ü‡¶ø ‡¶Ü‡¶∞ ‡¶´‡ßá‡¶∞‡¶æ‡¶®‡ßã ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ‡•§`)) { event.target.value = ''; return; } const reader = new FileReader(); reader.onload = (e) => { try { const importedData = JSON.parse(e.target.result); const isValid = importedData && typeof importedData.currentPassword === 'string' && Array.isArray(importedData.students); if (isValid) { showLoader(); appData = importedData; dbRef.set(appData).then(() => { showToast(`‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶¨‡¶∞‡ßç‡¶∑ ${viewedYear} ‡¶è ‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶á‡¶Æ‡ßç‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ì ‡¶∏‡¶ø‡¶ô‡ßç‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`, 'success'); hideLoader(); }); } else { showToast('‡¶´‡¶æ‡¶á‡¶≤‡ßá‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡¶†‡¶ø‡¶ï ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü‡ßá ‡¶®‡ßá‡¶á‡•§', 'error'); } } catch (error) { console.error('Error parsing imported file:', error); showToast('‡¶´‡¶æ‡¶á‡¶≤‡¶ü‡¶ø ‡¶™‡ßú‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', 'error'); } finally { event.target.value = ''; } }; reader.readAsText(file); }
    function findStudentById(studentId){ return (appData.students || []).find(s => s && s.id === studentId) || null; }
    function findClassById(classId){ return (appData.mainClassCategories || []).find(c => c && c.id === classId) || null; }
    function findBatchById(batchId){ if (!appData.batchSchedule) return null; for(const day of appData.batchSchedule){ if(!day || day.deletedAt || !day.classes) continue; for(const cls of day.classes){ if(!cls || cls.deletedAt || !cls.batches) continue; const batch = cls.batches.find(b => b && b.id === batchId); if(batch) return {batch, classSchedule: cls, day}; } } return null; }
    function findBatchesForStudent(studentId){ const foundBatches = []; if (!appData.batchSchedule) return foundBatches; appData.batchSchedule.forEach(day => { if(!day || day.deletedAt || !day.classes) return; day.classes.forEach(classSchedule => { if(!classSchedule || classSchedule.deletedAt || !classSchedule.batches) return; classSchedule.batches.forEach(batch => { if(batch && batch.studentIds && batch.studentIds.includes(studentId)){ const classInfo = findClassById(classSchedule.classId); foundBatches.push({ id: batch.id, day: day.dayName, className: classInfo?.name || 'Unknown', time: batch.time, classId: classSchedule.classId }); } }); }); }); return foundBatches; }
    function updateAdminModeUI(){ document.body.classList.toggle('admin-mode-active', isAdminMode); currentModeDisplay.textContent = isAdminMode ? 'Admin' : 'Assistant'; currentModeDisplay.classList.toggle('admin-active', isAdminMode); currentModeDisplay.classList.toggle('assistant-active', !isAdminMode); btnToggleMode.textContent = isAdminMode ? 'Exit' : 'Admin'; document.querySelectorAll('.admin-only').forEach(el => el.classList.toggle('hidden', !isAdminMode)); document.querySelectorAll('.assistant-disabled').forEach(el => { el.disabled = !isAdminMode; }); sessionStorage.setItem('isAdminMode', isAdminMode); }
    function loadPage(pageFunction, context = {}, isNavigating = false) { if (!isNavigating) { const state = { page: pageFunction.name, context }; if (historyIndex < pageHistory.length - 1) { pageHistory = pageHistory.slice(0, historyIndex + 1); } pageHistory.push(state); historyIndex = pageHistory.length - 1; } const stateToSave = { page: pageFunction.name, context: context }; sessionStorage.setItem('mcth_session_state', JSON.stringify(stateToSave)); breadcrumbContainer.innerHTML = ''; if (context.breadcrumbs) { context.breadcrumbs.forEach((crumb, index) => { const crumbElement = document.createElement('a'); crumbElement.href = '#'; crumbElement.textContent = crumb.text; crumbElement.onclick = (e) => { e.preventDefault(); const navState = pageHistory.find(p => p.page === crumb.pageFn.name); if(navState) { loadPage(crumb.pageFn, navState.context, true); } else if (crumb.pageFn) { loadPage(crumb.pageFn, crumb.context || {}, true); } }; breadcrumbContainer.appendChild(crumbElement); if (index < context.breadcrumbs.length - 1) { breadcrumbContainer.append(' / '); } }); } mainContentArea.innerHTML = ''; bannerPlaceholder.style.display = 'none'; try { if (typeof pageFunction === 'function') { pageFunction(context); } else { mainContentArea.innerHTML = `<p style="color:red; text-align:center;">‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ‡¶ü‡¶ø ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§</p>`; } } catch (e) { console.error("Error loading page:", e, "Context:", context); mainContentArea.innerHTML = `<p style="color:red; text-align:center;">‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§, ‡¶è‡¶á ‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ‡¶ü‡¶ø ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶è‡¶ï‡¶ü‡¶ø ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶ò‡¶ü‡ßá‡¶õ‡ßá‡•§</p>`; } updateAdminModeUI(); updateNavButtons(); }
    function updateNavButtons() { const backIcon = document.querySelector('#btnNavBack .nav-icon-svg'); const forwardIcon = document.querySelector('#btnNavForward .nav-icon-svg'); if(backIcon) backIcon.classList.toggle('disabled', historyIndex <= 0); if(forwardIcon) forwardIcon.classList.toggle('disabled', historyIndex >= pageHistory.length - 1); }
    function cloneTemplate(templateId){ return document.getElementById(templateId)?.content.cloneNode(true); }
    function closeDropdownAndRun(action){ privacyDropdown.classList.remove('active'); backupSubMenu.classList.remove('open'); btnBackupMenuToggle.classList.remove('open'); if(action) action(); }
    
    function listenForSmsSettingsChanges() {
        const smsManagementRef = db.ref('smsManagement');
        smsManagementRef.on('value', (snapshot) => {
            if (snapshot.exists()) {
                smsManagementData = snapshot.val();
                console.log('SMS settings updated in real-time:', smsManagementData);
            } else {
                smsManagementData = { automation: {} };
            }
        });
    }

    // PAGE RENDERING FUNCTIONS
    let sliderInterval; function showHomePage(context = {}) { context.breadcrumbs = [{ text: '‡¶π‡ßã‡¶Æ', pageFn: showHomePage }]; bannerPlaceholder.innerHTML = '<img src="images/image1.png" alt="Main Banner" onerror="this.style.display=\'none\';">'; bannerPlaceholder.style.display = 'block'; mainContentArea.appendChild(cloneTemplate('template-home')); const slider = document.getElementById('homeImageSlider'); let currentImage = 3; if(sliderInterval) clearInterval(sliderInterval); if(slider) { sliderInterval = setInterval(() => { slider.style.opacity = 0; setTimeout(() => { currentImage = currentImage === 3 ? 4 : 3; slider.src = `images/image${currentImage}.png`; slider.style.opacity = 1; }, 1000); }, 4000); } }
    
    function showDashboardPage(context = {}) {
        context.breadcrumbs = [{ text: '‡¶π‡ßã‡¶Æ', pageFn: showHomePage }, { text: '‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°' }];
        mainContentArea.appendChild(cloneTemplate('template-dashboard'));
        const grid = document.querySelector('.dashboard-grid');
        if (!grid) return;

        grid.innerHTML = `
            <div class="dashboard-card card-students" title="‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ${viewedYear} ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶¨‡¶∞‡ßç‡¶∑‡ßá‡¶∞ ‡¶õ‡¶æ‡¶§‡ßç‡¶∞-‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßÄ"><h4>‡¶Æ‡ßã‡¶ü ‡¶õ‡¶æ‡¶§‡ßç‡¶∞-‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßÄ (${viewedYear})</h4><p class="stat-number" id="db-total-students">...</p></div>
            <div class="dashboard-card card-batches" title="‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ${viewedYear} ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶¨‡¶∞‡ßç‡¶∑‡ßá‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö"><h4>‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡ßü ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö (${viewedYear})</h4><p class="stat-number" id="db-active-batches">...</p></div>
            <div class="dashboard-card card-collection" title="‡¶∏‡¶ï‡¶≤ ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶¨‡¶∞‡ßç‡¶∑ ‡¶Æ‡¶ø‡¶≤‡¶ø‡ßü‡ßá"><h4>‡¶ö‡¶≤‡¶§‡¶ø ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶Ü‡ßü (‡¶∏‡¶¨)</h4><p class="stat-number" id="db-month-income">... ‡ß≥</p><button class="details-button" data-type="collection" disabled>‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§</button></div>
            <div class="dashboard-card card-due" title="‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ${viewedYear} ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶¨‡¶∞‡ßç‡¶∑‡ßá‡¶∞ ‡¶¨‡¶ï‡ßá‡ßü‡¶æ"><h4>‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ï‡ßá‡ßü‡¶æ (${viewedYear})</h4><p class="stat-number" id="db-total-due">... ‡ß≥</p><button class="details-button" data-type="due" disabled>‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§</button></div>
            <div class="dashboard-card card-paid-students" title="‡¶∏‡¶ï‡¶≤ ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶¨‡¶∞‡ßç‡¶∑ ‡¶Æ‡¶ø‡¶≤‡¶ø‡ßü‡ßá"><h4>‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡¶ï‡ßÉ‡¶§ ‡¶õ‡¶æ‡¶§‡ßç‡¶∞ (‡¶∏‡¶¨)</h4><p class="stat-number" id="db-paid-students">...</p></div>
            <div class="dashboard-card card-due-students" title="‡¶∏‡¶ï‡¶≤ ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶¨‡¶∞‡ßç‡¶∑ ‡¶Æ‡¶ø‡¶≤‡¶ø‡ßü‡ßá"><h4>‡¶¨‡¶ï‡ßá‡ßü‡¶æ ‡¶•‡¶æ‡¶ï‡¶æ ‡¶õ‡¶æ‡¶§‡ßç‡¶∞ (‡¶∏‡¶¨)</h4><p class="stat-number" id="db-due-students">...</p></div>
        `;

        const totalStudentsThisYear = (appData.students || []).filter(s => s && !s.deletedAt).length;
        const activeBatchesThisYear = (appData.batchSchedule || [])
            .flatMap(day => (day.classes || []))
            .filter(cls => !cls.deletedAt)
            .flatMap(cls => (cls.batches || []))
            .filter(batch => !batch.deletedAt).length;
        
        document.getElementById('db-total-students').textContent = totalStudentsThisYear.toLocaleString('bn-BD');
        document.getElementById('db-active-batches').textContent = activeBatchesThisYear.toLocaleString('bn-BD');
        
        let studentsWithDuesForDetails_ThisYear = [];
        let currentMonthIncomeDetails = [];

        getCombinedDataForAllYears().then(combinedData => {
            const allStudents = combinedData.students;
            const allClassCategories = combinedData.classes;
            
            let totalStudentsWithAnyDues = 0;
            let totalOutstandingAmountThisYear = 0;
            let currentMonthIncome = 0;

            const now = new Date();
            const currentMonthIndex = now.getMonth();
            const currentBengaliMonth = BENGALI_MONTHS[currentMonthIndex];

            (allStudents || []).forEach(student => {
                if (!student || student.deletedAt) return;
                const studentYear = parseInt(student.academicYear);
                const studentDueAmount = calculateStudentOutstandingAmount(student, studentYear);
                if (studentDueAmount > 0) {
                    totalStudentsWithAnyDues++;
                }
            });
            const paidStudentsCountOverall = (allStudents || []).filter(s => s && !s.deletedAt).length - totalStudentsWithAnyDues;
            
            (appData.students || []).filter(s => s && !s.deletedAt).forEach(student => {
                const studentDueAmount = calculateStudentOutstandingAmount(student, viewedYear);
                if (studentDueAmount > 0) {
                    totalOutstandingAmountThisYear += studentDueAmount;
                    const classInfo = findClassById(student.classId);
                    let batchInfoString = findBatchesForStudent(student.id).map(b => `${b.day.substring(0,3)} (${b.time})`).join(', ') || 'N/A';
                    studentsWithDuesForDetails_ThisYear.push({ id: student.id, name: student.name, roll: student.roll, classId: student.classId, class: classInfo?.name || 'N/A', totalDueAmount: studentDueAmount, overdueMonths: calculateOverdueMonths(student, viewedYear), academicYear: viewedYear, batchInfo: batchInfoString });
                }
            });
            
            allStudents.forEach(student => {
                 if (!student || student.deletedAt) return;
                 const classInfo = allClassCategories.find(c => c.id === student.classId);
                
                if (student.admissionFee?.status === 'paid' && student.admissionFee.date) {
                    const admissionDate = new Date(student.admissionFee.date);
                    if (admissionDate.getMonth() === currentMonthIndex && admissionDate.getFullYear() === now.getFullYear()) {
                        currentMonthIncome += (student.admissionFee.amount || 0);
                        currentMonthIncomeDetails.push({ studentId: student.id, name: student.name, roll: student.roll, classId: student.classId, class: classInfo?.name || 'N/A', amount: student.admissionFee.amount, type: '‡¶≠‡¶∞‡ßç‡¶§‡¶ø ‡¶´‡¶ø', academicYear: student.academicYear });
                    }
                }
                const payment = (student.monthlyPayments || {})[currentBengaliMonth];
                if (payment && payment.status === 'paid' && payment.date) {
                    const paymentDate = new Date(payment.date);
                    if (paymentDate.getMonth() === currentMonthIndex && paymentDate.getFullYear() === now.getFullYear()) {
                        currentMonthIncome += (payment.fee || 0);
                        currentMonthIncomeDetails.push({ studentId: student.id, name: student.name, roll: student.roll, classId: student.classId, class: classInfo?.name || 'N/A', amount: payment.fee, type: `‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶´‡¶ø (${currentBengaliMonth})`, academicYear: student.academicYear });
                    }
                }
            });

            document.getElementById('db-month-income').textContent = `${currentMonthIncome.toLocaleString('bn-BD')} ‡ß≥`;
            document.getElementById('db-total-due').textContent = `${totalOutstandingAmountThisYear.toLocaleString('bn-BD')} ‡ß≥`;
            document.getElementById('db-paid-students').textContent = paidStudentsCountOverall.toLocaleString('bn-BD');
            document.getElementById('db-due-students').textContent = totalStudentsWithAnyDues.toLocaleString('bn-BD');
            
            document.querySelector('[data-type="collection"]').disabled = false;
            document.querySelector('[data-type="due"]').disabled = false;

        }).catch(err => {
            console.error("Error loading full dashboard data:", err);
            ['db-month-income', 'db-total-due', 'db-paid-students', 'db-due-students'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = 'Error';
            });
        });

        grid.addEventListener('click', (e) => {
            if (e.target.classList.contains('details-button') && !e.target.disabled) {
                const type = e.target.dataset.type;
                const dataToShow = type === 'due' ? studentsWithDuesForDetails_ThisYear : currentMonthIncomeDetails;
                loadPage(showDashboardDetailsPage, { type, breadcrumbs: [...context.breadcrumbs, { text: '‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ' }], detailedData: dataToShow });
            }
        });
    }

    function showDashboardDetailsPage({ type, breadcrumbs, detailedData }) { mainContentArea.appendChild(cloneTemplate('template-dashboard-details-page')); const now = new Date(); const currentBengaliMonth = BENGALI_MONTHS[now.getMonth()]; let pageTitle = ''; if (type === 'collection') { pageTitle = `‡¶ö‡¶≤‡¶§‡¶ø ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ (${currentBengaliMonth}) ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡¶ø‡¶§ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ (‡¶∏‡¶ï‡¶≤ ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶¨‡¶∞‡ßç‡¶∑)`; } else if (type === 'due') { pageTitle = `‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶¨‡¶∞‡ßç‡¶∑ ${viewedYear} ‡¶è‡¶∞ ‡¶∏‡¶ï‡¶≤ ‡¶¨‡¶ï‡ßá‡ßü‡¶æ‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ`; } document.getElementById('detailsListPageTitle').textContent = pageTitle; const classFilter = document.getElementById('detailsPageClassFilter'); const batchFilter = document.getElementById('detailsPageBatchFilter'); const tableBody = document.getElementById('detailsPageTableBody'); const summaryDiv = document.getElementById('detailsPageSummary'); const originalDetailedData = detailedData; function renderTable(dataToRender) { tableBody.innerHTML = ''; if (!dataToRender || dataToRender.length === 0) { tableBody.innerHTML = `<tr><td colspan="7" style="text-align: center;">‡¶ï‡ßã‡¶®‡ßã ‡¶§‡¶•‡ßç‡¶Ø ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§</td></tr>`; summaryDiv.textContent = ''; return; } let totalAmount = 0; let studentCountSet = new Set(); dataToRender.sort((a, b) => (parseInt(a.roll, 10) || 0) - (parseInt(b.roll, 10) || 0)); dataToRender.forEach((s, index) => { const tr = document.createElement('tr'); const studentYear = parseInt(s.academicYear); const yearLabel = studentYear !== viewedYear && type === 'collection' ? ` (${s.academicYear})` : ''; let rowHtml = `<td class="serial-number-column">${index + 1}.</td> <td><strong>${s.name}${yearLabel}</strong></td> <td><strong>${s.roll}</strong></td> <td><strong>${s.class || 'N/A'}</strong></td> <td>${s.batchInfo || 'N/A'}</td>`; if (type === 'collection') { rowHtml += `<td>${s.type}</td> <td style="text-align:right; padding-right:15px;">${(s.amount || 0).toLocaleString('bn-BD')}</td>`; totalAmount += (s.amount || 0); } else { rowHtml += `<td><strong>${s.totalDueAmount ? s.totalDueAmount.toLocaleString('bn-BD') : 'N/A'}</strong></td> <td title="${s.overdueMonths}">${s.overdueMonths ? s.overdueMonths.split(', ').slice(0, 2).join(', ') + (s.overdueMonths.split(', ').length > 2 ? '...' : '') : 'N/A'}</td>`; totalAmount += s.totalDueAmount; studentCountSet.add(s.id); } tr.innerHTML = rowHtml; tableBody.appendChild(tr); }); if (type === 'due') { summaryDiv.innerHTML = `‡¶Æ‡ßã‡¶ü ‡¶õ‡¶æ‡¶§‡ßç‡¶∞: ${studentCountSet.size} ‡¶ú‡¶® | ‡¶Æ‡ßã‡¶ü ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£: ${totalAmount.toLocaleString('bn-BD')} ‡¶ü‡¶æ‡¶ï‡¶æ`; } else { summaryDiv.innerHTML = `‡¶Æ‡ßã‡¶ü ‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡¶∂‡¶®: ${totalAmount.toLocaleString('bn-BD')} ‡¶ü‡¶æ‡¶ï‡¶æ`; } } function populateBatchFilter(selectedClassId) { batchFilter.innerHTML = '<option value="">‡¶∏‡¶¨ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö</option>'; batchFilter.disabled = true; if (!selectedClassId) return; const studentsInClass = originalDetailedData.filter(s => s.classId === selectedClassId); const batches = new Set(); studentsInClass.forEach(s => { if (s.batchInfo && s.batchInfo !== 'N/A') { s.batchInfo.split(', ').forEach(batchName => batches.add(batchName.trim())); } }); batches.forEach(batchName => { const option = document.createElement('option'); option.value = batchName; option.textContent = batchName; batchFilter.appendChild(option); }); if (batches.size > 0) { batchFilter.disabled = false; } } function populateClassFilter() { classFilter.innerHTML = '<option value="">‡¶∏‡¶¨ ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏</option>'; const classes = new Map(); originalDetailedData.forEach(s => { if (!classes.has(s.classId)) { classes.set(s.classId, s.class); } }); classes.forEach((name, id) => { const option = document.createElement('option'); option.value = id; option.textContent = name; classFilter.appendChild(option); }); } function applyFiltersAndRender() { const selectedClassId = classFilter.value; const selectedBatch = batchFilter.value; let filteredData = [...originalDetailedData]; if (selectedClassId) { filteredData = filteredData.filter(s => s.classId === selectedClassId); } if (selectedBatch) { filteredData = filteredData.filter(s => s.batchInfo && s.batchInfo.includes(selectedBatch)); } renderTable(filteredData); } classFilter.addEventListener('change', () => { populateBatchFilter(classFilter.value); applyFiltersAndRender(); }); batchFilter.addEventListener('change', applyFiltersAndRender); const headerCol6 = document.getElementById('headerCol6'); const headerCol7 = document.getElementById('headerCol7'); if (type === 'collection') { headerCol6.textContent = '‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶ß‡¶∞‡¶£'; headerCol7.textContent = '‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡¶ø‡¶§ ‡¶ü‡¶æ‡¶ï‡¶æ'; } else { headerCol6.textContent = '‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ï‡ßá‡ßü‡¶æ (‡¶ü‡¶æ‡¶ï‡¶æ)'; headerCol7.textContent = '‡¶¨‡¶ï‡ßá‡ßü‡¶æ ‡¶Æ‡¶æ‡¶∏‡¶∏‡¶Æ‡ßÇ‡¶π'; } document.getElementById('paymentTypeFilter').style.display = 'none'; document.getElementById('btnPrintDetailsList').onclick = () => { document.getElementById('printHeaderTitle').textContent = "‡¶Æ‡¶ø‡¶∞‡¶æ‡¶ï‡¶≤ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶°‡ßá‡¶ü ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶° ‡¶è‡¶ï‡¶æ‡¶°‡ßá‡¶Æ‡¶ø‡¶ï ‡¶á‡¶®‡ßç‡¶∏‡¶ü‡¶ø‡¶ü‡¶ø‡¶â‡¶ü"; document.getElementById('printHeaderSubtitle').textContent = pageTitle; const classText = classFilter.options[classFilter.selectedIndex].text; const batchText = batchFilter.options[batchFilter.selectedIndex].text; let filterInfo = `‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞: ${classText}`; if (batchFilter.value) filterInfo += `, ${batchText}`; document.getElementById('printHeaderFilters').textContent = filterInfo; window.print(); }; document.getElementById('btnBackToDashboard').onclick = () => loadPage(showDashboardPage); populateClassFilter(); populateBatchFilter(''); renderTable(originalDetailedData); }
    function showStudentDatabasePage(context = {}) { context.breadcrumbs = [{ text: '‡¶π‡ßã‡¶Æ', pageFn: showHomePage }, { text: '‡¶õ‡¶æ‡¶§‡ßç‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ‡¶¨‡ßá‡¶∏' }]; mainContentArea.appendChild(cloneTemplate('template-student-database')); const searchInput = document.getElementById('studentDatabaseSearchInput'); const contactInput = document.getElementById('studentDatabaseContactInput'); const resultsContainer = document.getElementById('student-search-results'); const performSearch = () => { const searchTerm = searchInput.value.toLowerCase().trim(); const contactTerm = contactInput.value.toLowerCase().trim(); resultsContainer.innerHTML = ''; if (searchTerm.length < 1 && contactTerm.length < 1) { resultsContainer.innerHTML = `<p style='text-align: center; color: var(--text-secondary);'>‡¶Ö‡¶®‡ßÅ‡¶∏‡¶®‡ßç‡¶ß‡¶æ‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶®‡¶æ‡¶Æ, ‡¶∞‡ßã‡¶≤ ‡¶¨‡¶æ ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®‡•§</p>`; return; } const filteredStudents = (appData.students || []).filter(s => { if (!s || s.deletedAt) return false; const nameRollMatch = !searchTerm || s.name.toLowerCase().includes(searchTerm) || s.roll.includes(searchTerm); const contactMatch = !contactTerm || (s.parentContact && s.parentContact.toLowerCase().includes(contactTerm)); return nameRollMatch && contactMatch; }).sort((a, b) => (parseInt(a.roll, 10) || 0) - (parseInt(b.roll, 10) || 0)); if (filteredStudents.length === 0) { resultsContainer.innerHTML = `<p style='text-align: center; color: var(--text-secondary);'>‡¶ï‡ßã‡¶®‡ßã ‡¶õ‡¶æ‡¶§‡ßç‡¶∞ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§</p>`; return; } let serialNumber = 0; filteredStudents.forEach(student => { serialNumber++; const classInfo = findClassById(student.classId); const resultItem = document.createElement('div'); resultItem.style.cssText = "padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 8px; cursor: pointer; display: flex; flex-direction: column; gap: 5px;"; resultItem.innerHTML = `<div><strong style="font-size: 1.1em;">${serialNumber}. ${student.name}</strong></div><div style="font-size: 0.9em; color: var(--text-secondary);"><span>‡¶∞‡ßã‡¶≤: ${student.roll}</span> | <span>‡¶ï‡ßç‡¶≤‡¶æ‡¶∏: ${classInfo?.name || 'N/A'}</span></div>`; resultItem.dataset.studentId = student.id; resultItem.onclick = () => loadPage(showStudentProfilePage, { studentId: student.id }); resultsContainer.appendChild(resultItem); }); }; searchInput.addEventListener('input', performSearch); contactInput.addEventListener('input', performSearch); performSearch(); }
    function showStudentProfilePage(context) { const student = findStudentById(context.studentId); if (!student) { loadPage(showStudentDatabasePage); return; } context.breadcrumbs = [ { text: '‡¶π‡ßã‡¶Æ', pageFn: showHomePage }, { text: '‡¶õ‡¶æ‡¶§‡ßç‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ‡¶¨‡ßá‡¶∏', pageFn: showStudentDatabasePage }, { text: student.name } ]; mainContentArea.appendChild(cloneTemplate('template-student-profile')); document.getElementById('profileNameHeader').textContent = student.name; document.getElementById('profileRoll').textContent = student.roll; document.getElementById('profileClass').textContent = findClassById(student.classId)?.name || 'N/A'; document.getElementById('profileSchool').textContent = student.schoolName || 'N/A'; document.getElementById('profileParentContact').textContent = student.parentContact || 'N/A'; document.getElementById('profileAdmissionDate').textContent = student.createdAt ? new Date(student.createdAt).toLocaleString('bn-BD', { day: 'numeric', month: 'long', year: 'numeric' }) : 'N/A'; const batchesContainer = document.getElementById('student-profile-batches'); const studentBatches = findBatchesForStudent(student.id); if (studentBatches.length > 0) { const ul = document.createElement('ul'); ul.style.cssText="list-style:none; padding:0;"; studentBatches.forEach(batchInfo => { const li = document.createElement('li'); li.style.cssText="background-color: var(--bg-hover); padding: 8px; border-radius: 4px; margin-bottom: 5px;"; li.textContent = `${batchInfo.day} (${batchInfo.time})`; ul.appendChild(li); }); batchesContainer.appendChild(ul); } else { batchesContainer.innerHTML = `<p style="color:var(--due-text);">‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö‡ßá ‡¶®‡ßá‡¶á‡•§</p>`; } const profilePhoto = document.getElementById('profilePagePhoto'); if(profilePhoto) { if(student.photoURL) { profilePhoto.src = student.photoURL; } profilePhoto.onerror = () => handleImageError(profilePhoto); } document.getElementById('btnGoToPaymentSection').onclick = () => { currentStudentContext = {...currentStudentContext, studentId: student.id, cameFrom: 'studentProfile', classId: student.classId }; loadPage(showStudentPaymentDetailsPage, {studentId: student.id}); }; document.getElementById('btnBackToDatabase').onclick = () => loadPage(showStudentDatabasePage); document.getElementById('btnEditStudentProfile')?.addEventListener('click', () => { showEditStudentModal(student.id); }); }
    async function showAddStudentModal(batchId, classId, onSuccess) {
        const modalFragment = cloneTemplate('template-add-student-modal');
        const modal = modalFragment.querySelector('#addStudentModal');
        document.body.appendChild(modal);

        const form = modal.querySelector('#addStudentForm');
        const closeBtn = modal.querySelector('.close-button');
        let uploadedPhotoURL = null;
        const imagePreview = modal.querySelector('#addStudentImagePreview');
        const selectPhotoBtn = modal.querySelector('#selectStudentPhotoBtn');
        const takePhotoBtn = modal.querySelector('#takeStudentPhotoBtn');
        const photoInput = modal.querySelector('#studentPhotoInput');
        
        const admissionFeeInput = modal.querySelector('#admissionFeeInputModal');
        const admissionFeeFreeCheckbox = modal.querySelector('#admissionFeeFreeCheckbox');
        const admissionReceiverInput = modal.querySelector('#admissionReceiverInputModal');

        const classInfo = findClassById(classId);
        const defaultAdmissionFee = classInfo?.defaultAdmissionFee || 0;
        admissionFeeInput.value = defaultAdmissionFee;
        
        const lastReceiver = localStorage.getItem('mcth_last_receiver_name');
        if(lastReceiver) {
            admissionReceiverInput.value = lastReceiver;
        }

        const toggleFeeInputs = () => {
            if (admissionFeeFreeCheckbox.checked) {
                admissionFeeInput.disabled = true;
                admissionFeeInput.value = '0';
            } else {
                admissionFeeInput.disabled = false;
                 admissionFeeInput.value = defaultAdmissionFee;
            }
        };

        admissionFeeFreeCheckbox.addEventListener('change', toggleFeeInputs);
        toggleFeeInputs();

        const closeModal = () => modal.remove();
        closeBtn.onclick = closeModal;
        modal.onclick = (e) => { if (e.target === modal) closeModal(); };
        
        selectPhotoBtn.onclick = () => photoInput.click();

        const handleImageSelection = async (imageSource) => {
            showLoader();
            try {
                const compressedDataUrl = await processAndCompressImage(imageSource);
                uploadedPhotoURL = compressedDataUrl;
                imagePreview.src = compressedDataUrl;
                showToast('‡¶õ‡¶¨‡¶ø ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', 'success');
            } catch (error) {
                console.error("Image processing failed:", error);
                showToast(error.message || '‡¶õ‡¶¨‡¶ø ‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏ ‡¶ï‡¶∞‡¶æ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶π‡ßü‡¶®‡¶ø‡•§', 'error');
                uploadedPhotoURL = null;
            } finally {
                hideLoader();
            }
        };

        photoInput.onchange = (e) => { const file = e.target.files[0]; if (file) handleImageSelection(file); };
        takePhotoBtn.onclick = () => { showCameraModal(blob => { if (blob) handleImageSelection(blob); }); };

        form.onsubmit = async (e) => {
            e.preventDefault();
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            showLoader();
            try {
                const name = modal.querySelector('#studentNameInput').value.trim();
                if (!name) { showToast("‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶Ü‡¶¨‡¶∂‡ßç‡¶Ø‡¶ï‡•§", 'error'); return; }
                
                const isAdmissionFeeFree = admissionFeeFreeCheckbox.checked;
                const admissionFeeAmount = isAdmissionFeeFree ? 0 : (parseFloat(admissionFeeInput.value) || 0);
                const receiverName = admissionReceiverInput.value.trim();

                if (!receiverName) { showToast("‡¶ó‡ßç‡¶∞‡¶π‡¶£‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶Ü‡¶¨‡¶∂‡ßç‡¶Ø‡¶ï‡•§", 'error'); return; }
                
                localStorage.setItem('mcth_last_receiver_name', receiverName);

                const studentId = `s_${Date.now()}`;
                const schoolName = modal.querySelector('#studentSchoolInput').value.trim();
                const parentContact = modal.querySelector('#parentContactInput').value.trim();
                const defaultMonthly = classInfo?.defaultMonthlyFee || 0;
                const newRoll = generateNextRollNumber();
                
                const admissionFeeData = { amount: admissionFeeAmount, status: 'paid', receiver: receiverName, date: new Date().toISOString(), token: generateToken() };

                const newStudent = { id: studentId, name, roll: newRoll, classId, parentContact: parentContact || 'N/A', schoolName: schoolName || 'N/A', createdAt: new Date().toISOString(), admissionFee: admissionFeeData, monthlyFeeDefault: defaultMonthly, monthlyPayments: {}, hasCustomFee: false, photoURL: uploadedPhotoURL };

                if (!appData.students) appData.students = [];
                appData.students.push(newStudent);
                logActivity('New student added', { studentName: name, roll: newRoll, class: classInfo.name, admissionFee: isAdmissionFeeFree ? 'Free' : admissionFeeData.amount });
                
                const batchInfo = findBatchById(batchId);
                if (batchInfo && batchInfo.batch) {
                    if (!batchInfo.batch.studentIds) batchInfo.batch.studentIds = [];
                    batchInfo.batch.studentIds.push(newStudent.id);
                }
                
                isSaving = true;
                await dbRef.set(appData);
                isSaving = false;

                showToast(`‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ '${name}' ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶§‡¶æ‡¶∞ ‡¶∞‡ßã‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞: ${newRoll}`, 'success');
                sessionStorage.setItem('newlyAddedStudentId', studentId);
                
                closeModal();
                if (onSuccess) onSuccess();
            } catch (error) {
                console.error("Failed to add student:", error);
                showToast("‡¶õ‡¶æ‡¶§‡ßç‡¶∞ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§", "error");
            } finally {
                hideLoader();
                submitButton.disabled = false;
            }
        };
        modal.classList.add('visible');
    }
    function showBatchPage(context = {}){ context.breadcrumbs = [{ text: '‡¶π‡ßã‡¶Æ', pageFn: showHomePage }, { text: '‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü' }]; mainContentArea.appendChild(cloneTemplate('template-batch')); renderBatchDayTabs(); const firstDay = (appData.batchSchedule || []).find(d => !d.deletedAt); if(firstDay){ document.querySelector(`.tab-button[data-day-id="${firstDay.id}"]`)?.click(); } }
    function renderBatchDayTabs(){ const container = document.getElementById('batch-day-tabs'); if (!container) return; container.innerHTML = ''; (appData.batchSchedule || []).forEach(day => { if (day.deletedAt) return; const tab = document.createElement('button'); tab.className = 'tab-button'; tab.dataset.dayId = day.id; tab.innerHTML = ` <span>${day.dayName}</span> <span class="student-action-icons admin-only hidden"> <span class="student-edit-icon" title="Rename Day">‚úèÔ∏è</span> <span class="student-delete-icon" title="Delete Day">üóëÔ∏è</span> </span> `; tab.querySelector('.student-edit-icon')?.addEventListener('click',async (e) => { e.stopPropagation(); if (!isAdminMode) return; const newDayName = prompt('‡¶®‡¶§‡ßÅ‡¶® ‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶®:', day.dayName); if (newDayName && newDayName.trim()) { day.dayName = newDayName.trim(); await saveAppData(); renderBatchDayTabs(); } }); tab.querySelector('.student-delete-icon')?.addEventListener('click',async (e) => { e.stopPropagation(); if (!isAdminMode) return; if (confirm(`'${day.dayName}' ‡¶¶‡¶ø‡¶®‡¶ü‡¶ø ‡¶è‡¶¨‡¶Ç ‡¶è‡¶∞ ‡¶Ö‡¶®‡ßç‡¶§‡¶∞‡ßç‡¶ó‡¶§ ‡¶∏‡¶ï‡¶≤ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö ‡¶∞‡¶ø‡¶∏‡¶æ‡¶á‡¶ï‡ßá‡¶≤ ‡¶¨‡¶ø‡¶®‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶§‡ßá ‡¶ö‡¶æ‡¶®?`)) { const dayToMove = (appData.batchSchedule || []).find(d => d.id === day.id); if(dayToMove) dayToMove.deletedAt = new Date().toISOString(); await saveAppData(); showToast(`'${day.dayName}' ‡¶∞‡¶ø‡¶∏‡¶æ‡¶á‡¶ï‡ßá‡¶≤ ‡¶¨‡¶ø‡¶®‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`, 'info'); renderBatchDayTabs(); } }); tab.addEventListener('click',(e) => { if(e.target.closest('.student-action-icons')) return; container.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active')); tab.classList.add('active'); renderBatchClassSubTabs(day.id); }); container.appendChild(tab); }); const addBtn = document.createElement('button'); addBtn.className = 'tab-button admin-only hidden'; addBtn.textContent = '+ ‡¶¶‡¶ø‡¶®'; addBtn.onclick = async () => { if (!isAdminMode) return; const dayName = prompt('‡¶®‡¶§‡ßÅ‡¶® ‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶® (‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶∂‡¶®‡¶ø‡¶¨‡¶æ‡¶∞):'); if (dayName && dayName.trim()) { const newDay = {id: `d_${Date.now()}`, dayName: dayName.trim(), classes: []}; if(!appData.batchSchedule) appData.batchSchedule = []; appData.batchSchedule.push(newDay); await saveAppData(); renderBatchDayTabs(); } }; container.appendChild(addBtn); updateAdminModeUI(); }
    function renderBatchClassSubTabs(dayId){ const day = (appData.batchSchedule || []).find(d => d.id === dayId); const container = document.getElementById('batch-class-subtabs-container'); if (!container || !day) { if (container) container.innerHTML = ''; return; } container.innerHTML = ` <div class="tab-container" id="sub-tabs-for-${dayId}"></div> <div id="batch-list-container"></div> `; const subTabContainer = container.querySelector(`#sub-tabs-for-${dayId}`); if(!day.classes) day.classes = []; (day.classes || []).filter(c=>!c.deletedAt).forEach(cls => { const classInfo = findClassById(cls.classId); if (!classInfo) return; const tab = document.createElement('button'); tab.className = 'tab-button'; tab.dataset.classScheduleId = cls.id; tab.innerHTML = ` <span>${classInfo.name}</span> <span class="student-action-icons admin-only hidden"> <span class="student-delete-icon" title="Remove Class from this Day">‚ùå</span> </span> `; tab.querySelector('.student-delete-icon').addEventListener('click',async e => { e.stopPropagation(); if (!isAdminMode) return; if (confirm(`‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø '${day.dayName}' ‡¶•‡ßá‡¶ï‡ßá '${classInfo.name}' ‡¶è‡¶∞ ‡¶∏‡¶ï‡¶≤ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?`)) { const clsToMove = day.classes.find(c=>c.id === cls.id); if(clsToMove) clsToMove.deletedAt = new Date().toISOString(); await saveAppData(); renderBatchClassSubTabs(dayId); } }); tab.addEventListener('click',(e) => { if(e.target.closest('.student-action-icons')) return; subTabContainer.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active')); tab.classList.add('active'); renderBatchList(dayId, cls.id); }); subTabContainer.appendChild(tab); }); const addClassBtn = document.createElement('button'); addClassBtn.className = 'tab-button admin-only hidden'; addClassBtn.textContent = '+ ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏'; addClassBtn.onclick = async () => { if (!isAdminMode) return; const className = prompt('‡¶ï‡ßç‡¶≤‡¶æ‡¶∏‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶®:'); if (!className || !className.trim()) return; let classInfo = (appData.mainClassCategories || []).find(c => c.name.toLowerCase() === className.trim().toLowerCase()); if (!classInfo) { if (confirm(`'${className}' ‡¶®‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶®‡ßá‡¶á‡•§ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶è‡¶ü‡¶ø ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?`)) { classInfo = { id: `c_${Date.now()}`, name: className.trim(), defaultMonthlyFee: 0, defaultAdmissionFee: 0 }; if(!appData.mainClassCategories) appData.mainClassCategories = []; appData.mainClassCategories.push(classInfo); } else { return; } } if ((day.classes || []).find(cs => cs.classId === classInfo.id && !cs.deletedAt)) { showToast('‡¶è‡¶á ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏‡¶ü‡¶ø ‡¶è‡¶á ‡¶¶‡¶ø‡¶®‡ßá ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶Ü‡¶õ‡ßá‡•§', 'error'); return; } day.classes.push({ id: `cs_${Date.now()}`, classId: classInfo.id, batches: [] }); await saveAppData(); renderBatchClassSubTabs(dayId); }; subTabContainer.appendChild(addClassBtn); const firstClass = (day.classes || []).find(cs => !cs.deletedAt); if(firstClass){ subTabContainer.querySelector('.tab-button')?.click(); } else { const batchListContainer = document.getElementById('batch-list-container'); if(batchListContainer) batchListContainer.innerHTML = ''; } updateAdminModeUI(); }
    function renderBatchList(dayId, classScheduleId){ const day = (appData.batchSchedule || []).find(d => d.id === dayId); const classSchedule = day?.classes?.find(cs => cs.id === classScheduleId); const container = document.getElementById('batch-list-container'); if (!container || !classSchedule) { if (container) container.innerHTML = ''; return; } container.innerHTML = ` <div class="batch-grid"></div> <button class="action-button btn-add admin-only hidden" id="addNewBatchBtn">+ ‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button> `; const grid = container.querySelector('.batch-grid'); grid.innerHTML = ''; if(!classSchedule.batches) classSchedule.batches = []; (classSchedule.batches || []).filter(b=>!b.deletedAt).forEach(batch => { const card = document.createElement('div'); card.className = 'batch-card'; const presentStudents = batch.studentIds?.length || 0; const vacant = batch.capacity - presentStudents; card.innerHTML = ` <div class="batch-card-header"> <span class="batch-time">${batch.time}</span> <div class="student-action-icons admin-only hidden"> <span class="student-edit-icon" title="Edit Batch Time">‚úèÔ∏è</span> <span class="student-delete-icon" title="Delete Batch">üóëÔ∏è</span> </div> </div> <div class="batch-card-body"> <table> <tr><th>‡¶Æ‡ßã‡¶ü ‡¶ß‡¶æ‡¶∞‡¶£‡¶ï‡ßç‡¶∑‡¶Æ‡¶§‡¶æ</th><td>${batch.capacity}</td></tr> <tr><th>‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶õ‡¶æ‡¶§‡ßç‡¶∞</th><td>${presentStudents}</td></tr> <tr><th>‡¶ñ‡¶æ‡¶≤‡¶ø ‡¶∏‡¶ø‡¶ü</th><td>${vacant > 0 ? vacant : 0}</td></tr> </table> <button class="action-button admin-only hidden">‡¶ß‡¶æ‡¶∞‡¶£‡¶ï‡ßç‡¶∑‡¶Æ‡¶§‡¶æ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®</button> </div> `; card.querySelector('.batch-time').onclick = () => loadPage(showBatchDetailsPage, { batchId: batch.id }); card.querySelector('.student-edit-icon').onclick = async (e) => { e.stopPropagation(); if (!isAdminMode) return; const newTime = prompt("‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö‡ßá‡¶∞ ‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡¶Æ‡ßü ‡¶¶‡¶ø‡¶®:", batch.time); if (newTime && newTime.trim()) { batch.time = newTime.trim(); await saveAppData(); renderBatchList(dayId, classScheduleId); } }; card.querySelector('.student-delete-icon').onclick = async (e) => { e.stopPropagation(); if (!isAdminMode) return; const studentsInBatch = (batch.studentIds || []).map(id => findStudentById(id)).filter(Boolean); if (confirm(`‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø '${batch.time}' ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö‡¶ü‡¶ø ‡¶è‡¶¨‡¶Ç ‡¶è‡¶∞ ‡¶Ö‡¶®‡ßç‡¶§‡¶∞‡ßç‡¶ó‡¶§ ${studentsInBatch.length} ‡¶ú‡¶® ‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡¶ï‡ßá ‡¶∞‡¶ø‡¶∏‡¶æ‡¶á‡¶ï‡ßá‡¶≤ ‡¶¨‡¶ø‡¶®‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶§‡ßá ‡¶ö‡¶æ‡¶®? ‡¶§‡¶æ‡¶¶‡ßá‡¶∞ ‡¶∏‡¶ï‡¶≤ ‡¶§‡¶•‡ßç‡¶Ø ‡¶∞‡¶ø‡¶∏‡¶æ‡¶á‡¶ï‡ßá‡¶≤ ‡¶¨‡¶ø‡¶®‡ßá ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶•‡¶æ‡¶ï‡¶¨‡ßá‡•§`)) { batch.deletedAt = new Date().toISOString(); batch.originalPath = { dayId: dayId, classScheduleId: classScheduleId }; if(!appData.recycleBin) appData.recycleBin = {}; if(!appData.recycleBin.batchSchedule) appData.recycleBin.batchSchedule = []; appData.recycleBin.batchSchedule.push({...batch}); if (!appData.recycleBin.students) appData.recycleBin.students = []; studentsInBatch.forEach(student => { const studentInDb = (appData.students || []).find(s => s.id === student.id); if (studentInDb && !studentInDb.deletedAt) { studentInDb.deletedAt = new Date().toISOString(); appData.recycleBin.students.push({...studentInDb}); } }); const batchInDb = classSchedule.batches.find(b => b.id === batch.id); if (batchInDb) batchInDb.deletedAt = batch.deletedAt; await saveAppData(); showToast(`‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö ‡¶è‡¶¨‡¶Ç ${studentsInBatch.length} ‡¶ú‡¶® ‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡¶ï‡ßá ‡¶∞‡¶ø‡¶∏‡¶æ‡¶á‡¶ï‡ßá‡¶≤ ‡¶¨‡¶ø‡¶®‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá`, 'info'); renderBatchList(dayId, classScheduleId); } }; card.querySelector('.batch-card-body button').onclick = async () => { if (!isAdminMode) return; const newCapacity = parseInt(prompt("‡¶®‡¶§‡ßÅ‡¶® ‡¶ß‡¶æ‡¶∞‡¶£‡¶ï‡ßç‡¶∑‡¶Æ‡¶§‡¶æ ‡¶¶‡¶ø‡¶®:", batch.capacity)); if (!isNaN(newCapacity) && newCapacity >= 0) { batch.capacity = newCapacity; await saveAppData(); showToast("‡¶ß‡¶æ‡¶∞‡¶£ ‡¶ï‡ßç‡¶∑‡¶Æ‡¶§‡¶æ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§", "success"); renderBatchList(dayId, classScheduleId); } else { showToast("‡¶∏‡¶†‡¶ø‡¶ï ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶¶‡¶ø‡¶®‡•§", "error"); } }; grid.appendChild(card); }); container.querySelector('#addNewBatchBtn').onclick = async () => { if (!isAdminMode) return; const time = prompt("‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶∏‡¶ï‡¶æ‡¶≤ ‡ßÆ:‡ß¶‡ß¶ - ‡ßØ:‡ß¶‡ß¶):"); if (!time || !time.trim()) return; const capacity = parseInt(prompt("‡¶õ‡¶æ‡¶§‡ßç‡¶∞ ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶ï‡ßç‡¶∑‡¶Æ‡¶§‡¶æ ‡¶ï‡¶§?", "50")); if (isNaN(capacity) || capacity < 0) return; if(!classSchedule.batches) classSchedule.batches = []; classSchedule.batches.push({ id: `b_${Date.now()}`, time: time.trim(), capacity: capacity, studentIds: [] }); await saveAppData(); renderBatchList(dayId, classScheduleId); }; updateAdminModeUI(); }
    function showBatchDetailsPage(context){ const batchInfo = findBatchById(context.batchId); if(!batchInfo){ loadPage(showBatchPage); return; } const {batch, classSchedule, day} = batchInfo; const classInfo = findClassById(classSchedule.classId); context.breadcrumbs = [ { text: '‡¶π‡ßã‡¶Æ', pageFn: showHomePage }, { text: '‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü', pageFn: showBatchPage }, { text: `${day.dayName} (${batch.time})` } ]; mainContentArea.appendChild(cloneTemplate('template-batch-details')); document.getElementById('batchDetailsHeader').textContent=`${classInfo.name} - ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö‡ßá‡¶∞ ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§`; document.getElementById('batchDetailsDay').textContent = day.dayName; document.getElementById('batchDetailsClass').textContent = classInfo.name; document.getElementById('batchDetailsTime').textContent = batch.time; document.getElementById('printBatchHeaderTitle').textContent = '‡¶Æ‡¶ø‡¶∞‡¶æ‡¶ï‡¶≤ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶°‡ßá‡¶ü ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶° ‡¶è‡¶ï‡¶æ‡¶°‡ßá‡¶Æ‡¶ø‡¶ï ‡¶á‡¶®‡ßç‡¶∏‡¶ü‡¶ø‡¶ü‡¶ø‡¶â‡¶ü'; document.getElementById('printBatchHeaderClass').textContent = `‡¶ï‡ßç‡¶≤‡¶æ‡¶∏: ${classInfo.name}`; document.getElementById('printBatchHeaderBatch').textContent = `‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö: ${day.dayName} (${batch.time})`; document.getElementById('btnPrintBatchList').onclick = () => window.print(); bulkStudentImportInput = document.getElementById('bulkStudentImportInput'); btnBulkImport = document.getElementById('btnBulkImport'); btnBulkImport.addEventListener('click', () => bulkStudentImportInput.click()); bulkStudentImportInput.addEventListener('change', async (event) => { const file = event.target.files[0]; if (!file) return; if (!['application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'application/vnd.ms-excel', 'text/csv'].includes(file.type)) { showToast('‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ Excel (.xlsx) ‡¶¨‡¶æ CSV (.csv) ‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá‡•§', 'error'); event.target.value = ''; return; } const reader = new FileReader(); reader.onload = async function(e) { showLoader(); try { const data = e.target.result; const workbook = XLSX.read(data, {type: 'binary'}); const sheetName = workbook.SheetNames[0]; const worksheet = workbook.Sheets[sheetName]; const jsonDataArray = XLSX.utils.sheet_to_json(worksheet, { header: 'A', defval: '' }); if(jsonDataArray.length === 0) { showToast('Excel ‡¶´‡¶æ‡¶á‡¶≤‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶°‡ßá‡¶ü‡¶æ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§', 'warning'); return; } const headerRow = jsonDataArray[0]; const expectedHeaders = ['‡¶ï‡ßç‡¶∞‡¶Æ‡¶ø‡¶ï ‡¶®‡¶Ç', '‡¶®‡¶æ‡¶Æ', '‡¶∏‡ßç‡¶ï‡ßÅ‡¶≤‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ', '‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞']; const headerMap = {}; expectedHeaders.forEach(expectedHeader => { const foundHeaderKey = Object.keys(headerRow).find(key => headerRow[key] && headerRow[key].toString().trim().toLowerCase() === expectedHeader.toLowerCase()); if (foundHeaderKey) { headerMap[expectedHeader] = foundHeaderKey; } }); if (expectedHeaders.some(h => !headerMap[h])) { const missing = expectedHeaders.filter(h => !headerMap[h]); showToast(`Excel ‡¶´‡¶æ‡¶á‡¶≤‡ßá‡¶∞ ‡¶π‡ßá‡¶°‡¶æ‡¶∞ ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡ßü‡•§ ‡¶Ö‡¶®‡ßÅ‡¶™‡¶∏‡ßç‡¶•‡¶ø‡¶§ ‡¶ï‡¶≤‡¶æ‡¶Æ: ${missing.join(', ')}`, 'error'); return; } let addedCount = 0; const newStudentsToAdd = []; const skippedStudents = []; const currentClassId = classSchedule.classId; const classInfo = findClassById(currentClassId); const defaultMonthly = classInfo?.defaultMonthlyFee || 0; const defaultAdmission = classInfo?.defaultAdmissionFee || 0; for (let i = 1; i < jsonDataArray.length; i++) { const row = jsonDataArray[i]; const studentName = row[headerMap['‡¶®‡¶æ‡¶Æ']]?.toString().trim(); const schoolName = row[headerMap['‡¶∏‡ßç‡¶ï‡ßÅ‡¶≤‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ']]?.toString().trim(); const contactNumber = row[headerMap['‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞']]?.toString().trim(); if (!studentName) { skippedStudents.push(`Row ${i+1}: ‡¶®‡¶æ‡¶Æ ‡¶®‡ßá‡¶á`); continue; } const newStudent = { id: `s_${Date.now()}_${addedCount}`, name: studentName, roll: generateNextRollNumber(), classId: currentClassId, parentContact: contactNumber || 'N/A', schoolName: schoolName || 'N/A', createdAt: new Date().toISOString(), admissionFee: { amount: defaultAdmission, status: 'due', receiver: '', date: null, token: null }, monthlyFeeDefault: defaultMonthly, monthlyPayments: {}, hasCustomFee: false }; newStudentsToAdd.push(newStudent); addedCount++; } if (newStudentsToAdd.length > 0) { if(!appData.students) appData.students = []; appData.students.push(...newStudentsToAdd); if(!batch.studentIds) batch.studentIds = []; newStudentsToAdd.forEach(student => batch.studentIds.push(student.id)); logActivity("Bulk student import successful", { count: addedCount, batchId: batch.id, classId: currentClassId }); saveAppData(); showToast(`${addedCount} ‡¶ú‡¶® ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`, 'success'); } else { showToast('‡¶ï‡ßã‡¶®‡ßã ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡¶®‡¶ø‡•§', 'info'); } if (skippedStudents.length > 0) { showToast(`‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ ‡¶¨‡¶æ‡¶¶ ‡¶™‡ßú‡ßá‡¶õ‡ßá (${skippedStudents.length} ‡¶ú‡¶®)‡•§ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® ‡¶ï‡¶®‡¶∏‡ßã‡¶≤‡•§`, 'warning'); console.warn("Skipped students during bulk import:", skippedStudents); } } catch (error) { console.error("Error processing Excel file:", error); showToast('Excel ‡¶´‡¶æ‡¶á‡¶≤ ‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶è‡¶ï‡¶ü‡¶ø ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', 'error'); } finally { hideLoader(); event.target.value = ''; } }; reader.readAsBinaryString(file); }); const tableBody = document.getElementById('batchStudentListBody'); const searchInput = document.getElementById('batchStudentSearchInput'); function populateBatchStudentTable(searchTerm=''){ tableBody.innerHTML = ''; const currentBatchInfo = findBatchById(context.batchId); if(!currentBatchInfo) return; const currentBatch = currentBatchInfo.batch; const searchTermLower = searchTerm.toLowerCase(); const studentsInBatch = (currentBatch.studentIds || []).map(findStudentById).filter(s => s && !s.deletedAt); const filteredStudents = studentsInBatch.filter(student => (student.name.toLowerCase().includes(searchTermLower))); filteredStudents.sort((a,b) => (parseInt(a.roll, 10) || 0) - (parseInt(b.roll, 10) || 0)); let serialNumber = 0; const newlyAddedStudentId = sessionStorage.getItem('newlyAddedStudentId'); filteredStudents.forEach(student => { serialNumber++; const tr = document.createElement('tr'); const contactInfo = student.parentContact || 'N/A'; let documentIconHTML = ''; if (student.id === newlyAddedStudentId) { documentIconHTML = `<span class="temp-doc-icon" data-student-id="${student.id}" title="‡¶≠‡¶∞‡ßç‡¶§‡¶ø ‡¶∞‡¶∂‡¶ø‡¶¶ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®" style="cursor: pointer; font-size: 1.2em;">üìÑ</span>`; setTimeout(() => { const icon = document.querySelector(`.temp-doc-icon[data-student-id="${student.id}"]`); if (icon) icon.remove(); sessionStorage.removeItem('newlyAddedStudentId'); }, 120000); } tr.innerHTML = ` <td class="serial-number-column">${serialNumber}.</td> <td><strong>${student.name}</strong> ${documentIconHTML}</td> <td><strong>${student.roll}</strong></td> <td><strong>${student.schoolName || 'N/A'}</strong></td> <td><strong>${contactInfo}</strong></td> <td class="student-action-icons print-hide"> <span class="student-transfer-icon" title="Transfer Student">üîÑ</span> <span class="student-edit-icon" title="Edit Student">‚úèÔ∏è</span> <span class="student-delete-icon" title="Remove from Batch">üóëÔ∏è</span> </td> `; tr.querySelector('.student-transfer-icon').onclick = () => { showStudentTransferModal(student.id, currentBatch.id, () => populateBatchStudentTable(searchInput.value)); }; tr.querySelector('.student-edit-icon').onclick = () => { showToast("‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø '‡¶õ‡¶æ‡¶§‡ßç‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ‡¶¨‡ßá‡¶∏' ‡¶Ö‡¶•‡¶¨‡¶æ '‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü' ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶•‡ßá‡¶ï‡ßá ‡¶§‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤‡ßá ‡¶Ø‡¶æ‡¶®‡•§", 'info'); }; tr.querySelector('.student-delete-icon').onclick = () => { if (!isAdminMode) { showToast('‡¶è‡¶á ‡¶ï‡¶æ‡¶ú‡¶ü‡¶ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶Æ‡ßã‡¶° ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®‡•§', 'error'); return; } if (!confirm(`‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø '${student.name}' (‡¶∞‡ßã‡¶≤: ${student.roll}) ‡¶ï‡ßá ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶°‡ßá‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶∞‡¶ø‡¶∏‡¶æ‡¶á‡¶ï‡ßá‡¶≤ ‡¶¨‡¶ø‡¶®‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶§‡ßá ‡¶ö‡¶æ‡¶®?\n\n‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶∏‡¶ï‡¶≤ ‡¶§‡¶•‡ßç‡¶Ø ‡¶∞‡¶ø‡¶∏‡¶æ‡¶á‡¶ï‡ßá‡¶≤ ‡¶¨‡¶ø‡¶®‡ßá ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶•‡¶æ‡¶ï‡¶¨‡ßá ‡¶è‡¶¨‡¶Ç ‡¶§‡¶æ‡¶ï‡ßá ‡¶Ü‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö ‡¶¨‡¶æ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ‡ßü ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ‡•§`)) return; const studentName = student.name; student.deletedAt = new Date().toISOString(); if (!appData.recycleBin.students) appData.recycleBin.students = []; appData.recycleBin.students.push(student); const studentInDb = (appData.students || []).find(s => s.id === student.id); if (studentInDb) studentInDb.deletedAt = student.deletedAt; (appData.batchSchedule || []).forEach(day => { if (day.deletedAt) return; (day.classes || []).forEach(cls => { if (cls.deletedAt) return; (cls.batches || []).forEach(batch => batch.studentIds = (batch.studentIds || []).filter(id => id !== student.id)); }); }); logActivity('Student moved to recycle bin', { studentName: studentName }); saveAppData(); showToast(`‡¶õ‡¶æ‡¶§‡ßç‡¶∞ '${studentName}' ‡¶ï‡ßá ‡¶∞‡¶ø‡¶∏‡¶æ‡¶á‡¶ï‡ßá‡¶≤ ‡¶¨‡¶ø‡¶®‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`, 'info'); }; const docIcon = tr.querySelector('.temp-doc-icon'); if (docIcon) { docIcon.onclick = () => { currentStudentContext = { studentId: student.id, paymentType: 'admission', cameFrom: 'batchDetails' }; loadPage(showPaymentDocumentPage, { studentId: student.id, paymentType: 'admission' }); }; } tableBody.appendChild(tr); }); } searchInput.addEventListener('input', e => populateBatchStudentTable(e.target.value)); populateBatchStudentTable(); document.getElementById('btnAddStudentToBatch').onclick = () => { showAddStudentModal(batch.id, classSchedule.classId, () => populateBatchStudentTable(searchInput.value)); }; document.getElementById('btnBackToBatchList').onclick = () => { loadPage(showBatchPage); setTimeout(()=>{ const dayTab = document.querySelector(`.tab-button[data-day-id="${day.id}"]`); if (dayTab) { dayTab.click(); setTimeout(()=>{ document.querySelector(`.tab-button[data-class-schedule-id="${classSchedule.id}"]`)?.click(); }, 50); } }, 50); }; updateAdminModeUI(); }
    function showStudentTransferModal(studentId, sourceBatchId, onTransferSuccess){ const student = findStudentById(studentId); if(!student) return; const modalFragment = cloneTemplate('template-transfer-modal'); const modalOverlay = modalFragment.querySelector('#studentTransferModal'); document.body.appendChild(modalOverlay); const modalTitle = modalOverlay.querySelector('#transferModalTitle'); const listContainer = modalOverlay.querySelector('#transferBatchListContainer'); const closeButton = modalOverlay.querySelector('.close-button'); modalTitle.textContent = `'${student.name}' (‡¶∞‡ßã‡¶≤: ${student.roll}) ‡¶ï‡ßá ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶∏‡¶´‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®`; listContainer.innerHTML = ''; (appData.batchSchedule || []).forEach(day => { if (day.deletedAt) return; const relevantClasses = (day.classes || []).filter(cs => cs.classId === student.classId && (cs.batches || []).length > 0); if (relevantClasses.length > 0) { const dayGroup = document.createElement('div'); dayGroup.className = 'transfer-day-group'; dayGroup.innerHTML = `<h3>${day.dayName}</h3>`; relevantClasses.forEach(classSchedule => { const classInfo = findClassById(classSchedule.classId); if (!classInfo) return; const classGroup = document.createElement('div'); classGroup.className = 'transfer-class-group'; classGroup.innerHTML = `<h4>${classInfo.name}</h4>`; (classSchedule.batches || []).forEach(batch => { const btn = document.createElement('button'); btn.className = 'transfer-batch-button'; let label = `‡¶∏‡¶Æ‡ßü: ${batch.time} (‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶õ‡¶æ‡¶§‡ßç‡¶∞: ${batch.studentIds?.length || 0}/${batch.capacity})`; if (batch.id === sourceBatchId) { btn.disabled = true; label += " (‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶®)"; } btn.textContent = label; btn.dataset.targetBatchId = batch.id; btn.onclick = () => { const destinationBatchId = btn.dataset.targetBatchId; const sourceInfo = findBatchById(sourceBatchId); const destInfo = findBatchById(destinationBatchId); if (sourceInfo && destInfo) { sourceInfo.batch.studentIds = (sourceInfo.batch.studentIds || []).filter(id => id !== studentId); if(!destInfo.batch.studentIds) destInfo.batch.studentIds = []; destInfo.batch.studentIds.push(studentId); saveAppData(); showToast(`'${student.name}' ‡¶ï‡ßá ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶∏‡¶´‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`, 'success'); modalOverlay.remove(); if (onTransferSuccess) onTransferSuccess(); } else { showToast("‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶∏‡¶´‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶è‡¶ï‡¶ü‡¶ø ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§","error"); } }; classGroup.appendChild(btn); }); dayGroup.appendChild(classGroup); }); listContainer.appendChild(dayGroup); } }); const closeModal = () => modalOverlay.remove(); closeButton.onclick = closeModal; modalOverlay.onclick = (e) => { if(e.target === modalOverlay) closeModal(); }; modalOverlay.classList.add('visible'); }
    function showPaymentPage(context = {}){ context.breadcrumbs = [{ text: '‡¶π‡ßã‡¶Æ', pageFn: showHomePage }, { text: '‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü' }]; mainContentArea.appendChild(cloneTemplate('template-payment')); renderPaymentPageTabs(); const activeTabs = document.querySelectorAll('#payment-class-categories-tabs .tab-button'); if(activeTabs.length > 0) { const classToSelect = context?.classId || ((appData.mainClassCategories || []).length > 0 ? (appData.mainClassCategories || []).find(c => !c.deletedAt)?.id : null); const tabToSelect = document.querySelector(`.tab-button[data-class-id="${classToSelect}"]`); if(tabToSelect){ tabToSelect.click(); } else if (activeTabs.length > 0) { activeTabs[0].click(); } } }
    function renderPaymentPageTabs(){ const tabsContainer = document.getElementById('payment-class-categories-tabs'); if(!tabsContainer) return; tabsContainer.innerHTML = ''; (appData.mainClassCategories || []).filter(c=>!c.deletedAt).forEach(classCat => { const tabButton = document.createElement('button'); tabButton.className = 'tab-button'; tabButton.dataset.classId = classCat.id; tabButton.innerHTML = ` <span>${classCat.name}</span> <span class="student-action-icons admin-only hidden"> <span class="student-delete-icon" title="Move class to recycle bin">üóëÔ∏è</span> </span> `; tabButton.querySelector('.student-delete-icon').addEventListener('click', async (e) => { e.stopPropagation(); if (!isAdminMode) return; if(confirm(`'${classCat.name}' ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏‡¶ü‡¶ø ‡¶è‡¶¨‡¶Ç ‡¶è‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡¶ø‡¶§ ‡¶∏‡¶ï‡¶≤ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö ‡¶∞‡¶ø‡¶∏‡¶æ‡¶á‡¶ï‡ßá‡¶≤ ‡¶¨‡¶ø‡¶®‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶§‡ßá ‡¶ö‡¶æ‡¶®?`)) { const classToMove = (appData.mainClassCategories || []).find(c=>c.id === classCat.id); if(classToMove) classToMove.deletedAt = new Date().toISOString(); (appData.batchSchedule || []).forEach(day => { if(day.deletedAt) return; (day.classes || []).forEach(cls => { if (cls.classId === classCat.id) { cls.deletedAt = new Date().toISOString(); } }); }); await saveAppData(); showToast(`'${classCat.name}' ‡¶∞‡¶ø‡¶∏‡¶æ‡¶á‡¶ï‡ßá‡¶≤ ‡¶¨‡¶ø‡¶®‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`, 'info'); renderPaymentPageTabs(); } }); tabButton.addEventListener('click',(e) => { if(e.target.closest('.student-delete-icon')) return; tabsContainer.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active')); tabButton.classList.add('active'); renderStudentListForClass(classCat.id); }); tabsContainer.appendChild(tabButton); }); const addBtn = document.createElement('button'); addBtn.className = 'tab-button admin-only hidden'; addBtn.textContent = '+ ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏'; addBtn.onclick = async () => {if(!isAdminMode) return; const newName = prompt("‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶®:"); if(newName && newName.trim()){ if(!appData.mainClassCategories) appData.mainClassCategories = []; appData.mainClassCategories.push({id:`c_${Date.now()}`, name: newName.trim(), defaultMonthlyFee: 0, defaultAdmissionFee: 0}); await saveAppData(); renderPaymentPageTabs(); }}; tabsContainer.appendChild(addBtn); updateAdminModeUI(); }
    function renderStudentListForClass(classId){ const tabContentDiv = document.getElementById('payment-tab-contents'); const classInfo = findClassById(classId); if (!tabContentDiv || !classInfo) return; const allBatchesInClass = (appData.batchSchedule || []).flatMap(day => (day.classes || []).filter(c => c.classId === classId && !c.deletedAt).flatMap(c => c.batches || []).filter(b=>!b.deletedAt)); const batchDayMap = new Map(); (appData.batchSchedule || []).forEach(day => { if(day.deletedAt) return; (day.classes || []).forEach(c => { if(c.deletedAt) return; (c.batches || []).forEach(b => batchDayMap.set(b.id,`${day.dayName.substring(0,3)} (${b.time})`)); }); }); let batchOptions=`<option value="">‡¶∏‡¶¨ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö</option>`; allBatchesInClass.forEach(b => { batchOptions+=`<option value="${b.id}">${batchDayMap.get(b.id) || ''}</option>`; }); tabContentDiv.innerHTML = ` <div id="student-list-payment" class="tab-content"> <div class="student-list-header"> <h3>${classInfo.name} - ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶¶‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h3> <div class="default-fee-controls"> <label>‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶´‡¶ø:</label> <input type="number" id="classDefaultMonthlyFee" class="assistant-disabled" value="${classInfo.defaultMonthlyFee || ''}"> <label>‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶≠‡¶∞‡ßç‡¶§‡¶ø ‡¶´‡¶ø:</label> <input type="number" id="classDefaultAdmissionFee" class="assistant-disabled" value="${classInfo.defaultAdmissionFee || ''}"> <button id="saveClassDefaultsBtn" class="action-button admin-only hidden">‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£</button> </div> </div> <div class="payment-filters"> <input type="search" id="studentSearchInput" placeholder="‡¶®‡¶æ‡¶Æ ‡¶¨‡¶æ ‡¶∞‡ßã‡¶≤ ‡¶¶‡¶ø‡ßü‡ßá ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶ï‡¶∞‡ßÅ‡¶®..."> <select id="batchFilter">${batchOptions}</select> <select id="paymentStatusFilter"> <option value="">‡¶∏‡¶¨ ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</option> <option value="due">‡¶¨‡¶ï‡ßá‡ßü‡¶æ</option> <option value="paid">‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡¶ø‡¶§</option> </select> </div> <div class="table-responsive-wrapper"><table> <thead> <tr> <th>‡¶ï‡ßç‡¶∞‡¶Æ‡¶ø‡¶ï</th> <th>‡¶®‡¶æ‡¶Æ</th> <th>‡¶∞‡ßã‡¶≤</th> <th>‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö</th> <th>‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</th> <th class="admin-only hidden">‡¶è‡¶ï‡¶∂‡¶®</th> </tr> </thead> <tbody></tbody> </table></div> </div> `; const studentListTbody = tabContentDiv.querySelector('tbody'); const searchInput = document.getElementById('studentSearchInput'); const batchFilter = document.getElementById('batchFilter'); const statusFilter = document.getElementById('paymentStatusFilter'); const saveDefaultsBtn = document.getElementById('saveClassDefaultsBtn'); saveDefaultsBtn.addEventListener('click', ()=>{ if (!isAdminMode) return; const newMonthlyFee = parseFloat(document.getElementById('classDefaultMonthlyFee').value) || 0; const newAdmissionFee = parseFloat(document.getElementById('classDefaultAdmissionFee').value) || 0; if (confirm(`‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø '${classInfo.name}' ‡¶è‡¶∞ ‡¶∏‡¶ï‡¶≤ ‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶´‡¶ø ${newMonthlyFee} ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶è‡¶¨‡¶Ç ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶≠‡¶∞‡ßç‡¶§‡¶ø ‡¶´‡¶ø ${newAdmissionFee} ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®? \n\n‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ (‚≠ê) ‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡¶¶‡ßá‡¶∞ ‡¶´‡¶ø ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶π‡¶¨‡ßá ‡¶®‡¶æ‡•§`)){ classInfo.defaultMonthlyFee = newMonthlyFee; classInfo.defaultAdmissionFee = newAdmissionFee; (appData.students || []).forEach(student => { if (student.classId === classId && !student.hasCustomFee) { student.monthlyFeeDefault = newMonthlyFee; Object.keys(student.monthlyPayments).forEach(month => { if (student.monthlyPayments[month].status === 'due') { student.monthlyPayments[month].fee = newMonthlyFee; } }); if (student.admissionFee.status === 'due' && student.admissionFee.amount > 0) { student.admissionFee.amount = newAdmissionFee; } } }); saveAppData(); } }); function populatePaymentStudentTable() { const searchTerm = searchInput.value.toLowerCase(); const selectedBatchId = batchFilter.value; const selectedStatus = statusFilter.value; studentListTbody.innerHTML = ''; const studentsInClass = (appData.students || []).filter(s => s && !s.deletedAt && s.classId === classId); studentsInClass.forEach(student => { BENGALI_MONTHS.forEach(month => { if (!student.monthlyPayments[month]) { student.monthlyPayments[month] = { fee: student.monthlyFeeDefault || 0, status: 'due', receiver: '', date: null, token: null }; } else if (student.monthlyPayments[month].status !== 'paid' && !student.hasCustomFee) { student.monthlyPayments[month].fee = student.monthlyFeeDefault; } }); }); const filteredStudents = studentsInClass.filter(s => { if (searchTerm && !s.name.toLowerCase().includes(searchTerm) && !s.roll.toLowerCase().includes(searchTerm)) return false; const studentBatches = findBatchesForStudent(s.id); if (selectedBatchId && !studentBatches.some(b => b.id === selectedBatchId)) return false; const studentIsCurrentlyDue = isStudentDue(s, viewedYear); if (selectedStatus === 'due' && !studentIsCurrentlyDue) return false; if (selectedStatus === 'paid' && studentIsCurrentlyDue) return false; return true; }).sort((a, b) => (parseInt(a.roll, 10) || 0) - (parseInt(b.roll, 10) || 0)); let serialNumber = 0; filteredStudents.forEach(student => { serialNumber++; const tr = document.createElement('tr'); const studentBatches = findBatchesForStudent(student.id); let batchDetailsHtml = studentBatches.length > 0 ? studentBatches.map(b => `${b.day.substring(0,3)} (${b.time})`).join('<br>') : `<span style="color:var(--due-text); font-style:italic;">‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö‡ßá ‡¶®‡ßá‡¶á</span>`; let studentNameHtml = student.name; if (student.hasCustomFee) { studentNameHtml += ` <span class="special-student-indicator" title="‡¶è‡¶á ‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶´‡¶ø ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶Ü‡¶õ‡ßá‡•§">‚≠ê</span>`; } const studentIsCurrentlyDue = isStudentDue(student, viewedYear); let statusHtml = `<span style="padding: 4px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold; text-align: center; color:${studentIsCurrentlyDue ? 'var(--due-text)':'var(--paid-text)'}; background-color:${studentIsCurrentlyDue ? 'var(--due-color)':'var(--paid-color)'}">${studentIsCurrentlyDue ? '‡¶¨‡¶ï‡ßá‡ßü‡¶æ' : '‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡¶ø‡¶§'}</span>`; tr.innerHTML = ` <td class="serial-number-column">${serialNumber}.</td> <td data-student-id="${student.id}" style="cursor:pointer; color: var(--text-tab-active);"> <span class="student-name"><strong>${studentNameHtml}</strong></span> </td> <td><strong>${student.roll}</strong></td> <td>${batchDetailsHtml}</td> <td>${statusHtml}</td> <td class="admin-only hidden student-action-icons"><span class="student-delete-icon" data-student-id="${student.id}" title="‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡¶ï‡ßá ‡¶∞‡¶ø‡¶∏‡¶æ‡¶á‡¶ï‡ßá‡¶≤ ‡¶¨‡¶ø‡¶®‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®">üóëÔ∏è</span></td> `; const nameCell = tr.querySelector('td[data-student-id]'); if (nameCell) { nameCell.onclick = (e) => { if (!e.target.closest('.student-action-icons')) { currentStudentContext = { studentId: student.id, classId: classId }; loadPage(showStudentPaymentDetailsPage, {studentId: student.id, classId: classId}); } }; } const deleteIcon = tr.querySelector('.student-delete-icon'); if (deleteIcon) { deleteIcon.onclick = (e) => { e.stopPropagation(); if (!isAdminMode) return; const studentToDelete = findStudentById(e.target.dataset.studentId); if (!studentToDelete || !confirm(`‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø '${studentToDelete.name}' (‡¶∞‡ßã‡¶≤: ${studentToDelete.roll}) ‡¶ï‡ßá ‡¶∞‡¶ø‡¶∏‡¶æ‡¶á‡¶ï‡ßá‡¶≤ ‡¶¨‡¶ø‡¶®‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶§‡ßá ‡¶ö‡¶æ‡¶®?\n\n‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶∏‡¶ï‡¶≤ ‡¶§‡¶•‡ßç‡¶Ø ‡¶∞‡¶ø‡¶∏‡¶æ‡¶á‡¶ï‡ßá‡¶≤ ‡¶¨‡¶ø‡¶®‡ßá ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶•‡¶æ‡¶ï‡¶¨‡ßá‡•§`)) return; const studentName = studentToDelete.name; studentToDelete.deletedAt = new Date().toISOString(); if(!appData.recycleBin.students) appData.recycleBin.students = []; appData.recycleBin.students.push(studentToDelete); const studentInDb = (appData.students || []).find(s=>s.id === studentToDelete.id); if(studentInDb) studentInDb.deletedAt = studentToDelete.deletedAt; (appData.batchSchedule || []).forEach(day => { (day.classes || []).forEach(cls => { (cls.batches || []).forEach(batch => batch.studentIds = (batch.studentIds || []).filter(id => id !== studentToDelete.id)); }); }); logActivity('Student moved to recycle bin', { studentName: studentName }); saveAppData(); showToast(`‡¶õ‡¶æ‡¶§‡ßç‡¶∞ '${studentName}' ‡¶ï‡ßá ‡¶∞‡¶ø‡¶∏‡¶æ‡¶á‡¶ï‡ßá‡¶≤ ‡¶¨‡¶ø‡¶®‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`, 'info'); }; } studentListTbody.appendChild(tr); }); updateAdminModeUI(); } searchInput.addEventListener('input', populatePaymentStudentTable); batchFilter.addEventListener('change', populatePaymentStudentTable); statusFilter.addEventListener('change', populatePaymentStudentTable); populatePaymentStudentTable(); updateAdminModeUI(); }
    function showStudentPaymentDetailsPage(context){ if(!context.studentId){ loadPage(showPaymentPage); return; } const student = findStudentById(context.studentId); if (!student) { showToast('‡¶õ‡¶æ‡¶§‡ßç‡¶∞ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§', 'error'); loadPage(showPaymentPage); return; } context.breadcrumbs = [{ text: '‡¶π‡ßã‡¶Æ', pageFn: showHomePage }]; if (context.cameFrom === 'history') { context.breadcrumbs.push({ text: '‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø', pageFn: showPaymentHistoryPage }); } else { context.breadcrumbs.push({ text: '‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü', pageFn: showPaymentPage, context: { classId: student.classId } }); if (context.cameFrom !== 'paymentDetails') { context.breadcrumbs.push({ text: student.name, pageFn: showStudentProfilePage, context: { studentId: student.id } }); } } context.breadcrumbs.push({ text: '‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£' }); mainContentArea.appendChild(cloneTemplate('template-student-payment-details')); const paymentPagePhoto = document.getElementById('paymentPagePhoto'); if(paymentPagePhoto) { if(student.photoURL) { paymentPagePhoto.src = student.photoURL; } paymentPagePhoto.onerror = () => handleImageError(paymentPagePhoto); } document.getElementById('studentNameHeader').textContent=`${student.name} ‡¶è‡¶∞ ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£`; document.getElementById('studentRollDisplay').textContent=student.roll; document.getElementById('studentClassDisplay').textContent=findClassById(student.classId)?.name||'N/A'; document.getElementById('entryDateValue').textContent=student.createdAt ? new Date(student.createdAt).toLocaleString('bn-BD',{day:'numeric',month:'long',year:'numeric'}) : 'N/A'; const admissionFeeInput = document.getElementById('admissionFeeAmount'); const admissionFeeStatus = document.getElementById('admissionFeeStatus'); const admissionReceiverInfo = document.getElementById('admissionReceiverInfo'); const admissionFeeData = student.admissionFee; admissionFeeInput.value = admissionFeeData?.amount || ''; admissionFeeStatus.textContent = `‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏: ${admissionFeeData?.status === 'paid' ? 'Paid' : (admissionFeeData?.amount > 0 ? 'Due' : 'N/A')}`; admissionReceiverInfo.textContent = `‡¶ó‡ßç‡¶∞‡¶π‡¶£‡¶ï‡¶æ‡¶∞‡ßÄ: ${admissionFeeData?.receiver || 'N/A'}`; document.getElementById('btnShowAdmissionDoc').disabled = admissionFeeData?.status !== 'paid'; document.getElementById('btnShowAdmissionDoc').addEventListener('click',()=>{ currentStudentContext = {...currentStudentContext, studentId: student.id, paymentType: 'admission', cameFrom: 'paymentDetails'}; loadPage(showPaymentDocumentPage, { studentId: student.id, paymentType: 'admission' }); }); document.getElementById('btnAdmissionPaid').addEventListener('click',() => handleAdmissionPayment(student.id)); document.getElementById('btnAdmissionDue').addEventListener('click', () => handleAdmissionDue(student.id)); const defaultFeeInput = document.getElementById('defaultMonthlyFeeForStudent'); const saveDefaultFeeBtn = document.getElementById('btnSaveDefaultMonthlyFee'); defaultFeeInput.value = student.monthlyFeeDefault > 0 ? student.monthlyFeeDefault : ''; saveDefaultFeeBtn.addEventListener('click', ()=>{ if (!isAdminMode) return; const newDefaultFee = parseFloat(defaultFeeInput.value); if (!isNaN(newDefaultFee) && newDefaultFee >= 0) { student.monthlyFeeDefault = newDefaultFee; student.hasCustomFee = true; Object.keys(student.monthlyPayments).forEach(monthName => { if (student.monthlyPayments[monthName].status === 'due') { student.monthlyPayments[monthName].fee = newDefaultFee; } }); saveAppData(); showToast('‡¶è‡¶á ‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶´‡¶ø ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', 'success'); } else { showToast('‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡¶†‡¶ø‡¶ï ‡¶´‡¶ø ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®‡•§', 'error'); } }); document.getElementById('btnBackToPreviousPage').onclick = () => { if (currentStudentContext?.cameFrom === 'studentProfile') { loadPage(showStudentProfilePage, { studentId: student.id }); } else if (currentStudentContext?.cameFrom === 'history') { loadPage(showPaymentHistoryPage); } else { loadPage(showPaymentPage, { classId: student.classId }); } }; const selectAllCheckbox = document.getElementById('selectAllMonthsCheckbox'); selectAllCheckbox.addEventListener('change', (e) => { document.querySelectorAll('#monthlyPaymentsTableBody .month-checkbox:not(:disabled)').forEach(chk => { chk.checked = e.target.checked; }); }); document.getElementById('btnPaySelectedMonths').addEventListener('click', () => handleMultiMonthPayment(student.id, context)); populateStudentMonthlyPaymentsTable(student.id); renderYearlyStatusChart(student); updateAdminModeUI(); }
    async function handleAdmissionPayment(studentId) { const student = findStudentById(studentId); if (!student) return; const newAmount = parseFloat(document.getElementById('admissionFeeAmount').value); if (isNaN(newAmount) || newAmount <= 0) { showToast("‡¶≠‡¶∞‡ßç‡¶§‡¶ø ‡¶´‡¶ø ‡¶è‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®‡•§","error"); return; } if (student.admissionFee?.status === 'paid' && !isAdminMode) { showToast("‡¶≠‡¶∞‡ßç‡¶§‡¶ø ‡¶´‡¶ø ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡¶ø‡¶§‡•§","info"); return; } const receiverName = prompt("‡¶≠‡¶∞‡ßç‡¶§‡¶ø ‡¶´‡¶ø ‡¶ó‡ßç‡¶∞‡¶π‡¶£‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®:"); if (receiverName?.trim()) { student.admissionFee = { amount: newAmount, status: 'paid', receiver: receiverName, date: new Date().toISOString(), token: generateToken() }; logActivity("Admission Fee Paid", { studentName: student.name, amount: newAmount }); await saveAppData(); loadPage(showStudentPaymentDetailsPage, {studentId: student.id}); if (smsManagementData.automation?.paymentEnabled && student.parentContact && student.parentContact.trim().toLowerCase() !== 'n/a') { const message = `‡¶™‡ßç‡¶∞‡¶ø‡ßü ${student.name} (‡¶∞‡ßã‡¶≤: ${student.roll}), ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶≠‡¶∞‡ßç‡¶§‡¶ø ‡¶´‡¶ø ‡¶¨‡¶æ‡¶¨‡¶¶ ${newAmount} ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡¶´‡¶≤ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ Trnx ID: ${student.admissionFee.token}‡•§\n\n‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶,\n‡¶Æ‡¶ø‡¶∞‡¶æ‡¶ï‡¶≤`; const pendingId = `pending_adm_${Date.now()}`; db.ref(`smsManagement/pending/payment/${pendingId}`).set({ id: pendingId, timestamp: new Date().toISOString(), studentId: student.id, message: message, paymentFor: '‡¶≠‡¶∞‡ßç‡¶§‡¶ø ‡¶´‡¶ø', amount: newAmount, classId: student.classId }); } showToast("‡¶≠‡¶∞‡ßç‡¶§‡¶ø ‡¶´‡¶ø ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá 'Paid' ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§", 'success'); } else if (receiverName !== null) { showToast("‡¶ó‡ßç‡¶∞‡¶π‡¶£‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶Ü‡¶¨‡¶∂‡ßç‡¶Ø‡¶ï‡•§","error"); } }
    async function handleAdmissionDue(studentId) { const student = findStudentById(studentId); if (!student) return; if (student.admissionFee?.status === 'paid' && !isAdminMode) { showToast("'Due' ‡¶ï‡¶∞‡¶§‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶Æ‡ßã‡¶° ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶ü‡¶ø‡¶≠‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§","error"); return; } const currentAmount = parseFloat(document.getElementById('admissionFeeAmount').value); student.admissionFee = { amount: isNaN(currentAmount) ? 0 : currentAmount, status: 'due', receiver: '', date: null, token: null }; logActivity("Admission Fee set to Due", { studentName: student.name }); await saveAppData(); loadPage(showStudentPaymentDetailsPage, {studentId: student.id}); showToast("‡¶≠‡¶∞‡ßç‡¶§‡¶ø ‡¶´‡¶ø ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá 'Due' ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§", 'info'); }
    async function handleMonthlyPayment(buttonElement, studentId, month, statusToSet){ const student = findStudentById(studentId); if (!student) return; const monthData = student.monthlyPayments[month]; if (!monthData) return; if (monthData.status === 'paid' && !isAdminMode) { showToast(`‡¶è‡¶á ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá 'Paid'‡•§ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶Æ‡ßã‡¶° ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®‡•§`,"info"); return; } if (statusToSet === 'paid') { const feeInput = buttonElement.closest('tr').querySelector('.monthly-fee-input'); const feeAmount = parseFloat(feeInput.value); if (isNaN(feeAmount) || feeAmount <= 0) { showToast("‡¶´‡¶ø ‡ß¶ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶¨‡¶æ ‡¶ñ‡¶æ‡¶≤‡¶ø ‡¶π‡¶≤‡ßá Paid ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ‡•§","error"); return; } const receiverName = prompt(`${month} ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶¨‡ßá‡¶§‡¶® ‡¶ó‡ßç‡¶∞‡¶π‡¶£‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®:`); if (receiverName?.trim()) { monthData.fee = feeAmount; monthData.status = 'paid'; monthData.receiver = receiverName; monthData.date = new Date().toISOString(); monthData.token = generateToken(); logActivity(`Monthly Fee Paid for ${month}`, { studentName: student.name, amount: feeAmount }); if (smsManagementData.automation?.paymentEnabled && student.parentContact && student.parentContact.trim().toLowerCase() !== 'n/a') { const message = `‡¶™‡ßç‡¶∞‡¶ø‡ßü ${student.name} (‡¶∞‡ßã‡¶≤: ${student.roll}), ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ${month} ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ${feeAmount} ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡¶´‡¶≤ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ Trnx ID: ${monthData.token}‡•§\n\n‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶,\n‡¶Æ‡¶ø‡¶∞‡¶æ‡¶ï‡¶≤`; const pendingId = `pending_mon_${Date.now()}`; db.ref(`smsManagement/pending/payment/${pendingId}`).set({ id: pendingId, timestamp: new Date().toISOString(), studentId: student.id, message: message, paymentFor: month, amount: feeAmount, classId: student.classId }); } await saveAppData(); } else if (receiverName !== null) { showToast("‡¶ó‡ßç‡¶∞‡¶π‡¶£‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶Ü‡¶¨‡¶∂‡ßç‡¶Ø‡¶ï‡•§","error"); return; } } else { if (!isAdminMode && monthData.status === 'paid') { showToast("'Due' ‡¶ï‡¶∞‡¶§‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶Æ‡ßã‡¶° ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶ü‡¶ø‡¶≠‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§","error"); return; } monthData.status = 'due'; monthData.receiver = ''; monthData.date = null; monthData.token = null; logActivity(`Monthly Fee set to Due for ${month}`, { studentName: student.name }); await saveAppData(); } populateStudentMonthlyPaymentsTable(studentId); renderYearlyStatusChart(student); }
    async function handleMultiMonthPayment(studentId, pageContext){ const selectedMonths = Array.from(document.querySelectorAll('#monthlyPaymentsTableBody .month-checkbox:checked')).map(cb => cb.dataset.month); if(selectedMonths.length === 0){ showToast('‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ö‡¶®‡ßç‡¶§‡¶§ ‡¶è‡¶ï‡¶ü‡¶ø ‡¶Æ‡¶æ‡¶∏ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§', 'info'); return; } const receiverName = prompt(`‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§ ‡¶Æ‡¶æ‡¶∏‡¶ó‡ßÅ‡¶≤‡ßã‡¶∞ (${selectedMonths.join(', ')}) ‡¶¨‡ßá‡¶§‡¶® ‡¶ó‡ßç‡¶∞‡¶π‡¶£‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®:`); if (!receiverName?.trim()) { if (receiverName !== null) showToast("‡¶ó‡ßç‡¶∞‡¶π‡¶£‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶Ü‡¶¨‡¶∂‡ßç‡¶Ø‡¶ï‡•§","error"); return; } const student = findStudentById(studentId); let totalPaid = 0; selectedMonths.forEach(month => { const feeInput = document.querySelector(`.monthly-fee-input[data-month="${month}"]`); const feeAmount = parseFloat(feeInput.value); if (!isNaN(feeAmount) && feeAmount > 0) { const monthData = student.monthlyPayments[month]; monthData.fee = feeAmount; monthData.status = 'paid'; monthData.receiver = receiverName; monthData.date = new Date().toISOString(); monthData.token = generateToken(); totalPaid += feeAmount; } }); logActivity(`Multi-month Fee Paid for ${selectedMonths.join(', ')}`, { studentName: student.name, amount: totalPaid }); if (smsManagementData.automation?.paymentEnabled && totalPaid > 0) { if (student.parentContact && student.parentContact.trim().toLowerCase() !== 'n/a') { const message = `‡¶™‡ßç‡¶∞‡¶ø‡ßü ${student.name} (‡¶∞‡ßã‡¶≤: ${student.roll}), ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ${selectedMonths.join(', ')} ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶Æ‡ßã‡¶ü ${totalPaid} ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡¶´‡¶≤ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§\n\n‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶,\n‡¶Æ‡¶ø‡¶∞‡¶æ‡¶ï‡¶≤`; const pendingId = `pending_mul_${Date.now()}`; db.ref(`smsManagement/pending/payment/${pendingId}`).set({ id: pendingId, timestamp: new Date().toISOString(), studentId: student.id, message: message, paymentFor: selectedMonths.join(', '), amount: totalPaid, classId: student.classId }); } } await saveAppData(); populateStudentMonthlyPaymentsTable(studentId); renderYearlyStatusChart(student); }
    async function showPaymentHistoryPage(context = {}) { context.breadcrumbs = [{ text: '‡¶π‡ßã‡¶Æ', pageFn: showHomePage }, { text: '‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø' }]; mainContentArea.appendChild(cloneTemplate('template-payment-history')); const historyContainer = document.getElementById('history-content-area'); const historyTabs = document.getElementById('history-tabs'); async function renderPaymentHistory() { historyContainer.innerHTML = '<p>‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>'; try { const combinedData = await getCombinedDataForAllYears(); const allClassCategories = combinedData.classes; const allPayments = []; (combinedData.students || []).forEach(student => { const classInfo = allClassCategories.find(c => c.id === student.classId); const studentYear = parseInt(student.academicYear); const yearLabel = studentYear !== viewedYear ? ` (${student.academicYear})` : ''; if (student.monthlyPayments && typeof student.monthlyPayments === 'object') { Object.entries(student.monthlyPayments).forEach(([monthName, payment]) => { if (payment && payment.status === 'paid' && payment.date) { allPayments.push({ date: new Date(payment.date), studentId: student.id, studentName: `${student.name}${yearLabel}`, studentRoll: student.roll, className: classInfo?.name || 'N/A', month: monthName, amount: payment.fee, paymentType: 'monthly' }); } }); } if (student.admissionFee?.status === 'paid' && student.admissionFee.date) { allPayments.push({ date: new Date(student.admissionFee.date), studentId: student.id, studentName: `${student.name}${yearLabel}`, studentRoll: student.roll, className: classInfo?.name || 'N/A', month: '‡¶≠‡¶∞‡ßç‡¶§‡¶ø ‡¶´‡¶ø', amount: student.admissionFee.amount, paymentType: 'admission' }); } }); allPayments.sort((a,b) => b.date - a.date); const groupedByDate = allPayments.reduce((acc, payment) => { const dateKey = payment.date.toISOString().split('T')[0]; if (!acc[dateKey]) { acc[dateKey] = { transactions: [], total: 0 }; } acc[dateKey].transactions.push(payment); acc[dateKey].total += (payment.amount || 0); return acc; }, {}); historyContainer.innerHTML = ''; if (Object.keys(groupedByDate).length === 0) { historyContainer.innerHTML = '<p>‡¶ï‡ßã‡¶®‡ßã ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§</p>'; } else { for (const dateKey in groupedByDate) { const dayData = groupedByDate[dateKey]; const formattedDate = new Date(dateKey).toLocaleString('bn-BD', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); const dateGroupDiv = document.createElement('div'); dateGroupDiv.className = 'history-date-group'; let tableRows = ''; dayData.transactions.forEach(tx => { tableRows += ` <tr> <td>${tx.studentName}</td> <td>${tx.className}</td> <td>${tx.studentRoll}</td> <td>${tx.month}</td> <td>${tx.amount.toLocaleString('bn-BD')}</td> <td><button class="action-button btn-show-doc view-history-doc-btn">‡¶°‡¶ï‡ßÅ‡¶Æ‡ßá‡¶®‡ßç‡¶ü</button></td> </tr> `; }); dateGroupDiv.innerHTML = ` <div class="history-date-header"> <h4>${formattedDate}</h4> <div style="display: flex; align-items: center; gap: 15px;"> <span class="total-collection">‡¶Æ‡ßã‡¶ü ‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡¶∂‡¶®: ${dayData.total.toLocaleString('bn-BD')} ‡¶ü‡¶æ‡¶ï‡¶æ</span> <button class="action-button print-hide daily-summary-print-btn" data-date-key="${dateKey}">POS ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü</button> </div> </div> <div class="table-responsive-wrapper"><table> <thead> <tr> <th>‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ (‡¶¨‡¶õ‡¶∞)</th><th>‡¶ï‡ßç‡¶≤‡¶æ‡¶∏</th><th>‡¶∞‡ßã‡¶≤</th><th>‡¶ï‡¶ø‡¶∏‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø</th><th>‡¶ü‡¶æ‡¶ï‡¶æ</th><th>‡¶è‡¶ï‡¶∂‡¶®</th> </tr> </thead> <tbody>${tableRows}</tbody> </table></div> `; historyContainer.appendChild(dateGroupDiv); } } historyContainer.addEventListener('click', (e) => { if (e.target && e.target.classList.contains('view-history-doc-btn')) { showToast("‡¶∞‡¶∂‡¶ø‡¶¶ ‡¶¶‡ßá‡¶ñ‡¶§‡ßá, ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶∏‡ßá‡¶á ‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶¨‡¶∞‡ßç‡¶∑‡ßá ‡¶ó‡¶ø‡ßü‡ßá ‡¶§‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶•‡ßá‡¶ï‡ßá ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®‡•§", "info", 4000); } if (e.target.classList.contains('daily-summary-print-btn')) { const dateKey = e.target.dataset.dateKey; if (groupedByDate[dateKey]) { showDailySummaryReceipt(dateKey, groupedByDate[dateKey]); } } }); } catch (err) { console.error("Error rendering payment history:", err); historyContainer.innerHTML = '<p style="color:red;">‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶π‡ßü‡¶®‡¶ø‡•§</p>'; } } async function renderActivityHistory() { historyContainer.innerHTML = '<p>‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>'; try { const combinedData = await getCombinedDataForAllYears(); const allLogs = combinedData.activityLog; if (!allLogs || allLogs.length === 0) { historyContainer.innerHTML = '<p>‡¶ï‡ßã‡¶®‡ßã ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶ü‡¶ø‡¶≠‡¶ø‡¶ü‡¶ø ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§</p>'; return; } allLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); const table = document.createElement('table'); table.innerHTML = `<thead><tr><th>‡¶∏‡¶Æ‡ßü</th><th>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶ü‡¶ø‡¶≠‡¶ø‡¶ü‡¶ø</th><th>‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§</th></tr></thead><tbody></tbody>`; const tbody = table.querySelector('tbody'); allLogs.forEach(log => { const tr = document.createElement('tr'); const formattedDate = new Date(log.timestamp).toLocaleString('bn-BD'); let details = ''; if(log.studentName) details += `‡¶õ‡¶æ‡¶§‡ßç‡¶∞: ${log.studentName}`; if(log.roll) details += `, ‡¶∞‡ßã‡¶≤: ${log.roll}`; if(log.class) details += `, ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏: ${log.class}`; if(log.batch) details += `, ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö: ${log.batch}`; const logYear = parseInt(log.academicYear); const yearLabel = logYear !== viewedYear ? ` (${log.academicYear})` : ''; tr.innerHTML = `<td>${formattedDate}</td><td>${log.message}${yearLabel}</td><td>${details}</td>`; tbody.appendChild(tr); }); historyContainer.innerHTML = ''; historyContainer.appendChild(table); } catch (err) { console.error("Error rendering activity history:", err); historyContainer.innerHTML = '<p style="color:red;">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶ü‡¶ø‡¶≠‡¶ø‡¶ü‡¶ø ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶π‡ßü‡¶®‡¶ø‡•§</p>'; } } historyTabs.addEventListener('click', e => { if (e.target.classList.contains('tab-button')) { historyTabs.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active')); e.target.classList.add('active'); if (e.target.dataset.tab === 'payment') renderPaymentHistory(); else renderActivityHistory(); } }); document.getElementById('btnBackFromHistory')?.addEventListener('click', () => loadPage(showHomePage)); renderPaymentHistory(); }
    
    function showPaymentDocumentPage(context){ 
        const student = findStudentById(context.studentId); 
        if (!student) { loadPage(showPaymentPage); return; } 
        context.breadcrumbs = [{ text: '‡¶π‡ßã‡¶Æ', pageFn: showHomePage }]; 
        if (context.cameFrom === 'history') { 
            context.breadcrumbs.push({ text: '‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø', pageFn: showPaymentHistoryPage }); 
        } else { 
            context.breadcrumbs.push({ text: '‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü', pageFn: showPaymentPage, context: { classId: student.classId } }); 
            if (context.cameFrom !== 'paymentDetails') { 
                context.breadcrumbs.push({ text: student.name, pageFn: showStudentProfilePage, context: { studentId: student.id } }); 
            } 
        } 
        context.breadcrumbs.push({ text: '‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶°‡¶ï‡ßÅ‡¶Æ‡ßá‡¶®‡ßç‡¶ü' }); 
        
        let paymentData, paymentTitle; 
        if(context.paymentType === 'admission'){ 
            paymentData = student.admissionFee; 
            paymentTitle = '‡¶≠‡¶∞‡ßç‡¶§‡¶ø ‡¶´‡¶ø'; 
        } else { 
            paymentData = student.monthlyPayments[context.month]; 
            paymentTitle = context.month; 
        } 
        
        if (!paymentData || paymentData.status !== 'paid') { 
            showToast("‡¶∞‡¶∂‡¶ø‡¶¶ ‡¶§‡ßà‡¶∞‡¶ø‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®‡ßÄ‡ßü ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§","error"); 
            const prevContext = context.cameFrom; 
            if(prevContext === 'studentProfile'){loadPage(showStudentProfilePage, { studentId: student.id });} 
            else if(prevContext === 'history'){loadPage(showPaymentHistoryPage);} 
            else if(prevContext === 'findTrnx'){loadPage(showFindTrnxIdPage);} 
            else if (prevContext === 'batchDetails') { const batchId = findBatchesForStudent(student.id)[0]?.id; if(batchId) loadPage(showBatchDetailsPage, { batchId }); else loadPage(showBatchPage); }
            else{loadPage(showStudentPaymentDetailsPage, context);} 
            return; 
        } 
        
        mainContentArea.appendChild(cloneTemplate('template-payment-document'));
        
        const printableReceiptArea = document.getElementById('printable-receipt-area');
        const studentBatches = findBatchesForStudent(student.id); 
        const batchInfoText = studentBatches.length > 0 ? studentBatches.map(b => `${b.day} (${b.time})`).join(', ') : 'N/A'; 
        const formattedDate = paymentData.date ? new Date(paymentData.date).toLocaleString('bn-BD') : 'N/A'; 
        const isFreeAdmission = context.paymentType === 'admission' && paymentData.amount === 0;
        const amountForDisplay = isFreeAdmission ? 'Free' : `${(paymentData.amount || paymentData.fee).toLocaleString('bn-BD')} ‡¶ü‡¶æ‡¶ï‡¶æ`;
        const token = paymentData.token || 'N/A'; 
        
        document.getElementById('docViewTokenNo').textContent = token;
        document.getElementById('docViewStudentName').textContent = student.name;
        document.getElementById('docViewStudentSchool').textContent = student.schoolName || 'N/A';
        document.getElementById('docViewStudentRoll').textContent = student.roll;
        document.getElementById('docViewClassName').textContent = findClassById(student.classId)?.name || 'N/A';
        document.getElementById('docViewBatchInfo').textContent = batchInfoText;
        document.getElementById('docViewPaymentMonth').textContent = paymentTitle;
        document.getElementById('docViewAmountPaid').textContent = amountForDisplay;
        document.getElementById('docViewPaymentDate').textContent = formattedDate;
        document.getElementById('docViewReceiverName').textContent = paymentData.receiver || '';

        document.getElementById('btnPrintGeneratedDocument')?.addEventListener('click', () => window.print());
        document.getElementById('btnBackFromDocument')?.addEventListener('click', () => { 
            const prevContext = context.cameFrom; 
            if (prevContext === 'studentProfile') { loadPage(showStudentProfilePage, { studentId: student.id }); } 
            else if (prevContext === 'history') { loadPage(showPaymentHistoryPage); } 
            else if (prevContext === 'findTrnx') { loadPage(showFindTrnxIdPage); } 
            else if (prevContext === 'batchDetails') { const batchId = findBatchesForStudent(student.id)[0]?.id; if(batchId) loadPage(showBatchDetailsPage, { batchId }); else loadPage(showBatchPage); }
            else { loadPage(showStudentPaymentDetailsPage, context); } 
        }); 
    }
    
    function showReportsPage(context = {}) { context.breadcrumbs = [{ text: '‡¶π‡ßã‡¶Æ', pageFn: showHomePage }, { text: '‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü‡¶∏' }]; mainContentArea.appendChild(cloneTemplate('template-reports-page')); const startDateInput = document.getElementById('reportStartDate'); const endDateInput = document.getElementById('reportEndDate'); const generateBtn = document.getElementById('btnGenerateReport'); const printBtn = document.getElementById('btnPrintReport'); const resultsArea = document.getElementById('report-content'); generateBtn.addEventListener('click', () => { const startDate = startDateInput.value ? new Date(startDateInput.value) : null; const endDate = endDateInput.value ? new Date(endDateInput.value) : null; if (!startDate || !endDate) { showToast('‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶è‡¶¨‡¶Ç ‡¶∂‡ßá‡¶∑ ‡¶â‡¶≠‡ßü ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶¶‡¶ø‡¶®‡•§', 'error'); return; } endDate.setHours(23, 59, 59, 999); showLoader(); setTimeout(() => { const reportData = { collections: [], total: 0 }; (appData.students || []).forEach(student => { if (student.admissionFee?.status === 'paid' && student.admissionFee.date) { const payDate = new Date(student.admissionFee.date); if (payDate >= startDate && payDate <= endDate) { reportData.collections.push({ studentName: student.name, studentRoll: student.roll, date: payDate, type: '‡¶≠‡¶∞‡ßç‡¶§‡¶ø ‡¶´‡¶ø', amount: student.admissionFee.amount }); reportData.total += student.admissionFee.amount; } } Object.entries(student.monthlyPayments).forEach(([month, payment]) => { if (payment.status === 'paid' && payment.date) { const payDate = new Date(payment.date); if (payDate >= startDate && payDate <= endDate) { reportData.collections.push({ studentName: student.name, studentRoll: student.roll, date: payDate, type: `${month} ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶´‡¶ø`, amount: payment.fee }); reportData.total += payment.fee; } } }); }); reportData.collections.sort((a, b) => a.date - b.date); if (reportData.collections.length === 0) { resultsArea.innerHTML = `<p style="text-align:center;">‡¶è‡¶á ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ‡ßá‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡¶∂‡¶® ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§</p>`; } else { let tableHTML = `<div class="table-responsive-wrapper"><h4>‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡¶∂‡¶® ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü (${startDate.toLocaleDateString('bn-BD')} - ${endDate.toLocaleDateString('bn-BD')})</h4> <table> <thead> <tr><th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th><th>‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</th><th>‡¶∞‡ßã‡¶≤</th><th>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th><th>‡¶ü‡¶æ‡¶ï‡¶æ</th></tr> </thead> <tbody>`; reportData.collections.forEach(item => { tableHTML += ` <tr> <td>${item.date.toLocaleDateString('bn-BD')}</td> <td><strong>${item.studentName}</strong></td> <td><strong>${item.studentRoll}</strong></td> <td>${item.type}</td> <td>${item.amount.toLocaleString('bn-BD')}</td> </tr> `; }); tableHTML += `</tbody></table> <div class="details-summary">‡¶Æ‡ßã‡¶ü ‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡¶∂‡¶®: ${reportData.total.toLocaleString('bn-BD')} ‡¶ü‡¶æ‡¶ï‡¶æ</div></div>`; resultsArea.innerHTML = tableHTML; document.getElementById('printReportHeaderDates').textContent = `‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ: ${startDate.toLocaleDateString('bn-BD')} ‡¶•‡ßá‡¶ï‡ßá ${endDate.toLocaleDateString('bn-BD')}`; printBtn.disabled = false; } hideLoader(); }, 50); }); printBtn.addEventListener('click', () => window.print()); }
    function showRecycleBinPage(context = {}) { context.breadcrumbs = [{ text: '‡¶π‡ßã‡¶Æ', pageFn: showHomePage }, { text: '‡¶∞‡¶ø‡¶∏‡¶æ‡¶á‡¶ï‡ßá‡¶≤ ‡¶¨‡¶ø‡¶®' }]; mainContentArea.appendChild(cloneTemplate('template-recycle-bin')); const tabs = document.getElementById('recycle-bin-tabs'); const contentArea = document.getElementById('recycle-bin-content'); const renderContent = (type) => { contentArea.innerHTML = ''; const items = appData.recycleBin?.[type] || []; if (items.length === 0) { contentArea.innerHTML = `<p style="text-align:center; padding: 20px;">‡¶è‡¶á ‡¶∞‡¶ø‡¶∏‡¶æ‡¶á‡¶ï‡ßá‡¶≤ ‡¶¨‡¶ø‡¶® ‡¶ñ‡¶æ‡¶≤‡¶ø‡•§</p>`; return; } items.sort((a,b) => new Date(b.deletedAt) - new Date(a.deletedAt)).forEach((item) => { const itemDiv = document.createElement('div'); itemDiv.className = 'recycle-bin-item'; let name = ''; if (type === 'students') name = `${item.name} (‡¶∞‡ßã‡¶≤: ${item.roll})`; else if (type === 'mainClassCategories') name = `‡¶ï‡ßç‡¶≤‡¶æ‡¶∏: ${item.name}`; else if (type === 'batchSchedule') { const dayName = item.originalPath?.dayId ? (appData.batchSchedule || []).find(d => d.id === item.originalPath.dayId)?.dayName : 'Unknown Day'; let classSchedule = item.originalPath?.classScheduleId ? findBatchById(item.id)?.classSchedule : null; let classInfo = classSchedule ? findClassById(classSchedule.classId) : null; name = `‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö: ${dayName || ''} - ${classInfo?.name || ''} - ${item.time || ''}`; } itemDiv.innerHTML = ` <div> <strong>${name}</strong><br> <small>‡¶°‡¶ø‡¶≤‡¶ø‡¶ü‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ: ${new Date(item.deletedAt).toLocaleString('bn-BD')}</small> </div> <div class="recycle-bin-actions"> <button class="action-button btn-restore" data-type="${type}" data-id="${item.id}">Restore</button> <button class="action-button btn-delete-perm" data-type="${type}" data-id="${item.id}">Delete Permanently</button> </div> `; contentArea.appendChild(itemDiv); }); }; contentArea.addEventListener('click', (e) => { if (!e.target.matches('.btn-restore, .btn-delete-perm')) return; const { type, id } = e.target.dataset; const itemIndex = appData.recycleBin[type].findIndex(i => i.id === id); if (itemIndex === -1) return; if (e.target.matches('.btn-restore')) { let confirmMessage = "‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§‡¶≠‡¶æ‡¶¨‡ßá ‡¶è‡¶ü‡¶ø ‡¶™‡ßÅ‡¶®‡¶∞‡ßÅ‡¶¶‡ßç‡¶ß‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?"; if(type === 'batchSchedule') { confirmMessage = "‡¶è‡¶á ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö‡¶ü‡¶ø ‡¶™‡ßÅ‡¶®‡¶∞‡ßÅ‡¶¶‡ßç‡¶ß‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶≤‡ßá ‡¶è‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡¶ø‡¶§ ‡¶∏‡¶ï‡¶≤ ‡¶õ‡¶æ‡¶§‡ßç‡¶∞-‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßÄ‡¶ì ‡¶™‡ßÅ‡¶®‡¶∞‡ßÅ‡¶¶‡ßç‡¶ß‡¶æ‡¶∞ ‡¶π‡ßü‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?"; } if(!confirm(confirmMessage)) return; const itemToRestore = appData.recycleBin[type].splice(itemIndex, 1)[0]; if (type === 'students') { const studentInDb = (appData.students || []).find(s => s.id === id); if(studentInDb) delete studentInDb.deletedAt; } else if (type === 'mainClassCategories') { const classInDb = (appData.mainClassCategories || []).find(c => c.id === id); if(classInDb) delete classInDb.deletedAt; } else if (type === 'batchSchedule') { (appData.batchSchedule || []).forEach(day => { (day.classes || []).forEach(cs => { const batchInDb = (cs.batches || []).find(b => b.id === id); if (batchInDb) delete batchInDb.deletedAt; }); }); (itemToRestore.studentIds || []).forEach(studentId => { const studentInRecycleBinIndex = appData.recycleBin.students.findIndex(s => s.id === studentId); if (studentInRecycleBinIndex > -1) { appData.recycleBin.students.splice(studentInRecycleBinIndex, 1); } const studentInDb = (appData.students || []).find(s => s.id === studentId); if (studentInDb) delete studentInDb.deletedAt; }); } saveAppData(); showToast('‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡ßÅ‡¶®‡¶∞‡ßÅ‡¶¶‡ßç‡¶ß‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', 'success'); renderContent(type); } else if (e.target.matches('.btn-delete-perm')) { if (confirm('‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§‡¶≠‡¶æ‡¶¨‡ßá ‡¶è‡¶ü‡¶ø ‡¶∏‡ßç‡¶•‡¶æ‡ßü‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®? ‡¶è‡¶á ‡¶ï‡¶æ‡¶ú‡¶ü‡¶ø ‡¶Ü‡¶∞ ‡¶´‡ßá‡¶∞‡¶æ‡¶®‡ßã ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ‡•§')) { appData.recycleBin[type].splice(itemIndex, 1)[0]; saveAppData(); showToast('‡¶∏‡ßç‡¶•‡¶æ‡ßü‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', 'info'); renderContent(type); } } }); tabs.addEventListener('click', e => { if (e.target.matches('.tab-button')) { tabs.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active')); e.target.classList.add('active'); renderContent(e.target.dataset.tab); } }); renderContent('students'); }
    function showFindTrnxIdPage(context = {}) {
        context.breadcrumbs = [{ text: '‡¶π‡ßã‡¶Æ', pageFn: showHomePage }, { text: 'Find Trnx ID' }];
        mainContentArea.appendChild(cloneTemplate('template-find-trnx-id-page'));

        const searchInput = document.getElementById('trnxIdSearchInput');
        const resultsContainer = document.getElementById('trnx-results-container');

        const allTransactions = [];
        (appData.students || []).forEach(student => {
            if (student.admissionFee?.status === 'paid' && student.admissionFee.token) {
                allTransactions.push({ studentId: student.id, studentName: student.name, paymentType: 'admission', token: student.admissionFee.token, description: '‡¶≠‡¶∞‡ßç‡¶§‡¶ø ‡¶´‡¶ø' });
            }
            Object.entries(student.monthlyPayments || {}).forEach(([month, payment]) => {
                if (payment.status === 'paid' && payment.token) {
                    allTransactions.push({ studentId: student.id, studentName: student.name, paymentType: 'monthly', month: month, token: payment.token, description: `${month} ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶´‡¶ø` });
                }
            });
        });
        
        allTransactions.sort((a,b) => b.token.localeCompare(a.token));

        function renderList(filter = '') {
            const searchTerm = filter.toLowerCase();
            const filtered = allTransactions.filter(tx => tx.token.toLowerCase().includes(searchTerm));

            if (filtered.length === 0) {
                resultsContainer.innerHTML = '<p style="text-align:center;">‡¶ï‡ßã‡¶®‡ßã ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§</p>';
                return;
            }

            resultsContainer.innerHTML = filtered.map(tx => `
                <div class="search-result-item" data-student-id="${tx.studentId}" data-payment-type="${tx.paymentType}" data-month="${tx.month || ''}" style="padding: 12px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; cursor: pointer;">
                    <div>
                        <strong style="font-size: 1.1em;">${tx.studentName}</strong>
                        <div style="font-size: 0.9em; color: var(--text-secondary);">${tx.description}</div>
                    </div>
                    <div style="font-weight: bold; color: var(--text-tab-active);">${tx.token}</div>
                </div>
            `).join('');
        }

        resultsContainer.addEventListener('click', (e) => {
            const item = e.target.closest('.search-result-item');
            if (item) {
                const { studentId, paymentType, month } = item.dataset;
                currentStudentContext = { studentId, paymentType, month, cameFrom: 'findTrnx' };
                loadPage(showPaymentDocumentPage, { studentId, paymentType, month });
            }
        });

        searchInput.addEventListener('input', () => renderList(searchInput.value));
        renderList(searchInput.value);
    }
    function showDailySummaryReceipt(dateKey, dailyData) {
        const modalFragment = cloneTemplate('template-daily-summary-receipt-modal');
        if (!modalFragment) return;
        document.body.appendChild(modalFragment);
        const modal = document.getElementById('dailySummaryModal');
        const formattedDate = new Date(dateKey).toLocaleString('bn-BD', {
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
        });
        document.getElementById('summaryReceiptDate').textContent = formattedDate;
        document.getElementById('summaryReceiptTotal').textContent = dailyData.total.toLocaleString('bn-BD');
        const tableBody = document.getElementById('summaryReceiptTableBody');
        tableBody.innerHTML = '';
        dailyData.transactions.forEach(tx => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${tx.studentName} <br><small>(${tx.studentRoll})</small></td>
                <td style="text-align: right;">${(tx.amount || 0).toLocaleString('bn-BD')}</td>
            `;
            tableBody.appendChild(tr);
        });
        const closeModal = () => modal.remove();
        modal.querySelector('#btnCloseDailySummary').onclick = closeModal;
        modal.querySelector('#btnPrintDailySummary').onclick = () => window.print();
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });
        modal.classList.add('visible');
    }
    function renderYearlyStatusChart(student) { const chartContainer = document.getElementById('yearlyStatusChart'); if (!chartContainer || !student) return; chartContainer.innerHTML = ''; const admissionDate = student.createdAt ? new Date(student.createdAt) : new Date(); const currentYear = viewedYear; BENGALI_MONTHS.forEach((monthName, index) => { const monthStartDate = new Date(currentYear, index, 1); const isApplicable = monthStartDate >= new Date(admissionDate.getFullYear(), admissionDate.getMonth(), 1); let statusClass = 'not-applicable'; let statusText = 'N/A'; if (isApplicable) { const monthData = student.monthlyPayments?.[monthName] || {}; if (monthData.status === 'paid') { statusClass = 'paid'; statusText = 'Paid'; } else if (paymentIsDue(index, currentYear)) { statusClass = 'due'; statusText = 'Due'; } else { statusClass = 'future'; statusText = 'Future'; } } const monthBox = document.createElement('div'); monthBox.className = `month-box ${statusClass}`; monthBox.textContent = `${monthName} - ${statusText}`; monthBox.title = `${monthName}: ${statusText}`; chartContainer.appendChild(monthBox); }); }
    function populateStudentMonthlyPaymentsTable(studentId) { const student = findStudentById(studentId); if (!student) return; const tableBody = document.getElementById('monthlyPaymentsTableBody'); tableBody.innerHTML = ''; const admissionDate = student.createdAt ? new Date(student.createdAt) : new Date(); BENGALI_MONTHS.forEach((monthName, index) => { const currentYear = viewedYear; const monthStartDate = new Date(currentYear, index, 1); const isApplicable = monthStartDate >= new Date(admissionDate.getFullYear(), admissionDate.getMonth(), 1); if (!student.monthlyPayments) student.monthlyPayments = {}; if (!student.monthlyPayments[monthName]) { student.monthlyPayments[monthName] = { fee: student.monthlyFeeDefault || 0, status: 'due', receiver: '', date: null, token: null }; } else if (student.monthlyPayments[monthName].status !== 'paid' && !student.hasCustomFee) { student.monthlyPayments[monthName].fee = student.monthlyFeeDefault; } const monthData = student.monthlyPayments[monthName]; const isPaid = monthData.status === 'paid'; const row = document.createElement('tr'); row.dataset.status = isApplicable ? monthData.status : 'not-applicable'; if (!isApplicable) { row.classList.add('row-not-applicable'); } else if (isPaid) { row.classList.add('row-paid'); } else if (paymentIsDue(index, currentYear)) { row.classList.add('row-due-past'); } row.innerHTML = ` <td><input type="checkbox" id="chk-${monthName}" class="month-checkbox" data-month="${monthName}" ${!isApplicable || isPaid ? 'disabled' : ''}></td> <td><label class="month-checkbox-label" for="chk-${monthName}">${monthName}</label></td> <td><input type="number" class="monthly-fee-input assistant-disabled" data-month="${monthName}" value="${monthData.fee}" ${!isApplicable || (isPaid && !isAdminMode) ? 'disabled' : ''}></td> <td> <button class="action-button btn-paid btn-month-paid" data-month="${monthName}" ${!isApplicable ? 'disabled' : ''}>Paid</button> <button class="action-button btn-due btn-month-due" data-month="${monthName}" ${!isApplicable ? 'disabled' : ''}>Due</button> </td> <td class="month-receiver-info">${isApplicable ? (monthData.receiver || 'N/A') : 'N/A'}</td> <td><button class="action-button btn-show-doc" data-month="${monthName}" ${!isPaid ? 'disabled' : ''}>‡¶°‡¶ï‡ßÅ‡¶Æ‡ßá‡¶®‡ßç‡¶ü</button></td> `; row.querySelector('.btn-month-paid')?.addEventListener('click', (e) => handleMonthlyPayment(e.target, studentId, monthName, 'paid')); row.querySelector('.btn-month-due')?.addEventListener('click', () => handleMonthlyPayment(null, studentId, monthName, 'due')); row.querySelector('.btn-show-doc')?.addEventListener('click', () => { if (monthData.status === 'paid') { currentStudentContext = {...currentStudentContext, studentId: student.id, month: monthName, paymentType: 'monthly' }; loadPage(showPaymentDocumentPage, { studentId: student.id, month: monthName, paymentType: 'monthly' }); } }); const feeInput = row.querySelector('.monthly-fee-input'); feeInput.addEventListener('change', () => { if (isAdminMode) feeInput.style.borderColor = '#f1c40f'; }); tableBody.appendChild(row); }); }
    function showAboutDeveloperModal() { const modalFragment = cloneTemplate('template-about-developer-modal'); if (!modalFragment) { showToast('Developer information could not be loaded.', 'error'); console.error('Template "template-about-developer-modal" not found.'); return; } const modal = modalFragment.querySelector('#aboutDeveloperModal'); document.body.appendChild(modal); const closeBtn = modal.querySelector('.close-button'); const closeModal = () => modal.remove(); closeBtn.onclick = closeModal; modal.addEventListener('click', (e) => { if (e.target === modal) { closeModal(); } }); setTimeout(() => { modal.classList.add('visible'); }, 10); }
    function showEditStudentModal(studentId) {
        const student = findStudentById(studentId);
        if (!student) return;
        const modalFragment = cloneTemplate('template-edit-student-modal');
        const modal = modalFragment.querySelector('#editStudentModal');
        document.body.appendChild(modal);

        const form = modal.querySelector('#editStudentForm');
        const closeBtn = modal.querySelector('.close-button');
        const nameInput = modal.querySelector('#editStudentNameInput');
        const rollInput = modal.querySelector('#editStudentRollInput');
        const schoolInput = modal.querySelector('#editStudentSchoolInput');
        const contactInput = modal.querySelector('#editStudentParentContactInput');
        const imagePreview = modal.querySelector('#editStudentImagePreview');
        const selectPhotoBtn = modal.querySelector('#editSelectStudentPhotoBtn');
        const takePhotoBtn = modal.querySelector('#editTakeStudentPhotoBtn');
        const photoInput = modal.querySelector('#editStudentPhotoInput');
        
        let newPhotoURL = student.photoURL || null;

        if (imagePreview) {
            imagePreview.src = student.photoURL || 'images/default_avatar.png';
            imagePreview.onerror = () => handleImageError(imagePreview);
        }
        nameInput.value = student.name || '';
        rollInput.value = student.roll || '';
        schoolInput.value = student.schoolName || '';
        contactInput.value = student.parentContact || '';

        const closeModal = () => modal.remove();
        closeBtn.onclick = closeModal;
        modal.onclick = (e) => { if (e.target === modal) closeModal(); };

        const handleImageSelection = async (imageSource) => {
            showLoader();
            try {
                const compressedDataUrl = await processAndCompressImage(imageSource);
                newPhotoURL = compressedDataUrl;
                imagePreview.src = compressedDataUrl;
                showToast('‡¶õ‡¶¨‡¶ø ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', 'success');
            } catch (error) {
                console.error("Image processing failed:", error);
                showToast(error.message || '‡¶õ‡¶¨‡¶ø ‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏ ‡¶ï‡¶∞‡¶æ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶π‡ßü‡¶®‡¶ø‡•§', 'error');
            } finally {
                hideLoader();
            }
        };

        selectPhotoBtn.onclick = () => photoInput.click();
        photoInput.onchange = (e) => { const file = e.target.files[0]; if (file) handleImageSelection(file); };
        takePhotoBtn.onclick = () => { showCameraModal(blob => { if (blob) handleImageSelection(blob); }); };

        form.onsubmit = async (e) => {
            e.preventDefault();
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            showLoader();
            try {
                const newName = nameInput.value.trim();
                if (!newName) { showToast("‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶ñ‡¶æ‡¶≤‡¶ø ‡¶∞‡¶æ‡¶ñ‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ‡•§", 'error'); return; }
                student.name = newName;
                student.roll = rollInput.value.trim();
                student.schoolName = schoolInput.value.trim();
                student.parentContact = contactInput.value.trim();
                student.photoURL = newPhotoURL;
                
                logActivity('Student profile updated', { studentName: student.name, roll: student.roll });
                await saveAppData();
                showToast('‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!', 'success');
                closeModal();
                loadPage(showStudentProfilePage, { studentId: student.id });
            } catch (error) {
                console.error("Failed to edit student:", error);
                showToast("‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§", "error");
            } finally {
                hideLoader();
                submitButton.disabled = false;
            }
        };
        modal.classList.add('visible');
    }

    // --- FINAL INITIALIZATION AND EVENT LISTENERS ---
    applyTheme(localStorage.getItem(THEME_KEY) || 'light');
    btnToggleMode?.addEventListener('click', () => { if (isAdminMode) { isAdminMode = false; updateAdminModeUI(); } else { const pass = prompt('‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶Æ‡ßã‡¶°‡ßá ‡¶Ø‡ßá‡¶§‡ßá ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡¶®:'); if (pass === currentPassword) { isAdminMode = true; showToast('‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶Æ‡ßã‡¶° ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶ü‡¶ø‡¶≠‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', 'success'); updateAdminModeUI(); } else if (pass) { showToast('‡¶≠‡ßÅ‡¶≤ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°!', 'error'); } } });
    btnPrivacyMenu?.addEventListener('click', (e) => { e.stopPropagation(); privacyDropdown.classList.toggle('active'); if (!privacyDropdown.classList.contains('active')) { backupSubMenu.classList.remove('open'); btnBackupMenuToggle.classList.remove('open'); } });
    window.addEventListener('click', (e) => { if (privacyDropdown.classList.contains('active') && !privacyDropdown.contains(e.target) && !btnPrivacyMenu.contains(e.target)) { privacyDropdown.classList.remove('active'); backupSubMenu.classList.remove('open'); btnBackupMenuToggle.classList.remove('open'); } });
    btnBackupMenuToggle?.addEventListener('click', (e) => { e.stopPropagation(); backupSubMenu.classList.toggle('open'); btnBackupMenuToggle.classList.toggle('open'); });
    btnExportData?.addEventListener('click', () => closeDropdownAndRun(handleExport));
    btnImportData?.addEventListener('click', () => { closeDropdownAndRun(() => { const requiredPin = '13913'; const enteredPin = prompt('‡¶°‡ßá‡¶ü‡¶æ ‡¶á‡¶Æ‡ßç‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá, ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡¶ø‡¶® ‡¶¶‡¶ø‡¶®:'); if (enteredPin === null) { return; } if (enteredPin === requiredPin) { showToast('‡¶∏‡¶†‡¶ø‡¶ï ‡¶™‡¶ø‡¶®‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶´‡¶æ‡¶á‡¶≤ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§', 'success'); fileImporter.click(); } else { showToast('‡¶≠‡ßÅ‡¶≤ ‡¶™‡¶ø‡¶®! ‡¶°‡ßá‡¶ü‡¶æ ‡¶á‡¶Æ‡ßç‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶®‡ßü‡•§', 'error'); } }); });
    btnChangePassword?.addEventListener('click', () => closeDropdownAndRun(() => { if (!isAdminMode) return; const oldPass = prompt("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡¶®:"); if (oldPass !== currentPassword) { showToast("‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡ßü!","error"); return; } const newPass = prompt("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡¶®:"); if (!newPass) { showToast("‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶ñ‡¶æ‡¶≤‡¶ø ‡¶∞‡¶æ‡¶ñ‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ‡•§","error"); return; } const confirmNewPass = prompt("‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°‡¶ü‡¶ø ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶¶‡¶ø‡¶®:"); if (newPass === confirmNewPass) { currentPassword = newPass; logActivity("Admin password changed."); saveAppData(); showToast("‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§","success"); } else { showToast("‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°‡¶ó‡ßÅ‡¶≤‡ßã ‡¶Æ‡¶ø‡¶≤‡ßá‡¶®‡¶ø‡•§","error"); } }));
    btnForgotPassword?.addEventListener('click', () => closeDropdownAndRun(() => { if (confirm(`‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°‡¶ü‡¶ø ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®? ‡¶è‡¶ü‡¶ø ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°‡ßá  ‡¶∏‡ßá‡¶ü ‡¶π‡ßü‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§ Default ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶° ‡¶≠‡ßÅ‡¶≤‡ßá ‡¶ó‡ßá‡¶≤‡ßá ‡¶°‡ßá‡¶≠‡ßá‡¶≤‡¶™‡¶æ‡¶∞ ‡¶è‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®`)) { currentPassword = resetDefaultPassword; isAdminMode = false; logActivity("Password forgotten and reset to default."); saveAppData(); showToast(`‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`,`info`); updateAdminModeUI(); } }));
    btnLogout?.addEventListener('click', () => { closeDropdownAndRun(() => { if (confirm('‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?')) { sessionStorage.clear(); localStorage.removeItem('mcth_rem_creds'); firebase.auth().signOut().then(() => { location.reload(); }); } }); });
    btnNavBack.addEventListener('click', () => { if (historyIndex > 0) { historyIndex--; const state = pageHistory[historyIndex]; if (window[state.page]) loadPage(window[state.page], state.context, true); } });
    btnNavForward.addEventListener('click', () => { if (historyIndex < pageHistory.length - 1) { historyIndex++; const state = pageHistory[historyIndex]; if (window[state.page]) loadPage(window[state.page], state.context, true); } });
    btnNavRefresh.addEventListener('click', () => location.reload());
    btnClearYearData?.addEventListener('click', () => closeDropdownAndRun(async () => {
        if (!isAdminMode) return;
        const confirmationText = `DELETE ${viewedYear}`;
        const userInput = prompt(`‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ! ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá ${viewedYear} ‡¶∏‡¶æ‡¶≤‡ßá‡¶∞ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡ßç‡¶•‡¶æ‡¶Ø‡¶º‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®? ‡¶è‡¶á ‡¶ï‡¶æ‡¶ú‡¶ü‡¶ø ‡¶Ü‡¶∞ ‡¶´‡ßá‡¶∞‡¶æ‡¶®‡ßã ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ‡•§\n\n‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡¶§‡ßá, "${confirmationText}" ‡¶ü‡¶æ‡¶á‡¶™ ‡¶ï‡¶∞‡ßÅ‡¶®:`);
        
        if (userInput === confirmationText) {
            const pass = prompt('‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø, ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡¶®:');
            if (pass === currentPassword) {
                showLoader();
                try {
                    await db.ref(`academicYears/${viewedYear}`).remove();
                    
                    const yearIndex = availableYears.indexOf(viewedYear);
                    if (yearIndex > -1) {
                        availableYears.splice(yearIndex, 1);
                        await db.ref('systemSettings/availableYears').set(availableYears);
                    }
                    
                    showToast(`${viewedYear} ‡¶∏‡¶æ‡¶≤‡ßá‡¶∞ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡ßç‡¶•‡¶æ‡¶Ø‡¶º‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§`, 'success');
                    
                    setTimeout(() => location.reload(), 1500);

                } catch (e) {
                    console.error("Error clearing year data:", e);
                    showToast("‡¶¨‡¶õ‡¶∞-‡¶è‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§", 'error');
                } finally {
                    hideLoader();
                }
            } else if (pass) {
                showToast('‡¶≠‡ßÅ‡¶≤ ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°‡•§ ‡¶ï‡¶æ‡¶ú‡¶ü‡¶ø ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§', 'error');
            }
        } else if (userInput) {
            showToast('‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ‡ßá‡¶∂‡¶® ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶Æ‡ßá‡¶≤‡ßá‡¶®‡¶ø‡•§ ‡¶ï‡¶æ‡¶ú‡¶ü‡¶ø ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§', 'error');
        }
    }));
    
    // Page function mapping to window object for history navigation
    window.showHomePage = showHomePage; window.showDashboardPage = showDashboardPage; window.showBatchPage = showBatchPage; window.showPaymentPage = showPaymentPage; window.showStudentDatabasePage = showStudentDatabasePage; window.showStudentProfilePage = showStudentProfilePage; window.showBatchDetailsPage = showBatchDetailsPage; window.showStudentPaymentDetailsPage = showStudentPaymentDetailsPage; window.showPaymentHistoryPage = showPaymentHistoryPage; window.showPaymentDocumentPage = showPaymentDocumentPage; window.showDashboardDetailsPage = showDashboardDetailsPage; window.showReportsPage = showReportsPage; window.showRecycleBinPage = showRecycleBinPage; window.showFindTrnxIdPage = showFindTrnxIdPage;
    
    btnShowHistory?.addEventListener('click', () => closeDropdownAndRun(() => loadPage(showPaymentHistoryPage)));
    btnRecycleBin?.addEventListener('click', () => closeDropdownAndRun(() => loadPage(showRecycleBinPage)));
    btnFindTrnxId?.addEventListener('click', () => closeDropdownAndRun(() => loadPage(showFindTrnxIdPage)));
    btnToggleTheme?.addEventListener('click', () => closeDropdownAndRun(toggleTheme));
    btnAboutDeveloper?.addEventListener('click', () => closeDropdownAndRun(showAboutDeveloperModal));
    btnHome.addEventListener('click', () => loadPage(showHomePage));
    btnDashboard.addEventListener('click', () => loadPage(showDashboardPage));
    btnBatch.addEventListener('click', () => loadPage(showBatchPage));
    btnPayment.addEventListener('click', () => { currentStudentContext = {}; loadPage(showPaymentPage); });
    btnStudentDatabase.addEventListener('click', () => loadPage(showStudentDatabasePage));
    btnReports.addEventListener('click', () => loadPage(showReportsPage));
    btnExam.addEventListener('click', () => { window.open('exam.html', '_blank'); });
    btnAttendance.addEventListener('click', () => { window.open('attendance.html', '_blank'); });
    btnSms.addEventListener('click', () => { window.open('sms.html', '_blank'); });
    
    listenForSmsSettingsChanges(); 
    fileImporter.addEventListener('change', handleImport);
    
    // ===== Year Management Logic =====
    const yearSelector = document.getElementById('yearSelector');

    function updateYearSelectorUI() {
        yearSelector.innerHTML = '';
        availableYears.sort((a,b) => a - b).forEach(year => { 
            const option = document.createElement('option'); 
            option.value = year; 
            option.textContent = `${year}${year == activeYear ? ' (Active)' : ''}`; 
            if (year == viewedYear) { option.selected = true; } 
            yearSelector.appendChild(option); 
        });
        const isYearBarHidden = localStorage.getItem(YEAR_BAR_HIDDEN_KEY) === 'true';
        document.getElementById('year-management-controls').style.display = isYearBarHidden ? 'none' : 'flex';
        btnToggleYearBar.textContent = isYearBarHidden ? 'Show Year Bar' : 'Hide Year Bar';
        updateAdminModeUI();
    }

    yearSelector.addEventListener('change', (e) => {
        const selectedYear = parseInt(e.target.value);
        if (selectedYear !== viewedYear) {
            const pass = prompt(`‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶¨‡¶∞‡ßç‡¶∑ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡¶®:`);
            if (pass === currentPassword) {
                if (isSaving) {
                    showToast("‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡ßá‡¶≠ ‡¶π‡¶ö‡ßç‡¶õ‡ßá‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§", "info");
                    e.target.value = viewedYear;
                    return;
                }
                dataLoaded = false;
                pageHistory = [];
                historyIndex = -1;
                sessionStorage.removeItem('mcth_session_state');
                loadAppData(selectedYear);
            } else {
                if (pass) { showToast('‡¶≠‡ßÅ‡¶≤ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°!', 'error'); }
                e.target.value = viewedYear;
            }
        }
    });

   btnToggleYearBar.addEventListener('click', () => {
       const isHidden = localStorage.getItem(YEAR_BAR_HIDDEN_KEY) === 'true';
       localStorage.setItem(YEAR_BAR_HIDDEN_KEY, !isHidden);
       updateYearSelectorUI();
       closeDropdownAndRun();
   });

    // Start the application by fetching system settings first
    db.ref('systemSettings').once('value').then(snapshot => {
        if (snapshot.exists()) {
            const settings = snapshot.val();
            activeYear = settings.activeYear || new Date().getFullYear();
            availableYears = settings.availableYears || [2025, 2026, 2027];
        } else {
            // If no settings exist, create them
            activeYear = new Date().getFullYear();
            availableYears = [2025, 2026, 2027];
            db.ref('systemSettings').set({ activeYear, availableYears });
        }
        
        const lastViewedYear = localStorage.getItem('mcth_viewed_year');
        viewedYear = lastViewedYear ? parseInt(lastViewedYear) : activeYear;
        
        // Ensure viewedYear is a valid, available year
        if (!availableYears.includes(viewedYear)) {
            viewedYear = activeYear;
            localStorage.setItem('mcth_viewed_year', viewedYear);
        }
    
        loadAppData(viewedYear); // Start the application
    }).catch(err => {
        console.error("Could not fetch system settings, defaulting.", err);
        activeYear = new Date().getFullYear();
        availableYears = [2025, 2026, 2027];
        viewedYear = activeYear;
        loadAppData(viewedYear);
    });
}
</script>
</body>
</html>