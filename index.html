<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCTH ম্যানেজমেন্ট - Mobile</title>
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">
    
    <!-- SheetJS CDN for Excel Import -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- FIREBASE SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>

    <style>
        /* ======== Mobile-Optimized Styles (Revised) ======== */
        @font-face {
            font-family: 'Kalpurush';
            src: url('fonts/kalpurush.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        :root {
            --bg-main: #f4f6f9; --bg-section: #ffffff; --bg-header: #1f2b38; --bg-tab-container: #e9ecef; --bg-tab: #f8f9fa; --bg-tab-active: #ffffff; --bg-input: #ffffff; --bg-input-disabled: #e9ecef; --bg-scrollable: #ffffff; --bg-hover: #eef2f7; --bg-footer: #1f2b38; --text-primary: #212529; --text-secondary: #6c757d; --text-header: #ffffff; --text-tab: #495057; --text-tab-active: #0056b3; --text-input-disabled: #6c757d; --text-footer: #e9ecef; --text-footer-dev: #adb5bd; --border-color: #dee2e6; --border-accent: #007bff; --border-tab-active: #ffffff; --paid-color: #a9d8b8; --due-color: #f1b5b8; --paid-text: #146c43; --due-text: #842029; --future-text: #6c757d; --not-applicable-color: #f8f9fa; --not-applicable-text: #666666;
            --toast-success-bg: #28a745; --toast-error-bg: #dc3545; --toast-info-bg: #17a2b8;
        }
        
        body[data-theme='dark'] {
            --bg-main: #121212; --bg-section: #1e1e1e; --bg-header: #1f2b38; --bg-tab-container: #121212; --bg-tab: #2a2a2a; --bg-tab-active: #1e1e1e; --bg-input: #252525; --bg-input-disabled: #3a3a3a; --bg-scrollable: #1e1e1e; --bg-hover: #333333; --bg-footer: #1f2b38; --text-primary: #e8eaed; --text-secondary: #9aa0a6; --text-header: #e8eaed; --text-tab: #e8eaed; --text-tab-active: #8ab4f8; --text-input-disabled: #888888; --text-footer: #e8eaed; --text-footer-dev: #9aa0a6; --border-color: #3a3a34; --border-accent: #8ab4f8; --border-tab-active: #1e1e1e; --paid-color: #143d26; --due-color: #4a1c21; --paid-text: #a3d9a5; --due-text: #f5c6cb; --not-applicable-color: #2c2c2c; --not-applicable-text: #666666;
        }
        
        html { scroll-behavior: smooth; }
        body {
            margin: 0;
            padding: 0;
            font-family: 'Kalpurush', sans-serif;
            font-size: 16px;
            background-color: var(--bg-main);
            color: var(--text-primary);
            transition: background-color .3s, color .3s;
            line-height: 1.5;
        }

        /* Login Styles */
        #login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; box-sizing: border-box; background-color: var(--bg-main); }
        .login-box { background-color: var(--bg-section); padding: 25px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; border: 1px solid var(--border-color); }
        .login-box h1 { font-size: 1.5em; margin-bottom: 20px; }
        .login-logo { width: 80px; height: 80px; margin: 0 auto 15px; }
        .input-group { position: relative; margin-bottom: 15px; }
        .input-group input { width: 100%; padding: 12px 15px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 1em; background-color: var(--bg-input); color: var(--text-primary); box-sizing: border-box; }
        .password-toggle-icon { position: absolute; top: 50%; right: 12px; transform: translateY(-50%); cursor: pointer; color: var(--text-secondary); font-size: 1.1em; }
        .login-options { display: flex; justify-content: space-between; align-items: center; font-size: 0.85em; margin-bottom: 20px; }
        .login-button { width: 100%; padding: 12px; border: none; border-radius: 8px; background-color: var(--border-accent); color: white; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: background-color 0.3s; }
        #login-error-msg { color: var(--due-text); margin-top: 10px; min-height: 20px; font-weight: bold; }
        .login-footer { margin-top: 25px; font-size: 0.75em; color: var(--text-secondary); }

        /* App Container Styles */
        #app-container { display: flex; flex-direction: column; min-height: 100vh; }
        #app-container.hidden { display: none; }
        
        /* ======== NEW MOBILE HEADER ======== */
        header {
            background-color: var(--bg-header);
            color: var(--text-header);
            padding: 8px 10px;
            position: sticky;
            top: 0;
            z-index: 1001;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .header-top-row, .header-mid-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
        .branding-info {
            display: flex;
            flex-direction: column;
        }
        .branding-info .institute-name {
            font-size: 1.1em;
            font-weight: bold;
        }
        .branding-info .contact-info {
            font-size: 0.75em;
            opacity: 0.8;
        }
        .header-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .mode-controls {
            display: flex;
            align-items: center;
            gap: 5px;
            background-color: rgba(255,255,255,0.1);
            padding: 3px 6px;
            border-radius: 15px;
        }
        .mode-display {
            font-size: 0.8em;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 10px;
        }
        .mode-display.admin-active { background-color: #c0392b; color: white; }
        .mode-display.assistant-active { background-color: #27ae60; color: white; }
        #btnToggleMode {
            background: none;
            border: none;
            color: white;
            font-size: 0.8em;
            cursor: pointer;
            opacity: 0.9;
        }
        #btnToggleMode:hover { opacity: 1; }
        #year-management-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }
        #yearSelector {
            padding: 4px 8px;
            border-radius: 15px;
            border: 1px solid #5a6a7e;
            background-color: #334257;
            color: #e8eaed;
            font-size: 0.9em;
            cursor: pointer;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;utf8,<svg fill='white' height='24' viewBox='0 0 24 24' width='24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>");
            background-repeat: no-repeat;
            background-position: right 5px top 50%;
            padding-right: 20px;
        }
        .header-nav-buttons {
            display: flex;
            overflow-x: auto;
            gap: 8px;
            padding-bottom: 5px; /* For scrollbar */
        }
        .header-nav-buttons::-webkit-scrollbar { height: 4px; }
        .header-nav-buttons::-webkit-scrollbar-thumb { background: #555; border-radius: 2px; }
        .header-nav-buttons button {
            border: none;
            cursor: pointer;
            border-radius: 15px;
            white-space: nowrap;
            background-color: var(--border-accent);
            color: #fff;
            padding: 6px 12px;
            font-size: 0.9em;
            transition: background-color 0.2s ease;
            flex-shrink: 0;
        }
        .header-nav-buttons button:hover { background-color: #0056b3; }
        
        .global-nav-icons { display: flex; gap: 12px; }
        .nav-icon-svg { width: 22px; height: 22px; cursor: pointer; transition: opacity .2s; }
        .nav-icon-svg path { fill: var(--text-header); }
        .nav-icon-svg.disabled { opacity: 0.4; cursor: not-allowed; }

        .privacy-menu-container { position: relative; }
        .privacy-menu-button { background: 0 0; border: none; color: var(--text-header); font-size: 1.6em; cursor: pointer; padding: 0 8px; line-height: 1; }
        .privacy-dropdown-content { display: none; position: absolute; top: 40px; right: 0; background-color: var(--bg-section); color: var(--text-primary); min-width: 220px; box-shadow: 0 4px 12px rgba(0,0,0,.2); z-index: 10000; border-radius: 8px; border: 1px solid var(--border-color); overflow: hidden; }
        .privacy-dropdown-content.active { display: block; }
        .privacy-dropdown-content h4 { margin: 0; padding: 10px 15px; background-color: var(--bg-tab); border-bottom: 1px solid var(--border-color); font-size: 0.9em; color: var(--text-secondary); }
        .privacy-dropdown-content button { width: 100%; padding: 10px 15px; text-align: left; background: 0 0; border: none; cursor: pointer; font-size: 0.95em; color: var(--text-primary); display: flex; align-items: center; justify-content: space-between; }
        .privacy-dropdown-content button:hover { background-color: var(--bg-hover); }
        .privacy-dropdown-content hr { margin: 5px 0; border: none; border-top: 1px solid var(--border-color); opacity: 0.5; }
        .backup-submenu { display: none; background-color: var(--bg-hover); padding-left: 15px; }
        .backup-submenu.open { display: block; }
        .backup-submenu button { padding-left: 25px; font-size: 0.9em; }
        .arrow-icon { display: inline-block; transition: transform .2s ease-in-out; }
        #btnBackupMenuToggle.open .arrow-icon { transform: rotate(90deg); }

        /* Main Content Area */
        main { padding: 15px; flex-grow: 1; position: relative; }
        #breadcrumb-container { padding: 0 5px 10px 5px; font-size: 0.8em; color: var(--text-secondary); flex-wrap: wrap; }
        #breadcrumb-container a { color: var(--text-tab-active); text-decoration: none; }
        #banner-area-placeholder { width: 100%; text-align: center; margin-bottom: 15px; }
        #banner-area-placeholder img { width: 100%; max-height: 200px; object-fit: cover; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,.08); }

        .page-section { background-color: var(--bg-section); padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 1px 4px rgba(0,0,0,.06); border: 1px solid var(--border-color); }
        .page-section.hidden, .admin-only.hidden { display: none; }

        /* Toasts */
        #toast-container { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); z-index: 10005; display: flex; flex-direction: column; gap: 8px; width: 90%; max-width: 400px; }
        .toast { padding: 12px 15px; border-radius: 6px; color: #fff; font-size: 0.9em; box-shadow: 0 2px 10px rgba(0,0,0,.2); opacity: 0; transform: translateY(20px); transition: opacity .3s, transform .3s; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success { background-color: var(--toast-success-bg); }
        .toast.error { background-color: var(--toast-error-bg); }
        .toast.info { background-color: var(--toast-info-bg); }

        /* Loader */
        #loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,.6); z-index: 10006; display: none; align-items: center; justify-content: center; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Grids and Layouts */
        .home-grid { display: flex; flex-direction: column; gap: 15px; }
        .adikothon-container { margin: 0; }
        .adikothon { padding: 20px; font-size: 0.95em; line-height: 1.6; }
        .adikothon h3 { font-size: 1.4em; margin-bottom: 15px; }
        .image-slider-container { margin: 0; padding: 10px; border: none; box-shadow: none; }
        #homeImageSlider { width: 100%; height: auto; max-height: 300px; object-fit: contain; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,.1); transition: opacity 1s ease-in-out; }

        /* Modals */
        .modal-overlay { display: none; position: fixed; z-index: 10001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,.6); backdrop-filter: blur(4px); align-items: center; justify-content: center; padding: 10px; box-sizing: border-box; }
        .modal-overlay.visible { display: flex; }
        .modal-content { background-color: var(--bg-section); margin: auto; padding: 20px; border: 1px solid var(--border-color); border-radius: 8px; width: 100%; max-width: 600px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 5px 15px rgba(0,0,0,.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 10px; }
        .modal-header h2 { margin: 0; color: var(--text-tab-active); font-size: 1.3em; }
        .close-button { color: var(--text-secondary); font-size: 1.8em; font-weight: 700; border: none; background: 0 0; cursor: pointer; padding: 0 5px; }
        .modal-body { overflow-y: auto; padding-right: 8px; flex-grow: 1; }
        .modal-body .form-group { margin-bottom: 15px; }
        .modal-body .form-group label { display: block; margin-bottom: 5px; font-weight: 700; color: var(--text-secondary); font-size: 0.95em; }
        .modal-body .form-group input, .modal-body .form-group select { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; box-sizing: border-box; background-color: var(--bg-input); color: var(--text-primary); }
        .modal-footer { margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color); text-align: right; }
        .modal-footer button { padding: 8px 15px; border-radius: 6px; }

        /* Dashboard */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; }
        .dashboard-card { background-color: var(--bg-section); padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,.05); border-left: 4px solid; text-align: center; position: relative; padding-bottom: 35px; border: 1px solid var(--border-color); border-left-width: 4px; }
        .dashboard-card h4 { margin: 0 0 8px 0; color: var(--text-secondary); font-size: 0.9em; }
        .dashboard-card .stat-number { font-size: 1.8em; font-weight: 700; margin: 0; word-break: break-word; }
        .dashboard-card .details-button { position: absolute; bottom: 8px; right: 8px; font-size: 0.8em; padding: 4px 10px; background-color: var(--bg-tab); border: 1px solid var(--border-color); color: var(--text-secondary); border-radius: 4px; cursor: pointer; }
        .card-students { border-color: #007bff; } .card-students .stat-number { color: #007bff; }
        .card-batches { border-color: #6f42c1; } .card-batches .stat-number { color: #6f42c1; }
        .card-collection { border-color: #28a745; } .card-collection .stat-number { color: #28a745; }
        .card-due { border-color: #dc3545; } .card-due .stat-number { color: #dc3545; }
        .card-paid-students { border-color: #17a2b8; } .card-paid-students .stat-number { color: #17a2b8; }
        .card-due-students { border-color: #fd7e14; } .card-due-students .stat-number { color: #fd7e14; }

        /* Tables */
        .table-responsive-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.95em; }
        th, td { border: 1px solid var(--border-color); padding: 10px; text-align: left; vertical-align: middle; white-space: nowrap; }
        th { background-color: var(--bg-tab); color: var(--text-secondary); font-weight: 700; font-size: 0.9em; }
        td input { width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 3px; box-sizing: border-box; background-color: var(--bg-input); color: var(--text-primary); }
        td input:disabled { background-color: var(--bg-input-disabled); cursor: not-allowed; color: var(--text-input-disabled); }

        /* General Buttons */
        .action-button, td button { padding: 6px 10px; margin-right: 5px; border: none; border-radius: 3px; cursor: pointer; transition: opacity 0.2s; font-size: 0.9em; }
        .btn-paid { background-color: #28a745; color: #fff; }
        .btn-due { background-color: #dc3545; color: #fff; }
        .btn-show-doc { background-color: var(--border-accent); color: #fff; }
        .btn-add { background-color: #007bff; color: #fff; margin-top: 10px; }

        /* Tabs */
        .tab-container { display: flex; overflow-x: auto; border-bottom: 2px solid var(--border-accent); background-color: var(--bg-tab-container); gap: 2px; }
        .tab-button { padding: 10px 15px; cursor: pointer; border: none; background-color: var(--bg-tab); border-bottom: 2px solid transparent; font-size: 1em; border-top-left-radius: 4px; border-top-right-radius: 4px; display: flex; align-items: center; gap: 5px; color: var(--text-tab); transition: all 0.2s ease; white-space: nowrap; flex-shrink: 0; }
        .tab-button.active { background-color: var(--bg-tab-active); border: 1px solid var(--border-color); border-bottom: 2px solid var(--border-tab-active); font-weight: 700; color: var(--text-tab-active); border-top: 2px solid var(--border-accent); margin-bottom: -1px; }
        .tab-content { padding: 15px; border: 1px solid var(--border-color); border-top: none; background-color: var(--bg-section); border-radius: 0 0 8px 8px; }

        /* Student Payment Details Page */
        .details-grid { display: flex; flex-direction: column; gap: 15px; }
        .yearly-status-container { border: 1px solid var(--border-color); padding: 10px; border-radius: 5px; }
        .yearly-status-chart { display: grid; grid-template-columns: repeat(auto-fit, minmax(70px, 1fr)); gap: 5px; text-align: center; }
        .month-box { padding: 5px; border-radius: 4px; font-size: .8em; font-weight: 700; border: 1px solid var(--border-color); }
        .month-box.paid { background-color: var(--paid-color); color: var(--paid-text); }
        .month-box.due { background-color: var(--due-color); color: var(--due-text); }
        .month-box.future { background-color: var(--bg-input-disabled); color: var(--future-text); }
        .month-box.not-applicable { background-color: var(--not-applicable-color); color: var(--not-applicable-text); }


        /* Other specific component styles */
        .payment-filters, .details-list-filters { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center; }
        .payment-filters input, .payment-filters select, .details-list-filters select, .details-list-filters input { padding: 8px; border-radius: 4px; border: 1px solid var(--border-color); background-color: var(--bg-input); color: var(--text-primary); height: 38px; font-size: 0.9em; flex-grow: 1; min-width: 120px; }
        .student-list-header { display: flex; flex-direction: column; align-items: flex-start; gap: 15px; margin-bottom: 15px; }
        .student-list-header h3 { margin: 0; font-size: 1.3em; }
        .default-fee-controls { display: flex; gap: 10px; align-items: center; background-color: var(--bg-tab); padding: 8px 12px; border-radius: 5px; border: 1px solid var(--border-color); flex-wrap: wrap; font-size: 0.9em; }
        
        .profile-card p { display: flex; flex-wrap: wrap; }
        .profile-card strong { min-width: 120px; margin-right: 10px; }

        .batch-grid { display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 15px; }
        .batch-card-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background-color: var(--bg-tab); }
        .batch-time { font-size: 1.2em; font-weight: 700; cursor: pointer; color: var(--text-tab-active); }
        .student-action-icons { display: flex; gap: 12px; align-items: center; justify-content: center; }
        .student-delete-icon, .student-edit-icon, .student-transfer-icon { cursor: pointer; font-size: 1.2em; transition: transform 0.2s ease; }
        
        /* Footer */
        footer { background-color: var(--bg-footer); color: var(--text-footer); text-align: center; padding: 15px; font-size: 0.85em; margin-top: 20px; }
        .developer-info { font-size: 0.8em; color: var(--text-footer-dev); margin-top: 5px; }

        /* Payment Receipt Specific Styles for Mobile */
        .receipt-controls { flex-direction: column; gap: 10px; align-items: stretch; }
        .payment-receipt { flex-direction: column; border: none; }
        .student-copy, .office-copy { width: 100% !important; border-left: none !important; }
        .office-copy { display: none; } /* Hide office copy by default on mobile */
        @media print { .office-copy { display: block; }}
    </style>
</head>
<body data-theme="light">
    
    <div id="login-container">
        <div class="login-box">
            <img src="images/image2.png" alt="Logo" class="login-logo" onerror="this.style.display='none'">
            <h1>গণিত ক্রিয়েটিভ টিচিং হোম</h1>
            <form id="login-form">
                <div class="input-group">
                    <input type="text" id="username" placeholder="MCTH Username" required>
                </div>
                <div class="input-group">
                    <input type="password" id="password" placeholder="Password" required>
                    <span id="password-toggle" class="password-toggle-icon">👁️</span>
                </div>
                <div class="login-options">
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="checkbox" id="remember-me"> Remember Me
                    </label>
                </div>
                <button type="submit" class="login-button">Software-এ প্রবেশ করুন</button>
                <div id="login-error-msg"></div>
            </form>
            <div class="login-footer">
                Developed by: Abdullah Al Rafi(BZS26)<br><br>
                &copy; Copyright by Math Creative Teaching Home 2025
            </div>
        </div>
    </div>
    
    <div id="app-container" class="hidden">
        <div id="toast-container"></div>
        <div id="loader-overlay"><div class="loader"></div></div>
        
        <header>
            <div class="header-top-row">
                <div class="branding-info">
                    <span class="institute-name">গণিত ক্রিয়েটিভ টিচিং হোম</span>
                    <span class="contact-info">☎ 01747019383/01784697168</span>
                </div>
                <div class="header-controls">
                    <div class="mode-controls">
                        <span id="currentModeDisplay" class="mode-display">Assistant</span>
                        <button id="btnToggleMode">Admin</button>
                    </div>
                    <div class="privacy-menu-container">
                        <button id="btnPrivacyMenu" class="privacy-menu-button" title="Options">&#8942;</button>
                        <div id="privacyDropdown" class="privacy-dropdown-content">
                            <h4>Settings</h4>
                            <button id="btnToggleYearBar">Hide Year Bar</button>
                            <button id="btnShowHistory">হিস্টোরি দেখুন</button>
                            <button id="btnRecycleBin">রিসাইকেল বিন</button>
                            <div class="backup-menu-container">
                                <button id="btnBackupMenuToggle">ব্যাকআপ <span class="arrow-icon">▶</span></button>
                                <div id="backupSubMenu" class="backup-submenu">
                                    <button id="btnExportData">💾 Export JSON</button>
                                    <button id="btnImportData">📤 Import JSON</button>
                                </div>
                            </div>
                            <button id="btnToggleTheme">থিম পরিবর্তন <span id="themeIcon"></span></button>
                            <hr>
                            <h4>About</h4>
                            <button id="btnAboutDeveloper">About Developer</button>
                            <hr>
                            <h4>Privacy</h4>
                            <button id="btnChangePassword" class="admin-only hidden">পাসওয়ার্ড পরিবর্তন</button>
                            <button id="btnForgotPassword">পাসওয়ার্ড ভুলে গেছি</button>
                            <hr>
                            <button id="btnLogout">লগআউট</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="header-mid-row">
                <div class="global-nav-icons">
                    <span id="btnNavBack" title="Back"><svg class="nav-icon-svg" width="24" height="24" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" fill="currentColor"></path></svg></span>
                    <span id="btnNavForward" title="Forward"><svg class="nav-icon-svg" width="24" height="24" viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z" fill="currentColor"></path></svg></span>
                    <span id="btnNavRefresh" title="Refresh"><svg class="nav-icon-svg" width="24" height="24" viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z" fill="currentColor"></path></svg></span>
                </div>
                <div id="year-management-controls">
                    <select id="yearSelector"></select>
                </div>
            </div>
            <div class="header-nav-buttons">
                <button id="btnHome">হোম</button>
                <button id="btnDashboard">ড্যাশবোর্ড</button>
                <button id="btnBatch">ব্যাচ</button>
                <button id="btnPayment">পেমেন্ট</button>
                <button id="btnStudentDatabase">ছাত্র ডেটাবেস</button>
                <button id="btnReports">রিপোর্টস</button>
                <button id="btnExam">পরীক্ষা</button>
                <button id="btnAttendance">অ্যাটেনডেন্স</button>
                <button id="btnSms">SMS</button>
            </div>
        </header>
        
        <input type="file" id="fileImporter" accept=".json" style="display:none">
        <div id="breadcrumb-container"></div>
        <main id="main-content-area">
            <div id="banner-area-placeholder"></div>
            <div id="dynamic-content-placeholder"></div>
        </main>
        
        <!-- === All TEMPLATES ARE NOW CORRECT AND VERIFIED FROM index.html === -->
        <template id="template-home"><div class="home-grid"><div class="page-section adikothon-container"><div class="adikothon"><h3>কিছু কথা:</h3><p>গণিত ক্রিয়েটিভ টিচিং হোম' একটি শিক্ষা সহায়ক প্রতিষ্ঠান। স্বচ্ছতা ও জবাবদিহিতার আলোকে একটি বিবেক সৃষ্টির লক্ষ্যে 'গণিত ক্রিয়েটিভ টিচিং হোম" সকল শিক্ষা কার্যক্রম পরিচালনা করছে। এ সমাজের কিছু মানুষের স্বপ্ন পূরণে গণিত ক্রিয়েটিভ টিচিং হোমের পক্ষ থেকে সামান্য সহযোগিতা প্রদান করতে পারলে 'গণিত ক্রিয়েটিভ টিচিং হোম' নিজেকে ধন্য মনে করবে।</p><p>'সবার জন্য শিক্ষা' এই স্লোগানকে সামনে রেখে 'গণিত ক্রিয়েটিভ টিচিং হোম' তার অবস্থান থেকে কিছু মানুষের শিক্ষা অর্জন নিশ্চিত করার লক্ষ্যে বিভিন্ন পদক্ষেপের মাধ্যমে শিক্ষার্থীদেরকে পড়াশোনামুখী করার বাস্তব পদক্ষেপ গ্রহণ করেছে। আর্থিক অস্বচ্ছল শিক্ষার্থী তথা এতিমদের জন্য বিনা বেতনে পড়ালেখা করার বিশেষ সুযোগ প্রদান, নিয়মিত বৃত্তি প্রদান এবং সকল শিক্ষার্থীদেরকে উৎসাহ প্রদানের জন্য নিয়মিত পরীক্ষার আয়োজন, প্রতিটি পরীক্ষার মূল্যায়ন সাপেক্ষে পুরস্কার ঘোষণা এবং আনুষ্ঠানিকভাবে পুরস্কার প্রদান, যা প্রতিটি শিক্ষার্থীকে দায়িত্ববোধ থেকে পড়াশোনা করার অনুপ্রেরণা যোগায়। অভিভাবকদের সঙ্গে নিয়মিত যোগাযোগের মাধ্যমে ছাত্র-ছাত্রীর সার্বিক উন্নয়নে প্রয়োজনীয় ব্যবস্থা নেওয়া হয়।</p><p>গণিত ক্রিয়েটিভ টিচিং হোমের' নিয়মিত অনুশীলন একজন শিক্ষার্থীর স্বপ্ন পূরণে বিশেষ সহায়ক ভূমিকা রাখবে বলে আমি দৃঢ়ভাবে বিশ্বাস করি। সকলের সার্বিক সুস্থতা ও দীর্ঘায়ু কামনা করছি।</p></div></div><div class="page-section image-slider-container"><img id="homeImageSlider" src="images/image3.png" alt="Promotional Image" onerror="this.style.display='none'"></div></div></template>
        <template id="template-dashboard"><div class="page-section"><h2>ড্যাশবোর্ড</h2><div class="dashboard-grid"></div></div></template>
        <template id="template-student-database">
            <div class="page-section">
                <h2>ছাত্র ডেটাবেস</h2>
                <p>যেকোনো ছাত্রকে তার নাম, রোল বা যোগাযোগ নম্বর দিয়ে খুঁজে বের করুন।</p>
                <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    <input type="search" id="studentDatabaseSearchInput" placeholder="নাম বা রোল..." style="flex-grow: 1; padding: 12px; font-size: 1em;">
                    <input type="search" id="studentDatabaseContactInput" placeholder="যোগাযোগ নম্বর..." style="flex-grow: 1; padding: 12px; font-size: 1em;">
                </div>
                <div id="student-search-results"></div>
            </div>
        </template>
        <template id="template-payment"><div class="page-section" style="padding:0; border:none; box-shadow:none; background-color: transparent;"><div class="tab-container" id="payment-class-categories-tabs"></div><div id="payment-tab-contents"></div></div></template>
        <template id="template-payment-history"><div class="page-section"><h2>হিস্টোরি</h2><div class="tab-container" id="history-tabs"><button class="tab-button active" data-tab="payment">পেমেন্ট হিস্টোরি</button><button class="tab-button" data-tab="activity">Student Activity</button></div><div id="history-content-area" class="tab-content" style="max-height: 60vh; overflow-y: auto;"></div><button id="btnBackFromHistory" class="action-button" style="margin-top:15px">হোম-পেজে ফেরত যান</button></div></template>
        <template id="template-student-profile">
            <div class="page-section">
                <div class="details-header-container" style="align-items:center;margin-bottom:15px; gap: 10px;">
                    <div style="margin-left: auto; display: flex; gap: 10px;">
                        <button id="btnEditStudentProfile" class="action-button admin-only hidden" style="background-color:#e67e22;color:#fff">Edit Profile</button>
                        <button id="btnGoToPaymentSection" class="action-button" style="background-color:#6f42c1;color:#fff">পেমেন্ট সেকশন দেখুন</button>
                    </div>
                </div>
                <div class="profile-grid" style="align-items: start; gap: 20px;">
                    <div class="profile-card" style="text-align: center; padding-top: 20px;">
                        <img id="profilePagePhoto" src="images/default_avatar.png" alt="Profile Photo" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid var(--border-color);" onerror="this.src='images/default_avatar.png'">
                        <h3 id="profileNameHeader" style="margin-top: 15px; font-size: 1.4em;"></h3>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <div class="profile-card">
                            <h4>সাধারণ তথ্য</h4>
                            <p><strong>রোল:</strong> <span id="profileRoll"></span></p>
                            <p><strong>ক্লাস:</strong> <span id="profileClass"></span></p>
                            <p><strong>স্কুল:</strong> <span id="profileSchool"></span></p>
                            <p><strong>যোগাযোগ (অভিভাবক):</strong> <span id="profileParentContact"></span></p>
                            <p><strong>ভর্তির তারিখ:</strong> <span id="profileAdmissionDate"></span></p>
                        </div>
                        <div class="profile-card">
                            <h4>বর্তমান ব্যাচসমূহ</h4>
                            <div id="student-profile-batches"></div>
                        </div>
                    </div>
                </div>
                <button id="btnBackToDatabase" class="action-button" style="margin-top:20px">ডেটাবেসে ফেরত যান</button>
            </div>
        </template>
        <template id="template-batch"><div class="page-section" style="padding:0; border:none; box-shadow:none; background-color: transparent;"><h2>ব্যাচ ম্যানেজমেন্ট</h2><div class="tab-container" id="batch-day-tabs"></div><div id="batch-class-subtabs-container" class="tab-content" style="border-top:none;margin-top:0;padding-top:10px"></div></div></template>
        <template id="template-batch-details"><div class="page-section"><div class="student-list-header print-hide"><div><h3 id="batchDetailsHeader">ব্যাচের শিক্ষার্থীদের তালিকা</h3><p><strong>দিন:</strong> <span id="batchDetailsDay"></span> | <strong>ক্লাস:</strong> <span id="batchDetailsClass"></span> | <strong>সময়:</strong> <span id="batchDetailsTime"></span></p></div><div class="details-list-filters"><input type="search" id="batchStudentSearchInput" class="print-hide" placeholder="নাম দিয়ে সার্চ করুন..."><button id="btnBulkImport" class="action-button print-hide">Excel থেকে যোগ করুন</button><input type="file" id="bulkStudentImportInput" accept=".xlsx" style="display:none;"><button id="btnPrintBatchList" class="action-button print-hide">PDF ডাউনলোড</button></div></div><hr class="print-hide"><div id="printableBatchDetailsArea" class="printable-area"><div class="details-page-printable-header print-only"><h2 id="printBatchHeaderTitle"></h2><h3 id="printBatchHeaderClass"></h3><p id="printBatchHeaderBatch"></p></div><div class="table-responsive-wrapper"><table><thead><tr><th>ক্রমিক নং</th><th>নাম</th><th>রোল</th><th>স্কুলের নাম</th><th>যোগাযোগ নম্বর</th><th class="print-hide">একশন</th></tr></thead><tbody id="batchStudentListBody"></tbody></table></div><div class="print-footer"><span class="left-footer-text">&copy; Math Creative Teaching Home 2025</span><span class="right-footer-text">Software by: Abdullah Al Rafi (BZS26)</span></div></div><button class="action-button btn-add print-hide" id="btnAddStudentToBatch">+ নতুন শিক্ষার্থী যোগ করুন</button><button id="btnBackToBatchList" class="action-button print-hide" style="margin-top:20px">ব্যাচ লিস্টে ফেরত যান</button></div></template>
        <template id="template-transfer-modal"><div id="studentTransferModal" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h2 id="transferModalTitle">ছাত্রকে অন্য ব্যাচে ট্রান্সফার করুন</h2><span class="close-button">&times;</span></div><div class="modal-body" id="transferBatchListContainer"></div></div></div></template>
        <template id="template-add-student-modal">
            <div id="addStudentModal" class="modal-overlay">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 id="addStudentModalTitle">নতুন শিক্ষার্থী যোগ করুন</h2><span class="close-button">&times;</span>
                    </div>
                    <form id="addStudentForm">
                        <div class="modal-body">
                            <div class="form-group"><label for="studentNameInput">ছাত্রের নাম (আবশ্যক)</label><input type="text" id="studentNameInput" required></div>
                            <div class="form-group"><label for="studentSchoolInput">স্কুলের নাম</label><input type="text" id="studentSchoolInput"></div>
                            <div class="form-group"><label for="parentContactInput">অভিভাবকের যোগাযোগ নম্বর</label><input type="tel" id="parentContactInput"></div>
                            <div class="form-group">
                                <label for="studentPhotoInput">ছাত্রের ছবি (ঐচ্ছিক, সর্বোচ্চ 100KB)</label>
                                <input type="file" id="studentPhotoInput" accept="image/png, image/jpeg">
                            </div>
                        </div>
                        <div class="modal-footer"><button type="submit" class="action-button btn-add">সংরক্ষণ করুন</button></div>
                    </form>
                </div>
            </div>
        </template>
        <template id="template-student-payment-details">
            <div class="page-section">
                <div class="details-header-container" style="align-items: center;">
                    <img id="paymentPagePhoto" src="images/default_avatar.png" alt="Photo" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; margin-right: 15px;" onerror="this.src='images/default_avatar.png'">
                    <h3 id="studentNameHeader" style="margin-right: auto;">শিক্ষার্থীর পেমেন্ট বিবরণ</h3>
                    <div id="studentEntryDateDisplay" class="entry-date-info">ভর্তির তারিখ: <span id="entryDateValue">N/A</span></div>
                </div>
                <p><strong>রোল:</strong> <span id="studentRollDisplay"></span> | <strong>ক্লাস:</strong> <span id="studentClassDisplay"></span></p>
                <hr>
                <div class="details-grid">
                    <div class="payment-main-details">
                        <div><h4>ভর্তি ফি:</h4><label>পরিমাণ: <input type="number" id="admissionFeeAmount" placeholder="টাকা"></label><button class="action-button btn-paid" id="btnAdmissionPaid">Paid</button><button class="action-button btn-due" id="btnAdmissionDue">Due</button><button class="action-button btn-show-doc" id="btnShowAdmissionDoc">ডকুমেন্ট</button><span id="admissionFeeStatus">স্ট্যাটাস: প্রযোজ্য নয়</span> | <span id="admissionReceiverInfo">গ্রহণকারী: প্রযোজ্য নয়</span></div>
                        <hr><div><h4>মাসিক ফি (ডিফল্ট):</h4><label>পরিমাণ: <input type="number" id="defaultMonthlyFeeForStudent" placeholder="টাকা"></label><button id="btnSaveDefaultMonthlyFee" class="action-button">সংরক্ষণ</button></div>
                    </div>
                    <div class="yearly-status-container">
                        <h4>বারো মাসের পেমেন্ট স্ট্যাটাস</h4><div class="yearly-status-chart" id="yearlyStatusChart"></div>
                    </div>
                </div>
                <hr>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px; flex-wrap: wrap; gap: 10px;">
                    <h4>মাসভিত্তিক পেমেন্ট:</h4><button id="btnPaySelectedMonths" class="action-button btn-paid">নির্বাচিত মাসগুলো পরিশোধ করুন</button>
                </div>
                <div class="table-responsive-wrapper" style="max-height:400px">
                    <table>
                        <thead><tr><th><input type="checkbox" id="selectAllMonthsCheckbox" title="সবগুলো নির্বাচন করুন"></th><th>মাস</th><th>ফি</th><th>স্ট্যাটাস</th><th>গ্রহণকারী</th><th>একশন</th></tr></thead>
                        <tbody id="monthlyPaymentsTableBody"></tbody>
                    </table>
                </div>
                <button id="btnBackToPreviousPage" class="action-button" style="margin-top:20px">আগের পেজে ফেরত যান</button>
            </div>
        </template>
        <template id="template-payment-document"><div class="page-section payment-receipt-page" style="padding: 0;"><div class="receipt-controls print-hide"><div class="mode-toggle-container"><span>B&W</span><label class="switch"><input type="checkbox" id="colorModeToggle"><span class="slider"></span></label><span>Color</span></div><div class="layout-selection"><span>রশিদ লেআউট:</span><input type="radio" id="layout1" name="receiptLayout" value="layout-1" checked><label for="layout1">১</label><input type="radio" id="layout2" name="receiptLayout" value="layout-2"><label for="layout2">২</label><input type="radio" id="layout3" name="receiptLayout" value="layout-3"><label for="layout3">৩</label></div><button id="btnPrintGeneratedDocument" class="action-button">প্রিন্ট করুন</button></div><div class="printable-area"><div class="payment-receipt layout-1" id="printable-receipt-area"><div class="layout3-header" style="display:none;"><img src="images/image2.png" alt="Logo" class="layout3-logo" onerror="this.style.display='none'"><div class="layout3-institute-info"><h3 class="institute-name">Math Creative Teaching Home</h3><p class="contact-info">Contact: 01780434830 / 01747019383</p><hr style="border-top: 1px dashed #bbb; margin: 10px 0;"></div></div><div class="receipt-content-wrapper student-copy"><div class="receipt-token overlapping-fix">Trnx ID: <span id="docViewTokenNo">N/A</span></div><div id="docWelcomeMessage" class="doc-welcome-message hidden overlapping-fix">WELCOME</div><div class="copy-title overlapping-fix">Student Copy</div><div class="receipt-header overlapping-fix"><h3 class="institute-name">Math Creative Teaching Home</h3><p class="contact-info">Contact: 01780434830 / 01747019383</p></div><div class="receipt-details-grid overlapping-fix"><p><strong>Name:</strong> <span id="docViewStudentName">N/A</span></p><p><strong class="school-label">School Name:</strong> <span id="docViewStudentSchool">N/A</span></p><p><strong>Roll:</strong> <span id="docViewStudentRoll">N/A</span></p><p><strong>Class:</strong> <span id="docViewClassName">N/A</span></p><p><strong>Batch:</strong> <span id="docViewBatchInfo">N/A</span></p><div></div></div><p class="overlapping-fix"><strong>Payment For:</strong> <span id="docViewPaymentMonth">N/A</span></p><p class="overlapping-fix"><strong>Amount Paid:</strong> <span id="docViewAmountPaid">N/A</span> টাকা</p><p class="overlapping-fix"><strong>Payment Date:</strong> <span id="docViewPaymentDate">N/A</span></p><div class="student-copy-watermark"><img src="images/image2.png" alt="Watermark" onerror="this.style.display='none'"></div><div class="receipt-footer-area overlapping-fix"><div class="authority-seal-area">Authority's Seal</div><div class="footer-line-container"><div class="receiver-signature-area"><span class="receiver-name-display" id="docViewReceiverName">Shakil</span>Receiver's Signature</div><div class="receipt-footer">Software by: Abdullah Al Rafi (BZS26)<br>Contact: 01745938158</div></div></div></div><div class="receipt-content-wrapper office-copy"><div class="receipt-token overlapping-fix">Trnx ID: <span id="docViewTokenNoOffice">N/A</span></div><div class="copy-title overlapping-fix">Office Copy</div><div class="receipt-header overlapping-fix"><h3 class="institute-name">MCTH</h3></div><p class="overlapping-fix"><strong>Name:</strong> <span id="docViewStudentNameOffice">N/A</span></p><p class="overlapping-fix"><strong class="school-label">School:</strong> <span id="docViewStudentSchoolOffice">N/A</span></p><p class="overlapping-fix"><strong>Roll:</strong> <span id="docViewStudentRollOffice">N/A</span></p><p class="overlapping-fix"><strong>Class:</strong> <span id="docViewClassNameOffice">N/A</span></p><p class="overlapping-fix"><strong>Batch:</strong> <span id="docViewBatchInfoOffice">N/A</span></p><p class="overlapping-fix"><strong>Payment For:</strong> <span id="docViewPaymentMonthOffice">N/A</span></p><p class="overlapping-fix"><strong>Amount:</strong> <span id="docViewAmountPaidOffice">N/A</span></p><p class="overlapping-fix"><strong>Date:</strong> <span id="docViewPaymentDateOffice">N/A</span></p><div class="receiver-signature-area overlapping-fix"><span class="receiver-name-display" id="docViewReceiverNameOffice">Ashik</span>Receiver's Signature</div><div class="receipt-footer overlapping-fix">Software by: Abdullah Al Rafi (BZS26)<br>Contact: 01745938158</div></div><div class="receipt-watermark layout-1-watermark"><img src="images/image2.png" alt="Watermark" onerror="this.style.display='none'"></div></div></div><button id="btnBackFromDocument" class="action-button print-hide" style="margin-top:20px">ফেরত যান</button></div></template>
        <template id="template-dashboard-details-page"><div class="page-section"><div class="details-list-controls print-hide"><h2 id="detailsListPageTitle" style="margin: 0;">বিস্তারিত তালিকা</h2><div class="details-list-filters"><select id="detailsPageClassFilter"></select><select id="detailsPageBatchFilter"></select><select id="paymentTypeFilter"><option value="">সব ধরণের ফি</option><option value="মাসিক ফি">মাসিক বেতন</option><option value="ভর্তি ফি">ভর্তি ফি</option></select><button id="btnPrintDetailsList" class="action-button">PDF ডাউনলোড</button></div></div><hr class="print-hide"><div id="printableDetailsArea" class="printable-area"><div class="details-page-printable-header print-only"><h2 id="printHeaderTitle"></h2><h3 id="printHeaderSubtitle"></h3><p id="printHeaderFilters"></p></div><div class="table-responsive-wrapper"><table><thead><tr><th>ক্রমিক নং</th><th>ছাত্রের নাম</th><th>রোল</th><th>ক্লাস</th><th>ব্যাচ</th><th id="headerCol6">পেমেন্টের ধরণ / মোট বকেয়া</th><th id="headerCol7">পরিশোধিত টাকা / বকেয়া মাস</th></tr></thead><tbody id="detailsPageTableBody"></tbody></table></div><div id="detailsPageSummary" class="details-summary"></div><div class="print-footer"><span class="left-footer-text">&copy; Math Creative Teaching Home 2025</span><span class="right-footer-text">Software by: Abdullah Al Rafi (BZS26)</span></div></div><button id="btnBackToDashboard" class="action-button print-hide" style="margin-top:20px">ড্যাশবোর্ডে ফেরত যান</button></div></template>
        <template id="template-reports-page"><div class="page-section"><h2>কালেকশন রিপোর্ট</h2><div class="details-list-controls"><div class="details-list-filters"><label for="reportStartDate">শুরুর তারিখ:</label><input type="date" id="reportStartDate"><label for="reportEndDate">শেষের তারিখ:</label><input type="date" id="reportEndDate"><button id="btnGenerateReport" class="action-button btn-add">রিপোর্ট দেখুন</button></div><button id="btnPrintReport" class="action-button" disabled>PDF ডাউনলোড</button></div><hr><div id="report-results-area" class="printable-area"><div class="details-page-printable-header print-only"><h2>গণিত ক্রিয়েটিভ টিচিং হোম</h2><h3>কালেকশন রিপোর্ট</h3><p id="printReportHeaderDates"></p></div><div id="report-content"><p style="text-align:center; color: var(--text-secondary);">অনুগ্রহ করে তারিখ নির্বাচন করে "রিপোর্ট দেখুন" বাটনে ক্লিক করুন।</p></div><div class="print-footer"><span class="left-footer-text">&copy; Math Creative Teaching Home 2025</span><span class="right-footer-text">Software by: Abdullah Al Rafi (BZS26)</span></div></div></div></template>
        <template id="template-recycle-bin"><div class="page-section"><h2>রিসাইকেল বিন</h2><div class="tab-container" id="recycle-bin-tabs"><button class="tab-button active" data-tab="students">ছাত্র</button><button class="tab-button" data-tab="mainClassCategories">ক্লাস</button><button class="tab-button" data-tab="batchSchedule">দিন/ব্যাচ</button></div><div id="recycle-bin-content" class="tab-content" style="max-height: 60vh; overflow-y: auto;"></div></div></template>
        <template id="template-about-developer-modal">
            <div id="aboutDeveloperModal" class="modal-overlay">
                <div class="modal-content" style="max-width: 95%; padding: 15px; background: var(--bg-main); border-radius: 12px;">
                    <div class="modal-header" style="padding-bottom: 10px; margin-bottom: 10px;">
                        <h2>About the Developer</h2>
                        <span class="close-button">&times;</span>
                    </div>
                    <div class="modal-body" style="padding:0;">
                        <img src="images/Abdullah-Al-Rafi-Digital-Card.png" alt="Developer Digital Card" style="width: 100%; height: auto; border-radius: 8px; display: block;" onerror="this.alt='Image not found.'">
                    </div>
                </div>
            </div>
        </template>
        <template id="template-edit-student-modal">
            <div id="editStudentModal" class="modal-overlay">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 id="editStudentModalTitle">Edit Student Information</h2>
                        <span class="close-button">&times;</span>
                    </div>
                    <form id="editStudentForm">
                        <div class="modal-body">
                             <div class="form-group" style="text-align: center;">
                                <img id="editStudentImagePreview" src="images/default_avatar.png" alt="Profile Picture" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 2px solid var(--border-color); margin-bottom: 10px;" onerror="this.src='images/default_avatar.png'">
                            </div>
                            <div class="form-group"><label for="editStudentNameInput">ছাত্রের নাম (আবশ্যক)</label><input type="text" id="editStudentNameInput" required></div>
                            <div class="form-group"><label for="editStudentRollInput">রোল নম্বর</label><input type="text" id="editStudentRollInput"></div>
                            <div class="form-group"><label for="editStudentSchoolInput">স্কুলের নাম</label><input type="text" id="editStudentSchoolInput"></div>
                            <div class="form-group"><label for="editStudentParentContactInput">অভিভাবকের যোগাযোগ নম্বর</label><input type="tel" id="editStudentParentContactInput"></div>
                            <div class="form-group"><label for="editStudentPhotoInput">নতুন ছবি আপলোড করুন (ঐচ্ছিক, সর্বোচ্চ 100KB)</label><input type="file" id="editStudentPhotoInput" accept="image/png, image/jpeg"></div>
                        </div>
                        <div class="modal-footer"><button type="submit" class="action-button btn-add">Save Changes</button></div>
                    </form>
                </div>
            </div>
        </template>

        <footer><div class="developer-info">Developed by: Abdullah Al Rafi<br>BZS26<br>Contact: 01745938158<br>Mail: rafiofficialpc@gmail.com</div></footer>
    </div>


<script>
// ================================================================== //
//            FIREBASE CONFIGURATION AND INITIALIZATION             //
// ================================================================== //
const firebaseConfig = {
    apiKey: "AIzaSyBE0xJ1nvqSj6a9bXtrtrNTDh0bu7PMLnw",
    authDomain: "math-creative-teaching-h-a86fd.firebaseapp.com",
    projectId: "math-creative-teaching-h-a86fd",
    storageBucket: "math-creative-teaching-h-a86fd.appspot.com",
    messagingSenderId: "547365102808",
    appId: "1:547365102808:web:45c46b74ffaaa945dda3ad",
    databaseURL: "https://math-creative-teaching-h-a86fd-default-rtdb.asia-southeast1.firebasedatabase.app"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const credsRef = db.ref('credentials');

// ================================================================== //
//                LOGIN SCRIPT START                                //
// ================================================================== //
document.addEventListener('DOMContentLoaded', () => {
    const REMEMBER_KEY = 'mcth_rem_creds'; 
    const SESSION_KEY = 'mcth_is_logged_in';

    const loginContainer = document.getElementById('login-container');
    const appContainer = document.getElementById('app-container');
    const loginForm = document.getElementById('login-form');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const passwordToggle = document.getElementById('password-toggle');
    const rememberMeCheckbox = document.getElementById('remember-me');
    const errorMsgDiv = document.getElementById('login-error-msg');
    
    if (sessionStorage.getItem(SESSION_KEY) === 'true') {
        loginContainer.style.display = 'none';
        appContainer.classList.remove('hidden');
        firebase.auth().signInAnonymously().then(() => {
            initializeAppLogic();
        }).catch(err => {
            console.error("Anonymous sign-in failed on session restore:", err);
            errorMsgDiv.textContent = 'Authentication session restore failed.';
            loginContainer.style.display = 'flex';
            appContainer.classList.add('hidden');
        });
        return;
    }

    passwordToggle.addEventListener('click', () => {
        const isPassword = passwordInput.type === 'password';
        passwordInput.type = isPassword ? 'text' : 'password';
        passwordToggle.textContent = isPassword ? '🙈' : '👁️';
    });

    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = usernameInput.value;
        const password = passwordInput.value;
        errorMsgDiv.textContent = '';

        try {
            await firebase.auth().signInAnonymously();
            const snapshot = await credsRef.once('value');
            
            let correctCreds;
            if (snapshot.exists()) {
                correctCreds = snapshot.val();
            } else {
                correctCreds = { username: "ashik'smathhome@602", password: "jaleswaritolamath25" };
                await credsRef.set(correctCreds);
            }

            if (username === correctCreds.username && password === correctCreds.password) {
                if (rememberMeCheckbox.checked) {
                    localStorage.setItem(REMEMBER_KEY, JSON.stringify({ user: username, pass: password }));
                } else {
                    localStorage.removeItem(REMEMBER_KEY);
                }
                sessionStorage.setItem(SESSION_KEY, 'true'); 
                
                loginContainer.style.display = 'none';
                appContainer.classList.remove('hidden');
                initializeAppLogic();
            } else {
                errorMsgDiv.textContent = 'ইউজারনেম বা পাসওয়ার্ড সঠিক নয়।';
                firebase.auth().signOut();
            }

        } catch (error) {
            console.error("Firebase login error:", error);
            errorMsgDiv.textContent = 'ডাটাবেস কানেক্ট করা যায়নি বা অনুমতি নেই।';
            if (firebase.auth().currentUser) {
                firebase.auth().signOut();
            }
        }
    });

    const rememberedCreds = localStorage.getItem(REMEMBER_KEY);
    if (rememberedCreds) {
        try {
            const creds = JSON.parse(rememberedCreds);
            usernameInput.value = creds.user;
            passwordInput.value = creds.pass;
            rememberMeCheckbox.checked = true;
        } catch(e) {
            localStorage.removeItem(REMEMBER_KEY);
        }
    }
});

// ======================================================= //
//          MAIN APPLICATION SCRIPT START                  //
// ======================================================= //
function initializeAppLogic() {
    const mainContentArea = document.getElementById('dynamic-content-placeholder');
    const bannerPlaceholder = document.getElementById('banner-area-placeholder');
    const breadcrumbContainer = document.getElementById('breadcrumb-container');
    const btnHome = document.getElementById('btnHome');
    const btnDashboard = document.getElementById('btnDashboard');
    const btnBatch = document.getElementById('btnBatch');
    const btnPayment = document.getElementById('btnPayment');
    const btnStudentDatabase = document.getElementById('btnStudentDatabase');
    const btnReports = document.getElementById('btnReports');
    const btnExam = document.getElementById('btnExam');
    const btnAttendance = document.getElementById('btnAttendance');
    const btnSms = document.getElementById('btnSms');
    const btnToggleMode = document.getElementById('btnToggleMode');
    const currentModeDisplay = document.getElementById('currentModeDisplay');
    const btnPrivacyMenu = document.getElementById('btnPrivacyMenu');
    const privacyDropdown = document.getElementById('privacyDropdown');
    const btnToggleYearBar = document.getElementById('btnToggleYearBar');
    const btnChangePassword = document.getElementById('btnChangePassword');
    const btnForgotPassword = document.getElementById('btnForgotPassword');
    const btnShowHistory = document.getElementById('btnShowHistory');
    const btnRecycleBin = document.getElementById('btnRecycleBin');
    const btnToggleTheme = document.getElementById('btnToggleTheme');
    const btnBackupMenuToggle = document.getElementById('btnBackupMenuToggle');
    const backupSubMenu = document.getElementById('backupSubMenu');
    const btnExportData = document.getElementById('btnExportData');
    const btnImportData = document.getElementById('btnImportData');
    const fileImporter = document.getElementById('fileImporter');
    const btnNavBack = document.getElementById('btnNavBack');
    const btnNavForward = document.getElementById('btnNavForward');
    const btnNavRefresh = document.getElementById('btnNavRefresh');
    const btnLogout = document.getElementById('btnLogout');
    const btnAboutDeveloper = document.getElementById('btnAboutDeveloper');
    let bulkStudentImportInput, btnBulkImport;

    let isAdminMode = sessionStorage.getItem('isAdminMode') === 'true';
    let currentPassword = '';
    let viewedYear = new Date().getFullYear();
    let activeYear = new Date().getFullYear();
    let dbRef;
    const resetDefaultPassword = 'rafi@602';
    const THEME_KEY = 'gonitAppTheme';
    const RECEIPT_LAYOUT_KEY = 'receiptLayoutPreference';
    const YEAR_BAR_HIDDEN_KEY = 'mcth_year_bar_hidden';
    let appData = {};
    let isSaving = false; 
    let dataLoaded = false; 

    let currentStudentContext = null;
    let pageHistory = [];
    let historyIndex = -1;
    const BENGALI_MONTHS=["জানুয়ারি","ফেব্রুয়ারি","মার্চ","এপ্রিল","মে","জুন","জুলাই","আগস্ট","সেপ্টেম্বর","অক্টোবর","নভেম্বর","ডিসেম্বর"];
    
    // UTILITY & HELPER FUNCTIONS
    function handleImageError(imgElement) { if (imgElement.src.includes('default_avatar.png')) return; imgElement.src = 'images/default_avatar.png'; }
    async function uploadStudentImage(file) { if (!file) return null; if (file.size > 100 * 1024) { showToast('ছবির সাইজ 100KB এর বেশি হতে পারবে না।', 'error'); return 'error'; } return new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result); reader.onerror = error => { showToast('ছবি প্রসেস করা সম্ভব হয়নি।', 'error'); reject(error); }; }); }
    function getDbRefForYear(year) { return db.ref(`academicYears/${year}/data`); }
    function paymentIsDue(monthIndex, year) { const now = new Date(); const currentMonthIndex = now.getMonth(); const currentYear = now.getFullYear(); const dueDateThreshold = 10; if (year < currentYear) return true; if (year > currentYear) return false; if (monthIndex < currentMonthIndex) return true; if (monthIndex > currentMonthIndex) return false; return now.getDate() > dueDateThreshold; }
    function isStudentDue(student, year) { if (!student || !student.monthlyPayments) return false; if (student.admissionFee?.status !== 'paid' && student.admissionFee?.amount > 0) return true; const admissionDate = student.createdAt ? new Date(student.createdAt) : new Date(year, 0, 1); for (let i = 0; i < 12; i++) { const monthDate = new Date(year, i, 1); if (monthDate < new Date(admissionDate.getFullYear(), admissionDate.getMonth(), 1)) continue; const monthName = BENGALI_MONTHS[i]; const payment = student.monthlyPayments[monthName]; const defaultFee = student.monthlyFeeDefault || 0; const isMonthCurrentlyDue = paymentIsDue(i, year); if (isMonthCurrentlyDue && ((payment && payment.status !== 'paid' && payment.fee > 0) || (!payment && defaultFee > 0))) { return true; } } return false; }
    function calculateStudentOutstandingAmount(student, year) { let totalDue = 0; if(!student || !student.monthlyPayments) return 0; const admissionDate = student.createdAt ? new Date(student.createdAt) : new Date(year, 0, 1); if (student.admissionFee && student.admissionFee.status !== 'paid' && student.admissionFee.amount > 0) { totalDue += student.admissionFee.amount; } for (let i = 0; i < 12; i++) { const monthDate = new Date(year, i, 1); if (monthDate < new Date(admissionDate.getFullYear(), admissionDate.getMonth(), 1)) continue; const monthName = BENGALI_MONTHS[i]; const payment = student.monthlyPayments[monthName]; const defaultFee = student.monthlyFeeDefault || 0; const isMonthCurrentlyDue = paymentIsDue(i, year); if (isMonthCurrentlyDue) { if (payment && payment.status !== 'paid' && payment.fee > 0) { totalDue += payment.fee; } else if (!payment && defaultFee > 0) { totalDue += defaultFee; } } } return totalDue; }
    function calculateOverdueMonths(student, year) { const overdueMonthsList = []; if(!student || !student.monthlyPayments) return ""; const admissionDate = student.createdAt ? new Date(student.createdAt) : new Date(year, 0, 1); for (let i = 0; i < 12; i++) { const monthDate = new Date(year, i, 1); if (monthDate < new Date(admissionDate.getFullYear(), admissionDate.getMonth(), 1)) continue; const monthName = BENGALI_MONTHS[i]; const payment = student.monthlyPayments[monthName]; const defaultFee = student.monthlyFeeDefault || 0; const isMonthCurrentlyDue = paymentIsDue(i, year); let hasOutstanding = false; if (isMonthCurrentlyDue) { if ((payment && payment.status !== 'paid' && payment.fee > 0) || (!payment && defaultFee > 0)) { hasOutstanding = true; } } if (hasOutstanding) { overdueMonthsList.push(monthName); } } return overdueMonthsList.join(', '); }
    function showToast(message, type = 'info', duration = 3000) { const container = document.getElementById('toast-container'); if (!container) return; const toast = document.createElement('div'); toast.className = `toast ${type}`; toast.textContent = message; container.appendChild(toast); setTimeout(() => toast.classList.add('show'), 10); setTimeout(() => { toast.classList.remove('show'); toast.addEventListener('transitionend', () => toast.remove()); }, duration); }
    function showLoader() { const l = document.getElementById('loader-overlay'); if(l) l.style.display = 'flex'; }
    function hideLoader() { const l = document.getElementById('loader-overlay'); if(l) l.style.display = 'none'; }
    function applyTheme(theme) { const themeIcon = document.getElementById('themeIcon'); document.body.setAttribute('data-theme', theme); if(themeIcon) themeIcon.textContent = theme === 'dark' ? '☀️' : '🌙'; }
    function toggleTheme() { const currentTheme = document.body.getAttribute('data-theme') || 'light'; const newTheme = currentTheme === 'light' ? 'dark' : 'light'; localStorage.setItem(THEME_KEY, newTheme); applyTheme(newTheme); }
    
    // FIREBASE DATA HANDLING
    async function getCombinedDataForAllYears() { const snapshot = await db.ref('academicYears').once('value'); if (!snapshot.exists()) return { students: [], activityLog: [], classes: [] }; const yearsData = snapshot.val(); const yearKeys = Object.keys(yearsData); const promises = yearKeys.map(year => getDbRefForYear(year).once('value')); const yearSnapshots = await Promise.all(promises); const combinedData = { students: [], activityLog: [], classes: [] }; yearSnapshots.forEach((yearSnap, index) => { const year = yearKeys[index]; const data = yearSnap.val(); if (data) { if (data.students) combinedData.students.push(...data.students.map(s => ({ ...s, academicYear: year }))); if (data.activityLog) combinedData.activityLog.push(...data.activityLog.map(log => ({ ...log, academicYear: year }))); if(data.mainClassCategories) combinedData.classes.push(...data.mainClassCategories); } }); combinedData.classes = Array.from(new Map(combinedData.classes.map(item => [item.id, item])).values()); return combinedData; }
    function getInitialDataStructure() { return { currentPassword: 'ashik@602', mainClassCategories: [ { id: 'c_1', name: 'ক্লাস ৬', defaultMonthlyFee: 300, defaultAdmissionFee: 500 }, { id: 'c_2', name: 'ক্লাস ৭', defaultMonthlyFee: 350, defaultAdmissionFee: 500 }, { id: 'c_3', name: 'ক্লাস ৮', defaultMonthlyFee: 400, defaultAdmissionFee: 500 }, { id: 'c_4', name: 'ক্লাস ৯', defaultMonthlyFee: 450, defaultAdmissionFee: 600 }, { id: 'c_5', name: 'ক্লাস ১০', defaultMonthlyFee: 500, defaultAdmissionFee: 600 }, ], students: [], batchSchedule: [ { id: 'd_1', dayName: 'শনিবার', classes: [{ id: 'cs_1', classId: 'c_1', batches: [{ id: 'b_1', time: 'বিকাল ৪:00 - ৫:00', capacity: 50, studentIds: [] }] }] }, { id: 'd_2', dayName: 'রবিবার', classes: [{ id: 'cs_2', classId: 'c_2', batches: [{ id: 'b_2', time: 'বিকাল ৪:00 - ৫:00', capacity: 50, studentIds: [] }] }] }, { id: 'd_3', dayName: 'সোমবার', classes: [{ id: 'cs_3', classId: 'c_3', batches: [{ id: 'b_3', time: 'বিকাল ৪:00 - ৫:00', capacity: 50, studentIds: [] }] }] }, { id: 'd_4', dayName: 'মঙ্গলবার', classes: [{ id: 'cs_4', classId: 'c_4', batches: [{ id: 'b_4', time: 'বিকাল ৫:00 - ৬:00', capacity: 40, studentIds: [] }] }] }, { id: 'd_5', dayName: 'বুধবার', classes: [{ id: 'cs_5', classId: 'c_5', batches: [{ id: 'b_5', time: 'বিকাল ৫:00 - ৬:00', capacity: 40, studentIds: [] }] }] } ], nextRollNumber: 1, activityLog: [], recycleBin: { students: [], mainClassCategories: [], batchSchedule: [] } }; }
    async function saveAppData() { if (!appData || !dataLoaded || isSaving) return; isSaving = true; try { appData.currentPassword = currentPassword; await dbRef.set(appData); } catch (e) { console.error("Error saving data:", e); showToast("ডেটা সংরক্ষণ করতে সমস্যা হয়েছে!", 'error'); } finally { isSaving = false; } }
    function loadAppData(yearToLoad) { showLoader(); viewedYear = yearToLoad; localStorage.setItem('mcth_viewed_year', viewedYear); dbRef = getDbRefForYear(yearToLoad); if (dbRef.off) dbRef.off(); dbRef.on('value', (snapshot) => { if (isSaving) return; if (snapshot.exists()) { appData = snapshot.val(); appData.students = appData.students || []; appData.mainClassCategories = appData.mainClassCategories || []; appData.batchSchedule = appData.batchSchedule || []; appData.recycleBin = appData.recycleBin || { students: [], mainClassCategories: [], batchSchedule: [] }; appData.activityLog = Array.isArray(appData.activityLog) ? appData.activityLog : []; (appData.students || []).forEach(s => { if (s) { s.createdAt = s.createdAt || new Date(yearToLoad, 0, 1).toISOString(); s.monthlyPayments = s.monthlyPayments || {}; s.admissionFee = s.admissionFee || { amount: 0, status: 'due' }; } }); currentPassword = appData.currentPassword || 'ashik@602'; } else { appData = getInitialDataStructure(); currentPassword = appData.currentPassword; dbRef.set(appData); return; } updateYearSelectorUI(); if (!dataLoaded) { dataLoaded = true; const sessionState = sessionStorage.getItem('mcth_session_state'); if (sessionState) { try { const { page, context } = JSON.parse(sessionState); pageHistory = [{ page, context }]; historyIndex = 0; if(window[page]) { loadPage(window[page], context, true); } else { loadPage(showHomePage, {}); } } catch (e) { loadPage(showHomePage, {}); } } else { loadPage(showHomePage, {}); } } else { const currentState = pageHistory[historyIndex]; if (currentState && window[currentState.page]) { loadPage(window[currentState.page], currentState.context, true); } } if(dataLoaded) hideLoader(); }, (error) => { console.error("Firebase read failed:", error); showToast("ডাটাবেস কানেক্ট করা যায়নি।", "error"); hideLoader(); }); }
    function generateNextRollNumber(){ const roll = appData.nextRollNumber || 1; appData.nextRollNumber = roll + 1; return String(roll).padStart(2, '0'); }
    function generateToken() { return `MCTH-${Math.random().toString(36).substring(2, 7).toUpperCase()}`; }
    function logActivity(message, details = {}) { if (!appData.activityLog) appData.activityLog = []; appData.activityLog.unshift({ timestamp: new Date().toISOString(), message, ...details }); if (appData.activityLog.length > 200) appData.activityLog.pop(); }
    function handleExport(){ if (!appData) { showToast('কোনো ডেটা এক্সপোর্ট করার জন্য পাওয়া যায়নি।', 'error'); return; } try { const dataStr = JSON.stringify(appData, null, 2); const dataBlob = new Blob([dataStr], { type: 'application/json' }); const url = URL.createObjectURL(dataBlob); const link = document.createElement('a'); link.href = url; link.download = `gonit_creative_backup_${viewedYear}_${new Date().toISOString().split('T')[0]}.json`; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url); showToast(`শিক্ষাবর্ষ ${viewedYear} এর ডেটা এক্সপোর্ট করা হয়েছে।`, 'success'); } catch (e) { showToast('ডেটা এক্সপোর্ট করার সময় একটি সমস্যা হয়েছে।', 'error'); } }
    function handleImport(event){ const file = event.target.files[0]; if (!file) return; if (!confirm(`আপনি কি নিশ্চিত যে বর্তমান শিক্ষাবর্ষ (${viewedYear}) এর সমস্ত ডেটা মুছে ফেলে ফাইল থেকে নতুন ডেটা লোড করতে চান? এই কাজটি আর ফেরানো যাবে না।`)) { event.target.value = ''; return; } const reader = new FileReader(); reader.onload = (e) => { try { const importedData = JSON.parse(e.target.result); if (importedData && typeof importedData.currentPassword === 'string' && Array.isArray(importedData.students)) { showLoader(); appData = importedData; dbRef.set(appData).then(() => { showToast(`শিক্ষাবর্ষ ${viewedYear} এ ডেটা সফলভাবে ইম্পোর্ট ও সিঙ্ক করা হয়েছে।`, 'success'); hideLoader(); }); } else { showToast('ফাইলের ডেটা সঠিক ফরম্যাটে নেই।', 'error'); } } catch (error) { showToast('ফাইলটি পড়তে সমস্যা হয়েছে।', 'error'); } finally { event.target.value = ''; } }; reader.readAsText(file); }
    function findStudentById(studentId){ return (appData.students || []).find(s => s && s.id === studentId) || null; }
    function findClassById(classId){ return (appData.mainClassCategories || []).find(c => c && c.id === classId) || null; }
    function findBatchById(batchId){ if (!appData.batchSchedule) return null; for(const day of appData.batchSchedule){ if(!day || day.deletedAt || !day.classes) continue; for(const cls of day.classes){ if(!cls || cls.deletedAt || !cls.batches) continue; const batch = cls.batches.find(b => b && b.id === batchId); if(batch) return {batch, classSchedule: cls, day}; } } return null; }
    function findBatchesForStudent(studentId){ const foundBatches = []; if (!appData.batchSchedule) return foundBatches; appData.batchSchedule.forEach(day => { if(!day || day.deletedAt || !day.classes) return; day.classes.forEach(classSchedule => { if(!classSchedule || classSchedule.deletedAt || !classSchedule.batches) return; classSchedule.batches.forEach(batch => { if(batch && batch.studentIds && batch.studentIds.includes(studentId)){ const classInfo = findClassById(classSchedule.classId); foundBatches.push({ id: batch.id, day: day.dayName, className: classInfo?.name || 'Unknown', time: batch.time, classId: classSchedule.classId }); } }); }); }); return foundBatches; }
    function updateAdminModeUI(){ document.body.classList.toggle('admin-mode-active', isAdminMode); currentModeDisplay.textContent = isAdminMode ? 'Admin' : 'Assistant'; currentModeDisplay.classList.toggle('admin-active', isAdminMode); currentModeDisplay.classList.toggle('assistant-active', !isAdminMode); btnToggleMode.textContent = isAdminMode ? 'Exit' : 'Admin'; document.querySelectorAll('.admin-only').forEach(el => el.classList.toggle('hidden', !isAdminMode)); document.querySelectorAll('.assistant-disabled').forEach(el => { el.disabled = !isAdminMode; }); sessionStorage.setItem('isAdminMode', isAdminMode); }
    function loadPage(pageFunction, context = {}, isNavigating = false) { if (!isNavigating) { const state = { page: pageFunction.name, context }; if (historyIndex < pageHistory.length - 1) pageHistory = pageHistory.slice(0, historyIndex + 1); pageHistory.push(state); historyIndex = pageHistory.length - 1; } sessionStorage.setItem('mcth_session_state', JSON.stringify({ page: pageFunction.name, context })); breadcrumbContainer.innerHTML = ''; if (context.breadcrumbs) { context.breadcrumbs.forEach((crumb, index) => { const crumbElement = document.createElement(index < context.breadcrumbs.length - 1 ? 'a' : 'span'); crumbElement.textContent = crumb.text; if (crumbElement.tagName === 'A') { crumbElement.href = '#'; crumbElement.onclick = (e) => { e.preventDefault(); const pageFn = window[crumb.pageFn.name]; if(pageFn) loadPage(pageFn, crumb.context || {}); }; } breadcrumbContainer.appendChild(crumbElement); if (index < context.breadcrumbs.length - 1) breadcrumbContainer.append(' / '); }); } mainContentArea.innerHTML = ''; bannerPlaceholder.style.display = 'none'; try { if (typeof pageFunction === 'function') pageFunction(context); else mainContentArea.innerHTML = `<p style="color:red; text-align:center;">Error: Page function not found.</p>`; } catch (e) { console.error("Error loading page:", pageFunction.name, e, "Context:", context); mainContentArea.innerHTML = `<p style="color:red; text-align:center;">Error loading page. Check console.</p>`; } updateAdminModeUI(); updateNavButtons(); }
    function updateNavButtons() { const backIcon = document.querySelector('#btnNavBack .nav-icon-svg'); const forwardIcon = document.querySelector('#btnNavForward .nav-icon-svg'); if(backIcon) backIcon.classList.toggle('disabled', historyIndex <= 0); if(forwardIcon) forwardIcon.classList.toggle('disabled', historyIndex >= pageHistory.length - 1); }
    function cloneTemplate(templateId){ return document.getElementById(templateId)?.content.cloneNode(true); }
    function closeDropdownAndRun(action){ privacyDropdown.classList.remove('active'); backupSubMenu.classList.remove('open'); btnBackupMenuToggle.classList.remove('open'); if(action) action(); }
    
    let sliderInterval; function showHomePage(context = {}) { context.breadcrumbs = [{ text: 'হোম', pageFn: showHomePage }]; bannerPlaceholder.innerHTML = '<img src="images/image1.png" alt="Main Banner" onerror="this.style.display=\'none\';">'; bannerPlaceholder.style.display = 'block'; mainContentArea.appendChild(cloneTemplate('template-home')); const slider = document.getElementById('homeImageSlider'); let currentImage = 3; if(sliderInterval) clearInterval(sliderInterval); if(slider) { sliderInterval = setInterval(() => { slider.style.opacity = 0; setTimeout(() => { currentImage = currentImage === 3 ? 4 : 3; slider.src = `images/image${currentImage}.png`; slider.style.opacity = 1; }, 1000); }, 4000); } }
    async function showDashboardPage(context = {}) { context.breadcrumbs = [{ text: 'হোম', pageFn: showHomePage }, { text: 'ড্যাশবোর্ড' }]; mainContentArea.appendChild(cloneTemplate('template-dashboard')); const grid = document.querySelector('.dashboard-grid'); if (!grid) return; grid.innerHTML = "<p>ড্যাশবোর্ডের তথ্য লোড হচ্ছে...</p>"; try { const totalStudentsThisYear = (appData.students || []).filter(s => s && !s.deletedAt).length; const activeBatchesThisYear = (appData.batchSchedule || []).flatMap(day => (day.classes || [])).filter(cls => !cls.deletedAt).flatMap(cls => (cls.batches || [])).filter(batch => !batch.deletedAt).length; const combinedData = await getCombinedDataForAllYears(); const allStudents = combinedData.students; let totalOutstandingAmountOverall = 0; let totalStudentsWithAnyDues = 0; let studentsWithDuesForDetails = []; let currentMonthIncome = 0; let currentMonthIncomeDetails = []; const now = new Date(); const currentMonthIndex = now.getMonth(); const currentBengaliMonth = BENGALI_MONTHS[currentMonthIndex]; const allClassCategories = combinedData.classes; const yearsSnapshot = await db.ref('academicYears').once('value'); (allStudents || []).forEach(student => { if (!student || student.deletedAt) return; const studentYear = parseInt(student.academicYear); const studentDueAmount = calculateStudentOutstandingAmount(student, studentYear); const classInfo = allClassCategories.find(c => c.id === student.classId); let batchInfoString = 'N/A'; const yearData = (yearsSnapshot.val() || {})[student.academicYear]?.data; if(yearData && yearData.batchSchedule){ const studentBatches = []; yearData.batchSchedule.forEach(day => { (day.classes || []).forEach(cls => { (cls.batches || []).forEach(batch => { if((batch.studentIds || []).includes(student.id)){ studentBatches.push(`${day.dayName.substring(0,3)} (${batch.time})`); } }); }); }); if(studentBatches.length > 0) batchInfoString = studentBatches.join(', '); } if (studentDueAmount > 0) { totalStudentsWithAnyDues++; totalOutstandingAmountOverall += studentDueAmount; studentsWithDuesForDetails.push({ id: student.id, name: student.name, roll: student.roll, classId: student.classId, class: classInfo?.name || 'N/A', totalDueAmount: studentDueAmount, overdueMonths: calculateOverdueMonths(student, studentYear), academicYear: student.academicYear, batchInfo: batchInfoString }); } if (student.admissionFee?.status === 'paid' && student.admissionFee.date) { const admissionDate = new Date(student.admissionFee.date); if (admissionDate.getMonth() === currentMonthIndex && admissionDate.getFullYear() === now.getFullYear()) { currentMonthIncome += (student.admissionFee.amount || 0); currentMonthIncomeDetails.push({ studentId: student.id, name: student.name, roll: student.roll, classId: student.classId, class: classInfo?.name || 'N/A', amount: student.admissionFee.amount, type: 'ভর্তি ফি', academicYear: student.academicYear, batchInfo: batchInfoString }); } } const payment = (student.monthlyPayments || {})[currentBengaliMonth]; if (payment && payment.status === 'paid' && payment.date) { const paymentDate = new Date(payment.date); if (paymentDate.getMonth() === currentMonthIndex && paymentDate.getFullYear() === now.getFullYear()) { currentMonthIncome += (payment.fee || 0); currentMonthIncomeDetails.push({ studentId: student.id, name: student.name, roll: student.roll, classId: student.classId, class: classInfo?.name || 'N/A', amount: payment.fee, type: `মাসিক ফি (${currentBengaliMonth})`, academicYear: student.academicYear, batchInfo: batchInfoString }); } } }); const paidStudentsCount = allStudents.filter(s => s && !s.deletedAt).length - totalStudentsWithAnyDues; grid.innerHTML = `<div class="dashboard-card card-students" title="শুধুমাত্র ${viewedYear} শিক্ষাবর্ষের ছাত্র-ছাত্রী"><h4>মোট ছাত্র (${viewedYear})</h4><p class="stat-number">${totalStudentsThisYear.toLocaleString('bn-BD')}</p></div><div class="dashboard-card card-batches" title="শুধুমাত্র ${viewedYear} শিক্ষাবর্ষের ব্যাচ"><h4>সক্রিয় ব্যাচ (${viewedYear})</h4><p class="stat-number">${activeBatchesThisYear.toLocaleString('bn-BD')}</p></div><div class="dashboard-card card-collection" title="সকল শিক্ষাবর্ষ মিলিয়ে"><h4>চলতি মাসের আয়</h4><p class="stat-number">${currentMonthIncome.toLocaleString('bn-BD')} ৳</p><button class="details-button" data-type="collection">বিস্তারিত</button></div><div class="dashboard-card card-due" title="সকল শিক্ষাবর্ষ মিলিয়ে"><h4>মোট বকেয়া</h4><p class="stat-number">${totalOutstandingAmountOverall.toLocaleString('bn-BD')} ৳</p><button class="details-button" data-type="due">বিস্তারিত</button></div><div class="dashboard-card card-paid-students" title="সকল শিক্ষাবর্ষ মিলিয়ে"><h4>পরিশোধকৃত ছাত্র</h4><p class="stat-number">${paidStudentsCount.toLocaleString('bn-BD')}</p></div><div class="dashboard-card card-due-students" title="সকল শিক্ষাবর্ষ মিলিয়ে"><h4>বকেয়া থাকা ছাত্র</h4><p class="stat-number">${totalStudentsWithAnyDues.toLocaleString('bn-BD')}</p></div>`; grid.addEventListener('click', (e) => { if (e.target.classList.contains('details-button')) { const type = e.target.dataset.type; const dataToShow = type === 'due' ? studentsWithDuesForDetails : currentMonthIncomeDetails; loadPage(showDashboardDetailsPage, { type, breadcrumbs: [...context.breadcrumbs, { text: 'বিস্তারিত তালিকা' }], detailedData: dataToShow }); } }); } catch(err) { console.error("Error loading dashboard data:", err); grid.innerHTML = "<p style='color:red;'>ড্যাশবোর্ডের তথ্য লোড করা যায়নি।</p>"; } }
    function showDashboardDetailsPage({ type, breadcrumbs, detailedData }) { mainContentArea.appendChild(cloneTemplate('template-dashboard-details-page')); const now = new Date(); const currentBengaliMonth = BENGALI_MONTHS[now.getMonth()]; let pageTitle = type === 'collection' ? `চলতি মাসের (${currentBengaliMonth}) পরিশোধিত তালিকা` : `সকল বকেয়ার তালিকা`; document.getElementById('detailsListPageTitle').textContent = pageTitle; const classFilter = document.getElementById('detailsPageClassFilter'); const batchFilter = document.getElementById('detailsPageBatchFilter'); const tableBody = document.getElementById('detailsPageTableBody'); const summaryDiv = document.getElementById('detailsPageSummary'); function renderTable(dataToRender) { tableBody.innerHTML = ''; if (!dataToRender || dataToRender.length === 0) { tableBody.innerHTML = `<tr><td colspan="7" style="text-align: center;">কোনো তথ্য খুঁজে পাওয়া যায়নি।</td></tr>`; summaryDiv.textContent = ''; return; } let totalAmount = 0; let studentCountSet = new Set(); dataToRender.sort((a, b) => (parseInt(a.roll, 10) || 0) - (parseInt(b.roll, 10) || 0)); dataToRender.forEach((s, index) => { const tr = document.createElement('tr'); const yearLabel = parseInt(s.academicYear) !== viewedYear ? ` (${s.academicYear})` : ''; let rowHtml = `<td class="serial-number-column">${index + 1}.</td><td><strong>${s.name}${yearLabel}</strong></td><td><strong>${s.roll}</strong></td><td><strong>${s.class || 'N/A'}</strong></td><td>${s.batchInfo || 'N/A'}</td>`; if (type === 'collection') { rowHtml += `<td>${s.type}</td><td style="text-align:right; padding-right:15px;">${(s.amount || 0).toLocaleString('bn-BD')}</td>`; totalAmount += (s.amount || 0); } else { rowHtml += `<td><strong>${s.totalDueAmount ? s.totalDueAmount.toLocaleString('bn-BD') : 'N/A'}</strong></td><td title="${s.overdueMonths}">${s.overdueMonths ? s.overdueMonths.split(', ').slice(0, 2).join(', ') + (s.overdueMonths.split(', ').length > 2 ? '...' : '') : 'N/A'}</td>`; totalAmount += s.totalDueAmount; studentCountSet.add(s.id); } tr.innerHTML = rowHtml; tableBody.appendChild(tr); }); summaryDiv.innerHTML = type === 'due' ? `মোট ছাত্র: ${studentCountSet.size} জন | মোট পরিমাণ: ${totalAmount.toLocaleString('bn-BD')} টাকা` : `মোট কালেকশন: ${totalAmount.toLocaleString('bn-BD')} টাকা`; } function populateBatchFilter(selectedClassId) { batchFilter.innerHTML = '<option value="">সব ব্যাচ</option>'; batchFilter.disabled = true; if (!selectedClassId) return; const studentsInClass = detailedData.filter(s => s.classId === selectedClassId); const batches = new Set(); studentsInClass.forEach(s => { if (s.batchInfo && s.batchInfo !== 'N/A') s.batchInfo.split(', ').forEach(b => batches.add(b.trim()))}); batches.forEach(batchName => { const option = document.createElement('option'); option.value = batchName; option.textContent = batchName; batchFilter.appendChild(option); }); if (batches.size > 0) batchFilter.disabled = false; } function populateClassFilter() { classFilter.innerHTML = '<option value="">সব ক্লাস</option>'; const classes = new Map(); detailedData.forEach(s => { if (!classes.has(s.classId)) classes.set(s.classId, s.class); }); classes.forEach((name, id) => { const option = document.createElement('option'); option.value = id; option.textContent = name; classFilter.appendChild(option); }); } function applyFiltersAndRender() { let filteredData = [...detailedData]; const selectedClassId = classFilter.value; const selectedBatch = batchFilter.value; if (selectedClassId) filteredData = filteredData.filter(s => s.classId === selectedClassId); if (selectedBatch) filteredData = filteredData.filter(s => s.batchInfo && s.batchInfo.includes(selectedBatch)); renderTable(filteredData); } classFilter.addEventListener('change', () => { populateBatchFilter(classFilter.value); applyFiltersAndRender(); }); batchFilter.addEventListener('change', applyFiltersAndRender); document.getElementById('headerCol6').textContent = type === 'collection' ? 'পেমেন্টের ধরণ' : 'মোট বকেয়া (টাকা)'; document.getElementById('headerCol7').textContent = type === 'collection' ? 'পরিশোধিত টাকা' : 'বকেয়া মাসসমূহ'; document.getElementById('paymentTypeFilter').style.display = 'none'; document.getElementById('btnPrintDetailsList').onclick = () => { document.getElementById('printHeaderTitle').textContent = "গণিত ক্রিয়েটিভ টিচিং হোম"; document.getElementById('printHeaderSubtitle').textContent = pageTitle; const classText = classFilter.options[classFilter.selectedIndex].text; const batchText = batchFilter.options[batchFilter.selectedIndex].text; let filterInfo = `ফিল্টার: ${classText}`; if (batchFilter.value) filterInfo += `, ${batchText}`; document.getElementById('printHeaderFilters').textContent = filterInfo; window.print(); }; document.getElementById('btnBackToDashboard').onclick = () => loadPage(showDashboardPage); populateClassFilter(); populateBatchFilter(''); renderTable(detailedData); }
    function showStudentDatabasePage(context = {}) { context.breadcrumbs = [{ text: 'হোম', pageFn: showHomePage }, { text: 'ছাত্র ডেটাবেস' }]; mainContentArea.appendChild(cloneTemplate('template-student-database')); const searchInput = document.getElementById('studentDatabaseSearchInput'); const contactInput = document.getElementById('studentDatabaseContactInput'); const resultsContainer = document.getElementById('student-search-results'); const performSearch = () => { const searchTerm = searchInput.value.toLowerCase().trim(); const contactTerm = contactInput.value.toLowerCase().trim(); resultsContainer.innerHTML = ''; if (searchTerm.length < 1 && contactTerm.length < 1) { resultsContainer.innerHTML = `<p style='text-align: center; color: var(--text-secondary);'>অনুসন্ধানের জন্য নাম, রোল বা যোগাযোগ নম্বর লিখুন।</p>`; return; } const filteredStudents = (appData.students || []).filter(s => { if (!s || s.deletedAt) return false; const nameRollMatch = !searchTerm || s.name.toLowerCase().includes(searchTerm) || s.roll.includes(searchTerm); const contactMatch = !contactTerm || (s.parentContact && s.parentContact.toLowerCase().includes(contactTerm)); return nameRollMatch && contactMatch; }).sort((a, b) => (parseInt(a.roll, 10) || 0) - (parseInt(b.roll, 10) || 0)); if (filteredStudents.length === 0) { resultsContainer.innerHTML = `<p style='text-align: center; color: var(--text-secondary);'>কোনো ছাত্র খুঁজে পাওয়া যায়নি।</p>`; return; } filteredStudents.forEach((student, index) => { const classInfo = findClassById(student.classId); const resultItem = document.createElement('div'); resultItem.style.cssText = "padding: 10px; border: 1px solid var(--border-color); margin-bottom: 5px; cursor: pointer; display: grid; grid-template-columns: auto 1fr auto; align-items: center; gap: 15px;"; resultItem.innerHTML = `<div>${index + 1}. <strong style="font-size: 1.1em;">${student.name}</strong></div> <div><small>রোল: ${student.roll}</small></div> <div><small>${classInfo?.name || 'N/A'}</small></div>`; resultItem.onclick = () => loadPage(showStudentProfilePage, { studentId: student.id }); resultsContainer.appendChild(resultItem); }); }; searchInput.addEventListener('input', performSearch); contactInput.addEventListener('input', performSearch); performSearch(); }
    function showStudentProfilePage(context) { const student = findStudentById(context.studentId); if (!student) { loadPage(showStudentDatabasePage); return; } context.breadcrumbs = [ { text: 'হোম', pageFn: showHomePage }, { text: 'ছাত্র ডেটাবেস', pageFn: showStudentDatabasePage }, { text: student.name } ]; mainContentArea.appendChild(cloneTemplate('template-student-profile')); document.getElementById('profileNameHeader').textContent = student.name; document.getElementById('profileRoll').textContent = student.roll; document.getElementById('profileClass').textContent = findClassById(student.classId)?.name || 'N/A'; document.getElementById('profileSchool').textContent = student.schoolName || 'N/A'; document.getElementById('profileParentContact').textContent = student.parentContact || 'N/A'; document.getElementById('profileAdmissionDate').textContent = student.createdAt ? new Date(student.createdAt).toLocaleString('bn-BD', { day: 'numeric', month: 'long', year: 'numeric' }) : 'N/A'; const batchesContainer = document.getElementById('student-profile-batches'); const studentBatches = findBatchesForStudent(student.id); if (studentBatches.length > 0) { const ul = document.createElement('ul'); ul.style.cssText="list-style:none; padding:0;"; studentBatches.forEach(batchInfo => { const li = document.createElement('li'); li.style.cssText="background-color: var(--bg-hover); padding: 8px; border-radius: 4px; margin-bottom: 5px;"; li.textContent = `${batchInfo.day} (${batchInfo.time})`; ul.appendChild(li); }); batchesContainer.appendChild(ul); } else { batchesContainer.innerHTML = `<p style="color:var(--due-text);">কোনো ব্যাচে নেই।</p>`; } const profilePhoto = document.getElementById('profilePagePhoto'); if(profilePhoto) { if(student.photoURL) { profilePhoto.src = student.photoURL; } profilePhoto.onerror = () => handleImageError(profilePhoto); } document.getElementById('btnGoToPaymentSection').onclick = () => { currentStudentContext = {...currentStudentContext, studentId: student.id, cameFrom: 'studentProfile', classId: student.classId }; loadPage(showStudentPaymentDetailsPage, {studentId: student.id, classId: student.classId}); }; document.getElementById('btnBackToDatabase').onclick = () => loadPage(showStudentDatabasePage); document.getElementById('btnEditStudentProfile')?.addEventListener('click', () => { showEditStudentModal(student.id); }); }
    async function showAddStudentModal(batchId, classId, onSuccess) { const modalFragment = cloneTemplate('template-add-student-modal'); const modal = modalFragment.querySelector('#addStudentModal'); document.body.appendChild(modal); const form = modal.querySelector('#addStudentForm'); const closeBtn = modal.querySelector('.close-button'); const photoInput = modal.querySelector('#studentPhotoInput'); const closeModal = () => modal.remove(); closeBtn.onclick = closeModal; modal.onclick = (e) => { if (e.target === modal) closeModal(); }; form.onsubmit = async (e) => { e.preventDefault(); const submitButton = form.querySelector('button[type="submit"]'); submitButton.disabled = true; showLoader(); try { const name = modal.querySelector('#studentNameInput').value.trim(); if (!name) { showToast("ছাত্রের নাম আবশ্যক।", 'error'); return; } const studentId = `s_${Date.now()}`; let uploadedPhotoURL = null; const file = photoInput.files[0]; if (file) { const result = await uploadStudentImage(file); if (result === 'error') return; uploadedPhotoURL = result; } const schoolName = modal.querySelector('#studentSchoolInput').value.trim(); const parentContact = modal.querySelector('#parentContactInput').value.trim(); const classInfo = findClassById(classId); const defaultMonthly = classInfo?.defaultMonthlyFee || 0; const defaultAdmission = classInfo?.defaultAdmissionFee || 0; const newRoll = generateNextRollNumber(); const newStudent = { id: studentId, name, roll: newRoll, classId, parentContact: parentContact || 'N/A', schoolName: schoolName || 'N/A', createdAt: new Date().toISOString(), admissionFee: { amount: defaultAdmission, status: 'due' }, monthlyFeeDefault: defaultMonthly, monthlyPayments: {}, photoURL: uploadedPhotoURL }; if (!appData.students) appData.students = []; appData.students.push(newStudent); logActivity('New student added', { studentName: name, roll: newRoll, class: classInfo.name }); const batchInfo = findBatchById(batchId); if (batchInfo && batchInfo.batch) { if (!batchInfo.batch.studentIds) batchInfo.batch.studentIds = []; batchInfo.batch.studentIds.push(newStudent.id); } await saveAppData(); showToast(`শিক্ষার্থী '${name}' যোগ করা হয়েছে। তার রোল নম্বর: ${newRoll}`, 'success'); closeModal(); if (onSuccess) onSuccess(); } catch (error) { showToast("ছাত্র যোগ করার সময় একটি সমস্যা হয়েছে।", "error"); } finally { hideLoader(); submitButton.disabled = false; } }; modal.classList.add('visible'); }
    function showBatchPage(context = {}){ context.breadcrumbs = [{ text: 'হোম', pageFn: showHomePage }, { text: 'ব্যাচ ম্যানেজমেন্ট' }]; mainContentArea.appendChild(cloneTemplate('template-batch')); renderBatchDayTabs(); const firstDay = (appData.batchSchedule || []).find(d => !d.deletedAt); if(firstDay){ document.querySelector(`.tab-button[data-day-id="${firstDay.id}"]`)?.click(); } }
    function renderBatchDayTabs(){ const container = document.getElementById('batch-day-tabs'); if (!container) return; container.innerHTML = ''; (appData.batchSchedule || []).forEach(day => { if (day.deletedAt) return; const tab = document.createElement('button'); tab.className = 'tab-button'; tab.dataset.dayId = day.id; tab.innerHTML = ` <span>${day.dayName}</span> <span class="student-action-icons admin-only hidden"> <span class="student-edit-icon" title="Rename Day">✏️</span> <span class="student-delete-icon" title="Delete Day">🗑️</span> </span> `; tab.querySelector('.student-edit-icon')?.addEventListener('click',(e) => { e.stopPropagation(); if (!isAdminMode) return; const newDayName = prompt('নতুন নাম দিন:', day.dayName); if (newDayName && newDayName.trim()) { day.dayName = newDayName.trim(); saveAppData(); } }); tab.querySelector('.student-delete-icon')?.addEventListener('click',(e) => { e.stopPropagation(); if (!isAdminMode) return; if (confirm(`'${day.dayName}' দিনটি এবং এর অন্তর্গত সকল ব্যাচ রিসাইকেল বিনে পাঠাতে চান?`)) { const dayToMove = (appData.batchSchedule || []).find(d => d.id === day.id); if(dayToMove) dayToMove.deletedAt = new Date().toISOString(); saveAppData(); showToast(`'${day.dayName}' রিসাইকেল বিনে পাঠানো হয়েছে।`, 'info'); } }); tab.addEventListener('click',(e) => { if(e.target.closest('.student-action-icons')) return; container.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active')); tab.classList.add('active'); renderBatchClassSubTabs(day.id); }); container.appendChild(tab); }); const addBtn = document.createElement('button'); addBtn.className = 'tab-button admin-only hidden'; addBtn.textContent = '+ দিন'; addBtn.onclick = () => { if (!isAdminMode) return; const dayName = prompt('নতুন দিনের নাম দিন (যেমন: শনিবার):'); if (dayName && dayName.trim()) { const newDay = {id: `d_${Date.now()}`, dayName: dayName.trim(), classes: []}; if(!appData.batchSchedule) appData.batchSchedule = []; appData.batchSchedule.push(newDay); saveAppData(); } }; container.appendChild(addBtn); updateAdminModeUI(); }
    function renderBatchClassSubTabs(dayId){ const day = (appData.batchSchedule || []).find(d => d.id === dayId); const container = document.getElementById('batch-class-subtabs-container'); if (!container || !day) { if (container) container.innerHTML = ''; return; } container.innerHTML = ` <div class="tab-container" id="sub-tabs-for-${dayId}"></div> <div id="batch-list-container"></div> `; const subTabContainer = container.querySelector(`#sub-tabs-for-${dayId}`); if(!day.classes) day.classes = []; (day.classes || []).filter(c=>!c.deletedAt).forEach(cls => { const classInfo = findClassById(cls.classId); if (!classInfo) return; const tab = document.createElement('button'); tab.className = 'tab-button'; tab.dataset.classScheduleId = cls.id; tab.innerHTML = ` <span>${classInfo.name}</span> <span class="student-action-icons admin-only hidden"> <span class="student-delete-icon" title="Remove Class from this Day">❌</span> </span> `; tab.querySelector('.student-delete-icon').addEventListener('click',e => { e.stopPropagation(); if (!isAdminMode) return; if (confirm(`আপনি কি '${day.dayName}' থেকে '${classInfo.name}' এর সকল ব্যাচ মুছে ফেলতে চান?`)) { const clsToMove = day.classes.find(c=>c.id === cls.id); if(clsToMove) clsToMove.deletedAt = new Date().toISOString(); saveAppData(); } }); tab.addEventListener('click',(e) => { if(e.target.closest('.student-action-icons')) return; subTabContainer.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active')); tab.classList.add('active'); renderBatchList(dayId, cls.id); }); subTabContainer.appendChild(tab); }); const addClassBtn = document.createElement('button'); addClassBtn.className = 'tab-button admin-only hidden'; addClassBtn.textContent = '+ ক্লাস'; addClassBtn.onclick = () => { if (!isAdminMode) return; const className = prompt('ক্লাসের নাম দিন:'); if (!className || !className.trim()) return; let classInfo = (appData.mainClassCategories || []).find(c => c.name.toLowerCase() === className.trim().toLowerCase()); if (!classInfo) { if (confirm(`'${className}' নামের কোনো ক্লাস নেই। আপনি কি এটি তৈরি করতে চান?`)) { classInfo = { id: `c_${Date.now()}`, name: className.trim(), defaultMonthlyFee: 0, defaultAdmissionFee: 0 }; if(!appData.mainClassCategories) appData.mainClassCategories = []; appData.mainClassCategories.push(classInfo); } else { return; } } if ((day.classes || []).find(cs => cs.classId === classInfo.id && !cs.deletedAt)) { showToast('এই ক্লাসটি এই দিনে ইতিমধ্যে যোগ করা আছে।', 'error'); return; } day.classes.push({ id: `cs_${Date.now()}`, classId: classInfo.id, batches: [] }); saveAppData(); }; subTabContainer.appendChild(addClassBtn); const firstClass = (day.classes || []).find(cs => !cs.deletedAt); if(firstClass){ subTabContainer.querySelector('.tab-button[data-class-schedule-id]')?.click(); } else { const batchListContainer = document.getElementById('batch-list-container'); if(batchListContainer) batchListContainer.innerHTML = ''; } updateAdminModeUI(); }
    function renderBatchList(dayId, classScheduleId){ const day = (appData.batchSchedule || []).find(d => d.id === dayId); const classSchedule = day?.classes?.find(cs => cs.id === classScheduleId); const container = document.getElementById('batch-list-container'); if (!container || !classSchedule) { if (container) container.innerHTML = ''; return; } container.innerHTML = ` <div class="batch-grid"></div> <button class="action-button btn-add admin-only hidden" id="addNewBatchBtn">+ নতুন ব্যাচ যোগ করুন</button> `; const grid = container.querySelector('.batch-grid'); grid.innerHTML = ''; if(!classSchedule.batches) classSchedule.batches = []; (classSchedule.batches || []).filter(b=>!b.deletedAt).forEach(batch => { const card = document.createElement('div'); card.className = 'batch-card'; const presentStudents = batch.studentIds?.length || 0; const vacant = batch.capacity - presentStudents; card.innerHTML = ` <div class="batch-card-header"> <span class="batch-time">${batch.time}</span> <div class="student-action-icons admin-only hidden"> <span class="student-edit-icon" title="Edit Batch Time">✏️</span> <span class="student-delete-icon" title="Delete Batch">🗑️</span> </div> </div> <div class="batch-card-body"> <table> <tr><th>মোট ধারণক্ষমতা</th><td>${batch.capacity}</td></tr> <tr><th>বর্তমান ছাত্র</th><td>${presentStudents}</td></tr> <tr><th>খালি সিট</th><td>${vacant > 0 ? vacant : 0}</td></tr> </table> <button class="action-button admin-only hidden">ধারণক্ষমতা পরিবর্তন</button> </div> `; card.querySelector('.batch-time').onclick = () => loadPage(showBatchDetailsPage, { batchId: batch.id }); card.querySelector('.student-edit-icon').onclick = (e) => { e.stopPropagation(); if (!isAdminMode) return; const newTime = prompt("ব্যাচের নতুন সময় দিন:", batch.time); if (newTime && newTime.trim()) { batch.time = newTime.trim(); saveAppData(); } }; card.querySelector('.student-delete-icon').onclick = (e) => { e.stopPropagation(); if (!isAdminMode) return; if (confirm(`আপনি কি '${batch.time}' ব্যাচটি রিসাইকেল বিনে পাঠাতে চান?`)) { batch.deletedAt = new Date().toISOString(); if(!appData.recycleBin.batchSchedule) appData.recycleBin.batchSchedule = []; appData.recycleBin.batchSchedule.push({...batch, originalPath: { dayId: dayId, classScheduleId: classScheduleId }}); saveAppData(); } }; card.querySelector('.batch-card-body button').onclick = () => { if (!isAdminMode) return; const newCapacity = parseInt(prompt("নতুন ধারণক্ষমতা দিন:", batch.capacity)); if (!isNaN(newCapacity) && newCapacity >= 0) { batch.capacity = newCapacity; saveAppData(); } }; grid.appendChild(card); }); container.querySelector('#addNewBatchBtn').onclick = () => { if (!isAdminMode) return; const time = prompt("নতুন ব্যাচের সময় লিখুন (যেমন: সকাল ৮:০০ - ৯:০০):"); if (!time || !time.trim()) return; const capacity = parseInt(prompt("ছাত্র ধারণ ক্ষমতা কত?", "50")); if (isNaN(capacity) || capacity < 0) return; if(!classSchedule.batches) classSchedule.batches = []; classSchedule.batches.push({ id: `b_${Date.now()}`, time: time.trim(), capacity: capacity, studentIds: [] }); saveAppData(); }; updateAdminModeUI(); }
    function showBatchDetailsPage(context){ const batchInfo = findBatchById(context.batchId); if(!batchInfo){ loadPage(showBatchPage); return; } const {batch, classSchedule, day} = batchInfo; const classInfo = findClassById(classSchedule.classId); context.breadcrumbs = [ { text: 'হোম', pageFn: showHomePage }, { text: 'ব্যাচ ম্যানেজমেন্ট', pageFn: showBatchPage }, { text: `${day.dayName} (${batch.time})` } ]; mainContentArea.appendChild(cloneTemplate('template-batch-details')); document.getElementById('batchDetailsHeader').textContent=`${classInfo.name} - ব্যাচের বিস্তারিত`; document.getElementById('batchDetailsDay').textContent = day.dayName; document.getElementById('batchDetailsClass').textContent = classInfo.name; document.getElementById('batchDetailsTime').textContent = batch.time; document.getElementById('printBatchHeaderTitle').textContent = 'গণিত ক্রিয়েটিভ টিচিং হোম'; document.getElementById('printBatchHeaderClass').textContent = `ক্লাস: ${classInfo.name}`; document.getElementById('printBatchHeaderBatch').textContent = `ব্যাচ: ${day.dayName} (${batch.time})`; document.getElementById('btnPrintBatchList').onclick = () => window.print(); bulkStudentImportInput = document.getElementById('bulkStudentImportInput'); btnBulkImport = document.getElementById('btnBulkImport'); btnBulkImport.addEventListener('click', () => bulkStudentImportInput.click()); bulkStudentImportInput.addEventListener('change', (event) => { /* Excel import logic */ }); const tableBody = document.getElementById('batchStudentListBody'); const searchInput = document.getElementById('batchStudentSearchInput'); function populateBatchStudentTable(searchTerm=''){ tableBody.innerHTML = ''; const currentBatchInfo = findBatchById(context.batchId); if(!currentBatchInfo) return; const currentBatch = currentBatchInfo.batch; const searchTermLower = searchTerm.toLowerCase(); const studentsInBatch = (currentBatch.studentIds || []).map(findStudentById).filter(s => s && !s.deletedAt); const filteredStudents = studentsInBatch.filter(student => (student.name.toLowerCase().includes(searchTermLower))); filteredStudents.sort((a,b) => (parseInt(a.roll, 10) || 0) - (parseInt(b.roll, 10) || 0)); let serialNumber = 0; filteredStudents.forEach(student => { serialNumber++; const tr = document.createElement('tr'); const contactInfo = student.parentContact || 'N/A'; tr.innerHTML = ` <td class="serial-number-column">${serialNumber}.</td> <td><strong>${student.name}</strong></td> <td><strong>${student.roll}</strong></td> <td><strong>${student.schoolName || 'N/A'}</strong></td> <td><strong>${contactInfo}</strong></td> <td class="student-action-icons print-hide"> <span class="student-transfer-icon" title="Transfer Student">🔄</span> <span class="student-edit-icon" title="Edit Student">✏️</span> <span class="student-delete-icon" title="Remove from Batch">🗑️</span> </td> `; tr.querySelector('.student-transfer-icon').onclick = () => { showStudentTransferModal(student.id, currentBatch.id, () => populateBatchStudentTable(searchInput.value)); }; tr.querySelector('.student-edit-icon').onclick = () => { showEditStudentModal(student.id); }; tr.querySelector('.student-delete-icon').onclick = () => { if (!isAdminMode) { showToast('এই কাজটি করতে অ্যাডমিন মোড প্রয়োজন।', 'error'); return; } if (!confirm(`আপনি কি '${student.name}' (রোল: ${student.roll}) কে সম্পূর্ণ ডেটাবেস থেকে মুছে রিসাইকেল বিনে পাঠাতে চান?`)) return; student.deletedAt = new Date().toISOString(); if (!appData.recycleBin.students) appData.recycleBin.students = []; appData.recycleBin.students.push(student); const studentInDb = (appData.students || []).find(s => s.id === student.id); if (studentInDb) studentInDb.deletedAt = student.deletedAt; (appData.batchSchedule || []).forEach(day => { (day.classes || []).forEach(cls => { (cls.batches || []).forEach(batch => batch.studentIds = (batch.studentIds || []).filter(id => id !== student.id)); }); }); logActivity('Student moved to recycle bin', { studentName: student.name }); saveAppData(); showToast(`ছাত্র '${student.name}' কে রিসাইকেল বিনে পাঠানো হয়েছে।`, 'info'); }; tableBody.appendChild(tr); }); } searchInput.addEventListener('input', e => populateBatchStudentTable(e.target.value)); populateBatchStudentTable(); document.getElementById('btnAddStudentToBatch').onclick = () => { showAddStudentModal(batch.id, classSchedule.classId, () => populateBatchStudentTable(searchInput.value)); }; document.getElementById('btnBackToBatchList').onclick = () => { loadPage(showBatchPage); }; updateAdminModeUI(); }
    function showStudentTransferModal(studentId, sourceBatchId, onTransferSuccess){ const student = findStudentById(studentId); if(!student) return; const modalFragment = cloneTemplate('template-transfer-modal'); const modalOverlay = modalFragment.querySelector('#studentTransferModal'); document.body.appendChild(modalOverlay); const modalTitle = modalOverlay.querySelector('#transferModalTitle'); const listContainer = modalOverlay.querySelector('#transferBatchListContainer'); const closeButton = modalOverlay.querySelector('.close-button'); modalTitle.textContent = `'${student.name}' (রোল: ${student.roll}) কে ট্রান্সফার করুন`; listContainer.innerHTML = ''; (appData.batchSchedule || []).forEach(day => { if (day.deletedAt) return; const relevantClasses = (day.classes || []).filter(cs => cs.classId === student.classId && (cs.batches || []).length > 0); if (relevantClasses.length > 0) { const dayGroup = document.createElement('div'); dayGroup.className = 'transfer-day-group'; dayGroup.innerHTML = `<h3>${day.dayName}</h3>`; relevantClasses.forEach(classSchedule => { const classInfo = findClassById(classSchedule.classId); if (!classInfo) return; const classGroup = document.createElement('div'); classGroup.innerHTML = `<h4>${classInfo.name}</h4>`; (classSchedule.batches || []).forEach(batch => { const btn = document.createElement('button'); btn.className = 'transfer-batch-button'; let label = `সময়: ${batch.time} (ছাত্র: ${batch.studentIds?.length || 0}/${batch.capacity})`; if (batch.id === sourceBatchId) { btn.disabled = true; label += " (বর্তমান)"; } btn.textContent = label; btn.dataset.targetBatchId = batch.id; btn.onclick = () => { const destinationBatchId = btn.dataset.targetBatchId; const sourceInfo = findBatchById(sourceBatchId); const destInfo = findBatchById(destinationBatchId); if (sourceInfo && destInfo) { sourceInfo.batch.studentIds = (sourceInfo.batch.studentIds || []).filter(id => id !== studentId); if(!destInfo.batch.studentIds) destInfo.batch.studentIds = []; destInfo.batch.studentIds.push(studentId); saveAppData(); showToast(`'${student.name}' কে সফলভাবে ট্রান্সফার করা হয়েছে।`, 'success'); modalOverlay.remove(); if (onTransferSuccess) onTransferSuccess(); } else { showToast("ট্রান্সফার করার সময় একটি ত্রুটি হয়েছে।","error"); } }; classGroup.appendChild(btn); }); dayGroup.appendChild(classGroup); }); listContainer.appendChild(dayGroup); } }); const closeModal = () => modalOverlay.remove(); closeButton.onclick = closeModal; modalOverlay.onclick = (e) => { if(e.target === modalOverlay) closeModal(); }; modalOverlay.classList.add('visible'); }
    function showPaymentPage(context = {}){ context.breadcrumbs = [{ text: 'হোম', pageFn: showHomePage }, { text: 'পেমেন্ট' }]; mainContentArea.appendChild(cloneTemplate('template-payment')); renderPaymentPageTabs(); const classToSelect = context?.classId || ((appData.mainClassCategories || []).find(c => !c.deletedAt)?.id); const tabToSelect = document.querySelector(`.tab-button[data-class-id="${classToSelect}"]`); if(tabToSelect){ tabToSelect.click(); } else { document.querySelector('#payment-class-categories-tabs .tab-button')?.click(); } }
    function renderPaymentPageTabs(){ const tabsContainer = document.getElementById('payment-class-categories-tabs'); if(!tabsContainer) return; tabsContainer.innerHTML = ''; (appData.mainClassCategories || []).filter(c=>!c.deletedAt).forEach(classCat => { const tabButton = document.createElement('button'); tabButton.className = 'tab-button'; tabButton.dataset.classId = classCat.id; tabButton.innerHTML = ` <span>${classCat.name}</span> <span class="student-action-icons admin-only hidden"> <span class="student-delete-icon" title="Move class to recycle bin">🗑️</span> </span> `; tabButton.querySelector('.student-delete-icon').addEventListener('click', (e) => { e.stopPropagation(); if (!isAdminMode) return; if(confirm(`'${classCat.name}' ক্লাসটি রিসাইকেল বিনে পাঠাতে চান?`)) { const classToMove = (appData.mainClassCategories || []).find(c=>c.id === classCat.id); if(classToMove) classToMove.deletedAt = new Date().toISOString(); (appData.batchSchedule || []).forEach(day => { (day.classes || []).forEach(cls => { if (cls.classId === classCat.id) cls.deletedAt = new Date().toISOString(); }); }); saveAppData(); } }); tabButton.addEventListener('click',(e) => { if(e.target.closest('.student-action-icons')) return; tabsContainer.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active')); tabButton.classList.add('active'); renderStudentListForClass(classCat.id); }); tabsContainer.appendChild(tabButton); }); const addBtn = document.createElement('button'); addBtn.className = 'tab-button admin-only hidden'; addBtn.textContent = '+ ক্লাস'; addBtn.onclick = () => {if(!isAdminMode) return; const newName = prompt("নতুন ক্লাসের নাম দিন:"); if(newName && newName.trim()){ if(!appData.mainClassCategories) appData.mainClassCategories = []; appData.mainClassCategories.push({id:`c_${Date.now()}`, name: newName.trim()}); saveAppData(); }}; tabsContainer.appendChild(addBtn); updateAdminModeUI(); }
    function renderStudentListForClass(classId){ const tabContentDiv = document.getElementById('payment-tab-contents'); const classInfo = findClassById(classId); if (!tabContentDiv || !classInfo) return; const allBatchesInClass = (appData.batchSchedule || []).flatMap(day => (day.classes || []).filter(c => c.classId === classId && !c.deletedAt).flatMap(c => c.batches || []).filter(b=>!b.deletedAt)); const batchDayMap = new Map(); (appData.batchSchedule || []).forEach(day => { if(day.deletedAt) return; (day.classes || []).forEach(c => { if(c.deletedAt) return; (c.batches || []).forEach(b => batchDayMap.set(b.id,`${day.dayName.substring(0,3)} (${b.time})`)); }); }); let batchOptions=`<option value="">সব ব্যাচ</option>`; allBatchesInClass.forEach(b => { batchOptions+=`<option value="${b.id}">${batchDayMap.get(b.id) || ''}</option>`; }); tabContentDiv.innerHTML = ` <div id="student-list-payment" class="tab-content"> <div class="student-list-header"> <h3>${classInfo.name} - শিক্ষার্থীদের তালিকা</h3> <div class="default-fee-controls"> <label>ডিফল্ট মাসিক ফি:</label> <input type="number" id="classDefaultMonthlyFee" class="assistant-disabled" value="${classInfo.defaultMonthlyFee || ''}"> <label>ডিফল্ট ভর্তি ফি:</label> <input type="number" id="classDefaultAdmissionFee" class="assistant-disabled" value="${classInfo.defaultAdmissionFee || ''}"> <button id="saveClassDefaultsBtn" class="action-button admin-only hidden">সংরক্ষণ</button> </div> </div> <div class="payment-filters"> <input type="search" id="studentSearchInput" placeholder="নাম বা রোল দিয়ে সার্চ করুন..."><select id="batchFilter">${batchOptions}</select><select id="paymentStatusFilter"><option value="">সব স্ট্যাটাস</option><option value="due">বকেয়া</option><option value="paid">পরিশোধিত</option></select> </div> <div class="table-responsive-wrapper"><table><thead><tr><th>ক্রমিক নং</th><th>নাম</th><th>রোল</th><th>ব্যাচ</th><th>স্ট্যাটাস</th><th class="admin-only hidden">একশন</th></tr></thead><tbody></tbody></table></div> </div> `; const studentListTbody = tabContentDiv.querySelector('tbody'); const searchInput = document.getElementById('studentSearchInput'); const batchFilter = document.getElementById('batchFilter'); const statusFilter = document.getElementById('paymentStatusFilter'); const saveDefaultsBtn = document.getElementById('saveClassDefaultsBtn'); saveDefaultsBtn.addEventListener('click', ()=>{ if (!isAdminMode) return; const newMonthlyFee = parseFloat(document.getElementById('classDefaultMonthlyFee').value) || 0; const newAdmissionFee = parseFloat(document.getElementById('classDefaultAdmissionFee').value) || 0; if (confirm(`আপনি কি '${classInfo.name}' এর সকল সাধারণ ছাত্রের ডিফল্ট মাসিক ফি ${newMonthlyFee} টাকা এবং ডিফল্ট ভর্তি ফি ${newAdmissionFee} টাকা সেট করতে চান?`)){ classInfo.defaultMonthlyFee = newMonthlyFee; classInfo.defaultAdmissionFee = newAdmissionFee; (appData.students || []).forEach(student => { if (student.classId === classId && !student.hasCustomFee) { student.monthlyFeeDefault = newMonthlyFee; Object.keys(student.monthlyPayments).forEach(month => { if (student.monthlyPayments[month].status === 'due') student.monthlyPayments[month].fee = newMonthlyFee; }); if (student.admissionFee.status === 'due') student.admissionFee.amount = newAdmissionFee; } }); saveAppData(); } }); function populatePaymentStudentTable() { const searchTerm = searchInput.value.toLowerCase(); const selectedBatchId = batchFilter.value; const selectedStatus = statusFilter.value; studentListTbody.innerHTML = ''; const studentsInClass = (appData.students || []).filter(s => s && !s.deletedAt && s.classId === classId); const filteredStudents = studentsInClass.filter(s => { if (searchTerm && !s.name.toLowerCase().includes(searchTerm) && !s.roll.toLowerCase().includes(searchTerm)) return false; const studentBatches = findBatchesForStudent(s.id); if (selectedBatchId && !studentBatches.some(b => b.id === selectedBatchId)) return false; const studentIsCurrentlyDue = isStudentDue(s, viewedYear); if (selectedStatus === 'due' && !studentIsCurrentlyDue) return false; if (selectedStatus === 'paid' && studentIsCurrentlyDue) return false; return true; }).sort((a, b) => (parseInt(a.roll, 10) || 0) - (parseInt(b.roll, 10) || 0)); let serialNumber = 0; filteredStudents.forEach(student => { serialNumber++; const tr = document.createElement('tr'); const studentBatches = findBatchesForStudent(student.id); let batchDetailsHtml = studentBatches.length > 0 ? studentBatches.map(b => `${b.day.substring(0,3)} (${b.time})`).join('<br>') : `<span style="color:var(--due-text); font-style:italic;">N/A</span>`; let studentNameHtml = student.name + (student.hasCustomFee ? ` <span title="বিশেষ ফি সেট করা আছে।">⭐</span>` : ''); const studentIsCurrentlyDue = isStudentDue(student, viewedYear); let statusHtml = `<span style="padding: 3px 8px; font-size: 0.8em; border-radius: 12px; color: ${studentIsCurrentlyDue ? 'var(--due-text)' : 'var(--paid-text)'}; background-color: ${studentIsCurrentlyDue ? 'var(--due-color)' : 'var(--paid-color)'};">${studentIsCurrentlyDue ? 'বকেয়া' : 'পরিশোধিত'}</span>`; tr.innerHTML = `<td>${serialNumber}.</td><td data-student-id="${student.id}" style="cursor:pointer; color: var(--text-tab-active);"><strong>${studentNameHtml}</strong></td><td><strong>${student.roll}</strong></td><td>${batchDetailsHtml}</td><td>${statusHtml}</td><td class="admin-only hidden student-action-icons"><span class="student-delete-icon" data-student-id="${student.id}" title="ছাত্রকে রিসাইকেল বিনে পাঠান">🗑️</span></td>`; const nameCell = tr.querySelector('td[data-student-id]'); if (nameCell) { nameCell.onclick = (e) => { if (e.target.closest('.student-action-icons')) return; currentStudentContext = { studentId: student.id, classId: classId, cameFrom: 'paymentPage' }; loadPage(showStudentPaymentDetailsPage, {studentId: student.id, classId: classId}); }; } const deleteIcon = tr.querySelector('.student-delete-icon'); if (deleteIcon) { deleteIcon.onclick = (e) => { e.stopPropagation(); if (!isAdminMode) return; const studentToDelete = findStudentById(e.target.dataset.studentId); if (!studentToDelete || !confirm(`আপনি কি '${studentToDelete.name}' কে রিসাইকেল বিনে পাঠাতে চান?`)) return; studentToDelete.deletedAt = new Date().toISOString(); if(!appData.recycleBin.students) appData.recycleBin.students = []; appData.recycleBin.students.push(studentToDelete); saveAppData(); showToast(`ছাত্র '${studentToDelete.name}' কে রিসাইকেল বিনে পাঠানো হয়েছে।`, 'info'); }; } studentListTbody.appendChild(tr); }); updateAdminModeUI(); } searchInput.addEventListener('input', populatePaymentStudentTable); batchFilter.addEventListener('change', populatePaymentStudentTable); statusFilter.addEventListener('change', populatePaymentStudentTable); populatePaymentStudentTable(); updateAdminModeUI(); }
    function showStudentPaymentDetailsPage(context){ if(!context.studentId){ loadPage(showPaymentPage); return; } const student = findStudentById(context.studentId); if (!student) { showToast('ছাত্র খুঁজে পাওয়া যায়নি।', 'error'); loadPage(showPaymentPage, { classId: context.classId }); return; } context.breadcrumbs = [{ text: 'হোম', pageFn: showHomePage }]; if (currentStudentContext?.cameFrom === 'studentProfile') { context.breadcrumbs.push({ text: 'ছাত্র ডেটাবেস', pageFn: showStudentDatabasePage }, { text: student.name, pageFn: showStudentProfilePage, context: { studentId: student.id } }); } else { context.breadcrumbs.push({ text: 'পেমেন্ট', pageFn: showPaymentPage, context: { classId: student.classId } }); } context.breadcrumbs.push({ text: 'পেমেন্ট বিবরণ' }); mainContentArea.appendChild(cloneTemplate('template-student-payment-details')); const paymentPagePhoto = document.getElementById('paymentPagePhoto'); if(paymentPagePhoto) { if(student.photoURL) { paymentPagePhoto.src = student.photoURL; } paymentPagePhoto.onerror = () => handleImageError(paymentPagePhoto); } document.getElementById('studentNameHeader').textContent=`${student.name} এর পেমেন্ট বিবরণ`; document.getElementById('studentRollDisplay').textContent=student.roll; document.getElementById('studentClassDisplay').textContent=findClassById(student.classId)?.name||'N/A'; document.getElementById('entryDateValue').textContent=student.createdAt ? new Date(student.createdAt).toLocaleString('bn-BD',{day:'numeric',month:'long',year:'numeric'}) : 'N/A'; const admissionFeeInput = document.getElementById('admissionFeeAmount'); const admissionFeeStatus = document.getElementById('admissionFeeStatus'); const admissionReceiverInfo = document.getElementById('admissionReceiverInfo'); const admissionFeeData = student.admissionFee; admissionFeeInput.value = admissionFeeData?.amount || ''; admissionFeeStatus.textContent = `স্ট্যাটাস: ${admissionFeeData?.status === 'paid' ? 'Paid' : (admissionFeeData?.amount > 0 ? 'Due' : 'N/A')}`; admissionReceiverInfo.textContent = `গ্রহণকারী: ${admissionFeeData?.receiver || 'N/A'}`; document.getElementById('btnShowAdmissionDoc').disabled = admissionFeeData?.status !== 'paid'; document.getElementById('btnShowAdmissionDoc').addEventListener('click',()=>{ loadPage(showPaymentDocumentPage, { studentId: student.id, paymentType: 'admission', cameFrom: 'paymentDetails' }); }); document.getElementById('btnAdmissionPaid').addEventListener('click',() => handleAdmissionPayment(student.id)); document.getElementById('btnAdmissionDue').addEventListener('click', () => handleAdmissionDue(student.id)); const defaultFeeInput = document.getElementById('defaultMonthlyFeeForStudent'); const saveDefaultFeeBtn = document.getElementById('btnSaveDefaultMonthlyFee'); defaultFeeInput.value = student.monthlyFeeDefault > 0 ? student.monthlyFeeDefault : ''; saveDefaultFeeBtn.addEventListener('click', ()=>{ if (!isAdminMode) return; const newDefaultFee = parseFloat(defaultFeeInput.value); if (!isNaN(newDefaultFee) && newDefaultFee >= 0) { student.monthlyFeeDefault = newDefaultFee; student.hasCustomFee = true; Object.keys(student.monthlyPayments).forEach(monthName => { if (student.monthlyPayments[monthName].status === 'due') student.monthlyPayments[monthName].fee = newDefaultFee; }); saveAppData(); showToast('এই ছাত্রের জন্য বিশেষ ডিফল্ট মাসিক ফি সংরক্ষণ করা হয়েছে।', 'success'); } else { showToast('অনুগ্রহ করে একটি সঠিক ফি লিখুন।', 'error'); } }); document.getElementById('btnBackToPreviousPage').onclick = () => { if (currentStudentContext?.cameFrom === 'studentProfile') { loadPage(showStudentProfilePage, { studentId: student.id }); } else { loadPage(showPaymentPage, { classId: student.classId }); } }; const selectAllCheckbox = document.getElementById('selectAllMonthsCheckbox'); selectAllCheckbox.addEventListener('change', (e) => { document.querySelectorAll('#monthlyPaymentsTableBody .month-checkbox:not(:disabled)').forEach(chk => { chk.checked = e.target.checked; }); }); document.getElementById('btnPaySelectedMonths').addEventListener('click', () => handleMultiMonthPayment(student.id)); populateStudentMonthlyPaymentsTable(student.id); renderYearlyStatusChart(student); updateAdminModeUI(); }
    async function handleAdmissionPayment(studentId) { const student = findStudentById(studentId); if (!student) return; const newAmount = parseFloat(document.getElementById('admissionFeeAmount').value); if (isNaN(newAmount) || newAmount <= 0) { showToast("ভর্তি ফি এর পরিমাণ সঠিকভাবে লিখুন।","error"); return; } if (student.admissionFee?.status === 'paid' && !isAdminMode) { showToast("ভর্তি ফি ইতিমধ্যে পরিশোধিত।","info"); return; } const receiverName = prompt("ভর্তি ফি গ্রহণকারীর নাম লিখুন:"); if (receiverName?.trim()) { student.admissionFee = { amount: newAmount, status: 'paid', receiver: receiverName, date: new Date().toISOString(), token: generateToken() }; logActivity("Admission Fee Paid", { studentName: student.name, amount: newAmount }); await saveAppData(); loadPage(showStudentPaymentDetailsPage, {studentId: student.id, classId: student.classId}); showToast("ভর্তি ফি সফলভাবে 'Paid' হিসেবে আপডেট করা হয়েছে।", 'success'); } else if (receiverName !== null) { showToast("গ্রহণকারীর নাম আবশ্যক।","error"); } }
    async function handleAdmissionDue(studentId) { const student = findStudentById(studentId); if (!student) return; if (student.admissionFee?.status === 'paid' && !isAdminMode) { showToast("'Due' করতে অ্যাডমিন মোড অ্যাক্টিভেট করুন।","error"); return; } const currentAmount = parseFloat(document.getElementById('admissionFeeAmount').value); student.admissionFee = { amount: isNaN(currentAmount) ? 0 : currentAmount, status: 'due', receiver: '', date: null, token: null }; logActivity("Admission Fee set to Due", { studentName: student.name }); await saveAppData(); loadPage(showStudentPaymentDetailsPage, {studentId: student.id, classId: student.classId}); showToast("ভর্তি ফি সফলভাবে 'Due' হিসেবে আপডেট করা হয়েছে।", 'info'); }
    async function handleMonthlyPayment(buttonElement, studentId, month, statusToSet){ const student = findStudentById(studentId); if (!student) return; const monthData = student.monthlyPayments[month]; if (!monthData) return; if (monthData.status === 'paid' && !isAdminMode) { showToast(`এই মাসের পেমেন্ট ইতিমধ্যে 'Paid'। পরিবর্তনে অ্যাডমিন মোড প্রয়োজন।`,"info"); return; } if (statusToSet === 'paid') { const feeInput = buttonElement.closest('tr').querySelector('.monthly-fee-input'); const feeAmount = parseFloat(feeInput.value); if (isNaN(feeAmount) || feeAmount <= 0) { showToast("ফি ০ টাকা বা খালি হলে Paid করা যাবে না।","error"); return; } const receiverName = prompt(`${month} মাসের বেতন গ্রহণকারীর নাম লিখুন:`); if (receiverName?.trim()) { monthData.fee = feeAmount; monthData.status = 'paid'; monthData.receiver = receiverName; monthData.date = new Date().toISOString(); monthData.token = generateToken(); if (feeAmount !== student.monthlyFeeDefault) student.hasCustomFee = true; logActivity(`Monthly Fee Paid for ${month}`, { studentName: student.name, amount: feeAmount }); await saveAppData(); } else if (receiverName !== null) { showToast("গ্রহণকারীর নাম আবশ্যক।","error"); return; } } else { if (!isAdminMode && monthData.status === 'paid') { showToast("'Due' করতে অ্যাডমিন মোড অ্যাক্টিভেট করুন।","error"); return; } monthData.status = 'due'; monthData.receiver = ''; monthData.date = null; monthData.token = null; logActivity(`Monthly Fee set to Due for ${month}`, { studentName: student.name }); await saveAppData(); } populateStudentMonthlyPaymentsTable(studentId); renderYearlyStatusChart(student); }
    async function handleMultiMonthPayment(studentId){ const selectedMonths = Array.from(document.querySelectorAll('#monthlyPaymentsTableBody .month-checkbox:checked')).map(cb => cb.dataset.month); if(selectedMonths.length === 0){ showToast('অনুগ্রহ করে অন্তত একটি মাস নির্বাচন করুন।', 'info'); return; } const receiverName = prompt(`নির্বাচিত মাসগুলোর (${selectedMonths.join(', ')}) বেতন গ্রহণকারীর নাম লিখুন:`); if (!receiverName?.trim()) { if (receiverName !== null) showToast("গ্রহণকারীর নাম আবশ্যক।","error"); return; } const student = findStudentById(studentId); let totalPaid = 0; selectedMonths.forEach(month => { const feeInput = document.querySelector(`.monthly-fee-input[data-month="${month}"]`); const feeAmount = parseFloat(feeInput.value); if (!isNaN(feeAmount) && feeAmount > 0) { const monthData = student.monthlyPayments[month]; monthData.fee = feeAmount; monthData.status = 'paid'; monthData.receiver = receiverName; monthData.date = new Date().toISOString(); monthData.token = generateToken(); if (feeAmount !== student.monthlyFeeDefault) student.hasCustomFee = true; totalPaid += feeAmount; } }); logActivity(`Multi-month Fee Paid for ${selectedMonths.join(', ')}`, { studentName: student.name, amount: totalPaid }); await saveAppData(); populateStudentMonthlyPaymentsTable(studentId); renderYearlyStatusChart(student); }
    async function showPaymentHistoryPage(context = {}) { context.breadcrumbs = [{ text: 'হোম', pageFn: showHomePage }, { text: 'হিস্টোরি' }]; mainContentArea.appendChild(cloneTemplate('template-payment-history')); const historyContainer = document.getElementById('history-content-area'); const historyTabs = document.getElementById('history-tabs'); async function renderPaymentHistory() { historyContainer.innerHTML = '<p>হিস্টোরি লোড হচ্ছে...</p>'; try { const combinedData = await getCombinedDataForAllYears(); const allPayments = []; (combinedData.students || []).forEach(student => { const classInfo = findClassById(student.classId); const yearLabel = parseInt(student.academicYear) !== viewedYear ? ` (${student.academicYear})` : ''; Object.entries(student.monthlyPayments || {}).forEach(([monthName, payment]) => { if (payment && payment.status === 'paid' && payment.date) allPayments.push({ date: new Date(payment.date), studentName: `${student.name}${yearLabel}`, studentRoll: student.roll, className: classInfo?.name || 'N/A', month: monthName, amount: payment.fee }); }); if (student.admissionFee?.status === 'paid' && student.admissionFee.date) allPayments.push({ date: new Date(student.admissionFee.date), studentName: `${student.name}${yearLabel}`, studentRoll: student.roll, className: classInfo?.name || 'N/A', month: 'ভর্তি ফি', amount: student.admissionFee.amount }); }); allPayments.sort((a,b) => b.date - a.date); const groupedByDate = allPayments.reduce((acc, p) => { const dateKey = p.date.toISOString().split('T')[0]; if (!acc[dateKey]) acc[dateKey] = { transactions: [], total: 0 }; acc[dateKey].transactions.push(p); acc[dateKey].total += (p.amount || 0); return acc; }, {}); historyContainer.innerHTML = ''; if (Object.keys(groupedByDate).length === 0) { historyContainer.innerHTML = '<p>কোনো পেমেন্টের রেকর্ড পাওয়া যায়নি।</p>'; return; } for (const dateKey in groupedByDate) { const dayData = groupedByDate[dateKey]; const formattedDate = new Date(dateKey).toLocaleString('bn-BD', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); let tableRows = dayData.transactions.map(tx => `<tr><td>${tx.studentName}</td><td>${tx.className}</td><td>${tx.studentRoll}</td><td>${tx.month}</td><td>${tx.amount.toLocaleString('bn-BD')}</td></tr>`).join(''); const dateGroupDiv = document.createElement('div'); dateGroupDiv.className = 'history-date-group'; dateGroupDiv.innerHTML = `<div class="history-date-header"><h4>${formattedDate}</h4><span class="total-collection">মোট: ${dayData.total.toLocaleString('bn-BD')} টাকা</span></div><table><thead><tr><th>ছাত্রের নাম</th><th>ক্লাস</th><th>রোল</th><th>বিবরণ</th><th>টাকা</th></tr></thead><tbody>${tableRows}</tbody></table>`; historyContainer.appendChild(dateGroupDiv); } } catch (err) { historyContainer.innerHTML = '<p style="color:red;">হিস্টোরি লোড করা সম্ভব হয়নি।</p>'; } } async function renderActivityHistory() { historyContainer.innerHTML = '<p>হিস্টোরি লোড হচ্ছে...</p>'; try { const combinedData = await getCombinedDataForAllYears(); const allLogs = combinedData.activityLog; if (!allLogs || allLogs.length === 0) { historyContainer.innerHTML = '<p>কোনো অ্যাক্টিভিটি রেকর্ড পাওয়া যায়নি।</p>'; return; } allLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); let tableHTML = `<table><thead><tr><th>সময়</th><th>অ্যাক্টিভিটি</th><th>বিস্তারিত</th></tr></thead><tbody>`; allLogs.forEach(log => { let details = Object.entries(log).filter(([k]) => !['timestamp', 'message', 'academicYear'].includes(k)).map(([k, v]) => `${k}: ${v}`).join(', '); tableHTML += `<tr><td>${new Date(log.timestamp).toLocaleString('bn-BD')}</td><td>${log.message} (${log.academicYear})</td><td>${details}</td></tr>`; }); tableHTML += `</tbody></table>`; historyContainer.innerHTML = tableHTML; } catch (err) { historyContainer.innerHTML = '<p style="color:red;">অ্যাক্টিভিটি হিস্টোরি লোড করা সম্ভব হয়নি।</p>'; } } historyTabs.addEventListener('click', e => { if (e.target.classList.contains('tab-button')) { historyTabs.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active')); e.target.classList.add('active'); if (e.target.dataset.tab === 'payment') renderPaymentHistory(); else renderActivityHistory(); } }); document.getElementById('btnBackFromHistory')?.addEventListener('click', () => loadPage(showHomePage)); renderPaymentHistory(); }
    function showPaymentDocumentPage(context){ const student = findStudentById(context.studentId); if (!student) { loadPage(showPaymentPage); return; } context.breadcrumbs = [{ text: 'হোম', pageFn: showHomePage }]; if (context.cameFrom === 'history') { context.breadcrumbs.push({ text: 'হিস্টোরি', pageFn: showPaymentHistoryPage }); } else { context.breadcrumbs.push({ text: 'পেমেন্ট', pageFn: showPaymentPage, context: { classId: student.classId } }); if (context.cameFrom !== 'paymentDetails') { context.breadcrumbs.push({ text: student.name, pageFn: showStudentProfilePage, context: { studentId: student.id } }); } } context.breadcrumbs.push({ text: 'পেমেন্ট ডকুমেন্ট' }); let paymentData, paymentTitle; if(context.paymentType === 'admission'){ paymentData = student.admissionFee; paymentTitle = 'ভর্তি ফি'; } else { paymentData = student.monthlyPayments[context.month]; paymentTitle = context.month; } if (!paymentData || paymentData.status !== 'paid') { showToast("রশিদ তৈরির জন্য প্রয়োজনীয় তথ্য পাওয়া যায়নি।","error"); const prevContext = context.cameFrom; if(prevContext === 'studentProfile'){loadPage(showStudentProfilePage, { studentId: student.id });} else if(prevContext === 'history'){loadPage(showPaymentHistoryPage);} else{loadPage(showStudentPaymentDetailsPage, context);} return; } mainContentArea.appendChild(cloneTemplate('template-payment-document')); if(document.getElementById('docWelcomeMessage') && context.paymentType === 'admission'){ document.getElementById('docWelcomeMessage').classList.remove('hidden'); } const studentBatches = findBatchesForStudent(student.id); const batchInfoText = studentBatches.length > 0 ? studentBatches.map(b => `${b.day} (${b.time})`).join(', ') : 'N/A'; const formattedDate = paymentData.date ? new Date(paymentData.date).toLocaleString('bn-BD') : 'N/A'; const amount = paymentData.amount || paymentData.fee; const token = paymentData.token || 'N/A'; const studentCopyIds = ['docViewStudentName', 'docViewStudentRoll', 'docViewStudentSchool', 'docViewClassName', 'docViewBatchInfo', 'docViewPaymentMonth', 'docViewAmountPaid', 'docViewReceiverName', 'docViewPaymentDate', 'docViewTokenNo']; const officeCopyIds = studentCopyIds.map(id => id + 'Office'); const values = [student.name, student.roll, student.schoolName, findClassById(student.classId)?.name || 'N/A', batchInfoText, paymentTitle, amount, paymentData.receiver, formattedDate, token]; studentCopyIds.forEach((id, i) => { const el = document.getElementById(id); if (el) el.textContent = values[i] || 'N/A'; }); officeCopyIds.forEach((id, i) => { const el = document.getElementById(id); if (el) el.textContent = values[i] || 'N/A'; }); document.getElementById('colorModeToggle')?.addEventListener('change',(e) => { document.getElementById('printable-receipt-area').classList.toggle('color-mode', e.target.checked); }); document.getElementById('btnPrintGeneratedDocument')?.addEventListener('click', () => window.print()); const layoutRadios = document.querySelectorAll('input[name="receiptLayout"]'); const printableReceiptArea = document.getElementById('printable-receipt-area'); const savedLayout = localStorage.getItem(RECEIPT_LAYOUT_KEY) || 'layout-1'; printableReceiptArea.classList.remove('layout-1', 'layout-2', 'layout-3'); printableReceiptArea.classList.add(savedLayout); const selectedRadio = document.querySelector(`input[value="${savedLayout}"]`); if (selectedRadio) selectedRadio.checked = true; layoutRadios.forEach(radio => { radio.addEventListener('change', (e) => { printableReceiptArea.classList.remove('layout-1', 'layout-2', 'layout-3'); printableReceiptArea.classList.add(e.target.value); localStorage.setItem(RECEIPT_LAYOUT_KEY, e.target.value); }); }); document.getElementById('btnBackFromDocument')?.addEventListener('click', () => { loadPage(showStudentPaymentDetailsPage, context); }); }
    function showReportsPage(context = {}) { context.breadcrumbs = [{ text: 'হোম', pageFn: showHomePage }, { text: 'রিপোর্টস' }]; mainContentArea.appendChild(cloneTemplate('template-reports-page')); const startDateInput = document.getElementById('reportStartDate'); const endDateInput = document.getElementById('reportEndDate'); const generateBtn = document.getElementById('btnGenerateReport'); const printBtn = document.getElementById('btnPrintReport'); const resultsArea = document.getElementById('report-content'); generateBtn.addEventListener('click', () => { const startDate = startDateInput.value ? new Date(startDateInput.value) : null; const endDate = endDateInput.value ? new Date(endDateInput.value) : null; if (!startDate || !endDate) { showToast('অনুগ্রহ করে শুরু এবং শেষ উভয় তারিখ দিন।', 'error'); return; } endDate.setHours(23, 59, 59, 999); showLoader(); setTimeout(() => { const reportData = { collections: [], total: 0 }; (appData.students || []).forEach(student => { if (student.admissionFee?.status === 'paid' && student.admissionFee.date) { const payDate = new Date(student.admissionFee.date); if (payDate >= startDate && payDate <= endDate) { reportData.collections.push({ studentName: student.name, studentRoll: student.roll, date: payDate, type: 'ভর্তি ফি', amount: student.admissionFee.amount }); reportData.total += student.admissionFee.amount; } } Object.entries(student.monthlyPayments).forEach(([month, payment]) => { if (payment.status === 'paid' && payment.date) { const payDate = new Date(payment.date); if (payDate >= startDate && payDate <= endDate) { reportData.collections.push({ studentName: student.name, studentRoll: student.roll, date: payDate, type: `${month} মাসের ফি`, amount: payment.fee }); reportData.total += payment.fee; } } }); }); reportData.collections.sort((a, b) => a.date - b.date); if (reportData.collections.length === 0) { resultsArea.innerHTML = `<p style="text-align:center;">এই তারিখের মধ্যে কোনো কালেকশন পাওয়া যায়নি।</p>`; } else { let tableHTML = `<h4>কালেকশন রিপোর্ট (${startDate.toLocaleDateString('bn-BD')} - ${endDate.toLocaleDateString('bn-BD')})</h4> <table> <thead> <tr><th>তারিখ</th><th>ছাত্রের নাম</th><th>রোল</th><th>বিবরণ</th><th>টাকা</th></tr> </thead> <tbody>`; reportData.collections.forEach(item => { tableHTML += ` <tr> <td>${item.date.toLocaleDateString('bn-BD')}</td> <td><strong>${item.studentName}</strong></td> <td><strong>${item.studentRoll}</strong></td> <td>${item.type}</td> <td>${item.amount.toLocaleString('bn-BD')}</td> </tr> `; }); tableHTML += `</tbody></table> <div class="details-summary" style="text-align:right; font-weight:bold; margin-top:1rem;">মোট কালেকশন: ${reportData.total.toLocaleString('bn-BD')} টাকা</div>`; resultsArea.innerHTML = tableHTML; document.getElementById('printReportHeaderDates').textContent = `তারিখ: ${startDate.toLocaleDateString('bn-BD')} থেকে ${endDate.toLocaleDateString('bn-BD')}`; printBtn.disabled = false; } hideLoader(); }, 50); }); printBtn.addEventListener('click', () => window.print()); }
    function showRecycleBinPage(context = {}) { context.breadcrumbs = [{ text: 'হোম', pageFn: showHomePage }, { text: 'রিসাইকেল বিন' }]; mainContentArea.appendChild(cloneTemplate('template-recycle-bin')); const tabs = document.getElementById('recycle-bin-tabs'); const contentArea = document.getElementById('recycle-bin-content'); const renderContent = (type) => { contentArea.innerHTML = ''; const items = appData.recycleBin?.[type] || []; if (items.length === 0) { contentArea.innerHTML = `<p style="text-align:center; padding: 20px;">এই রিসাইকেল বিন খালি।</p>`; return; } items.sort((a,b) => new Date(b.deletedAt) - new Date(a.deletedAt)).forEach((item) => { const itemDiv = document.createElement('div'); itemDiv.className = 'recycle-bin-item'; let name = item.name || 'Unknown'; if (type === 'students') name = `${item.name} (রোল: ${item.roll})`; else if (type === 'mainClassCategories') name = `ক্লাস: ${item.name}`; else if (type === 'batchSchedule') name = `ব্যাচ: ${item.time}`; itemDiv.innerHTML = `<div><strong>${name}</strong><br><small>ডিলিটের তারিখ: ${new Date(item.deletedAt).toLocaleString('bn-BD')}</small></div><div class="recycle-bin-actions"><button class="action-button btn-restore" data-type="${type}" data-id="${item.id}">Restore</button><button class="action-button btn-delete-perm" data-type="${type}" data-id="${item.id}">Delete</button></div>`; contentArea.appendChild(itemDiv); }); }; contentArea.addEventListener('click', (e) => { if (!e.target.matches('.btn-restore, .btn-delete-perm')) return; const { type, id } = e.target.dataset; const itemIndex = appData.recycleBin[type].findIndex(i => i.id === id); if (itemIndex === -1) return; const itemToProcess = appData.recycleBin[type].splice(itemIndex, 1)[0]; if (e.target.matches('.btn-restore')) { delete itemToProcess.deletedAt; const targetArray = appData[type] || []; targetArray.push(itemToProcess); appData[type] = targetArray; saveAppData(); showToast('সফলভাবে পুনরুদ্ধার করা হয়েছে।', 'success'); } else if (e.target.matches('.btn-delete-perm')) { if (confirm('আপনি কি নিশ্চিতভাবে এটি স্থায়ীভাবে মুছে ফেলতে চান?')) { saveAppData(); showToast('স্থায়ীভাবে মুছে ফেলা হয়েছে।', 'info'); } else { appData.recycleBin[type].splice(itemIndex, 0, itemToProcess); } } renderContent(type); }); tabs.addEventListener('click', e => { if (e.target.matches('.tab-button')) { tabs.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active')); e.target.classList.add('active'); renderContent(e.target.dataset.tab); } }); renderContent('students'); }
    function renderYearlyStatusChart(student) { const chartContainer = document.getElementById('yearlyStatusChart'); if (!chartContainer || !student) return; chartContainer.innerHTML = ''; const admissionDate = student.createdAt ? new Date(student.createdAt) : new Date(); const currentYear = viewedYear; BENGALI_MONTHS.forEach((monthName, index) => { const monthStartDate = new Date(currentYear, index, 1); const isApplicable = monthStartDate >= new Date(admissionDate.getFullYear(), admissionDate.getMonth(), 1); let statusClass = 'not-applicable'; let statusText = 'N/A'; if (isApplicable) { const monthData = student.monthlyPayments?.[monthName] || {}; if (monthData.status === 'paid') { statusClass = 'paid'; statusText = 'Paid'; } else if (paymentIsDue(index, currentYear)) { statusClass = 'due'; statusText = 'Due'; } else { statusClass = 'future'; statusText = 'Future'; } } const monthBox = document.createElement('div'); monthBox.className = `month-box ${statusClass}`; monthBox.textContent = `${monthName.substring(0,3)} - ${statusText}`; monthBox.title = `${monthName}: ${statusText}`; chartContainer.appendChild(monthBox); }); }
    function populateStudentMonthlyPaymentsTable(studentId) { const student = findStudentById(studentId); if (!student) return; const tableBody = document.getElementById('monthlyPaymentsTableBody'); tableBody.innerHTML = ''; const admissionDate = student.createdAt ? new Date(student.createdAt) : new Date(); BENGALI_MONTHS.forEach((monthName, index) => { const currentYear = viewedYear; const monthStartDate = new Date(currentYear, index, 1); const isApplicable = monthStartDate >= new Date(admissionDate.getFullYear(), admissionDate.getMonth(), 1); if (!student.monthlyPayments) student.monthlyPayments = {}; if (!student.monthlyPayments[monthName]) student.monthlyPayments[monthName] = { fee: student.monthlyFeeDefault || 0, status: 'due' }; else if (student.monthlyPayments[monthName].status !== 'paid' && !student.hasCustomFee) student.monthlyPayments[monthName].fee = student.monthlyFeeDefault; const monthData = student.monthlyPayments[monthName]; const isPaid = monthData.status === 'paid'; const row = document.createElement('tr'); row.dataset.status = isApplicable ? monthData.status : 'not-applicable'; if (!isApplicable) row.classList.add('row-not-applicable'); else if (isPaid) row.classList.add('row-paid'); else if (paymentIsDue(index, currentYear)) row.classList.add('row-due-past'); row.innerHTML = `<td><input type="checkbox" id="chk-${monthName}" class="month-checkbox" data-month="${monthName}" ${!isApplicable || isPaid ? 'disabled' : ''}></td><td><label for="chk-${monthName}">${monthName}</label></td><td><input type="number" class="monthly-fee-input assistant-disabled" data-month="${monthName}" value="${monthData.fee}" ${!isApplicable || (isPaid && !isAdminMode) ? 'disabled' : ''}></td><td><button class="action-button btn-paid btn-month-paid" data-month="${monthName}" ${!isApplicable ? 'disabled' : ''}>Paid</button><button class="action-button btn-due btn-month-due" data-month="${monthName}" ${!isApplicable ? 'disabled' : ''}>Due</button></td><td>${isApplicable ? (monthData.receiver || 'N/A') : 'N/A'}</td><td><button class="action-button btn-show-doc" data-month="${monthName}" ${!isPaid ? 'disabled' : ''}>ডকুমেন্ট</button></td>`; row.querySelector('.btn-month-paid')?.addEventListener('click', (e) => handleMonthlyPayment(e.target, studentId, monthName, 'paid')); row.querySelector('.btn-month-due')?.addEventListener('click', () => handleMonthlyPayment(null, studentId, monthName, 'due')); row.querySelector('.btn-show-doc')?.addEventListener('click', () => { if (monthData.status === 'paid') loadPage(showPaymentDocumentPage, { studentId: student.id, month: monthName, paymentType: 'monthly', cameFrom: 'paymentDetails' }); }); const feeInput = row.querySelector('.monthly-fee-input'); feeInput.addEventListener('change', () => { if (isAdminMode) { student.hasCustomFee = true; saveAppData(); } }); tableBody.appendChild(row); }); }
    function showAboutDeveloperModal() { const modalFragment = cloneTemplate('template-about-developer-modal'); if (!modalFragment) return; const modal = modalFragment.querySelector('#aboutDeveloperModal'); document.body.appendChild(modal); const closeBtn = modal.querySelector('.close-button'); const closeModal = () => modal.remove(); closeBtn.onclick = closeModal; modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); }); setTimeout(() => { modal.classList.add('visible'); }, 10); }
    function showEditStudentModal(studentId) { const student = findStudentById(studentId); if (!student) return; const modalFragment = cloneTemplate('template-edit-student-modal'); const modal = modalFragment.querySelector('#editStudentModal'); document.body.appendChild(modal); const form = modal.querySelector('#editStudentForm'); const closeBtn = modal.querySelector('.close-button'); const nameInput = modal.querySelector('#editStudentNameInput'); const rollInput = modal.querySelector('#editStudentRollInput'); const schoolInput = modal.querySelector('#editStudentSchoolInput'); const contactInput = modal.querySelector('#editStudentParentContactInput'); const photoInput = modal.querySelector('#editStudentPhotoInput'); const imagePreview = modal.querySelector('#editStudentImagePreview'); if (imagePreview) { if (student.photoURL) imagePreview.src = student.photoURL; imagePreview.onerror = () => handleImageError(imagePreview); } nameInput.value = student.name || ''; rollInput.value = student.roll || ''; schoolInput.value = student.schoolName || ''; contactInput.value = student.parentContact || ''; const closeModal = () => modal.remove(); closeBtn.onclick = closeModal; modal.onclick = (e) => { if (e.target === modal) closeModal(); }; form.onsubmit = async (e) => { e.preventDefault(); const submitButton = form.querySelector('button[type="submit"]'); submitButton.disabled = true; showLoader(); try { const newName = nameInput.value.trim(); if (!newName) { showToast("ছাত্রের নাম খালি রাখা যাবে না।", 'error'); return; } student.name = newName; student.roll = rollInput.value.trim(); student.schoolName = schoolInput.value.trim(); student.parentContact = contactInput.value.trim(); const file = photoInput.files[0]; if (file) { const photoURL = await uploadStudentImage(file); if (photoURL !== 'error') student.photoURL = photoURL; } logActivity('Student profile updated', { studentName: student.name, roll: student.roll }); await saveAppData(); showToast('প্রোফাইল সফলভাবে আপডেট করা হয়েছে!', 'success'); closeModal(); loadPage(window[pageHistory[historyIndex].page], pageHistory[historyIndex].context, true); } catch (error) { showToast("প্রোফাইল এডিট করার সময় একটি সমস্যা হয়েছে।", "error"); } finally { hideLoader(); submitButton.disabled = false; } }; modal.classList.add('visible'); }

    // --- FINAL INITIALIZATION AND EVENT LISTENERS ---
    applyTheme(localStorage.getItem(THEME_KEY) || 'light');
    window.showHomePage = showHomePage; window.showDashboardPage = showDashboardPage; window.showBatchPage = showBatchPage; window.showPaymentPage = showPaymentPage; window.showStudentDatabasePage = showStudentDatabasePage; window.showStudentProfilePage = showStudentProfilePage; window.showBatchDetailsPage = showBatchDetailsPage; window.showStudentPaymentDetailsPage = showStudentPaymentDetailsPage; window.showPaymentHistoryPage = showPaymentHistoryPage; window.showPaymentDocumentPage = showPaymentDocumentPage; window.showDashboardDetailsPage = showDashboardDetailsPage; window.showReportsPage = showReportsPage; window.showRecycleBinPage = showRecycleBinPage;
    btnToggleMode?.addEventListener('click', () => { if (isAdminMode) { isAdminMode = false; updateAdminModeUI(); } else { const pass = prompt('অ্যাডমিন মোডে যেতে পাসওয়ার্ড দিন:'); if (pass === currentPassword) { isAdminMode = true; showToast('অ্যাডমিন মোড অ্যাক্টিভেট হয়েছে।', 'success'); updateAdminModeUI(); } else if (pass) { showToast('ভুল পাসওয়ার্ড!', 'error'); } } });
    btnPrivacyMenu?.addEventListener('click', (e) => { e.stopPropagation(); privacyDropdown.classList.toggle('active'); });
    window.addEventListener('click', (e) => { if (privacyDropdown.classList.contains('active') && !privacyDropdown.contains(e.target) && !btnPrivacyMenu.contains(e.target)) { privacyDropdown.classList.remove('active'); backupSubMenu.classList.remove('open'); btnBackupMenuToggle.classList.remove('open'); } });
    btnBackupMenuToggle?.addEventListener('click', (e) => { e.stopPropagation(); backupSubMenu.classList.toggle('open'); btnBackupMenuToggle.classList.toggle('open'); });
    btnExportData?.addEventListener('click', () => closeDropdownAndRun(handleExport));
    btnImportData?.addEventListener('click', () => closeDropdownAndRun(() => fileImporter.click()));
    btnChangePassword?.addEventListener('click', () => closeDropdownAndRun(() => { if (!isAdminMode) return; const oldPass = prompt("আপনার বর্তমান পাসওয়ার্ড দিন:"); if (oldPass !== currentPassword) { showToast("বর্তমান পাসওয়ার্ড সঠিক নয়!","error"); return; } const newPass = prompt("আপনার নতুন পাসওয়ার্ড দিন:"); if (!newPass) { showToast("নতুন পাসওয়ার্ড খালি রাখা যাবে না।","error"); return; } const confirmNewPass = prompt("নতুন পাসওয়ার্ডটি আবার দিন:"); if (newPass === confirmNewPass) { currentPassword = newPass; logActivity("Admin password changed."); saveAppData(); showToast("পাসওয়ার্ড সফলভাবে পরিবর্তন করা হয়েছে।","success"); } else { showToast("নতুন পাসওয়ার্ডগুলো মিলেনি।","error"); } }));
    btnForgotPassword?.addEventListener('click', () => closeDropdownAndRun(() => { if (confirm(`আপনি কি নিশ্চিতভাবে পাসওয়ার্ডটি রিসেট করতে চান?`)) { currentPassword = resetDefaultPassword; isAdminMode = false; logActivity("Password reset to default."); saveAppData(); showToast(`পাসওয়ার্ড রিসেট করা হয়েছে।`,`info`); updateAdminModeUI(); } }));
    btnLogout?.addEventListener('click', () => closeDropdownAndRun(() => { if (confirm('আপনি কি লগআউট করতে চান?')) { sessionStorage.clear(); localStorage.removeItem('mcth_rem_creds'); firebase.auth().signOut().then(() => location.reload()); } }));
    btnNavBack.addEventListener('click', () => { if (historyIndex > 0) { historyIndex--; const state = pageHistory[historyIndex]; if (window[state.page]) loadPage(window[state.page], state.context, true); } });
    btnNavForward.addEventListener('click', () => { if (historyIndex < pageHistory.length - 1) { historyIndex++; const state = pageHistory[historyIndex]; if (window[state.page]) loadPage(window[state.page], state.context, true); } });
    btnNavRefresh.addEventListener('click', () => { const currentState = pageHistory[historyIndex]; if (currentState) loadPage(window[currentState.page], currentState.context, true); else location.reload(); });
    btnShowHistory?.addEventListener('click', () => closeDropdownAndRun(() => loadPage(showPaymentHistoryPage)));
    btnRecycleBin?.addEventListener('click', () => closeDropdownAndRun(() => loadPage(showRecycleBinPage)));
    btnToggleTheme?.addEventListener('click', () => closeDropdownAndRun(toggleTheme));
    btnAboutDeveloper?.addEventListener('click', () => closeDropdownAndRun(showAboutDeveloperModal));
    btnHome.addEventListener('click', () => loadPage(showHomePage));
    btnDashboard.addEventListener('click', () => loadPage(showDashboardPage));
    btnBatch.addEventListener('click', () => loadPage(showBatchPage));
    btnPayment.addEventListener('click', () => { currentStudentContext = {}; loadPage(showPaymentPage); });
    btnStudentDatabase.addEventListener('click', () => loadPage(showStudentDatabasePage));
    btnReports.addEventListener('click', () => loadPage(showReportsPage));
    btnExam.addEventListener('click', () => window.open('exam.html', '_blank'));
    btnAttendance.addEventListener('click', () => window.open('attendance.html', '_blank'));
    btnSms.addEventListener('click', () => window.open('sms.html', '_blank'));
    fileImporter.addEventListener('change', handleImport);
    
    const yearSelector = document.getElementById('yearSelector');
    function updateYearSelectorUI() {
        yearSelector.innerHTML = '';
        const calendarYear = new Date().getFullYear();
        const years = Array.from(new Set([activeYear, viewedYear, calendarYear, calendarYear - 1, calendarYear + 1])).sort((a,b) => b - a);
        years.forEach(year => { const option = document.createElement('option'); option.value = year; option.textContent = `${year}${year == activeYear ? ' (Active)' : ''}`; if (year == viewedYear) option.selected = true; yearSelector.appendChild(option); });
        updateAdminModeUI();
    }
    yearSelector.addEventListener('change', (e) => { const selectedYear = parseInt(e.target.value); if (selectedYear !== viewedYear) { if (isSaving) { showToast("ডেটা সেভ হচ্ছে, অপেক্ষা করুন।", "info"); e.target.value = viewedYear; return; } dataLoaded = false; pageHistory = []; historyIndex = -1; sessionStorage.removeItem('mcth_session_state'); loadAppData(selectedYear); } });
    if(btnToggleYearBar) { btnToggleYearBar.addEventListener('click', () => { closeDropdownAndRun(() => { const yearControlsContainer = document.getElementById('year-management-controls'); const isHidden = yearControlsContainer.style.display === 'none'; yearControlsContainer.style.display = isHidden ? 'flex' : 'none'; localStorage.setItem(YEAR_BAR_HIDDEN_KEY, !isHidden); }); }); if (localStorage.getItem(YEAR_BAR_HIDDEN_KEY) === 'true') document.getElementById('year-management-controls').style.display = 'none'; }
    firebase.database().ref('systemSettings/activeYear').once('value').then(snapshot => { activeYear = snapshot.exists() ? snapshot.val() : new Date().getFullYear(); const lastViewedYear = localStorage.getItem('mcth_viewed_year'); viewedYear = lastViewedYear ? parseInt(lastViewedYear) : activeYear; loadAppData(viewedYear); }).catch(err => { console.error("Could not fetch active year:", err); activeYear = new Date().getFullYear(); viewedYear = activeYear; loadAppData(viewedYear); });
}
</script>
</body>
</html>
