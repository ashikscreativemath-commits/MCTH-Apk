<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>মিরাকল ম্যানেজমেন্ট</title>
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">
    
    <!-- SheetJS CDN for Excel Import -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- FIREBASE SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>

    <style>
        @font-face {
            font-family: 'Kalpurush';
            src: url('fonts/kalpurush.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        :root {
            --bg-main: #e8f5e9; --bg-section: #ffffff; --bg-header: #00695c; --bg-tab-container: var(--bg-main); --bg-tab: #e8f5e9; --bg-tab-active: #ffffff; --bg-input: #f1f8e9; --bg-input-disabled: #f5f5f5; --bg-subtle: #f1f8e9; --bg-scrollable: #ffffff; --bg-hover: #dcedc8; --bg-footer: #00695c; --text-primary: #212121; --text-secondary: #757575; --text-header: #ffffff; --text-tab: #424242; --text-tab-active: #ff9f43; --text-input-disabled: #bdbdbd; --text-footer: #e0f2f1; --text-footer-dev: #b2dfdb; --border-color: #e0e0e0; --border-accent: #ff9f43; --border-tab-active: #ffffff; --paid-color: rgba(46, 213, 115, 0.15); --due-color: rgba(255, 107, 107, 0.15); --paid-text: #27ae60; --due-text: #e74c3c; --not-applicable-color: #f5f5f5; --not-applicable-text: #9e9e9e; --toast-success-bg: #27ae60; --toast-error-bg: #e74c3c; --toast-info-bg: #3498db; --future-text: #6c757d;
        }
        
        body[data-theme='dark'] {
            --bg-main: #121212; --bg-section: #1e1e1e; --bg-header: #1f2b38; --bg-tab-container: #121212; --bg-tab: #2a2a2a; --bg-tab-active: #1e1e1e; --bg-input: #252525; --bg-input-disabled: #3a3a3a; --bg-scrollable: #1e1e1e; --bg-hover: #333333; --bg-footer: #1f2b38; --text-primary: #e8eaed; --text-secondary: #9aa0a6; --text-header: #e8eaed; --text-tab: #e8eaed; --text-tab-active: #ff9f43; --text-input-disabled: #888888; --text-footer: #e8eaed; --text-footer-dev: #9aa0a6; --border-color: #3a3a34; --border-accent: #ff9f43; --border-tab-active: #1e1e1e; --paid-color: #143d26; --due-color: #4a1c21; --paid-text: #a3d9a5; --due-text: #f5c6cb; --not-applicable-color: #2c2c2c; --not-applicable-text: #666666;
        }
        
        html { scroll-behavior: smooth; }
        body {
            margin: 0; padding: 0; font-family: 'Kalpurush', sans-serif; font-size: 16px; background-color: var(--bg-main); color: var(--text-primary); transition: background-color .3s, color .3s; line-height: 1.5;
        }

        /* Login Styles */
        #login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; box-sizing: border-box; background-color: var(--bg-main); }
        .login-box { background-color: var(--bg-section); padding: 25px; border-radius: 5px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; border: 1px solid var(--border-color); }
        .login-box h1 { font-size: 1.3em; margin-bottom: 15px; }
        .login-logo { width: 100px; height: 100px; margin: 0 auto 20px; }
        .input-group { position: relative; margin-bottom: 15px; }
        .input-group input { width: 100%; padding: 12px 15px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 1em; background-color: var(--bg-input); color: var(--text-primary); box-sizing: border-box; }
        .password-toggle-icon { position: absolute; top: 50%; right: 12px; transform: translateY(-50%); cursor: pointer; color: var(--text-secondary); font-size: 1.1em; }
        .login-options { display: flex; justify-content: space-between; align-items: center; font-size: 0.85em; margin-bottom: 20px; }
        .login-button { width: 100%; padding: 12px; border: none; border-radius: 8px; background-color: var(--border-accent); color: white; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: background-color 0.3s; }
        #login-error-msg { color: var(--due-text); margin-top: 10px; min-height: 20px; font-weight: bold; }
        .login-footer { margin-top: 25px; font-size: 0.85em; color: var(--text-secondary); text-align: center; }
        .login-footer .copyright-text { font-size: 0.9em; margin-bottom: 15px; }
        .developer-box { border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; background-color: var(--bg-main); }
        .social-icons { display: flex; justify-content: center; gap: 20px; align-items: center; }
        .social-icons a { display: inline-block; color: var(--text-secondary); transition: color 0.3s, transform 0.3s; }
        .social-icons a:hover { color: var(--border-accent); transform: scale(1.1); }
        .social-icons svg { width: 28px; height: 28px; fill: currentColor; }
        .login-footer .instruction-text { font-size: 0.8em; font-style: italic; margin-top: 12px; margin-bottom: 0; color: var(--text-secondary); }
        .login-footer .developed-by-text { margin-bottom: 8px; font-size: 1.1em; }
        .company-info { display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 15px; }
        .company-logo { width: 40px; height: 40px; object-fit: contain; }
        .company-text { text-align: left; line-height: 1.5; }
        .company-text strong { font-size: 1.2em; color: var(--text-primary); }
        .company-text small { font-size: 0.9em; }

        #app-container { display: flex; flex-direction: column; min-height: 100vh; position: relative; }
        #app-container.hidden { display: none; }
        #center-watermark { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 70vw; max-width: 300px; height: 100vh; background-image: url(images/image2.png); background-size: contain; background-repeat: no-repeat; background-position: center; opacity: .05; z-index: 999; pointer-events: none; }
        body[data-theme=dark] #center-watermark{ filter: invert(1) grayscale(1); opacity: 0.08; }
        
        header { background-color: var(--bg-header); color: var(--text-header); padding: 8px 10px; position: sticky; top: 0; z-index: 1001; box-shadow: 0 2px 5px rgba(0,0,0,0.2); display: flex; flex-direction: column; gap: 8px; }
        .header-top-row, .header-mid-row { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        .branding-info { display: flex; flex-direction: column; }
        .branding-info .institute-name { font-size: 1.1em; font-weight: bold; }
        .branding-info .contact-info { font-size: 0.75em; opacity: 0.8; }
        .header-controls { display: flex; align-items: center; gap: 10px; }
        .mode-controls { display: flex; align-items: center; gap: 5px; background-color: rgba(255,255,255,0.1); padding: 3px 6px; border-radius: 15px; }
        .mode-display { font-size: 0.8em; font-weight: bold; padding: 2px 6px; border-radius: 10px; }
        .mode-display.admin-active { background-color: #c0392b; color: white; }
        .mode-display.assistant-active { background-color: #27ae60; color: white; }
        #btnToggleMode { background: none; border: none; color: white; font-size: 0.8em; cursor: pointer; opacity: 0.9; }
        #year-management-controls { display: flex; align-items: center; gap: 8px; font-size: 0.9em; }
        #yearSelector { padding: 4px 8px; border-radius: 15px; border: 1px solid #5a6a7e; background-color: #334257; color: #e8eaed; font-size: 0.9em; cursor: pointer; -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url("data:image/svg+xml;utf8,<svg fill='white' height='24' viewBox='0 0 24 24' width='24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>"); background-repeat: no-repeat; background-position: right 5px top 50%; padding-right: 20px; }
        .header-nav-buttons { display: flex; overflow-x: auto; gap: 8px; padding-bottom: 5px; }
        .header-nav-buttons::-webkit-scrollbar { height: 4px; }
        .header-nav-buttons::-webkit-scrollbar-thumb { background: #555; border-radius: 2px; }
        .header-nav-buttons button { border: none; cursor: pointer; border-radius: 15px; white-space: nowrap; background-color: var(--border-accent); color: #fff; padding: 6px 12px; font-size: 0.9em; transition: background-color 0.2s ease, transform 0.2s ease; flex-shrink: 0; }
        .header-nav-buttons button:hover { transform: translateY(-2px); }
        
        .global-nav-icons { display: flex; gap: 12px; }
        .nav-icon-svg { width: 22px; height: 22px; cursor: pointer; transition: opacity .2s; }
        .nav-icon-svg path { fill: var(--text-header); }
        .nav-icon-svg.disabled { opacity: 0.4; cursor: not-allowed; }

        .privacy-menu-container { position: relative; }
        .privacy-menu-button { background: 0 0; border: none; color: var(--text-header); font-size: 1.6em; cursor: pointer; padding: 0 8px; line-height: 1; }
        .privacy-dropdown-content { display: none; position: absolute; top: 40px; right: 0; background-color: var(--bg-section); color: var(--text-primary); min-width: 220px; box-shadow: 0 4px 12px rgba(0,0,0,.2); z-index: 10000; border-radius: 8px; border: 1px solid var(--border-color); overflow: hidden; }
        .privacy-dropdown-content.active { display: block; }
        .privacy-dropdown-content h4 { margin: 0; padding: 10px 15px; background-color: var(--bg-tab); border-bottom: 1px solid var(--border-color); font-size: 0.9em; color: var(--text-secondary); }
        .privacy-dropdown-content button { width: 100%; padding: 10px 15px; text-align: left; background: 0 0; border: none; cursor: pointer; font-size: 0.95em; color: var(--text-primary); display: flex; align-items: center; justify-content: space-between; }
        .privacy-dropdown-content button:hover { background-color: var(--bg-hover); }
        .privacy-dropdown-content hr { margin: 5px 0; border: none; border-top: 1px solid var(--border-color); opacity: 0.5; }
        .backup-submenu { display: none; background-color: var(--bg-hover); padding-left: 15px; }
        .backup-submenu.open { display: block; }
        .backup-submenu button { padding-left: 25px; font-size: 0.9em; }
        .arrow-icon { display: inline-block; transition: transform .2s ease-in-out; }
        #btnBackupMenuToggle.open .arrow-icon { transform: rotate(90deg); }

        main { padding: 15px; flex-grow: 1; position: relative; z-index: 1; }
        #breadcrumb-container { padding: 0 5px 10px 5px; font-size: 0.8em; color: var(--text-secondary); flex-wrap: wrap; }
        #breadcrumb-container a { color: var(--text-tab-active); text-decoration: none; }
        #banner-area-placeholder { width: 100%; text-align: center; margin-bottom: 15px; }
        #banner-area-placeholder img { width: 100%; max-height: 200px; object-fit: cover; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,.08); }

        .page-section { background-color: var(--bg-section); padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 1px 4px rgba(0,0,0,.06); border: 1px solid var(--border-color); }
        .page-section.hidden, .admin-only.hidden { display: none; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #dynamic-content-placeholder { animation: fadeIn 0.4s ease-out; }

        #toast-container { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); z-index: 10005; display: flex; flex-direction: column; gap: 8px; width: 90%; max-width: 400px; }
        .toast { padding: 12px 15px; border-radius: 6px; color: #fff; font-size: 0.9em; box-shadow: 0 2px 10px rgba(0,0,0,.2); opacity: 0; transform: translateY(20px); transition: opacity .3s, transform .3s; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success { background-color: var(--toast-success-bg); }
        .toast.error { background-color: var(--toast-error-bg); }
        .toast.info { background-color: var(--toast-info-bg); }

        #loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,.6); z-index: 10006; display: none; align-items: center; justify-content: center; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid var(--border-accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .home-grid, .profile-grid { display: flex; flex-direction: column; gap: 15px; }
        .adikothon { padding: 20px; font-size: 0.95em; line-height: 1.6; text-align: justify;}
        .adikothon h3 { font-size: 1.4em; margin-bottom: 15px; text-align: center; }
        #homeImageSlider { width: 100%; height: auto; max-height: 300px; object-fit: contain; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,.1); transition: opacity 1s ease-in-out; }

        .modal-overlay { display: none; position: fixed; z-index: 10001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,.6); backdrop-filter: blur(4px); align-items: center; justify-content: center; padding: 10px; box-sizing: border-box; }
        .modal-overlay.visible { display: flex; }
        .modal-content { background-color: var(--bg-section); margin: auto; padding: 20px; border: 1px solid var(--border-color); border-radius: 8px; width: 100%; max-width: 600px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 5px 15px rgba(0,0,0,.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 10px; }
        .modal-header h2 { margin: 0; color: var(--text-tab-active); font-size: 1.3em; }
        .close-button { color: var(--text-secondary); font-size: 1.8em; font-weight: 700; border: none; background: 0 0; cursor: pointer; padding: 0 5px; }
        .modal-body { overflow-y: auto; padding-right: 8px; flex-grow: 1; }
        .modal-body .form-group { margin-bottom: 15px; }
        .modal-body .form-group label { display: block; margin-bottom: 5px; font-weight: 700; color: var(--text-secondary); font-size: 0.95em; }
        .modal-body .form-group input, .modal-body .form-group select { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; box-sizing: border-box; background-color: var(--bg-input); color: var(--text-primary); }
        .modal-footer { margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color); text-align: right; }
        .modal-footer button { padding: 8px 15px; border-radius: 6px; }

        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; }
        .dashboard-card { background-color: var(--bg-section); padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,.05); border-left: 4px solid; text-align: center; position: relative; padding-bottom: 35px; border: 1px solid var(--border-color); border-left-width: 4px; }
        .dashboard-card h4 { margin: 0 0 8px 0; color: var(--text-secondary); font-size: 0.9em; }
        .dashboard-card .stat-number { font-size: 1.8em; font-weight: 700; margin: 0; word-break: break-word; }
        .dashboard-card .details-button { position: absolute; bottom: 8px; right: 8px; font-size: 0.8em; padding: 4px 10px; background-color: var(--bg-tab); border: 1px solid var(--border-color); color: var(--text-secondary); border-radius: 4px; cursor: pointer; }
        .card-students { border-color: #007bff; } .card-students .stat-number { color: #007bff; }
        .card-batches { border-color: #6f42c1; } .card-batches .stat-number { color: #6f42c1; }
        .card-collection { border-color: #28a745; } .card-collection .stat-number { color: #28a745; }
        .card-due { border-color: #dc3545; } .card-due .stat-number { color: #dc3545; }
        .card-paid-students { border-color: #17a2b8; } .card-paid-students .stat-number { color: #17a2b8; }
        .card-due-students { border-color: #fd7e14; } .card-due-students .stat-number { color: #fd7e14; }

        .table-responsive-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.95em; }
        th, td { border: 1px solid var(--border-color); padding: 10px; text-align: left; vertical-align: middle; white-space: nowrap; }
        th { background-color: var(--bg-tab); color: var(--text-secondary); font-weight: 700; font-size: 0.9em; }
        td input { width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 3px; box-sizing: border-box; background-color: var(--bg-input); color: var(--text-primary); }
        td input:disabled { background-color: var(--bg-input-disabled); cursor: not-allowed; color: var(--text-input-disabled); }

        .action-button, td button { padding: 6px 10px; margin-right: 5px; border: none; border-radius: 3px; cursor: pointer; transition: opacity 0.2s; font-size: 0.9em; }
        .btn-paid { background-color: #28a745; color: #fff; }
        .btn-due { background-color: #dc3545; color: #fff; }
        .btn-show-doc { background-color: var(--border-accent); color: #fff; }
        .btn-add { background-color: #007bff; color: #fff; margin-top: 10px; }

        .tab-container { display: flex; overflow-x: auto; border-bottom: 2px solid var(--border-accent); background-color: var(--bg-tab-container); gap: 2px; }
        .tab-button { padding: 10px 15px; cursor: pointer; border: none; background-color: var(--bg-tab); border-bottom: 2px solid transparent; font-size: 1em; border-top-left-radius: 4px; border-top-right-radius: 4px; display: flex; align-items: center; gap: 5px; color: var(--text-tab); transition: all 0.2s ease; white-space: nowrap; flex-shrink: 0; }
        .tab-button.active { background-color: var(--bg-tab-active); border: 1px solid var(--border-color); border-bottom: 2px solid var(--border-tab-active); font-weight: 700; color: var(--text-tab-active); border-top: 2px solid var(--border-accent); margin-bottom: -1px; transform: scale(1.05); }
        .tab-content { padding: 15px; border: 1px solid var(--border-color); border-top: none; background-color: var(--bg-section); border-radius: 0 0 8px 8px; }

        .details-grid { display: flex; flex-direction: column; gap: 15px; }
        .yearly-status-container { border: 1px solid var(--border-color); padding: 10px; border-radius: 5px; }
        .yearly-status-chart { display: grid; grid-template-columns: repeat(auto-fit, minmax(70px, 1fr)); gap: 5px; text-align: center; }
        .month-box { padding: 5px; border-radius: 4px; font-size: .8em; font-weight: 700; border: 1px solid var(--border-color); }
        .month-box.paid { background-color: var(--paid-color); color: var(--paid-text); border-color: var(--paid-text); }
        .month-box.due { background-color: var(--due-color); color: var(--due-text); border-color: var(--due-text); }
        .month-box.future { background-color: var(--bg-input-disabled); color: var(--future-text); }
        .month-box.not-applicable { background-color: var(--not-applicable-color); color: var(--not-applicable-text); }

        .payment-filters, .details-list-filters { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center; }
        .payment-filters input, .payment-filters select, .details-list-filters select, .details-list-filters input { padding: 8px; border-radius: 4px; border: 1px solid var(--border-color); background-color: var(--bg-input); color: var(--text-primary); height: 38px; font-size: 0.9em; flex-grow: 1; min-width: 120px; }
        .student-list-header { display: flex; flex-direction: column; align-items: flex-start; gap: 15px; margin-bottom: 15px; }
        .student-list-header h3 { margin: 0; font-size: 1.3em; }
        .default-fee-controls { display: flex; gap: 10px; align-items: center; background-color: var(--bg-tab); padding: 8px 12px; border-radius: 5px; border: 1px solid var(--border-color); flex-wrap: wrap; font-size: 0.9em; }
        
        .profile-card p { display: flex; flex-wrap: wrap; margin: 8px 0; }
        .profile-card strong { min-width: 120px; margin-right: 10px; color: var(--text-secondary); }

        .batch-grid { display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 15px; }
        .batch-card-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background-color: var(--bg-tab); }
        .batch-time { font-size: 1.2em; font-weight: 700; cursor: pointer; color: var(--text-tab-active); }
        .student-action-icons { display: flex; gap: 12px; align-items: center; justify-content: center; }
        .student-delete-icon, .student-edit-icon, .student-transfer-icon { cursor: pointer; font-size: 1.2em; transition: transform 0.2s ease; }
        
        footer { background-color: var(--bg-footer); color: var(--text-footer); text-align: center; padding: 15px; font-size: 0.85em; margin-top: 20px; }
        
        /* Payment Receipt Styles */
        .receipt-controls { flex-direction: column; gap: 10px; align-items: stretch; }
        .payment-receipt { flex-direction: column; max-width: 80mm; width: 100%; min-height: auto; border: 1px solid #000; margin: 10px auto; padding: 10px; font-size: 0.8em; background-image: none; overflow: hidden; box-shadow: none; color: #000; background-color: #fff; }
        .payment-receipt .receipt-content-wrapper { width: 100%; padding: 0; border: none; display: block; }
        .payment-receipt .student-copy, .payment-receipt .office-copy { width: 100%; padding: 0; border: none; display: block; }
        .payment-receipt .office-copy, .payment-receipt .receipt-watermark, .payment-receipt .student-copy-watermark, .payment-receipt .doc-welcome-message, .payment-receipt .receipt-header, .payment-receipt .copy-title, .payment-receipt .authority-seal-area { display: none; }
        .payment-receipt .layout3-header { display: block; text-align: center; margin-bottom: 10px; }
        .payment-receipt .layout3-logo { width: 150px; height: auto; display: block; margin: 0 auto 5px; filter: none; }
        .payment-receipt .layout3-institute-info .institute-name { margin: 0; font-size: 1.2em; margin-bottom: 5px; }
        .payment-receipt .layout3-institute-info .contact-info { font-size: 0.9em; margin: 0; }
        .payment-receipt p { margin: 4px 0; font-size: 1em; }
        .payment-receipt strong { font-weight: 700; }
        .payment-receipt .receipt-details-grid { display: block; margin-bottom: 5px; }
        .payment-receipt .receipt-footer-area { margin-top: 15px; padding-top: 10px; padding-bottom: 10px; position: relative; }
        .payment-receipt .receiver-signature-area { position: relative; margin-top: 30px; text-align: center; }
        .payment-receipt .receiver-signature-area .receiver-name-display { margin-top: 25px; margin-bottom: 2px; min-width: 100px; height: 15px; border-bottom: 1px dashed #000;}
        .payment-receipt .receipt-footer { position: relative; bottom: auto; left: auto; width: auto; margin-top: 20px; text-align: center; font-size: 0.7em; color: #555; }
        .payment-receipt .receipt-token { position: relative; top: auto; right: auto; text-align: center; margin-bottom: 5px; }
        
        .daily-summary-receipt { padding: 15px; font-size: 0.9em; }
        .daily-summary-receipt table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 0.95em; }
        .daily-summary-receipt th, .daily-summary-receipt td { border: none; padding: 4px 2px; border-bottom: 1px dotted #ccc; }
        .daily-summary-receipt th { border-bottom: 1px solid #333; }
        .daily-summary-receipt tbody tr:last-child td { border-bottom: none; }
        
        @media print {
            @page {
                size: 80mm auto;
                margin: 2mm;
            }
            body {
                background-color: #fff !important;
                -webkit-print-color-adjust: exact;
            }
            body * {
                visibility: hidden;
            }
            .printable-area, .printable-area * {
                visibility: visible;
            }
            .printable-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0;
                border: none;
            }
   
            .payment-receipt, .daily-summary-receipt {
                width: 100%; 
                box-shadow: none;
                border: none;
                margin: 0;
                padding: 0;
                color: #000 !important;
            }
            .print-hide {
                display: none !important;
            }
        }
        </style>
</head>
<body data-theme="light">
    
    <div id="login-container">
        <div class="login-box">
            <img src="images/image2.png" alt="Logo" class="login-logo" onerror="this.style.display='none'">
            <h1>মিরাকল ক্যাডেট অ্যান্ড একাডেমিক ইন্সটিটিউট</h1>
            <form id="login-form">
                <div class="input-group">
                    <input type="text" id="username" placeholder="Miracle Username" required>
                </div>
                <div class="input-group">
                    <input type="password" id="password" placeholder="Password" required>
                    <span id="password-toggle" class="password-toggle-icon">👁️</span>
                </div>
                <div class="login-options">
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="checkbox" id="remember-me"> Remember Me
                    </label>
                </div>
                <button type="submit" class="login-button">Login to Software</button>
                <div id="login-error-msg"></div>
            </form>
            <div class="login-footer">
                <p class="copyright-text">&copy; Copyright by Miracle Cadet & Academic Institute 2026</p>
                <div class="developer-box">
                    <p class="developed-by-text">Developed by,</p>
                    <div class="company-info">
                        <img src="images/image5.png" alt="Bindumatra IT Logo" class="company-logo">
                        <div class="company-text">
                            <strong>বিন্দুমাত্রা আইটি</strong><br>
                            <small>CEO : Abdullah Al Rafi </small>
                        </div>
                    </div>
                    <div class="social-icons">
                        <a href="mailto:bindumatrait@gmail.com" title="Email Bindumatra IT Solutions" target="_blank">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"></path></svg>
                        </a>
                        <a href="https://www.facebook.com/profile.php?id=61580476801857" title="Facebook Page" target="_blank">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 2.04c-5.5 0-10 4.49-10 10.02 0 5 3.66 9.15 8.44 9.9v-7.02H7.97v-2.89h2.47V9.9c0-2.45 1.44-3.8 3.65-3.8 1.06 0 2.16.19 2.16.19v2.47h-1.27c-1.2 0-1.56.72-1.56 1.5v1.84h2.78l-.45 2.89h-2.33v7.02c4.78-.75 8.44-4.9 8.44-9.9C22 6.53 17.5 2.04 12 2.04z"></path></svg>
                        </a>
                        <a href="https://wa.me/8801745938158" title="Contact on WhatsApp" target="_blank">
                           <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.894 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.886-.001 2.269.655 4.357 1.846 6.167l-1.117 4.082 4.162-1.085zM9.06 7.426c.14-.364.44-1.13.56-1.293.12-.162.28-.192.42-.192.14 0 .28.096.42.364.14.268.56 1.32.62 1.42.06.1.12.18.2.3.08.12.14.24.26.36s.24.22.4.32c.16.1.34.16.5.24.16.08.3.12.42.14.12.02.26 0 .38-.08.12-.08.5-1.25.62-1.47.12-.22.24-.28.4-.28.16 0 .3.04.42.12.12.08.56 1.13.66 1.31.1.18.18.28.2.32.02.04.04.1.02.18s-.08.24-.16.32c-.08.08-.18.1-.28.14s-.2.08-.32.1c-.12.02-.26.02-.4.02s-.68-.08-1.02-.22c-.34-.14-.7-.34-1.08-.62s-.68-.62-.94-.96c-.26-.34-.48-.74-.62-1.18s-.18-.9-.18-1.46c0-.56.08-1.04.22-1.46z"></path></svg>
                        </a>
                    </div>
                    <p class="instruction-text">click the icons to visit</p> 
                </div>
            </div>
        </div>
    </div>
    
    <div id="app-container" class="hidden">
        <div id="center-watermark"></div>
        <div id="toast-container"></div>
        <div id="loader-overlay"><div class="loader"></div></div>
        
        <header>
            <div class="header-top-row">
                <div class="branding-info">
                    <span class="institute-name">মিরাকল ক্যাডেট অ্যান্ড একাডেমিক ইন্সটিটিউট</span>
                    <span class="contact-info">☎ ০১৫১৬৫৩৪২৩১</span>
                </div>
                <div class="header-controls">
                    <div class="mode-controls">
                        <span id="currentModeDisplay" class="mode-display">Assistant</span>
                        <button id="btnToggleMode">Admin</button>
                    </div>
                    <div class="privacy-menu-container">
                        <button id="btnPrivacyMenu" class="privacy-menu-button" title="Options">&#8942;</button>
                        <div id="privacyDropdown" class="privacy-dropdown-content">
                            <h4>Settings</h4>
                            <button id="btnToggleYearBar">Hide Year Bar</button>
                            <button id="btnShowHistory">হিস্টোরি দেখুন</button>
                            <button id="btnRecycleBin">রিসাইকেল বিন</button>
                            <button id="btnFindTrnxId">Find Trnx ID</button>
                            <div class="backup-menu-container">
                                <button id="btnBackupMenuToggle">ব্যাকআপ <span class="arrow-icon">▶</span></button>
                                <div id="backupSubMenu" class="backup-submenu">
                                    <button id="btnExportData">💾 Export JSON</button>
                                    <button id="btnImportData">📤 Import JSON</button>
                                </div>
                            </div>
                            <button id="btnToggleTheme">থিম পরিবর্তন <span id="themeIcon"></span></button>
                            <hr>
                            <h4>About</h4>
                            <button id="btnAboutDeveloper">About Developer</button>
                            <hr>
                            <h4>Privacy</h4>
                            <button id="btnChangePassword" class="admin-only hidden">পাসওয়ার্ড পরিবর্তন</button>
                            <button id="btnForgotPassword">পাসওয়ার্ড ভুলে গেছি</button>
                            <button id="btnClearYearData" class="admin-only hidden">⚠️ Clear Year Data</button>
                            <hr>
                            <button id="btnLogout">লগআউট</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="header-mid-row">
                <div class="global-nav-icons">
                    <span id="btnNavBack" title="Back"><svg class="nav-icon-svg" width="24" height="24" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" fill="currentColor"></path></svg></span>
                    <span id="btnNavForward" title="Forward"><svg class="nav-icon-svg" width="24" height="24" viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z" fill="currentColor"></path></svg></span>
                    <span id="btnNavRefresh" title="Refresh"><svg class="nav-icon-svg" width="24" height="24" viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z" fill="currentColor"></path></svg></span>
                </div>
                <div id="year-management-controls">
                    <select id="yearSelector"></select>
                </div>
            </div>
            <div class="header-nav-buttons">
                <button id="btnHome">হোম</button>
                <button id="btnDashboard">ড্যাশবোর্ড</button>
                <button id="btnBatch">ব্যাচ</button>
                <button id="btnPayment">পেমেন্ট</button>
                <button id="btnStudentDatabase">ছাত্র ডেটাবেস</button>
                <button id="btnReports">রিপোর্টস</button>
                <button id="btnExam">পরীক্ষা</button>
                <button id="btnAttendance">অ্যাটেনডেন্স</button>
                <button id="btnSms">SMS</button>
            </div>
        </header>
        
        <input type="file" id="fileImporter" accept=".json" style="display:none">
        <div id="breadcrumb-container"></div>
        <main id="main-content-area">
            <div id="banner-area-placeholder"></div>
            <div id="dynamic-content-placeholder"></div>
        </main>

        <!-- HTML Templates -->
        <template id="template-home"><div class="home-grid"><div class="page-section adikothon-container"><div class="adikothon"><h3>কিছু কথা:</h3><p>মিরাকল ক্যাডেট অ্যান্ড একাডেমিক ইন্সটিটিউট' একটি শিক্ষা সহায়ক প্রতিষ্ঠান। স্বচ্ছতা ও জবাবদিহিতার আলোকে একটি বিবেক সৃষ্টির লক্ষ্যে 'মিরাকল ক্যাডেট অ্যান্ড একাডেমিক ইন্সটিটিউট" সকল শিক্ষা কার্যক্রম পরিচালনা করছে। এ সমাজের কিছু মানুষের স্বপ্ন পূরণে মিরাকল ক্যাডেট অ্যান্ড একাডেমিক ইন্সটিটিউট এর পক্ষ থেকে সামান্য সহযোগিতা প্রদান করতে পারলে 'মিরাকল ক্যাডেট অ্যান্ড একাডেমিক ইন্সটিটিউট' নিজেকে ধন্য মনে করবে।</p><p>'সবার জন্য শিক্ষা' এই স্লোগানকে সামনে রেখে 'মিরাকল ক্যাডেট অ্যান্ড একাডেমিক ইন্সটিটিউট' তার অবস্থান থেকে কিছু মানুষের শিক্ষা অর্জন নিশ্চিত করার লক্ষ্যে বিভিন্ন পদক্ষেপের মাধ্যমে শিক্ষার্থীদেরকে পড়াশোনামুখী করার বাস্তব পদক্ষেপ গ্রহণ করেছে। আর্থিক অস্বচ্ছল শিক্ষার্থী তথা এতিমদের জন্য বিনা বেতনে পড়ালেখা করার বিশেষ সুযোগ প্রদান, নিয়মিত বৃত্তি প্রদান এবং সকল শিক্ষার্থীদেরকে উৎসাহ প্রদানের জন্য নিয়মিত পরীক্ষার আয়োজন, প্রতিটি পরীক্ষার মূল্যায়ন সাপেক্ষে পুরস্কার ঘোষণা এবং আনুষ্ঠানিকভাবে পুরস্কার প্রদান, যা প্রতিটি শিক্ষার্থীকে দায়িত্ববোধ থেকে পড়াশোনা করার অনুপ্রেরণা যোগায়। অভিভাবকদের সঙ্গে নিয়মিত যোগাযোগের মাধ্যমে ছাত্র-ছাত্রীর সার্বিক উন্নয়নে প্রয়োজনীয় ব্যবস্থা নেওয়া হয়।</p><p>মিরাকল ক্যাডেট অ্যান্ড একাডেমিক ইন্সটিটিউট এর' নিয়মিত অনুশীলন একজন শিক্ষার্থীর স্বপ্ন পূরণে বিশেষ সহায়ক ভূমিকা রাখবে বলে আমি দৃঢ়ভাবে বিশ্বাস করি। সকলের সার্বিক সুস্থতা ও দীর্ঘায়ু কামনা করছি।</p></div></div><div class="page-section image-slider-container"><img id="homeImageSlider" src="images/image3.png" alt="Promotional Image" onerror="this.style.display='none'"></div></div></template>
        <template id="template-dashboard"><div class="page-section"><h2>ড্যাশবোর্ড</h2><div class="dashboard-grid"></div></div></template>
        <template id="template-student-database"><div class="page-section"><h2>ছাত্র ডেটাবেস</h2><p>যেকোনো ছাত্রকে তার নাম, রোল বা যোগাযোগ নম্বর দিয়ে খুঁজে বের করুন।</p><div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;"><input type="search" id="studentDatabaseSearchInput" placeholder="ছাত্রের নাম বা রোল লিখুন..." style="flex-grow: 1; padding: 12px; font-size: 1em;"><input type="search" id="studentDatabaseContactInput" placeholder="যোগাযোগ নম্বর লিখুন..." style="flex-grow: 1; padding: 12px; font-size: 1em;"></div><div id="student-search-results"></div></div></template>
        <template id="template-payment"><div class="page-section" style="padding:0; border:none; box-shadow:none; background-color: transparent;"><div class="tab-container" id="payment-class-categories-tabs"></div><div id="payment-tab-contents"></div></div></template>
        <template id="template-payment-history"><div class="page-section"><h2>হিস্টোরি</h2><div class="tab-container" id="history-tabs"><button class="tab-button active" data-tab="payment">পেমেন্ট হিস্টোরি</button><button class="tab-button" data-tab="activity">Student Activity</button></div><div id="history-content-area" class="tab-content" style="max-height: 70vh; overflow-y: auto;"></div><button id="btnBackFromHistory" class="action-button" style="margin-top:20px">হোম-পেজে ফেরত যান</button></div></template>
        <template id="template-student-profile"><div class="page-section"><div class="details-header-container" style="display:flex; justify-content:flex-end; align-items:center;margin-bottom:20px; gap: 10px;"><button id="btnEditStudentProfile" class="action-button admin-only hidden" style="background-color:#e67e22;color:#fff">Edit Profile</button><button id="btnGoToPaymentSection" class="action-button" style="background-color:#6f42c1;color:#fff">পেমেন্ট সেকশন</button></div><div class="profile-grid"><div class="profile-card" style="text-align: center; padding-top: 30px;"><img id="profilePagePhoto" src="images/default_avatar.png" alt="Profile Photo" style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 3px solid var(--border-color);" onerror="this.src='images/default_avatar.png'"><h3 id="profileNameHeader" style="margin-top: 15px; font-size: 1.5em;"></h3></div><div><div class="profile-card"><h4>সাধারণ তথ্য</h4><p><strong>রোল:</strong> <span id="profileRoll"></span></p><p><strong>ক্লাস:</strong> <span id="profileClass"></span></p><p><strong>স্কুল:</strong> <span id="profileSchool"></span></p><p><strong>যোগাযোগ:</strong> <span id="profileParentContact"></span></p><p><strong>ভর্তির তারিখ:</strong> <span id="profileAdmissionDate"></span></p></div><div class="profile-card"><h4>বর্তমান ব্যাচসমূহ</h4><div id="student-profile-batches"></div></div></div></div><button id="btnBackToDatabase" class="action-button" style="margin-top:20px">ডেটাবেসে ফেরত যান</button></div></template>
        <template id="template-batch"><div class="page-section" style="padding:0; border:none; box-shadow:none; background-color: transparent;"><h2>ব্যাচ ম্যানেজমেন্ট</h2><div class="tab-container" id="batch-day-tabs"></div><div id="batch-class-subtabs-container" class="tab-content" style="border-top:none;margin-top:0;padding-top:10px"></div></div></template>
        <template id="template-batch-details"><div class="page-section"><div class="student-list-header print-hide"><div><h3 id="batchDetailsHeader">ব্যাচের শিক্ষার্থীদের তালিকা</h3><p><strong>দিন:</strong> <span id="batchDetailsDay"></span> | <strong>ক্লাস:</strong> <span id="batchDetailsClass"></span> | <strong>সময়:</strong> <span id="batchDetailsTime"></span></p></div><div class="details-list-filters"><input type="search" id="batchStudentSearchInput" class="print-hide" placeholder="নাম দিয়ে সার্চ করুন..."><button id="btnBulkImport" class="action-button print-hide">Excel থেকে যোগ করুন</button><input type="file" id="bulkStudentImportInput" accept=".xlsx" style="display:none;"><button id="btnPrintBatchList" class="action-button print-hide">PDF ডাউনলোড</button></div></div><hr class="print-hide"><div id="printableBatchDetailsArea" class="printable-area"><div class="details-page-printable-header print-only"><h2 id="printBatchHeaderTitle"></h2><h3 id="printBatchHeaderClass"></h3><p id="printBatchHeaderBatch"></p></div><div class="table-responsive-wrapper"><table><thead><tr><th>ক্রমিক নং</th><th>নাম</th><th>রোল</th><th>স্কুলের নাম</th><th>যোগাযোগ নম্বর</th><th class="print-hide">একশন</th></tr></thead><tbody id="batchStudentListBody"></tbody></table></div><div class="print-footer"><span class="left-footer-text">&copy; Miracle Cadet & Academic Institute 2026</span><span class="right-footer-text">Software by: বিন্দুমাত্রা আইটি</span></div></div><button class="action-button btn-add print-hide" id="btnAddStudentToBatch">+ নতুন শিক্ষার্থী যোগ করুন</button><button id="btnBackToBatchList" class="action-button print-hide" style="margin-top:20px">ব্যাচ লিস্টে ফেরত যান</button></div></template>
        <template id="template-transfer-modal"><div id="studentTransferModal" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h2 id="transferModalTitle">ছাত্রকে অন্য ব্যাচে ট্রান্সফার করুন</h2><span class="close-button">&times;</span></div><div class="modal-body" id="transferBatchListContainer"></div></div></div></template>
        <template id="template-add-student-modal">
            <div id="addStudentModal" class="modal-overlay">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 id="addStudentModalTitle">নতুন শিক্ষার্থী যোগ করুন</h2><span class="close-button">&times;</span>
                    </div>
                    <form id="addStudentForm">
                        <div class="modal-body">
                            <div class="form-group" style="text-align: center;">
                                <img id="addStudentImagePreview" src="images/default_avatar.png" alt="Profile Picture" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 2px solid var(--border-color); margin-bottom: 10px;" onerror="this.src='images/default_avatar.png'">
                            </div>
                            <div class="form-group"><label for="studentNameInput">ছাত্রের নাম (আবশ্যক)</label><input type="text" id="studentNameInput" required></div>
                            <div class="form-group"><label for="studentSchoolInput">স্কুলের নাম</label><input type="text" id="studentSchoolInput"></div>
                            <div class="form-group"><label for="parentContactInput">অভিভাবকের যোগাযোগ নম্বর</label><input type="tel" id="parentContactInput"></div>
                            <div class="form-group">
                                <label>ছাত্রের ছবি (ঐচ্ছিক, সর্বোচ্চ 300KB)</label>
                                <div style="display: flex; gap: 10px;">
                                    <button type="button" id="selectStudentPhotoBtn" class="action-button" style="flex: 1;"> ফাইল থেকে দিন</button>
                                    <button type="button" id="takeStudentPhotoBtn" class="action-button" style="flex: 1;">ক্যামেরা দিয়ে তুলুন</button>
                                </div>
                                <input type="file" id="studentPhotoInput" accept="image/png, image/jpeg" style="display: none;">
                            </div>
                            <!-- Start of new admission fee section -->
                            <fieldset style="border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; margin-top: 15px; background-color: var(--bg-main);">
                                <legend style="font-weight: bold; padding: 0 10px; color: var(--text-secondary);">ভর্তি ফি সংক্রান্ত</legend>
                                <div class="form-group">
                                    <label for="admissionFeeInputModal">পরিমাণ (টাকা)</label>
                                    <input type="number" id="admissionFeeInputModal" placeholder="ডিফল্ট ফি">
                                </div>
                                <div class="form-group" style="background-color: var(--bg-subtle); padding: 10px; border-radius: 5px;">
                                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 1.1em;">
                                        <input type="checkbox" id="admissionFeeFreeCheckbox" style="width: 20px; height: 20px;"> ভর্তি ফি ফ্রি
                                    </label>
                                </div>
                                <div class="form-group" id="admissionReceiverGroup">
                                    <label for="admissionReceiverInputModal">গ্রহণকারীর নাম (আবশ্যক)</label>
                                    <input type="text" id="admissionReceiverInputModal" required>
                                </div>
                            </fieldset>
                            <!-- End of new admission fee section -->
                        </div>
                        <div class="modal-footer"><button type="submit" class="action-button btn-add">সংরক্ষণ করুন</button></div>
                    </form>
                </div>
            </div>
        </template>
        <template id="template-student-payment-details"><div class="page-section"><div class="details-header-container" style="display:flex; align-items: center; gap: 15px; margin-bottom: 10px;"><img id="paymentPagePhoto" src="images/default_avatar.png" alt="Photo" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;" onerror="this.src='images/default_avatar.png'"><div><h3 id="studentNameHeader" style="margin:0;">শিক্ষার্থীর পেমেন্ট বিবরণ</h3><div id="studentEntryDateDisplay" class="entry-date-info" style="font-size: 0.8em;">ভর্তির তারিখ: <span id="entryDateValue">N/A</span></div></div></div><p style="margin: 5px 0;"><strong>রোল:</strong> <span id="studentRollDisplay"></span> | <strong>ক্লাস:</strong> <span id="studentClassDisplay"></span></p><hr><div class="details-grid"><div class="payment-main-details"><div style="margin-bottom:1rem;"><h4>ভর্তি ফি:</h4><label>পরিমাণ: <input type="number" id="admissionFeeAmount" placeholder="টাকা"></label><br><button class="action-button btn-paid" id="btnAdmissionPaid">Paid</button><button class="action-button btn-due" id="btnAdmissionDue">Due</button><button class="action-button btn-show-doc" id="btnShowAdmissionDoc">রশিদ</button><br><span id="admissionFeeStatus">স্ট্যাটাস: প্রযোজ্য নয়</span> | <span id="admissionReceiverInfo">গ্রহণকারী: প্রযোজ্য নয়</span></div><hr><div><h4>মাসিক ফি (ডিফল্ট):</h4><label>পরিমাণ: <input type="number" id="defaultMonthlyFeeForStudent" placeholder="টাকা"></label><button id="btnSaveDefaultMonthlyFee" class="action-button">সংরক্ষণ</button></div></div><div class="yearly-status-container"><h4>বারো মাসের পেমেন্ট স্ট্যাটাস</h4><div class="yearly-status-chart" id="yearlyStatusChart"></div></div></div><hr><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px; flex-wrap: wrap; gap: 10px;"><h4>মাসভিত্তিক পেমেন্ট:</h4><button id="btnPaySelectedMonths" class="action-button btn-paid">নির্বাচিত মাসগুলো পরিশোধ করুন</button></div><div class="table-responsive-wrapper" style="max-height:400px"><table><thead><tr><th><input type="checkbox" id="selectAllMonthsCheckbox" title="সবগুলো নির্বাচন করুন"></th><th>মাস</th><th>ফি</th><th>স্ট্যাটাস</th><th>গ্রহণকারী</th><th>একশন</th></tr></thead><tbody id="monthlyPaymentsTableBody"></tbody></table></div><button id="btnBackToPreviousPage" class="action-button" style="margin-top:20px">আগের পেজে ফেরত যান</button></div></template>
        <template id="template-payment-document"><div class="page-section payment-receipt-page" style="padding: 0;"><div class="receipt-controls print-hide"><button id="btnPrintGeneratedDocument" class="action-button">প্রিন্ট করুন</button></div><div class="printable-area"><div class="payment-receipt" id="printable-receipt-area"><div class="layout3-header"><img src="images/miraclelogo.png" alt="Logo" class="layout3-logo" onerror="this.style.display='none'"><div class="layout3-institute-info"><h3 class="institute-name">Miracle Cadet & Academic Institute</h3><p class="contact-info">Contact: 01516534231</p><hr style="border-top: 1px dashed #bbb; margin: 10px 0;"></div></div><div class="receipt-content-wrapper student-copy"><div class="receipt-token">Trnx ID: <span id="docViewTokenNo">N/A</span></div><p><strong>Name:</strong> <span id="docViewStudentName">N/A</span></p><p><strong>School Name:</strong> <span id="docViewStudentSchool">N/A</span></p><p><strong>Roll:</strong> <span id="docViewStudentRoll">N/A</span></p><p><strong>Class:</strong> <span id="docViewClassName">N/A</span></p><p><strong>Batch:</strong> <span id="docViewBatchInfo">N/A</span></p><p><strong>Payment For:</strong> <span id="docViewPaymentMonth">N/A</span></p><p><strong>Amount Paid:</strong> <span id="docViewAmountPaid">N/A</span></p><p><strong>Payment Date:</strong> <span id="docViewPaymentDate">N/A</span></p><div class="receipt-footer-area"><div class="receiver-signature-area"><div id="docViewReceiverName" style="margin-bottom: 20px; font-weight: bold;"></div><div class="receiver-name-display"></div>Authority Signature</div><div class="receipt-footer">Software by: বিন্দুমাত্রা আইটি<br>bindumatrait@gmail.com</div></div></div></div></div><button id="btnBackFromDocument" class="action-button print-hide" style="margin-top:20px">ফেরত যান</button></div></template>
        <template id="template-dashboard-details-page"><div class="page-section"><div class="details-list-controls print-hide"><h2 id="detailsListPageTitle" style="margin: 0;">বিস্তারিত তালিকা</h2><div class="details-list-filters"><select id="detailsPageClassFilter"></select><select id="detailsPageBatchFilter"></select><select id="paymentTypeFilter"><option value="">সব ধরণের ফি</option><option value="মাসিক ফি">মাসিক বেতন</option><option value="ভর্তি ফি">ভর্তি ফি</option></select><button id="btnPrintDetailsList" class="action-button">PDF ডাউনলোড</button></div></div><hr class="print-hide"><div id="printableDetailsArea" class="printable-area"><div class="details-page-printable-header print-only"><h2 id="printHeaderTitle"></h2><h3 id="printHeaderSubtitle"></h3><p id="printHeaderFilters"></p></div><div class="table-responsive-wrapper"><table><thead><tr><th>ক্রমিক নং</th><th>ছাত্রের নাম</th><th>রোল</th><th>ক্লাস</th><th>ব্যাচ</th><th id="headerCol6"> বিবরণ </th><th id="headerCol7"> টাকা / মাস </th></tr></thead><tbody id="detailsPageTableBody"></tbody></table></div><div id="detailsPageSummary" class="details-summary"></div><div class="print-footer"><span class="left-footer-text">&copy; Miracle Cadet & Academic Institute 2026</span><span class="right-footer-text">Software by: বিন্দুমাত্রা আইটি</span></div></div><button id="btnBackToDashboard" class="action-button print-hide" style="margin-top:20px">ড্যাশবোর্ডে ফেরত যান</button></div></template>
        <template id="template-reports-page"><div class="page-section"><h2>কালেকশন রিপোর্ট</h2><div class="details-list-controls"><div class="details-list-filters"><label for="reportStartDate">শুরুর তারিখ:</label><input type="date" id="reportStartDate"><label for="reportEndDate">শেষের তারিখ:</label><input type="date" id="reportEndDate"><button id="btnGenerateReport" class="action-button btn-add">রিপোর্ট দেখুন</button></div><button id="btnPrintReport" class="action-button" disabled>PDF ডাউনলোড</button></div><hr><div id="report-results-area" class="printable-area"><div class="details-page-printable-header print-only"><h2>মিরাকল ক্যাডেট অ্যান্ড একাডেমিক ইন্সটিটিউট</h2><h3>কালেকশন রিপোর্ট</h3><p id="printReportHeaderDates"></p></div><div id="report-content"><p style="text-align:center; color: var(--text-secondary);">অনুগ্রহ করে তারিখ নির্বাচন করে "রিপোর্ট দেখুন" বাটনে ক্লিক করুন।</p></div><div class="print-footer"><span class="left-footer-text">&copy; Miracle Cadet & Academic Institute 2026</span><span class="right-footer-text">Software by: বিন্দুমাত্রা আইটি</span></div></div></div></template>
        <template id="template-recycle-bin"><div class="page-section"><h2>রিসাইকেল বিন</h2><div class="tab-container" id="recycle-bin-tabs"><button class="tab-button active" data-tab="students">ছাত্র</button><button class="tab-button" data-tab="mainClassCategories">ক্লাস</button><button class="tab-button" data-tab="batchSchedule">দিন/ব্যাচ</button></div><div id="recycle-bin-content" class="tab-content" style="max-height: 60vh; overflow-y: auto;"></div></div></template>
        <template id="template-about-developer-modal"><div id="aboutDeveloperModal" class="modal-overlay"><div class="modal-content" style="max-width: 95%; padding: 15px; background: var(--bg-main); border-radius: 12px;"><div class="modal-header" style="padding-bottom: 10px; margin-bottom: 10px;"><h2>About the Developer</h2><span class="close-button">&times;</span></div><div class="modal-body" style="padding:0;"><img src="images/Abdullah-Al-Rafi-Digital-Card.png" alt="Developer Digital Card" style="width: 100%; height: auto; border-radius: 8px; display: block;" onerror="this.alt='Image not found.'"></div></div></div></template>
        <template id="template-edit-student-modal"><div id="editStudentModal" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h2 id="editStudentModalTitle">Edit Student Information</h2><span class="close-button">&times;</span></div><form id="editStudentForm"><div class="modal-body"><div class="form-group" style="text-align: center;"><img id="editStudentImagePreview" src="images/default_avatar.png" alt="Profile Picture" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 2px solid var(--border-color); margin-bottom: 10px;" onerror="this.src='images/default_avatar.png'"></div><div class="form-group"><label for="editStudentNameInput">ছাত্রের নাম (আবশ্যক)</label><input type="text" id="editStudentNameInput" required></div><div class="form-group"><label for="editStudentRollInput">রোল নম্বর</label><input type="text" id="editStudentRollInput"></div><div class="form-group"><label for="editStudentSchoolInput">স্কুলের নাম</label><input type="text" id="editStudentSchoolInput"></div><div class="form-group"><label for="editStudentParentContactInput">অভিভাবকের যোগাযোগ নম্বর</label><input type="tel" id="editStudentParentContactInput"></div><div class="form-group"><label>নতুন ছবি আপলোড করুন (ঐচ্ছিক, সর্বোচ্চ 300KB)</label><div style="display: flex; gap: 10px;"><button type="button" id="editSelectStudentPhotoBtn" class="action-button" style="flex: 1;"> ফাইল থেকে দিন</button><button type="button" id="editTakeStudentPhotoBtn" class="action-button" style="flex: 1;">ক্যামেরা দিয়ে তুলুন</button></div><input type="file" id="editStudentPhotoInput" accept="image/png, image/jpeg" style="display: none;"></div></div><div class="modal-footer"><button type="submit" class="action-button btn-add">Save Changes</button></div></form></div></div></template>
        <template id="template-daily-summary-receipt-modal"><div id="dailySummaryModal" class="modal-overlay"><div class="modal-content" style="max-width: 400px; padding: 0;"><div class="printable-area"><div class="payment-receipt daily-summary-receipt"><div class="layout3-header"><img src="images/image2.png" alt="Logo" class="layout3-logo" onerror="this.style.display='none'"><div class="layout3-institute-info"><h3 class="institute-name">মিরাকল ক্যাডেট অ্যান্ড একাডেমিক ইন্সটিটিউট</h3><p class="contact-info">জলেশ্বরীতলা, বগুড়া। ☎ ০১৫১৬৫৩৪২৩১</p></div></div><hr style="border-top: 1px dashed #bbb; margin: 10px 0;"><div class="receipt-content-wrapper"><h4 style="text-align: center; margin: 5px 0 10px;">দৈনিক কালেকশন রিপোর্ট</h4><p><strong>তারিখ:</strong> <span id="summaryReceiptDate">N/A</span></p><table><thead><tr><th style="text-align: left;">ছাত্রের নাম/রোল</th><th style="text-align: right;">টাকা</th></tr></thead><tbody id="summaryReceiptTableBody"></tbody></table><hr style="border-top: 1px dashed #bbb; margin: 10px 0;"><p style="text-align: right; font-size: 1.2em; font-weight: bold;"><strong>মোট কালেকশন:</strong> <span id="summaryReceiptTotal">0</span> টাকা</p><div class="receipt-footer" style="position: relative; margin-top: 20px;">&copy; Miracle Cadet & Academic Institute 2026 <br>Software by: বিন্দুমাত্রা আইটি</div></div></div></div><div class="modal-footer print-hide" style="border-top: 1px solid var(--border-color); padding: 10px; background-color: var(--bg-tab);"><button id="btnPrintDailySummary" class="action-button btn-add">প্রিন্ট করুন</button><button id="btnCloseDailySummary" class="action-button">বন্ধ করুন</button></div></div></div></template>
        <template id="template-find-trnx-id-page"><div class="page-section"><h2>Find Transaction ID</h2><p>Search for a transaction by its ID or browse the list of all successful transactions for the current year.</p><input type="search" id="trnxIdSearchInput" placeholder="Enter Transaction ID..." value="MCAI-" style="width: 100%; padding: 12px; font-size: 1.1em; margin-bottom: 20px; box-sizing: border-box;"><div id="trnx-results-container" style="max-height: 60vh; overflow-y: auto;"></div></div></template>
        <template id="template-camera-modal"><div id="cameraModal" class="modal-overlay"><div class="modal-content" style="max-width: 640px;"><div class="modal-header"><h2>ছবি তুলুন</h2><span class="close-button">&times;</span></div><div class="modal-body" style="text-align: center;"><video id="camera-video-feed" width="600" height="450" autoplay playsinline style="border-radius: 8px; background-color: #000; max-width: 100%;"></video><canvas id="camera-canvas" style="display:none;"></canvas></div><div class="modal-footer"><button id="capture-photo-btn" class="action-button btn-add">ছবি তুলুন</button></div></div></div></template>

        <footer><div class="developer-info">Developed by: বিন্দুমাত্রা আইটি<br>পিটি আই মোড়, বগুড়া<br>Whatsapp: 01745938158<br>Mail: bindumatrait@gmail.com</div></footer>
    </div>
    
<script>
// ================================================================== //
//            FIREBASE CONFIGURATION AND INITIALIZATION             //
// ================================================================== //
const firebaseConfig = {
  apiKey: "AIzaSyAnpbv9WhvOqV8nsbmVOQuBhKDF7D9-Ztc",
  authDomain: "miracle-math-online-software.firebaseapp.com",
  projectId: "miracle-math-online-software",
  storageBucket: "miracle-math-online-software.firebasestorage.app",
  messagingSenderId: "27829239296",
  appId: "1:27829239296:web:108d6b86969c95cea2a2e5",
  measurementId: "G-GSVFRCS9NR",
  databaseURL: "https://miracle-math-online-software-default-rtdb.asia-southeast1.firebasedatabase.app"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const credsRef = db.ref('credentials');

// ================================================================== //
//                LOGIN SCRIPT START                                //
// ================================================================== //
document.addEventListener('DOMContentLoaded', () => {
    const REMEMBER_KEY = 'mcth_rem_creds'; 
    const SESSION_KEY = 'mcth_is_logged_in';

    const loginContainer = document.getElementById('login-container');
    const appContainer = document.getElementById('app-container');
    const loginForm = document.getElementById('login-form');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const passwordToggle = document.getElementById('password-toggle');
    const rememberMeCheckbox = document.getElementById('remember-me');
    const errorMsgDiv = document.getElementById('login-error-msg');
    
    if (sessionStorage.getItem(SESSION_KEY) === 'true') {
        loginContainer.style.display = 'none';
        appContainer.classList.remove('hidden');
        firebase.auth().signInAnonymously().then(() => {
            initializeAppLogic();
        }).catch(err => {
            console.error("Anonymous sign-in failed on session restore:", err);
            errorMsgDiv.textContent = 'Authentication session restore failed.';
            loginContainer.style.display = 'flex';
            appContainer.classList.add('hidden');
        });
        return;
    }

    passwordToggle.addEventListener('click', () => {
        const isPassword = passwordInput.type === 'password';
        passwordInput.type = isPassword ? 'text' : 'password';
        passwordToggle.textContent = isPassword ? '🙈' : '👁️';
    });

    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = usernameInput.value;
        const password = passwordInput.value;
        errorMsgDiv.textContent = '';

        try {
            await firebase.auth().signInAnonymously();
            const snapshot = await credsRef.once('value');
            let correctCreds = snapshot.exists() ? snapshot.val() : { username: "ashik'smathhome@602", password: "jaleswaritolamath25" };
            if (!snapshot.exists()) await credsRef.set(correctCreds);

            if (username === correctCreds.username && password === correctCreds.password) {
                if (rememberMeCheckbox.checked) {
                    localStorage.setItem(REMEMBER_KEY, JSON.stringify({ user: username, pass: password }));
                } else {
                    localStorage.removeItem(REMEMBER_KEY);
                }
                sessionStorage.setItem(SESSION_KEY, 'true'); 
                loginContainer.style.display = 'none';
                appContainer.classList.remove('hidden');
                initializeAppLogic();
            } else {
                errorMsgDiv.textContent = 'ইউজারনেম বা পাসওয়ার্ড সঠিক নয়।';
                firebase.auth().signOut();
            }
        } catch (error) {
            console.error("Firebase login error:", error);
            errorMsgDiv.textContent = 'ডাটাবেস কানেক্ট করা যায়নি বা অনুমতি নেই।';
            if (firebase.auth().currentUser) firebase.auth().signOut();
        }
    });

    const rememberedCreds = localStorage.getItem(REMEMBER_KEY);
    if (rememberedCreds) {
        try {
            const creds = JSON.parse(rememberedCreds);
            usernameInput.value = creds.user;
            passwordInput.value = creds.pass;
            rememberMeCheckbox.checked = true;
        } catch(e) {
            localStorage.removeItem(REMEMBER_KEY);
        }
    }
});

// ======================================================= //
//          MAIN APPLICATION SCRIPT START                  //
// ======================================================= //
function initializeAppLogic() {
    const mainContentArea = document.getElementById('dynamic-content-placeholder');
    const bannerPlaceholder = document.getElementById('banner-area-placeholder');
    const breadcrumbContainer = document.getElementById('breadcrumb-container');
    const btnHome = document.getElementById('btnHome');
    const btnDashboard = document.getElementById('btnDashboard');
    const btnBatch = document.getElementById('btnBatch');
    const btnPayment = document.getElementById('btnPayment');
    const btnStudentDatabase = document.getElementById('btnStudentDatabase');
    const btnReports = document.getElementById('btnReports');
    const btnExam = document.getElementById('btnExam');
    const btnAttendance = document.getElementById('btnAttendance');
    const btnSms = document.getElementById('btnSms');
    const btnToggleMode = document.getElementById('btnToggleMode');
    const currentModeDisplay = document.getElementById('currentModeDisplay');
    const btnPrivacyMenu = document.getElementById('btnPrivacyMenu');
    const privacyDropdown = document.getElementById('privacyDropdown');
    const btnToggleYearBar = document.getElementById('btnToggleYearBar');
    const btnChangePassword = document.getElementById('btnChangePassword');
    const btnForgotPassword = document.getElementById('btnForgotPassword');
    const btnShowHistory = document.getElementById('btnShowHistory');
    const btnRecycleBin = document.getElementById('btnRecycleBin');
    const btnFindTrnxId = document.getElementById('btnFindTrnxId');
    const btnClearYearData = document.getElementById('btnClearYearData');
    const btnToggleTheme = document.getElementById('btnToggleTheme');
    const btnBackupMenuToggle = document.getElementById('btnBackupMenuToggle');
    const backupSubMenu = document.getElementById('backupSubMenu');
    const btnExportData = document.getElementById('btnExportData');
    const btnImportData = document.getElementById('btnImportData');
    const fileImporter = document.getElementById('fileImporter');
    const btnNavBack = document.getElementById('btnNavBack');
    const btnNavForward = document.getElementById('btnNavForward');
    const btnNavRefresh = document.getElementById('btnNavRefresh');
    const btnLogout = document.getElementById('btnLogout');
    const btnAboutDeveloper = document.getElementById('btnAboutDeveloper');
    let bulkStudentImportInput, btnBulkImport;

    let isAdminMode = sessionStorage.getItem('isAdminMode') === 'true';
    let currentPassword = '';
    let viewedYear = new Date().getFullYear();
    let activeYear = new Date().getFullYear();
    let availableYears = [];
    let dbRef;
    let smsManagementData = {};
    const resetDefaultPassword = 'rafi@602';
    const THEME_KEY = 'gonitAppTheme';
    const YEAR_BAR_HIDDEN_KEY = 'mcth_year_bar_hidden';
    const LAST_RECEIVER_NAME_KEY = 'mcth_last_receiver_name'; 
    let appData = {};
    let isSaving = false; 
    let dataLoaded = false; 

    let currentStudentContext = null;
    let pageHistory = [];
    let historyIndex = -1;
    const BENGALI_MONTHS=["জানুয়ারি","ফেব্রুয়ারি","মার্চ","এপ্রিল","মে","জুন","জুলাই","আগস্ট","সেপ্টেম্বর","অক্টোবর","নভেম্বর","ডিসেম্বর"];
    
    // UTILITY & HELPER FUNCTIONS
    async function processAndCompressImage(source, targetSizeKB = 300) {
        const MAX_SIZE_BYTES = targetSizeKB * 1024;
        const sourceUrl = (source instanceof Blob || source instanceof File) ? URL.createObjectURL(source) : source;

        return new Promise((resolve, reject) => {
            const img = new Image();
            img.src = sourceUrl;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                let width = img.width;
                let height = img.height;
                const MAX_DIMENSION = 1024;

                if (width > height) {
                    if (width > MAX_DIMENSION) {
                        height *= MAX_DIMENSION / width;
                        width = MAX_DIMENSION;
                    }
                } else {
                    if (height > MAX_DIMENSION) {
                        width *= MAX_DIMENSION / height;
                        height = MAX_DIMENSION;
                    }
                }
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                URL.revokeObjectURL(sourceUrl);

                let quality = 0.9;
                let dataUrl = canvas.toDataURL('image/jpeg', quality);
                while (dataUrl.length * 0.75 > MAX_SIZE_BYTES && quality > 0.1) {
                    quality -= 0.1;
                    dataUrl = canvas.toDataURL('image/jpeg', quality);
                }
                if (dataUrl.length * 0.75 > MAX_SIZE_BYTES) {
                    return reject(new Error(`ছবিটি ${targetSizeKB}KB এর নিচে আনা সম্ভব হয়নি।`));
                }
                resolve(dataUrl);
            };
            img.onerror = error => {
                URL.revokeObjectURL(sourceUrl);
                reject(error);
            };
        });
    }

    let activeCameraStream = null;
    function showCameraModal(onCapture) {
        const modalFragment = cloneTemplate('template-camera-modal');
        if (!modalFragment) {
            showToast('ক্যামেরা ফিচারটি পাওয়া যায়নি।', 'error');
            return;
        }
        document.body.appendChild(modalFragment);
        const modal = document.getElementById('cameraModal');
        const video = document.getElementById('camera-video-feed');
        const canvas = document.getElementById('camera-canvas');
        const captureBtn = document.getElementById('capture-photo-btn');
        const closeBtn = modal.querySelector('.close-button');

        const stopCamera = () => { if (activeCameraStream) { activeCameraStream.getTracks().forEach(track => track.stop()); activeCameraStream = null; } };
        const closeModal = () => { stopCamera(); modal.remove(); };

        closeBtn.onclick = closeModal;
        modal.onclick = (e) => { if (e.target === modal) closeModal(); };

        navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } })
            .then(stream => { activeCameraStream = stream; video.srcObject = stream; modal.classList.add('visible'); })
            .catch(err => { console.error("Error accessing camera:", err); showToast('ক্যামেরা চালু করা যায়নি। অনুগ্রহ করে পারমিশন চেক করুন।', 'error'); closeModal(); });

        captureBtn.onclick = () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
            canvas.toBlob(blob => { if (onCapture) { onCapture(blob); } closeModal(); }, 'image/jpeg');
        };
    }

    function handleImageError(imgElement) { if (imgElement.src.includes('default_avatar.png')) return; imgElement.src = 'images/default_avatar.png'; }
    function getDbRefForYear(year) { return db.ref(`academicYears/${year}/data`); }
    function paymentIsDue(monthIndex, year) { const now = new Date(); const currentMonthIndex = now.getMonth(); const currentYear = now.getFullYear(); const dueDateThreshold = 10; if (year < currentYear) return true; if (year > currentYear) return false; if (monthIndex < currentMonthIndex) return true; if (monthIndex > currentMonthIndex) return false; return now.getDate() > dueDateThreshold; }
    function isStudentDue(student, year) { if (!student || !student.monthlyPayments) return false; if (student.admissionFee?.status !== 'paid' && student.admissionFee?.amount > 0) return true; const admissionDate = student.createdAt ? new Date(student.createdAt) : new Date(year, 0, 1); for (let i = 0; i < 12; i++) { const monthDate = new Date(year, i, 1); if (monthDate < new Date(admissionDate.getFullYear(), admissionDate.getMonth(), 1)) continue; const monthName = BENGALI_MONTHS[i]; const payment = student.monthlyPayments[monthName]; const defaultFee = student.monthlyFeeDefault || 0; const isMonthCurrentlyDue = paymentIsDue(i, year); if (isMonthCurrentlyDue && ((payment && payment.status !== 'paid' && payment.fee > 0) || (!payment && defaultFee > 0))) { return true; } } return false; }
    function calculateStudentOutstandingAmount(student, year) { let totalDue = 0; if(!student || !student.monthlyPayments) return 0; const admissionDate = student.createdAt ? new Date(student.createdAt) : new Date(year, 0, 1); if (student.admissionFee && student.admissionFee.status !== 'paid' && student.admissionFee.amount > 0) { totalDue += student.admissionFee.amount; } for (let i = 0; i < 12; i++) { const monthDate = new Date(year, i, 1); if (monthDate < new Date(admissionDate.getFullYear(), admissionDate.getMonth(), 1)) continue; const monthName = BENGALI_MONTHS[i]; const payment = student.monthlyPayments[monthName]; const defaultFee = student.monthlyFeeDefault || 0; const isMonthCurrentlyDue = paymentIsDue(i, year); if (isMonthCurrentlyDue) { if (payment && payment.status !== 'paid' && payment.fee > 0) { totalDue += payment.fee; } else if (!payment && defaultFee > 0) { totalDue += defaultFee; } } } return totalDue; }
    function calculateOverdueMonths(student, year) { const overdueMonthsList = []; if(!student || !student.monthlyPayments) return ""; const admissionDate = student.createdAt ? new Date(student.createdAt) : new Date(year, 0, 1); for (let i = 0; i < 12; i++) { const monthDate = new Date(year, i, 1); if (monthDate < new Date(admissionDate.getFullYear(), admissionDate.getMonth(), 1)) continue; const monthName = BENGALI_MONTHS[i]; const payment = student.monthlyPayments[monthName]; const defaultFee = student.monthlyFeeDefault || 0; const isMonthCurrentlyDue = paymentIsDue(i, year); let hasOutstanding = false; if (isMonthCurrentlyDue) { if ((payment && payment.status !== 'paid' && payment.fee > 0) || (!payment && defaultFee > 0)) { hasOutstanding = true; } } if (hasOutstanding) { overdueMonthsList.push(monthName); } } return overdueMonthsList.join(', '); }
    function showToast(message, type = 'info', duration = 3000) { const container = document.getElementById('toast-container'); if (!container) return; const toast = document.createElement('div'); toast.className = `toast ${type}`; toast.textContent = message; container.appendChild(toast); setTimeout(() => toast.classList.add('show'), 10); setTimeout(() => { toast.classList.remove('show'); toast.addEventListener('transitionend', () => toast.remove()); }, duration); }
    function showLoader() { const l = document.getElementById('loader-overlay'); if(l) l.style.display = 'flex'; }
    function hideLoader() { const l = document.getElementById('loader-overlay'); if(l) l.style.display = 'none'; }
    function applyTheme(theme) { const themeIcon = document.getElementById('themeIcon'); document.body.setAttribute('data-theme', theme); if(themeIcon) themeIcon.textContent = theme === 'dark' ? '☀️' : '🌙'; }
    function toggleTheme() { const currentTheme = document.body.getAttribute('data-theme') || 'light'; const newTheme = currentTheme === 'light' ? 'dark' : 'light'; localStorage.setItem(THEME_KEY, newTheme); applyTheme(newTheme); }
    
    // FIREBASE DATA HANDLING
    async function getCombinedDataForAllYears() { const academicYearsRef = db.ref('academicYears'); const snapshot = await academicYearsRef.once('value'); if (!snapshot.exists()) return { students: [], activityLog: [], classes: [] }; const yearsData = snapshot.val(); const yearKeys = Object.keys(yearsData); const promises = yearKeys.map(year => getDbRefForYear(year).once('value')); const yearSnapshots = await Promise.all(promises); const combinedData = { students: [], activityLog: [], classes: [] }; yearSnapshots.forEach((yearSnap, index) => { const year = yearKeys[index]; const data = yearSnap.val(); if (data) { if (data.students) { combinedData.students.push(...data.students.map(s => ({ ...s, academicYear: year }))); } if (data.activityLog) { combinedData.activityLog.push(...data.activityLog.map(log => ({ ...log, academicYear: year }))); } if(data.mainClassCategories) { combinedData.classes.push(...data.mainClassCategories); } } }); const uniqueClasses = Array.from(new Map(combinedData.classes.map(item => [item.id, item])).values()); combinedData.classes = uniqueClasses; return combinedData; }
    function getInitialDataStructure() { return { currentPassword: 'ashik@602', mainClassCategories: [ { id: 'c_1', name: 'ক্লাস ৬', defaultMonthlyFee: 300, defaultAdmissionFee: 500 }, { id: 'c_2', name: 'ক্লাস ৭', defaultMonthlyFee: 350, defaultAdmissionFee: 500 }, { id: 'c_3', name: 'ক্লাস ৮', defaultMonthlyFee: 400, defaultAdmissionFee: 500 }, { id: 'c_4', name: 'ক্লাস ৯', defaultMonthlyFee: 450, defaultAdmissionFee: 600 }, { id: 'c_5', name: 'ক্লাস ১০', defaultMonthlyFee: 500, defaultAdmissionFee: 600 }, ], students: [], batchSchedule: [ { id: 'd_1', dayName: 'শনিবার', classes: [{ id: 'cs_1', classId: 'c_1', batches: [{ id: 'b_1', time: 'বিকাল ৪:00 - ৫:00', capacity: 50, studentIds: [] }] }] }, { id: 'd_2', dayName: 'রবিবার', classes: [{ id: 'cs_2', classId: 'c_2', batches: [{ id: 'b_2', time: 'বিকাল ৪:00 - ৫:00', capacity: 50, studentIds: [] }] }] }, { id: 'd_3', dayName: 'সোমবার', classes: [{ id: 'cs_3', classId: 'c_3', batches: [{ id: 'b_3', time: 'বিকাল ৪:00 - ৫:00', capacity: 50, studentIds: [] }] }] }, { id: 'd_4', dayName: 'মঙ্গলবার', classes: [{ id: 'cs_4', classId: 'c_4', batches: [{ id: 'b_4', time: 'বিকাল ৫:00 - ৬:00', capacity: 40, studentIds: [] }] }] }, { id: 'd_5', dayName: 'বুধবার', classes: [{ id: 'cs_5', classId: 'c_5', batches: [{ id: 'b_5', time: 'বিকাল ৫:00 - ৬:00', capacity: 40, studentIds: [] }] }] } ], nextRollNumber: 1, activityLog: [], recycleBin: { students: [], mainClassCategories: [], batchSchedule: [] } }; }
    async function saveAppData() { if (!appData || !dataLoaded || isSaving) return; isSaving = true; try { appData.currentPassword = currentPassword; await dbRef.set(appData); } catch (e) { console.error("Error saving data to Firebase:", e); showToast("ডেটা সংরক্ষণ করতে সমস্যা হয়েছে!", 'error'); } finally { isSaving = false; hideLoader(); } }

    function loadAppData(yearToLoad) {
        showLoader();
        viewedYear = yearToLoad;
        localStorage.setItem('mcth_viewed_year', viewedYear);
    
        if (dbRef && typeof dbRef.off === 'function') {
            dbRef.off();
        }
    
        dbRef = getDbRefForYear(yearToLoad);
    
        dbRef.on('value', (dataSnapshot) => {
            if (isSaving) {
                return;
            }
            
            if (dataSnapshot.exists()) {
                appData = dataSnapshot.val();
                if (!appData.students) appData.students = [];
                if (!appData.mainClassCategories) appData.mainClassCategories = []; 
                if (!appData.batchSchedule) appData.batchSchedule = [];
                if (!appData.recycleBin) appData.recycleBin = { students: [], mainClassCategories: [], batchSchedule: [] };
                if (appData.activityLog && !Array.isArray(appData.activityLog)) {
                    appData.activityLog = Object.values(appData.activityLog);
                } else if (!appData.activityLog) {
                    appData.activityLog = [];
                }

                (appData.students || []).forEach(s => { if (s) { if(!s.createdAt) s.createdAt = new Date(yearToLoad, 0, 1).toISOString(); if (!s.monthlyPayments) s.monthlyPayments = {}; if (!s.admissionFee) s.admissionFee = { amount: 0, status: 'due', receiver: '', date: null, token: null }; } });
                currentPassword = appData.currentPassword || 'ashik@602';
            } else {
                console.log(`No data for year ${yearToLoad}. Initializing...`);
                appData = getInitialDataStructure();
                currentPassword = appData.currentPassword;
                dbRef.set(appData); 
            }
            
            updateYearSelectorUI();

            if (!dataLoaded) {
                dataLoaded = true;
                const sessionState = sessionStorage.getItem('mcth_session_state');
                if (sessionState) {
                    try {
                        const { page, context } = JSON.parse(sessionState);
                        pageHistory = [{ page, context }]; 
                        historyIndex = 0;
                        if(window[page]) {
                           loadPage(window[page], context, true);
                        } else {
                           loadPage(showHomePage, {});
                        }
                    } catch (e) {
                        loadPage(showHomePage, {});
                    }
                } else {
                    loadPage(showHomePage, {});
                }
            } else {
                const currentState = pageHistory[historyIndex];
                if (currentState && window[currentState.page]) {
                    loadPage(window[currentState.page], currentState.context, true); 
                }
            }
            if(dataLoaded) hideLoader();

        }, (error) => { 
            console.error("Firebase read failed: " + error.code, error.message); 
            showToast("ডাটাবেস কানেক্ট করা যায়নি। Rules চেক করুন।", "error"); 
            hideLoader(); 
        });
    }

    function generateNextRollNumber(){ const roll = appData.nextRollNumber || 1; appData.nextRollNumber = roll + 1; return String(roll).padStart(2, '0'); }
    function generateToken() { return `MCAI-${Math.random().toString(36).substring(2, 7).toUpperCase()}`; }
    function logActivity(message, details = {}) { if (!appData.activityLog) { appData.activityLog = []; } appData.activityLog.unshift({ timestamp: new Date().toISOString(), message, ...details }); if (appData.activityLog.length > 200) appData.activityLog.pop(); }
    function handleExport(){ if (!appData) { showToast('কোনো ডেটা এক্সপোর্ট করার জন্য পাওয়া যায়নি।', 'error'); return; } try { const dataStr = JSON.stringify(appData, null, 2); const dataBlob = new Blob([dataStr], { type: 'application/json' }); const url = URL.createObjectURL(dataBlob); const link = document.createElement('a'); link.href = url; link.download = `miracle_backup_${viewedYear}_${new Date().toISOString().split('T')[0]}.json`; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url); showToast(`শিক্ষাবর্ষ ${viewedYear} এর ডেটা এক্সপোর্ট করা হয়েছে।`, 'success'); } catch (e) { console.error('Error exporting data:', e); showToast('ডেটা এক্সপোর্ট করার সময় একটি সমস্যা হয়েছে।', 'error'); } }
    function handleImport(event){ const file = event.target.files[0]; if (!file) return; if (!confirm(`আপনি কি নিশ্চিত যে বর্তমান শিক্ষাবর্ষ (${viewedYear}) এর সমস্ত ডেটা মুছে ফেলে ফাইল থেকে নতুন ডেটা লোড করতে চান? এই কাজটি আর ফেরানো যাবে না।`)) { event.target.value = ''; return; } const reader = new FileReader(); reader.onload = (e) => { try { const importedData = JSON.parse(e.target.result); const isValid = importedData && typeof importedData.currentPassword === 'string' && Array.isArray(importedData.students); if (isValid) { showLoader(); appData = importedData; dbRef.set(appData).then(() => { showToast(`শিক্ষাবর্ষ ${viewedYear} এ ডেটা সফলভাবে ইম্পোর্ট ও সিঙ্ক করা হয়েছে।`, 'success'); hideLoader(); }); } else { showToast('ফাইলের ডেটা সঠিক ফরম্যাটে নেই।', 'error'); } } catch (error) { console.error('Error parsing imported file:', error); showToast('ফাইলটি পড়তে সমস্যা হয়েছে।', 'error'); } finally { event.target.value = ''; } }; reader.readAsText(file); }
    function findStudentById(studentId){ return (appData.students || []).find(s => s && s.id === studentId) || null; }
    function findClassById(classId){ return (appData.mainClassCategories || []).find(c => c && c.id === classId) || null; }
    function findBatchById(batchId){ if (!appData.batchSchedule) return null; for(const day of appData.batchSchedule){ if(!day || day.deletedAt || !day.classes) continue; for(const cls of day.classes){ if(!cls || cls.deletedAt || !cls.batches) continue; const batch = cls.batches.find(b => b && b.id === batchId); if(batch) return {batch, classSchedule: cls, day}; } } return null; }
    function findBatchesForStudent(studentId){ const foundBatches = []; if (!appData.batchSchedule) return foundBatches; appData.batchSchedule.forEach(day => { if(!day || day.deletedAt || !day.classes) return; day.classes.forEach(classSchedule => { if(!classSchedule || classSchedule.deletedAt || !classSchedule.batches) return; classSchedule.batches.forEach(batch => { if(batch && batch.studentIds && batch.studentIds.includes(studentId)){ const classInfo = findClassById(classSchedule.classId); foundBatches.push({ id: batch.id, day: day.dayName, className: classInfo?.name || 'Unknown', time: batch.time, classId: classSchedule.classId }); } }); }); }); return foundBatches; }
    function updateAdminModeUI(){ document.body.classList.toggle('admin-mode-active', isAdminMode); currentModeDisplay.textContent = isAdminMode ? 'Admin' : 'Assistant'; currentModeDisplay.classList.toggle('admin-active', isAdminMode); currentModeDisplay.classList.toggle('assistant-active', !isAdminMode); btnToggleMode.textContent = isAdminMode ? 'Exit' : 'Admin'; document.querySelectorAll('.admin-only').forEach(el => el.classList.toggle('hidden', !isAdminMode)); document.querySelectorAll('.assistant-disabled').forEach(el => { el.disabled = !isAdminMode; }); sessionStorage.setItem('isAdminMode', isAdminMode); }
    function loadPage(pageFunction, context = {}, isNavigating = false) { if (!isNavigating) { const state = { page: pageFunction.name, context }; if (historyIndex < pageHistory.length - 1) { pageHistory = pageHistory.slice(0, historyIndex + 1); } pageHistory.push(state); historyIndex = pageHistory.length - 1; } const stateToSave = { page: pageFunction.name, context: context }; sessionStorage.setItem('mcth_session_state', JSON.stringify(stateToSave)); breadcrumbContainer.innerHTML = ''; if (context.breadcrumbs) { context.breadcrumbs.forEach((crumb, index) => { const crumbElement = document.createElement('a'); crumbElement.href = '#'; crumbElement.textContent = crumb.text; crumbElement.onclick = (e) => { e.preventDefault(); const navState = pageHistory.find(p => p.page === crumb.pageFn.name); if(navState) { loadPage(crumb.pageFn, navState.context, true); } else if (crumb.pageFn) { loadPage(crumb.pageFn, crumb.context || {}, true); } }; breadcrumbContainer.appendChild(crumbElement); if (index < context.breadcrumbs.length - 1) { breadcrumbContainer.append(' / '); } }); } mainContentArea.innerHTML = ''; bannerPlaceholder.style.display = 'none'; try { if (typeof pageFunction === 'function') { pageFunction(context); } else { mainContentArea.innerHTML = `<p style="color:red; text-align:center;">ত্রুটি: পৃষ্ঠাটি খুঁজে পাওয়া যায়নি।</p>`; } } catch (e) { console.error("Error loading page:", e, "Context:", context); mainContentArea.innerHTML = `<p style="color:red; text-align:center;">দুঃখিত, এই পৃষ্ঠাটি লোড করার সময় একটি ত্রুটি ঘটেছে।</p>`; } updateAdminModeUI(); updateNavButtons(); }
    function updateNavButtons() { const backIcon = document.querySelector('#btnNavBack .nav-icon-svg'); const forwardIcon = document.querySelector('#btnNavForward .nav-icon-svg'); if(backIcon) backIcon.classList.toggle('disabled', historyIndex <= 0); if(forwardIcon) forwardIcon.classList.toggle('disabled', historyIndex >= pageHistory.length - 1); }
    function cloneTemplate(templateId){ return document.getElementById(templateId)?.content.cloneNode(true); }
    function closeDropdownAndRun(action){ privacyDropdown.classList.remove('active'); backupSubMenu.classList.remove('open'); btnBackupMenuToggle.classList.remove('open'); if(action) action(); }
    
    function listenForSmsSettingsChanges() {
        const smsManagementRef = db.ref('smsManagement');
        smsManagementRef.on('value', (snapshot) => {
            if (snapshot.exists()) {
                smsManagementData = snapshot.val();
                console.log('SMS settings updated in real-time:', smsManagementData);
            } else {
                smsManagementData = { automation: {} };
            }
        });
    }

    // PAGE RENDERING FUNCTIONS
    let sliderInterval; function showHomePage(context = {}) { context.breadcrumbs = [{ text: 'হোম', pageFn: showHomePage }]; bannerPlaceholder.innerHTML = '<img src="images/image1.png" alt="Main Banner" onerror="this.style.display=\'none\';">'; bannerPlaceholder.style.display = 'block'; mainContentArea.appendChild(cloneTemplate('template-home')); const slider = document.getElementById('homeImageSlider'); let currentImage = 3; if(sliderInterval) clearInterval(sliderInterval); if(slider) { sliderInterval = setInterval(() => { slider.style.opacity = 0; setTimeout(() => { currentImage = currentImage === 3 ? 4 : 3; slider.src = `images/image${currentImage}.png`; slider.style.opacity = 1; }, 1000); }, 4000); } }
    
    function showDashboardPage(context = {}) {
        context.breadcrumbs = [{ text: 'হোম', pageFn: showHomePage }, { text: 'ড্যাশবোর্ড' }];
        mainContentArea.appendChild(cloneTemplate('template-dashboard'));
        const grid = document.querySelector('.dashboard-grid');
        if (!grid) return;

        grid.innerHTML = `
            <div class="dashboard-card card-students" title="শুধুমাত্র ${viewedYear} শিক্ষাবর্ষের ছাত্র-ছাত্রী"><h4>মোট ছাত্র-ছাত্রী (${viewedYear})</h4><p class="stat-number" id="db-total-students">...</p></div>
            <div class="dashboard-card card-batches" title="শুধুমাত্র ${viewedYear} শিক্ষাবর্ষের ব্যাচ"><h4>সক্রিয় ব্যাচ (${viewedYear})</h4><p class="stat-number" id="db-active-batches">...</p></div>
            <div class="dashboard-card card-collection" title="সকল শিক্ষাবর্ষ মিলিয়ে"><h4>চলতি মাসের আয় (সব)</h4><p class="stat-number" id="db-month-income">... ৳</p><button class="details-button" data-type="collection" disabled>বিস্তারিত</button></div>
            <div class="dashboard-card card-due" title="শুধুমাত্র ${viewedYear} শিক্ষাবর্ষের বকেয়া"><h4>মোট বকেয়া (${viewedYear})</h4><p class="stat-number" id="db-total-due">... ৳</p><button class="details-button" data-type="due" disabled>বিস্তারিত</button></div>
            <div class="dashboard-card card-paid-students" title="সকল শিক্ষাবর্ষ মিলিয়ে"><h4>পরিশোধকৃত ছাত্র (সব)</h4><p class="stat-number" id="db-paid-students">...</p></div>
            <div class="dashboard-card card-due-students" title="সকল শিক্ষাবর্ষ মিলিয়ে"><h4>বকেয়া থাকা ছাত্র (সব)</h4><p class="stat-number" id="db-due-students">...</p></div>
        `;

        const totalStudentsThisYear = (appData.students || []).filter(s => s && !s.deletedAt).length;
        const activeBatchesThisYear = (appData.batchSchedule || [])
            .flatMap(day => (day.classes || []))
            .filter(cls => !cls.deletedAt)
            .flatMap(cls => (cls.batches || []))
            .filter(batch => !batch.deletedAt).length;
        
        document.getElementById('db-total-students').textContent = totalStudentsThisYear.toLocaleString('bn-BD');
        document.getElementById('db-active-batches').textContent = activeBatchesThisYear.toLocaleString('bn-BD');
        
        let studentsWithDuesForDetails_ThisYear = [];
        let currentMonthIncomeDetails = [];

        getCombinedDataForAllYears().then(combinedData => {
            const allStudents = combinedData.students;
            const allClassCategories = combinedData.classes;
            
            let totalStudentsWithAnyDues = 0;
            let totalOutstandingAmountThisYear = 0;
            let currentMonthIncome = 0;

            const now = new Date();
            const currentMonthIndex = now.getMonth();
            const currentBengaliMonth = BENGALI_MONTHS[currentMonthIndex];

            (allStudents || []).forEach(student => {
                if (!student || student.deletedAt) return;
                const studentYear = parseInt(student.academicYear);
                const studentDueAmount = calculateStudentOutstandingAmount(student, studentYear);
                if (studentDueAmount > 0) {
                    totalStudentsWithAnyDues++;
                }
            });
            const paidStudentsCountOverall = (allStudents || []).filter(s => s && !s.deletedAt).length - totalStudentsWithAnyDues;
            
            (appData.students || []).filter(s => s && !s.deletedAt).forEach(student => {
                const studentDueAmount = calculateStudentOutstandingAmount(student, viewedYear);
                if (studentDueAmount > 0) {
                    totalOutstandingAmountThisYear += studentDueAmount;
                    const classInfo = findClassById(student.classId);
                    let batchInfoString = findBatchesForStudent(student.id).map(b => `${b.day.substring(0,3)} (${b.time})`).join(', ') || 'N/A';
                    studentsWithDuesForDetails_ThisYear.push({ id: student.id, name: student.name, roll: student.roll, classId: student.classId, class: classInfo?.name || 'N/A', totalDueAmount: studentDueAmount, overdueMonths: calculateOverdueMonths(student, viewedYear), academicYear: viewedYear, batchInfo: batchInfoString });
                }
            });
            
            allStudents.forEach(student => {
                 if (!student || student.deletedAt) return;
                 const classInfo = allClassCategories.find(c => c.id === student.classId);
                
                if (student.admissionFee?.status === 'paid' && student.admissionFee.date) {
                    const admissionDate = new Date(student.admissionFee.date);
                    if (admissionDate.getMonth() === currentMonthIndex && admissionDate.getFullYear() === now.getFullYear()) {
                        currentMonthIncome += (student.admissionFee.amount || 0);
                        currentMonthIncomeDetails.push({ studentId: student.id, name: student.name, roll: student.roll, classId: student.classId, class: classInfo?.name || 'N/A', amount: student.admissionFee.amount, type: 'ভর্তি ফি', academicYear: student.academicYear });
                    }
                }
                const payment = (student.monthlyPayments || {})[currentBengaliMonth];
                if (payment && payment.status === 'paid' && payment.date) {
                    const paymentDate = new Date(payment.date);
                    if (paymentDate.getMonth() === currentMonthIndex && paymentDate.getFullYear() === now.getFullYear()) {
                        currentMonthIncome += (payment.fee || 0);
                        currentMonthIncomeDetails.push({ studentId: student.id, name: student.name, roll: student.roll, classId: student.classId, class: classInfo?.name || 'N/A', amount: payment.fee, type: `মাসিক ফি (${currentBengaliMonth})`, academicYear: student.academicYear });
                    }
                }
            });

            document.getElementById('db-month-income').textContent = `${currentMonthIncome.toLocaleString('bn-BD')} ৳`;
            document.getElementById('db-total-due').textContent = `${totalOutstandingAmountThisYear.toLocaleString('bn-BD')} ৳`;
            document.getElementById('db-paid-students').textContent = paidStudentsCountOverall.toLocaleString('bn-BD');
            document.getElementById('db-due-students').textContent = totalStudentsWithAnyDues.toLocaleString('bn-BD');
            
            document.querySelector('[data-type="collection"]').disabled = false;
            document.querySelector('[data-type="due"]').disabled = false;

        }).catch(err => {
            console.error("Error loading full dashboard data:", err);
            ['db-month-income', 'db-total-due', 'db-paid-students', 'db-due-students'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = 'Error';
            });
        });

        grid.addEventListener('click', (e) => {
            if (e.target.classList.contains('details-button') && !e.target.disabled) {
                const type = e.target.dataset.type;
                const dataToShow = type === 'due' ? studentsWithDuesForDetails_ThisYear : currentMonthIncomeDetails;
                loadPage(showDashboardDetailsPage, { type, breadcrumbs: [...context.breadcrumbs, { text: 'বিস্তারিত তালিকা' }], detailedData: dataToShow });
            }
        });
    }

    function showDashboardDetailsPage({ type, breadcrumbs, detailedData }) { mainContentArea.appendChild(cloneTemplate('template-dashboard-details-page')); const now = new Date(); const currentBengaliMonth = BENGALI_MONTHS[now.getMonth()]; let pageTitle = ''; if (type === 'collection') { pageTitle = `চলতি মাসের (${currentBengaliMonth}) পরিশোধিত তালিকা (সকল শিক্ষাবর্ষ)`; } else if (type === 'due') { pageTitle = `শিক্ষাবর্ষ ${viewedYear} এর সকল বকেয়ার তালিকা`; } document.getElementById('detailsListPageTitle').textContent = pageTitle; const classFilter = document.getElementById('detailsPageClassFilter'); const batchFilter = document.getElementById('detailsPageBatchFilter'); const tableBody = document.getElementById('detailsPageTableBody'); const summaryDiv = document.getElementById('detailsPageSummary'); const originalDetailedData = detailedData; function renderTable(dataToRender) { tableBody.innerHTML = ''; if (!dataToRender || dataToRender.length === 0) { tableBody.innerHTML = `<tr><td colspan="7" style="text-align: center;">কোনো তথ্য খুঁজে পাওয়া যায়নি।</td></tr>`; summaryDiv.textContent = ''; return; } let totalAmount = 0; let studentCountSet = new Set(); dataToRender.sort((a, b) => (parseInt(a.roll, 10) || 0) - (parseInt(b.roll, 10) || 0)); dataToRender.forEach((s, index) => { const tr = document.createElement('tr'); const studentYear = parseInt(s.academicYear); const yearLabel = studentYear !== viewedYear && type === 'collection' ? ` (${s.academicYear})` : ''; let rowHtml = `<td class="serial-number-column">${index + 1}.</td> <td><strong>${s.name}${yearLabel}</strong></td> <td><strong>${s.roll}</strong></td> <td><strong>${s.class || 'N/A'}</strong></td> <td>${s.batchInfo || 'N/A'}</td>`; if (type === 'collection') { rowHtml += `<td>${s.type}</td> <td style="text-align:right; padding-right:15px;">${(s.amount || 0).toLocaleString('bn-BD')}</td>`; totalAmount += (s.amount || 0); } else { rowHtml += `<td><strong>${s.totalDueAmount ? s.totalDueAmount.toLocaleString('bn-BD') : 'N/A'}</strong></td> <td title="${s.overdueMonths}">${s.overdueMonths ? s.overdueMonths.split(', ').slice(0, 2).join(', ') + (s.overdueMonths.split(', ').length > 2 ? '...' : '') : 'N/A'}</td>`; totalAmount += s.totalDueAmount; studentCountSet.add(s.id); } tr.innerHTML = rowHtml; tableBody.appendChild(tr); }); if (type === 'due') { summaryDiv.innerHTML = `মোট ছাত্র: ${studentCountSet.size} জন | মোট পরিমাণ: ${totalAmount.toLocaleString('bn-BD')} টাকা`; } else { summaryDiv.innerHTML = `মোট কালেকশন: ${totalAmount.toLocaleString('bn-BD')} টাকা`; } } function populateBatchFilter(selectedClassId) { batchFilter.innerHTML = '<option value="">সব ব্যাচ</option>'; batchFilter.disabled = true; if (!selectedClassId) return; const studentsInClass = originalDetailedData.filter(s => s.classId === selectedClassId); const batches = new Set(); studentsInClass.forEach(s => { if (s.batchInfo && s.batchInfo !== 'N/A') { s.batchInfo.split(', ').forEach(batchName => batches.add(batchName.trim())); } }); batches.forEach(batchName => { const option = document.createElement('option'); option.value = batchName; option.textContent = batchName; batchFilter.appendChild(option); }); if (batches.size > 0) { batchFilter.disabled = false; } } function populateClassFilter() { classFilter.innerHTML = '<option value="">সব ক্লাস</option>'; const classes = new Map(); originalDetailedData.forEach(s => { if (!classes.has(s.classId)) { classes.set(s.classId, s.class); } }); classes.forEach((name, id) => { const option = document.createElement('option'); option.value = id; option.textContent = name; classFilter.appendChild(option); }); } function applyFiltersAndRender() { const selectedClassId = classFilter.value; const selectedBatch = batchFilter.value; let filteredData = [...originalDetailedData]; if (selectedClassId) { filteredData = filteredData.filter(s => s.classId === selectedClassId); } if (selectedBatch) { filteredData = filteredData.filter(s => s.batchInfo && s.batchInfo.includes(selectedBatch)); } renderTable(filteredData); } classFilter.addEventListener('change', () => { populateBatchFilter(classFilter.value); applyFiltersAndRender(); }); batchFilter.addEventListener('change', applyFiltersAndRender); const headerCol6 = document.getElementById('headerCol6'); const headerCol7 = document.getElementById('headerCol7'); if (type === 'collection') { headerCol6.textContent = 'পেমেন্টের ধরণ'; headerCol7.textContent = 'পরিশোধিত টাকা'; } else { headerCol6.textContent = 'মোট বকেয়া (টাকা)'; headerCol7.textContent = 'বকেয়া মাসসমূহ'; } document.getElementById('paymentTypeFilter').style.display = 'none'; document.getElementById('btnPrintDetailsList').onclick = () => { document.getElementById('printHeaderTitle').textContent = "মিরাকল ক্যাডেট অ্যান্ড একাডেমিক ইন্সটিটিউট"; document.getElementById('printHeaderSubtitle').textContent = pageTitle; const classText = classFilter.options[classFilter.selectedIndex].text; const batchText = batchFilter.options[batchFilter.selectedIndex].text; let filterInfo = `ফিল্টার: ${classText}`; if (batchFilter.value) filterInfo += `, ${batchText}`; document.getElementById('printHeaderFilters').textContent = filterInfo; window.print(); }; document.getElementById('btnBackToDashboard').onclick = () => loadPage(showDashboardPage); populateClassFilter(); populateBatchFilter(''); renderTable(originalDetailedData); }
    function showStudentDatabasePage(context = {}) { context.breadcrumbs = [{ text: 'হোম', pageFn: showHomePage }, { text: 'ছাত্র ডেটাবেস' }]; mainContentArea.appendChild(cloneTemplate('template-student-database')); const searchInput = document.getElementById('studentDatabaseSearchInput'); const contactInput = document.getElementById('studentDatabaseContactInput'); const resultsContainer = document.getElementById('student-search-results'); const performSearch = () => { const searchTerm = searchInput.value.toLowerCase().trim(); const contactTerm = contactInput.value.toLowerCase().trim(); resultsContainer.innerHTML = ''; if (searchTerm.length < 1 && contactTerm.length < 1) { resultsContainer.innerHTML = `<p style='text-align: center; color: var(--text-secondary);'>অনুসন্ধানের জন্য নাম, রোল বা যোগাযোগ নম্বর লিখুন।</p>`; return; } const filteredStudents = (appData.students || []).filter(s => { if (!s || s.deletedAt) return false; const nameRollMatch = !searchTerm || s.name.toLowerCase().includes(searchTerm) || s.roll.includes(searchTerm); const contactMatch = !contactTerm || (s.parentContact && s.parentContact.toLowerCase().includes(contactTerm)); return nameRollMatch && contactMatch; }).sort((a, b) => (parseInt(a.roll, 10) || 0) - (parseInt(b.roll, 10) || 0)); if (filteredStudents.length === 0) { resultsContainer.innerHTML = `<p style='text-align: center; color: var(--text-secondary);'>কোনো ছাত্র খুঁজে পাওয়া যায়নি।</p>`; return; } let serialNumber = 0; filteredStudents.forEach(student => { serialNumber++; const classInfo = findClassById(student.classId); const resultItem = document.createElement('div'); resultItem.style.cssText = "padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 8px; cursor: pointer; display: flex; flex-direction: column; gap: 5px;"; resultItem.innerHTML = `<div><strong style="font-size: 1.1em;">${serialNumber}. ${student.name}</strong></div><div style="font-size: 0.9em; color: var(--text-secondary);"><span>রোল: ${student.roll}</span> | <span>ক্লাস: ${classInfo?.name || 'N/A'}</span></div>`; resultItem.dataset.studentId = student.id; resultItem.onclick = () => loadPage(showStudentProfilePage, { studentId: student.id }); resultsContainer.appendChild(resultItem); }); }; searchInput.addEventListener('input', performSearch); contactInput.addEventListener('input', performSearch); performSearch(); }
    function showStudentProfilePage(context) { const student = findStudentById(context.studentId); if (!student) { loadPage(showStudentDatabasePage); return; } context.breadcrumbs = [ { text: 'হোম', pageFn: showHomePage }, { text: 'ছাত্র ডেটাবেস', pageFn: showStudentDatabasePage }, { text: student.name } ]; mainContentArea.appendChild(cloneTemplate('template-student-profile')); document.getElementById('profileNameHeader').textContent = student.name; document.getElementById('profileRoll').textContent = student.roll; document.getElementById('profileClass').textContent = findClassById(student.classId)?.name || 'N/A'; document.getElementById('profileSchool').textContent = student.schoolName || 'N/A'; document.getElementById('profileParentContact').textContent = student.parentContact || 'N/A'; document.getElementById('profileAdmissionDate').textContent = student.createdAt ? new Date(student.createdAt).toLocaleString('bn-BD', { day: 'numeric', month: 'long', year: 'numeric' }) : 'N/A'; const batchesContainer = document.getElementById('student-profile-batches'); const studentBatches = findBatchesForStudent(student.id); if (studentBatches.length > 0) { const ul = document.createElement('ul'); ul.style.cssText="list-style:none; padding:0;"; studentBatches.forEach(batchInfo => { const li = document.createElement('li'); li.style.cssText="background-color: var(--bg-hover); padding: 8px; border-radius: 4px; margin-bottom: 5px;"; li.textContent = `${batchInfo.day} (${batchInfo.time})`; ul.appendChild(li); }); batchesContainer.appendChild(ul); } else { batchesContainer.innerHTML = `<p style="color:var(--due-text);">কোনো ব্যাচে নেই।</p>`; } const profilePhoto = document.getElementById('profilePagePhoto'); if(profilePhoto) { if(student.photoURL) { profilePhoto.src = student.photoURL; } profilePhoto.onerror = () => handleImageError(profilePhoto); } document.getElementById('btnGoToPaymentSection').onclick = () => { currentStudentContext = {...currentStudentContext, studentId: student.id, cameFrom: 'studentProfile', classId: student.classId }; loadPage(showStudentPaymentDetailsPage, {studentId: student.id}); }; document.getElementById('btnBackToDatabase').onclick = () => loadPage(showStudentDatabasePage); document.getElementById('btnEditStudentProfile')?.addEventListener('click', () => { showEditStudentModal(student.id); }); }
    async function showAddStudentModal(batchId, classId, onSuccess) {
        const modalFragment = cloneTemplate('template-add-student-modal');
        const modal = modalFragment.querySelector('#addStudentModal');
        document.body.appendChild(modal);

        const form = modal.querySelector('#addStudentForm');
        const closeBtn = modal.querySelector('.close-button');
        let uploadedPhotoURL = null;
        const imagePreview = modal.querySelector('#addStudentImagePreview');
        const selectPhotoBtn = modal.querySelector('#selectStudentPhotoBtn');
        const takePhotoBtn = modal.querySelector('#takeStudentPhotoBtn');
        const photoInput = modal.querySelector('#studentPhotoInput');
        
        const admissionFeeInput = modal.querySelector('#admissionFeeInputModal');
        const admissionFeeFreeCheckbox = modal.querySelector('#admissionFeeFreeCheckbox');
        const admissionReceiverInput = modal.querySelector('#admissionReceiverInputModal');

        const classInfo = findClassById(classId);
        const defaultAdmissionFee = classInfo?.defaultAdmissionFee || 0;
        admissionFeeInput.value = defaultAdmissionFee;
        
        const lastReceiver = localStorage.getItem('mcth_last_receiver_name');
        if(lastReceiver) {
            admissionReceiverInput.value = lastReceiver;
        }

        const toggleFeeInputs = () => {
            if (admissionFeeFreeCheckbox.checked) {
                admissionFeeInput.disabled = true;
                admissionFeeInput.value = '0';
            } else {
                admissionFeeInput.disabled = false;
                 admissionFeeInput.value = defaultAdmissionFee;
            }
        };

        admissionFeeFreeCheckbox.addEventListener('change', toggleFeeInputs);
        toggleFeeInputs();

        const closeModal = () => modal.remove();
        closeBtn.onclick = closeModal;
        modal.onclick = (e) => { if (e.target === modal) closeModal(); };
        
        selectPhotoBtn.onclick = () => photoInput.click();

        const handleImageSelection = async (imageSource) => {
            showLoader();
            try {
                const compressedDataUrl = await processAndCompressImage(imageSource);
                uploadedPhotoURL = compressedDataUrl;
                imagePreview.src = compressedDataUrl;
                showToast('ছবি সফলভাবে প্রসেস হয়েছে।', 'success');
            } catch (error) {
                console.error("Image processing failed:", error);
                showToast(error.message || 'ছবি প্রসেস করা সম্ভব হয়নি।', 'error');
                uploadedPhotoURL = null;
            } finally {
                hideLoader();
            }
        };

        photoInput.onchange = (e) => { const file = e.target.files[0]; if (file) handleImageSelection(file); };
        takePhotoBtn.onclick = () => { showCameraModal(blob => { if (blob) handleImageSelection(blob); }); };

        form.onsubmit = async (e) => {
            e.preventDefault();
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            showLoader();
            try {
                const name = modal.querySelector('#studentNameInput').value.trim();
                if (!name) { showToast("ছাত্রের নাম আবশ্যক।", 'error'); return; }
                
                const isAdmissionFeeFree = admissionFeeFreeCheckbox.checked;
                const admissionFeeAmount = isAdmissionFeeFree ? 0 : (parseFloat(admissionFeeInput.value) || 0);
                const receiverName = admissionReceiverInput.value.trim();

                if (!receiverName) { showToast("গ্রহণকারীর নাম আবশ্যক।", 'error'); return; }
                
                localStorage.setItem('mcth_last_receiver_name', receiverName);

                const studentId = `s_${Date.now()}`;
                const schoolName = modal.querySelector('#studentSchoolInput').value.trim();
                const parentContact = modal.querySelector('#parentContactInput').value.trim();
                const defaultMonthly = classInfo?.defaultMonthlyFee || 0;
                const newRoll = generateNextRollNumber();
                
                const admissionFeeData = { amount: admissionFeeAmount, status: 'paid', receiver: receiverName, date: new Date().toISOString(), token: generateToken() };

                const newStudent = { id: studentId, name, roll: newRoll, classId, parentContact: parentContact || 'N/A', schoolName: schoolName || 'N/A', createdAt: new Date().toISOString(), admissionFee: admissionFeeData, monthlyFeeDefault: defaultMonthly, monthlyPayments: {}, hasCustomFee: false, photoURL: uploadedPhotoURL };

                if (!appData.students) appData.students = [];
                appData.students.push(newStudent);
                logActivity('New student added', { studentName: name, roll: newRoll, class: classInfo.name, admissionFee: isAdmissionFeeFree ? 'Free' : admissionFeeData.amount });
                
                const batchInfo = findBatchById(batchId);
                if (batchInfo && batchInfo.batch) {
                    if (!batchInfo.batch.studentIds) batchInfo.batch.studentIds = [];
                    batchInfo.batch.studentIds.push(newStudent.id);
                }
                
                isSaving = true;
                await dbRef.set(appData);
                isSaving = false;

                showToast(`শিক্ষার্থী '${name}' যোগ করা হয়েছে। তার রোল নম্বর: ${newRoll}`, 'success');
                sessionStorage.setItem('newlyAddedStudentId', studentId);
                
                closeModal();
                if (onSuccess) onSuccess();
            } catch (error) {
                console.error("Failed to add student:", error);
                showToast("ছাত্র যোগ করার সময় একটি সমস্যা হয়েছে।", "error");
            } finally {
                hideLoader();
                submitButton.disabled = false;
            }
        };
        modal.classList.add('visible');
    }
    function showBatchPage(context = {}){ context.breadcrumbs = [{ text: 'হোম', pageFn: showHomePage }, { text: 'ব্যাচ ম্যানেজমেন্ট' }]; mainContentArea.appendChild(cloneTemplate('template-batch')); renderBatchDayTabs(); const firstDay = (appData.batchSchedule || []).find(d => !d.deletedAt); if(firstDay){ document.querySelector(`.tab-button[data-day-id="${firstDay.id}"]`)?.click(); } }
    function renderBatchDayTabs(){ const container = document.getElementById('batch-day-tabs'); if (!container) return; container.innerHTML = ''; (appData.batchSchedule || []).forEach(day => { if (day.deletedAt) return; const tab = document.createElement('button'); tab.className = 'tab-button'; tab.dataset.dayId = day.id; tab.innerHTML = ` <span>${day.dayName}</span> <span class="student-action-icons admin-only hidden"> <span class="student-edit-icon" title="Rename Day">✏️</span> <span class="student-delete-icon" title="Delete Day">🗑️</span> </span> `; tab.querySelector('.student-edit-icon')?.addEventListener('click',async (e) => { e.stopPropagation(); if (!isAdminMode) return; const newDayName = prompt('নতুন নাম দিন:', day.dayName); if (newDayName && newDayName.trim()) { day.dayName = newDayName.trim(); await saveAppData(); renderBatchDayTabs(); } }); tab.querySelector('.student-delete-icon')?.addEventListener('click',async (e) => { e.stopPropagation(); if (!isAdminMode) return; if (confirm(`'${day.dayName}' দিনটি এবং এর অন্তর্গত সকল ব্যাচ রিসাইকেল বিনে পাঠাতে চান?`)) { const dayToMove = (appData.batchSchedule || []).find(d => d.id === day.id); if(dayToMove) dayToMove.deletedAt = new Date().toISOString(); await saveAppData(); showToast(`'${day.dayName}' রিসাইকেল বিনে পাঠানো হয়েছে।`, 'info'); renderBatchDayTabs(); } }); tab.addEventListener('click',(e) => { if(e.target.closest('.student-action-icons')) return; container.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active')); tab.classList.add('active'); renderBatchClassSubTabs(day.id); }); container.appendChild(tab); }); const addBtn = document.createElement('button'); addBtn.className = 'tab-button admin-only hidden'; addBtn.textContent = '+ দিন'; addBtn.onclick = async () => { if (!isAdminMode) return; const dayName = prompt('নতুন দিনের নাম দিন (যেমন: শনিবার):'); if (dayName && dayName.trim()) { const newDay = {id: `d_${Date.now()}`, dayName: dayName.trim(), classes: []}; if(!appData.batchSchedule) appData.batchSchedule = []; appData.batchSchedule.push(newDay); await saveAppData(); renderBatchDayTabs(); } }; container.appendChild(addBtn); updateAdminModeUI(); }
    function renderBatchClassSubTabs(dayId){ const day = (appData.batchSchedule || []).find(d => d.id === dayId); const container = document.getElementById('batch-class-subtabs-container'); if (!container || !day) { if (container) container.innerHTML = ''; return; } container.innerHTML = ` <div class="tab-container" id="sub-tabs-for-${dayId}"></div> <div id="batch-list-container"></div> `; const subTabContainer = container.querySelector(`#sub-tabs-for-${dayId}`); if(!day.classes) day.classes = []; (day.classes || []).filter(c=>!c.deletedAt).forEach(cls => { const classInfo = findClassById(cls.classId); if (!classInfo) return; const tab = document.createElement('button'); tab.className = 'tab-button'; tab.dataset.classScheduleId = cls.id; tab.innerHTML = ` <span>${classInfo.name}</span> <span class="student-action-icons admin-only hidden"> <span class="student-delete-icon" title="Remove Class from this Day">❌</span> </span> `; tab.querySelector('.student-delete-icon').addEventListener('click',async e => { e.stopPropagation(); if (!isAdminMode) return; if (confirm(`আপনি কি '${day.dayName}' থেকে '${classInfo.name}' এর সকল ব্যাচ মুছে ফেলতে চান?`)) { const clsToMove = day.classes.find(c=>c.id === cls.id); if(clsToMove) clsToMove.deletedAt = new Date().toISOString(); await saveAppData(); renderBatchClassSubTabs(dayId); } }); tab.addEventListener('click',(e) => { if(e.target.closest('.student-action-icons')) return; subTabContainer.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active')); tab.classList.add('active'); renderBatchList(dayId, cls.id); }); subTabContainer.appendChild(tab); }); const addClassBtn = document.createElement('button'); addClassBtn.className = 'tab-button admin-only hidden'; addClassBtn.textContent = '+ ক্লাস'; addClassBtn.onclick = async () => { if (!isAdminMode) return; const className = prompt('ক্লাসের নাম দিন:'); if (!className || !className.trim()) return; let classInfo = (appData.mainClassCategories || []).find(c => c.name.toLowerCase() === className.trim().toLowerCase()); if (!classInfo) { if (confirm(`'${className}' নামের কোনো ক্লাস নেই। আপনি কি এটি তৈরি করতে চান?`)) { classInfo = { id: `c_${Date.now()}`, name: className.trim(), defaultMonthlyFee: 0, defaultAdmissionFee: 0 }; if(!appData.mainClassCategories) appData.mainClassCategories = []; appData.mainClassCategories.push(classInfo); } else { return; } } if ((day.classes || []).find(cs => cs.classId === classInfo.id && !cs.deletedAt)) { showToast('এই ক্লাসটি এই দিনে ইতিমধ্যে যোগ করা আছে।', 'error'); return; } day.classes.push({ id: `cs_${Date.now()}`, classId: classInfo.id, batches: [] }); await saveAppData(); renderBatchClassSubTabs(dayId); }; subTabContainer.appendChild(addClassBtn); const firstClass = (day.classes || []).find(cs => !cs.deletedAt); if(firstClass){ subTabContainer.querySelector('.tab-button')?.click(); } else { const batchListContainer = document.getElementById('batch-list-container'); if(batchListContainer) batchListContainer.innerHTML = ''; } updateAdminModeUI(); }
    function renderBatchList(dayId, classScheduleId){ const day = (appData.batchSchedule || []).find(d => d.id === dayId); const classSchedule = day?.classes?.find(cs => cs.id === classScheduleId); const container = document.getElementById('batch-list-container'); if (!container || !classSchedule) { if (container) container.innerHTML = ''; return; } container.innerHTML = ` <div class="batch-grid"></div> <button class="action-button btn-add admin-only hidden" id="addNewBatchBtn">+ নতুন ব্যাচ যোগ করুন</button> `; const grid = container.querySelector('.batch-grid'); grid.innerHTML = ''; if(!classSchedule.batches) classSchedule.batches = []; (classSchedule.batches || []).filter(b=>!b.deletedAt).forEach(batch => { const card = document.createElement('div'); card.className = 'batch-card'; const presentStudents = batch.studentIds?.length || 0; const vacant = batch.capacity - presentStudents; card.innerHTML = ` <div class="batch-card-header"> <span class="batch-time">${batch.time}</span> <div class="student-action-icons admin-only hidden"> <span class="student-edit-icon" title="Edit Batch Time">✏️</span> <span class="student-delete-icon" title="Delete Batch">🗑️</span> </div> </div> <div class="batch-card-body"> <table> <tr><th>মোট ধারণক্ষমতা</th><td>${batch.capacity}</td></tr> <tr><th>বর্তমান ছাত্র</th><td>${presentStudents}</td></tr> <tr><th>খালি সিট</th><td>${vacant > 0 ? vacant : 0}</td></tr> </table> <button class="action-button admin-only hidden">ধারণক্ষমতা পরিবর্তন</button> </div> `; card.querySelector('.batch-time').onclick = () => loadPage(showBatchDetailsPage, { batchId: batch.id }); card.querySelector('.student-edit-icon').onclick = async (e) => { e.stopPropagation(); if (!isAdminMode) return; const newTime = prompt("ব্যাচের নতুন সময় দিন:", batch.time); if (newTime && newTime.trim()) { batch.time = newTime.trim(); await saveAppData(); renderBatchList(dayId, classScheduleId); } }; card.querySelector('.student-delete-icon').onclick = async (e) => { e.stopPropagation(); if (!isAdminMode) return; const studentsInBatch = (batch.studentIds || []).map(id => findStudentById(id)).filter(Boolean); if (confirm(`আপনি কি '${batch.time}' ব্যাচটি এবং এর অন্তর্গত ${studentsInBatch.length} জন ছাত্রকে রিসাইকেল বিনে পাঠাতে চান? তাদের সকল তথ্য রিসাইকেল বিনে সংরক্ষিত থাকবে।`)) { batch.deletedAt = new Date().toISOString(); batch.originalPath = { dayId: dayId, classScheduleId: classScheduleId }; if(!appData.recycleBin) appData.recycleBin = {}; if(!appData.recycleBin.batchSchedule) appData.recycleBin.batchSchedule = []; appData.recycleBin.batchSchedule.push({...batch}); if (!appData.recycleBin.students) appData.recycleBin.students = []; studentsInBatch.forEach(student => { const studentInDb = (appData.students || []).find(s => s.id === student.id); if (studentInDb && !studentInDb.deletedAt) { studentInDb.deletedAt = new Date().toISOString(); appData.recycleBin.students.push({...studentInDb}); } }); const batchInDb = classSchedule.batches.find(b => b.id === batch.id); if (batchInDb) batchInDb.deletedAt = batch.deletedAt; await saveAppData(); showToast(`ব্যাচ এবং ${studentsInBatch.length} জন ছাত্রকে রিসাইকেল বিনে পাঠানো হয়েছে`, 'info'); renderBatchList(dayId, classScheduleId); } }; card.querySelector('.batch-card-body button').onclick = async () => { if (!isAdminMode) return; const newCapacity = parseInt(prompt("নতুন ধারণক্ষমতা দিন:", batch.capacity)); if (!isNaN(newCapacity) && newCapacity >= 0) { batch.capacity = newCapacity; await saveAppData(); showToast("ধারণ ক্ষমতা আপডেট করা হয়েছে।", "success"); renderBatchList(dayId, classScheduleId); } else { showToast("সঠিক সংখ্যা দিন।", "error"); } }; grid.appendChild(card); }); container.querySelector('#addNewBatchBtn').onclick = async () => { if (!isAdminMode) return; const time = prompt("নতুন ব্যাচের সময় লিখুন (যেমন: সকাল ৮:০০ - ৯:০০):"); if (!time || !time.trim()) return; const capacity = parseInt(prompt("ছাত্র ধারণ ক্ষমতা কত?", "50")); if (isNaN(capacity) || capacity < 0) return; if(!classSchedule.batches) classSchedule.batches = []; classSchedule.batches.push({ id: `b_${Date.now()}`, time: time.trim(), capacity: capacity, studentIds: [] }); await saveAppData(); renderBatchList(dayId, classScheduleId); }; updateAdminModeUI(); }
    function showBatchDetailsPage(context){ const batchInfo = findBatchById(context.batchId); if(!batchInfo){ loadPage(showBatchPage); return; } const {batch, classSchedule, day} = batchInfo; const classInfo = findClassById(classSchedule.classId); context.breadcrumbs = [ { text: 'হোম', pageFn: showHomePage }, { text: 'ব্যাচ ম্যানেজমেন্ট', pageFn: showBatchPage }, { text: `${day.dayName} (${batch.time})` } ]; mainContentArea.appendChild(cloneTemplate('template-batch-details')); document.getElementById('batchDetailsHeader').textContent=`${classInfo.name} - ব্যাচের বিস্তারিত`; document.getElementById('batchDetailsDay').textContent = day.dayName; document.getElementById('batchDetailsClass').textContent = classInfo.name; document.getElementById('batchDetailsTime').textContent = batch.time; document.getElementById('printBatchHeaderTitle').textContent = 'মিরাকল ক্যাডেট অ্যান্ড একাডেমিক ইন্সটিটিউট'; document.getElementById('printBatchHeaderClass').textContent = `ক্লাস: ${classInfo.name}`; document.getElementById('printBatchHeaderBatch').textContent = `ব্যাচ: ${day.dayName} (${batch.time})`; document.getElementById('btnPrintBatchList').onclick = () => window.print(); bulkStudentImportInput = document.getElementById('bulkStudentImportInput'); btnBulkImport = document.getElementById('btnBulkImport'); btnBulkImport.addEventListener('click', () => bulkStudentImportInput.click()); bulkStudentImportInput.addEventListener('change', async (event) => { const file = event.target.files[0]; if (!file) return; if (!['application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'application/vnd.ms-excel', 'text/csv'].includes(file.type)) { showToast('শুধুমাত্র Excel (.xlsx) বা CSV (.csv) ফাইল আপলোড করা যাবে।', 'error'); event.target.value = ''; return; } const reader = new FileReader(); reader.onload = async function(e) { showLoader(); try { const data = e.target.result; const workbook = XLSX.read(data, {type: 'binary'}); const sheetName = workbook.SheetNames[0]; const worksheet = workbook.Sheets[sheetName]; const jsonDataArray = XLSX.utils.sheet_to_json(worksheet, { header: 'A', defval: '' }); if(jsonDataArray.length === 0) { showToast('Excel ফাইলে কোনো ডেটা পাওয়া যায়নি।', 'warning'); return; } const headerRow = jsonDataArray[0]; const expectedHeaders = ['ক্রমিক নং', 'নাম', 'স্কুলের নাম', 'যোগাযোগ নম্বর']; const headerMap = {}; expectedHeaders.forEach(expectedHeader => { const foundHeaderKey = Object.keys(headerRow).find(key => headerRow[key] && headerRow[key].toString().trim().toLowerCase() === expectedHeader.toLowerCase()); if (foundHeaderKey) { headerMap[expectedHeader] = foundHeaderKey; } }); if (expectedHeaders.some(h => !headerMap[h])) { const missing = expectedHeaders.filter(h => !headerMap[h]); showToast(`Excel ফাইলের হেডার সঠিক নয়। অনুপস্থিত কলাম: ${missing.join(', ')}`, 'error'); return; } let addedCount = 0; const newStudentsToAdd = []; const skippedStudents = []; const currentClassId = classSchedule.classId; const classInfo = findClassById(currentClassId); const defaultMonthly = classInfo?.defaultMonthlyFee || 0; const defaultAdmission = classInfo?.defaultAdmissionFee || 0; for (let i = 1; i < jsonDataArray.length; i++) { const row = jsonDataArray[i]; const studentName = row[headerMap['নাম']]?.toString().trim(); const schoolName = row[headerMap['স্কুলের নাম']]?.toString().trim(); const contactNumber = row[headerMap['যোগাযোগ নম্বর']]?.toString().trim(); if (!studentName) { skippedStudents.push(`Row ${i+1}: নাম নেই`); continue; } const newStudent = { id: `s_${Date.now()}_${addedCount}`, name: studentName, roll: generateNextRollNumber(), classId: currentClassId, parentContact: contactNumber || 'N/A', schoolName: schoolName || 'N/A', createdAt: new Date().toISOString(), admissionFee: { amount: defaultAdmission, status: 'due', receiver: '', date: null, token: null }, monthlyFeeDefault: defaultMonthly, monthlyPayments: {}, hasCustomFee: false }; newStudentsToAdd.push(newStudent); addedCount++; } if (newStudentsToAdd.length > 0) { if(!appData.students) appData.students = []; appData.students.push(...newStudentsToAdd); if(!batch.studentIds) batch.studentIds = []; newStudentsToAdd.forEach(student => batch.studentIds.push(student.id)); logActivity("Bulk student import successful", { count: addedCount, batchId: batch.id, classId: currentClassId }); saveAppData(); showToast(`${addedCount} জন শিক্ষার্থী সফলভাবে যোগ করা হয়েছে।`, 'success'); } else { showToast('কোনো শিক্ষার্থী যোগ করা হয়নি।', 'info'); } if (skippedStudents.length > 0) { showToast(`কিছু শিক্ষার্থী বাদ পড়েছে (${skippedStudents.length} জন)। দেখুন কনসোল।`, 'warning'); console.warn("Skipped students during bulk import:", skippedStudents); } } catch (error) { console.error("Error processing Excel file:", error); showToast('Excel ফাইল প্রসেস করার সময় একটি ত্রুটি হয়েছে।', 'error'); } finally { hideLoader(); event.target.value = ''; } }; reader.readAsBinaryString(file); }); const tableBody = document.getElementById('batchStudentListBody'); const searchInput = document.getElementById('batchStudentSearchInput'); function populateBatchStudentTable(searchTerm=''){ tableBody.innerHTML = ''; const currentBatchInfo = findBatchById(context.batchId); if(!currentBatchInfo) return; const currentBatch = currentBatchInfo.batch; const searchTermLower = searchTerm.toLowerCase(); const studentsInBatch = (currentBatch.studentIds || []).map(findStudentById).filter(s => s && !s.deletedAt); const filteredStudents = studentsInBatch.filter(student => (student.name.toLowerCase().includes(searchTermLower))); filteredStudents.sort((a,b) => (parseInt(a.roll, 10) || 0) - (parseInt(b.roll, 10) || 0)); let serialNumber = 0; const newlyAddedStudentId = sessionStorage.getItem('newlyAddedStudentId'); filteredStudents.forEach(student => { serialNumber++; const tr = document.createElement('tr'); const contactInfo = student.parentContact || 'N/A'; let documentIconHTML = ''; if (student.id === newlyAddedStudentId) { documentIconHTML = `<span class="temp-doc-icon" data-student-id="${student.id}" title="ভর্তি রশিদ দেখুন" style="cursor: pointer; font-size: 1.2em;">📄</span>`; setTimeout(() => { const icon = document.querySelector(`.temp-doc-icon[data-student-id="${student.id}"]`); if (icon) icon.remove(); sessionStorage.removeItem('newlyAddedStudentId'); }, 120000); } tr.innerHTML = ` <td class="serial-number-column">${serialNumber}.</td> <td><strong>${student.name}</strong> ${documentIconHTML}</td> <td><strong>${student.roll}</strong></td> <td><strong>${student.schoolName || 'N/A'}</strong></td> <td><strong>${contactInfo}</strong></td> <td class="student-action-icons print-hide"> <span class="student-transfer-icon" title="Transfer Student">🔄</span> <span class="student-edit-icon" title="Edit Student">✏️</span> <span class="student-delete-icon" title="Remove from Batch">🗑️</span> </td> `; tr.querySelector('.student-transfer-icon').onclick = () => { showStudentTransferModal(student.id, currentBatch.id, () => populateBatchStudentTable(searchInput.value)); }; tr.querySelector('.student-edit-icon').onclick = () => { showToast("শিক্ষার্থীর তথ্য পরিবর্তনের জন্য 'ছাত্র ডেটাবেস' অথবা 'পেমেন্ট' সেকশন থেকে তার প্রোফাইলে যান।", 'info'); }; tr.querySelector('.student-delete-icon').onclick = () => { if (!isAdminMode) { showToast('এই কাজটি করতে অ্যাডমিন মোড প্রয়োজন।', 'error'); return; } if (!confirm(`আপনি কি '${student.name}' (রোল: ${student.roll}) কে সম্পূর্ণ ডেটাবেস থেকে মুছে রিসাইকেল বিনে পাঠাতে চান?\n\nছাত্রের সকল তথ্য রিসাইকেল বিনে সংরক্ষিত থাকবে এবং তাকে আর কোনো ব্যাচ বা তালিকায় দেখা যাবে না।`)) return; const studentName = student.name; student.deletedAt = new Date().toISOString(); if (!appData.recycleBin.students) appData.recycleBin.students = []; appData.recycleBin.students.push(student); const studentInDb = (appData.students || []).find(s => s.id === student.id); if (studentInDb) studentInDb.deletedAt = student.deletedAt; (appData.batchSchedule || []).forEach(day => { if (day.deletedAt) return; (day.classes || []).forEach(cls => { if (cls.deletedAt) return; (cls.batches || []).forEach(batch => batch.studentIds = (batch.studentIds || []).filter(id => id !== student.id)); }); }); logActivity('Student moved to recycle bin', { studentName: studentName }); saveAppData(); showToast(`ছাত্র '${studentName}' কে রিসাইকেল বিনে পাঠানো হয়েছে।`, 'info'); }; const docIcon = tr.querySelector('.temp-doc-icon'); if (docIcon) { docIcon.onclick = () => { currentStudentContext = { studentId: student.id, paymentType: 'admission', cameFrom: 'batchDetails' }; loadPage(showPaymentDocumentPage, { studentId: student.id, paymentType: 'admission' }); }; } tableBody.appendChild(tr); }); } searchInput.addEventListener('input', e => populateBatchStudentTable(e.target.value)); populateBatchStudentTable(); document.getElementById('btnAddStudentToBatch').onclick = () => { showAddStudentModal(batch.id, classSchedule.classId, () => populateBatchStudentTable(searchInput.value)); }; document.getElementById('btnBackToBatchList').onclick = () => { loadPage(showBatchPage); setTimeout(()=>{ const dayTab = document.querySelector(`.tab-button[data-day-id="${day.id}"]`); if (dayTab) { dayTab.click(); setTimeout(()=>{ document.querySelector(`.tab-button[data-class-schedule-id="${classSchedule.id}"]`)?.click(); }, 50); } }, 50); }; updateAdminModeUI(); }
    function showStudentTransferModal(studentId, sourceBatchId, onTransferSuccess){ const student = findStudentById(studentId); if(!student) return; const modalFragment = cloneTemplate('template-transfer-modal'); const modalOverlay = modalFragment.querySelector('#studentTransferModal'); document.body.appendChild(modalOverlay); const modalTitle = modalOverlay.querySelector('#transferModalTitle'); const listContainer = modalOverlay.querySelector('#transferBatchListContainer'); const closeButton = modalOverlay.querySelector('.close-button'); modalTitle.textContent = `'${student.name}' (রোল: ${student.roll}) কে ট্রান্সফার করুন`; listContainer.innerHTML = ''; (appData.batchSchedule || []).forEach(day => { if (day.deletedAt) return; const relevantClasses = (day.classes || []).filter(cs => cs.classId === student.classId && (cs.batches || []).length > 0); if (relevantClasses.length > 0) { const dayGroup = document.createElement('div'); dayGroup.className = 'transfer-day-group'; dayGroup.innerHTML = `<h3>${day.dayName}</h3>`; relevantClasses.forEach(classSchedule => { const classInfo = findClassById(classSchedule.classId); if (!classInfo) return; const classGroup = document.createElement('div'); classGroup.className = 'transfer-class-group'; classGroup.innerHTML = `<h4>${classInfo.name}</h4>`; (classSchedule.batches || []).forEach(batch => { const btn = document.createElement('button'); btn.className = 'transfer-batch-button'; let label = `সময়: ${batch.time} (বর্তমান ছাত্র: ${batch.studentIds?.length || 0}/${batch.capacity})`; if (batch.id === sourceBatchId) { btn.disabled = true; label += " (বর্তমান)"; } btn.textContent = label; btn.dataset.targetBatchId = batch.id; btn.onclick = () => { const destinationBatchId = btn.dataset.targetBatchId; const sourceInfo = findBatchById(sourceBatchId); const destInfo = findBatchById(destinationBatchId); if (sourceInfo && destInfo) { sourceInfo.batch.studentIds = (sourceInfo.batch.studentIds || []).filter(id => id !== studentId); if(!destInfo.batch.studentIds) destInfo.batch.studentIds = []; destInfo.batch.studentIds.push(studentId); saveAppData(); showToast(`'${student.name}' কে সফলভাবে ট্রান্সফার করা হয়েছে।`, 'success'); modalOverlay.remove(); if (onTransferSuccess) onTransferSuccess(); } else { showToast("ট্রান্সফার করার সময় একটি ত্রুটি হয়েছে।","error"); } }; classGroup.appendChild(btn); }); dayGroup.appendChild(classGroup); }); listContainer.appendChild(dayGroup); } }); const closeModal = () => modalOverlay.remove(); closeButton.onclick = closeModal; modalOverlay.onclick = (e) => { if(e.target === modalOverlay) closeModal(); }; modalOverlay.classList.add('visible'); }
    function showPaymentPage(context = {}){ context.breadcrumbs = [{ text: 'হোম', pageFn: showHomePage }, { text: 'পেমেন্ট' }]; mainContentArea.appendChild(cloneTemplate('template-payment')); renderPaymentPageTabs(); const activeTabs = document.querySelectorAll('#payment-class-categories-tabs .tab-button'); if(activeTabs.length > 0) { const classToSelect = context?.classId || ((appData.mainClassCategories || []).length > 0 ? (appData.mainClassCategories || []).find(c => !c.deletedAt)?.id : null); const tabToSelect = document.querySelector(`.tab-button[data-class-id="${classToSelect}"]`); if(tabToSelect){ tabToSelect.click(); } else if (activeTabs.length > 0) { activeTabs[0].click(); } } }
    function renderPaymentPageTabs(){ const tabsContainer = document.getElementById('payment-class-categories-tabs'); if(!tabsContainer) return; tabsContainer.innerHTML = ''; (appData.mainClassCategories || []).filter(c=>!c.deletedAt).forEach(classCat => { const tabButton = document.createElement('button'); tabButton.className = 'tab-button'; tabButton.dataset.classId = classCat.id; tabButton.innerHTML = ` <span>${classCat.name}</span> <span class="student-action-icons admin-only hidden"> <span class="student-delete-icon" title="Move class to recycle bin">🗑️</span> </span> `; tabButton.querySelector('.student-delete-icon').addEventListener('click', async (e) => { e.stopPropagation(); if (!isAdminMode) return; if(confirm(`'${classCat.name}' ক্লাসটি এবং এর সাথে সম্পর্কিত সকল ব্যাচ রিসাইকেল বিনে পাঠাতে চান?`)) { const classToMove = (appData.mainClassCategories || []).find(c=>c.id === classCat.id); if(classToMove) classToMove.deletedAt = new Date().toISOString(); (appData.batchSchedule || []).forEach(day => { if(day.deletedAt) return; (day.classes || []).forEach(cls => { if (cls.classId === classCat.id) { cls.deletedAt = new Date().toISOString(); } }); }); await saveAppData(); showToast(`'${classCat.name}' রিসাইকেল বিনে পাঠানো হয়েছে।`, 'info'); renderPaymentPageTabs(); } }); tabButton.addEventListener('click',(e) => { if(e.target.closest('.student-delete-icon')) return; tabsContainer.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active')); tabButton.classList.add('active'); renderStudentListForClass(classCat.id); }); tabsContainer.appendChild(tabButton); }); const addBtn = document.createElement('button'); addBtn.className = 'tab-button admin-only hidden'; addBtn.textContent = '+ ক্লাস'; addBtn.onclick = async () => {if(!isAdminMode) return; const newName = prompt("নতুন ক্লাসের নাম দিন:"); if(newName && newName.trim()){ if(!appData.mainClassCategories) appData.mainClassCategories = []; appData.mainClassCategories.push({id:`c_${Date.now()}`, name: newName.trim(), defaultMonthlyFee: 0, defaultAdmissionFee: 0}); await saveAppData(); renderPaymentPageTabs(); }}; tabsContainer.appendChild(addBtn); updateAdminModeUI(); }
    function renderStudentListForClass(classId){ const tabContentDiv = document.getElementById('payment-tab-contents'); const classInfo = findClassById(classId); if (!tabContentDiv || !classInfo) return; const allBatchesInClass = (appData.batchSchedule || []).flatMap(day => (day.classes || []).filter(c => c.classId === classId && !c.deletedAt).flatMap(c => c.batches || []).filter(b=>!b.deletedAt)); const batchDayMap = new Map(); (appData.batchSchedule || []).forEach(day => { if(day.deletedAt) return; (day.classes || []).forEach(c => { if(c.deletedAt) return; (c.batches || []).forEach(b => batchDayMap.set(b.id,`${day.dayName.substring(0,3)} (${b.time})`)); }); }); let batchOptions=`<option value="">সব ব্যাচ</option>`; allBatchesInClass.forEach(b => { batchOptions+=`<option value="${b.id}">${batchDayMap.get(b.id) || ''}</option>`; }); tabContentDiv.innerHTML = ` <div id="student-list-payment" class="tab-content"> <div class="student-list-header"> <h3>${classInfo.name} - শিক্ষার্থীদের তালিকা</h3> <div class="default-fee-controls"> <label>ডিফল্ট মাসিক ফি:</label> <input type="number" id="classDefaultMonthlyFee" class="assistant-disabled" value="${classInfo.defaultMonthlyFee || ''}"> <label>ডিফল্ট ভর্তি ফি:</label> <input type="number" id="classDefaultAdmissionFee" class="assistant-disabled" value="${classInfo.defaultAdmissionFee || ''}"> <button id="saveClassDefaultsBtn" class="action-button admin-only hidden">সংরক্ষণ</button> </div> </div> <div class="payment-filters"> <input type="search" id="studentSearchInput" placeholder="নাম বা রোল দিয়ে সার্চ করুন..."> <select id="batchFilter">${batchOptions}</select> <select id="paymentStatusFilter"> <option value="">সব স্ট্যাটাস</option> <option value="due">বকেয়া</option> <option value="paid">পরিশোধিত</option> </select> </div> <div class="table-responsive-wrapper"><table> <thead> <tr> <th>ক্রমিক</th> <th>নাম</th> <th>রোল</th> <th>ব্যাচ</th> <th>স্ট্যাটাস</th> <th class="admin-only hidden">একশন</th> </tr> </thead> <tbody></tbody> </table></div> </div> `; const studentListTbody = tabContentDiv.querySelector('tbody'); const searchInput = document.getElementById('studentSearchInput'); const batchFilter = document.getElementById('batchFilter'); const statusFilter = document.getElementById('paymentStatusFilter'); const saveDefaultsBtn = document.getElementById('saveClassDefaultsBtn'); saveDefaultsBtn.addEventListener('click', ()=>{ if (!isAdminMode) return; const newMonthlyFee = parseFloat(document.getElementById('classDefaultMonthlyFee').value) || 0; const newAdmissionFee = parseFloat(document.getElementById('classDefaultAdmissionFee').value) || 0; if (confirm(`আপনি কি '${classInfo.name}' এর সকল সাধারণ ছাত্রের ডিফল্ট মাসিক ফি ${newMonthlyFee} টাকা এবং ডিফল্ট ভর্তি ফি ${newAdmissionFee} টাকা সেট করতে চান? \n\nবিশেষ (⭐) ছাত্রদের ফি পরিবর্তন হবে না।`)){ classInfo.defaultMonthlyFee = newMonthlyFee; classInfo.defaultAdmissionFee = newAdmissionFee; (appData.students || []).forEach(student => { if (student.classId === classId && !student.hasCustomFee) { student.monthlyFeeDefault = newMonthlyFee; Object.keys(student.monthlyPayments).forEach(month => { if (student.monthlyPayments[month].status === 'due') { student.monthlyPayments[month].fee = newMonthlyFee; } }); if (student.admissionFee.status === 'due' && student.admissionFee.amount > 0) { student.admissionFee.amount = newAdmissionFee; } } }); saveAppData(); } }); function populatePaymentStudentTable() { const searchTerm = searchInput.value.toLowerCase(); const selectedBatchId = batchFilter.value; const selectedStatus = statusFilter.value; studentListTbody.innerHTML = ''; const studentsInClass = (appData.students || []).filter(s => s && !s.deletedAt && s.classId === classId); studentsInClass.forEach(student => { BENGALI_MONTHS.forEach(month => { if (!student.monthlyPayments[month]) { student.monthlyPayments[month] = { fee: student.monthlyFeeDefault || 0, status: 'due', receiver: '', date: null, token: null }; } else if (student.monthlyPayments[month].status !== 'paid' && !student.hasCustomFee) { student.monthlyPayments[month].fee = student.monthlyFeeDefault; } }); }); const filteredStudents = studentsInClass.filter(s => { if (searchTerm && !s.name.toLowerCase().includes(searchTerm) && !s.roll.toLowerCase().includes(searchTerm)) return false; const studentBatches = findBatchesForStudent(s.id); if (selectedBatchId && !studentBatches.some(b => b.id === selectedBatchId)) return false; const studentIsCurrentlyDue = isStudentDue(s, viewedYear); if (selectedStatus === 'due' && !studentIsCurrentlyDue) return false; if (selectedStatus === 'paid' && studentIsCurrentlyDue) return false; return true; }).sort((a, b) => (parseInt(a.roll, 10) || 0) - (parseInt(b.roll, 10) || 0)); let serialNumber = 0; filteredStudents.forEach(student => { serialNumber++; const tr = document.createElement('tr'); const studentBatches = findBatchesForStudent(student.id); let batchDetailsHtml = studentBatches.length > 0 ? studentBatches.map(b => `${b.day.substring(0,3)} (${b.time})`).join('<br>') : `<span style="color:var(--due-text); font-style:italic;">কোনো ব্যাচে নেই</span>`; let studentNameHtml = student.name; if (student.hasCustomFee) { studentNameHtml += ` <span class="special-student-indicator" title="এই ছাত্রের জন্য বিশেষ ফি সেট করা আছে।">⭐</span>`; } const studentIsCurrentlyDue = isStudentDue(student, viewedYear); let statusHtml = `<span style="padding: 4px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold; text-align: center; color:${studentIsCurrentlyDue ? 'var(--due-text)':'var(--paid-text)'}; background-color:${studentIsCurrentlyDue ? 'var(--due-color)':'var(--paid-color)'}">${studentIsCurrentlyDue ? 'বকেয়া' : 'পরিশোধিত'}</span>`; tr.innerHTML = ` <td class="serial-number-column">${serialNumber}.</td> <td data-student-id="${student.id}" style="cursor:pointer; color: var(--text-tab-active);"> <span class="student-name"><strong>${studentNameHtml}</strong></span> </td> <td><strong>${student.roll}</strong></td> <td>${batchDetailsHtml}</td> <td>${statusHtml}</td> <td class="admin-only hidden student-action-icons"><span class="student-delete-icon" data-student-id="${student.id}" title="ছাত্রকে রিসাইকেল বিনে পাঠান">🗑️</span></td> `; const nameCell = tr.querySelector('td[data-student-id]'); if (nameCell) { nameCell.onclick = (e) => { if (!e.target.closest('.student-action-icons')) { currentStudentContext = { studentId: student.id, classId: classId }; loadPage(showStudentPaymentDetailsPage, {studentId: student.id, classId: classId}); } }; } const deleteIcon = tr.querySelector('.student-delete-icon'); if (deleteIcon) { deleteIcon.onclick = (e) => { e.stopPropagation(); if (!isAdminMode) return; const studentToDelete = findStudentById(e.target.dataset.studentId); if (!studentToDelete || !confirm(`আপনি কি '${studentToDelete.name}' (রোল: ${studentToDelete.roll}) কে রিসাইকেল বিনে পাঠাতে চান?\n\nছাত্রের সকল তথ্য রিসাইকেল বিনে সংরক্ষিত থাকবে।`)) return; const studentName = studentToDelete.name; studentToDelete.deletedAt = new Date().toISOString(); if(!appData.recycleBin.students) appData.recycleBin.students = []; appData.recycleBin.students.push(studentToDelete); const studentInDb = (appData.students || []).find(s=>s.id === studentToDelete.id); if(studentInDb) studentInDb.deletedAt = studentToDelete.deletedAt; (appData.batchSchedule || []).forEach(day => { (day.classes || []).forEach(cls => { (cls.batches || []).forEach(batch => batch.studentIds = (batch.studentIds || []).filter(id => id !== studentToDelete.id)); }); }); logActivity('Student moved to recycle bin', { studentName: studentName }); saveAppData(); showToast(`ছাত্র '${studentName}' কে রিসাইকেল বিনে পাঠানো হয়েছে।`, 'info'); }; } studentListTbody.appendChild(tr); }); updateAdminModeUI(); } searchInput.addEventListener('input', populatePaymentStudentTable); batchFilter.addEventListener('change', populatePaymentStudentTable); statusFilter.addEventListener('change', populatePaymentStudentTable); populatePaymentStudentTable(); updateAdminModeUI(); }
    function showStudentPaymentDetailsPage(context){ if(!context.studentId){ loadPage(showPaymentPage); return; } const student = findStudentById(context.studentId); if (!student) { showToast('ছাত্র খুঁজে পাওয়া যায়নি।', 'error'); loadPage(showPaymentPage); return; } context.breadcrumbs = [{ text: 'হোম', pageFn: showHomePage }]; if (context.cameFrom === 'history') { context.breadcrumbs.push({ text: 'হিস্টোরি', pageFn: showPaymentHistoryPage }); } else { context.breadcrumbs.push({ text: 'পেমেন্ট', pageFn: showPaymentPage, context: { classId: student.classId } }); if (context.cameFrom !== 'paymentDetails') { context.breadcrumbs.push({ text: student.name, pageFn: showStudentProfilePage, context: { studentId: student.id } }); } } context.breadcrumbs.push({ text: 'পেমেন্ট বিবরণ' }); mainContentArea.appendChild(cloneTemplate('template-student-payment-details')); const paymentPagePhoto = document.getElementById('paymentPagePhoto'); if(paymentPagePhoto) { if(student.photoURL) { paymentPagePhoto.src = student.photoURL; } paymentPagePhoto.onerror = () => handleImageError(paymentPagePhoto); } document.getElementById('studentNameHeader').textContent=`${student.name} এর পেমেন্ট বিবরণ`; document.getElementById('studentRollDisplay').textContent=student.roll; document.getElementById('studentClassDisplay').textContent=findClassById(student.classId)?.name||'N/A'; document.getElementById('entryDateValue').textContent=student.createdAt ? new Date(student.createdAt).toLocaleString('bn-BD',{day:'numeric',month:'long',year:'numeric'}) : 'N/A'; const admissionFeeInput = document.getElementById('admissionFeeAmount'); const admissionFeeStatus = document.getElementById('admissionFeeStatus'); const admissionReceiverInfo = document.getElementById('admissionReceiverInfo'); const admissionFeeData = student.admissionFee; admissionFeeInput.value = admissionFeeData?.amount || ''; admissionFeeStatus.textContent = `স্ট্যাটাস: ${admissionFeeData?.status === 'paid' ? 'Paid' : (admissionFeeData?.amount > 0 ? 'Due' : 'N/A')}`; admissionReceiverInfo.textContent = `গ্রহণকারী: ${admissionFeeData?.receiver || 'N/A'}`; document.getElementById('btnShowAdmissionDoc').disabled = admissionFeeData?.status !== 'paid'; document.getElementById('btnShowAdmissionDoc').addEventListener('click',()=>{ currentStudentContext = {...currentStudentContext, studentId: student.id, paymentType: 'admission', cameFrom: 'paymentDetails'}; loadPage(showPaymentDocumentPage, { studentId: student.id, paymentType: 'admission' }); }); document.getElementById('btnAdmissionPaid').addEventListener('click',() => handleAdmissionPayment(student.id)); document.getElementById('btnAdmissionDue').addEventListener('click', () => handleAdmissionDue(student.id)); const defaultFeeInput = document.getElementById('defaultMonthlyFeeForStudent'); const saveDefaultFeeBtn = document.getElementById('btnSaveDefaultMonthlyFee'); defaultFeeInput.value = student.monthlyFeeDefault > 0 ? student.monthlyFeeDefault : ''; saveDefaultFeeBtn.addEventListener('click', ()=>{ if (!isAdminMode) return; const newDefaultFee = parseFloat(defaultFeeInput.value); if (!isNaN(newDefaultFee) && newDefaultFee >= 0) { student.monthlyFeeDefault = newDefaultFee; student.hasCustomFee = true; Object.keys(student.monthlyPayments).forEach(monthName => { if (student.monthlyPayments[monthName].status === 'due') { student.monthlyPayments[monthName].fee = newDefaultFee; } }); saveAppData(); showToast('এই ছাত্রের জন্য বিশেষ ডিফল্ট মাসিক ফি সংরক্ষণ করা হয়েছে।', 'success'); } else { showToast('অনুগ্রহ করে একটি সঠিক ফি লিখুন।', 'error'); } }); document.getElementById('btnBackToPreviousPage').onclick = () => { if (currentStudentContext?.cameFrom === 'studentProfile') { loadPage(showStudentProfilePage, { studentId: student.id }); } else if (currentStudentContext?.cameFrom === 'history') { loadPage(showPaymentHistoryPage); } else { loadPage(showPaymentPage, { classId: student.classId }); } }; const selectAllCheckbox = document.getElementById('selectAllMonthsCheckbox'); selectAllCheckbox.addEventListener('change', (e) => { document.querySelectorAll('#monthlyPaymentsTableBody .month-checkbox:not(:disabled)').forEach(chk => { chk.checked = e.target.checked; }); }); document.getElementById('btnPaySelectedMonths').addEventListener('click', () => handleMultiMonthPayment(student.id, context)); populateStudentMonthlyPaymentsTable(student.id); renderYearlyStatusChart(student); updateAdminModeUI(); }
    async function handleAdmissionPayment(studentId) { const student = findStudentById(studentId); if (!student) return; const newAmount = parseFloat(document.getElementById('admissionFeeAmount').value); if (isNaN(newAmount) || newAmount <= 0) { showToast("ভর্তি ফি এর পরিমাণ সঠিকভাবে লিখুন।","error"); return; } if (student.admissionFee?.status === 'paid' && !isAdminMode) { showToast("ভর্তি ফি ইতিমধ্যে পরিশোধিত।","info"); return; } const receiverName = prompt("ভর্তি ফি গ্রহণকারীর নাম লিখুন:"); if (receiverName?.trim()) { student.admissionFee = { amount: newAmount, status: 'paid', receiver: receiverName, date: new Date().toISOString(), token: generateToken() }; logActivity("Admission Fee Paid", { studentName: student.name, amount: newAmount }); await saveAppData(); loadPage(showStudentPaymentDetailsPage, {studentId: student.id}); if (smsManagementData.automation?.paymentEnabled && student.parentContact && student.parentContact.trim().toLowerCase() !== 'n/a') { const message = `প্রিয় ${student.name} (রোল: ${student.roll}), আপনার ভর্তি ফি বাবদ ${newAmount} টাকা পেমেন্ট সফল হয়েছে। Trnx ID: ${student.admissionFee.token}।\n\nধন্যবাদ,\nমিরাকল`; const pendingId = `pending_adm_${Date.now()}`; db.ref(`smsManagement/pending/payment/${pendingId}`).set({ id: pendingId, timestamp: new Date().toISOString(), studentId: student.id, message: message, paymentFor: 'ভর্তি ফি', amount: newAmount, classId: student.classId }); } showToast("ভর্তি ফি সফলভাবে 'Paid' হিসেবে আপডেট করা হয়েছে।", 'success'); } else if (receiverName !== null) { showToast("গ্রহণকারীর নাম আবশ্যক।","error"); } }
    async function handleAdmissionDue(studentId) { const student = findStudentById(studentId); if (!student) return; if (student.admissionFee?.status === 'paid' && !isAdminMode) { showToast("'Due' করতে অ্যাডমিন মোড অ্যাক্টিভেট করুন।","error"); return; } const currentAmount = parseFloat(document.getElementById('admissionFeeAmount').value); student.admissionFee = { amount: isNaN(currentAmount) ? 0 : currentAmount, status: 'due', receiver: '', date: null, token: null }; logActivity("Admission Fee set to Due", { studentName: student.name }); await saveAppData(); loadPage(showStudentPaymentDetailsPage, {studentId: student.id}); showToast("ভর্তি ফি সফলভাবে 'Due' হিসেবে আপডেট করা হয়েছে।", 'info'); }
    async function handleMonthlyPayment(buttonElement, studentId, month, statusToSet){ const student = findStudentById(studentId); if (!student) return; const monthData = student.monthlyPayments[month]; if (!monthData) return; if (monthData.status === 'paid' && !isAdminMode) { showToast(`এই মাসের পেমেন্ট ইতিমধ্যে 'Paid'। পরিবর্তনে অ্যাডমিন মোড প্রয়োজন।`,"info"); return; } if (statusToSet === 'paid') { const feeInput = buttonElement.closest('tr').querySelector('.monthly-fee-input'); const feeAmount = parseFloat(feeInput.value); if (isNaN(feeAmount) || feeAmount <= 0) { showToast("ফি ০ টাকা বা খালি হলে Paid করা যাবে না।","error"); return; } const receiverName = prompt(`${month} মাসের বেতন গ্রহণকারীর নাম লিখুন:`); if (receiverName?.trim()) { monthData.fee = feeAmount; monthData.status = 'paid'; monthData.receiver = receiverName; monthData.date = new Date().toISOString(); monthData.token = generateToken(); logActivity(`Monthly Fee Paid for ${month}`, { studentName: student.name, amount: feeAmount }); if (smsManagementData.automation?.paymentEnabled && student.parentContact && student.parentContact.trim().toLowerCase() !== 'n/a') { const message = `প্রিয় ${student.name} (রোল: ${student.roll}), আপনার ${month} মাসের ${feeAmount} টাকা পেমেন্ট সফল হয়েছে। Trnx ID: ${monthData.token}।\n\nধন্যবাদ,\nমিরাকল`; const pendingId = `pending_mon_${Date.now()}`; db.ref(`smsManagement/pending/payment/${pendingId}`).set({ id: pendingId, timestamp: new Date().toISOString(), studentId: student.id, message: message, paymentFor: month, amount: feeAmount, classId: student.classId }); } await saveAppData(); } else if (receiverName !== null) { showToast("গ্রহণকারীর নাম আবশ্যক।","error"); return; } } else { if (!isAdminMode && monthData.status === 'paid') { showToast("'Due' করতে অ্যাডমিন মোড অ্যাক্টিভেট করুন।","error"); return; } monthData.status = 'due'; monthData.receiver = ''; monthData.date = null; monthData.token = null; logActivity(`Monthly Fee set to Due for ${month}`, { studentName: student.name }); await saveAppData(); } populateStudentMonthlyPaymentsTable(studentId); renderYearlyStatusChart(student); }
    async function handleMultiMonthPayment(studentId, pageContext){ const selectedMonths = Array.from(document.querySelectorAll('#monthlyPaymentsTableBody .month-checkbox:checked')).map(cb => cb.dataset.month); if(selectedMonths.length === 0){ showToast('অনুগ্রহ করে অন্তত একটি মাস নির্বাচন করুন।', 'info'); return; } const receiverName = prompt(`নির্বাচিত মাসগুলোর (${selectedMonths.join(', ')}) বেতন গ্রহণকারীর নাম লিখুন:`); if (!receiverName?.trim()) { if (receiverName !== null) showToast("গ্রহণকারীর নাম আবশ্যক।","error"); return; } const student = findStudentById(studentId); let totalPaid = 0; selectedMonths.forEach(month => { const feeInput = document.querySelector(`.monthly-fee-input[data-month="${month}"]`); const feeAmount = parseFloat(feeInput.value); if (!isNaN(feeAmount) && feeAmount > 0) { const monthData = student.monthlyPayments[month]; monthData.fee = feeAmount; monthData.status = 'paid'; monthData.receiver = receiverName; monthData.date = new Date().toISOString(); monthData.token = generateToken(); totalPaid += feeAmount; } }); logActivity(`Multi-month Fee Paid for ${selectedMonths.join(', ')}`, { studentName: student.name, amount: totalPaid }); if (smsManagementData.automation?.paymentEnabled && totalPaid > 0) { if (student.parentContact && student.parentContact.trim().toLowerCase() !== 'n/a') { const message = `প্রিয় ${student.name} (রোল: ${student.roll}), আপনার ${selectedMonths.join(', ')} মাসের মোট ${totalPaid} টাকা পেমেন্ট সফল হয়েছে।\n\nধন্যবাদ,\nমিরাকল`; const pendingId = `pending_mul_${Date.now()}`; db.ref(`smsManagement/pending/payment/${pendingId}`).set({ id: pendingId, timestamp: new Date().toISOString(), studentId: student.id, message: message, paymentFor: selectedMonths.join(', '), amount: totalPaid, classId: student.classId }); } } await saveAppData(); populateStudentMonthlyPaymentsTable(studentId); renderYearlyStatusChart(student); }
    async function showPaymentHistoryPage(context = {}) { context.breadcrumbs = [{ text: 'হোম', pageFn: showHomePage }, { text: 'হিস্টোরি' }]; mainContentArea.appendChild(cloneTemplate('template-payment-history')); const historyContainer = document.getElementById('history-content-area'); const historyTabs = document.getElementById('history-tabs'); async function renderPaymentHistory() { historyContainer.innerHTML = '<p>হিস্টোরি লোড হচ্ছে...</p>'; try { const combinedData = await getCombinedDataForAllYears(); const allClassCategories = combinedData.classes; const allPayments = []; (combinedData.students || []).forEach(student => { const classInfo = allClassCategories.find(c => c.id === student.classId); const studentYear = parseInt(student.academicYear); const yearLabel = studentYear !== viewedYear ? ` (${student.academicYear})` : ''; if (student.monthlyPayments && typeof student.monthlyPayments === 'object') { Object.entries(student.monthlyPayments).forEach(([monthName, payment]) => { if (payment && payment.status === 'paid' && payment.date) { allPayments.push({ date: new Date(payment.date), studentId: student.id, studentName: `${student.name}${yearLabel}`, studentRoll: student.roll, className: classInfo?.name || 'N/A', month: monthName, amount: payment.fee, paymentType: 'monthly' }); } }); } if (student.admissionFee?.status === 'paid' && student.admissionFee.date) { allPayments.push({ date: new Date(student.admissionFee.date), studentId: student.id, studentName: `${student.name}${yearLabel}`, studentRoll: student.roll, className: classInfo?.name || 'N/A', month: 'ভর্তি ফি', amount: student.admissionFee.amount, paymentType: 'admission' }); } }); allPayments.sort((a,b) => b.date - a.date); const groupedByDate = allPayments.reduce((acc, payment) => { const dateKey = payment.date.toISOString().split('T')[0]; if (!acc[dateKey]) { acc[dateKey] = { transactions: [], total: 0 }; } acc[dateKey].transactions.push(payment); acc[dateKey].total += (payment.amount || 0); return acc; }, {}); historyContainer.innerHTML = ''; if (Object.keys(groupedByDate).length === 0) { historyContainer.innerHTML = '<p>কোনো পেমেন্টের রেকর্ড পাওয়া যায়নি।</p>'; } else { for (const dateKey in groupedByDate) { const dayData = groupedByDate[dateKey]; const formattedDate = new Date(dateKey).toLocaleString('bn-BD', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); const dateGroupDiv = document.createElement('div'); dateGroupDiv.className = 'history-date-group'; let tableRows = ''; dayData.transactions.forEach(tx => { tableRows += ` <tr> <td>${tx.studentName}</td> <td>${tx.className}</td> <td>${tx.studentRoll}</td> <td>${tx.month}</td> <td>${tx.amount.toLocaleString('bn-BD')}</td> <td><button class="action-button btn-show-doc view-history-doc-btn">ডকুমেন্ট</button></td> </tr> `; }); dateGroupDiv.innerHTML = ` <div class="history-date-header"> <h4>${formattedDate}</h4> <div style="display: flex; align-items: center; gap: 15px;"> <span class="total-collection">মোট কালেকশন: ${dayData.total.toLocaleString('bn-BD')} টাকা</span> <button class="action-button print-hide daily-summary-print-btn" data-date-key="${dateKey}">POS প্রিন্ট</button> </div> </div> <div class="table-responsive-wrapper"><table> <thead> <tr> <th>ছাত্রের নাম (বছর)</th><th>ক্লাস</th><th>রোল</th><th>কিসের জন্য</th><th>টাকা</th><th>একশন</th> </tr> </thead> <tbody>${tableRows}</tbody> </table></div> `; historyContainer.appendChild(dateGroupDiv); } } historyContainer.addEventListener('click', (e) => { if (e.target && e.target.classList.contains('view-history-doc-btn')) { showToast("রশিদ দেখতে, অনুগ্রহ করে সেই ছাত্রের শিক্ষাবর্ষে গিয়ে তার প্রোফাইল থেকে দেখুন।", "info", 4000); } if (e.target.classList.contains('daily-summary-print-btn')) { const dateKey = e.target.dataset.dateKey; if (groupedByDate[dateKey]) { showDailySummaryReceipt(dateKey, groupedByDate[dateKey]); } } }); } catch (err) { console.error("Error rendering payment history:", err); historyContainer.innerHTML = '<p style="color:red;">হিস্টোরি লোড করা সম্ভব হয়নি।</p>'; } } async function renderActivityHistory() { historyContainer.innerHTML = '<p>হিস্টোরি লোড হচ্ছে...</p>'; try { const combinedData = await getCombinedDataForAllYears(); const allLogs = combinedData.activityLog; if (!allLogs || allLogs.length === 0) { historyContainer.innerHTML = '<p>কোনো অ্যাক্টিভিটি রেকর্ড পাওয়া যায়নি।</p>'; return; } allLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); const table = document.createElement('table'); table.innerHTML = `<thead><tr><th>সময়</th><th>অ্যাক্টিভিটি</th><th>বিস্তারিত</th></tr></thead><tbody></tbody>`; const tbody = table.querySelector('tbody'); allLogs.forEach(log => { const tr = document.createElement('tr'); const formattedDate = new Date(log.timestamp).toLocaleString('bn-BD'); let details = ''; if(log.studentName) details += `ছাত্র: ${log.studentName}`; if(log.roll) details += `, রোল: ${log.roll}`; if(log.class) details += `, ক্লাস: ${log.class}`; if(log.batch) details += `, ব্যাচ: ${log.batch}`; const logYear = parseInt(log.academicYear); const yearLabel = logYear !== viewedYear ? ` (${log.academicYear})` : ''; tr.innerHTML = `<td>${formattedDate}</td><td>${log.message}${yearLabel}</td><td>${details}</td>`; tbody.appendChild(tr); }); historyContainer.innerHTML = ''; historyContainer.appendChild(table); } catch (err) { console.error("Error rendering activity history:", err); historyContainer.innerHTML = '<p style="color:red;">অ্যাক্টিভিটি হিস্টোরি লোড করা সম্ভব হয়নি।</p>'; } } historyTabs.addEventListener('click', e => { if (e.target.classList.contains('tab-button')) { historyTabs.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active')); e.target.classList.add('active'); if (e.target.dataset.tab === 'payment') renderPaymentHistory(); else renderActivityHistory(); } }); document.getElementById('btnBackFromHistory')?.addEventListener('click', () => loadPage(showHomePage)); renderPaymentHistory(); }
    
    function showPaymentDocumentPage(context){ 
        const student = findStudentById(context.studentId); 
        if (!student) { loadPage(showPaymentPage); return; } 
        context.breadcrumbs = [{ text: 'হোম', pageFn: showHomePage }]; 
        if (context.cameFrom === 'history') { 
            context.breadcrumbs.push({ text: 'হিস্টোরি', pageFn: showPaymentHistoryPage }); 
        } else { 
            context.breadcrumbs.push({ text: 'পেমেন্ট', pageFn: showPaymentPage, context: { classId: student.classId } }); 
            if (context.cameFrom !== 'paymentDetails') { 
                context.breadcrumbs.push({ text: student.name, pageFn: showStudentProfilePage, context: { studentId: student.id } }); 
            } 
        } 
        context.breadcrumbs.push({ text: 'পেমেন্ট ডকুমেন্ট' }); 
        
        let paymentData, paymentTitle; 
        if(context.paymentType === 'admission'){ 
            paymentData = student.admissionFee; 
            paymentTitle = 'ভর্তি ফি'; 
        } else { 
            paymentData = student.monthlyPayments[context.month]; 
            paymentTitle = context.month; 
        } 
        
        if (!paymentData || paymentData.status !== 'paid') { 
            showToast("রশিদ তৈরির জন্য প্রয়োজনীয় তথ্য পাওয়া যায়নি।","error"); 
            const prevContext = context.cameFrom; 
            if(prevContext === 'studentProfile'){loadPage(showStudentProfilePage, { studentId: student.id });} 
            else if(prevContext === 'history'){loadPage(showPaymentHistoryPage);} 
            else if(prevContext === 'findTrnx'){loadPage(showFindTrnxIdPage);} 
            else if (prevContext === 'batchDetails') { const batchId = findBatchesForStudent(student.id)[0]?.id; if(batchId) loadPage(showBatchDetailsPage, { batchId }); else loadPage(showBatchPage); }
            else{loadPage(showStudentPaymentDetailsPage, context);} 
            return; 
        } 
        
        mainContentArea.appendChild(cloneTemplate('template-payment-document'));
        
        const printableReceiptArea = document.getElementById('printable-receipt-area');
        const studentBatches = findBatchesForStudent(student.id); 
        const batchInfoText = studentBatches.length > 0 ? studentBatches.map(b => `${b.day} (${b.time})`).join(', ') : 'N/A'; 
        const formattedDate = paymentData.date ? new Date(paymentData.date).toLocaleString('bn-BD') : 'N/A'; 
        const isFreeAdmission = context.paymentType === 'admission' && paymentData.amount === 0;
        const amountForDisplay = isFreeAdmission ? 'Free' : `${(paymentData.amount || paymentData.fee).toLocaleString('bn-BD')} টাকা`;
        const token = paymentData.token || 'N/A'; 
        
        document.getElementById('docViewTokenNo').textContent = token;
        document.getElementById('docViewStudentName').textContent = student.name;
        document.getElementById('docViewStudentSchool').textContent = student.schoolName || 'N/A';
        document.getElementById('docViewStudentRoll').textContent = student.roll;
        document.getElementById('docViewClassName').textContent = findClassById(student.classId)?.name || 'N/A';
        document.getElementById('docViewBatchInfo').textContent = batchInfoText;
        document.getElementById('docViewPaymentMonth').textContent = paymentTitle;
        document.getElementById('docViewAmountPaid').textContent = amountForDisplay;
        document.getElementById('docViewPaymentDate').textContent = formattedDate;
        document.getElementById('docViewReceiverName').textContent = paymentData.receiver || '';

        document.getElementById('btnPrintGeneratedDocument')?.addEventListener('click', () => window.print());
        document.getElementById('btnBackFromDocument')?.addEventListener('click', () => { 
            const prevContext = context.cameFrom; 
            if (prevContext === 'studentProfile') { loadPage(showStudentProfilePage, { studentId: student.id }); } 
            else if (prevContext === 'history') { loadPage(showPaymentHistoryPage); } 
            else if (prevContext === 'findTrnx') { loadPage(showFindTrnxIdPage); } 
            else if (prevContext === 'batchDetails') { const batchId = findBatchesForStudent(student.id)[0]?.id; if(batchId) loadPage(showBatchDetailsPage, { batchId }); else loadPage(showBatchPage); }
            else { loadPage(showStudentPaymentDetailsPage, context); } 
        }); 
    }
    
    function showReportsPage(context = {}) { context.breadcrumbs = [{ text: 'হোম', pageFn: showHomePage }, { text: 'রিপোর্টস' }]; mainContentArea.appendChild(cloneTemplate('template-reports-page')); const startDateInput = document.getElementById('reportStartDate'); const endDateInput = document.getElementById('reportEndDate'); const generateBtn = document.getElementById('btnGenerateReport'); const printBtn = document.getElementById('btnPrintReport'); const resultsArea = document.getElementById('report-content'); generateBtn.addEventListener('click', () => { const startDate = startDateInput.value ? new Date(startDateInput.value) : null; const endDate = endDateInput.value ? new Date(endDateInput.value) : null; if (!startDate || !endDate) { showToast('অনুগ্রহ করে শুরু এবং শেষ উভয় তারিখ দিন।', 'error'); return; } endDate.setHours(23, 59, 59, 999); showLoader(); setTimeout(() => { const reportData = { collections: [], total: 0 }; (appData.students || []).forEach(student => { if (student.admissionFee?.status === 'paid' && student.admissionFee.date) { const payDate = new Date(student.admissionFee.date); if (payDate >= startDate && payDate <= endDate) { reportData.collections.push({ studentName: student.name, studentRoll: student.roll, date: payDate, type: 'ভর্তি ফি', amount: student.admissionFee.amount }); reportData.total += student.admissionFee.amount; } } Object.entries(student.monthlyPayments).forEach(([month, payment]) => { if (payment.status === 'paid' && payment.date) { const payDate = new Date(payment.date); if (payDate >= startDate && payDate <= endDate) { reportData.collections.push({ studentName: student.name, studentRoll: student.roll, date: payDate, type: `${month} মাসের ফি`, amount: payment.fee }); reportData.total += payment.fee; } } }); }); reportData.collections.sort((a, b) => a.date - b.date); if (reportData.collections.length === 0) { resultsArea.innerHTML = `<p style="text-align:center;">এই তারিখের মধ্যে কোনো কালেকশন পাওয়া যায়নি।</p>`; } else { let tableHTML = `<div class="table-responsive-wrapper"><h4>কালেকশন রিপোর্ট (${startDate.toLocaleDateString('bn-BD')} - ${endDate.toLocaleDateString('bn-BD')})</h4> <table> <thead> <tr><th>তারিখ</th><th>ছাত্রের নাম</th><th>রোল</th><th>বিবরণ</th><th>টাকা</th></tr> </thead> <tbody>`; reportData.collections.forEach(item => { tableHTML += ` <tr> <td>${item.date.toLocaleDateString('bn-BD')}</td> <td><strong>${item.studentName}</strong></td> <td><strong>${item.studentRoll}</strong></td> <td>${item.type}</td> <td>${item.amount.toLocaleString('bn-BD')}</td> </tr> `; }); tableHTML += `</tbody></table> <div class="details-summary">মোট কালেকশন: ${reportData.total.toLocaleString('bn-BD')} টাকা</div></div>`; resultsArea.innerHTML = tableHTML; document.getElementById('printReportHeaderDates').textContent = `তারিখ: ${startDate.toLocaleDateString('bn-BD')} থেকে ${endDate.toLocaleDateString('bn-BD')}`; printBtn.disabled = false; } hideLoader(); }, 50); }); printBtn.addEventListener('click', () => window.print()); }
    function showRecycleBinPage(context = {}) { context.breadcrumbs = [{ text: 'হোম', pageFn: showHomePage }, { text: 'রিসাইকেল বিন' }]; mainContentArea.appendChild(cloneTemplate('template-recycle-bin')); const tabs = document.getElementById('recycle-bin-tabs'); const contentArea = document.getElementById('recycle-bin-content'); const renderContent = (type) => { contentArea.innerHTML = ''; const items = appData.recycleBin?.[type] || []; if (items.length === 0) { contentArea.innerHTML = `<p style="text-align:center; padding: 20px;">এই রিসাইকেল বিন খালি।</p>`; return; } items.sort((a,b) => new Date(b.deletedAt) - new Date(a.deletedAt)).forEach((item) => { const itemDiv = document.createElement('div'); itemDiv.className = 'recycle-bin-item'; let name = ''; if (type === 'students') name = `${item.name} (রোল: ${item.roll})`; else if (type === 'mainClassCategories') name = `ক্লাস: ${item.name}`; else if (type === 'batchSchedule') { const dayName = item.originalPath?.dayId ? (appData.batchSchedule || []).find(d => d.id === item.originalPath.dayId)?.dayName : 'Unknown Day'; let classSchedule = item.originalPath?.classScheduleId ? findBatchById(item.id)?.classSchedule : null; let classInfo = classSchedule ? findClassById(classSchedule.classId) : null; name = `ব্যাচ: ${dayName || ''} - ${classInfo?.name || ''} - ${item.time || ''}`; } itemDiv.innerHTML = ` <div> <strong>${name}</strong><br> <small>ডিলিটের তারিখ: ${new Date(item.deletedAt).toLocaleString('bn-BD')}</small> </div> <div class="recycle-bin-actions"> <button class="action-button btn-restore" data-type="${type}" data-id="${item.id}">Restore</button> <button class="action-button btn-delete-perm" data-type="${type}" data-id="${item.id}">Delete Permanently</button> </div> `; contentArea.appendChild(itemDiv); }); }; contentArea.addEventListener('click', (e) => { if (!e.target.matches('.btn-restore, .btn-delete-perm')) return; const { type, id } = e.target.dataset; const itemIndex = appData.recycleBin[type].findIndex(i => i.id === id); if (itemIndex === -1) return; if (e.target.matches('.btn-restore')) { let confirmMessage = "আপনি কি নিশ্চিতভাবে এটি পুনরুদ্ধার করতে চান?"; if(type === 'batchSchedule') { confirmMessage = "এই ব্যাচটি পুনরুদ্ধার করলে এর সাথে সম্পর্কিত সকল ছাত্র-ছাত্রীও পুনরুদ্ধার হয়ে যাবে। আপনি কি নিশ্চিত?"; } if(!confirm(confirmMessage)) return; const itemToRestore = appData.recycleBin[type].splice(itemIndex, 1)[0]; if (type === 'students') { const studentInDb = (appData.students || []).find(s => s.id === id); if(studentInDb) delete studentInDb.deletedAt; } else if (type === 'mainClassCategories') { const classInDb = (appData.mainClassCategories || []).find(c => c.id === id); if(classInDb) delete classInDb.deletedAt; } else if (type === 'batchSchedule') { (appData.batchSchedule || []).forEach(day => { (day.classes || []).forEach(cs => { const batchInDb = (cs.batches || []).find(b => b.id === id); if (batchInDb) delete batchInDb.deletedAt; }); }); (itemToRestore.studentIds || []).forEach(studentId => { const studentInRecycleBinIndex = appData.recycleBin.students.findIndex(s => s.id === studentId); if (studentInRecycleBinIndex > -1) { appData.recycleBin.students.splice(studentInRecycleBinIndex, 1); } const studentInDb = (appData.students || []).find(s => s.id === studentId); if (studentInDb) delete studentInDb.deletedAt; }); } saveAppData(); showToast('সফলভাবে পুনরুদ্ধার করা হয়েছে।', 'success'); renderContent(type); } else if (e.target.matches('.btn-delete-perm')) { if (confirm('আপনি কি নিশ্চিতভাবে এটি স্থায়ীভাবে মুছে ফেলতে চান? এই কাজটি আর ফেরানো যাবে না।')) { appData.recycleBin[type].splice(itemIndex, 1)[0]; saveAppData(); showToast('স্থায়ীভাবে মুছে ফেলা হয়েছে।', 'info'); renderContent(type); } } }); tabs.addEventListener('click', e => { if (e.target.matches('.tab-button')) { tabs.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active')); e.target.classList.add('active'); renderContent(e.target.dataset.tab); } }); renderContent('students'); }
    function showFindTrnxIdPage(context = {}) {
        context.breadcrumbs = [{ text: 'হোম', pageFn: showHomePage }, { text: 'Find Trnx ID' }];
        mainContentArea.appendChild(cloneTemplate('template-find-trnx-id-page'));

        const searchInput = document.getElementById('trnxIdSearchInput');
        const resultsContainer = document.getElementById('trnx-results-container');

        const allTransactions = [];
        (appData.students || []).forEach(student => {
            if (student.admissionFee?.status === 'paid' && student.admissionFee.token) {
                allTransactions.push({ studentId: student.id, studentName: student.name, paymentType: 'admission', token: student.admissionFee.token, description: 'ভর্তি ফি' });
            }
            Object.entries(student.monthlyPayments || {}).forEach(([month, payment]) => {
                if (payment.status === 'paid' && payment.token) {
                    allTransactions.push({ studentId: student.id, studentName: student.name, paymentType: 'monthly', month: month, token: payment.token, description: `${month} মাসের ফি` });
                }
            });
        });
        
        allTransactions.sort((a,b) => b.token.localeCompare(a.token));

        function renderList(filter = '') {
            const searchTerm = filter.toLowerCase();
            const filtered = allTransactions.filter(tx => tx.token.toLowerCase().includes(searchTerm));

            if (filtered.length === 0) {
                resultsContainer.innerHTML = '<p style="text-align:center;">কোনো লেনদেন পাওয়া যায়নি।</p>';
                return;
            }

            resultsContainer.innerHTML = filtered.map(tx => `
                <div class="search-result-item" data-student-id="${tx.studentId}" data-payment-type="${tx.paymentType}" data-month="${tx.month || ''}" style="padding: 12px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; cursor: pointer;">
                    <div>
                        <strong style="font-size: 1.1em;">${tx.studentName}</strong>
                        <div style="font-size: 0.9em; color: var(--text-secondary);">${tx.description}</div>
                    </div>
                    <div style="font-weight: bold; color: var(--text-tab-active);">${tx.token}</div>
                </div>
            `).join('');
        }

        resultsContainer.addEventListener('click', (e) => {
            const item = e.target.closest('.search-result-item');
            if (item) {
                const { studentId, paymentType, month } = item.dataset;
                currentStudentContext = { studentId, paymentType, month, cameFrom: 'findTrnx' };
                loadPage(showPaymentDocumentPage, { studentId, paymentType, month });
            }
        });

        searchInput.addEventListener('input', () => renderList(searchInput.value));
        renderList(searchInput.value);
    }
    function showDailySummaryReceipt(dateKey, dailyData) {
        const modalFragment = cloneTemplate('template-daily-summary-receipt-modal');
        if (!modalFragment) return;
        document.body.appendChild(modalFragment);
        const modal = document.getElementById('dailySummaryModal');
        const formattedDate = new Date(dateKey).toLocaleString('bn-BD', {
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
        });
        document.getElementById('summaryReceiptDate').textContent = formattedDate;
        document.getElementById('summaryReceiptTotal').textContent = dailyData.total.toLocaleString('bn-BD');
        const tableBody = document.getElementById('summaryReceiptTableBody');
        tableBody.innerHTML = '';
        dailyData.transactions.forEach(tx => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${tx.studentName} <br><small>(${tx.studentRoll})</small></td>
                <td style="text-align: right;">${(tx.amount || 0).toLocaleString('bn-BD')}</td>
            `;
            tableBody.appendChild(tr);
        });
        const closeModal = () => modal.remove();
        modal.querySelector('#btnCloseDailySummary').onclick = closeModal;
        modal.querySelector('#btnPrintDailySummary').onclick = () => window.print();
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });
        modal.classList.add('visible');
    }
    function renderYearlyStatusChart(student) { const chartContainer = document.getElementById('yearlyStatusChart'); if (!chartContainer || !student) return; chartContainer.innerHTML = ''; const admissionDate = student.createdAt ? new Date(student.createdAt) : new Date(); const currentYear = viewedYear; BENGALI_MONTHS.forEach((monthName, index) => { const monthStartDate = new Date(currentYear, index, 1); const isApplicable = monthStartDate >= new Date(admissionDate.getFullYear(), admissionDate.getMonth(), 1); let statusClass = 'not-applicable'; let statusText = 'N/A'; if (isApplicable) { const monthData = student.monthlyPayments?.[monthName] || {}; if (monthData.status === 'paid') { statusClass = 'paid'; statusText = 'Paid'; } else if (paymentIsDue(index, currentYear)) { statusClass = 'due'; statusText = 'Due'; } else { statusClass = 'future'; statusText = 'Future'; } } const monthBox = document.createElement('div'); monthBox.className = `month-box ${statusClass}`; monthBox.textContent = `${monthName} - ${statusText}`; monthBox.title = `${monthName}: ${statusText}`; chartContainer.appendChild(monthBox); }); }
    function populateStudentMonthlyPaymentsTable(studentId) { const student = findStudentById(studentId); if (!student) return; const tableBody = document.getElementById('monthlyPaymentsTableBody'); tableBody.innerHTML = ''; const admissionDate = student.createdAt ? new Date(student.createdAt) : new Date(); BENGALI_MONTHS.forEach((monthName, index) => { const currentYear = viewedYear; const monthStartDate = new Date(currentYear, index, 1); const isApplicable = monthStartDate >= new Date(admissionDate.getFullYear(), admissionDate.getMonth(), 1); if (!student.monthlyPayments) student.monthlyPayments = {}; if (!student.monthlyPayments[monthName]) { student.monthlyPayments[monthName] = { fee: student.monthlyFeeDefault || 0, status: 'due', receiver: '', date: null, token: null }; } else if (student.monthlyPayments[monthName].status !== 'paid' && !student.hasCustomFee) { student.monthlyPayments[monthName].fee = student.monthlyFeeDefault; } const monthData = student.monthlyPayments[monthName]; const isPaid = monthData.status === 'paid'; const row = document.createElement('tr'); row.dataset.status = isApplicable ? monthData.status : 'not-applicable'; if (!isApplicable) { row.classList.add('row-not-applicable'); } else if (isPaid) { row.classList.add('row-paid'); } else if (paymentIsDue(index, currentYear)) { row.classList.add('row-due-past'); } row.innerHTML = ` <td><input type="checkbox" id="chk-${monthName}" class="month-checkbox" data-month="${monthName}" ${!isApplicable || isPaid ? 'disabled' : ''}></td> <td><label class="month-checkbox-label" for="chk-${monthName}">${monthName}</label></td> <td><input type="number" class="monthly-fee-input assistant-disabled" data-month="${monthName}" value="${monthData.fee}" ${!isApplicable || (isPaid && !isAdminMode) ? 'disabled' : ''}></td> <td> <button class="action-button btn-paid btn-month-paid" data-month="${monthName}" ${!isApplicable ? 'disabled' : ''}>Paid</button> <button class="action-button btn-due btn-month-due" data-month="${monthName}" ${!isApplicable ? 'disabled' : ''}>Due</button> </td> <td class="month-receiver-info">${isApplicable ? (monthData.receiver || 'N/A') : 'N/A'}</td> <td><button class="action-button btn-show-doc" data-month="${monthName}" ${!isPaid ? 'disabled' : ''}>ডকুমেন্ট</button></td> `; row.querySelector('.btn-month-paid')?.addEventListener('click', (e) => handleMonthlyPayment(e.target, studentId, monthName, 'paid')); row.querySelector('.btn-month-due')?.addEventListener('click', () => handleMonthlyPayment(null, studentId, monthName, 'due')); row.querySelector('.btn-show-doc')?.addEventListener('click', () => { if (monthData.status === 'paid') { currentStudentContext = {...currentStudentContext, studentId: student.id, month: monthName, paymentType: 'monthly' }; loadPage(showPaymentDocumentPage, { studentId: student.id, month: monthName, paymentType: 'monthly' }); } }); const feeInput = row.querySelector('.monthly-fee-input'); feeInput.addEventListener('change', () => { if (isAdminMode) feeInput.style.borderColor = '#f1c40f'; }); tableBody.appendChild(row); }); }
    function showAboutDeveloperModal() { const modalFragment = cloneTemplate('template-about-developer-modal'); if (!modalFragment) { showToast('Developer information could not be loaded.', 'error'); console.error('Template "template-about-developer-modal" not found.'); return; } const modal = modalFragment.querySelector('#aboutDeveloperModal'); document.body.appendChild(modal); const closeBtn = modal.querySelector('.close-button'); const closeModal = () => modal.remove(); closeBtn.onclick = closeModal; modal.addEventListener('click', (e) => { if (e.target === modal) { closeModal(); } }); setTimeout(() => { modal.classList.add('visible'); }, 10); }
    function showEditStudentModal(studentId) {
        const student = findStudentById(studentId);
        if (!student) return;
        const modalFragment = cloneTemplate('template-edit-student-modal');
        const modal = modalFragment.querySelector('#editStudentModal');
        document.body.appendChild(modal);

        const form = modal.querySelector('#editStudentForm');
        const closeBtn = modal.querySelector('.close-button');
        const nameInput = modal.querySelector('#editStudentNameInput');
        const rollInput = modal.querySelector('#editStudentRollInput');
        const schoolInput = modal.querySelector('#editStudentSchoolInput');
        const contactInput = modal.querySelector('#editStudentParentContactInput');
        const imagePreview = modal.querySelector('#editStudentImagePreview');
        const selectPhotoBtn = modal.querySelector('#editSelectStudentPhotoBtn');
        const takePhotoBtn = modal.querySelector('#editTakeStudentPhotoBtn');
        const photoInput = modal.querySelector('#editStudentPhotoInput');
        
        let newPhotoURL = student.photoURL || null;

        if (imagePreview) {
            imagePreview.src = student.photoURL || 'images/default_avatar.png';
            imagePreview.onerror = () => handleImageError(imagePreview);
        }
        nameInput.value = student.name || '';
        rollInput.value = student.roll || '';
        schoolInput.value = student.schoolName || '';
        contactInput.value = student.parentContact || '';

        const closeModal = () => modal.remove();
        closeBtn.onclick = closeModal;
        modal.onclick = (e) => { if (e.target === modal) closeModal(); };

        const handleImageSelection = async (imageSource) => {
            showLoader();
            try {
                const compressedDataUrl = await processAndCompressImage(imageSource);
                newPhotoURL = compressedDataUrl;
                imagePreview.src = compressedDataUrl;
                showToast('ছবি সফলভাবে প্রসেস হয়েছে।', 'success');
            } catch (error) {
                console.error("Image processing failed:", error);
                showToast(error.message || 'ছবি প্রসেস করা সম্ভব হয়নি।', 'error');
            } finally {
                hideLoader();
            }
        };

        selectPhotoBtn.onclick = () => photoInput.click();
        photoInput.onchange = (e) => { const file = e.target.files[0]; if (file) handleImageSelection(file); };
        takePhotoBtn.onclick = () => { showCameraModal(blob => { if (blob) handleImageSelection(blob); }); };

        form.onsubmit = async (e) => {
            e.preventDefault();
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            showLoader();
            try {
                const newName = nameInput.value.trim();
                if (!newName) { showToast("ছাত্রের নাম খালি রাখা যাবে না।", 'error'); return; }
                student.name = newName;
                student.roll = rollInput.value.trim();
                student.schoolName = schoolInput.value.trim();
                student.parentContact = contactInput.value.trim();
                student.photoURL = newPhotoURL;
                
                logActivity('Student profile updated', { studentName: student.name, roll: student.roll });
                await saveAppData();
                showToast('প্রোফাইল সফলভাবে আপডেট করা হয়েছে!', 'success');
                closeModal();
                loadPage(showStudentProfilePage, { studentId: student.id });
            } catch (error) {
                console.error("Failed to edit student:", error);
                showToast("প্রোফাইল এডিট করার সময় একটি সমস্যা হয়েছে।", "error");
            } finally {
                hideLoader();
                submitButton.disabled = false;
            }
        };
        modal.classList.add('visible');
    }

    // --- FINAL INITIALIZATION AND EVENT LISTENERS ---
    applyTheme(localStorage.getItem(THEME_KEY) || 'light');
    btnToggleMode?.addEventListener('click', () => { if (isAdminMode) { isAdminMode = false; updateAdminModeUI(); } else { const pass = prompt('অ্যাডমিন মোডে যেতে পাসওয়ার্ড দিন:'); if (pass === currentPassword) { isAdminMode = true; showToast('অ্যাডমিন মোড অ্যাক্টিভেট হয়েছে।', 'success'); updateAdminModeUI(); } else if (pass) { showToast('ভুল পাসওয়ার্ড!', 'error'); } } });
    btnPrivacyMenu?.addEventListener('click', (e) => { e.stopPropagation(); privacyDropdown.classList.toggle('active'); if (!privacyDropdown.classList.contains('active')) { backupSubMenu.classList.remove('open'); btnBackupMenuToggle.classList.remove('open'); } });
    window.addEventListener('click', (e) => { if (privacyDropdown.classList.contains('active') && !privacyDropdown.contains(e.target) && !btnPrivacyMenu.contains(e.target)) { privacyDropdown.classList.remove('active'); backupSubMenu.classList.remove('open'); btnBackupMenuToggle.classList.remove('open'); } });
    btnBackupMenuToggle?.addEventListener('click', (e) => { e.stopPropagation(); backupSubMenu.classList.toggle('open'); btnBackupMenuToggle.classList.toggle('open'); });
    btnExportData?.addEventListener('click', () => closeDropdownAndRun(handleExport));
    btnImportData?.addEventListener('click', () => { closeDropdownAndRun(() => { const requiredPin = '13913'; const enteredPin = prompt('ডেটা ইম্পোর্ট করতে, অনুগ্রহ করে আপনার পিন দিন:'); if (enteredPin === null) { return; } if (enteredPin === requiredPin) { showToast('সঠিক পিন। অনুগ্রহ করে ফাইল নির্বাচন করুন।', 'success'); fileImporter.click(); } else { showToast('ভুল পিন! ডেটা ইম্পোর্ট করা সম্ভব নয়।', 'error'); } }); });
    btnChangePassword?.addEventListener('click', () => closeDropdownAndRun(() => { if (!isAdminMode) return; const oldPass = prompt("আপনার বর্তমান পাসওয়ার্ড দিন:"); if (oldPass !== currentPassword) { showToast("বর্তমান পাসওয়ার্ড সঠিক নয়!","error"); return; } const newPass = prompt("আপনার নতুন পাসওয়ার্ড দিন:"); if (!newPass) { showToast("নতুন পাসওয়ার্ড খালি রাখা যাবে না।","error"); return; } const confirmNewPass = prompt("নতুন পাসওয়ার্ডটি আবার দিন:"); if (newPass === confirmNewPass) { currentPassword = newPass; logActivity("Admin password changed."); saveAppData(); showToast("পাসওয়ার্ড সফলভাবে পরিবর্তন করা হয়েছে।","success"); } else { showToast("নতুন পাসওয়ার্ডগুলো মিলেনি।","error"); } }));
    btnForgotPassword?.addEventListener('click', () => closeDropdownAndRun(() => { if (confirm(`আপনি কি নিশ্চিতভাবে পাসওয়ার্ডটি রিসেট করতে চান? এটি ডিফল্ট পাসওয়ার্ডে  সেট হয়ে যাবে। Default পাসওয়াড ভুলে গেলে ডেভেলপার এর সাথে যোগাযোগ করুন`)) { currentPassword = resetDefaultPassword; isAdminMode = false; logActivity("Password forgotten and reset to default."); saveAppData(); showToast(`পাসওয়ার্ড রিসেট করা হয়েছে।`,`info`); updateAdminModeUI(); } }));
    btnLogout?.addEventListener('click', () => { closeDropdownAndRun(() => { if (confirm('আপনি কি লগআউট করতে চান?')) { sessionStorage.clear(); localStorage.removeItem('mcth_rem_creds'); firebase.auth().signOut().then(() => { location.reload(); }); } }); });
    btnNavBack.addEventListener('click', () => { if (historyIndex > 0) { historyIndex--; const state = pageHistory[historyIndex]; if (window[state.page]) loadPage(window[state.page], state.context, true); } });
    btnNavForward.addEventListener('click', () => { if (historyIndex < pageHistory.length - 1) { historyIndex++; const state = pageHistory[historyIndex]; if (window[state.page]) loadPage(window[state.page], state.context, true); } });
    btnNavRefresh.addEventListener('click', () => location.reload());
    btnClearYearData?.addEventListener('click', () => closeDropdownAndRun(async () => {
        if (!isAdminMode) return;
        const confirmationText = `DELETE ${viewedYear}`;
        const userInput = prompt(`সতর্কবার্তা! আপনি কি নিশ্চিত যে ${viewedYear} সালের সমস্ত ডেটা স্থায়ীভাবে মুছে ফেলতে চান? এই কাজটি আর ফেরানো যাবে না।\n\nনিশ্চিত করতে, "${confirmationText}" টাইপ করুন:`);
        
        if (userInput === confirmationText) {
            const pass = prompt('নিশ্চিত করার জন্য, অনুগ্রহ করে অ্যাডমিন পাসওয়ার্ড দিন:');
            if (pass === currentPassword) {
                showLoader();
                try {
                    await db.ref(`academicYears/${viewedYear}`).remove();
                    
                    const yearIndex = availableYears.indexOf(viewedYear);
                    if (yearIndex > -1) {
                        availableYears.splice(yearIndex, 1);
                        await db.ref('systemSettings/availableYears').set(availableYears);
                    }
                    
                    showToast(`${viewedYear} সালের সমস্ত ডেটা স্থায়ীভাবে মুছে ফেলা হয়েছে।`, 'success');
                    
                    setTimeout(() => location.reload(), 1500);

                } catch (e) {
                    console.error("Error clearing year data:", e);
                    showToast("বছর-এর ডেটা মুছে ফেলতে ব্যর্থ হয়েছে।", 'error');
                } finally {
                    hideLoader();
                }
            } else if (pass) {
                showToast('ভুল পাসওয়ার্ড। কাজটি বাতিল করা হয়েছে।', 'error');
            }
        } else if (userInput) {
            showToast('কনফার্মেশন টেক্সট মেলেনি। কাজটি বাতিল করা হয়েছে।', 'error');
        }
    }));
    
    // Page function mapping to window object for history navigation
    window.showHomePage = showHomePage; window.showDashboardPage = showDashboardPage; window.showBatchPage = showBatchPage; window.showPaymentPage = showPaymentPage; window.showStudentDatabasePage = showStudentDatabasePage; window.showStudentProfilePage = showStudentProfilePage; window.showBatchDetailsPage = showBatchDetailsPage; window.showStudentPaymentDetailsPage = showStudentPaymentDetailsPage; window.showPaymentHistoryPage = showPaymentHistoryPage; window.showPaymentDocumentPage = showPaymentDocumentPage; window.showDashboardDetailsPage = showDashboardDetailsPage; window.showReportsPage = showReportsPage; window.showRecycleBinPage = showRecycleBinPage; window.showFindTrnxIdPage = showFindTrnxIdPage;
    
    btnShowHistory?.addEventListener('click', () => closeDropdownAndRun(() => loadPage(showPaymentHistoryPage)));
    btnRecycleBin?.addEventListener('click', () => closeDropdownAndRun(() => loadPage(showRecycleBinPage)));
    btnFindTrnxId?.addEventListener('click', () => closeDropdownAndRun(() => loadPage(showFindTrnxIdPage)));
    btnToggleTheme?.addEventListener('click', () => closeDropdownAndRun(toggleTheme));
    btnAboutDeveloper?.addEventListener('click', () => closeDropdownAndRun(showAboutDeveloperModal));
    btnHome.addEventListener('click', () => loadPage(showHomePage));
    btnDashboard.addEventListener('click', () => loadPage(showDashboardPage));
    btnBatch.addEventListener('click', () => loadPage(showBatchPage));
    btnPayment.addEventListener('click', () => { currentStudentContext = {}; loadPage(showPaymentPage); });
    btnStudentDatabase.addEventListener('click', () => loadPage(showStudentDatabasePage));
    btnReports.addEventListener('click', () => loadPage(showReportsPage));
    btnExam.addEventListener('click', () => { window.open('exam.html', '_blank'); });
    btnAttendance.addEventListener('click', () => { window.open('attendance.html', '_blank'); });
    btnSms.addEventListener('click', () => { window.open('sms.html', '_blank'); });
    
    listenForSmsSettingsChanges(); 
    fileImporter.addEventListener('change', handleImport);
    
    // ===== Year Management Logic =====
    const yearSelector = document.getElementById('yearSelector');

    function updateYearSelectorUI() {
        yearSelector.innerHTML = '';
        availableYears.sort((a,b) => a - b).forEach(year => { 
            const option = document.createElement('option'); 
            option.value = year; 
            option.textContent = `${year}${year == activeYear ? ' (Active)' : ''}`; 
            if (year == viewedYear) { option.selected = true; } 
            yearSelector.appendChild(option); 
        });
        const isYearBarHidden = localStorage.getItem(YEAR_BAR_HIDDEN_KEY) === 'true';
        document.getElementById('year-management-controls').style.display = isYearBarHidden ? 'none' : 'flex';
        btnToggleYearBar.textContent = isYearBarHidden ? 'Show Year Bar' : 'Hide Year Bar';
        updateAdminModeUI();
    }

    yearSelector.addEventListener('change', (e) => {
        const selectedYear = parseInt(e.target.value);
        if (selectedYear !== viewedYear) {
            const pass = prompt(`শিক্ষাবর্ষ পরিবর্তন করতে অ্যাডমিন পাসওয়ার্ড দিন:`);
            if (pass === currentPassword) {
                if (isSaving) {
                    showToast("পূর্ববর্তী ডেটা সেভ হচ্ছে। অনুগ্রহ করে অপেক্ষা করুন।", "info");
                    e.target.value = viewedYear;
                    return;
                }
                dataLoaded = false;
                pageHistory = [];
                historyIndex = -1;
                sessionStorage.removeItem('mcth_session_state');
                loadAppData(selectedYear);
            } else {
                if (pass) { showToast('ভুল পাসওয়ার্ড!', 'error'); }
                e.target.value = viewedYear;
            }
        }
    });

   btnToggleYearBar.addEventListener('click', () => {
       const isHidden = localStorage.getItem(YEAR_BAR_HIDDEN_KEY) === 'true';
       localStorage.setItem(YEAR_BAR_HIDDEN_KEY, !isHidden);
       updateYearSelectorUI();
       closeDropdownAndRun();
   });

    // Start the application by fetching system settings first
    db.ref('systemSettings').once('value').then(snapshot => {
        if (snapshot.exists()) {
            const settings = snapshot.val();
            activeYear = settings.activeYear || new Date().getFullYear();
            availableYears = settings.availableYears || [2025, 2026, 2027];
        } else {
            // If no settings exist, create them
            activeYear = new Date().getFullYear();
            availableYears = [2025, 2026, 2027];
            db.ref('systemSettings').set({ activeYear, availableYears });
        }
        
        const lastViewedYear = localStorage.getItem('mcth_viewed_year');
        viewedYear = lastViewedYear ? parseInt(lastViewedYear) : activeYear;
        
        // Ensure viewedYear is a valid, available year
        if (!availableYears.includes(viewedYear)) {
            viewedYear = activeYear;
            localStorage.setItem('mcth_viewed_year', viewedYear);
        }
    
        loadAppData(viewedYear); // Start the application
    }).catch(err => {
        console.error("Could not fetch system settings, defaulting.", err);
        activeYear = new Date().getFullYear();
        availableYears = [2025, 2026, 2027];
        viewedYear = activeYear;
        loadAppData(viewedYear);
    });
}
</script>
</body>
</html>