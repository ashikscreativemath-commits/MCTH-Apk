<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCTH অ্যাটেনডেন্স - Mobile</title>
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">

    <!-- FIREBASE SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    
    <!-- Chart.js for Analysis -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <!-- Flatpickr for Multi-Date Selection -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>


    <style>
        @font-face {
          font-family: 'Kalpurush';
          src: url('fonts/kalpurush.ttf') format('truetype');
        }   
        :root {
            --bg-main: #f4f6f9; --bg-section: #ffffff; --bg-header: #1f2b38; --bg-tab-container: #e9ecef; --bg-tab: #f8f9fa; --bg-tab-active: #ffffff; --bg-input: #ffffff; --bg-input-disabled: #e9ecef; --bg-hover: #eef2f7; --text-primary: #212529; --text-secondary: #6c757d; --text-header: #ffffff; --text-tab: #495057; --text-tab-active: #0056b3; --border-color: #dee2e6; --border-accent: #007bff;
            --danger-color: #dc3545; --success-color: #28a745; --warning-color: #ffc107; --special-color: #6f42c1;
            --footer-bg: #1d3557; --footer-text: #f1faee;
        }
        
        body[data-theme='dark'] {
            --bg-main: #121212; --bg-section: #1e1e1e; --bg-header: #1f2b38; --bg-tab: #2a2a2a; --bg-tab-active: #1e1e1e; --bg-input: #252525; --bg-input-disabled: #3a3a3a; --bg-hover: #333333; --text-primary: #e8eaed; --text-secondary: #9aa0a6; --text-header: #e8eaed; --text-tab: #e8eaed; --text-tab-active: #8ab4f8; --border-color: #3a3a34; --border-accent: #8ab4f8;
            --footer-bg: #242526; --footer-text: #e4e6eb;
        }
        
        html { scroll-behavior: smooth; }
        body {
            margin: 0; padding: 0; font-family: 'Kalpurush', sans-serif; font-size: 16px; background-color: var(--bg-main); color: var(--text-primary); transition: background-color .3s, color .3s; line-height: 1.5;
        }
        
        /* Login Page Styles */
        #login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 15px; box-sizing: border-box; }
        .login-box { background-color: var(--bg-section); padding: 25px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; border: 1px solid var(--border-color); }
        .login-logo { width: 80px; height: 80px; margin: 0 auto 15px; }
        .login-box h1 { font-size: 1.5em; margin-bottom: 20px; }
        .input-group { position: relative; margin-bottom: 15px; }
        .input-group input { width: 100%; padding: 12px 15px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 1em; background-color: var(--bg-input, #fff); color: var(--text-primary); box-sizing: border-box; }
        .password-toggle-icon { position: absolute; top: 50%; right: 15px; transform: translateY(-50%); cursor: pointer; color: var(--text-secondary); }
        .login-options { display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; margin-bottom: 25px; }
        .login-button { width: 100%; padding: 12px; border: none; border-radius: 8px; background-color: var(--border-accent); color: white; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: background-color 0.3s; }
        #login-error-msg { color: var(--danger-color); margin-top: 15px; min-height: 20px; font-weight: bold; }
        #app-container.hidden { display: none; }
        .login-footer { margin-top: 25px; font-size: 0.8em; color: var(--text-secondary); }
        
        /* Main App Header Styles */
        #app-container { display: flex; flex-direction: column; min-height: 100vh; position: relative; }
        #center-watermark { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 70vw; max-width: 300px; height: 100vh; background-image: url(images/image2.png); background-size: contain; background-repeat: no-repeat; background-position: center; opacity: .05; z-index: -1; pointer-events: none; }
        body[data-theme=dark] #center-watermark{ filter: invert(1) grayscale(1); opacity: 0.08; }
        header { background-color: var(--bg-header); color: var(--text-header); padding: 8px 10px; position: sticky; top: 0; z-index: 1001; box-shadow: 0 2px 5px rgba(0,0,0,0.2); display: flex; flex-direction: column; gap: 8px; }
        .header-top-row, .header-mid-row { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        .branding-info { display: flex; flex-direction: column; }
        .branding-info .institute-name { font-size: 1.1em; font-weight: bold; }
        .header-controls { display: flex; align-items: center; gap: 10px; }
        .mode-controls { display: flex; align-items: center; gap: 5px; background-color: rgba(255,255,255,0.1); padding: 3px 6px; border-radius: 15px; }
        .mode-display { font-size: 0.8em; font-weight: bold; padding: 2px 6px; border-radius: 10px; }
        .mode-display.admin-active { background-color: #c0392b; color: white; }
        .mode-display.assistant-active { background-color: #27ae60; color: white; }
        #btnToggleMode { background: none; border: none; color: white; font-size: 0.8em; cursor: pointer; opacity: 0.9; }
        #year-management-controls { display: flex; align-items: center; gap: 8px; font-size: 0.9em; }
        #yearSelector { padding: 4px 8px; border-radius: 15px; border: 1px solid #5a6a7e; background-color: #334257; color: #e8eaed; font-size: 0.9em; cursor: pointer; -webkit-appearance: none; appearance: none;
            background-image: url("data:image/svg+xml;utf8,<svg fill='white' height='24' viewBox='0 0 24' width='24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>");
            background-repeat: no-repeat; background-position: right 5px top 50%; padding-right: 20px; }
        .global-nav-icons { display: flex; gap: 12px; }
        .nav-icon-svg { width: 22px; height: 22px; cursor: pointer; transition: opacity .2s; }
        .nav-icon-svg path { fill: var(--text-header); }
        .global-menu-container { position: relative; }
        .global-menu-btn { background: 0 0; border: none; color: var(--text-header); font-size: 1.6em; cursor: pointer; padding: 0 8px; line-height: 1; }
        .global-menu-dropdown { display: none; position: absolute; top: 40px; right: 0; background-color: var(--bg-section); color: var(--text-primary); min-width: 220px; box-shadow: 0 4px 12px rgba(0,0,0,.2); z-index: 10000; border-radius: 8px; border: 1px solid var(--border-color); overflow: hidden; }
        .global-menu-dropdown.active { display: block; }
        .global-menu-dropdown button { width: 100%; padding: 10px 15px; text-align: left; background: 0 0; border: none; cursor: pointer; font-size: 0.95em; color: var(--text-primary); display: flex; align-items: center; justify-content: space-between; }
        .global-menu-dropdown button:hover { background-color: var(--bg-hover); }
        .global-menu-dropdown hr { margin: 5px 0; border: none; border-top: 1px solid var(--border-color); opacity: 0.5; }
        .backup-submenu{display:none;background-color:var(--bg-hover);padding-left:15px}.backup-submenu.open{display:block}.backup-submenu button{padding-left:25px}.arrow-icon{display:inline-block;transition:transform .2s ease-in-out}#btnBackupMenuToggle.open .arrow-icon{transform:rotate(90deg)}
        
        main{padding:15px;flex-grow:1;position:relative;z-index:1;}
        .page-section{background-color:var(--bg-section);padding:15px;border-radius:8px;margin-bottom:15px;box-shadow:0 1px 4px rgba(0,0,0,.06);border:1px solid var(--border-color);}
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .page-header h2 { margin: 0; font-size: 1.3em; }

        /* Tab Styles */
        .tab-container { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; }
        .tab-button { background: none; border: none; padding: 12px 15px; cursor: pointer; font-size: 1em; color: var(--text-secondary); border-bottom: 3px solid transparent; transition: color 0.2s ease, border-color 0.2s ease; font-weight: 600; }
        .tab-button.active { color: var(--border-accent); border-bottom-color: var(--border-accent); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Batch/Class List */
        .class-card { background-color: var(--bg-section); padding: 15px; border-radius: 8px; border-left: 4px solid var(--special-color); margin-bottom: 15px; }
        .class-card-header { font-size: 1.3em; font-weight: bold; color: var(--special-color); margin: 0 0 15px; }
        .batch-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .batch-card { position: relative; background-color: var(--bg-hover); padding: 12px; cursor: pointer; border: 1px solid var(--border-color); border-radius: 8px; transition: all .2s ease; }
        .batch-card h4 { margin: 0 0 5px; font-size: 1.1em; }
        .batch-card p { margin: 2px 0; font-size: 0.9em; color: var(--text-secondary); }
        .batch-menu-container { position: absolute; top: 5px; right: 5px; }
        .menu-toggle-btn { background: none; border: none; font-size: 24px; line-height: 1; padding: 5px; cursor: pointer; color: var(--text-secondary); border-radius: 50%; width: 32px; height: 32px; transition: background-color 0.2s; }
        .batch-menu-dropdown { display: none; position: absolute; background-color: var(--bg-section); min-width: 140px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); z-index: 10; border: 1px solid var(--border-color); right: 0; top: 35px; border-radius: 8px; overflow: hidden; }
        .batch-menu-dropdown.active { display: block; }
        .batch-menu-dropdown button { display: flex; align-items: center; gap: 8px; width: 100%; padding: 8px 12px; background: none; border: none; cursor: pointer; font-size: 0.9em; }

        /* Attendance View Styles */
        .countdown-info, .holiday-info, .access-denied-message { font-size: 1em; font-weight: bold; padding: 12px; border-radius: 8px; margin-bottom: 10px; text-align: center; }
        .countdown-info { background-color: var(--warning-color); color: #333; }
        .holiday-info { background-color: var(--special-color); color: white; }
        .attendance-header-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-item { text-align: center; background: var(--bg-main); padding: 10px; border-radius: 6px; }
        .stat-item .label { font-size: 0.8em; color: var(--text-secondary); }
        .stat-item .value { font-size: 1.4em; font-weight: bold; }
        .stat-item .value.total { color: var(--special-color); }
        .stat-item .value.present { color: var(--success-color); }
        .stat-item .value.absent { color: var(--danger-color); }
        .student-list { display: flex; flex-direction: column; gap: 10px; }
        .student-list-item { display: grid; grid-template-columns: 40px 1fr auto; align-items: center; gap: 10px; padding: 10px; background-color: var(--bg-section); border: 1px solid var(--border-color); border-radius: 8px; }
        body.hide-student-images .student-photo { display: none; }
        body.hide-student-images .student-list-item { grid-template-columns: 1fr auto; }
        .student-photo { width: 40px; height: 40px; border-radius: 50%; overflow: hidden; background-color: var(--bg-main); }
        .student-photo img { width: 100%; height: 100%; object-fit: cover; }
        .student-name { font-weight: 600; }
        .student-school { font-size: 0.85em; color: var(--text-secondary); }
        .student-roll { font-weight: bold; font-size: 1.1em; color: var(--border-accent); }
        .attendance-action button { padding: 6px 12px; font-size: 0.9em; }
        .status-tag { padding: 4px 10px; border-radius: 12px; font-weight: bold; font-size: 0.8em; }
        .status-present { background-color: var(--success-color); color: white; }
        .status-absent { background-color: var(--danger-color); color: white; }
        
        /* Analysis & Dashboard Styles */
        .analysis-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .analysis-card { background-color: var(--bg-section); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); }
        .analysis-card h3 { margin-top: 0; border-bottom: 2px solid var(--border-accent); padding-bottom: 8px; font-size: 1.1em; }
        .student-performance-list { list-style-type: none; padding-left: 0; }
        .student-performance-list li { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--bg-main); font-size: 0.9em;}
        .student-performance-list li:last-child { border-bottom: none; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .calendar-day { padding: 8px 4px; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; margin: auto; font-size: 0.8em;}
        .day-name { font-weight: bold; color: var(--text-secondary); padding-bottom: 10px; font-size: 0.8em;}
        .day-present { background-color: var(--success-color); color: white; }
        .day-absent { background-color: var(--danger-color); color: white; }
        
        /* Holiday History Table */
        .history-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9em; }
        .history-table th, .history-table td { padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .history-table th { background-color: var(--bg-main); }
        .history-table td .batch-tag { background-color: var(--special-color); color: white; padding: 3px 6px; border-radius: 4px; font-size: 0.75em; margin-right: 4px; display: inline-block; margin-bottom: 3px; }

        /* Shared Button & Input Styles */
        button, .btn { border: none; cursor: pointer; border-radius: 6px; padding: 10px 18px; font-weight: 600; transition: all 0.2s ease-out; }
        .btn-primary { background-color: var(--border-accent); color: #fff; }
        .btn-secondary { background-color: #e4e6eb; color: #1c1e21; }
        body[data-theme='dark'] .btn-secondary { background-color: #3a3b3c; color: #e4e6eb; }
        .btn-danger { background-color: var(--danger-color); color: #fff; }
        .btn-special { background-color: var(--special-color); color: #fff; }
        input[type="search"] { padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--bg-section); color: var(--text-primary); font-size: 1em; box-sizing: border-box; width: 100%; }
        
        /* Modals & Loader */
        .modal-overlay{display:none;position:fixed;z-index:10001;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,.6);backdrop-filter:blur(4px);align-items:center;justify-content:center;}.modal-overlay.visible{display:flex}.modal-content{background-color:var(--bg-section);margin:auto;padding:20px;border-radius:12px;width:95%;max-width:500px;max-height:90vh;display:flex;flex-direction:column;box-shadow:0 5px 15px rgba(0,0,0,.3)}.modal-header{padding-bottom:15px;margin-bottom:15px;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center}.modal-header h2{margin:0;font-size:1.4em}.modal-close-btn{background:none;border:none;font-size:2em;cursor:pointer;color:var(--text-secondary);line-height:1;padding:0 5px;}.modal-body{flex-grow:1;overflow-y:auto;}.form-group{margin-bottom:15px}.form-group label{font-weight:600;color:var(--text-secondary);display:block;margin-bottom:8px;font-size:0.9em}.form-group input, .form-group select{width:100%;padding:10px;border:1px solid var(--border-color);border-radius:6px;box-sizing:border-box;background-color:var(--bg-main);color:var(--text-primary);font-size:1em;}.modal-footer{padding-top:15px;margin-top:15px;border-top:1px solid var(--border-color);display:flex;justify-content:flex-end;gap:10px}
        #loader-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:10006;display:none;align-items:center;justify-content:center}.loader{border:5px solid #f3f3f3;border-top:5px solid var(--border-accent);border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        #toast-container{position:fixed;bottom:20px;right:20px;z-index:10005;display:flex;flex-direction:column;gap:10px}.toast{padding:12px 15px;border-radius:8px;color:#fff;font-size:1em;box-shadow:0 2px 8px rgba(0,0,0,.15);opacity:0;transform:translateY(20px);transition:opacity .3s,transform .3s;max-width:300px}.toast.show{opacity:1;transform:translateY(0)}.toast.success{background-color:var(--success-color)}.toast.error{background-color:var(--danger-color)}.toast.info{background-color:#0dcaf0}
        
        /* Footer */
        .app-footer { background-color: var(--footer-bg); color: var(--footer-text); padding: 20px 15px; text-align: center; margin-top: 20px; }
        .footer-content { line-height: 1.7; }
        .footer-content p { margin: 5px 0; font-size: 0.9em; }
        .footer-content a { color: var(--footer-text); text-decoration: none; display: inline-flex; align-items: center; gap: 6px; }
        .footer-content a:hover { color: var(--border-accent); }
        .footer-socials { display: flex; justify-content: center; flex-wrap: wrap; gap: 10px 15px; margin-top: 10px; }
        .footer-contact { margin-top: 10px; }
        .footer-socials svg, .footer-contact svg { width: 16px; height: 16px; fill: currentColor; }
    </style>
</head>
<body data-theme="light">
    <div id="login-container">
        <div class="login-box">
            <img src="images/image2.png" alt="Logo" class="login-logo" onerror="this.style.display='none'">
            <h1>Attendance Management</h1>
            <form id="login-form">
                <div class="input-group">
                    <input type="text" id="name" placeholder="Assistant Name" required>
                </div>
                <div class="input-group">
                    <input type="email" id="gmail" placeholder="Assistant Gmail" required>
                </div>
                <hr style="border-top: 1px solid var(--border-color); margin: 20px 0;">
                <div class="input-group">
                    <input type="text" id="username" placeholder="System username" required>
                </div>
                <div class="input-group">
                    <input type="password" id="password" placeholder="Password" required>
                    <span id="password-toggle" class="password-toggle-icon">👁️</span>
                </div>
                <div class="login-options">
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="checkbox" id="remember-me"> Remember All Details
                    </label>
                </div>
                <button type="submit" class="login-button">Login</button>
                <div id="login-error-msg"></div>
                <div class="login-footer">
                    Developed by: Abdullah Al Rafi<br>
                    &copy; Copyright Math Creative Teaching Home 2025
                </div>
            </form>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <div id="center-watermark"></div>
        <div id="loader-overlay"><div class="loader"></div></div>
        <div id="toast-container"></div>
        <input type="file" id="fileImporter" accept=".json" style="display:none">
        
        <header>
            <div class="header-top-row">
                <div class="branding-info">
                    <span class="institute-name">MCTH Attendance</span>
                </div>
                <div class="header-controls">
                    <div id="user-info-display" style="font-size: 0.8em; text-align: right;"></div>
                    <div class="global-menu-container">
                        <button id="globalMenuBtn" class="global-menu-btn" title="Options">&#9776;</button>
                        <div id="globalMenuDropdown" class="global-menu-dropdown">
                            <button id="btnToggleTheme"><span>Change Theme</span><span id="themeIcon"></span></button>
                            <button id="btnToggleStudentImages"><span>Hide Student Image</span></button>
                            <div class="backup-menu-container">
                                <button id="btnBackupMenuToggle"><span>Backup</span><span class="arrow-icon">▶</span></button>
                                <div id="backupSubMenu" class="backup-submenu">
                                    <button id="btnExportData">💾 Export JSON</button>
                                    <button id="btnImportData">📤 Import JSON</button>
                                </div>
                            </div>
                            <button id="btnAboutDev"><span>About Developer</span></button>
                            <hr>
                            <button id="btnLogout"><span>Logout</span></button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="header-mid-row">
                 <div class="global-nav-icons">
                    <button id="btnNavBack" class="nav-btn" title="Back" style="background: none; border: none;"><svg class="nav-icon-svg" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" fill="currentColor"></path></svg></button>
                    <button id="btnNavRefresh" class="nav-btn" title="Refresh" style="background: none; border: none;"><svg class="nav-icon-svg" viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z" fill="currentColor"></path></svg></button>
                </div>
                <div id="year-management-controls">
                    <select id="yearSelector"></select>
                </div>
                <div class="mode-controls">
                    <span id="currentModeDisplay" class="mode-display">Assistant</span>
                    <button id="btnToggleMode">Admin</button>
                </div>
            </div>
        </header>

        <main id="app-main-content"></main>

        <footer class="app-footer">
            <div class="footer-content">
                <p>&copy; Math Creative Teaching Home 2025</p>
                <p>Developed by Abdullah Al Rafi</p>
                <div class="footer-socials">
                    <a href="https://wa.me/8801745938158" target="_blank" rel="noopener noreferrer"><svg viewBox="0 0 24 24"><path d="M12.04 2C6.58 2 2.13 6.45 2.13 11.91C2.13 13.66 2.61 15.31 3.48 16.76L2 22L7.43 20.48C8.82 21.3 10.39 21.81 12.04 21.81C17.5 21.81 21.95 17.36 21.95 11.9C21.95 9.27 20.92 6.81 19.05 4.94C17.18 3.07 14.72 2 12.04 2M12.04 3.67C14.25 3.67 16.31 4.53 17.87 6.09C19.42 7.65 20.28 9.71 20.28 11.91C20.28 16.47 16.6 20.15 12.04 20.15C10.56 20.15 9.15 19.71 7.96 18.9L7.54 18.64L3.8 19.77L4.95 16.11L4.68 15.68C3.78 14.43 3.32 12.96 3.32 11.91C3.32 7.35 6.99 3.67 12.04 3.67M16.57 14.45C16.37 14.35 15.28 13.81 15.08 13.73C14.88 13.65 14.73 13.61 14.59 13.86C14.44 14.11 13.99 14.65 13.84 14.8C13.69 14.95 13.54 14.96 13.34 14.86C13.14 14.76 12.28 14.47 11.27 13.59C10.49 12.91 9.96 12.06 9.81 11.81C9.66 11.56 9.79 11.45 9.91 11.33C10.02 11.22 10.16 11.03 10.29 10.88C10.41 10.73 10.46 10.61 10.54 10.43C10.61 10.26 10.56 10.11 10.51 10.01C10.46 9.91 10.03 8.82 9.83 8.32C9.64 7.82 9.44 7.86 9.29 7.85H9.01C8.86 7.85 8.64 7.9 8.44 8.1C8.24 8.3 7.79 8.75 7.79 9.76C7.79 10.77 8.48 11.73 8.58 11.88C8.68 12.03 10.03 14.16 12.11 14.99C12.59 15.18 12.95 15.29 13.25 15.38C13.78 15.53 14.28 15.49 14.68 15.43C15.12 15.36 16.11 14.81 16.31 14.71C16.51 14.61 16.57 14.55 16.57 14.45Z"></path></svg>
                        <span>01745938158</span>
                    </a>
                    <a href="mailto:rafiofficialpc@gmail.com"><svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"></path></svg><span>rafiofficialpc@gmail.com</span></a>
                </div>
            </div>
        </footer>
    </div>
    
    <!-- TEMPLATES -->
    <template id="template-about-dev-modal">
        <div id="aboutDeveloperModal" class="modal-overlay"> <div class="modal-content" style="max-width: 95%; padding: 15px;"> <div class="modal-header"> <h2>About the Developer</h2> <button class="modal-close-btn">&times;</button> </div> <div class="modal-body" style="padding:0;"> <img src="images/Abdullah-Al-Rafi-Digital-Card.png" alt="Developer Digital Card" style="width: 100%; height: auto; border-radius: 8px; display: block;" onerror="this.alt='Image not found.';"> </div> </div> </div>
    </template>
    <template id="template-batch-list-view">
        <div class="page-section">
            <div id="main-tabs" class="tab-container">
                <button class="tab-button active" data-tab="batches">ব্যাচসমূহ</button>
                <button class="tab-button admin-only" data-tab="holidays">ছুটি ঘোষণা</button>
            </div>
            <div id="tab-content-batches" class="tab-content active">
                <div class="page-header">
                    <h2>Select a Batch</h2>
                    <button id="btnStudentDashboard" class="btn-special" style="font-size:0.9em; padding: 8px 12px;">👨‍🎓 Student Dashboard</button>
                </div>
                <div id="class-list-container"></div>
            </div>
            <div id="tab-content-holidays" class="tab-content"></div>
        </div>
    </template>
    <template id="template-batch-attendance-view">
        <div class="page-section">
            <div id="class-timer-info" style="display: none;"></div>
            <div class="page-header">
                <div>
                    <h2 id="attendance-batch-name"></h2>
                    <p id="attendance-batch-info" style="color: var(--text-secondary); margin: 5px 0 0;"></p>
                </div>
            </div>
            <div class="attendance-header-stats">
                <div class="stat-item">
                    <div class="label">আজকের তারিখ</div>
                    <div class="value" id="stat-date">--</div>
                </div>
                <div class="stat-item">
                    <div class="label">মোট ছাত্র</div>
                    <div class="value total" id="stat-total">0</div>
                </div>
                <div class="stat-item">
                    <div class="label">উপস্থিত</div>
                    <div class="value present" id="stat-present">0</div>
                </div>
                <div class="stat-item">
                    <div class="label">অনুপস্থিত</div>
                    <div class="value absent" id="stat-absent">0</div>
                </div>
            </div>
            <input type="search" id="studentSearchInput" placeholder="রোল দিয়ে সার্চ করুন..." style="margin-bottom: 20px;">
            <div id="student-list" class="student-list"></div>
        </div>
    </template>
    <template id="template-access-denied-view">
         <div class="page-section" style="text-align: center; padding: 25px;">
            <h2 id="access-denied-batch-name" style="margin-bottom: 15px;"></h2>
            <div id="access-denied-message" class="access-denied-message"></div>
            <div id="class-timer-info" style="margin-top: 15px;"></div>
            <div id="next-class-details" style="font-size: 1em; color: var(--text-secondary); margin-top: 5px;"></div>
         </div>
    </template>
    <template id="template-schedule-modal">
        <div id="scheduleModal" class="modal-overlay"> <div class="modal-content"> <div class="modal-header"> <h2 id="scheduleModalTitle">Set Batch Schedule</h2> <button class="modal-close-btn">&times;</button> </div> <form id="scheduleForm"> <div class="modal-body"> <div class="form-group"> <label>Select Class Days</label> <div class="day-selector"> <label><input type="checkbox" name="classDay" value="1"><span>Mon</span></label> <label><input type="checkbox" name="classDay" value="2"><span>Tue</span></label> <label><input type="checkbox" name="classDay" value="3"><span>Wed</span></label> <label><input type="checkbox" name="classDay" value="4"><span>Thu</span></label> <label><input type="checkbox" name="classDay" value="5"><span>Fri</span></label> <label><input type="checkbox" name="classDay" value="6"><span>Sat</span></label> <label><input type="checkbox" name="classDay" value="0"><span>Sun</span></label> </div> </div> <div style="display: flex; gap: 20px;"> <div class="form-group" style="flex: 1;"> <label for="startTime">Class Start Time</label> <input type="time" id="startTime" required> </div> <div class="form-group" style="flex: 1;"> <label for="endTime">Class End Time</label> <input type="time" id="endTime" required> </div> </div> </div> <div class="modal-footer"> <button type="button" class="btn-secondary" id="btnCancelSchedule">Cancel</button> <button type="submit" class="btn-primary" id="btnSaveSchedule">Save Schedule</button> </div> </form> </div> </div>
    </template>
    <template id="template-batch-analysis-view">
        <div class="page-header"> <h2 id="analysisBatchName">Batch Analysis</h2> </div> <div id="analysis-content"> <div class="attendance-header-stats" id="analysis-summary-stats"> <div class="stat-item"> <div class="label">Overall Attendance</div> <div class="value present" id="stat-overall-percentage">-%</div> </div> <div class="stat-item"> <div class="label">Total Classes</div> <div class="value total" id="stat-total-classes">0</div> </div> <div class="stat-item"> <div class="label">Avg. Students</div> <div class="value" id="stat-avg-students">0</div> </div> </div> <div class="analysis-grid"> <div class="analysis-card"> <h3>Present vs. Absent</h3> <canvas id="overallAttendanceChart"></canvas> </div> <div class="analysis-card"> <h3>Top 5 Present Students</h3> <ol id="topPresentersList" class="student-performance-list"></ol> </div> <div class="analysis-card"> <h3>Top 5 Absent Students</h3> <ol id="topAbsenteesList" class="student-performance-list"></ol> </div> <div class="analysis-card"> <h3>Attendance Trend</h3> <canvas id="attendanceTrendChart"></canvas> </div> <div class="analysis-card"> <h3>Day-wise Performance</h3> <canvas id="dayWiseChart"></canvas> </div> </div> </div>
    </template>
    <template id="template-student-dashboard-selector-view">
        <div class="page-header"> <h2>Student Dashboard</h2> <input type="search" id="studentDashboardSearch" placeholder="Search student by name or roll..."> </div> <div class="page-section"> <div id="student-dashboard-list" class="student-list"></div> </div>
    </template>
    <template id="template-student-dashboard-view">
         <div class="page-header"> <h2 id="studentDashboardName"></h2> </div> <div class="attendance-header-stats"> <div class="stat-item"> <div class="label">Attendance %</div> <div class="value present" id="stat-student-percentage">-%</div> </div> <div class="stat-item"> <div class="label">Total Classes</div> <div class="value total" id="stat-student-total">0</div> </div> <div class="stat-item"> <div class="label">Present</div> <div class="value present" id="stat-student-present">0</div> </div> <div class="stat-item"> <div class="label">Absent</div> <div class="value absent" id="stat-student-absent">0</div> </div> </div> <div class="page-section"> <div class="analysis-grid"> <div class="analysis-card"> <h3>Monthly Overview</h3> <div class="calendar-container" style="padding:0; border:none; box-shadow: none;"> <div class="calendar-header"> <button id="prevMonthBtn" class="nav-btn">&lt;</button> <h3 id="calendarMonthYear"></h3> <button id="nextMonthBtn" class="nav-btn">&gt;</button> </div> <div class="calendar-grid day-names" style="font-size:0.8em;"> <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div> </div> <div id="calendar-days" class="calendar-grid"></div> </div> </div> <div class="analysis-card"> <h3>Personal Attendance</h3> <canvas id="personalAttendanceChart"></canvas> </div> <div class="analysis-card"> <h3>Comparison with Batch Avg.</h3> <canvas id="comparisonChart"></canvas> </div> <div class="analysis-card"> <h3>Absence Pattern by Day</h3> <canvas id="studentDayAbsenceChart"></canvas> </div> </div> </div>
    </template>
    <template id="template-holiday-view">
        <div class="page-header"><h2>ছুটি ঘোষণা করুন</h2></div>
        <div class="page-section">
            <div class="form-group">
                <label for="holiday-dates-picker">তারিখ নির্বাচন করুন</label>
                <input type="text" id="holiday-dates-picker" placeholder="Select dates from the calendar...">
            </div>
            <div class="form-group">
                <label>ব্যাচ নির্বাচন করুন</label>
                <div style="margin-bottom: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">
                     <label><input type="checkbox" id="holiday-select-all-batches"> <strong>সবগুলো ব্যাচ</strong></label>
                </div>
                <div id="holiday-batch-selector" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); padding: 10px; border-radius: 6px; background-color: var(--bg-main);"></div>
            </div>
            <button id="btn-declare-holiday" class="btn-primary" style="width: 100%;">ছুটি ঘোষণা করুন</button>
        </div>
        <div class="page-section">
            <h3>পূর্ববর্তী ছুটির তালিকা</h3>
            <div class="table-responsive-wrapper">
                <table id="holiday-history-table" class="history-table">
                    <thead> <tr> <th>Date</th> <th>Batches</th> </tr> </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </template>

<script>
// ================================================================== //
//            FIREBASE CONFIGURATION AND INITIALIZATION             //
// ================================================================== //
const firebaseConfig = {
    apiKey: "AIzaSyBE0xJ1nvqSj6a9bXtrtrNTDh0bu7PMLnw",
    authDomain: "math-creative-teaching-h-a86fd.firebaseapp.com",
    projectId: "math-creative-teaching-h-a86fd",
    storageBucket: "math-creative-teaching-h-a86fd.appspot.com",
    messagingSenderId: "547365102808",
    appId: "1:547365102808:web:45c46b74ffaaa945dda3ad",
    databaseURL: "https://math-creative-teaching-h-a86fd-default-rtdb.asia-southeast1.firebasedatabase.app"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const credsRef = db.ref('credentials');

// ================================================================== //
//                LOGIN SCRIPT START                                //
// ================================================================== //
document.addEventListener('DOMContentLoaded', () => {
    const REMEMBER_KEY = 'mcth_attendance_rem_creds'; 
    const SESSION_KEY = 'mcth_attendance_is_logged_in';

    const loginContainer = document.getElementById('login-container');
    const appContainer = document.getElementById('app-container');
    const loginForm = document.getElementById('login-form');
    const nameInput = document.getElementById('name');
    const gmailInput = document.getElementById('gmail');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const passwordToggle = document.getElementById('password-toggle');
    const rememberMeCheckbox = document.getElementById('remember-me');
    const errorMsgDiv = document.getElementById('login-error-msg');
    
    if (sessionStorage.getItem(SESSION_KEY) === 'true') {
        loginContainer.style.display = 'none';
        appContainer.classList.remove('hidden');
        firebase.auth().signInAnonymously().then(() => {
            initializeAppLogic();
        }).catch(err => {
            console.error("Anonymous sign-in failed on session restore:", err);
            errorMsgDiv.textContent = 'Authentication session restore failed.';
        });
        return;
    }

    passwordToggle.addEventListener('click', () => {
        const isPassword = passwordInput.type === 'password';
        passwordInput.type = isPassword ? 'text' : 'password';
        passwordToggle.textContent = isPassword ? '🙈' : '👁️';
    });

    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = nameInput.value.trim();
        const gmail = gmailInput.value.trim();
        const username = usernameInput.value;
        const password = passwordInput.value;
        errorMsgDiv.textContent = ''; 

        if (!name || !gmail) {
            errorMsgDiv.textContent = 'অনুগ্রহ করে আপনার নাম এবং Gmail দিন।';
            return;
        }

        try {
            await firebase.auth().signInAnonymously();

            const snapshot = await credsRef.once('value');
            const correctCreds = snapshot.exists() ? snapshot.val() : { username: "ashik'smathhome@602", password: "jaleswaritolamath25" };

            if (username === correctCreds.username && password === correctCreds.password) {
                const userInfo = { name, gmail, user: username, pass: password };
                if (rememberMeCheckbox.checked) {
                    localStorage.setItem(REMEMBER_KEY, JSON.stringify(userInfo));
                } else {
                    localStorage.removeItem(REMEMBER_KEY);
                }
                sessionStorage.setItem(SESSION_KEY, 'true');
                sessionStorage.setItem('mcth_attendance_user', JSON.stringify({name, gmail}));
                
                loginContainer.style.display = 'none';
                appContainer.classList.remove('hidden');
                initializeAppLogic();
            } else {
                errorMsgDiv.textContent = 'ইউজারনেম বা পাসওয়ার্ড সঠিক নয়।';
                firebase.auth().signOut();
            }
        } catch (error) {
            console.error("Firebase login error:", error);
            errorMsgDiv.textContent = 'ডাটাবেস কানেক্ট করা যায়নি বা অনুমতি নেই।';
            if (firebase.auth().currentUser) {
                firebase.auth().signOut();
            }
        }
    });

    const rememberedCreds = localStorage.getItem(REMEMBER_KEY);
    if (rememberedCreds) {
        try {
            const creds = JSON.parse(rememberedCreds);
            nameInput.value = creds.name || '';
            gmailInput.value = creds.gmail || '';
            usernameInput.value = creds.user || '';
            passwordInput.value = creds.pass || '';
            rememberMeCheckbox.checked = true;
        } catch(e) {
            localStorage.removeItem(REMEMBER_KEY);
        }
    }
});

// ================================================================== //
//          MAIN APPLICATION SCRIPT START                           //
// ================================================================== //
function initializeAppLogic() {
    let appData = {}, currentUser = {}, isAdminMode = false, currentBatchId = null;
    let charts = {}; 

    let viewedYear = 2026;
    let activeYear = new Date().getFullYear();
    let dataRef; 
    let dataLoaded = false;
    let currentPassword = '';
    let countdownInterval;
    let attendanceListener = null;

    const mainContainer = document.getElementById('app-main-content');
    const fileImporter = document.getElementById('fileImporter');
    const VIEWED_YEAR_KEY = 'mcth_attendance_viewed_year';

    // --- Utility Functions ---
    const showLoader = () => document.getElementById('loader-overlay').style.display = 'flex';
    const hideLoader = () => document.getElementById('loader-overlay').style.display = 'none';
    function showToast(message, type = 'info', duration = 3000) { const c = document.getElementById('toast-container'); if (!c) return; const t = document.createElement('div'); t.className = `toast ${type}`; t.textContent = message; c.appendChild(t); setTimeout(() => t.classList.add('show'), 10); setTimeout(() => { t.classList.remove('show'); t.addEventListener('transitionend', () => t.remove()); }, duration); }
    function applyTheme(theme) { document.body.setAttribute('data-theme', theme); localStorage.setItem('attendanceAppTheme', theme); }
    function toggleTheme() { const currentTheme = document.body.getAttribute('data-theme') || 'light'; const newTheme = currentTheme === 'light' ? 'dark' : 'light'; applyTheme(newTheme); }
    function getStudentPhotoPlaceholder() { return `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path></svg>`;}
    function getTodayDateString() { const now = new Date(); const bstNow = new Date(now.getTime() + (6 * 60 * 60 * 1000)); return bstNow.toISOString().split('T')[0]; }
    const getDbRefForYear = (year) => db.ref(`academicYears/${year}/data`);
    
    // --- View Rendering Engine ---
    let viewHistory = [];
    let historyIndex = -1;
    function renderView(viewFunction, context = {}, isNavigating = false) {
        Object.values(charts).forEach(chart => chart.destroy());
        charts = {};
        if(countdownInterval) clearInterval(countdownInterval);
        if(attendanceListener) { dataRef.child(`attendance/records/${getTodayDateString()}/${currentBatchId}`).off('value', attendanceListener); attendanceListener = null; }

        if (!isNavigating) {
            const state = { page: viewFunction.name, context };
            if (historyIndex < viewHistory.length - 1) viewHistory = viewHistory.slice(0, historyIndex + 1);
            viewHistory.push(state);
            historyIndex = viewHistory.length - 1;
        }
        mainContainer.innerHTML = '';
        
        const viewName = viewFunction.name.replace('render', '').replace('View', '');
        const templateId = 'template-' + viewName.replace(/([a-z0-9])([A-Z])/g, '$1-$2').toLowerCase() + '-view';

        const template = document.getElementById(templateId);
        if (template) {
            mainContainer.appendChild(template.content.cloneNode(true));
            viewFunction(context);
        } else {
            console.error(`Template not found: ${templateId}`);
            mainContainer.innerHTML = `<p style="color:red; text-align:center;">Error: View template could not be loaded.</p>`;
        }
        updateNavButtons();
    }
    function updateNavButtons() {
        const btnNavBack = document.getElementById('btnNavBack');
        btnNavBack.style.opacity = historyIndex > 0 ? '1' : '0.4';
        btnNavBack.style.cursor = historyIndex > 0 ? 'pointer' : 'default';
        btnNavBack.disabled = historyIndex <= 0;
    }
    
    // --- App & Data Initialization ---
    function initializeApp() {
        try {
            currentUser = JSON.parse(sessionStorage.getItem('mcth_attendance_user'));
            const userInfoDisplay = document.getElementById('user-info-display');
            if(userInfoDisplay && currentUser) userInfoDisplay.textContent = `Asst: ${currentUser.name}`;
        } catch (e) { currentUser = { name: 'Unknown', gmail: 'Unknown' }; }
        
        applyTheme(localStorage.getItem('attendanceAppTheme') || 'light');
        applyImageVisibilityPreference();
        setupHeaderEventListeners();
        
        db.ref('systemSettings/activeYear').once('value').then(snapshot => {
            activeYear = snapshot.exists() ? snapshot.val() : new Date().getFullYear();
            const lastViewedYear = localStorage.getItem(VIEWED_YEAR_KEY);
            viewedYear = lastViewedYear ? parseInt(lastViewedYear) : 2026;
            loadAppData(viewedYear);
        }).catch(err => {
            console.error("Could not fetch active year, defaulting.", err);
            const lastViewedYear = localStorage.getItem(VIEWED_YEAR_KEY);
            viewedYear = lastViewedYear ? parseInt(lastViewedYear) : 2026;
            loadAppData(viewedYear);
        });
    }

    function loadAppData(yearToLoad) { 
        showLoader();
        viewedYear = yearToLoad;
        localStorage.setItem(VIEWED_YEAR_KEY, viewedYear);
        dataRef = getDbRefForYear(viewedYear);

        dataRef.on('value', snapshot => {
             hideLoader(); 
             appData = snapshot.exists() ? snapshot.val() : {}; 
             if (!appData.attendance) appData.attendance = { schedules: {}, records: {}, holidays: {} };
             if (!appData.attendance.holidays) appData.attendance.holidays = {};
             currentPassword = appData.currentPassword || 'ashik@602';
             
             if (!dataLoaded) {
                 dataLoaded = true;
                 renderView(renderBatchListView);
             } else {
                const currentView = viewHistory[historyIndex];
                if (currentView && window[currentView.page]) {
                     renderView(window[currentView.page], currentView.context, true);
                }
             }
             updateYearSelectorUI();
        }, error => {
            hideLoader(); 
            console.error("Firebase read failed: ", error); 
            showToast("Cannot connect to database.", "error"); 
        });
    }
    
    function setupHeaderEventListeners() {
        const yearSelector = document.getElementById('yearSelector');
        document.getElementById('globalMenuBtn').addEventListener('click', e => { e.stopPropagation(); document.getElementById('globalMenuDropdown').classList.toggle('active'); });
        document.body.addEventListener('click', () => document.getElementById('globalMenuDropdown').classList.remove('active'));
        document.getElementById('btnToggleTheme').addEventListener('click', toggleTheme);
        document.getElementById('btnToggleStudentImages').addEventListener('click', toggleImageVisibility);
        document.getElementById('btnAboutDev').addEventListener('click', () => { const template = document.getElementById('template-about-dev-modal'); if (template) { const modal = template.content.cloneNode(true); document.body.appendChild(modal); const modalElement = document.getElementById('aboutDeveloperModal'); const closeBtn = modalElement.querySelector('.modal-close-btn'); const closeModal = () => modalElement.remove(); closeBtn.onclick = closeModal; modalElement.onclick = (e) => { if (e.target === modalElement) closeModal(); }; setTimeout(() => modalElement.classList.add('visible'), 10); } });
        document.getElementById('btnLogout').addEventListener('click', () => { if (confirm('আপনি কি লগআউট করতে চান?')) { sessionStorage.clear(); localStorage.removeItem('mcth_attendance_rem_creds'); location.reload(); } });
        document.getElementById('btnNavBack').addEventListener('click', () => { if (historyIndex > 0) { historyIndex--; renderView(window[viewHistory[historyIndex].page], viewHistory[historyIndex].context, true); } });
        document.getElementById('btnNavRefresh').addEventListener('click', () => location.reload());
        document.getElementById('btnBackupMenuToggle')?.addEventListener('click', (e) => { e.stopPropagation(); document.getElementById('backupSubMenu').classList.toggle('open'); e.currentTarget.classList.toggle('open'); });
        document.getElementById('btnExportData').addEventListener('click', handleExport);
        document.getElementById('btnImportData').addEventListener('click', () => { const pin = prompt("ডেটা ইম্পোর্ট করতে, অনুগ্রহ করে আপনার পিন দিন:"); if (pin === '13913') fileImporter.click(); else if (pin) showToast('ভুল পিন!', 'error'); });
        fileImporter.addEventListener('change', handleImport);
        document.getElementById('btnToggleMode').addEventListener('click', toggleAdminMode);

        yearSelector.addEventListener('change', (e) => {
            const selectedYear = parseInt(e.target.value);
            if (selectedYear !== viewedYear) {
                const pass = prompt('শিক্ষাবর্ষ পরিবর্তন করতে অ্যাডমিন পাসওয়ার্ড দিন:');
                if (pass === currentPassword) {
                    if (isSaving) { showToast("ডেটা সেভ হচ্ছে, অপেক্ষা করুন।", "info"); e.target.value = viewedYear; return; }
                    dataLoaded = false; viewHistory = []; historyIndex = -1; sessionStorage.removeItem('mcth_session_state');
                    localStorage.setItem(VIEWED_YEAR_KEY, selectedYear);
                    loadAppData(selectedYear);
                    showToast(`শিক্ষাবর্ষ ${selectedYear} তে পরিবর্তন করা হয়েছে।`, 'success');
                } else {
                    if(pass) showToast('ভুল পাসওয়ার্ড!', 'error');
                    yearSelector.value = viewedYear;
                }
            }
        });
        updateAdminModeUI();
    }
    
    function updateYearSelectorUI() {
        const yearSelector = document.getElementById('yearSelector');
        yearSelector.innerHTML = '';
        const calendarYear = new Date().getFullYear();
        const years = Array.from(new Set([activeYear, viewedYear, 2026, calendarYear, calendarYear - 1, calendarYear + 1])).sort((a,b) => b - a);
        years.forEach(year => { const option = document.createElement('option'); option.value = year; option.textContent = `${year}${year == activeYear ? ' (Active)' : ''}`; if (year == viewedYear) option.selected = true; yearSelector.appendChild(option); });
        document.getElementById('year-management-controls').style.visibility = 'visible';
    }

    function applyImageVisibilityPreference() { const showImages = localStorage.getItem('mcth_show_images') !== 'false'; const btn = document.getElementById('btnToggleStudentImages')?.querySelector('span'); if (showImages) { document.body.classList.remove('hide-student-images'); if(btn) btn.textContent = 'Hide Images'; } else { document.body.classList.add('hide-student-images'); if(btn) btn.textContent = 'Show Images'; } }
    function toggleImageVisibility() { const isCurrentlyHidden = document.body.classList.contains('hide-student-images'); localStorage.setItem('mcth_show_images', isCurrentlyHidden); applyImageVisibilityPreference(); }
    function logActivity(action, details = {}) { dataRef.child('attendance/activityLog').push({ timestamp: new Date().toISOString(), user: `${currentUser.name} (${currentUser.gmail})`, action, details }); }

    function updateAdminModeUI() {
        const display = document.getElementById('currentModeDisplay');
        if (!display) return;
        isAdminMode = sessionStorage.getItem('isAdminMode') === 'true';
        document.body.classList.toggle('admin-mode-active', isAdminMode);
        display.textContent = isAdminMode ? 'Admin' : 'Assistant';
        display.classList.toggle('admin-active', isAdminMode);
        display.classList.toggle('assistant-active', !isAdminMode);
        document.getElementById('btnToggleMode').textContent = isAdminMode ? 'Exit' : 'Admin';
        document.querySelectorAll('.admin-only').forEach(el => el.style.display = isAdminMode ? '' : 'none');
        document.getElementById('yearSelector').disabled = !isAdminMode;
        const holidayTab = document.querySelector('.tab-button[data-tab="holidays"]');
        if (holidayTab) holidayTab.style.display = isAdminMode ? '' : 'none';
        const scheduleButtons = document.querySelectorAll('.btn-schedule');
        scheduleButtons.forEach(btn => btn.style.display = isAdminMode ? '' : 'none');
    }

    function toggleAdminMode() {
        const wasAdmin = sessionStorage.getItem('isAdminMode') === 'true';
        if (wasAdmin) {
            sessionStorage.setItem('isAdminMode', 'false');
            updateAdminModeUI();
        } else {
            const pass = prompt('অ্যাডমিন মোডে যেতে পাসওয়ার্ড দিন:');
            if (pass === currentPassword) {
                sessionStorage.setItem('isAdminMode', 'true');
                showToast('অ্যাডমিন মোড অ্যাক্টিভেট হয়েছে।', 'success');
                updateAdminModeUI();
            } else if (pass) {
                showToast('ভুল পাসওয়ার্ড!', 'error');
            }
        }
    }
    
    function handleExport(){ dataRef.child('attendance').once('value', snapshot => { if(!snapshot.exists()) return showToast('No data to export.', 'error'); const dataStr = JSON.stringify(snapshot.val(), null, 2); const blob = new Blob([dataStr], { type: "application/json" }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `attendance_${viewedYear}_${getTodayDateString()}.json`; a.click(); URL.revokeObjectURL(url); showToast("Data exported.", 'success'); }); }
    function handleImport(event) { const file = event.target.files[0]; if (!file || !confirm(`Replace all attendance data for ${viewedYear}?`)) return; const reader = new FileReader(); reader.onload = e => { try { const data = JSON.parse(e.target.result); dataRef.child('attendance').set(data).then(() => showToast('Data imported.', 'success')).catch(err => showToast(`Error: ${err.message}`, 'error')); } catch (err) { showToast('Invalid JSON file.', 'error'); } }; reader.readAsText(file); }
    
    function renderBatchListView() {
        const tabsContainer = mainContainer.querySelector('#main-tabs');
        tabsContainer.querySelectorAll('.tab-button').forEach(btn => {
            btn.addEventListener('click', () => {
                tabsContainer.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                mainContainer.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                const targetContent = document.getElementById(`tab-content-${btn.dataset.tab}`);
                if (targetContent) targetContent.classList.add('active');
                if (btn.dataset.tab === 'holidays') renderHolidayContent();
                else if (btn.dataset.tab === 'batches') renderBatchListContent();
            });
        });
        renderBatchListContent();
        updateAdminModeUI();
    }
    
    function renderBatchListContent(){
        const classContainer = document.getElementById('class-list-container');
        if (!classContainer) return;
        const classGroups = {};
        (appData.batchSchedule || []).forEach(day => {
            if (day.deletedAt) return;
            (day.classes || []).forEach(cls => {
                if (cls.deletedAt) return;
                const classInfo = (appData.mainClassCategories || []).find(c => c.id === cls.classId);
                if (!classInfo) return;
                if (!classGroups[classInfo.id]) classGroups[classInfo.id] = { name: classInfo.name, batches: [] };
                (cls.batches || []).forEach(batch => {
                    if (!batch.deletedAt) classGroups[classInfo.id].batches.push({ ...batch, dayName: day.dayName, className: classInfo.name });
                });
            });
        });

        if (Object.keys(classGroups).length === 0) { classContainer.innerHTML = `<p style="text-align:center; color: var(--text-secondary);">No active classes for year ${viewedYear}.</p>`; return; }
        classContainer.innerHTML = '';
        Object.values(classGroups).forEach(classGroup => {
            const classCard = document.createElement('div');
            classCard.className = 'class-card';
            let batchHTML = classGroup.batches.map(batch => `
                <div class="batch-card" data-batch-id="${batch.id}">
                     <div class="batch-menu-container">
                        <button class="menu-toggle-btn">&vellip;</button>
                        <div class="batch-menu-dropdown">
                            <button class="btn-schedule admin-only" data-batch-id="${batch.id}">📅 Schedule</button>
                            <button class="btn-analysis" data-batch-id="${batch.id}">📊 Analysis</button>
                        </div>
                    </div>
                    <h4>${batch.time}</h4>
                    <p><strong>Day:</strong> ${batch.dayName}</p>
                </div>`).join('');
            classCard.innerHTML = `<h3 class="class-card-header">${classGroup.name}</h3><div class="batch-grid">${batchHTML}</div>`;
            classContainer.appendChild(classCard);
        });

        classContainer.addEventListener('click', e => {
            const menuToggle = e.target.closest('.menu-toggle-btn');
            const scheduleBtn = e.target.closest('.btn-schedule');
            const analysisBtn = e.target.closest('.btn-analysis');
            const batchCard = e.target.closest('.batch-card');

            if (menuToggle) { e.stopPropagation(); document.querySelectorAll('.batch-menu-dropdown.active').forEach(d => d.classList.remove('active')); menuToggle.nextElementSibling.classList.toggle('active'); } 
            else if (scheduleBtn) { if(isAdminMode) showScheduleModal(scheduleBtn.dataset.batchId); else showToast('Only admins can set schedule.', 'error'); } 
            else if (analysisBtn) { renderView(renderBatchAnalysisView, { batchId: analysisBtn.dataset.batchId }); } 
            else if (batchCard) {
                const batchId = batchCard.dataset.batchId;
                currentBatchId = batchId;
                const isHoliday = checkIsHoliday(getTodayDateString(), batchId);
                const schedule = appData.attendance?.schedules?.[batchId];
                const { status } = getScheduleStatus(schedule);
                if (status === 'during' && !isHoliday) renderView(renderBatchAttendanceView, { batchId: batchId });
                else renderView(renderAccessDeniedView, { batchId: batchId });
            }
        });
        document.getElementById('btnStudentDashboard').addEventListener('click', () => renderView(renderStudentDashboardSelectorView));
        updateAdminModeUI();
    }
    
    function findBatchById(batchId) { for (const day of (appData.batchSchedule || [])) { for (const cls of (day.classes || [])) { const batch = (cls.batches || []).find(b => b.id === batchId); if (batch) { const classInfo = (appData.mainClassCategories || []).find(c => c.id === cls.classId); return { ...batch, dayName: day.dayName, className: classInfo?.name || 'Unknown' }; } } } return null; }
    function checkIsHoliday(dateStr, batchIdToCheck) { const holidays = appData.attendance?.holidays || {}; return Object.values(holidays).some(h => { if (!h.batchIds || !h.batchIds.includes(batchIdToCheck)) return false; if (Array.isArray(h.dates)) return h.dates.includes(dateStr); if (typeof h.dates === 'string') return h.dates === dateStr; return false; }); }
    function getScheduleStatus(schedule) {
        if (!schedule || !schedule.days || schedule.days.length === 0 || !schedule.startTime || !schedule.endTime) return { status: 'no_schedule', nextClassDate: null };
        const now = new Date();
        const bstNow = new Date(now.getTime() + (6 * 60 * 60 * 1000));
        const todayDay = bstNow.getUTCDay();
        const [startHour, startMinute] = schedule.startTime.split(':');
        const [endHour, endMinute] = schedule.endTime.split(':');
        const classStartTime = new Date(Date.UTC(bstNow.getUTCFullYear(), bstNow.getUTCMonth(), bstNow.getUTCDate(), startHour, startMinute));
        const attendanceStartTime = new Date(classStartTime.getTime() - 30 * 60000);
        const attendanceEndTime = new Date(Date.UTC(bstNow.getUTCFullYear(), bstNow.getUTCMonth(), bstNow.getUTCDate(), endHour, endMinute));
        attendanceEndTime.setUTCMinutes(attendanceEndTime.getUTCMinutes() + 30);
        let currentStatus = schedule.days.includes(todayDay) ? (bstNow < attendanceStartTime ? 'before' : (bstNow <= attendanceEndTime ? 'during' : 'after')) : 'not_today';
        let nextClassDate = null;
        for (let i = 0; i < 8; i++) { 
            const checkDate = new Date(bstNow);
            checkDate.setUTCDate(bstNow.getUTCDate() + i);
            if (schedule.days.includes(checkDate.getUTCDay()) && !checkIsHoliday(checkDate.toISOString().split('T')[0], currentBatchId)) {
                const nextTime = new Date(Date.UTC(checkDate.getUTCFullYear(), checkDate.getUTCMonth(), checkDate.getUTCDate(), startHour, startMinute));
                if (nextTime > bstNow) { nextClassDate = nextTime; break; }
            }
        }
        return { status: currentStatus, nextClassDate };
    }
    
    function renderBatchAttendanceView({ batchId }) {
        currentBatchId = batchId;
        const batchDetails = findBatchById(batchId);
        if (!batchDetails) { mainContainer.innerHTML = '<p>Batch not found.</p>'; return; }
        document.getElementById('attendance-batch-name').textContent = `${batchDetails.className} - ${batchDetails.dayName}`;
        document.getElementById('attendance-batch-info').textContent = batchDetails.time;
        document.getElementById('stat-date').textContent = new Date().toLocaleDateString('bn-BD', { weekday: 'long', day: 'numeric', month: 'long', timeZone: 'Asia/Dhaka' });
        const studentListDiv = document.getElementById('student-list');
        studentListDiv.innerHTML = '<p>Loading students...</p>';
        const students = (batchDetails.studentIds || []).map(id => (appData.students || []).find(s => s && s.id === id && !s.deletedAt)).filter(Boolean).sort((a, b) => parseInt(a.roll) - parseInt(b.roll));
        document.getElementById('stat-total').textContent = students.length;
        studentListDiv.innerHTML = '';
        students.forEach(student => {
            const item = document.createElement('div');
            item.className = 'student-list-item';
            item.dataset.studentId = student.id;
            const photoHtml = student.photoURL ? `<img src="${student.photoURL}" alt="Photo" onerror="this.parentElement.innerHTML = getStudentPhotoPlaceholder();">` : getStudentPhotoPlaceholder();
            item.innerHTML = `<div class="student-photo">${photoHtml}</div><div class="student-details-container"><div class="student-name">${student.name}</div><div class="student-school">${student.schoolName || 'N/A'}</div></div><div class="student-roll">${student.roll}</div><div class="attendance-action"></div>`;
            studentListDiv.appendChild(item);
        });
        document.getElementById('studentSearchInput').addEventListener('input', (e) => { const term = e.target.value.toLowerCase(); studentListDiv.querySelectorAll('.student-list-item').forEach(item => { item.style.display = item.querySelector('.student-roll').textContent.includes(term) ? '' : 'grid'; }); });
        studentListDiv.addEventListener('click', handleAttendanceAction);
        setupAttendanceListener(batchId, students);
    }

    function setupAttendanceListener(batchId, students) {
        if (attendanceListener) dataRef.child(`attendance/records/${getTodayDateString()}/${batchId}`).off('value', attendanceListener);
        attendanceListener = dataRef.child(`attendance/records/${getTodayDateString()}/${batchId}`).on('value', snapshot => { updateStudentListUI(batchId, snapshot.val() || {}, students); });
    }

    function updateStudentListUI(batchId, records, students) {
        const studentListDiv = document.getElementById('student-list');
        if (!studentListDiv) return;
        const { status } = getScheduleStatus(appData.attendance?.schedules?.[batchId]);
        const canTakeAttendance = status === 'during';
        let presentCount = 0, absentCount = 0;
        studentListDiv.querySelectorAll('.student-list-item').forEach(item => {
            const record = records[item.dataset.studentId];
            const actionDiv = item.querySelector('.attendance-action');
            if(record) {
                if (record.status === 'present') presentCount++; else absentCount++;
                actionDiv.innerHTML = `<span class="status-tag status-${record.status}">${record.status}</span>`;
            } else {
                actionDiv.innerHTML = `<button class="btn ${canTakeAttendance ? 'btn-primary' : 'btn-secondary'}" data-action="present" ${!canTakeAttendance ? 'disabled' : ''}>Present</button>`;
            }
        });
        if (status === 'after') {
            const updates = {};
            let newAbsences = 0;
            students.forEach(student => { if (!records[student.id]) { updates[`attendance/records/${getTodayDateString()}/${batchId}/${student.id}`] = { status: 'absent', markedBy: 'system', timestamp: new Date().toISOString() }; newAbsences++; } });
            if (newAbsences > 0) dataRef.update(updates).then(() => logActivity(`Auto-marked ${newAbsences} absent`, { batchId }));
        }
        document.getElementById('stat-present').textContent = presentCount;
        document.getElementById('stat-absent').textContent = absentCount;
    }

    function handleAttendanceAction(e) {
        const button = e.target.closest('button[data-action]');
        if (!button) return;
        const studentItem = button.closest('.student-list-item');
        button.disabled = true; button.textContent = 'Saving...';
        const record = { status: button.dataset.action, markedBy: `${currentUser.name} (${currentUser.gmail})`, timestamp: new Date().toISOString() };
        dataRef.child(`attendance/records/${getTodayDateString()}/${currentBatchId}/${studentItem.dataset.studentId}`).set(record)
            .then(() => { logActivity(`Marked student ${button.dataset.action}`, { studentId: studentItem.dataset.studentId, batchId: currentBatchId }); showToast(`Marked ${button.dataset.action}!`, 'success', 1500); })
            .catch(err => showToast(`Error: ${err.message}`, 'error'));
    }
    
    function renderAccessDeniedView({batchId}){
        const batchDetails = findBatchById(batchId);
        const timerInfoDiv = document.getElementById('class-timer-info');
        const messageDiv = document.getElementById('access-denied-message');
        const nextClassDetailsDiv = document.getElementById('next-class-details');
        document.getElementById('access-denied-batch-name').textContent = `${batchDetails.className} - ${batchDetails.dayName}`;
        const schedule = appData.attendance?.schedules?.[batchId];
        const isHoliday = checkIsHoliday(getTodayDateString(), batchId);
        if (isHoliday) { messageDiv.textContent = 'আজ ছুটি ঘোষণা করা হয়েছে।'; messageDiv.className = 'access-denied-message holiday-info'; }
        else { messageDiv.textContent = 'এখন ক্লাস টাইম না।'; messageDiv.className = 'access-denied-message'; messageDiv.style.backgroundColor = 'var(--special-color)'; messageDiv.style.color = '#fff';}
        const { nextClassDate } = getScheduleStatus(schedule);
        if (nextClassDate) {
            if(countdownInterval) clearInterval(countdownInterval);
            const updateCountdown = () => {
                const bstNow = new Date(new Date().getTime() + (6 * 60 * 60 * 1000));
                const diff = nextClassDate - bstNow;
                if (diff <= 0) { clearInterval(countdownInterval); timerInfoDiv.innerHTML = `<div class="countdown-info">ক্লাসের সময় হয়ে গেছে। অনুগ্রহ করে ব্যাচ লিস্টে ফিরে গিয়ে আবার চেষ্টা করুন।</div>`; return; }
                const d=Math.floor(diff/(1e3*60*60*24)), h=Math.floor((diff/(1e3*60*60))%24), m=Math.floor((diff/1e3/60)%60), s=Math.floor((diff/1e3)%60);
                timerInfoDiv.innerHTML = `<div class="countdown-info">${d} দিন ${h} ঘণ্টা ${m} মিনিট ${s} সেকেন্ড</div>`;
            };
            updateCountdown();
            countdownInterval = setInterval(updateCountdown, 1000);
         } else { timerInfoDiv.textContent = 'পরবর্তী ক্লাসের কোনো তথ্য পাওয়া যায়নি।'; }
    }

    function showScheduleModal(batchId) {
        if(document.getElementById('scheduleModal')) document.getElementById('scheduleModal').remove();
        const template = document.getElementById('template-schedule-modal');
        document.body.appendChild(template.content.cloneNode(true));
        
        const modal = document.getElementById('scheduleModal');
        const batchDetails = findBatchById(batchId);
        modal.querySelector('#scheduleModalTitle').textContent = `Schedule for ${batchDetails.className} (${batchDetails.time})`;
        
        const schedule = appData.attendance?.schedules?.[batchId];
        if (schedule) {
            modal.querySelector('#startTime').value = schedule.startTime;
            modal.querySelector('#endTime').value = schedule.endTime;
            (schedule.days || []).forEach(dayIndex => { const checkbox = modal.querySelector(`input[name="classDay"][value="${dayIndex}"]`); if (checkbox) checkbox.checked = true; });
        }
        
        if (!isAdminMode) {
            modal.querySelectorAll('input, button[type="submit"]').forEach(el => el.disabled = true);
            modal.querySelector('#btnSaveSchedule').style.display = 'none';
        }

        modal.querySelector('#scheduleForm').addEventListener('submit', e => {
            e.preventDefault();
            const selectedDays = Array.from(modal.querySelectorAll('input[name="classDay"]:checked')).map(cb => parseInt(cb.value));
            const startTime = modal.querySelector('#startTime').value;
            const endTime = modal.querySelector('#endTime').value;
            if (selectedDays.length === 0 || !startTime || !endTime) { showToast('Please select days and times.', 'error'); return; }
            const newSchedule = { days: selectedDays, startTime, endTime };
            dataRef.child(`attendance/schedules/${batchId}`).set(newSchedule)
                .then(() => { logActivity('Updated schedule', { batchId }); showToast('Schedule saved!', 'success'); modal.remove(); });
        });

        modal.querySelector('.modal-close-btn').onclick = () => modal.remove();
        modal.querySelector('#btnCancelSchedule').onclick = () => modal.remove();
        modal.classList.add('visible');
    }
    
    function processBatchData(batchId) { const records = appData.attendance?.records || {}; const studentDetails = appData.students || []; const batchInfo = findBatchById(batchId); const studentIdsInBatch = new Set(batchInfo.studentIds || []); const studentStats = {}; studentIdsInBatch.forEach(id => { const student = studentDetails.find(s => s.id === id); if(student) studentStats[id] = { name: student.name, roll: student.roll, present: 0, absent: 0 }; }); const dailyAttendance = {}; const dayWiseCounts = { 0: {p:0, t:0}, 1: {p:0, t:0}, 2: {p:0, t:0}, 3: {p:0, t:0}, 4: {p:0, t:0}, 5: {p:0, t:0}, 6: {p:0, t:0} }; let totalPresents = 0; let totalAbsents = 0; for (const date in records) { if (records[date][batchId]) { const dayRecord = records[date][batchId]; dailyAttendance[date] = { present: 0, total: 0 }; const dayOfWeek = new Date(date).getUTCDay(); for (const studentId in dayRecord) { if (studentIdsInBatch.has(studentId) && studentStats[studentId]) { dailyAttendance[date].total++; dayWiseCounts[dayOfWeek].t++; if (dayRecord[studentId].status === 'present') { studentStats[studentId].present++; totalPresents++; dailyAttendance[date].present++; dayWiseCounts[dayOfWeek].p++; } else if (dayRecord[studentId].status === 'absent') { studentStats[studentId].absent++; totalAbsents++; } } } } } const totalClassDays = Object.keys(dailyAttendance).length; if (totalClassDays === 0) return null; const overallPercentage = totalPresents + totalAbsents > 0 ? (totalPresents / (totalPresents + totalAbsents) * 100).toFixed(1) : 0; const avgStudents = (totalPresents / totalClassDays).toFixed(1); const sortedStudents = Object.values(studentStats).filter(s => s.present + s.absent > 0); const topPresenters = [...sortedStudents].sort((a, b) => b.present - a.present || a.absent - b.absent).slice(0, 5); const topAbsentees = [...sortedStudents].sort((a, b) => b.absent - a.absent || a.present - b.present).slice(0, 5); const trendData = Object.entries(dailyAttendance).sort().map(([date, data]) => ({ x: date, y: data.total > 0 ? (data.present / data.total * 100) : 0 })); const dayLabels = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']; const dayData = dayLabels.map((_, i) => dayWiseCounts[i].t > 0 ? (dayWiseCounts[i].p / dayWiseCounts[i].t * 100) : 0); return { totalPresents, totalAbsents, totalClassDays, overallPercentage, avgStudents, topPresenters, topAbsentees, trendData, dayData, dayLabels }; }
    function renderBatchAnalysisView({ batchId }) { const batchDetails = findBatchById(batchId); document.getElementById('analysisBatchName').textContent = `Analysis for: ${batchDetails.className} (${batchDetails.time})`; const analysisContent = document.getElementById('analysis-content'); showLoader(); setTimeout(() => { const data = processBatchData(batchId); hideLoader(); if (!data) { analysisContent.innerHTML = `<p style="text-align:center; padding: 40px; color: var(--text-secondary);">Not enough data for analysis.</p>`; return; } document.getElementById('stat-overall-percentage').textContent = `${data.overallPercentage}%`; document.getElementById('stat-total-classes').textContent = data.totalClassDays; document.getElementById('stat-avg-students').textContent = data.avgStudents; document.getElementById('topPresentersList').innerHTML = data.topPresenters.map(s => `<li><span class="name">${s.roll}. ${s.name}</span> <span class="stat stat-present">${s.present} days</span></li>`).join(''); document.getElementById('topAbsenteesList').innerHTML = data.topAbsentees.map(s => `<li><span class="name">${s.roll}. ${s.name}</span> <span class="stat stat-absent">${s.absent} days</span></li>`).join(''); const chartTextColor = getComputedStyle(document.body).getPropertyValue('--text-primary'); charts.overall = new Chart(document.getElementById('overallAttendanceChart'), { type: 'doughnut', data: { labels: ['Present', 'Absent'], datasets: [{ data: [data.totalPresents, data.totalAbsents], backgroundColor: [getComputedStyle(document.documentElement).getPropertyValue('--success-color'), getComputedStyle(document.documentElement).getPropertyValue('--danger-color')], borderColor: 'var(--bg-section)', borderWidth: 4 }] }, options: { responsive: true, plugins: { legend: { position: 'top', labels: { color: chartTextColor } } } } }); charts.trend = new Chart(document.getElementById('attendanceTrendChart'), { type: 'line', data: { datasets: [{ label: 'Attendance %', data: data.trendData, borderColor: 'var(--special-color)', tension: 0.1, fill: false }]}, options: { responsive: true, scales: { x: { type: 'time', time: { unit: 'day' }, ticks: { color: chartTextColor } }, y: { beginAtZero: true, max: 100, ticks: { color: chartTextColor, callback: val => val + '%' } } }, plugins: { legend: { labels: { color: chartTextColor } } } } }); charts.dayWise = new Chart(document.getElementById('dayWiseChart'), { type: 'bar', data: { labels: data.dayLabels, datasets: [{ label: 'Avg. Attendance %', data: data.dayData, backgroundColor: 'var(--border-accent)' }] }, options: { responsive: true, scales: { y: { beginAtZero: true, max: 100, ticks: { color: chartTextColor, callback: val => val + '%' } }, x: { ticks: { color: chartTextColor } } }, plugins: { legend: { display: false } } } }); }, 10); }
    function renderStudentDashboardSelectorView() { const listContainer = document.getElementById('student-dashboard-list'); const searchInput = document.getElementById('studentDashboardSearch'); const populateList = (searchTerm = '') => { listContainer.innerHTML = ''; const filtered = (appData.students || []).filter(s => s && !s.deletedAt && (s.name.toLowerCase().includes(searchTerm) || s.roll.includes(searchTerm))); filtered.sort((a,b) => parseInt(a.roll) - parseInt(b.roll)).forEach(student => { const item = document.createElement('div'); item.className = 'student-list-item'; item.innerHTML = `<div class="student-roll">${student.roll}</div><div><div class="student-name">${student.name}</div></div><button class="btn-primary">View</button>`; item.querySelector('button').addEventListener('click', () => renderView(renderStudentDashboardView, { studentId: student.id })); listContainer.appendChild(item); }); }; searchInput.addEventListener('input', () => populateList(searchInput.value.toLowerCase())); populateList(); }
    function processStudentData(studentId) { const allRecords = appData.attendance?.records || {}; let presentCount = 0, absentCount = 0, totalClasses = 0; const studentAbsenceByDay = { 0:0, 1:0, 2:0, 3:0, 4:0, 5:0, 6:0 }; const batchAverages = {}; const studentBatches = new Set(); (appData.batchSchedule || []).forEach(day => (day.classes || []).forEach(cls => (cls.batches || []).forEach(batch => { if (batch.studentIds && batch.studentIds.includes(studentId)) studentBatches.add(batch.id); }))); for (const date in allRecords) { const dayOfWeek = new Date(date).getUTCDay(); for (const batchId of studentBatches) { if(allRecords[date][batchId]) { const batchRecord = allRecords[date][batchId]; if (!batchAverages[batchId]) batchAverages[batchId] = { totalPresents: 0, totalRecords: 0 }; Object.values(batchRecord).forEach(rec => { batchAverages[batchId].totalRecords++; if (rec.status === 'present') batchAverages[batchId].totalPresents++; }); if (batchRecord[studentId]) { totalClasses++; if (batchRecord[studentId].status === 'present') presentCount++; else if (batchRecord[studentId].status === 'absent') { absentCount++; studentAbsenceByDay[dayOfWeek]++; } } } } } const studentPercentage = totalClasses > 0 ? (presentCount / totalClasses * 100).toFixed(1) : 0; let overallBatchPresents = 0, overallBatchRecords = 0; Object.values(batchAverages).forEach(b => { overallBatchPresents += b.totalPresents; overallBatchRecords += b.totalRecords; }); const overallBatchAvg = overallBatchRecords > 0 ? (overallBatchPresents / overallBatchRecords * 100).toFixed(1) : 0; const dayLabels = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']; const dayData = dayLabels.map((_, i) => studentAbsenceByDay[i]); return { presentCount, absentCount, totalClasses, studentPercentage, overallBatchAvg, dayData, dayLabels }; }
    function renderStudentDashboardView({ studentId }) { const student = (appData.students || []).find(s => s.id === studentId); if (!student) return renderView(renderStudentDashboardSelectorView); document.getElementById('studentDashboardName').textContent = `Dashboard for: ${student.name} (Roll: ${student.roll})`; const data = processStudentData(studentId); document.getElementById('stat-student-percentage').textContent = `${data.studentPercentage}%`; document.getElementById('stat-student-total').textContent = data.totalClasses; document.getElementById('stat-student-present').textContent = data.presentCount; document.getElementById('stat-student-absent').textContent = data.absentCount; const chartTextColor = getComputedStyle(document.body).getPropertyValue('--text-primary'); const successColor = getComputedStyle(document.documentElement).getPropertyValue('--success-color'); const dangerColor = getComputedStyle(document.documentElement).getPropertyValue('--danger-color'); let currentDate = new Date(); const renderCalendar = (date) => { const month = date.getMonth(), year = date.getFullYear(); document.getElementById('calendarMonthYear').textContent = date.toLocaleDateString('bn-BD', { month: 'long', year: 'numeric' }); const calendarDays = document.getElementById('calendar-days'); calendarDays.innerHTML = ''; const firstDayOfMonth = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate(); for (let i = 0; i < firstDayOfMonth; i++) calendarDays.innerHTML += `<div></div>`; for (let day = 1; day <= daysInMonth; day++) { const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`; let dayClass = new Date(dateStr) < new Date(getTodayDateString()) ? '' : 'day-future'; let status = null; const recordsForDay = appData.attendance?.records?.[dateStr]; if (recordsForDay) for (const batchId in recordsForDay) if (recordsForDay[batchId][studentId]) { status = recordsForDay[batchId][studentId].status; break; } if (status === 'present') dayClass = 'day-present'; else if (status === 'absent') dayClass = 'day-absent'; calendarDays.innerHTML += `<div class="calendar-day ${dayClass}">${day}</div>`; } }; document.getElementById('prevMonthBtn').onclick = () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(currentDate); }; document.getElementById('nextMonthBtn').onclick = () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(currentDate); }; renderCalendar(currentDate); charts.personal = new Chart(document.getElementById('personalAttendanceChart'), { type: 'doughnut', data: { labels: ['Present', 'Absent'], datasets: [{ data: [data.presentCount, data.absentCount], backgroundColor: [successColor, dangerColor], borderColor: 'var(--bg-section)', borderWidth: 4 }] }, options: { responsive: true, plugins: { legend: { position: 'top', labels: { color: chartTextColor } } } } }); charts.comparison = new Chart(document.getElementById('comparisonChart'), { type: 'bar', data: { labels: ['Student', 'Batch Average'], datasets: [{ label: 'Attendance %', data: [data.studentPercentage, data.overallBatchAvg], backgroundColor: ['var(--special-color)', 'var(--border-accent)'] }] }, options: { responsive: true, indexAxis: 'y', scales: { x: { beginAtZero: true, max: 100, ticks: { color: chartTextColor, callback: val => val + '%' } }, y: { ticks: { color: chartTextColor }}}, plugins: { legend: { display: false } } } }); charts.absencePattern = new Chart(document.getElementById('studentDayAbsenceChart'), { type: 'bar', data: { labels: data.dayLabels, datasets: [{ label: 'Days Absent', data: data.dayData, backgroundColor: dangerColor }] }, options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { stepSize: 1, color: chartTextColor } }, x: { ticks: { color: chartTextColor }} }, plugins: { legend: { display: false } } } }); }
    function renderHolidayContent() { const container = document.getElementById('tab-content-holidays'); container.innerHTML = ''; container.appendChild(document.getElementById('template-holiday-view').content.cloneNode(true)); const datePickerElem = document.getElementById('holiday-dates-picker'); const batchSelector = document.getElementById('holiday-batch-selector'); const selectAllCheckbox = document.getElementById('holiday-select-all-batches'); const declareBtn = document.getElementById('btn-declare-holiday'); const fp = flatpickr(datePickerElem, { mode: "multiple", dateFormat: "Y-m-d", inline: true }); const allBatches = (appData.batchSchedule || []).flatMap(day => (day.classes || []).flatMap(cls => (cls.batches || []).map(b => ({...b, dayName: day.dayName, className: (appData.mainClassCategories.find(c => c.id === cls.classId) || {}).name})))); batchSelector.innerHTML = ''; allBatches.forEach(b => { batchSelector.innerHTML += `<label style="display: block; margin-bottom: 5px;"><input type="checkbox" name="holiday-batches" value="${b.id}"> ${b.className} - ${b.dayName} (${b.time})</label>`; }); const allBatchCheckboxes = batchSelector.querySelectorAll('input[name="holiday-batches"]'); selectAllCheckbox.addEventListener('change', () => allBatchCheckboxes.forEach(cb => cb.checked = selectAllCheckbox.checked)); allBatchCheckboxes.forEach(cb => cb.addEventListener('change', () => selectAllCheckbox.checked = [...allBatchCheckboxes].every(c => c.checked))); declareBtn.addEventListener('click', () => { const selectedDates = fp.selectedDates.map(date => date.toISOString().split('T')[0]); const batchIds = [...document.querySelectorAll('input[name="holiday-batches"]:checked')].map(cb => cb.value); if (selectedDates.length === 0 || batchIds.length === 0) return showToast('Please select dates and batches.', 'error'); showLoader(); const holidayId = `holiday_${Date.now()}`; const holidayData = { dates: selectedDates, batchIds }; dataRef.child(`attendance/holidays/${holidayId}`).set(holidayData).then(() => { hideLoader(); showToast('Holiday(s) declared!', 'success'); fp.clear(); allBatchCheckboxes.forEach(cb => cb.checked = false); selectAllCheckbox.checked = false; }).catch(err => { hideLoader(); showToast(`Error: ${err.message}`, 'error'); }); }); const historyTableBody = document.getElementById('holiday-history-table').querySelector('tbody'); historyTableBody.innerHTML = '<tr><td colspan="2">Loading history...</td></tr>'; const holidays = appData.attendance?.holidays || {}; const flattenedHolidays = []; for (const id in holidays) holidays[id].dates.forEach(date => flattenedHolidays.push({ date, batchIds: holidays[id].batchIds })); flattenedHolidays.sort((a,b) => new Date(b.date) - new Date(a.date)); if(flattenedHolidays.length > 0) historyTableBody.innerHTML = flattenedHolidays.map(holiday => `<tr><td>${new Date(holiday.date).toLocaleDateString('bn-BD', { day: 'numeric', month: 'long', year: 'numeric'})}</td><td>${holiday.batchIds.map(bId => { const b = findBatchById(bId); return b ? `<span class="batch-tag">${b.className} (${b.time})</span>` : ''; }).join('') || 'N/A'}</td></tr>`).join(''); else historyTableBody.innerHTML = '<tr><td colspan="2">No holiday history.</td></tr>'; }
    
    window.renderBatchListView = renderBatchListView; window.renderBatchAttendanceView = renderBatchAttendanceView; window.renderBatchAnalysisView = renderBatchAnalysisView; window.renderStudentDashboardSelectorView = renderStudentDashboardSelectorView; window.renderStudentDashboardView = renderStudentDashboardView; window.renderHolidayContent = renderHolidayContent; window.renderAccessDeniedView = renderAccessDeniedView;

    initializeApp();
}
</script>
</body>
</html>