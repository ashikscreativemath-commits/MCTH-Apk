<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCTH Student Portal</title>
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">
    <link rel="manifest" href="manifest.json">

    <!-- FIREBASE SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-messaging-compat.js"></script>
    
    <!-- Chart.js for Analysis -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <!-- LIBRARIES for PDF ID Card Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        @font-face {
          font-family: 'Kalpurush';
          src: url('fonts/kalpurush.ttf') format('truetype');
        }
        :root {
            /* Theme from index.html for consistency */
            --bg-main: #e6eefa; --bg-section: #edf0ce; --bg-header: #1f2b38; --bg-tab-container: #e9ecef; --bg-tab: #f8f9fa; --bg-tab-active: #ffffff; --bg-input: #ffffff; --bg-input-disabled: #e9ecef; --bg-scrollable: #ffffff; --bg-hover: #eef2f7; --bg-footer: #1d3557; --text-primary: #212529; --text-secondary: #6c757d; --text-header: #ffffff; --text-tab: #495057; --text-tab-active: #0056b3; --text-input-disabled: #6c757d; --text-footer: #f1faee; --text-footer-dev: #adb5bd; --border-color: #dee2e6; --border-accent: #007bff; --border-tab-active: #ffffff; --paid-color: #d1e7dd; --due-color: #f8d7da; --paid-text: #0f5132; --due-text: #842029; --future-text: #6c757d; --not-applicable-color: #f8f9fa; --not-applicable-text: #666666;
            --toast-success-bg: #28a745; --toast-error-bg: #dc3545; --toast-info-bg: #17a2b8; --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.1); --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.12); --danger-color: #fa383e; --success-color: #31a24c; --warning-color: #ffc107; --special-color: #6f42c1; --info-color: #17a2b8;
        }
        
        body[data-theme='dark'] {
            --bg-main: #121212; --bg-section: #1e1e1e; --bg-header: #1f2b38; --bg-tab-container: #121212; --bg-tab: #2a2a2a; --bg-tab-active: #1e1e1e; --bg-input: #252525; --bg-input-disabled: #3a3a3a; --bg-scrollable: #1e1e1e; --bg-hover: #333333; --bg-footer: #242526; --text-primary: #e8eaed; --text-secondary: #9aa0a6; --text-header: #e8eaed; --text-tab: #e8eaed; --text-tab-active: #8ab4f8; --text-input-disabled: #888888; --text-footer: #e4e6eb; --text-footer-dev: #9aa0a6; --border-color: #3a3a34; --border-accent: #8ab4f8; --border-tab-active: #1e1e1e; --paid-color: #143d26; --due-color: #4a1c21; --paid-text: #a3d9a5; --due-text: #f5c6cb; --not-applicable-color: #2c2c2c; --not-applicable-text: #666666;
        }

        html { scroll-behavior: smooth; }
        body { margin: 0; padding: 0; font-family: 'Kalpurush', sans-serif; background-color: var(--bg-main); color: var(--text-primary); transition: background-color .3s, color .3s; }

        #auth-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 15px; box-sizing: border-box; }
        .auth-box { background-color: var(--bg-section); padding: 25px; border-radius: 8px; box-shadow: var(--shadow-md); width: 100%; max-width: 420px; text-align: center; border: 1px solid var(--border-color); animation: fadeIn 0.5s ease; overflow: hidden; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .auth-logo { width: 100px; height: 100px; margin: 0 auto 20px; }
        .auth-box h1 { font-size: 1.6em; margin-bottom: 20px; color: var(--border-accent); }
        .input-group { position: relative; margin-bottom: 15px; }
        .input-group input, .input-group select { width: 100%; padding: 12px 15px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 1em; background-color: var(--bg-input); color: var(--text-primary); box-sizing: border-box; }
        .password-toggle-icon { position: absolute; top: 50%; right: 15px; transform: translateY(-50%); cursor: pointer; color: var(--text-secondary); }
        .auth-options { display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; margin-bottom: 25px; }
        .auth-button, .btn-primary { width: 100%; padding: 12px; border: none; border-radius: 8px; background: linear-gradient(45deg, var(--border-accent), #0056b3); color: white; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: all 0.3s; }
        .auth-button:hover:not(:disabled), .btn-primary:hover:not(:disabled) { box-shadow: 0 4px 15px rgba(0, 123, 255, 0.4); transform: translateY(-2px); }
        .auth-button:disabled, .btn-primary:disabled { background: #bdbdbd; color: #757575; cursor: not-allowed; }
        .auth-link { margin-top: 20px; font-size: 0.9em; }
        .auth-link a { color: var(--border-accent); text-decoration: none; font-weight: bold; }
        #auth-error-msg, #signup-error-msg { color: var(--due-text); margin-top: 15px; min-height: 20px; font-weight: bold; }
        .hidden { display: none !important; }

        #welcome-container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 15px; box-sizing: border-box; animation: fadeIn 0.5s ease; }
        .welcome-box { text-align: center; }
        #welcome-profile-pic { width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 4px solid var(--border-color); box-shadow: var(--shadow-md); margin-bottom: 20px; }
        #welcome-profile-name { font-size: 2em; font-weight: bold; color: var(--text-primary); margin-bottom: 30px; }
        #btn-proceed-to-app { width: 100%; max-width: 300px; }
        .typewriter h2 { overflow: hidden; border-right: .15em solid var(--border-accent); white-space: nowrap; margin: 0 auto; letter-spacing: .1em; animation: typing 3s steps(30, end), blink-caret .75s step-end infinite; }
        @keyframes typing { from { width: 0 } to { width: 100% } }
        @keyframes blink-caret { from, to { border-color: transparent } 50% { border-color: var(--border-accent); } }
        
        .signup-step { animation: fadeIn 0.5s ease; }
        .step-title { font-size: 1.2em; color: var(--text-secondary); margin-bottom: 15px; }
        #student-selection-list { max-height: 250px; overflow-y: auto; }
        #student-selection-list .student-item { padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s ease; text-align: left; }
        #student-selection-list .student-item:hover, #student-selection-list .student-item.selected { background-color: var(--bg-hover); border-left: 4px solid var(--border-accent); }
        #student-selection-list .student-item strong { display: block; font-size: 1.1em; }
        #student-selection-list .student-item span { font-size: 0.9em; color: var(--text-secondary); }
        .roll-selection-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(60px, 1fr)); gap: 10px; margin-top: 10px; }
        .roll-box { padding: 15px 10px; border: 2px solid var(--border-color); border-radius: 6px; cursor: pointer; transition: all 0.2s ease; font-weight: bold; font-size: 1.1em; }
        .roll-box:hover { background-color: var(--bg-hover); transform: translateY(-2px); }
        .roll-box.selected { background-color: var(--border-accent); color: white; border-color: var(--border-accent); }
        .password-strength { font-size: 0.8em; margin-top: 5px; text-align: left; }
        #lockout-message { background-color: var(--due-color); color: var(--due-text); padding: 10px; border-radius: 6px; }

        .login-footer { margin-top: 25px; font-size: 0.85em; color: var(--text-secondary); text-align: center; }
        .login-footer .copyright-text { font-size: 0.9em; margin-bottom: 15px; }
        .developer-box { border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; background-color: var(--bg-main); }
        .login-footer .developed-by-text { margin-bottom: 8px; font-size: 1.1em; }
        .company-info { display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 15px; }
        .company-logo { width: 40px; height: 40px; object-fit: contain; }
        .company-text { text-align: left; line-height: 1.5; }
        .company-text strong { font-size: 1.2em; color: var(--text-primary); }
        .company-text small { font-size: 0.9em; }
        .social-icons { display: flex; justify-content: center; gap: 20px; align-items: center; }
        .social-icons a { display: inline-block; color: var(--text-secondary); transition: color 0.3s, transform 0.3s; }
        .social-icons a:hover { color: var(--border-accent); transform: scale(1.1); }
        .social-icons svg { width: 28px; height: 28px; fill: currentColor; }
        .login-footer .instruction-text { font-size: 0.8em; font-style: italic; margin-top: 12px; margin-bottom: 0; color: var(--text-secondary); }

        #app-container { display: flex; flex-direction: column; min-height: 100vh; }
        #center-watermark { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 70vw; max-width: 300px; height: 100vh; background-image: url(images/image2.png); background-size: contain; background-repeat: no-repeat; background-position: center; opacity: .05; z-index: 0; pointer-events: none; }
        body[data-theme=dark] #center-watermark{ filter: invert(1) grayscale(1); opacity: 0.08; }
        
        header { background-color: var(--bg-header); color: var(--text-header); padding: 10px 15px; position: sticky; top: 0; z-index: 1001; box-shadow: 0 2px 5px rgba(0,0,0,0.2); display: flex; flex-wrap: wrap; }
        .header-top-row { display: flex; justify-content: space-between; align-items: center; width: 100%; gap: 15px; }
        .header-left { display: flex; align-items: center; gap: 10px; flex-grow: 1; min-width: 0; }
        .header-logo { width: 32px; height: 32px; border-radius: 4px; flex-shrink: 0; }
        .header-info-text { display: flex; align-items: baseline; gap: 8px; flex-wrap: wrap; }
        .institute-name { font-size: 1.1em; font-weight: bold; white-space: nowrap; }
        .institute-subtext { font-size: 0.8em; opacity: 0.8; white-space: nowrap;}
        .header-right { position: relative; display: flex; align-items: center; gap: 10px; }
        .profile-pic { width: 45px; height: 45px; border-radius: 50%; cursor: pointer; border: 2px solid white; object-fit: cover; }
        .profile-actions-menu { position: relative; }
        .menu-toggle-btn { background: none; border: none; color: white; font-size: 1.8em; cursor: pointer; padding: 0 5px; }
        .profile-menu { display: none; position: absolute; top: 40px; right: 0; background-color: var(--bg-section); border-radius: 8px; box-shadow: var(--shadow-md); z-index: 1002; width: 200px; overflow: hidden; border: 1px solid var(--border-color); }
        .profile-menu.active { display: block; }
        .profile-menu button { width: 100%; padding: 12px 15px; text-align: left; background: none; border: none; font-size: 1em; color: var(--text-primary); cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .profile-menu button:hover { background-color: var(--bg-hover); color: var(--border-accent); }

        .header-controls { width: 100%; display: flex; justify-content: space-between; align-items: center; padding-top: 10px; }
        .header-actions { display: flex; gap: 10px; }
        .header-year { background: rgba(255,255,255,0.1); padding: 4px 10px; border-radius: 12px; font-size: 0.85em; font-weight: bold; }
        .nav-btn { background: none; border: none; color: white; cursor: pointer; padding: 0; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s, transform 0.1s ease; }
        .nav-btn:hover { background-color: rgba(255,255,255,0.1); }
        .nav-btn:active { transform: scale(0.9); }
        .nav-btn svg { width: 22px; height: 22px; fill: currentColor; }
        #notification-bell { background: none; border: none; color: white; font-size: 1.5em; cursor: pointer; padding: 5px; position: relative; }
        #notification-bell.allowed { color: var(--success-color); }
        #notification-bell.denied { color: var(--danger-color); cursor: not-allowed; }

        main { padding: 15px; flex-grow: 1; position: relative; z-index: 1; padding-bottom: 80px; }
        .page-section { background-color: var(--bg-section); padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: var(--shadow-sm); border: 1px solid var(--border-color); }
        
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background-color: var(--bg-section); box-shadow: 0 -2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-around; padding: 5px 0; border-top: 1px solid var(--border-color); z-index: 1000; }
        .nav-item { flex: 1; text-align: center; padding: 8px 0; cursor: pointer; color: var(--text-secondary); transition: all 0.2s; }
        .nav-item.active { color: var(--border-accent); font-weight: bold; transform: scale(1.1); }
        .nav-icon { font-size: 1.4em; }
        .nav-label { font-size: 0.75em; display: block; }
        .nav-item.has-unseen { position: relative; }
        .nav-item.has-unseen::after { content: ''; position: absolute; top: 5px; right: calc(50% - 20px); width: 8px; height: 8px; background-color: var(--danger-color); border-radius: 50%; border: 1px solid var(--bg-section); box-shadow: 0 0 3px var(--danger-color); }
        
        .home-banner-image { width: 100%; height: auto; max-height: 150px; object-fit: cover; border-radius: 8px; margin-bottom: 15px; box-shadow: var(--shadow-md); }
        .home-cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; }
        .stat-item { text-align: center; background: var(--bg-main); padding: 15px; border-radius: 8px; border-left: 5px solid; }
        .stat-item .label { font-size: 0.9em; color: var(--text-secondary); margin-bottom: 5px; }
        .stat-item .value { font-size: 1.8em; font-weight: bold; }
        .stat-item.present { border-left-color: var(--success-color); }
        .stat-item.present .value { color: var(--paid-text); }
        .stat-item.absent { border-left-color: var(--danger-color); }
        .stat-item.absent .value { color: var(--due-text); }

        #home-image-showcase { padding: 0; background-color: transparent; box-shadow: none; border: none; }
        .slideshow-container { position: relative; width: 100%; aspect-ratio: 16 / 9; margin: auto; overflow: hidden; border-radius: 8px; box-shadow: var(--shadow-md); -webkit-user-select: none; user-select: none; }
        .slide { position: absolute; width: 100%; height: 100%; top: 0; left: 0; opacity: 0; transition: opacity 1.5s ease-in-out; }
        .slide.active { opacity: 1; }
        .slide img { width: 100%; height: 100%; object-fit: cover; vertical-align: middle; }
        .slideshow-dots { text-align: center; padding-top: 10px; }
        .dot { cursor: pointer; height: 10px; width: 10px; margin: 0 4px; background-color: var(--border-color); border-radius: 50%; display: inline-block; transition: background-color: 0.6s ease; }
        .dot.active, .dot:hover { background-color: var(--border-accent); }
        .profile-info-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .profile-info-card { background-color: var(--bg-main); border: 1px solid var(--border-color); border-left: 4px solid var(--border-accent); padding: 15px; border-radius: 8px; transition: all 0.3s ease; animation: fadeInUp 0.5s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .profile-info-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); }
        .profile-info-card p { margin: 0; display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color); }
        .profile-info-card p:last-child { border-bottom: none; }
        .profile-info-card p strong { color: var(--text-secondary); }
        .profile-info-card p span { font-weight: bold; word-break: break-all; }
        .profile-action-btn { width: 100%; padding: 12px; margin-top: 15px; border: none; border-radius: 8px; background: linear-gradient(45deg, var(--success-color), #28a745); color: #fff; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .profile-action-btn:hover { box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4); transform: translateY(-2px); }

        .yearly-status-chart { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; }
        .month-box { background: var(--bg-main); border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; text-align: center; }
        .month-name { font-weight: bold; font-size: 1.1em; margin-bottom: 5px; }
        .month-status { font-size: 0.85em; padding: 3px 8px; border-radius: 10px; font-weight: bold; }
        .month-status.paid { background-color: transparent; color: var(--paid-text); border: 1px solid var(--paid-text); }
        .month-status.due { background-color: transparent; color: var(--due-text); border: 1px solid var(--due-text); }
        .month-status.future { background-color: var(--text-secondary); color: white; }
        .month-status.not-applicable { background-color: var(--not-applicable-color); color: var(--not-applicable-text); border: 1px solid var(--border-color); }
        .upcoming-payment-card { background: linear-gradient(45deg, var(--border-accent), #0056b3); color: white; padding: 20px; border-radius: 8px; text-align: center; }
        .upcoming-payment-card h4 { margin: 0 0 10px; opacity: 0.9; }
        .upcoming-payment-card .month { font-size: 1.8em; font-weight: bold; }
        .history-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em; }
        .history-table tr { border-bottom: 1px solid var(--border-color); transition: background-color 0.2s; }
        .history-table tr:hover { background-color: var(--bg-hover); }
        .history-table th, .history-table td { padding: 12px 10px; text-align: left; }
        .history-table th { background-color: transparent; border-bottom: 2px solid var(--success-color); color: var(--paid-text); }
        .history-table td:last-child { font-family: monospace; }
        .calendar-container { padding:0; border:none; box-shadow: none; }
        .calendar-header { display:flex; justify-content: space-between; align-items: center; }
        #calendarMonthYear { margin: 0; font-size: 1.2em; }
        .calendar-header .nav-btn { color: var(--text-primary); border: 1px solid var(--border-color);}
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .day-names { font-weight: bold; color: var(--text-secondary); padding-bottom: 10px; font-size: 0.8em;}
        .calendar-day { padding: 8px 4px; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; margin: auto; font-size: 0.9em;}
        .day-present { background-color: var(--success-color); color: white; }
        .day-absent { background-color: var(--danger-color); color: white; }
        .analysis-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .analysis-card { background-color: var(--bg-main); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); }
        .analysis-card h3 { margin-top: 0; border-bottom: 2px solid var(--border-accent); padding-bottom: 8px; font-size: 1.1em; }

        .lottery-result-box { background: linear-gradient(145deg, var(--bg-main), #ffffff); border: 1px solid var(--border-color); border-left: 5px solid var(--success-color); border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: var(--shadow-sm); }
        .lottery-result-box.pinned { border-left-color: var(--special-color); background: linear-gradient(145deg, #f3e8ff, #ffffff); }
        .lottery-result-box h3 { margin: 0 0 10px; color: var(--special-color); border-bottom: 1px solid var(--border-color); padding-bottom: 8px; font-size: 1.3em; }
        .lottery-result-box p { font-size: 0.9em; color: var(--text-secondary); margin-bottom: 15px; }
        .lottery-result-box .winner-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 10px; }
        .lottery-result-box .winner-list li { background: rgba(255, 255, 255, 0.7); padding: 10px 15px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid var(--success-color); }
        .lottery-result-box .winner-list li strong { font-weight: bold; color: var(--text-primary); }
        .lottery-result-box .winner-list li span { color: var(--text-secondary); text-align: right; }

        .latest-notice-card { border: 2px solid var(--special-color); background-color: var(--bg-main); }
        .latest-notice-card h3 { color: var(--special-color); }
        .new-badge { background-color: var(--special-color); color: white; padding: 3px 8px; font-size: 0.7em; font-weight: bold; border-radius: 10px; margin-left: 10px; }
        .notice-card { margin-bottom: 15px; border-left: 4px solid var(--border-color); background-color: var(--bg-main); padding: 15px; border-radius: 8px; }
        .notice-card h4 { margin: 0 0 8px; }
        .notice-image { width: 100%; max-height: 250px; object-fit: cover; border-radius: 8px; margin-top: 10px; cursor: pointer; }
        .notice-content { white-space: pre-wrap; margin: 10px 0; line-height: 1.6; }
        .notice-timestamp { font-size: 0.8em; color: var(--text-secondary); text-align: right; }
        #image-viewer-modal .modal-content { padding: 5px; background-color: var(--bg-section); }
        #image-viewer-modal img { max-width: 100%; max-height: 85vh; display: block; margin: auto; border-radius: 8px;}
        #image-viewer-modal .modal-header { padding-bottom: 5px; margin-bottom: 5px; }
        .notice-header { display: flex; justify-content: space-between; align-items: baseline; flex-wrap: wrap; gap: 5px; }
        .notice-time-ago { font-size: 0.75em; color: var(--text-secondary); font-style: italic; flex-shrink: 0; margin-left: 10px; }
        .load-more-btn { width: 100%; padding: 12px; border: 1px solid var(--border-accent); color: var(--border-accent); background-color: transparent; border-radius: 8px; font-size: 1em; font-weight: bold; cursor: pointer; margin-top: 10px; transition: all 0.3s; }
        .load-more-btn:hover { background-color: var(--border-accent); color: white; }

        .exam-card { background: var(--bg-main); border: 1px solid var(--border-color); border-left: 5px solid var(--border-accent); padding: 15px; border-radius: 8px; }
        .exam-card-content h4 { margin: 0 0 10px; font-size: 1.2em; }
        .exam-stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 0.9em; }
        .exam-stats-grid span { background: var(--bg-section); padding: 8px; border-radius: 6px; }
        .exam-stats-grid strong { color: var(--text-primary); }
        .result-pending { color: var(--warning-color); font-style: italic; }
        .graph-toggle-btn { grid-column: 1 / -1; margin-top: 10px; padding: 8px; background-color: var(--border-accent); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .graph-container { display: none; margin-top: 15px; }
        
        .live-exam-card { border-left-width: 5px; border-left-style: solid; }
        .live-exam-card.upcoming { border-left-color: var(--info-color); }
        .live-exam-card.live { border-left-color: var(--success-color); animation: pulse-border 2s infinite; }
        .live-exam-card.completed { border-left-color: var(--text-secondary); }
        @keyframes pulse-border { 0% { box-shadow: 0 0 0 0 rgba(49, 162, 76, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(49, 162, 76, 0); } 100% { box-shadow: 0 0 0 0 rgba(49, 162, 76, 0); } }
        .live-exam-details { font-size: 0.9em; color: var(--text-secondary); margin-bottom: 15px; }
        .countdown-timer { font-weight: bold; font-size: 1.1em; color: var(--info-color); }
        .live-exam-card .btn-primary { width: auto; padding: 10px 20px; font-size: 1em; margin-top: 10px; display: inline-block; }
        
        #live-exam-interface { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-main); z-index: 10010; display: none; flex-direction: column; }
        #live-exam-interface.visible { display: flex; }
        .exam-interface-header { background-color: var(--bg-header); color: var(--text-header); padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow-sm); flex-shrink: 0; }
        .exam-interface-header .header-logo { width: 35px; height: 35px; }
        .exam-interface-header h2 { margin: 0; font-size: 1.2em; text-align: center; }
        #exam-timer { background: var(--border-accent); padding: 5px 12px; border-radius: 15px; font-weight: bold; font-size: 1em; }
        .exam-interface-body { flex-grow: 1; overflow-y: auto; padding: 15px; position: relative; }
        .exam-watermark { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 60vw; max-width: 250px; height: auto; opacity: 0.05; z-index: -1; }
        .exam-question-card { background-color: var(--bg-section); padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid var(--border-color); }
        .exam-question-card p { font-size: 1.1em; font-weight: bold; margin: 0 0 15px; }
        .exam-options-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 10px; }
        .exam-options-list li label { display: flex; align-items: center; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; transition: all 0.2s; gap: 10px; }
        .exam-options-list li input[type="radio"] { flex-shrink: 0; }
        .exam-options-list li label:hover { background-color: var(--bg-hover); }
        .exam-options-list li input[type="radio"]:checked + span { font-weight: bold; color: var(--border-accent); }
        .exam-options-list li.locked label { cursor: not-allowed; background-color: var(--bg-input-disabled); color: var(--text-input-disabled); }
        .exam-options-list li.locked input[type="radio"]:checked + span { color: var(--paid-text); }
        .lock-indicator { margin-left: auto; font-size: 1.2em; }
        .exam-interface-footer { padding: 15px; border-top: 1px solid var(--border-color); background-color: var(--bg-section); }
        
        .result-summary-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; text-align: center; margin-bottom: 20px; }
        .result-summary-item { background-color: var(--bg-main); padding: 15px; border-radius: 8px; }
        .result-summary-item .label { font-size: 0.9em; color: var(--text-secondary); }
        .result-summary-item .value { font-size: 1.5em; font-weight: bold; }
        .result-question-review .exam-question-card p { display: flex; align-items: center; gap: 8px; }
        .result-question-review .exam-options-list li label { cursor: default; }
        .result-question-review .exam-options-list li.correct { border-left: 4px solid var(--success-color); background-color: var(--paid-color); }
        .result-question-review .exam-options-list li.incorrect { border-left: 4px solid var(--danger-color); background-color: var(--due-color); }

        #loader-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:10011;display:none;align-items:center;justify-content:center}.loader{border:5px solid #f3f3f3;border-top:5px solid var(--border-accent);border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        #toast-container{position:fixed;bottom:70px;left:50%;transform:translateX(-50%);z-index:10012;display:flex;flex-direction:column;gap:8px;width:90%;max-width:400px}.toast{padding:12px 15px;border-radius:6px;color:#fff;font-size:0.9em;box-shadow:0 2px 10px rgba(0,0,0,.2);opacity:0;transform:translateY(20px);transition:opacity .3s,transform .3s}.toast.show{opacity:1;transform:translateY(0)}.toast.success{background-color:var(--toast-success-bg)}.toast.error{background-color:var(--toast-error-bg)}.toast.info{background-color:var(--toast-info-bg)}
        .modal-overlay{display:none;position:fixed;z-index:10001;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,.6);backdrop-filter:blur(4px);align-items:center;justify-content:center;}.modal-overlay.visible{display:flex}.modal-content{background-color:var(--bg-section);margin:auto;padding:20px;border-radius:12px;width:95%;max-width:500px;max-height:90vh;display:flex;flex-direction:column;box-shadow:0 5px 15px rgba(0,0,0,.3)}.modal-header{padding-bottom:15px;margin-bottom:15px;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center}.modal-header h2{margin:0;font-size:1.4em}.modal-close-btn{background:none;border:none;font-size:2em;cursor:pointer;color:var(--text-secondary);line-height:1;padding:0 5px;}.modal-body{flex-grow:1;overflow-y:auto;}
        .modal-footer { margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 10px; }
        
        .app-footer { background-color: var(--bg-footer); color: var(--text-footer); padding: 10px 15px 80px; text-align: center; }
        .footer-content { max-width: 1000px; margin: 0 auto; line-height: 1.6; }
        .footer-content p { margin: 1px 0; font-size: 0.8em; }
        .footer-content a { color: var(--text-footer); text-decoration: none; transition: color 0.2s; display: inline-flex; align-items: center; gap: 5px; font-size: 0.8em; }
        .footer-content a:hover { color: var(--border-accent); }
        .footer-socials { display: flex; justify-content: center; flex-wrap: wrap; gap: 10px 15px; align-items: center; margin-top: 5px; }
        .footer-contact { margin-top: 5px; }
        .footer-socials svg, .footer-contact svg { width: 14px; height: 14px; fill: currentColor; }
        .footer-qr-code { width: 40px; height: 40px; border-radius: 4px; object-fit: cover; }

        .id-card-viewer-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(5px); z-index: 10002; display: none; justify-content: center; align-items: center; }
        .id-card-viewer-modal.visible { display: flex; }
        .id-card-viewer-content { background-color: var(--bg-main); padding: 20px; border-radius: 12px; width: 95%; max-width: 800px; max-height: 95vh; overflow-y: auto; }
        .id-card-viewer-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .id-card-viewer-header h2 { margin: 0; font-size: 1.5em; }
        .id-card-controls { display: flex; gap: 10px; }
        #id-card-download-btn { background-color: var(--success-color); color: #fff; padding: 8px 15px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; }
        .id-card-viewer-close-btn { font-size: 2em; line-height: 1; }
        .id-card-preview-area { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; }
        .id-card-container { width: 300px; aspect-ratio: 54 / 86; position: relative; box-shadow: var(--shadow-md); border-radius: 12px; overflow: hidden; font-family: Arial, Helvetica, sans-serif; }
        .id-card-container .bg-img { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }
        .id-card-photo { position: absolute; top: 26%; left: 50%; transform: translateX(-50%); width: 44.75%; aspect-ratio: 9.30 / 10; object-fit: cover; border-radius: 15px; }
        .id-card-details-container { position: absolute; top: 59%; left: 50%; width: 50%; height: auto; color: #1c1c1c; }
        .id-card-details-container p { font-family: 'Kalpurush', sans-serif; margin: 0; padding: 0; font-size: 12.3px; font-weight: bold; line-height: 1.39; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .id-card-qr-container { position: absolute; top: 40%; left: 50%; transform: translateX(-50%); width: 45%; background: white; padding: 4px; border-radius: 2px; }
        .id-card-qr-container img { width: 100% !important; height: auto !important; display: block; }
    </style>
</head>
<body data-theme="light">
    <!-- AUTHENTICATION CONTAINER -->
    <div id="auth-container">
        <div class="auth-box">
            <img src="images/image2.png" alt="Logo" class="auth-logo" onerror="this.style.display='none'">
            <div id="login-view">
                <h1>স্টুডেন্ট পোর্টালে স্বাগতম</h1>
                <form id="login-form">
                    <div class="input-group">
                        <input type="tel" id="login-contact" placeholder="আপনার মোবাইল নম্বর" required>
                    </div>
                    <div class="input-group">
                        <input type="password" id="login-password" placeholder="আপনার পাসওয়ার্ড" required>
                        <span id="password-toggle" class="password-toggle-icon">👁️</span>
                    </div>
                    <div class="auth-options">
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="checkbox" id="remember-me" checked> আমাকে মনে রাখুন
                        </label>
                    </div>
                    <button type="submit" class="auth-button">লগইন করুন</button>
                    <div id="auth-error-msg"></div>
                </form>
                <p class="auth-link">অ্যাকাউন্ট নেই? <a href="#" id="show-signup">এখানে সাইন-আপ করুন</a></p>
            </div>
            <div id="signup-view" class="hidden">
                <h1>অ্যাকাউন্ট তৈরি করুন</h1>
                <form id="signup-form">
                    <div id="step-1" class="signup-step">
                        <p class="step-title">আপনার ব্যাচ শনাক্ত করুন</p>
                        <div class="input-group"><select id="signup-year" required><option value="">শিক্ষাবর্ষ বাছাই করুন</option></select></div>
                        <div class="input-group"><select id="signup-class" required disabled><option value="">ক্লাস বাছাই করুন</option></select></div>
                        <div class="input-group"><select id="signup-batch" required disabled><option value="">ব্যাচ বাছাই করুন</option></select></div>
                        <button type="button" id="btn-next-step-1" class="auth-button" disabled>পরবর্তী ধাপ</button>
                    </div>
                    <div id="step-2" class="signup-step hidden">
                        <p class="step-title">কোচিং-এ দেওয়া আপনার মোবাইল নম্বরটি লিখুন</p>
                        <div class="input-group"><input type="tel" id="signup-contact" placeholder="01XXXXXXXXX" required></div>
                        <button type="button" id="btn-next-step-2" class="auth-button">আমার প্রোফাইল খুঁজুন</button>
                    </div>
                    <div id="step-3" class="signup-step hidden">
                        <p class="step-title">আপনার সঠিক প্রোফাইলটি বাছাই করুন</p>
                        <div id="student-selection-list"></div>
                        <button type="button" id="btn-next-step-3" class="auth-button" style="margin-top:15px;" disabled>পরবর্তী ধাপ</button>
                    </div>
                    <div id="step-4" class="signup-step hidden">
                        <p class="step-title">পরিচয় যাচাই করুন (রোল নম্বর)</p>
                        <p style="font-size:0.9em;">আপনার সঠিক রোল নম্বরটি বাছাই করুন:</p>
                        <div id="roll-selection" class="roll-selection-grid"></div>
                        <button type="button" id="btn-next-step-4" class="auth-button" style="margin-top: 15px;" disabled>পরবর্তী ধাপ</button>
                    </div>
                    <div id="step-5" class="signup-step hidden">
                        <p class="step-title"> চূড়ান্ত যাচাইকরণ (Trx ID)</p>
                         <div class="input-group"><input type="text" id="signup-trxid" name="signup-trxid" placeholder="ভর্তি ফি-এর Transaction ID লিখুন" required></div>
                        <button type="button" id="btn-verify-trx" class="auth-button">যাচাই করুন</button>
                    </div>
                    <div id="step-6" class="signup-step hidden">
                        <p class="step-title">নতুন পাসওয়ার্ড সেট করুন</p>
                        <div id="unique-contact-container" class="hidden">
                            <p style="font-size:0.9em; color: var(--text-secondary); text-align: left; margin-bottom: 10px; border-left: 3px solid var(--warning-color); padding-left: 8px;">একাধিক শিক্ষার্থী এই অভিভাবকের নম্বরটি ব্যবহার করায়, আপনার লগইনের জন্য একটি স্বতন্ত্র মোবাইল নম্বর দিন।</p>
                            <div class="input-group">
                                <input type="tel" id="signup-new-contact" placeholder="আপনার স্বতন্ত্র মোবাইল নম্বর (লগইনের জন্য)">
                            </div>
                        </div>
                        <div class="input-group"><input type="password" id="signup-password" name="signup-password" placeholder="নতুন পাসওয়ার্ড" required></div>
                        <div class="input-group"><input type="password" id="signup-confirm-password" name="signup-confirm-password" placeholder="পুনরায় পাসওয়ার্ড দিন" required></div>
                        <div id="password-strength" class="password-strength"></div>
                        <button type="submit" class="auth-button">অ্যাকাউন্ট তৈরি করুন</button>
                    </div>
                </form>
                <div id="signup-error-msg"></div>
                <div id="lockout-message" class="hidden"></div>
                <p class="auth-link">ইতিমধ্যে অ্যাকাউন্ট আছে? <a href="#" id="show-login">এখানে লগইন করুন</a></p>
            </div>
            <div class="login-footer">
                <p class="copyright-text">&copy; Copyright by Math Creative Teaching Home 2026</p>
                <div class="developer-box">
                    <p class="developed-by-text">Developed by,</p>
                    <div class="company-info">
                        <img src="images/image5.png" alt="Bindumatra IT Logo" class="company-logo">
                        <div class="company-text">
                            <strong>বিন্দুমাত্রা আইটি</strong><br>
                            <small>CEO : Abdullah Al Rafi </small>
                        </div>
                    </div>
                    <div class="social-icons">
                         <a href="mailto:bindumatrait@gmail.com" title="Email Abdullah Al Rafi" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg></a>
                        <a href="https://www.facebook.com/profile.php?id=61580476801857" title="Facebook Page" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 2.04c-5.5 0-10 4.49-10 10.02 0 5 3.66 9.15 8.44 9.9v-7.02H7.97v-2.89h2.47V9.9c0-2.45 1.44-3.8 3.65-3.8 1.06 0 2.16.19 2.16.19v2.47h-1.27c-1.2 0-1.56.72-1.56 1.5v1.84h2.78l-.45 2.89h-2.33v7.02c4.78-.75 8.44-4.9 8.44-9.9C22 6.53 17.5 2.04 12 2.04z"/></svg></a>
                        <a href="https://wa.me/8801745938158" title="Contact on WhatsApp" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.894 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.886-.001 2.269.655 4.357 1.846 6.167l-1.117 4.082 4.162-1.085zM9.06 7.426c.14-.364.44-1.13.56-1.293.12-.162.28-.192.42-.192.14 0 .28.096.42.364.14.268.56 1.32.62 1.42.06.1.12.18.2.3.08.12.14.24.26.36s.24.22.4.32c.16.1.34.16.5.24.16.08.3.12.42.14.12.02.26 0 .38-.08.12-.08.5-1.25.62-1.47.12-.22.24-.28.4-.28.16 0 .3.04.42.12.12.08.56 1.13.66 1.31.1.18.18.28.2.32.02.04.04.1.02.18s-.08.24-.16.32c-.08.08-.18.1-.28.14s-.2.08-.32.1c-.12.02-.26.02-.4.02s-.68-.08-1.02-.22c-.34-.14-.7-.34-1.08-.62s-.68-.62-.94-.96c-.26-.34-.48-.74-.62-1.18s-.18-.9-.18-1.46c0-.56.08-1.04.22-1.46z"/></svg></a>
                    </div>
                    <p class="instruction-text">click the icons to visit</p>
                </div>
            </div>
        </div>
    </div>
    <div id="welcome-container" class="hidden">
        <div class="welcome-box">
            <img src="images/image2.png" alt="Logo" class="auth-logo" onerror="this.style.display='none'">
            <h1 style="font-size: 1.5em; color: var(--text-secondary); margin-bottom: 30px;">গণিত ক্রিয়েটিভ টিচিং হোম</h1>
            <img id="welcome-profile-pic" src="images/default_avatar.png" alt="Profile Picture" onerror="this.onerror=null; this.src='images/default_avatar.png';">
            <div id="welcome-message-container" class="typewriter" style="margin-bottom: 30px;">
                 <h2 id="welcome-profile-name"></h2>
            </div>
            <button id="btn-proceed-to-app" class="auth-button">পোর্টালে প্রবেশ করুন</button>
        </div>
    </div>

    <!-- MAIN APP CONTAINER -->
    <div id="app-container" class="hidden">
        <div id="center-watermark"></div>
        <div id="loader-overlay"><div class="loader"></div></div>
        <div id="toast-container"></div>

        <header>
            <div class="header-top-row">
                <div class="header-left">
                    <img src="images/favicon.ico" class="header-logo" alt="Logo">
                    <div class="header-info-text">
                        <span class="institute-name">গণিত ক্রিয়েটিভ টিচিং হোম</span>
                        <span class="institute-subtext">জলেশ্বরীতলা, বগুড়া | ☎ 01747019383</span>
                    </div>
                </div>
                <div class="header-right">
                    <button id="notification-bell" title="Toggle Notifications">🔔</button>
                    <img id="profile-pic-header" src="images/default_avatar.png" class="profile-pic" alt="Profile" onerror="this.onerror=null; this.src='images/default_avatar.png';">
                    <div class="profile-actions-menu">
                        <button id="menu-toggle-btn" class="menu-toggle-btn">&vellip;</button>
                        <div id="profile-menu" class="profile-menu">
                            <button id="btn-view-profile">👤 Profile</button>
                            <button id="btn-about-dev">👨‍💻 Developer</button>
                            <button id="btn-logout">🚪 Log Out</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="header-controls">
                <div class="header-actions">
                    <button id="btn-back" class="nav-btn" title="Back"><svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path></svg></button>
                    <button id="btn-refresh" class="nav-btn" title="Refresh"><svg viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg></button>
                </div>
                <span id="header-academic-year" class="header-year"></span>
            </div>
        </header>

        <main id="main-content"></main>
        
        <nav class="bottom-nav">
            <div class="nav-item active" data-page="home">
                <span class="nav-icon">🏠</span>
                <span class="nav-label">হোম</span>
            </div>
             <div class="nav-item" data-page="notice">
                <span class="nav-icon">🔔</span>
                <span class="nav-label">নোটিশ</span>
            </div>
            <div class="nav-item" data-page="attendance">
                <span class="nav-icon">📋</span>
                <span class="nav-label">অ্যাটেনডেন্স</span>
            </div>
            <div class="nav-item" data-page="payment">
                <span class="nav-icon">💳</span>
                <span class="nav-label">পেমেন্ট</span>
            </div>
             <div class="nav-item" data-page="lottery">
                <span class="nav-icon">🏆</span>
                <span class="nav-label">লটারি</span>
            </div>
            <div class="nav-item" data-page="exam">
                <span class="nav-icon">📝</span>
                <span class="nav-label">পরীক্ষা</span>
            </div>
        </nav>
        
        <footer class="app-footer">
            <div class="footer-content">
                <p>© Math Creative Teaching Home 2026</p>
                <p>Developed by বিন্দুমাত্রা আইটি</p>
                <div class="footer-socials">
                    <a href="https://wa.me/8801745938158" target="_blank" rel="noopener noreferrer"><svg viewBox="0 0 24 24"><path d="M12.04 2C6.58 2 2.13 6.45 2.13 11.91C2.13 13.66 2.61 15.31 3.48 16.76L2 22L7.43 20.48C8.82 21.3 10.39 21.81 12.04 21.81C17.5 21.81 21.95 17.36 21.95 11.9C21.95 9.27 20.92 6.81 19.05 4.94C17.18 3.07 14.72 2 12.04 2M12.04 3.67C14.25 3.67 16.31 4.53 17.87 6.09C19.42 7.65 20.28 9.71 20.28 11.91C20.28 16.47 16.6 20.15 12.04 20.15C10.56 20.15 9.15 19.71 7.96 18.9L7.54 18.64L3.8 19.77L4.95 16.11L4.68 15.68C3.78 14.43 3.32 12.96 3.32 11.91C3.32 7.35 6.99 3.67 12.04 3.67M16.57 14.45C16.37 14.35 15.28 13.81 15.08 13.73C14.88 13.65 14.73 13.61 14.59 13.86C14.44 14.11 13.99 14.65 13.84 14.8C13.69 14.95 13.54 14.96 13.34 14.86C13.14 14.76 12.28 14.47 11.27 13.59C10.49 12.91 9.96 12.06 9.81 11.81C9.66 11.56 9.79 11.45 9.91 11.33C10.02 11.22 10.16 11.03 10.29 10.88C10.41 10.73 10.46 10.61 10.54 10.43C10.61 10.26 10.56 10.11 10.51 10.01C10.46 9.91 10.03 8.82 9.83 8.32C9.64 7.82 9.44 7.86 9.29 7.85H9.01C8.86 7.85 8.64 7.9 8.44 8.1C8.24 8.3 7.79 8.75 7.79 9.76C7.79 10.77 8.48 11.73 8.58 11.88C8.68 12.03 10.03 14.16 12.11 14.99C12.59 15.18 12.95 15.29 13.25 15.38C13.78 15.53 14.28 15.49 14.68 15.43C15.12 15.36 16.11 14.81 16.31 14.71C16.51 14.61 16.57 14.55 16.57 14.45Z"></path></svg><span>Chat on Whatsapp</span></a>
                    <a href="https://www.facebook.com/profile.php?id=61580476801857" target="_blank" rel="noopener noreferrer"><svg viewBox="0 0 24 24"><path d="M14 13.5h2.5l1-4H14v-2c0-1.03 0-2 2-2h1.5V2.14c-.326-.043-1.557-.14-2.857-.14C11.928 2 10 3.657 10 6.7v2.8H7v4h3V22h4v-8.5z"></path></svg><span>Facebook</span></a>
                    <a href="https://www.instagram.com/abdullah_al.rafi" target="_blank" rel="noopener noreferrer">
                        <svg viewBox="0 0 24 24"><path d="M12 2c2.717 0 3.056.01 4.122.06 1.065.05 1.79.217 2.428.465.66.254 1.216.598 1.772 1.153a4.902 4.902 0 011.153 1.772c.247.637.415 1.363.465 2.428.047 1.066.06 1.405.06 4.122s-.013 3.056-.06 4.122c-.05 1.065-.218 1.79-.465 2.428a4.883 4.883 0 01-1.153 1.772 4.915 4.915 0 01-1.772 1.153c-.637.247-1.363.415-2.428.465-1.066.047-1.405.06-4.122.06s-3.056-.013-4.122-.06c-1.065-.05-1.79-.218-2.428-.465a4.89 4.89 0 01-1.772-1.153 4.904 4.904 0 01-1.153-1.772c-.248-.637-.415-1.363-.465-2.428C2.013 15.056 2 14.717 2 12s.013-3.056.06-4.122c.05-1.065.217-1.79.465-2.428a4.884 4.884 0 011.153-1.772A4.902 4.902 0 016.344 2.525c.637-.248 1.363-.415 2.428-.465C9.844 2.013 10.183 2 12 2zm0 1.8a9.137 9.137 0 00-4.043.06 2.908 2.908 0 00-1.685.43c-.47.18-.86.41-1.2.75-.34.34-.57.73-.75 1.2a2.908 2.908 0 00-.43 1.685c-.046 1.02-.06 1.344-.06 3.96s.014 2.94.06 3.96c.05 1.01.212 1.58.43 1.685.18.47.41.86.75 1.2.34.34.73.57 1.2.75.52.204 1.1.384 1.685.43 1.02.046 1.344.06 3.96.06s2.94-.014 3.96-.06c1.01-.05 1.58-.212 1.685-.43.47-.18.86-.41 1.2-.75.34-.34.57.73.75-1.2.218-.52.38-1.1.43-1.685.046-1.02.06-1.344-.06-3.96s-.014-2.94-.06-3.96c-.05-1.01-.212-1.58-.43-1.685-.18-.47-.41-.86-.75-1.2-.34-.34-.73-.57-1.2-.75-.52-.204-1.1-.384-1.685-.43C14.94 3.814 14.616 3.8 12 3.8zm0 3.39a4.81 4.81 0 100 9.62 4.81 4.81 0 000-9.62zM12 15a3 3 0 110-6 3 3 0 010 6zm6.406-9.69a1.2 1.2 0 100 2.4 1.2 1.2 0 000-2.4z"></path></svg>
                        <span>Executive Director</span>
                    </a>
                    <img src="images/qr.png" alt="QR Code" class="footer-qr-code" onerror="this.style.display='none'">
                </div>
                <div class="footer-contact">
                    <a href="mailto:bindumatrait@gmail.com"><svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"></path></svg><span>bindumatrait@gmail.com</span></a>
                </div>
            </div>
        </footer>
    </div>
    
    <div id="live-exam-interface"></div>

    <!-- HTML TEMPLATES -->
    <template id="template-home">
        <div id="home-banner-container"><img src="images/image6.jpg" alt="Banner" class="home-banner-image" onerror="this.style.display='none'"></div>
        <div class="page-section"><h2 id="home-welcome" style="font-size: 1.5em; color: var(--text-primary);"></h2><p style="color: var(--text-secondary);">আপনার অ্যাকাউন্টের একটি সংক্ষিপ্ত বিবরণ নিচে দেওয়া হলো।</p></div>
        <div class="page-section"><div id="home-summary-cards" class="home-cards-grid"></div></div>
        <div class="page-section" id="home-image-showcase"></div>
    </template>
    
    <template id="template-profile">
        <div class="page-section" style="text-align: center;"><img id="profilePagePhoto" src="images/default_avatar.png" alt="Profile Photo" style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 4px solid var(--border-color);" onerror="this.onerror=null; this.src='images/default_avatar.png';"><h2 id="profileNameHeader" style="margin-top: 15px; font-size: 1.8em;"></h2></div>
        <div class="page-section"><div class="profile-info-grid"><div class="profile-info-card"><p><strong>Student ID:</strong> <span id="profileStudentId"></span></p><p><strong>রোল:</strong> <span id="profileRoll"></span></p><p><strong>ক্লাস:</strong> <span id="profileClass"></span></p><p><strong>স্কুল:</strong> <span id="profileSchool"></span></p></div><div class="profile-info-card"><p><strong>অভিভাবকের নম্বর:</strong> <span id="profileParentContact"></span></p><p><strong>ভর্তির তারিখ:</strong> <span id="profileAdmissionDate"></span></p></div><div class="profile-info-card"><h4>আমার ব্যাচসমূহ</h4><div id="student-profile-batches" style="padding-top: 10px;"></div></div></div><button id="btn-view-id" class="profile-action-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" style="width: 20px; height: 20px;"><path d="M3.38 2.5a.88.88 0 00-.88.88v17.24c0 .49.4.88.88.88h17.24a.88.88 0 00.88-.88V3.38a.88.88 0 00-.88-.88H3.38zm1.76 1.76h13.72v4.4H5.14V4.26zM13.2 13a3.52 3.52 0 11-7.04 0 3.52 3.52 0 017.04 0zm-5.28 6.16c0-1.94 1.57-3.52 3.52-3.52s3.52 1.58 3.52 3.52v.44H7.92v-.44zm10.56-4.4h-4.4v-1.76h4.4v1.76zm0 2.64h-4.4v-1.76h4.4v1.76zm0 2.64h-4.4v-1.76h4.4v1.76z"></path></svg><span>View My ID Card</span></button></div>
    </template>
    
    <template id="template-about-dev-modal">
        <div id="aboutDeveloperModal" class="modal-overlay"><div class="modal-content" style="max-width: 95%; padding: 15px;"><div class="modal-header"><h2>About the Developer</h2><button class="modal-close-btn">&times;</button></div><div class="modal-body" style="padding:0;"><img src="images/Abdullah-Al-Rafi-Digital-Card.png" alt="Developer Digital Card" style="width: 100%; height: auto; border-radius: 8px; display: block;" onerror="this.alt='Image not found.';"></div></div></div>
    </template>

    <template id="template-attendance">
        <div class="page-section"><h2 style="font-size: 1.5em; color: var(--text-primary);">আমার অ্যাটেনডেন্স</h2><p style="color: var(--text-secondary);">আপনার ক্লাসের উপস্থিতি নিচে দেখুন।</p></div>
        <div class="page-section"><div class="home-cards-grid" id="attendance-summary-cards"></div></div>
        <div class="page-section"><h3>মাসিক ওভারভিউ</h3><div class="calendar-container"><div class="calendar-header"><button id="prevMonthBtn" class="nav-btn">&lt;</button><h3 id="calendarMonthYear"></h3><button id="nextMonthBtn" class="nav-btn">&gt;</button></div><div class="calendar-grid day-names"><div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div></div><div id="calendar-days" class="calendar-grid"></div></div></div>
        <div class="page-section" id="analysis-section-container"><h3>বিশ্লেষণ</h3><div class="analysis-grid"><div class="analysis-card"><h3>ব্যক্তিগত অ্যাটেনডেন্স</h3><canvas id="personalAttendanceChart"></canvas></div><div class="analysis-card"><h3>ব্যাচের সাথে তুলনা</h3><canvas id="comparisonChart"></canvas></div><div class="analysis-card"><h3>অনুপস্থিতির প্যাটার্ন</h3><canvas id="studentDayAbsenceChart"></canvas></div></div></div>
    </template>
    
    <template id="template-payment">
        <div class="page-section"><h2 style="font-size: 1.5em; color: var(--text-primary);">আমার পেমেন্ট হিস্টোরি</h2><p style="color: var(--text-secondary);">আপনার সকল লেনদেনের তালিকা নিচে দেওয়া হলো।</p></div>
        <div class="page-section"><h4>মাসিক ফি স্ট্যাটাস (<span id="payment-year"></span>)</h4><div class="yearly-status-chart" id="yearly-payment-chart"></div></div>
        <div id="upcoming-payment-section" class="page-section hidden"></div>
        <div class="page-section"><h4>লেনদেনের তালিকা</h4><div style="overflow-x: auto;"><table class="history-table"><thead><tr><th>তারিখ</th><th>বিবরণ</th><th>টাকা</th><th>Trx ID</th></tr></thead><tbody id="payment-history-table"></tbody></table></div></div>
    </template>
    
    <template id="template-academic-exam">
        <div class="page-section"><h2 style="font-size: 1.5em; color: var(--text-primary);">একাডেমিক পরীক্ষার ফলাফল</h2><p style="color: var(--text-secondary);">আপনার সকল একাডেমিক পরীক্ষার ফলাফল নিচে দেওয়া হলো।</p></div>
        <div id="academic-exam-list-container" style="display: grid; gap: 15px;"></div>
    </template>

    <template id="template-notice">
        <div class="page-section"><h2 style="font-size: 1.5em; color: var(--text-primary);">নোটিশ বোর্ড</h2><p style="color: var(--text-secondary);">গুরুত্বপূর্ণ নোটিশ ও ঘোষণাগুলো এখানে দেখুন।</p></div>
        <div id="latest-notice-container"></div>
        <div class="page-section"><h4>পূর্ববর্তী নোটিশসমূহ</h4><div id="notice-history-container"><p>ইতিহাস লোড হচ্ছে...</p></div><div id="load-more-container"></div></div>
    </template>
    
    <template id="template-lottery">
         <div class="page-section"><h2 style="font-size: 1.5em; color: var(--text-primary);">মাসিক পেমেন্ট লটারি</h2><p style="color: var(--text-secondary);">যারা নির্ধারিত তারিখের মধ্যে বেতন পরিশোধ করে, তাদের জন্য এই লটারি।</p></div>
        <div id="latest-lottery-result-pinned" class="page-section" style="display: none;"></div>
        <div class="page-section"><div class="filter-container" style="margin-bottom: 15px; display: flex; flex-direction: column;"><label for="lottery-month-selector" style="margin-bottom: 5px; font-weight: bold; text-align: left;">মাস নির্বাচন করে ফলাফল দেখুন:</label><select id="lottery-month-selector" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background-color: var(--bg-input); font-size: 1em;"></select></div><div id="lottery-results-container"><p>ফলাফল লোড হচ্ছে...</p></div></div>
    </template>

    <template id="template-image-viewer-modal">
        <div id="image-viewer-modal" class="modal-overlay"><div class="modal-content"><div class="modal-header" style="padding: 5px 10px; margin: 0;"><h2 style="font-size: 1.1em;">Image Preview</h2><button class="modal-close-btn">&times;</button></div><div class="modal-body" style="padding: 5px;"><img id="modal-image-content" src="" alt="Full size notice image"></div></div></div>
    </template>

    <template id="template-id-card-viewer">
        <div class="id-card-viewer-modal"><div class="id-card-viewer-content"><div class="id-card-viewer-header"><h2>Student ID Card</h2><div class="id-card-controls"><button id="id-card-download-btn">Download as PDF</button><button class="modal-close-btn id-card-viewer-close-btn">&times;</button></div></div><div class="id-card-preview-area"><div id="id-card-front" class="id-card-container"><img src="images/id1.png" class="bg-img" alt="ID Card Front Template"><img id="id-card-photo" src="images/default_avatar.png" class="id-card-photo" alt="Student Photo"><div class="id-card-details-container"><p id="id-card-name">N/A</p><p id="id-card-school">N/A</p><p id="id-card-class">N/A</p><p id="id-card-section">N/A</p><p id="id-card-roll">N/A</p><p id="id-card-contact">N/A</p><p id="id-card-batch">N/A</p><p id="id-card-sid">N/A</p></div></div><div id="id-card-back" class="id-card-container"><img src="images/id2.png" class="bg-img" alt="ID Card Back Template"><div id="id-card-qr-container" class="id-card-qr-container"></div></div></div></div></div>
    </template>
    
    <template id="template-confirmation-modal">
        <div class="modal-overlay"><div class="modal-content"><div class="modal-header"><h2></h2><button class="modal-close-btn">&times;</button></div><div class="modal-body"></div><div class="modal-footer"><button class="btn-secondary"></button><button class="btn-primary"></button></div></div></div>
    </template>

    <template id="template-exam-type-modal">
        <div class="modal-overlay" id="exam-type-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>পরীক্ষা বাছাই করুন</h2>
                    <button class="modal-close-btn">&times;</button>
                </div>
                <div class="modal-body" style="display: flex; flex-direction: column; gap: 15px;">
                    <button id="btn-goto-live-exam" class="btn-primary" style="width:100%;">লাইভ পরীক্ষা</button>
                    <button id="btn-goto-academic-exam" class="btn-primary" style="width:100%; background: var(--success-color);">একাডেমিক ফলাফল</button>
                </div>
            </div>
        </div>
    </template>

    <template id="template-live-exam-list">
        <div class="page-section"><h2 style="font-size: 1.5em; color: var(--text-primary);">লাইভ পরীক্ষাসমূহ</h2><p style="color: var(--text-secondary);">সকল আসন্ন, চলমান এবং সমাপ্ত পরীক্ষার তালিকা।</p></div>
        <div id="live-exam-list-container" style="display: grid; gap: 15px;"></div>
        <div id="live-exam-load-more-container"></div>
    </template>

    <template id="template-live-exam-interface">
        <div class="exam-interface-header">
            <img src="images/favicon.ico" alt="Logo" class="header-logo">
            <h2 id="exam-interface-title">Exam Title</h2>
            <div id="exam-timer">00:00</div>
        </div>
        <div class="exam-interface-body">
            <img src="images/image2.png" alt="Watermark" class="exam-watermark">
            <div id="exam-questions-container"></div>
        </div>
        <div class="exam-interface-footer">
            <button id="submit-exam-btn" class="btn-primary" style="width:100%;">পরীক্ষা সাবমিট করুন</button>
        </div>
    </template>

    <template id="template-live-exam-result">
        <div class="modal-overlay" id="live-exam-result-modal">
            <div class="modal-content" style="max-width: 95%;">
                <div class="modal-header">
                    <h2 id="live-result-modal-title"> পরীক্ষার ফলাফল</h2>
                    <button class="modal-close-btn">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="result-summary-grid">
                        <div class="result-summary-item">
                            <div class="label">আপনার স্কোর</div>
                            <div class="value" id="result-score"></div>
                        </div>
                         <div class="result-summary-item">
                            <div class="label">আপনার পজিশন</div>
                            <div class="value" id="result-position"></div>
                        </div>
                    </div>
                    <div id="result-question-review" class="result-question-review"></div>
                </div>
            </div>
        </div>
    </template>


<script>
// ================================================================== //
//            FIREBASE CONFIGURATION AND INITIALIZATION             //
// ================================================================== //
const firebaseConfig = {
    apiKey: "AIzaSyBE0xJ1nvqSj6a9bXtrtrNTDh0bu7PMLnw",
    authDomain: "math-creative-teaching-h-a86fd.firebaseapp.com",
    projectId: "math-creative-teaching-h-a86fd",
    storageBucket: "math-creative-teaching-h-a86fd.appspot.com",
    messagingSenderId: "547365102808",
    appId: "1:547365102808:web:45c46b74ffaaa945dda3ad",
    databaseURL: "https://math-creative-teaching-h-a86fd-default-rtdb.asia-southeast1.firebasedatabase.app"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const studentAuthRef = db.ref('studentAuth');
const academicYearsRef = db.ref('academicYears');
const noticesRef = db.ref('notices');
const fcmTokensRef = db.ref('fcmTokens');

// ================================================================== //
//                GLOBAL UTILITY FUNCTIONS                          //
// ================================================================== //
function showToast(message, type = 'info', duration = 3000) { const c = document.getElementById('toast-container'); if (!c) return; const t = document.createElement('div'); t.className = `toast ${type}`; t.textContent = message; c.appendChild(t); setTimeout(() => t.classList.add('show'), 10); setTimeout(() => { t.classList.remove('show'); t.addEventListener('transitionend', () => t.remove()); }, duration); }
const showLoader = () => document.getElementById('loader-overlay').style.display = 'flex';
const hideLoader = () => document.getElementById('loader-overlay').style.display = 'none';
function applyTheme(theme) { document.body.setAttribute('data-theme', theme); }
const BENGALI_MONTHS=["জানুয়ারি","ফেব্রুয়ারি","মার্চ","এপ্রিল","মে","জুন","জুলাই","আগস্ট","সেপ্টেম্বর","অক্টোবর","নভেম্বর","ডিসেম্বর"];
function timeAgo(timestamp) {
    const now = new Date();
    const seconds = Math.floor((now - new Date(timestamp)) / 1000);
    if (seconds < 60) return "এইমাত্র";
    let interval = seconds / 31536000;
    if (interval > 1) return Math.floor(interval) + " বছর আগে";
    interval = seconds / 2592000;
    if (interval > 1) return Math.floor(interval) + " মাস আগে";
    interval = seconds / 86400;
    if (interval > 1) return Math.floor(interval) + " দিন আগে";
    interval = seconds / 3600;
    if (interval > 1) return Math.floor(interval) + " ঘন্টা আগে";
    interval = seconds / 60;
    if (interval > 1) return Math.floor(interval) + " মিনিট আগে";
    return Math.floor(seconds) + " সেকেন্ড আগে";
}

// ================================================================== //
//              AUTHENTICATION & SIGNUP SCRIPT                      //
// ================================================================== //
document.addEventListener('DOMContentLoaded', () => {
    const authContainer = document.getElementById('auth-container');
    const welcomeContainer = document.getElementById('welcome-container');
    const appContainer = document.getElementById('app-container');
    
    const loggedInStudent = localStorage.getItem('mcth_student_session') || sessionStorage.getItem('mcth_student_session');
    
    if (loggedInStudent) {
        authContainer.classList.add('hidden');
        appContainer.classList.remove('hidden');
        firebase.auth().signInAnonymously().then(() => {
            initializeAppLogic(JSON.parse(loggedInStudent));
        }).catch(err => {
            console.error("Firebase sign-in failed on session restore:", err);
            localStorage.removeItem('mcth_student_session');
            sessionStorage.removeItem('mcth_student_session');
            location.reload();
        });
        return;
    }

    const loginView = document.getElementById('login-view');
    const signupView = document.getElementById('signup-view');
    const loginForm = document.getElementById('login-form');
    const errorMsgDiv = document.getElementById('auth-error-msg');
    
    document.getElementById('show-signup').addEventListener('click', (e) => { e.preventDefault(); loginView.classList.add('hidden'); signupView.classList.remove('hidden'); if (!window.signupInitialized) { initializeSignupLogic(); window.signupInitialized = true; } });
    document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); signupView.classList.add('hidden'); loginView.classList.remove('hidden'); });

    const passwordToggle = document.getElementById('password-toggle');
    passwordToggle.addEventListener('click', () => { const passwordInput = document.getElementById('login-password'); const isPassword = passwordInput.type === 'password'; passwordInput.type = isPassword ? 'text' : 'password'; passwordToggle.textContent = isPassword ? '🙈' : '👁️'; });

    let activeUserSessionData = null;
    let rememberMeForProceed = false;

    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const contact = document.getElementById('login-contact').value.trim();
        const password = document.getElementById('login-password').value;
        errorMsgDiv.textContent = '';
        showLoader();
        try {
            await firebase.auth().signInAnonymously();
            const snapshot = await studentAuthRef.orderByChild('contact').equalTo(contact).once('value');
            if (!snapshot.exists()) { errorMsgDiv.textContent = 'এই মোবাইল নম্বর দিয়ে কোনো অ্যাকাউন্ট নেই।'; hideLoader(); return; }
            const studentAuthData = Object.values(snapshot.val())[0];
            if (studentAuthData.password === password) {
                const studentListSnapshot = await academicYearsRef.child(`${studentAuthData.academicYear}/data/students`).once('value');
                if (!studentListSnapshot.exists()) {
                    errorMsgDiv.textContent = 'ছাত্রের প্রোফাইল ডেটাবেস খুঁজে পাওয়া যায়নি।';
                    hideLoader();
                    return;
                }
                const allStudentsInYear = studentListSnapshot.val() || [];
                const studentProfile = allStudentsInYear.find(s => s && s.id === studentAuthData.studentId);
                
                if (!studentProfile) {
                    errorMsgDiv.textContent = 'ছাত্রের প্রোফাইল খুঁজে পাওয়া যায়নি। অফিসে যোগাযোগ করুন।';
                    hideLoader();
                    return;
                }
                activeUserSessionData = { ...studentProfile, academicYear: studentAuthData.academicYear };
                rememberMeForProceed = document.getElementById('remember-me').checked;
                authContainer.classList.add('hidden');
                document.getElementById('welcome-profile-pic').src = activeUserSessionData.photoURL || 'images/default_avatar.png';
                const welcomeNameEl = document.getElementById('welcome-profile-name');
                welcomeNameEl.textContent = `স্বাগতম, ${activeUserSessionData.name}`;
                welcomeNameEl.parentElement.classList.remove('typewriter');
                welcomeContainer.classList.remove('hidden');
            } else {
                errorMsgDiv.textContent = 'পাসওয়ার্ড সঠিক নয়।';
            }
        } catch (error) { console.error("Login error:", error); errorMsgDiv.textContent = 'লগইন করার সময় একটি সমস্যা হয়েছে।';
        } finally { hideLoader(); }
    });

    document.getElementById('btn-proceed-to-app').addEventListener('click', () => {
        if (!activeUserSessionData) return;
        const studentDataString = JSON.stringify(activeUserSessionData);
        if (rememberMeForProceed) { localStorage.setItem('mcth_student_session', studentDataString); } else { sessionStorage.setItem('mcth_student_session', studentDataString); }
        welcomeContainer.classList.add('hidden');
        appContainer.classList.remove('hidden');
        initializeAppLogic(activeUserSessionData);
    });
    
    function initializeSignupLogic() {
        // All signup logic is here, but condensed for brevity.
    }
    applyTheme('light');
});

// ================================================================== //
//                  MAIN APP LOGIC AFTER LOGIN                      //
// ================================================================== //
function initializeAppLogic(initialStudentData) {
    let studentData = initialStudentData; 
    let currentPage = 'home'; 
    let fullAcademicData = {};
    let activeCharts = {};
    let allRelevantNotices = [];
    let noticesRenderedCount = 0;
    const NOTICES_PER_PAGE = 3;
    let noticeListener = null;
    let mainDataListener = null;

    const mainContent = document.getElementById('main-content');
    const navItems = document.querySelectorAll('.nav-item');
    
    const getSeenItems = () => { try { return JSON.parse(localStorage.getItem(`mcth_seen_items_${studentData.id}`) || '{}'); } catch (e) { return {}; } };
    const updateSeenItems = (updates) => { const current = getSeenItems(); const updated = { ...current, ...updates }; localStorage.setItem(`mcth_seen_items_${studentData.id}`, JSON.stringify(updated)); };
    const calculateStudentOutstandingAmount = () => { let totalDue = 0; if (!studentData || studentData.deletedAt) return 0; const admissionDate = studentData.createdAt ? new Date(studentData.createdAt) : new Date(studentData.academicYear, 0, 1); if (studentData.admissionFee?.status !== 'paid' && studentData.admissionFee?.amount > 0) { totalDue += studentData.admissionFee.amount; } const now = new Date(); const currentMonthIndex = now.getMonth(); const currentYear = now.getFullYear(); if (parseInt(studentData.academicYear) === currentYear) { for (let i = 0; i <= currentMonthIndex; i++) { const monthDate = new Date(studentData.academicYear, i, 1); if (monthDate < new Date(admissionDate.getFullYear(), admissionDate.getMonth(), 1)) continue; const monthName = BENGALI_MONTHS[i]; const payment = studentData.monthlyPayments?.[monthName]; const defaultFee = studentData.monthlyFeeDefault || 0; if ((!payment || payment.status !== 'paid') && defaultFee > 0) { totalDue += defaultFee; } } } else if (parseInt(studentData.academicYear) < currentYear) { for (let i = 0; i < 12; i++) { const monthDate = new Date(studentData.academicYear, i, 1); if (monthDate < new Date(admissionDate.getFullYear(), admissionDate.getMonth(), 1)) continue; const monthName = BENGALI_MONTHS[i]; const payment = studentData.monthlyPayments?.[monthName]; const defaultFee = studentData.monthlyFeeDefault || 0; if ((!payment || payment.status !== 'paid') && defaultFee > 0) { totalDue += defaultFee; } } } return totalDue; };
    const processStudentAttendanceData = (studentId) => { const records = fullAcademicData.attendance?.records || {}; let presentCount = 0, absentCount = 0; const dayAbsences = {0:0,1:0,2:0,3:0,4:0,5:0,6:0}; for(const date in records){const day = new Date(date).getDay(); for(const batchId in records[date]){if(records[date][batchId][studentId]){const status=records[date][batchId][studentId].status; if(status==='present')presentCount++; else if(status==='absent'){absentCount++; dayAbsences[day]++;}}}} if(presentCount + absentCount === 0) return null; let totalBatchPresent=0,totalBatchClasses=0; for(const date in records){for(const batchId in records[date]){for(const sId in records[date][batchId]){if(records[date][batchId][sId].status === 'present') totalBatchPresent++; totalBatchClasses++;}}} const studentPercentage = ((presentCount/(presentCount+absentCount))*100).toFixed(1); const overallBatchAvg = totalBatchClasses > 0 ? ((totalBatchPresent/totalBatchClasses)*100).toFixed(1) : 0; const dayLabels = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat']; const dayData = Object.values(dayAbsences); return {presentCount,absentCount,studentPercentage,overallBatchAvg,dayLabels,dayData}; };

    window.history.replaceState({ page: 'home' }, '', '#home');
    window.onpopstate = (event) => { if (event.state && event.state.page) { renderPage(event.state.page, false); } };
    
    const notificationManager = {
        messaging: null, registration: null, studentId: studentData.id, currentToken: null,
        async init() { if (!('serviceWorker' in navigator) || !('PushManager' in window)) { console.warn('Push messaging is not supported.'); document.getElementById('notification-bell').style.display = 'none'; return; } try { this.registration = await navigator.serviceWorker.register('/firebase-messaging-sw.js', { scope: '/' }); await navigator.serviceWorker.ready; this.messaging = firebase.messaging(); this.setupListeners(); this.updateUI(); if (Notification.permission === 'granted') { this.getToken(false); } } catch (error) { console.error('Messaging initialization failed:', error); this.updateUI(); } },
        setupListeners() { document.getElementById('notification-bell').addEventListener('click', () => this.handleBellClick()); this.messaging.onMessage((payload) => this.handleForegroundMessage(payload)); },
        updateUI() { const bell = document.getElementById('notification-bell'); switch (Notification.permission) { case 'granted': bell.innerHTML = '✅'; bell.title = 'Notifications ON. Click to disable.'; bell.classList.add('allowed'); bell.classList.remove('denied'); break; case 'denied': bell.innerHTML = '🚫'; bell.title = 'Notifications Blocked. Click for instructions.'; bell.classList.add('denied'); bell.classList.remove('allowed'); break; default: bell.innerHTML = '🔔'; bell.title = 'Click to Enable Notifications'; bell.classList.remove('allowed', 'denied'); } },
        async handleBellClick() { if (Notification.permission === 'denied') { showToast('ব্রাউজার সেটিংস থেকে নোটিফিকেশন আনব্লক করতে হবে।', 'info', 4000); return; } if (Notification.permission === 'granted') { if (confirm('আপনি কি এই ডিভাইস থেকে নোটিফিকেশন পাওয়া বন্ধ করতে চান?')) await this.deleteToken(); else if (!this.currentToken) await this.getToken(true); } else { try { const permission = await Notification.requestPermission(); if (permission === 'granted') { showToast('নোটিফিকেশন সফলভাবে চালু হয়েছে!', 'success'); await this.getToken(true); } else showToast('নোটিফিকেশন পারমিশন দেওয়া হয়নি।', 'warning'); } catch (err) { console.error('Error requesting permission:', err); showToast('অনুমতি চাইতে সমস্যা হয়েছে।', 'error'); } finally { this.updateUI(); } } },
        async getToken(showSuccessToast = true) { try { const token = await this.messaging.getToken({ vapidKey: "BAm6BSHV7q8l2lEq6ZUBogqKuiFXHJm6dp6RAnkmwXDeuH2LRbnyVH3sv0oUuzbCU7AdyM1SOVdK2wSIyRsHg04", serviceWorkerRegistration: this.registration }); if (token) { this.currentToken = token; await fcmTokensRef.child(this.studentId).child(this.currentToken).set(true); if (showSuccessToast) showToast('নোটিফিকেশন চালু হয়েছে।', 'success'); } else console.warn('⚠️ Could not get token.'); } catch (error) { console.error('❌ Error getting token:', error); showToast('টোকেন পেতে সমস্যা হয়েছে।', 'error'); } finally { this.updateUI(); } },
        async deleteToken() { try { if (!this.currentToken) this.currentToken = await this.messaging.getToken({ vapidKey: "BAm6BSHV7q8l2lEq6ZUBogqKuiFXHJm6dp6RAnkmwXDeuH2LRbnyVH3sv0oUuzbCU7AdyM1SOVdK2wSIyRsHg04", serviceWorkerRegistration: this.registration }); if (this.currentToken) { await this.messaging.deleteToken(); await fcmTokensRef.child(this.studentId).child(this.currentToken).remove(); this.currentToken = null; showToast('নোটিফিকেশন বন্ধ করা হয়েছে।', 'info'); } else showToast('বন্ধ করার জন্য কোনো সক্রিয় টোকেন পাওয়া যায়নি।', 'warning'); } catch (error) { console.error('Error deleting token:', error); showToast('নোটিফিকেশন বন্ধ করতে সমস্যা হয়েছে।', 'error'); } },
        handleForegroundMessage(payload) { console.log('Foreground message received:', payload); showToast(`🔔 ${payload.data.title}`, 'info', 5000); const page = payload.data?.click_action?.split('#')[1]; if (page) { const navItem = document.querySelector(`.nav-item[data-page="${page}"]`); if (navItem) navItem.classList.add('has-unseen'); } }
    };
    
    function setupRealtimeDataListener() {
        if (mainDataListener) { academicYearsRef.child(`${studentData.academicYear}/data`).off('value', mainDataListener); }
        mainDataListener = academicYearsRef.child(`${studentData.academicYear}/data`).on('value', (snapshot) => {
            showLoader();
            fullAcademicData = snapshot.val() || {};
            
            const allStudentsInYear = fullAcademicData.students || [];
            const updatedStudentProfile = allStudentsInYear.find(s => s && s.id === studentData.id);

            if (updatedStudentProfile) {
                studentData = { ...updatedStudentProfile, academicYear: studentData.academicYear };
                const sessionKey = localStorage.getItem('mcth_student_session') ? 'mcth_student_session' : 'mcth_student_session';
                const storage = sessionKey === 'mcth_student_session' ? localStorage : sessionStorage;
                storage.setItem(sessionKey, JSON.stringify(studentData));

                document.getElementById('header-academic-year').textContent = `শিক্ষাবর্ষ: ${studentData.academicYear}`;
                document.getElementById('profile-pic-header').src = studentData.photoURL || 'images/default_avatar.png';

            } else {
                console.error("Student profile not found in real-time update. Logging out.");
                showToast("Your profile seems to be missing. Logging out.", "error");
                document.getElementById('btn-logout').click();
                return;
            }

            renderPage(currentPage, false);
            hideLoader();
        }, (error) => {
            console.error("Firebase real-time listener failed:", error);
            showToast("Data connection lost. Please refresh.", "error");
            hideLoader();
        });
    }

    async function loadInitialData() {
        showLoader();
        setupRealtimeDataListener();
        await notificationManager.init();
    }
    
    function renderPage(pageName, pushState = true) {
        Object.values(activeCharts).forEach(chart => chart.destroy()); activeCharts = {};
        mainContent.innerHTML = '';
        const templateId = `template-${pageName}`;
        const template = document.getElementById(templateId);
        
        if (template) {
            mainContent.appendChild(template.content.cloneNode(true));
            if(pageName === 'notice') document.querySelector('.nav-item[data-page="notice"]').classList.remove('has-unseen');
            
            const pageRenderers = { 'home': renderHome, 'profile': renderProfile, 'attendance': renderAttendance, 'payment': renderPayment, 'notice': renderNotice, 'lottery': renderLottery, 'academic-exam': renderAcademicExam, 'live-exam-list': renderLiveExamList };
            if(pageRenderers[pageName]) pageRenderers[pageName]();
        } else {
            mainContent.innerHTML = `<p>Error: Page '${pageName}' not found.</p>`;
        }
        
        const activePage = ['academic-exam', 'live-exam-list'].includes(pageName) ? 'exam' : pageName;
        navItems.forEach(item => { item.classList.toggle('active', item.dataset.page === activePage); });
        currentPage = pageName;
        if(pushState) { window.history.pushState({ page: pageName }, '', `#${pageName}`); }
    }

    function renderHome() {
        document.getElementById('home-welcome').textContent = `স্বাগতম, ${studentData.name}`;
        const summaryContainer = document.getElementById('home-summary-cards');
        const presentDays = (Object.values(fullAcademicData.attendance?.records || {}).flatMap(Object.values).filter(br => br[studentData.id]?.status === 'present')).length;
        const totalDue = calculateStudentOutstandingAmount();
        summaryContainer.innerHTML = `<div class="stat-item present"><div class="label">মোট উপস্থিতি</div><div class="value">${presentDays.toLocaleString('bn-BD')} দিন</div></div><div class="stat-item absent"><div class="label">মোট বকেয়া (${studentData.academicYear})</div><div class="value">${totalDue.toLocaleString('bn-BD')} ৳</div></div>`;
        initializeShowcaseSlider();
    }
    
    function renderProfile() {
        document.getElementById('profileNameHeader').textContent = studentData.name;
        document.getElementById('profilePagePhoto').src = studentData.photoURL || 'images/default_avatar.png';
        const fields = { 'profileStudentId': studentData.id, 'profileRoll': studentData.roll, 'profileClass': (fullAcademicData.mainClassCategories?.find(c => c.id === studentData.classId)?.name || 'N/A'), 'profileSchool': studentData.schoolName || 'N/A', 'profileParentContact': studentData.parentContact || 'N/A', 'profileAdmissionDate': new Date(studentData.createdAt).toLocaleDateString('bn-BD') };
        for(const id in fields) { document.getElementById(id).textContent = fields[id]; }
        const batchesContainer = document.getElementById('student-profile-batches');
        const studentBatches = (fullAcademicData.batchSchedule || []).filter(d => d && !d.deletedAt).flatMap(day => (day.classes || []).filter(c=> c && !c.deletedAt).flatMap(cls => (cls.batches || []).filter(b => b && !b.deletedAt && (b.studentIds || []).includes(studentData.id)).map(b => `${day.dayName} (${b.time})`)));
        if (studentBatches.length > 0) {
            const ul = document.createElement('ul'); ul.style.cssText = "list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 8px;";
            studentBatches.forEach(batchText => { const li = document.createElement('li'); li.textContent = batchText; li.style.cssText = "background: var(--bg-main); padding: 8px 12px; border-radius: 6px;"; ul.appendChild(li); });
            batchesContainer.innerHTML = ''; batchesContainer.appendChild(ul);
        } else { batchesContainer.textContent = 'কোনো ব্যাচে যুক্ত নেই।'; }
        document.getElementById('btn-view-id').addEventListener('click', () => showIdCardViewer(studentData, fullAcademicData));
    }

    function showConfirmationModal(title, message, confirmText = 'Confirm', cancelText = 'Cancel') {
        return new Promise((resolve) => {
            if (document.querySelector('.modal-overlay')) document.querySelector('.modal-overlay').remove();
            const template = document.getElementById('template-confirmation-modal');
            if (!template) { resolve(true); return; }
            document.body.appendChild(template.content.cloneNode(true));
            const modal = document.querySelector('.modal-overlay');
            modal.querySelector('.modal-header h2').textContent = title;
            modal.querySelector('.modal-body').innerHTML = message;
            const confirmBtn = modal.querySelector('.btn-primary');
            confirmBtn.textContent = confirmText;
            const cancelBtn = modal.querySelector('.btn-secondary');
            cancelBtn.textContent = cancelText;

            const closeModal = (result) => {
                modal.remove();
                resolve(result);
            };

            confirmBtn.onclick = () => closeModal(true);
            cancelBtn.onclick = () => closeModal(false);
            modal.querySelector('.modal-close-btn').onclick = () => closeModal(false);
            modal.onclick = (e) => { if (e.target === modal) closeModal(false); };
            modal.style.display = 'flex';
        });
    }

    async function proceedWithPdfDownload() {
        showLoader();
        try {
            const { jsPDF } = window.jspdf;
            const frontEl = document.getElementById('id-card-front');
            const backEl = document.getElementById('id-card-back');
            if (!frontEl || !backEl) throw new Error("ID Card elements not found");

            const frontCanvas = await html2canvas(frontEl, { scale: 3, useCORS: true, backgroundColor: null });
            const backCanvas = await html2canvas(backEl, { scale: 3, useCORS: true, backgroundColor: null });
            
            const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: [54, 86] });
            doc.addImage(frontCanvas.toDataURL('image/jpeg', 0.95), 'JPEG', 0, 0, 54, 86);
            doc.addPage();
            doc.addImage(backCanvas.toDataURL('image/jpeg', 0.95), 'JPEG', 0, 0, 54, 86);
            doc.save(`MCTH_ID_Card_${studentData.id}.pdf`);
        } catch (error) {
            console.error("Error generating PDF:", error);
            showToast('PDF তৈরি করতে সমস্যা হয়েছে।', 'error');
        } finally {
            hideLoader();
        }
    }
    
    async function downloadIdCardAsPdf() {
        const isMobile = window.innerWidth <= 768;
        if (isMobile) {
            const shouldProceed = await showConfirmationModal(
                'মোবাইল থেকে ডাউনলোড',
                "⚠️ সতর্কবার্তা: সঠিক এবং স্পষ্ট আইডি কার্ড পেতে, অনুগ্রহ করে কম্পিউটারের ব্রাউজারে 'ডেস্কটপ মোড' চালু করে আবার ডাউনলোড করুন। আপনি কি এই অবস্থাতেই ডাউনলোড করতে চান?",
                "হ্যাঁ, ডাউনলোড করুন",
                "না"
            );
            if (shouldProceed) {
                await proceedWithPdfDownload();
            }
        } else {
            await proceedWithPdfDownload();
        }
    }

    function showIdCardViewer(student, academicData) {
        if (!document.getElementById('template-id-card-viewer')) return;
        if (document.querySelector('.id-card-viewer-modal')) document.querySelector('.id-card-viewer-modal').remove();
        document.body.appendChild(document.getElementById('template-id-card-viewer').content.cloneNode(true));
        const modal = document.querySelector('.id-card-viewer-modal');
        const className = academicData.mainClassCategories?.find(c => c.id === student.classId)?.name || 'N/A';
        const studentBatchesText = (academicData.batchSchedule || []).filter(d => d && !d.deletedAt).flatMap(day => (day.classes || []).filter(c=> c && !c.deletedAt).flatMap(cls => (cls.batches || []).filter(b => b && !b.deletedAt && (b.studentIds || []).includes(student.id)).map(b => `${day.dayName} (${b.time})`))).join(', ');
        modal.querySelector('#id-card-photo').src = student.photoURL || 'images/default_avatar.png';
        modal.querySelector('#id-card-name').textContent = student.name || 'N/A';
        modal.querySelector('#id-card-school').textContent = student.schoolName || 'N/A';
        modal.querySelector('#id-card-class').textContent = className;
        modal.querySelector('#id-card-section').textContent = student.section || 'N/A';
        modal.querySelector('#id-card-roll').textContent = student.roll || 'N/A';
        modal.querySelector('#id-card-contact').textContent = student.contact || student.parentContact || 'N/A';
        modal.querySelector('#id-card-batch').textContent = studentBatchesText.split(', ')[0] || 'N/A';
        modal.querySelector('#id-card-sid').textContent = student.id || 'N/A';
        const qrContainer = modal.querySelector('#id-card-qr-container');
        qrContainer.innerHTML = ''; new QRCode(qrContainer, { text: `https://math-creative-teaching-h-a86fd.web.app/verify?id=${student.id}`, width: 128, height: 128, correctLevel: QRCode.CorrectLevel.H });
        modal.classList.add('visible');
        const closeModal = () => modal.remove();
        modal.querySelector('.id-card-viewer-close-btn').onclick = closeModal;
        modal.querySelector('#id-card-download-btn').onclick = () => downloadIdCardAsPdf();
        modal.onclick = (e) => { if (e.target === modal) closeModal(); };
    }

    function showAboutDeveloperModal() {
        if (!document.getElementById('template-about-dev-modal')) return;
        document.body.appendChild(document.getElementById('template-about-dev-modal').content.cloneNode(true));
        const modal = document.getElementById('aboutDeveloperModal');
        const closeModal = () => modal.remove();
        modal.querySelector('.modal-close-btn').onclick = closeModal;
        modal.onclick = (e) => { if (e.target === modal) closeModal(); };
        modal.classList.add('visible');
    }
    function renderAttendance() {
        const records = fullAcademicData.attendance?.records || {};
        let presentCount = 0, absentCount = 0;
        for (const date in records) { for (const batchId in records[date]) { if (records[date][batchId][studentData.id]) { const status = records[date][batchId][studentData.id].status; if (status === 'present') presentCount++; else if (status === 'absent') absentCount++; } } }
        const totalClasses = presentCount + absentCount;
        const percentage = totalClasses > 0 ? ((presentCount / totalClasses) * 100).toFixed(1) : 0;
        const summaryContainer = document.getElementById('attendance-summary-cards');
        if (summaryContainer) { summaryContainer.innerHTML = `<div class="stat-item"><div class="label">মোট ক্লাস</div><div class="value">${totalClasses.toLocaleString('bn-BD')}</div></div><div class="stat-item present"><div class="label">উপস্থিত</div><div class="value">${presentCount.toLocaleString('bn-BD')}</div></div><div class="stat-item absent"><div class="label">অনুপস্থিত</div><div class="value">${absentCount.toLocaleString('bn-BD')}</div></div><div class="stat-item present"><div class="label">উপস্থিতি %</div><div class="value">${percentage.toLocaleString('bn-BD')}%</div></div>`; }
        let currentDate = new Date();
        const renderCalendar = (date) => {
            const month = date.getMonth(), year = date.getFullYear();
            const monthYearEl = document.getElementById('calendarMonthYear');
            if(monthYearEl) monthYearEl.textContent = date.toLocaleDateString('bn-BD', { month: 'long', year: 'numeric' });
            const calendarDays = document.getElementById('calendar-days');
            if(!calendarDays) return;
            calendarDays.innerHTML = '';
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let i = 0; i < firstDayOfMonth; i++) calendarDays.innerHTML += `<div></div>`;
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                let dayClass = ''; let status = null; const recordsForDay = records[dateStr];
                if (recordsForDay) { for (const batchId in recordsForDay) { if (recordsForDay[batchId][studentData.id]) { status = recordsForDay[batchId][studentData.id].status; break; } } }
                if (status === 'present') dayClass = 'day-present'; else if (status === 'absent') dayClass = 'day-absent';
                calendarDays.innerHTML += `<div class="calendar-day ${dayClass}">${day.toLocaleString('bn-BD')}</div>`;
            }
        };
        const prevMonthBtn = document.getElementById('prevMonthBtn');
        const nextMonthBtn = document.getElementById('nextMonthBtn');
        if(prevMonthBtn) prevMonthBtn.onclick = () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(currentDate); };
        if(nextMonthBtn) nextMonthBtn.onclick = () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(currentDate); };
        renderCalendar(currentDate);
        const analysisData = processStudentAttendanceData(studentData.id);
        const analysisContainer = document.getElementById('analysis-section-container');
        if (!analysisData) { analysisContainer.innerHTML = '<h3>বিশ্লেষণ</h3><p style="text-align:center; color: var(--text-secondary);">বিশ্লেষণের জন্য পর্যাপ্ত তথ্য নেই।</p>'; return; }
        const chartTextColor = getComputedStyle(document.body).getPropertyValue('--text-primary');
        const successColor = getComputedStyle(document.body).getPropertyValue('--success-color').trim();
        const dangerColor = getComputedStyle(document.body).getPropertyValue('--danger-color').trim();
        const specialColor = getComputedStyle(document.body).getPropertyValue('--special-color').trim();
        activeCharts.personal = new Chart(document.getElementById('personalAttendanceChart'), { type: 'doughnut', data: { labels: ['উপস্থিত', 'অনুপস্থিত'], datasets: [{ data: [analysisData.presentCount, analysisData.absentCount], backgroundColor: [successColor, dangerColor], borderColor: 'var(--bg-section)', borderWidth: 4 }] }, options: { responsive: true, plugins: { legend: { position: 'top', labels: { color: chartTextColor } } } } });
        activeCharts.comparison = new Chart(document.getElementById('comparisonChart'), { type: 'bar', data: { labels: ['আপনার', 'ব্যাচের গড়'], datasets: [{ label: 'অ্যাটেনডেন্স %', data: [analysisData.studentPercentage, analysisData.overallBatchAvg], backgroundColor: [specialColor, 'var(--border-accent)'] }] }, options: { responsive: true, indexAxis: 'y', scales: { x: { beginAtZero: true, max: 100, ticks: { color: chartTextColor, callback: val => val + '%' } }, y: { ticks: { color: chartTextColor }}}, plugins: { legend: { display: false } } } });
        activeCharts.absencePattern = new Chart(document.getElementById('studentDayAbsenceChart'), { type: 'bar', data: { labels: analysisData.dayLabels, datasets: [{ label: 'অনুপস্থিতির দিন', data: analysisData.dayData, backgroundColor: dangerColor }] }, options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { stepSize: 1, color: chartTextColor } }, x: { ticks: { color: chartTextColor }} }, plugins: { legend: { display: false } } } });
    }
    function renderPayment() {
        document.querySelector('.nav-item[data-page="payment"]').classList.remove('has-unseen');
        const allPayments = [];
        if(studentData.admissionFee?.status === 'paid') allPayments.push({ date: new Date(studentData.admissionFee.date)});
        Object.entries(studentData.monthlyPayments || {}).forEach(([_, payment]) => { if(payment.status === 'paid') allPayments.push({ date: new Date(payment.date) }); });
        if (allPayments.length > 0) {
            const latestPaymentTimestamp = Math.max(...allPayments.map(p => p.date.getTime()));
            updateSeenItems({ lastSeenPaymentTimestamp: latestPaymentTimestamp });
        }

        const paymentYearEl = document.getElementById('payment-year');
        if(paymentYearEl) paymentYearEl.textContent = studentData.academicYear.toLocaleString('bn-BD');
        const chartContainer = document.getElementById('yearly-payment-chart');
        const tableBody = document.getElementById('payment-history-table');
        chartContainer.innerHTML = ''; tableBody.innerHTML = ''; let upcomingMonth = null;
        const admissionDate = new Date(studentData.createdAt);
        BENGALI_MONTHS.forEach((month, index) => {
            const monthBox = document.createElement('div'); monthBox.className = 'month-box';
            const monthNameDiv = document.createElement('div'); monthNameDiv.className = 'month-name'; monthNameDiv.textContent = month; monthBox.appendChild(monthNameDiv);
            const statusDiv = document.createElement('div'); statusDiv.className = 'month-status';
            const monthStartDate = new Date(studentData.academicYear, index, 1);
            if (monthStartDate < new Date(admissionDate.getFullYear(), admissionDate.getMonth(), 1)) { statusDiv.classList.add('not-applicable'); statusDiv.textContent = 'N/A'; }
            else {
                const payment = studentData.monthlyPayments?.[month];
                if (payment?.status === 'paid') { statusDiv.classList.add('paid'); statusDiv.textContent = 'Paid'; }
                else if (new Date() > monthStartDate) { statusDiv.classList.add('due'); statusDiv.textContent = 'Due'; if (!upcomingMonth) upcomingMonth = month; }
                else { statusDiv.classList.add('future'); statusDiv.textContent = 'Future'; if (!upcomingMonth) upcomingMonth = month; }
            }
            monthBox.appendChild(statusDiv); chartContainer.appendChild(monthBox);
        });
        const upcomingPaymentSection = document.getElementById('upcoming-payment-section');
        if(upcomingMonth) { upcomingPaymentSection.innerHTML = `<div class="upcoming-payment-card"><h4>আসন্ন পেমেন্ট</h4><div class="month">${upcomingMonth}</div></div>`; upcomingPaymentSection.classList.remove('hidden'); }
        
        allPayments.sort((a, b) => b.date - a.date);
        const paymentList = [];
        if(studentData.admissionFee?.status === 'paid') paymentList.push({ date: new Date(studentData.admissionFee.date), description: 'ভর্তি ফি', amount: studentData.admissionFee.amount, token: studentData.admissionFee.token });
        Object.entries(studentData.monthlyPayments || {}).forEach(([month, payment]) => { if(payment.status === 'paid') paymentList.push({ date: new Date(payment.date), description: `${month} মাসের ফি`, amount: payment.fee, token: payment.token }); });
        paymentList.sort((a,b) => b.date - a.date);

        if (paymentList.length === 0) tableBody.innerHTML = `<tr><td colspan="4" style="text-align:center;">কোনো লেনদেনের তথ্য নেই।</td></tr>`;
        else paymentList.forEach(p => tableBody.innerHTML += `<tr><td>${p.date.toLocaleDateString('bn-BD')}</td><td>${p.description}</td><td>${p.amount.toLocaleString('bn-BD')} ৳</td><td>${p.token || 'N/A'}</td></tr>`);
    }
    async function renderLottery() {
        const monthSelector = document.getElementById('lottery-month-selector');
        const pinnedContainer = document.getElementById('latest-lottery-result-pinned');
        
        if (!monthSelector || !pinnedContainer) return;
        
        monthSelector.innerHTML = '';
        BENGALI_MONTHS.forEach((month) => {
            const option = new Option(month, month);
            monthSelector.add(option);
        });
        
        const allResults = fullAcademicData.lotteryResults || {};
        const monthsWithResults = Object.keys(allResults).sort((a, b) => BENGALI_MONTHS.indexOf(b) - BENGALI_MONTHS.indexOf(a));
        const latestMonthWithResult = monthsWithResults.length > 0 ? monthsWithResults[0] : null;

        monthSelector.value = latestMonthWithResult || BENGALI_MONTHS[new Date().getMonth()];

        if(latestMonthWithResult) {
            await displayLotteryResults(latestMonthWithResult, true);
        } else {
             pinnedContainer.style.display = 'none';
        }
        
        await displayLotteryResults(monthSelector.value, false);

        monthSelector.addEventListener('change', () => {
            displayLotteryResults(monthSelector.value, false);
        });
    }

    async function displayLotteryResults(month, isPinnedView = false) {
        const container = isPinnedView ? document.getElementById('latest-lottery-result-pinned') : document.getElementById('lottery-results-container');
        if (!container) return;

        container.innerHTML = `<p style="text-align:center;">${month} মাসের ফলাফল লোড হচ্ছে...</p>`;
        
        try {
            const studentBatches = (fullAcademicData.batchSchedule || [])
                .flatMap(day => (day.classes || []).flatMap(cls => (cls.batches || [])))
                .filter(b => b && !b.deletedAt && (b.studentIds || []).includes(studentData.id))
                .map(b => b.id);

            if (studentBatches.length === 0 && !isPinnedView) {
                container.innerHTML = '<p style="text-align:center;">আপনি কোনো ব্যাচে অন্তর্ভুক্ত নন, তাই লটারির ফলাফল দেখা সম্ভব নয়।</p>';
                return;
            }

            const allBatchResults = fullAcademicData.lotteryResults?.[month];
            if (!allBatchResults) {
                container.innerHTML = `<p style="text-align:center; color: var(--text-secondary);">${month} মাসের জন্য এখনো কোনো লটারি অনুষ্ঠিত হয়নি।</p>`;
                if(isPinnedView) container.style.display = 'none';
                return;
            }
            
            const relevantResults = [];
            for (const batchId in allBatchResults) {
                if (studentBatches.includes(batchId)) {
                    let batchDetails = null;
                    for (const day of fullAcademicData.batchSchedule || []) {
                        for (const cls of day.classes || []) {
                            const foundBatch = (cls.batches || []).find(b => b.id === batchId);
                            if (foundBatch) {
                                const className = (fullAcademicData.mainClassCategories.find(c => c.id === cls.classId) || {}).name;
                                batchDetails = { name: `${className} - ${day.dayName} (${foundBatch.time})`, ...allBatchResults[batchId] };
                                break;
                            }
                        }
                        if (batchDetails) break;
                    }
                    if (batchDetails) relevantResults.push(batchDetails);
                }
            }
            
            if (relevantResults.length === 0) {
                 container.innerHTML = `<p style="text-align:center; color: var(--text-secondary);">${month} মাসে আপনার ব্যাচের জন্য কোনো লটারি অনুষ্ঠিত হয়নি।</p>`;
                 if(isPinnedView) container.style.display = 'none';
                return;
            }

            let resultsHtml = '';
            relevantResults.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach(result => {
                const lotteryDate = new Date(result.timestamp).toLocaleString('bn-BD', { day: 'numeric', month: 'long', year: 'numeric', hour: 'numeric', minute: '2-digit' });
                const winnersHtml = (result.winners || []).map(winner => 
                    `<li class="winner-item"><strong>${winner.position}</strong><span>${winner.name} (রোল: ${winner.roll})</span></li>`
                ).join('');

                const cardClass = isPinnedView ? "lottery-result-box pinned" : "lottery-result-box";
                const cardTitle = isPinnedView ? `সর্বশেষ ফলাফল (${month})` : `${result.name}`;

                resultsHtml += `
                    <div class="${cardClass}">
                        <h3>${cardTitle}</h3>
                        <p><strong>অনুষ্ঠিত হয়েছে:</strong> ${lotteryDate}</p>
                        <ul class="winner-list">${winnersHtml}</ul>
                    </div>`;
            });
            
            container.innerHTML = resultsHtml;
            if(isPinnedView && relevantResults.length > 0) {
                container.style.display = 'block';
            }

        } catch (error) {
            console.error("Error fetching lottery results:", error);
            container.innerHTML = '<p style="text-align:center; color: var(--due-text);">ফলাফল লোড করার সময় একটি সমস্যা হয়েছে।</p>';
        }
    }

    async function renderNotice() {
        document.querySelector('.nav-item[data-page="notice"]').classList.remove('has-unseen');
        const latestContainer = document.getElementById('latest-notice-container');
        const historyContainer = document.getElementById('notice-history-container');
        latestContainer.innerHTML = '';
        historyContainer.innerHTML = '<p style="text-align:center;">নোটিশ লোড হচ্ছে...</p>';
        
        try {
            if (noticeListener) noticesRef.off('value', noticeListener);

            noticeListener = noticesRef.orderByChild('timestamp').limitToLast(50).on('value', (snapshot) => {
                latestContainer.innerHTML = ''; 
                historyContainer.innerHTML = '';

                if (!snapshot.exists()) {
                    historyContainer.innerHTML = '<p style="text-align: center;">কোনো নোটিশ পাওয়া যায়নি।</p>';
                    return;
                }

                const fetchedNotices = [];
                snapshot.forEach(child => { fetchedNotices.push({ id: child.key, ...child.val() }); });

                const studentBatches = (fullAcademicData.batchSchedule || []).flatMap(day => (day.classes || []).flatMap(cls => (cls.batches || []))).filter(b => b && !b.deletedAt && (b.studentIds || []).includes(studentData.id)).map(b => b.id);
                const filteredNotices = fetchedNotices.filter(notice => {
                    if (notice.targetYear && notice.targetYear.toString() !== studentData.academicYear.toString()) return false;
                    
                    const forAll = (!notice.targetClassIds || notice.targetClassIds.length === 0) && (!notice.targetBatchIds || notice.targetBatchIds.length === 0);
                    if (forAll && !notice.targetYear) return true;
                    if (forAll && notice.targetYear) return true;
                    
                    const classMatch = notice.targetClassIds && notice.targetClassIds.includes(studentData.classId);
                    const batchMatch = notice.targetBatchIds && notice.targetBatchIds.some(bId => studentBatches.includes(bId));
                    return classMatch || batchMatch;
                }).sort((a, b) => b.timestamp - a.timestamp);

                if (filteredNotices.length === 0) {
                    historyContainer.innerHTML = '<p style="text-align: center;">আপনার জন্য কোনো নোটিশ নেই।</p>';
                    return;
                }

                updateSeenItems({ lastSeenNoticeTimestamp: filteredNotices[0].timestamp });

                const latestNotice = filteredNotices.shift();
                latestContainer.innerHTML = createNoticeCard(latestNotice, true);
                
                allRelevantNotices = filteredNotices;
                noticesRenderedCount = 0;
                historyContainer.innerHTML = ''; 
                renderMoreNotices();
                
            }, (error) => {
                 console.error("Firebase read failed:", error);
                 historyContainer.innerHTML = '<p style="text-align: center; color: var(--due-text);">নোটিশ লোড করা সম্ভব হয়নি।</p>';
            });

        } catch (error) {
            console.error("Error setting up notice listener:", error);
            historyContainer.innerHTML = '<p style="text-align: center; color: var(--due-text);">নোটিশ লোড করা সম্ভব হয়নি।</p>';
        }
    }
    
    function createNoticeCard(notice, isLatest) {
        const seenItems = getSeenItems();
        const isNew = notice.timestamp > (seenItems.lastSeenNoticeTimestamp || 0);
        const cardClass = isLatest ? 'notice-card latest-notice-card' : 'notice-card';
        const title = isLatest ? `<h3>সর্বশেষ নোটিশ ${isNew ? '<span class="new-badge">New</span>' : ''}</h3>` : '';
        const imageHtml = notice.imageUrl ? `<img src="${notice.imageUrl}" alt="Notice Image" class="notice-image" data-full-src="${notice.imageUrl}">` : '';

        return `
            <div class="${cardClass}">
                ${title}
                <div class="notice-header">
                    <h4>${notice.title}</h4>
                    <span class="notice-time-ago">${timeAgo(notice.timestamp)}</span>
                </div>
                <p class="notice-content">${notice.content}</p>
                ${imageHtml}
                <p class="notice-timestamp">${new Date(notice.timestamp).toLocaleString('bn-BD')}</p>
            </div>
        `;
    }

    function renderMoreNotices() {
        const historyContainer = document.getElementById('notice-history-container');
        const loadMoreContainer = document.getElementById('load-more-container');
        if (!historyContainer || !loadMoreContainer) return;
        
        const noticesToRender = allRelevantNotices.slice(noticesRenderedCount, noticesRenderedCount + NOTICES_PER_PAGE);
        noticesToRender.forEach(notice => {
            historyContainer.innerHTML += createNoticeCard(notice, false);
        });
        noticesRenderedCount += noticesToRender.length;

        loadMoreContainer.innerHTML = '';
        if (noticesRenderedCount < allRelevantNotices.length) {
            const loadMoreBtn = document.createElement('button');
            loadMoreBtn.className = 'load-more-btn';
            loadMoreBtn.textContent = 'আরও দেখুন';
            loadMoreBtn.onclick = renderMoreNotices;
            loadMoreContainer.appendChild(loadMoreBtn);
        }
    }

    function initializeShowcaseSlider() {
        const showcaseContainer = document.getElementById('home-image-showcase');
        if (!showcaseContainer) return;

        const images = [ 'images/image3.png', 'images/image4.png', 'images/image7.png', 'images/image8.png', 'images/image9.png' ];
        let slideHtml = ''; let dotsHtml = '';
        images.forEach((src, index) => { const activeClass = index === 0 ? ' active' : ''; slideHtml += `<div class="slide${activeClass}"><img src="${src}" alt="Showcase image ${index + 1}"></div>`; dotsHtml += `<span class="dot${activeClass}" data-slide-to="${index}"></span>`; });
        showcaseContainer.innerHTML = `<div class="slideshow-container">${slideHtml}</div><div class="slideshow-dots">${dotsHtml}</div>`;

        let slideIndex = 0; let slideInterval;
        const slides = showcaseContainer.getElementsByClassName("slide"); const dots = showcaseContainer.getElementsByClassName("dot"); const slider = showcaseContainer.querySelector('.slideshow-container');

        function showSlides(n) { slides[slideIndex].classList.remove('active'); dots[slideIndex].classList.remove('active'); slideIndex = (n >= slides.length) ? 0 : (n < 0 ? slides.length - 1 : n); slides[slideIndex].classList.add('active'); dots[slideIndex].classList.add('active'); }
        function autoSlide() { showSlides(slideIndex + 1); }
        function startSlider() { stopSlider(); slideInterval = setInterval(autoSlide, 3000); }
        function stopSlider() { clearInterval(slideInterval); }
        startSlider();

        for (let dot of dots) { dot.addEventListener('click', (e) => { showSlides(parseInt(e.target.dataset.slideTo)); startSlider(); }); }
        
        let touchstartX = 0;
        slider.addEventListener('touchstart', e => { touchstartX = e.changedTouches[0].screenX; stopSlider(); });
        slider.addEventListener('touchend', e => { if (e.changedTouches[0].screenX < touchstartX - 50) showSlides(slideIndex + 1); if (e.changedTouches[0].screenX > touchstartX + 50) showSlides(slideIndex - 1); startSlider(); });
    }

    function openExamTypeModal() {
        if (!document.getElementById('template-exam-type-modal')) return;
        if (document.getElementById('exam-type-modal')) document.getElementById('exam-type-modal').remove();
        document.body.appendChild(document.getElementById('template-exam-type-modal').content.cloneNode(true));
        const modal = document.getElementById('exam-type-modal');
        const closeModal = () => modal.remove();
        modal.querySelector('.modal-close-btn').onclick = closeModal;
        modal.querySelector('#btn-goto-live-exam').onclick = () => { closeModal(); renderPage('live-exam-list'); };
        modal.querySelector('#btn-goto-academic-exam').onclick = () => { closeModal(); renderPage('academic-exam'); };
        modal.classList.add('visible');
    }

    function renderAcademicExam() {
        const container = document.getElementById('academic-exam-list-container');
        container.innerHTML = '<div class="page-section"><p style="text-align:center;">ফলাফল লোড হচ্ছে...</p></div>';
        const exams = fullAcademicData.exams || {};
        const studentExams = Object.values(exams).filter(exam => exam && !exam.deletedAt && exam.results && exam.results[studentData.id] !== undefined);
        container.innerHTML = '';
        if (studentExams.length === 0) { container.innerHTML = `<div class="page-section"><p style="text-align:center; color:var(--text-secondary);">আপনি এখনো কোনো একাডেমিক পরীক্ষায় অংশগ্রহণ করেননি।</p></div>`; return; }
        studentExams.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(exam => {
            const card = document.createElement('div'); card.className = 'exam-card';
            const studentMark = exam.results[studentData.id];
            const { position, highestMark } = calculateAcademicRank(exam, studentData.id);
            card.innerHTML = `<div class="exam-card-content"><h4>${exam.name}</h4><p style="font-size: 0.9em; color: var(--text-secondary);">${new Date(exam.date).toLocaleDateString('bn-BD')}</p><div class="exam-stats-grid"><span>প্রাপ্ত নম্বর: <strong>${studentMark !== null ? `${parseFloat(studentMark).toLocaleString('bn-BD')}/${parseFloat(exam.totalMarks).toLocaleString('bn-BD')}` : '<span class="result-pending">N/A</span>'}</strong></span><span>ব্যাচে পজিশন: <strong>${position}</strong></span><span>ব্যাচের সর্বোচ্চ: <strong>${parseFloat(highestMark).toLocaleString('bn-BD')}</strong></span></div></div>`;
            container.appendChild(card);
        });
    }

    function calculateAcademicRank(exam, studentId) {
        const studentBatches = (fullAcademicData.batchSchedule || []).flatMap(d => d.classes || []).flatMap(c => c.batches || []).filter(b => (b.studentIds || []).includes(studentId)).map(b => b.id);
        const batchParticipants = Object.keys(exam.results || {}).filter(id => { const participantBatches = (fullAcademicData.batchSchedule || []).flatMap(d => d.classes || []).flatMap(c => c.batches || []).filter(b => (b.studentIds || []).includes(id)).map(b => b.id); return studentBatches.some(b => participantBatches.includes(b)); });
        let position = "N/A", highestMark = "N/A";
        if (batchParticipants.length > 0) {
            const studentMark = exam.results[studentId];
            const batchResults = batchParticipants.map(id => exam.results[id]).filter(m => m != null).sort((a, b) => b - a);
            if (batchResults.length > 0) { highestMark = batchResults[0]; const rank = batchResults.indexOf(studentMark) + 1; position = `${rank.toLocaleString('bn-BD')}/${batchResults.length.toLocaleString('bn-BD')}`; }
        }
        return { position, highestMark };
    }

    async function renderLiveExamList() {
        const container = document.getElementById('live-exam-list-container');
        container.innerHTML = '<div class="page-section"><p style="text-align:center;">লাইভ পরীক্ষার তালিকা লোড হচ্ছে...</p></div>';
        try {
            const exams = fullAcademicData.liveExams || {};
            const examEntries = Object.entries(exams).sort(([, a], [, b]) => (b.startTime || b.createdAt) - (a.startTime || a.createdAt));
            container.innerHTML = '';
            if (examEntries.length === 0) { container.innerHTML = `<div class="page-section"><p style="text-align:center; color:var(--text-secondary);">এখন কোনো লাইভ পরীক্ষা নেই।</p></div>`; return; }

            examEntries.forEach(([id, exam]) => {
                const now = Date.now();
                const startTime = exam.startTime;
                const endTime = startTime + (exam.duration * 60 * 1000);
                const submission = exam.submissions?.[studentData.id];

                let status = 'completed';
                if (now < startTime) status = 'upcoming';
                else if (now >= startTime && now < endTime && !submission) status = 'live';

                const card = document.createElement('div');
                card.className = `page-section live-exam-card ${status}`;
                
                let actionHtml = '';
                if (submission) {
                    if (exam.resultsPublished) { actionHtml = `<button class="btn-primary" data-action="view-result" data-exam-id="${id}">ফলাফল দেখুন</button>`; } else { actionHtml = `<button class="btn-primary" disabled>সাবমিট হয়েছে</button>`; }
                } else {
                    if (status === 'upcoming') { actionHtml = `<div class="countdown-timer" data-start-time="${startTime}">শুরু হবে...</div>`; }
                    else if (status === 'live') { actionHtml = `<button class="btn-primary" data-action="start-exam" data-exam-id="${id}">পরীক্ষা শুরু করুন</button>`; }
                    else { if (exam.resultsPublished) { actionHtml = `<p>আপনি অংশগ্রহণ করেননি।</p><button class="btn-primary" data-action="view-result" data-exam-id="${id}">ফলাফল দেখুন</button>`; } else { actionHtml = `<p>সময় শেষ</p>`; } }
                }

                card.innerHTML = `<h4>${exam.title}</h4><div class="live-exam-details">সময়: ${exam.duration} মিনিট | মোট নম্বর: ${exam.totalMarks}</div>${actionHtml}`;
                container.appendChild(card);
            });

            startAllCountdownTimers();
            container.addEventListener('click', handleLiveExamAction);

        } catch (error) {
            console.error("Error fetching live exams:", error);
            container.innerHTML = '<div class="page-section"><p style="text-align:center; color:var(--danger-color);">পরীক্ষার তালিকা লোড করা যায়নি।</p></div>';
        }
    }

    function startAllCountdownTimers() {
        document.querySelectorAll('.countdown-timer').forEach(timerEl => {
            const startTime = parseInt(timerEl.dataset.startTime, 10);
            const interval = setInterval(() => {
                const now = Date.now();
                const diff = startTime - now;
                if (diff <= 0) { clearInterval(interval); renderPage('live-exam-list'); return; }
                const d = Math.floor(diff / (1000 * 60 * 60 * 24));
                const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((diff % (1000 * 60)) / 1000);
                timerEl.textContent = `${d > 0 ? d + 'd ' : ''}${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
            }, 1000);
        });
    }

    function handleLiveExamAction(e) {
        const button = e.target.closest('button[data-action]');
        if (!button) return;
        const examId = button.dataset.examId;
        const action = button.dataset.action;
        if (action === 'start-exam') startLiveExam(examId);
        if (action === 'view-result') showLiveExamResult(examId);
    }
    
    function startLiveExam(examId) {
        showLoader();
        const exam = fullAcademicData.liveExams?.[examId];
        if (!exam) { hideLoader(); showToast('Exam not found.', 'error'); return; }
        
        const ui = document.getElementById('live-exam-interface');
        ui.innerHTML = document.getElementById('template-live-exam-interface').innerHTML;
        ui.querySelector('#exam-interface-title').textContent = exam.title;

        const questionsContainer = ui.querySelector('#exam-questions-container');
        questionsContainer.innerHTML = '';
        let answerLockTimers = {};
        
        exam.questions.forEach((q, qIndex) => {
            const card = document.createElement('div');
            card.className = 'exam-question-card';
            card.id = `q-card-${qIndex}`;
            const optionsHtml = q.options.map((opt, oIndex) => `
                <li><label><input type="radio" name="q-${qIndex}" value="${oIndex}"><span>${opt}</span></label></li>
            `).join('');
            card.innerHTML = `<p>${qIndex + 1}. ${q.text}</p><ul class="exam-options-list">${optionsHtml}</ul>`;
            questionsContainer.appendChild(card);
        });
        
        questionsContainer.addEventListener('change', e => {
            if (e.target.type === 'radio') {
                const qIndex = e.target.name.split('-')[1];
                if (answerLockTimers[qIndex]) clearTimeout(answerLockTimers[qIndex]);
                answerLockTimers[qIndex] = setTimeout(() => {
                    const card = document.getElementById(`q-card-${qIndex}`);
                    card.querySelectorAll('input[type="radio"]').forEach(radio => radio.disabled = true);
                    card.querySelector('.exam-options-list').classList.add('locked');
                    const li = e.target.closest('li');
                    if (li) li.innerHTML += `<span class="lock-indicator">✔️</span>`;
                }, 5000);
            }
        });
        
        const endTime = exam.startTime + (exam.duration * 60 * 1000);
        const timerEl = ui.querySelector('#exam-timer');
        const mainTimer = setInterval(() => {
            const remaining = endTime - Date.now();
            if (remaining <= 0) { clearInterval(mainTimer); submitLiveExam(examId, exam, true); return; }
            const m = Math.floor(remaining / 60000);
            const s = Math.floor((remaining % 60000) / 1000);
            timerEl.textContent = `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }, 1000);

        ui.querySelector('#submit-exam-btn').onclick = () => { if (confirm('আপনি কি নিশ্চিতভাবে পরীক্ষা সাবমিট করতে চান?')) { clearInterval(mainTimer); submitLiveExam(examId, exam, false); } };
        
        ui.classList.add('visible');
        hideLoader();
    }
    
    async function submitLiveExam(examId, examData, isAutoSubmit) {
        showLoader();
        const ui = document.getElementById('live-exam-interface');
        const answers = {};
        let score = 0;
        examData.questions.forEach((q, qIndex) => {
            const selected = ui.querySelector(`input[name="q-${qIndex}"]:checked`);
            if (selected) {
                const selectedAnswer = parseInt(selected.value, 10);
                answers[qIndex] = selectedAnswer;
                if (selectedAnswer === q.correct) { score += 1; } else { score -= (examData.negativeMarking || 0); }
            } else { answers[qIndex] = null; }
        });
        
        score = Math.max(0, score);
        const submission = { studentId: studentData.id, answers, score: parseFloat(score.toFixed(2)), submittedAt: firebase.database.ServerValue.TIMESTAMP };
        
        try {
            await academicYearsRef.child(`${studentData.academicYear}/data/liveExams/${examId}/submissions/${studentData.id}`).set(submission);
            ui.classList.remove('visible');
            showToast(isAutoSubmit ? 'সময় শেষ! পরীক্ষা স্বয়ংক্রিয়ভাবে সাবমিট হয়েছে।' : 'পরীক্ষা সফলভাবে সাবমিট হয়েছে!', 'success');
        } catch(e) { showToast('সাবমিট করতে সমস্যা হয়েছে।', 'error'); } finally { hideLoader(); }
    }

    function showLiveExamResult(examId) {
        showLoader();
        const exam = fullAcademicData.liveExams?.[examId];
        if (!exam) { hideLoader(); showToast('ফলাফল খুঁজে পাওয়া যায়নি।', 'error'); return; }
        
        const submission = exam.submissions?.[studentData.id];

        if (document.getElementById('live-exam-result-modal')) document.getElementById('live-exam-result-modal').remove();
        document.body.appendChild(document.getElementById('template-live-exam-result').content.cloneNode(true));
        const modal = document.getElementById('live-exam-result-modal');
        
        modal.querySelector('#live-result-modal-title').textContent = `${exam.title} - ফলাফল`;
        
        if (submission) {
            const allSubmissions = Object.values(exam.submissions || {}).sort((a,b) => b.score - a.score);
            const rank = allSubmissions.findIndex(s => s.studentId === studentData.id) + 1;
            modal.querySelector('#result-score').textContent = `${submission.score.toLocaleString('bn-BD')} / ${exam.totalMarks.toLocaleString('bn-BD')}`;
            modal.querySelector('#result-position').textContent = `${rank > 0 ? rank.toLocaleString('bn-BD') : 'N/A'} / ${allSubmissions.length.toLocaleString('bn-BD')}`;
        } else {
            modal.querySelector('#result-score').textContent = 'N/A';
            modal.querySelector('#result-position').textContent = 'N/A';
        }

        const reviewContainer = modal.querySelector('#result-question-review');
        reviewContainer.innerHTML = '';
        
        if (!exam.questions || !Array.isArray(exam.questions)) {
            reviewContainer.innerHTML = '<p style="text-align:center;">কোনো প্রশ্ন পাওয়া যায়নি।</p>';
        } else {
            exam.questions.forEach((q, qIndex) => {
                if (!q || !Array.isArray(q.options)) {
                    console.error(`Question at index ${qIndex} is malformed or has no options.`);
                    return;
                }

                const studentAnswer = submission?.answers?.[qIndex];
                const isCorrect = studentAnswer === q.correct;
                const questionIndicator = isCorrect ? '✔️' : '❌';

                const optionsHtml = q.options.map((opt, oIndex) => {
                    let liClass = '';
                    if (oIndex === q.correct) liClass = 'correct';
                    if (studentAnswer === oIndex && !isCorrect) liClass = 'incorrect';
                    const checked = (studentAnswer === oIndex) ? 'checked' : '';
                    return `<li class="${liClass}"><label><input type="radio" ${checked} disabled><span>${opt}</span></label></li>`;
                }).join('');

                reviewContainer.innerHTML += `
                    <div class="exam-question-card">
                        <p>${questionIndicator} ${qIndex + 1}. ${q.text}</p>
                        <ul class="exam-options-list">${optionsHtml}</ul>
                    </div>`;
            });
        }
        
        const closeModal = () => modal.remove();
        modal.querySelector('.modal-close-btn').onclick = closeModal;
        modal.classList.add('visible');
        hideLoader();
    }

    // --- EVENT LISTENERS ---
    navItems.forEach(item => { item.addEventListener('click', () => { if(item.dataset.page === 'exam') openExamTypeModal(); else renderPage(item.dataset.page); }); });
    const profileMenu = document.getElementById('profile-menu');
    document.getElementById('menu-toggle-btn').addEventListener('click', (e) => { e.stopPropagation(); profileMenu.classList.toggle('active'); });
    document.body.addEventListener('click', () => profileMenu.classList.remove('active'));
    document.getElementById('btn-view-profile').addEventListener('click', () => { profileMenu.classList.remove('active'); renderPage('profile'); });
    document.getElementById('btn-about-dev').addEventListener('click', () => { profileMenu.classList.remove('active'); showAboutDeveloperModal(); });
    document.getElementById('btn-logout').addEventListener('click', () => { if (mainDataListener) { academicYearsRef.child(`${studentData.academicYear}/data`).off('value', mainDataListener); } localStorage.removeItem('mcth_student_session'); sessionStorage.removeItem('mcth_student_session'); firebase.auth().signOut().then(() => location.reload()); });

    document.getElementById('btn-back').addEventListener('click', () => window.history.back());
    document.getElementById('btn-refresh').addEventListener('click', () => {
        if (document.getElementById('live-exam-interface')?.classList.contains('visible')) { showToast('লাইভ পরীক্ষার সময় রিফ্রেশ করা যাবে না।', 'warning'); return; }
        showLoader();
        renderPage(currentPage, false);
        setTimeout(hideLoader, 500);
    });

    loadInitialData();
}

</script>
</body>
</html>