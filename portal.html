<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCTH Student Portal</title>
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">

    <!-- FIREBASE SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    
    <!-- Chart.js for Analysis -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <style>
        @font-face {
          font-family: 'Kalpurush';
          src: url('fonts/kalpurush.ttf') format('truetype');
        }
        :root {
            /* Theme from index.html for consistency */
            --bg-main: #f0f2f5; --bg-section: #ffffff; --bg-header: #1f2b38; --text-primary: #212529; --text-secondary: #6c757d; --text-header: #ffffff; --border-color: #dee2e6; --border-accent: #007bff; --paid-color: #d1e7dd; --due-color: #f8d7da; --paid-text: #0f5132; --due-text: #842029; --future-text: #6c757d;
            --toast-success-bg: #28a745; --toast-error-bg: #dc3545; --toast-info-bg: #17a2b8; --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.05); --shadow-md: 0 5px 15px rgba(0, 0, 0, 0.1); --danger-color: #dc3545; --success-color: #198754; --warning-color: #ffc107; --bg-hover: #e9ecef;
        }
        
        body[data-theme='dark'] {
            --bg-main: #121212; --bg-section: #1e1e1e; --bg-header: #1c232e; --text-primary: #e8eaed; --text-secondary: #9aa0a6; --text-header: #e8eaed; --border-color: #3a3a3c; --border-accent: #8ab4f8; --paid-color: #143d26; --due-color: #4a1c21; --paid-text: #a3d9a5; --due-text: #f5c6cb; --future-text: #9aa0a6; --bg-hover: #2a2a2a;
        }

        html { scroll-behavior: smooth; }
        body { margin: 0; padding: 0; font-family: 'Kalpurush', sans-serif; background-color: var(--bg-main); color: var(--text-primary); transition: background-color .3s, color .3s; }

        /* Login & Signup Styles */
        #auth-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 15px; box-sizing: border-box; }
        .auth-box { background-color: var(--bg-section); padding: 25px; border-radius: 8px; box-shadow: var(--shadow-md); width: 100%; max-width: 420px; text-align: center; border: 1px solid var(--border-color); animation: fadeIn 0.5s ease; overflow: hidden; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .auth-logo { width: 100px; height: 100px; margin: 0 auto 20px; }
        .auth-box h1 { font-size: 1.6em; margin-bottom: 20px; color: var(--border-accent); }
        .input-group { position: relative; margin-bottom: 15px; }
        .input-group input, .input-group select { width: 100%; padding: 12px 15px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 1em; background-color: var(--bg-input, #fff); color: var(--text-primary); box-sizing: border-box; }
        .password-toggle-icon { position: absolute; top: 50%; right: 15px; transform: translateY(-50%); cursor: pointer; color: var(--text-secondary); }
        .auth-options { display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; margin-bottom: 25px; }
        .auth-button { width: 100%; padding: 12px; border: none; border-radius: 8px; background: linear-gradient(45deg, var(--border-accent), #0056b3); color: white; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: all 0.3s; }
        .auth-button:hover:not(:disabled) { box-shadow: 0 4px 15px rgba(0, 123, 255, 0.4); transform: translateY(-2px); }
        .auth-button:disabled { background: #ccc; cursor: not-allowed; }
        .auth-link { margin-top: 20px; font-size: 0.9em; }
        .auth-link a { color: var(--border-accent); text-decoration: none; font-weight: bold; }
        #auth-error-msg { color: var(--due-text); margin-top: 15px; min-height: 20px; font-weight: bold; }
        .hidden { display: none !important; }

        /* Signup Specific Styles */
        .signup-step { animation: fadeIn 0.5s ease; }
        .step-title { font-size: 1.2em; color: var(--text-secondary); margin-bottom: 15px; }
        #student-selection-list .student-item { padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s ease; text-align: left; }
        #student-selection-list .student-item:hover { background-color: var(--bg-hover); border-left: 4px solid var(--border-accent); }
        #student-selection-list .student-item strong { display: block; font-size: 1.1em; }
        #student-selection-list .student-item span { font-size: 0.9em; color: var(--text-secondary); }
        .roll-selection-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px; }
        .roll-box { padding: 15px 10px; border: 2px solid var(--border-color); border-radius: 6px; cursor: pointer; transition: all 0.2s ease; font-weight: bold; font-size: 1.1em; }
        .roll-box:hover { background-color: var(--bg-hover); transform: translateY(-2px); }
        .roll-box.selected { background-color: var(--border-accent); color: white; border-color: var(--border-accent); }
        .password-strength { font-size: 0.8em; margin-top: 5px; text-align: left; }
        #lockout-message { background-color: var(--due-color); color: var(--due-text); padding: 10px; border-radius: 6px; }

        /* Login Footer (Updated) */
        .login-footer { margin-top: 25px; font-size: 0.85em; color: var(--text-secondary); text-align: center; }
        .login-footer .copyright-text { font-size: 0.9em; margin-bottom: 15px; }
        .developer-box { border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; background-color: var(--bg-main); }
        .login-footer .developed-by-text { margin-bottom: 8px; font-size: 1.1em; }
        .company-info { display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 15px; }
        .company-logo { width: 40px; height: 40px; object-fit: contain; }
        .company-text { text-align: left; line-height: 1.5; }
        .company-text strong { font-size: 1.2em; color: var(--text-primary); }
        .company-text small { font-size: 0.9em; }
        .social-icons { display: flex; justify-content: center; gap: 20px; align-items: center; }
        .social-icons a { display: inline-block; color: var(--text-secondary); transition: color 0.3s, transform 0.3s; }
        .social-icons a:hover { color: var(--border-accent); transform: scale(1.1); }
        .social-icons svg { width: 28px; height: 28px; fill: currentColor; }
        .login-footer .instruction-text { font-size: 0.8em; font-style: italic; margin-top: 12px; margin-bottom: 0; color: var(--text-secondary); }

        /* Main App Styles */
        #app-container { display: flex; flex-direction: column; min-height: 100vh; position: relative; }
        #center-watermark { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 70vw; max-width: 300px; height: 100vh; background-image: url(images/image2.png); background-size: contain; background-repeat: no-repeat; background-position: center; opacity: .05; z-index: -1; pointer-events: none; }
        body[data-theme=dark] #center-watermark{ filter: invert(1) grayscale(1); opacity: 0.08; }
        
        header { background-color: var(--bg-header); color: var(--text-header); padding: 12px 15px; position: sticky; top: 0; z-index: 1001; box-shadow: 0 2px 5px rgba(0,0,0,0.2); display: flex; justify-content: space-between; align-items: center; }
        .header-left .institute-name { font-size: 1.2em; font-weight: bold; }
        .header-right { position: relative; }
        .profile-menu-button { background: none; border: none; color: white; font-size: 1.5em; cursor: pointer; padding: 5px; }
        .profile-menu { display: none; position: absolute; top: 50px; right: 0; background-color: var(--bg-section); border-radius: 8px; box-shadow: var(--shadow-md); z-index: 1002; width: 200px; overflow: hidden; animation: fadeIn 0.2s ease; }
        .profile-menu.active { display: block; }
        .profile-menu button { width: 100%; padding: 12px 15px; text-align: left; background: none; border: none; font-size: 1em; color: var(--text-primary); cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .profile-menu button:hover { background-color: var(--bg-hover); }

        main { padding: 15px; flex-grow: 1; }
        .page-section { background-color: var(--bg-section); padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: var(--shadow-sm); border: 1px solid var(--border-color); }
        
        /* Navigation Tabs */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background-color: var(--bg-section); box-shadow: 0 -2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-around; padding: 5px 0; border-top: 1px solid var(--border-color); }
        .nav-item { flex: 1; text-align: center; padding: 8px 0; cursor: pointer; color: var(--text-secondary); transition: all 0.2s; }
        .nav-item.active { color: var(--border-accent); font-weight: bold; transform: scale(1.1); }
        .nav-icon { font-size: 1.4em; }
        .nav-label { font-size: 0.75em; display: block; }
        
        /* Dashboard & UI Enhancements */
        .stat-item { text-align: center; background: var(--bg-main); padding: 15px; border-radius: 8px; border-left: 5px solid; }
        .stat-item .label { font-size: 0.9em; color: var(--text-secondary); margin-bottom: 5px; }
        .stat-item .value { font-size: 1.8em; font-weight: bold; }
        .stat-item.present { border-left-color: var(--success-color); }
        .stat-item.present .value { color: var(--success-color); }
        .stat-item.absent { border-left-color: var(--danger-color); }
        .stat-item.absent .value { color: var(--danger-color); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .calendar-day { padding: 8px 4px; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; margin: auto; font-size: 0.8em;}
        .day-name { font-weight: bold; color: var(--text-secondary); padding-bottom: 10px; font-size: 0.8em;}
        .day-present { background-color: var(--success-color); color: white; }
        .day-absent { background-color: var(--danger-color); color: white; }
        
        /* Payment History Table */
        .history-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em; }
        .history-table th, .history-table td { padding: 10px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .history-table th { background-color: var(--bg-main); }
        .payment-status-box { padding: 5px; border-radius: 4px; font-size: .8em; font-weight: 700; border: 1px solid transparent; text-align: center; }
        .payment-status-box.paid { background-color: var(--paid-color); color: var(--paid-text); }
        .payment-status-box.due { background-color: var(--due-color); color: var(--due-text); }
        .payment-status-box.future { background-color: #e9ecef; color: var(--future-text); }

        /* Exam Page Styles */
        .exam-card { background: var(--bg-main); border: 1px solid var(--border-color); border-left: 5px solid var(--border-accent); padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .exam-card h4 { margin: 0 0 10px; font-size: 1.2em; }
        .exam-stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 0.9em; }
        .exam-stats-grid span { background: var(--bg-section); padding: 8px; border-radius: 6px; }
        .exam-stats-grid strong { color: var(--text-primary); }
        .result-pending { color: var(--warning-color); font-style: italic; }

        /* Shared Utils & Modals */
        #loader-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:10006;display:none;align-items:center;justify-content:center}.loader{border:5px solid #f3f3f3;border-top:5px solid var(--border-accent);border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        #toast-container{position:fixed;bottom:70px;left:50%;transform:translateX(-50%);z-index:10005;display:flex;flex-direction:column;gap:8px;width:90%;max-width:400px}.toast{padding:12px 15px;border-radius:6px;color:#fff;font-size:0.9em;box-shadow:0 2px 10px rgba(0,0,0,.2);opacity:0;transform:translateY(20px);transition:opacity .3s,transform .3s}.toast.show{opacity:1;transform:translateY(0)}.toast.success{background-color:var(--toast-success-bg)}.toast.error{background-color:var(--toast-error-bg)}.toast.info{background-color:var(--toast-info-bg)}
        .modal-overlay { display: none; position: fixed; z-index: 10001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,.6); backdrop-filter: blur(4px); align-items: center; justify-content: center; }
        .modal-overlay.visible { display: flex; }
        .modal-content { background-color: var(--bg-section); margin: auto; padding: 20px; border-radius: 12px; width: 95%; max-width: 500px; box-shadow: var(--shadow-md); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); }

        /* Home Page */
        .adikothon { padding: 15px; font-size: 0.95em; line-height: 1.6; }
        #homeImageSlider { width: 100%; height: auto; border-radius: 8px; box-shadow: var(--shadow-sm); transition: opacity 1s ease-in-out; }

        /* Footer */
        .app-footer { background-color: var(--bg-footer); color: var(--text-footer); padding: 30px 15px; text-align: center; }
        .footer-content { max-width: 100%; margin: 0 auto; line-height: 1.7; }
        .footer-content p { margin: 5px 0; }
        .footer-content a { color: var(--text-footer); text-decoration: none; transition: color 0.2s; display: inline-flex; align-items: center; gap: 6px; }
        .footer-content a:hover { color: var(--border-accent); }
        .footer-socials { display: flex; justify-content: center; flex-wrap: wrap; gap: 10px 20px; }
        .footer-socials svg { width: 18px; height: 18px; fill: currentColor; }
    </style>
</head>
<body data-theme="light">
    <!-- AUTHENTICATION CONTAINER -->
    <div id="auth-container">
        <div class="auth-box">
            <img src="images/image2.png" alt="Logo" class="auth-logo" onerror="this.style.display='none'">
            <!-- Login View -->
            <div id="login-view">
                <h1>স্টুডেন্ট পোর্টালে স্বাগতম</h1>
                <form id="login-form">
                    <div class="input-group"><input type="tel" id="login-contact" placeholder="আপনার মোবাইল নম্বর" required></div>
                    <div class="input-group">
                        <input type="password" id="login-password" placeholder="আপনার পাসওয়ার্ড" required>
                        <span id="password-toggle" class="password-toggle-icon">👁️</span>
                    </div>
                    <div id="login-profile-confirmation" class="hidden" style="margin-bottom: 20px; animation: fadeIn 0.5s;">
                        <img id="login-profile-pic" src="images/default_avatar.png" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 10px;" onerror="this.onerror=null; this.src='images/default_avatar.png';">
                        <h3 id="login-profile-name" style="margin: 0; font-size: 1.2em;"></h3>
                    </div>
                    <div class="auth-options"><label style="display: flex; align-items: center; gap: 5px; cursor: pointer;"><input type="checkbox" id="remember-me"> আমাকে মনে রাখুন</label></div>
                    <button type="submit" class="auth-button">লগইন করুন</button>
                    <div id="auth-error-msg"></div>
                </form>
                <p class="auth-link">অ্যাকাউন্ট নেই? <a href="#" id="show-signup">এখানে সাইন-আপ করুন</a></p>
            </div>
            <!-- Signup View -->
            <div id="signup-view" class="hidden">
                <h1>অ্যাকাউন্ট তৈরি করুন</h1>
                <form id="signup-form">
                    <div id="step-1" class="signup-step">
                        <p class="step-title">আপনার ব্যাচ শনাক্ত করুন</p>
                        <div class="input-group"><select id="signup-year" required><option value="">শিক্ষাবর্ষ বাছাই করুন</option></select></div>
                        <div class="input-group"><select id="signup-class" required disabled><option value="">ক্লাস বাছাই করুন</option></select></div>
                        <div class="input-group"><select id="signup-batch" required disabled><option value="">ব্যাচ বাছাই করুন</option></select></div>
                        <button type="button" id="btn-next-step-1" class="auth-button">পরবর্তী ধাপ</button>
                    </div>
                    <div id="step-2" class="signup-step hidden">
                        <p class="step-title">কোচিং-এ দেওয়া আপনার মোবাইল নম্বরটি লিখুন</p>
                        <div class="input-group"><input type="tel" id="signup-contact" placeholder="01XXXXXXXXX" required></div>
                        <button type="button" id="btn-next-step-2" class="auth-button">আমার প্রোফাইল খুঁজুন</button>
                    </div>
                    <div id="step-3" class="signup-step hidden">
                        <p class="step-title">আপনার সঠিক প্রোফাইলটি বাছাই করুন</p>
                        <div id="student-selection-list"></div>
                    </div>
                    <div id="step-4" class="signup-step hidden">
                        <p class="step-title">পরিচয় যাচাই করুন</p>
                        <p style="font-size:0.9em;">আপনার সঠিক রোল নম্বরটি বাছাই করুন:</p>
                        <div id="roll-selection" class="roll-selection-grid"></div>
                        <button type="button" id="btn-next-step-4" class="auth-button" style="margin-top: 15px;">পরবর্তী ধাপ</button>
                    </div>
                    <div id="step-5" class="signup-step hidden">
                        <p class="step-title"> চূড়ান্ত যাচাইকরণ</p>
                         <div class="input-group"><input type="text" id="signup-trxid" name="signup-trxid" placeholder="ভর্তি ফি-এর Transaction ID লিখুন" required disabled></div>
                        <button type="button" id="btn-verify" class="auth-button">যাচাই করুন</button>
                    </div>
                    <div id="step-6" class="signup-step hidden">
                        <p class="step-title">নতুন পাসওয়ার্ড সেট করুন</p>
                        <div class="input-group"><input type="password" id="signup-password" name="signup-password" placeholder="নতুন পাসওয়ার্ড" required disabled></div>
                        <div class="input-group"><input type="password" id="signup-confirm-password" name="signup-confirm-password" placeholder="পুনরায় পাসওয়ার্ড দিন" required disabled></div>
                        <div id="password-strength" class="password-strength"></div>
                        <button type="submit" class="auth-button">অ্যাকাউন্ট তৈরি করুন</button>
                    </div>
                </form>
                <div id="signup-error-msg" style="color: var(--due-text); margin-top: 15px; font-weight: bold;"></div>
                <div id="lockout-message" class="hidden"></div>
                <p class="auth-link">ইতিমধ্যে অ্যাকাউন্ট আছে? <a href="#" id="show-login">এখানে লগইন করুন</a></p>
            </div>
            <!-- Footer -->
            <div class="login-footer">
                <p class="copyright-text">&copy; Copyright by Math Creative Teaching Home 2025</p>
                <div class="developer-box">
                    <p class="developed-by-text">Developed by,</p>
                    <div class="company-info">
                        <img src="images/image5.png" alt="Bindumatra IT Logo" class="company-logo" onerror="this.style.display='none'">
                        <div class="company-text">
                            <strong>বিন্দুমাত্রা আইটি</strong><br>
                            <small>CEO : Abdullah Al Rafi (BZS 26)</small>
                        </div>
                    </div>
                    <div class="social-icons">
                         <a href="mailto:rafiofficialpc@gmail.com" title="Email Abdullah Al Rafi" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg></a>
                        <a href="https://www.facebook.com/profile.php?id=61580476801857" title="Facebook Page" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 2.04c-5.5 0-10 4.49-10 10.02 0 5 3.66 9.15 8.44 9.9v-7.02H7.97v-2.89h2.47V9.9c0-2.45 1.44-3.8 3.65-3.8 1.06 0 2.16.19 2.16.19v2.47h-1.27c-1.2 0-1.56.72-1.56 1.5v1.84h2.78l-.45 2.89h-2.33v7.02c4.78-.75 8.44-4.9 8.44-9.9C22 6.53 17.5 2.04 12 2.04z"/></svg></a>
                        <a href="https://wa.me/8801745938158" title="Contact on WhatsApp" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.894 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.886-.001 2.269.655 4.357 1.846 6.167l-1.117 4.082 4.162-1.085zM9.06 7.426c.14-.364.44-1.13.56-1.293.12-.162.28-.192.42-.192.14 0 .28.096.42.364.14.268.56 1.32.62 1.42.06.1.12.18.2.3.08.12.14.24.26.36s.24.22.4.32c.16.1.34.16.5.24.16.08.3.12.42.14.12.02.26 0 .38-.08.12-.08.5-1.25.62-1.47.12-.22.24-.28.4-.28.16 0 .3.04.42.12.12.08.56 1.13.66 1.31.1.18.18.28.2.32.02.04.04.1.02.18s-.08.24-.16.32c-.08.08-.18.1-.28.14s-.2.08-.32.1c-.12.02-.26.02-.4.02s-.68-.08-1.02-.22c-.34-.14-.7-.34-1.08-.62s-.68-.62-.94-.96c-.26-.34-.48-.74-.62-1.18s-.18-.9-.18-1.46c0-.56.08-1.04.22-1.46z"/></svg></a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN APP CONTAINER -->
    <div id="app-container" class="hidden">
        <div id="center-watermark"></div>
        <div id="loader-overlay"><div class="loader"></div></div>
        <div id="toast-container"></div>

        <header>
            <div class="header-left"><span class="institute-name">MCTH Student Portal</span></div>
            <div class="header-right">
                <button id="profile-menu-button" class="profile-menu-button">&#8942;</button>
                <div id="profile-menu" class="profile-menu">
                    <button id="btn-view-profile">👤 প্রোফাইল দেখুন</button>
                    <button id="btn-about-dev">👨‍💻 About Developer</button>
                    <button id="btn-logout">🚪 লগআউট</button>
                </div>
            </div>
        </header>

        <main id="main-content" style="padding-bottom: 70px;"></main>
        
        <nav class="bottom-nav">
             <div class="nav-item" data-page="home"><span class="nav-icon">🏠</span><span class="nav-label">হোম</span></div>
            <div class="nav-item active" data-page="dashboard"><span class="nav-icon">📊</span><span class="nav-label">ড্যাশবোর্ড</span></div>
            <div class="nav-item" data-page="attendance"><span class="nav-icon">📋</span><span class="nav-label">অ্যাটেনডেন্স</span></div>
            <div class="nav-item" data-page="payment"><span class="nav-icon">💳</span><span class="nav-label">পেমেন্ট</span></div>
            <div class="nav-item" data-page="exam"><span class="nav-icon">📝</span><span class="nav-label">পরীক্ষা</span></div>
        </nav>
        
        <footer class="app-footer">
            <div class="footer-content">
                <p>© Math Creative Teaching Home 2025</p>
                <p>Developed by Abdullah Al Rafi</p>
                <div class="footer-socials">
                    <a href="https://wa.me/8801745938158" target="_blank" rel="noopener noreferrer"><svg viewBox="0 0 24 24"><path d="M12.04 2C6.58 2 2.13 6.45 2.13 11.91C2.13 13.66 2.61 15.31 3.48 16.76L2 22L7.43 20.48C8.82 21.3 10.39 21.81 12.04 21.81C17.5 21.81 21.95 17.36 21.95 11.9C21.95 9.27 20.92 6.81 19.05 4.94C17.18 3.07 14.72 2 12.04 2M12.04 3.67C14.25 3.67 16.31 4.53 17.87 6.09C19.42 7.65 20.28 9.71 20.28 11.91C20.28 16.47 16.6 20.15 12.04 20.15C10.56 20.15 9.15 19.71 7.96 18.9L7.54 18.64L3.8 19.77L4.95 16.11L4.68 15.68C3.78 14.43 3.32 12.96 3.32 11.91C3.32 7.35 6.99 3.67 12.04 3.67M16.57 14.45C16.37 14.35 15.28 13.81 15.08 13.73C14.88 13.65 14.73 13.61 14.59 13.86C14.44 14.11 13.99 14.65 13.84 14.8C13.69 14.95 13.54 14.96 13.34 14.86C13.14 14.76 12.28 14.47 11.27 13.59C10.49 12.91 9.96 12.06 9.81 11.81C9.66 11.56 9.79 11.45 9.91 11.33C10.02 11.22 10.16 11.03 10.29 10.88C10.41 10.73 10.46 10.61 10.54 10.43C10.61 10.26 10.56 10.11 10.51 10.01C10.46 9.91 10.03 8.82 9.83 8.32C9.64 7.82 9.44 7.86 9.29 7.85H9.01C8.86 7.85 8.64 7.9 8.44 8.1C8.24 8.3 7.79 8.75 7.79 9.76C7.79 10.77 8.48 11.73 8.58 11.88C8.68 12.03 10.03 14.16 12.11 14.99C12.59 15.18 12.95 15.29 13.25 15.38C13.78 15.53 14.28 15.49 14.68 15.43C15.12 15.36 16.11 14.81 16.31 14.71C16.51 14.61 16.57 14.55 16.57 14.45Z"></path></svg><span>01745938158</span></a>
                    <a href="https://www.facebook.com/abdullahalrafi13" target="_blank" rel="noopener noreferrer"><svg viewBox="0 0 24 24"><path d="M14 13.5h2.5l1-4H14v-2c0-1.03 0-2 2-2h1.5V2.14c-.326-.043-1.557-.14-2.857-.14C11.928 2 10 3.657 10 6.7v2.8H7v4h3V22h4v-8.5z"></path></svg><span>abdullahalrafi13</span></a>
                </div>
            </div>
        </footer>
    </div>

    <!-- HTML TEMPLATES -->
    <template id="template-home">
        <div class="page-section">
            <div class="adikothon"><h3>কিছু কথা:</h3><p>গণিত ক্রিয়েটিভ টিচিং হোম' একটি শিক্ষা সহায়ক প্রতিষ্ঠান। স্বচ্ছতা ও জবাবদিহিতার আলোকে একটি বিবেক সৃষ্টির লক্ষ্যে 'গণিত ক্রিয়েটিভ টিচিং হোম" সকল শিক্ষা কার্যক্রম পরিচালনা করছে।</p><p>'সবার জন্য শিক্ষা' এই স্লোগানকে সামনে রেখে 'গণিত ক্রিয়েটিভ টিচিং হোম' তার অবস্থান থেকে কিছু মানুষের শিক্ষা অর্জন নিশ্চিত করার লক্ষ্যে বিভিন্ন পদক্ষেপের মাধ্যমে শিক্ষার্থীদেরকে পড়াশোনামুখী করার বাস্তব পদক্ষেপ গ্রহণ করেছে।</p></div>
        </div>
        <div class="page-section"><img id="homeImageSlider" src="images/image3.png" alt="Promotional Image" onerror="this.style.display='none'"></div>
    </template>

    <template id="template-dashboard">
        <div class="page-section">
            <h2 id="dashboard-welcome" style="font-size: 1.5em; color: var(--text-primary);"></h2>
            <p style="color: var(--text-secondary);">আপনার প্রোফাইল, উপস্থিতি এবং পেমেন্টের সারসংক্ষেপ দেখুন।</p>
        </div>
        <div id="dashboard-summary-cards" style="display: grid; gap: 15px;"></div>
    </template>

    <template id="template-profile">
        <div class="page-section" style="text-align: center;">
            <img id="profile-page-pic" src="images/default_avatar.png" style="width: 150px; height: 150px; border-radius: 50%; border: 4px solid var(--border-color); object-fit: cover; box-shadow: var(--shadow-md);" alt="Profile" onerror="this.onerror=null; this.src='images/default_avatar.png';">
            <h2 id="profile-page-name" style="margin-top: 15px; font-size: 1.8em;"></h2>
            <p style="background-color: var(--bg-hover); padding: 5px 10px; border-radius: 20px; display: inline-block; font-size: 0.9em;"><strong>Student ID:</strong> <span id="profile-student-id"></span></p>
        </div>
        <div class="page-section">
            <h4><span style="margin-right: 8px;">ℹ️</span>সাধারণ তথ্য</h4>
            <div style="display: grid; gap: 10px; margin-top: 10px;">
                <p style="margin: 0;"><strong>রোল:</strong> <span id="profile-roll"></span></p>
                <p style="margin: 0;"><strong>ক্লাস:</strong> <span id="profile-class"></span></p>
                <p style="margin: 0;"><strong>স্কুল:</strong> <span id="profile-school"></span></p>
                <p style="margin: 0;"><strong>মোবাইল নম্বর:</strong> <span id="profile-contact"></span></p>
                <p style="margin: 0;"><strong>ভর্তির তারিখ:</strong> <span id="profile-admission-date"></span></p>
                <p style="margin: 0;"><strong>শিক্ষাবর্ষ:</strong> <span id="profile-academic-year"></span></p>
            </div>
        </div>
         <div class="page-section">
            <h4><span style="margin-right: 8px;">📅</span>আমার ব্যাচসমূহ</h4>
            <div id="profile-batches" style="margin-top: 10px;"></div>
        </div>
    </template>

    <template id="template-attendance">
        <div class="page-section">
            <h2 style="font-size: 1.5em; color: var(--text-primary);">আমার অ্যাটেনডেন্স</h2>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;">
                <div class="stat-item present"><div class="label">উপস্থিতি %</div><div class="value" id="stat-student-percentage">-%</div></div>
                <div class="stat-item absent"><div class="label">অনুপস্থিতি %</div><div class="value" id="stat-student-absent-percentage">-%</div></div>
                <div class="stat-item present"><div class="label">উপস্থিত</div><div class="value" id="stat-student-present">0</div></div>
                <div class="stat-item absent"><div class="label">অনুপস্থিত</div><div class="value" id="stat-student-absent">0</div></div>
            </div>
        </div>
        <div class="page-section">
            <h3>মাসিক ক্যালেন্ডার</h3>
            <div class="calendar-header" style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <button id="prevMonthBtn" style="background:none; border:none; font-size:1.5em; cursor:pointer;">&lt;</button>
                <h4 id="calendarMonthYear" style="margin:0;"></h4>
                <button id="nextMonthBtn" style="background:none; border:none; font-size:1.5em; cursor:pointer;">&gt;</button>
            </div>
            <div class="calendar-grid day-names">
                <div>রবি</div><div>সোম</div><div>মঙ্গল</div><div>বুধ</div><div>বৃহঃ</div><div>শুক্র</div><div>শনি</div>
            </div>
            <div id="calendar-days" class="calendar-grid"></div>
        </div>
        <div class="page-section">
            <h3>উপস্থিতি চার্ট</h3>
            <canvas id="personalAttendanceChart"></canvas>
        </div>
    </template>
    
    <template id="template-payment">
        <div class="page-section">
            <h2 style="font-size: 1.5em; color: var(--text-primary);">আমার পেমেন্ট হিস্টোরি</h2>
            <div id="due-summary-box" class="page-section" style="background-color: var(--due-color); color: var(--due-text); margin-top: 15px;"></div>
        </div>
        <div class="page-section">
            <h4>মাসিক ফি স্ট্যাটাস (<span id="payment-year"></span>)</h4>
            <div id="yearly-payment-chart" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 8px; margin-top:10px;"></div>
        </div>
        <div class="page-section">
            <h4>লেনদেনের তালিকা</h4>
            <div style="overflow-x: auto;">
                <table class="history-table">
                    <thead><tr><th>তারিখ</th><th>বিবরণ</th><th>টাকা</th><th>Trx ID</th></tr></thead>
                    <tbody id="payment-history-table"></tbody>
                </table>
            </div>
        </div>
    </template>
    
    <template id="template-exam">
        <div class="page-section">
             <h2 style="font-size: 1.5em; color: var(--text-primary);">আমার পরীক্ষার ফলাফল</h2>
             <p style="color: var(--text-secondary);">আপনার সকল পরীক্ষার ফলাফল নিচে দেওয়া হলো।</p>
        </div>
        <div id="exam-list-container" style="display: grid; gap: 15px;"></div>
        <div class="page-section" id="exam-chart-container" style="display: none;">
            <h3>পারফরম্যান্স গ্রাফ</h3>
            <canvas id="examPerformanceChart"></canvas>
        </div>
    </template>
    
    <template id="template-about-dev-modal">
        <div id="aboutDeveloperModal" class="modal-overlay">
            <div class="modal-content" style="max-width: 95%; padding: 15px;">
                <div class="modal-header">
                    <h2>About the Developer</h2>
                    <button style="background:none; border:none; font-size: 1.5em; cursor:pointer; color: var(--text-secondary);" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                </div>
                <div style="padding:0;">
                    <img src="images/Abdullah-Al-Rafi-Digital-Card.png" alt="Developer Digital Card" style="width: 100%; height: auto; border-radius: 8px; display: block;" onerror="this.alt='Image not found.';">
                </div>
            </div>
        </div>
    </template>

<script>
// ================================================================== //
//            FIREBASE CONFIGURATION AND INITIALIZATION             //
// ================================================================== //
const firebaseConfig = {
    apiKey: "AIzaSyBE0xJ1nvqSj6a9bXtrtrNTDh0bu7PMLnw",
    authDomain: "math-creative-teaching-h-a86fd.firebaseapp.com",
    projectId: "math-creative-teaching-h-a86fd",
    storageBucket: "math-creative-teaching-h-a86fd.appspot.com",
    messagingSenderId: "547365102808",
    appId: "1:547365102808:web:45c46b74ffaaa945dda3ad",
    databaseURL: "https://math-creative-teaching-h-a86fd-default-rtdb.asia-southeast1.firebasedatabase.app"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const studentAuthRef = db.ref('studentAuth');
const academicYearsRef = db.ref('academicYears');

// ================================================================== //
//                GLOBAL UTILITY FUNCTIONS                          //
// ================================================================== //
function showToast(message, type = 'info', duration = 3000) { const c = document.getElementById('toast-container'); if (!c) return; const t = document.createElement('div'); t.className = `toast ${type}`; t.textContent = message; c.appendChild(t); setTimeout(() => t.classList.add('show'), 10); setTimeout(() => { t.classList.remove('show'); t.addEventListener('transitionend', () => t.remove()); }, duration); }
const showLoader = () => document.getElementById('loader-overlay').style.display = 'flex';
const hideLoader = () => document.getElementById('loader-overlay').style.display = 'none';
function applyTheme(theme) { document.body.setAttribute('data-theme', theme); }
const BENGALI_MONTHS=["জানুয়ারি","ফেব্রুয়ারি","মার্চ","এপ্রিল","মে","জুন","জুলাই","আগস্ট","সেপ্টেম্বর","অক্টোবর","নভেম্বর","ডিসেম্বর"];

// ================================================================== //
//              AUTHENTICATION & SIGNUP SCRIPT                      //
// ================================================================== //
document.addEventListener('DOMContentLoaded', () => {
    const authContainer = document.getElementById('auth-container');
    const appContainer = document.getElementById('app-container');
    
    const loggedInStudent = sessionStorage.getItem('mcth_student_session');
    if (loggedInStudent) {
        authContainer.classList.add('hidden');
        appContainer.classList.remove('hidden');
        firebase.auth().signInAnonymously().then(() => {
            initializeAppLogic(JSON.parse(loggedInStudent));
        }).catch(err => {
            console.error("Firebase sign-in failed on session restore:", err);
            sessionStorage.removeItem('mcth_student_session');
            location.reload();
        });
        return;
    }

    const loginView = document.getElementById('login-view');
    const signupView = document.getElementById('signup-view');
    const loginForm = document.getElementById('login-form');
    const signupForm = document.getElementById('signup-form');
    const errorMsgDiv = document.getElementById('auth-error-msg');
    
    document.getElementById('show-signup').addEventListener('click', (e) => { e.preventDefault(); loginView.classList.add('hidden'); signupView.classList.remove('hidden'); });
    document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); signupView.classList.add('hidden'); loginView.classList.remove('hidden'); });

    // --- Login Logic ---
    const passwordToggle = document.getElementById('password-toggle');
    passwordToggle.addEventListener('click', () => {
        const passwordInput = document.getElementById('login-password');
        const isPassword = passwordInput.type === 'password';
        passwordInput.type = isPassword ? 'text' : 'password';
        passwordToggle.textContent = isPassword ? '🙈' : '👁️';
    });

    let loginAttemptStudentData = null;
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const contact = document.getElementById('login-contact').value.trim();
        const password = document.getElementById('login-password').value;
        const profileConfirmDiv = document.getElementById('login-profile-confirmation');
        
        if (!profileConfirmDiv.classList.contains('hidden') && loginAttemptStudentData) {
            sessionStorage.setItem('mcth_student_session', JSON.stringify(loginAttemptStudentData));
            authContainer.classList.add('hidden');
            appContainer.classList.remove('hidden');
            initializeAppLogic(loginAttemptStudentData);
            return;
        }

        errorMsgDiv.textContent = '';
        showLoader();

        try {
            await firebase.auth().signInAnonymously();
            const snapshot = await studentAuthRef.orderByChild('contact').equalTo(contact).once('value');

            if (!snapshot.exists()) {
                errorMsgDiv.textContent = 'এই মোবাইল নম্বর দিয়ে কোনো অ্যাকাউন্ট নেই।';
                return;
            }

            const studentAuthData = Object.values(snapshot.val())[0];
            if (studentAuthData.password === password) {
                const yearSnapshot = await academicYearsRef.child(studentAuthData.academicYear).child('data').once('value');
                if(!yearSnapshot.exists()){
                    errorMsgDiv.textContent = 'ছাত্রের তথ্য খুঁজে পাওয়া যায়নি।';
                    return;
                }
                const allStudentsInYear = yearSnapshot.val().students || [];
                const studentProfile = allStudentsInYear.find(s => s && s.id === studentAuthData.studentId);
                
                if (!studentProfile) {
                     errorMsgDiv.textContent = 'ছাত্রের প্রোফাইল খুঁজে পাওয়া যায়নি। অফিসে যোগাযোগ করুন।';
                     return;
                }

                loginAttemptStudentData = { ...studentProfile, academicYear: studentAuthData.academicYear };
                
                const profilePic = document.getElementById('login-profile-pic');
                profilePic.src = loginAttemptStudentData.photoURL || 'images/default_avatar.png';
                profilePic.onerror = () => { profilePic.onerror = null; profilePic.src = 'images/default_avatar.png'; };
                document.getElementById('login-profile-name').textContent = `স্বাগতম, ${loginAttemptStudentData.name}`;
                profileConfirmDiv.classList.remove('hidden');
                document.querySelector('#login-form button[type="submit"]').textContent = 'প্রবেশ করুন';
                
            } else {
                errorMsgDiv.textContent = 'পাসওয়ার্ড সঠিক নয়।';
            }
        } catch (error) { console.error("Login error:", error); errorMsgDiv.textContent = 'লগইন করার সময় একটি সমস্যা হয়েছে।'; } 
        finally { hideLoader(); }
    });


    // --- Signup Logic ---
    let signupData = { allYearsData: {}, potentialStudents: [], selectedStudent: null, lockoutData: JSON.parse(localStorage.getItem('mcth_signup_lockout') || '{}') };
    const signupErrorDiv = document.getElementById('signup-error-msg');
    const lockoutMsgDiv = document.getElementById('lockout-message');

    function checkLockout() {
        if (signupData.lockoutData.until && Date.now() < signupData.lockoutData.until) {
            document.querySelectorAll('#signup-form button, #signup-form input, #signup-form select').forEach(el => el.disabled = true);
            const countdownSpan = document.createElement('span');
            lockoutMsgDiv.innerHTML = 'অনেকবার ভুল চেষ্টার কারণে আপনি ব্লকড আছেন। আবার চেষ্টা করুন: ';
            lockoutMsgDiv.appendChild(countdownSpan);
            
            const countdownInterval = setInterval(() => {
                const timeLeft = Math.ceil((signupData.lockoutData.until - Date.now()) / 1000);
                if (timeLeft <= 0) { clearInterval(countdownInterval); localStorage.removeItem('mcth_signup_lockout'); location.reload(); }
                countdownSpan.textContent = `${Math.floor(timeLeft / 60)} মিনিট ${timeLeft % 60} সেকেন্ড`;
            }, 1000);
            lockoutMsgDiv.classList.remove('hidden');
            return true;
        }
        return false;
    }
    
    function handleFailedAttempt() {
        const attempts = (signupData.lockoutData.attempts || 0) + 1;
        const lockoutDurations = [15, 35, 60, 120];
        let lockoutUntil = null;

        if (attempts > lockoutDurations.length) {
            lockoutUntil = Date.now() + 365 * 24 * 60 * 60 * 1000;
            signupErrorDiv.textContent = 'আপনার ডিভাইসটি স্থায়ীভাবে ব্লক করা হয়েছে। অফিসে যোগাযোগ করুন।';
        } else {
            lockoutUntil = Date.now() + (lockoutDurations[attempts - 1] * 60 * 1000);
            signupErrorDiv.textContent = 'আপনার দেওয়া তথ্যে ভুল রয়েছে।';
        }
        
        signupData.lockoutData = { attempts, until: lockoutUntil };
        localStorage.setItem('mcth_signup_lockout', JSON.stringify(signupData.lockoutData));
        checkLockout();
    }
    
    if (checkLockout()) return;

    const setStepInputsDisabled = (step, isDisabled) => {
        document.querySelectorAll(`#step-${step} input, #step-${step} select`).forEach(el => el.disabled = isDisabled);
    };

    async function initializeSignupSelectors() {
        showLoader();
        const yearsSnapshot = await academicYearsRef.once('value');
        if (!yearsSnapshot.exists()) { signupErrorDiv.textContent = "কোনো শিক্ষাবর্ষের তথ্য পাওয়া যায়নি।"; hideLoader(); return; }
        signupData.allYearsData = yearsSnapshot.val();

        const yearSelect = document.getElementById('signup-year');
        const classSelect = document.getElementById('signup-class');
        const batchSelect = document.getElementById('signup-batch');
        
        yearSelect.innerHTML = '<option value="">শিক্ষাবর্ষ বাছাই করুন</option>';
        Object.keys(signupData.allYearsData).sort((a,b) => b-a).forEach(year => yearSelect.add(new Option(year, year)));

        yearSelect.addEventListener('change', () => {
            classSelect.innerHTML = '<option value="">ক্লাস বাছাই করুন</option>';
            batchSelect.innerHTML = '<option value="">ব্যাচ বাছাই করুন</option>';
            classSelect.disabled = true;
            batchSelect.disabled = true;
            const selectedYear = yearSelect.value;
            if (!selectedYear) return;

            const classes = signupData.allYearsData[selectedYear].data?.mainClassCategories || [];
            classes.forEach(cls => { if (!cls.deletedAt) classSelect.add(new Option(cls.name, cls.id)); });
            if (classSelect.options.length > 1) classSelect.disabled = false;
        });

        classSelect.addEventListener('change', () => {
            batchSelect.innerHTML = '<option value="">ব্যাচ বাছাই করুন</option>';
            batchSelect.disabled = true;
            const selectedYear = yearSelect.value;
            const selectedClassId = classSelect.value;
            if (!selectedYear || !selectedClassId) return;

            const batches = signupData.allYearsData[selectedYear].data?.batchSchedule || [];
            batches.forEach(day => {
                (day.classes || []).forEach(cls => {
                    if (cls.classId === selectedClassId && !cls.deletedAt) {
                        (cls.batches || []).forEach(batch => {
                            if (!batch.deletedAt) batchSelect.add(new Option(`${day.dayName} (${batch.time})`, batch.id));
                        });
                    }
                });
            });
            if (batchSelect.options.length > 1) batchSelect.disabled = false;
        });
        hideLoader();
    }
    initializeSignupSelectors();

    document.getElementById('btn-next-step-1').addEventListener('click', () => {
        if (!document.getElementById('signup-year').value || !document.getElementById('signup-class').value || !document.getElementById('signup-batch').value) {
            signupErrorDiv.textContent = 'অনুগ্রহ করে সব তথ্য পূরণ করুন।'; return;
        }
        signupErrorDiv.textContent = '';
        document.getElementById('step-1').classList.add('hidden');
        document.getElementById('step-2').classList.remove('hidden');
    });

    document.getElementById('btn-next-step-2').addEventListener('click', async () => {
        const selectedYear = document.getElementById('signup-year').value;
        const selectedBatchId = document.getElementById('signup-batch').value;
        const contact = document.getElementById('signup-contact').value.trim();
        
        if (!contact) { signupErrorDiv.textContent = 'মোবাইল নম্বর দিন।'; return; }
        showLoader();
        signupErrorDiv.textContent = '';
        
        try {
            await firebase.auth().signInAnonymously();
            const yearData = signupData.allYearsData[selectedYear]?.data;
            if (!yearData) throw new Error("Year data not found");
            
            const batchInfo = (yearData.batchSchedule || []).flatMap(d => d.classes || []).flatMap(c => c.batches || []).find(b => b.id === selectedBatchId);
            
            if (!batchInfo || !batchInfo.studentIds) {
                 signupErrorDiv.textContent = 'এই ব্যাচে কোনো ছাত্র পাওয়া যায়নি।'; hideLoader(); return;
            }

            const studentIdsInBatch = batchInfo.studentIds;
            const allStudentsInYear = yearData.students || [];
            const potentialStudents = studentIdsInBatch
                .map(id => allStudentsInYear.find(s => s && s.id === id && s.parentContact === contact && !s.deletedAt))
                .filter(Boolean);

            if (potentialStudents.length === 0) {
                signupErrorDiv.textContent = 'এই ব্যাচে আপনার দেওয়া মোবাইল নম্বরটি পাওয়া যায়নি।'; hideLoader(); return;
            }
            
            signupData.potentialStudents = await Promise.all(potentialStudents.map(async student => {
                 const authCheck = await studentAuthRef.child(student.id).once('value');
                 return authCheck.exists() ? null : { ...student, academicYear: selectedYear };
            }));
            signupData.potentialStudents = signupData.potentialStudents.filter(Boolean);

            if (signupData.potentialStudents.length === 0) {
                 signupErrorDiv.textContent = 'আপনার দেওয়া তথ্যের ভিত্তিতে সকল ছাত্রের অ্যাকাউন্ট ইতিমধ্যে তৈরি করা আছে।'; hideLoader(); return;
            }
            
            displayStudentMatches(signupData.potentialStudents);
            document.getElementById('step-2').classList.add('hidden');
            document.getElementById('step-3').classList.remove('hidden');

        } catch (error) { console.error("Signup step 2 error:", error); signupErrorDiv.textContent = 'প্রোফাইল খুঁজতে গিয়ে সমস্যা হয়েছে।'; } 
        finally { hideLoader(); }
    });

    function displayStudentMatches(students) {
        const listContainer = document.getElementById('student-selection-list');
        listContainer.innerHTML = '';
        students.forEach((student, index) => {
            const item = document.createElement('div');
            item.className = 'student-item';
            const maskedContact = student.parentContact.length > 2 ? student.parentContact.slice(0, -2).replace(/./g, '*') + student.parentContact.slice(-2) : student.parentContact;
            item.innerHTML = `<strong>${student.name}</strong><span>মোবাইল: ${maskedContact}</span>`;
            item.addEventListener('click', () => {
                signupData.selectedStudent = students[index];
                populateRollPuzzle(signupData.selectedStudent);
                document.getElementById('step-3').classList.add('hidden');
                document.getElementById('step-4').classList.remove('hidden');
            });
            listContainer.appendChild(item);
        });
    }
    
    function populateRollPuzzle(student) {
        const rollContainer = document.querySelector('#step-4 #roll-selection');
        rollContainer.innerHTML = '';
        const correctRoll = student.roll;
        const rollOptions = new Set([correctRoll]);
        while (rollOptions.size < 8) {
            const randomOffset = Math.floor(Math.random() * 20) - 10;
            const fakeRoll = String(parseInt(correctRoll, 10) + randomOffset);
            if(fakeRoll !== correctRoll && parseInt(fakeRoll, 10) > 0) rollOptions.add(fakeRoll);
        }
        const shuffledRolls = Array.from(rollOptions).sort(() => Math.random() - 0.5);
        shuffledRolls.forEach(roll => {
            const box = document.createElement('div');
            box.className = 'roll-box';
            box.textContent = roll;
            box.dataset.roll = roll;
            box.addEventListener('click', () => {
                document.querySelectorAll('#step-4 .roll-box').forEach(b => b.classList.remove('selected'));
                box.classList.add('selected');
            });
            rollContainer.appendChild(box);
        });
    }

    document.getElementById('btn-next-step-4').addEventListener('click', () => {
        const selectedRoll = document.querySelector('#step-4 .roll-box.selected')?.dataset.roll;
        if (!selectedRoll) {
            signupErrorDiv.textContent = 'অনুগ্রহ করে আপনার রোল নম্বর বাছাই করুন।'; return;
        }
        if (selectedRoll === signupData.selectedStudent.roll) {
            signupErrorDiv.textContent = '';
            document.getElementById('step-4').classList.add('hidden');
            document.getElementById('step-5').classList.remove('hidden');
            setStepInputsDisabled(5, false); // Enable inputs for step 5
        } else {
            handleFailedAttempt();
        }
    });

    document.getElementById('btn-verify').addEventListener('click', () => {
        const student = signupData.selectedStudent;
        const enteredTrxId = document.getElementById('signup-trxid').value.trim();

        if (student && student.admissionFee?.status === 'paid' && student.admissionFee.token === enteredTrxId) {
            signupErrorDiv.textContent = '';
            localStorage.removeItem('mcth_signup_lockout');
            showToast('যাচাই সফল হয়েছে! অনুগ্রহ করে পাসওয়ার্ড সেট করুন।', 'success');
            document.getElementById('step-5').classList.add('hidden');
            document.getElementById('step-6').classList.remove('hidden');
            setStepInputsDisabled(6, false); // Enable inputs for step 6
        } else {
            handleFailedAttempt();
        }
    });

    signupForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const password = document.getElementById('signup-password').value;
        const confirmPassword = document.getElementById('signup-confirm-password').value;
        const strengthDiv = document.getElementById('password-strength');

        if(password.length < 8) { strengthDiv.textContent = 'পাসওয়ার্ড কমপক্ষে ৮ অক্ষরের হতে হবে।'; strengthDiv.style.color = 'red'; return; }
        if(!/[A-Z]/.test(password) || !/[a-z]/.test(password) || !/[0-9]/.test(password)) { strengthDiv.textContent = 'বড় হাতের অক্ষর, ছোট হাতের অক্ষর এবং সংখ্যা ব্যবহার করুন।'; strengthDiv.style.color = 'red'; return; }
        if (password !== confirmPassword) { strengthDiv.textContent = 'পাসওয়ার্ড দুটি মিলেনি।'; strengthDiv.style.color = 'red'; return; }
        
        strengthDiv.textContent = '';
        showLoader();

        try {
            const student = signupData.selectedStudent;
            const newAuthData = { studentId: student.id, contact: student.parentContact, academicYear: student.academicYear, password: password };
            await studentAuthRef.child(student.id).set(newAuthData);
            
            const sessionData = { ...student, academicYear: student.academicYear };
            sessionStorage.setItem('mcth_student_session', JSON.stringify(sessionData));
            
            authContainer.classList.add('hidden');
            appContainer.classList.remove('hidden');
            initializeAppLogic(sessionData);

        } catch (error) { console.error("Account creation error:", error); signupErrorDiv.textContent = 'অ্যাকাউন্ট তৈরি করার সময় সমস্যা হয়েছে।'; } 
        finally { hideLoader(); }
    });

    applyTheme(localStorage.getItem('mcth_student_theme') || 'light');
});


// ================================================================== //
//                  MAIN APP LOGIC AFTER LOGIN                      //
// ================================================================== //
function initializeAppLogic(studentData) {
    let currentPage = 'dashboard';
    let fullAcademicData = {};
    let examDataCache = null;
    let lastExamDataFetch = null;
    let personalAttendanceChart = null;

    const mainContent = document.getElementById('main-content');
    const navItems = document.querySelectorAll('.nav-item');
    const profileMenuButton = document.getElementById('profile-menu-button');
    const profileMenu = document.getElementById('profile-menu');
    
    // History API for back button
    window.history.replaceState({ page: 'dashboard' }, '', '#dashboard');
    window.onpopstate = (event) => {
        if (event.state && event.state.page) {
            renderPage(event.state.page, false); // false to not push new state
        }
    };

    // --- Initial Data Load ---
    async function loadInitialData() {
        showLoader();
        try {
            const snapshot = await academicYearsRef.child(studentData.academicYear).child('data').once('value');
            fullAcademicData = snapshot.val() || {};
            // Load the dashboard by default
            renderPage(currentPage);
        } catch (error) {
            console.error("Failed to load academic data:", error);
            showToast("আপনার তথ্য লোড করা সম্ভব হয়নি।", "error");
        } finally {
            hideLoader();
        }
    }
    
    // --- Page Rendering Engine ---
    function renderPage(pageName, pushState = true) {
        mainContent.innerHTML = '';
        const template = document.getElementById(`template-${pageName}`);
        if (template) {
            mainContent.appendChild(template.content.cloneNode(true));
            // Call the specific function to populate the page
            switch (pageName) {
                case 'home': renderHome(); break;
                case 'dashboard': renderDashboard(); break;
                case 'profile': renderProfile(); break;
                case 'attendance': renderAttendance(); break;
                case 'payment': renderPayment(); break;
                case 'exam': renderExam(); break;
            }
        } else {
            mainContent.innerHTML = `<p>Error: Page not found.</p>`;
        }
        
        // Update active nav item
        navItems.forEach(item => {
            item.classList.toggle('active', item.dataset.page === pageName);
        });
        currentPage = pageName;
        if(pushState && window.location.hash !== `#${pageName}`) {
            window.history.pushState({ page: pageName }, '', `#${pageName}`);
        }
    }

    // --- Specific Page Renderers ---
    function renderHome() {
        let sliderInterval;
        const slider = document.getElementById('homeImageSlider');
        if (slider) {
            let currentImage = 3;
            sliderInterval = setInterval(() => {
                slider.style.opacity = 0;
                setTimeout(() => {
                    currentImage = currentImage === 3 ? 4 : 3;
                    slider.src = `images/image${currentImage}.png`;
                    slider.style.opacity = 1;
                }, 1000);
            }, 4000);
        }
    }

    function renderDashboard() {
        document.getElementById('dashboard-welcome').textContent = `স্বাগতম, ${studentData.name}`;
        
        const summaryContainer = document.getElementById('dashboard-summary-cards');
        const presentDays = (Object.values(fullAcademicData.attendance?.records || {}).flatMap(Object.values).filter(br => br[studentData.id]?.status === 'present')).length;
        const totalDue = calculateStudentOutstandingAmount();
        const currentMonth = BENGALI_MONTHS[new Date().getMonth()];
        const currentMonthPayment = studentData.monthlyPayments?.[currentMonth];
        let currentMonthStatus = 'বকেয়া';
        if (currentMonthPayment?.status === 'paid') {
            currentMonthStatus = 'পরিশোধিত';
        }

        summaryContainer.innerHTML = `
            <div class="stat-item present"><div class="label">মোট উপস্থিতি</div><div class="value">${presentDays} দিন</div></div>
            <div class="stat-item absent"><div class="label">মোট বকেয়া</div><div class="value">${totalDue.toLocaleString('bn-BD')} ৳</div></div>
            <div class="stat-item" style="border-left-color: var(--warning-color);"><div class="label">${currentMonth} মাসের ফি</div><div class="value" style="color: var(--warning-color);">${currentMonthStatus}</div></div>
        `;
    }

    function renderProfile() {
        document.getElementById('profile-page-pic').src = studentData.photoURL || 'images/default_avatar.png';
        document.getElementById('profile-page-pic').onerror = () => { document.getElementById('profile-page-pic').src = 'images/default_avatar.png' };
        document.getElementById('profile-page-name').textContent = studentData.name;
        document.getElementById('profile-student-id').textContent = studentData.id;
        document.getElementById('profile-roll').textContent = studentData.roll;
        const classInfo = fullAcademicData.mainClassCategories?.find(c => c.id === studentData.classId);
        document.getElementById('profile-class').textContent = classInfo?.name || 'N/A';
        document.getElementById('profile-school').textContent = studentData.schoolName || 'N/A';
        document.getElementById('profile-contact').textContent = studentData.parentContact || 'N/A';
        document.getElementById('profile-admission-date').textContent = new Date(studentData.createdAt).toLocaleDateString('bn-BD');
        document.getElementById('profile-academic-year').textContent = studentData.academicYear;

        const batchesDiv = document.getElementById('profile-batches');
        const studentBatches = (fullAcademicData.batchSchedule || []).flatMap(day => (day.classes || []).flatMap(cls => (cls.batches || []).filter(batch => (batch.studentIds || []).includes(studentData.id)).map(b => `<li style="background-color: var(--bg-hover); padding: 8px; border-radius: 4px;">${day.dayName} (${b.time})</li>`)));
        if (studentBatches.length > 0) {
            batchesDiv.innerHTML = `<ul style="list-style: none; padding: 0; display: grid; gap: 8px;">${studentBatches.join('')}</ul>`;
        } else {
            batchesDiv.textContent = "কোনো ব্যাচে যুক্ত নেই।";
        }
    }

    function renderAttendance() {
        const attendanceRecords = fullAcademicData.attendance?.records || {};
        let presentCount = 0, absentCount = 0;
        const studentAttendance = {}; 

        for (const date in attendanceRecords) {
            for (const batchId in attendanceRecords[date]) {
                if (attendanceRecords[date][batchId][studentData.id]) {
                    const status = attendanceRecords[date][batchId][studentData.id].status;
                    studentAttendance[date] = status;
                    if (status === 'present') presentCount++;
                    else if (status === 'absent') absentCount++;
                }
            }
        }
        
        const totalClasses = presentCount + absentCount;
        const percentage = totalClasses > 0 ? ((presentCount / totalClasses) * 100).toFixed(1) : 0;
        const absentPercentage = totalClasses > 0 ? ((absentCount / totalClasses) * 100).toFixed(1) : 0;
        document.getElementById('stat-student-present').textContent = presentCount;
        document.getElementById('stat-student-absent').textContent = absentCount;
        document.getElementById('stat-student-percentage').textContent = `${percentage}%`;
        document.getElementById('stat-student-absent-percentage').textContent = `${absentPercentage}%`;

        let currentDate = new Date();
        const renderCalendar = (date) => {
            const month = date.getMonth(), year = date.getFullYear();
            document.getElementById('calendarMonthYear').textContent = date.toLocaleDateString('bn-BD', { month: 'long', year: 'numeric' });
            const calendarDays = document.getElementById('calendar-days');
            calendarDays.innerHTML = '';
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let i = 0; i < firstDayOfMonth; i++) calendarDays.innerHTML += `<div></div>`;
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                let dayClass = '';
                const status = studentAttendance[dateStr];
                if (status === 'present') dayClass = 'day-present'; else if (status === 'absent') dayClass = 'day-absent';
                calendarDays.innerHTML += `<div class="calendar-day ${dayClass}">${day}</div>`;
            }
        };
        document.getElementById('prevMonthBtn').onclick = () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(currentDate); };
        document.getElementById('nextMonthBtn').onclick = () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(currentDate); };
        renderCalendar(currentDate);

        if(personalAttendanceChart) personalAttendanceChart.destroy();
        personalAttendanceChart = new Chart(document.getElementById('personalAttendanceChart'), {
            type: 'doughnut',
            data: {
                labels: ['উপস্থিত', 'অনুপস্থিত'],
                datasets: [{ data: [presentCount, absentCount], backgroundColor: ['var(--success-color)', 'var(--danger-color)'], borderColor: 'var(--bg-section)', borderWidth: 4 }]
            },
            options: { responsive: true, plugins: { legend: { position: 'top', labels: { color: document.body.getAttribute('data-theme') === 'dark' ? 'white' : 'black' } } } }
        });
    }

    function renderPayment() {
        document.getElementById('payment-year').textContent = studentData.academicYear;
        const chartContainer = document.getElementById('yearly-payment-chart');
        const tableBody = document.getElementById('payment-history-table');
        const dueSummaryBox = document.getElementById('due-summary-box');
        chartContainer.innerHTML = '';
        tableBody.innerHTML = '';
        let allPayments = [];

        const totalDue = calculateStudentOutstandingAmount();
        const overdueMonths = calculateOverdueMonths();
        if (totalDue > 0) {
            dueSummaryBox.innerHTML = `<h4>বকেয়া সামারি</h4><p>আপনার মোট <strong>${totalDue.toLocaleString('bn-BD')} টাকা</strong> বকেয়া রয়েছে।</p><p><small>বকেয়া মাসসমূহ: ${overdueMonths}</small></p>`;
            dueSummaryBox.style.display = 'block';
        } else {
            dueSummaryBox.style.display = 'none';
        }

        BENGALI_MONTHS.forEach((month, index) => {
            const payment = studentData.monthlyPayments?.[month];
            const box = document.createElement('div');
            box.className = 'payment-status-box';
            let status = 'future';
            if (payment?.status === 'paid') status = 'paid';
            else if (new Date(studentData.academicYear, index, 1) < new Date()) status = 'due';
            box.classList.add(status);
            box.textContent = month;
            chartContainer.appendChild(box);
        });

        if(studentData.admissionFee?.status === 'paid') allPayments.push({ date: new Date(studentData.admissionFee.date), description: 'ভর্তি ফি', amount: studentData.admissionFee.amount, token: studentData.admissionFee.token });
        Object.entries(studentData.monthlyPayments || {}).forEach(([month, payment]) => { if(payment.status === 'paid') allPayments.push({ date: new Date(payment.date), description: `${month} মাসের ফি`, amount: payment.fee, token: payment.token }); });
        
        allPayments.sort((a, b) => b.date - a.date);
        if (allPayments.length === 0) tableBody.innerHTML = `<tr><td colspan="4" style="text-align:center;">কোনো লেনদেনের তথ্য নেই।</td></tr>`;
        else allPayments.forEach(p => tableBody.innerHTML += `<tr><td>${p.date.toLocaleDateString('bn-BD')}</td><td>${p.description}</td><td>${p.amount.toLocaleString('bn-BD')} ৳</td><td>${p.token || 'N/A'}</td></tr>`);
    }

    async function renderExam() {
        const container = document.getElementById('exam-list-container');
        const chartContainer = document.getElementById('exam-chart-container');
        container.innerHTML = '<div class="page-section"><p style="text-align:center;">ফলাফল লোড হচ্ছে...</p></div>';

        const now = new Date();
        const lastFetchTime = lastExamDataFetch ? new Date(lastExamDataFetch) : null;
        let shouldRefresh = true;

        if(lastFetchTime) {
            const today3AM = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 3, 0, 0);
            if (now < today3AM && lastFetchTime >= new Date(today3AM.getTime() - 24 * 60 * 60 * 1000)) { shouldRefresh = false; } 
            else if (now >= today3AM && lastFetchTime >= today3AM) { shouldRefresh = false; }
        }
        
        if (shouldRefresh || !examDataCache) {
            try {
                const snapshot = await academicYearsRef.child(studentData.academicYear).child('data/exams').once('value');
                examDataCache = snapshot.val() || {};
                lastExamDataFetch = now.toISOString();
                localStorage.setItem('mcth_last_exam_fetch', lastExamDataFetch);
            } catch(e) { console.error(e); showToast("পরীক্ষার তথ্য লোড করা যায়নি।", "error"); }
        }

        const exams = examDataCache || {};
        const studentExams = Object.values(exams).filter(exam => exam && !exam.deletedAt && exam.results && exam.results[studentData.id] !== undefined);
        
        container.innerHTML = '';
        if (studentExams.length === 0) {
            container.innerHTML = `<div class="page-section"><p style="text-align:center; color:var(--text-secondary);">আপনি এখনো কোনো পরীক্ষায় অংশগ্রহণ করেননি।</p></div>`;
            return;
        }

        studentExams.sort((a,b) => new Date(b.date) - new Date(a.date));
        const chartLabels = [];
        const studentMarksData = [];
        const highestMarksData = [];
        
        studentExams.forEach(exam => {
            const card = document.createElement('div'); card.className = 'exam-card';
            const studentMark = exam.results[studentData.id];
            
            const studentBatches = (fullAcademicData.batchSchedule || []).flatMap(d => (d.classes || []).flatMap(c => (c.batches || []).filter(b => (b.studentIds || []).includes(studentData.id)).map(b => b.id)));
            const batchParticipants = Object.keys(exam.results).filter(id => {
                const participantBatches = (fullAcademicData.batchSchedule || []).flatMap(d => (d.classes || []).flatMap(c => (c.batches || []).filter(b => (b.studentIds || []).includes(id)).map(b => b.id)));
                return studentBatches.some(b => participantBatches.includes(b));
            });

            let position = "N/A", highestMark = "N/A";
            if (batchParticipants.length > 0) {
                const batchResults = batchParticipants.map(id => exam.results[id]).filter(m => m != null).sort((a, b) => b - a);
                if(batchResults.length > 0) {
                    highestMark = batchResults[0];
                    if(studentMark != null) {
                        const rank = batchResults.indexOf(studentMark) + 1;
                        position = `${rank}/${batchParticipants.length}`;
                    }
                }
            }

            card.innerHTML = `
                <h4>${exam.name}</h4>
                <p style="font-size: 0.9em; color: var(--text-secondary);">${new Date(exam.date).toLocaleDateString('bn-BD')}</p>
                <div class="exam-stats-grid">
                    <span>প্রাপ্ত নম্বর: <strong>${studentMark !== null ? `${studentMark}/${exam.totalMarks}` : '<span class="result-pending">মূল্যায়ন হয়নি</span>'}</strong></span>
                    <span>ব্যাচে পজিশন: <strong>${position}</strong></span>
                    <span>ব্যাচের সর্বোচ্চ: <strong>${highestMark}</strong></span>
                </div>
            `;
            container.appendChild(card);

            if(studentMark != null) {
                chartLabels.unshift(exam.name.split(' ').slice(0, 2).join(' ')); // Shorten name for chart
                studentMarksData.unshift(studentMark);
                highestMarksData.unshift(highestMark);
            }
        });

        if(chartLabels.length > 0) {
            chartContainer.style.display = 'block';
            new Chart(document.getElementById('examPerformanceChart'), {
                type: 'bar',
                data: {
                    labels: chartLabels,
                    datasets: [
                        { label: 'আপনার নম্বর', data: studentMarksData, backgroundColor: 'var(--success-color)' },
                        { label: 'সর্বোচ্চ নম্বর', data: highestMarksData, backgroundColor: 'var(--border-accent)' }
                    ]
                },
                options: { scales: { y: { beginAtZero: true } } }
            });
        }
    }

    function calculateStudentOutstandingAmount() {
        let totalDue = 0; if (!studentData) return 0;
        const admissionDate = new Date(studentData.createdAt);
        if (studentData.admissionFee && studentData.admissionFee.status !== 'paid' && studentData.admissionFee.amount > 0) totalDue += studentData.admissionFee.amount;
        for (let i = 0; i < 12; i++) {
            const monthDate = new Date(studentData.academicYear, i, 1);
            if (monthDate < new Date(admissionDate.getFullYear(), admissionDate.getMonth(), 1)) continue;
            const payment = studentData.monthlyPayments?.[BENGALI_MONTHS[i]];
            const isDueMonth = new Date() > new Date(studentData.academicYear, i, 10);
            if (isDueMonth && (!payment || payment.status !== 'paid')) totalDue += payment?.fee || studentData.monthlyFeeDefault || 0;
        }
        return totalDue;
    }
    
    function calculateOverdueMonths() {
        const overdue = [];
        for (let i = 0; i < 12; i++) {
            const monthDate = new Date(studentData.academicYear, i, 1);
            if (monthDate < new Date(new Date(studentData.createdAt).getFullYear(), new Date(studentData.createdAt).getMonth(), 1)) continue;
            const payment = studentData.monthlyPayments?.[BENGALI_MONTHS[i]];
            const isDueMonth = new Date() > new Date(studentData.academicYear, i, 10);
            if (isDueMonth && (!payment || payment.status !== 'paid')) {
                overdue.push(BENGALI_MONTHS[i]);
            }
        }
        return overdue.join(', ') || 'কোনো বকেয়া নেই';
    }

    // --- Event Listeners ---
    navItems.forEach(item => { item.addEventListener('click', () => { renderPage(item.dataset.page); }); });
    profileMenuButton.addEventListener('click', (e) => { e.stopPropagation(); profileMenu.classList.toggle('active'); });
    document.body.addEventListener('click', () => profileMenu.classList.remove('active'));
    document.getElementById('btn-view-profile').addEventListener('click', () => { profileMenu.classList.remove('active'); renderPage('profile'); });
    document.getElementById('btn-logout').addEventListener('click', () => { sessionStorage.removeItem('mcth_student_session'); location.reload(); });
    document.getElementById('btn-about-dev').addEventListener('click', () => {
        profileMenu.classList.remove('active');
        const modalTemplate = document.getElementById('template-about-dev-modal');
        if (modalTemplate) document.body.appendChild(modalTemplate.content.cloneNode(true));
    });

    // --- Initial Load ---
    document.getElementById('profile-pic-header').src = studentData.photoURL || 'images/default_avatar.png';
    document.getElementById('profile-pic-header').onerror = () => { document.getElementById('profile-pic-header').src = 'images/default_avatar.png'; };
    lastExamDataFetch = localStorage.getItem('mcth_last_exam_fetch');
    loadInitialData();
}

</script>
</body>
</html>