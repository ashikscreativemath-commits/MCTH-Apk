<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Miracle Student Portal</title>
    <link rel="icon" type="image/x-icon" href="images/image2.png">
    <link rel="manifest" href="manifest.json?v=5"> <!-- Version Updated -->

    <!-- FIREBASE SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-messaging-compat.js"></script>
    
    <!-- Chart.js for Analysis -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <!-- LIBRARIES for PDF ID Card Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        @font-face {
          font-family: 'Kalpurush';
          src: url('fonts/kalpurush.ttf') format('truetype');
        }
        
        :root {
            --bg-main: #e8f5e9; --bg-section: #ffffff; --bg-header: #00695c; --bg-tab-container: var(--bg-main); --bg-tab: #e8f5e9; --bg-tab-active: #ffffff; --bg-input: #f1f8e9; --bg-input-disabled: #f5f5f5; --bg-subtle: #f1f8e9; --bg-scrollable: #ffffff; --bg-hover: #dcedc8; --bg-footer: #00695c; --text-primary: #212121; --text-secondary: #757575; --text-header: #ffffff; --text-tab: #424242; --text-tab-active: #ff9f43; --text-input-disabled: #bdbdbd; --text-footer: #e0f2f1; --text-footer-dev: #b2dfdb; --border-color: #e0e0e0; --border-accent: #ff9f43; --accent-green: #2ed573; --border-tab-active: #ffffff; --paid-color: rgba(46, 213, 115, 0.15); --due-color: rgba(255, 107, 107, 0.15); --paid-text: #27ae60; --due-text: #e74c3c; --not-applicable-color: #f5f5f5; --not-applicable-text: #9e9e9e; --toast-success-bg: #27ae60; --toast-error-bg: #e74c3c; --toast-info-bg: #3498db; --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05); --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.1); --danger-color: #ff6b6b; --success-color: #2ed573; --warning-color: #feca57; --special-color: #ff9f43;
        }
        html { scroll-behavior: smooth; }
        body { margin: 0; padding: 0; font-family: 'Kalpurush', sans-serif; background-color: var(--bg-main); color: var(--text-primary); transition: background-color .3s, color .3s; }
        #auth-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 15px; box-sizing: border-box; }
        .auth-box { background-color: var(--bg-section); padding: 25px; border-radius: 8px; box-shadow: var(--shadow-md); width: 100%; max-width: 420px; text-align: center; border: 1px solid var(--border-color); animation: fadeIn 0.5s ease; overflow: hidden; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .auth-logo { width: 100px; height: 100px; margin: 0 auto 20px; }
        .auth-box h1 { font-size: 1.6em; margin-bottom: 20px; color: var(--border-accent); }
        .input-group { position: relative; margin-bottom: 15px; }
        .input-group input, .input-group select { width: 100%; padding: 12px 15px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 1em; background-color: var(--bg-input); color: var(--text-primary); box-sizing: border-box; }
        .password-toggle-icon { position: absolute; top: 50%; right: 15px; transform: translateY(-50%); cursor: pointer; color: var(--text-secondary); }
        .auth-options { display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; margin-bottom: 25px; }
        .auth-button { width: 100%; padding: 12px; border: none; border-radius: 8px; background: linear-gradient(45deg, var(--border-accent), #e67e22); color: white; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: all 0.3s; }
        .auth-button:hover:not(:disabled) { box-shadow: 0 4px 15px rgba(255, 159, 67, 0.4); transform: translateY(-2px); }
        .auth-button:disabled { background: #bdbdbd; color: #757575; cursor: not-allowed; }
        .auth-link { margin-top: 20px; font-size: 0.9em; }
        .auth-link a { color: var(--border-accent); text-decoration: none; font-weight: bold; }
        #auth-error-msg, #signup-error-msg { color: var(--due-text); margin-top: 15px; min-height: 20px; font-weight: bold; }
        .hidden { display: none !important; }
        #welcome-container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 15px; box-sizing: border-box; animation: fadeIn 0.5s ease; }
        .welcome-box { text-align: center; }
        #welcome-profile-pic { width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 4px solid var(--border-color); box-shadow: var(--shadow-md); margin-bottom: 20px; }
        #welcome-profile-name { font-size: 2em; font-weight: bold; color: var(--text-primary); margin-bottom: 30px; }
        #btn-proceed-to-app { width: 100%; max-width: 300px; }
        .typewriter h2 { overflow: hidden; border-right: .15em solid var(--border-accent); white-space: nowrap; margin: 0 auto; letter-spacing: .1em; animation: typing 3s steps(30, end), blink-caret .75s step-end infinite; }
        @keyframes typing { from { width: 0 } to { width: 100% } }
        @keyframes blink-caret { from, to { border-color: transparent } 50% { border-color: var(--border-accent); } }
        .signup-step { animation: fadeIn 0.5s ease; }
        .step-title { font-size: 1.2em; color: var(--text-secondary); margin-bottom: 15px; }
        #student-selection-list { max-height: 250px; overflow-y: auto; }
        #student-selection-list .student-item { padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s ease; text-align: left; }
        #student-selection-list .student-item:hover, #student-selection-list .student-item.selected { background-color: var(--bg-hover); border-left: 4px solid var(--border-accent); }
        #student-selection-list .student-item strong { display: block; font-size: 1.1em; }
        #student-selection-list .student-item span { font-size: 0.9em; color: var(--text-secondary); }
        .roll-selection-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(60px, 1fr)); gap: 10px; margin-top: 10px; }
        .roll-box { padding: 15px 10px; border: 2px solid var(--border-color); border-radius: 6px; cursor: pointer; transition: all 0.2s ease; font-weight: bold; font-size: 1.1em; }
        .roll-box:hover { background-color: var(--bg-hover); transform: translateY(-2px); }
        .roll-box.selected { background-color: var(--border-accent); color: white; border-color: var(--border-accent); }
        .password-strength { font-size: 0.8em; margin-top: 5px; text-align: left; }
        #lockout-message { background-color: var(--due-color); color: var(--due-text); padding: 10px; border-radius: 6px; }
        .login-footer { margin-top: 25px; font-size: 0.85em; color: var(--text-secondary); text-align: center; }
        .login-footer .copyright-text { font-size: 0.9em; margin-bottom: 15px; }
        .developer-box { border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; background-color: var(--bg-main); }
        .login-footer .developed-by-text { margin-bottom: 8px; font-size: 1.1em; }
        .company-info { display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 15px; }
        .company-logo { width: 40px; height: 40px; object-fit: contain; }
        .company-text { text-align: left; line-height: 1.5; }
        .company-text strong { font-size: 1.2em; color: var(--text-primary); }
        .company-text small { font-size: 0.9em; }
        .social-icons { display: flex; justify-content: center; gap: 20px; align-items: center; }
        .social-icons a { display: inline-block; color: var(--text-secondary); transition: color 0.3s, transform 0.3s; }
        .social-icons a:hover { color: var(--border-accent); transform: scale(1.1); }
        .social-icons svg { width: 28px; height: 28px; fill: currentColor; }
        .login-footer .instruction-text { font-size: 0.8em; font-style: italic; margin-top: 12px; margin-bottom: 0; color: var(--text-secondary); }
        #app-container { display: flex; flex-direction: column; min-height: 100vh; }
        #center-watermark { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 70vw; max-width: 300px; height: 100vh; background-image: url(images/image2.png); background-size: contain; background-repeat: no-repeat; background-position: center; opacity: .04; z-index: 2; pointer-events: none; filter: grayscale(1); }
        header { background-color: var(--bg-header); color: var(--text-header); padding: 15px 15px; position: sticky; top: 0; z-index: 1001; box-shadow: 0 2px 5px rgba(0,0,0,0.2); display: flex; flex-wrap: wrap; }
        .header-top-row { display: flex; justify-content: space-between; align-items: center; width: 100%; gap: 15px; }
        .header-left { display: flex; align-items: center; gap: 15px; flex-grow: 1; min-width: 0; }
        .header-logo { width: 40px; height: 40px; border-radius: 4px; flex-shrink: 0; }
        .header-info-text { display: flex; flex-direction: column; align-items: flex-start; line-height: 1.2; }
        .institute-name { font-size: 2em; font-weight: bold; white-space: nowrap; color: var(--border-accent); }
        .institute-subtext { font-size: 0.75em; opacity: 0.8; white-space: nowrap; color: #f0f0f0; }
        .institute-contact-info { display: flex; flex-wrap: wrap; gap: 15px; font-size: 0.8em; opacity: 0.9; color: #f0f0f0; margin-top: 4px; }
        .contact-item { display: flex; align-items: center; gap: 4px; }
        .header-right { position: relative; display: flex; align-items: center; gap: 10px; }
        .profile-pic { width: 45px; height: 45px; border-radius: 50%; cursor: pointer; border: 2px solid var(--border-accent); object-fit: cover; }
        .profile-actions-menu { position: relative; }
        .menu-toggle-btn { background: none; border: none; color: white; font-size: 1.8em; cursor: pointer; padding: 0 5px; }
        .profile-menu { display: none; position: absolute; top: 40px; right: 0; background-color: var(--bg-section); border-radius: 8px; box-shadow: var(--shadow-md); z-index: 1002; width: 200px; overflow: hidden; border: 1px solid var(--border-color); }
        .profile-menu.active { display: block; }
        .profile-menu button { width: 100%; padding: 12px 15px; text-align: left; background: none; border: none; font-size: 1em; color: var(--text-primary); cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .profile-menu button:hover { background-color: var(--bg-hover); color: var(--border-accent); }
        .header-controls { width: 100%; display: flex; justify-content: space-between; align-items: center; padding-top: 10px; }
        .header-actions { display: flex; gap: 10px; }
        .header-year { background: rgba(255,255,255,0.1); padding: 4px 10px; border-radius: 12px; font-size: 0.85em; font-weight: bold; }
        .nav-btn { background: none; border: none; color: white; cursor: pointer; padding: 0; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s, transform 0.1s ease; }
        .nav-btn:hover { background-color: rgba(255,255,255,0.1); }
        .nav-btn:active { transform: scale(0.9); }
        .nav-btn svg { width: 22px; height: 22px; fill: currentColor; }
        #notification-bell { background: none; border: none; color: white; font-size: 1.5em; cursor: pointer; padding: 5px; position: relative; }
        #notification-bell.allowed { color: var(--success-color); }
        #notification-bell.denied { color: var(--danger-color); cursor: not-allowed; }
        main { padding: 15px; flex-grow: 1; position: relative; z-index: 1; padding-bottom: 80px; }
        .page-section { background-color: var(--bg-section); padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: var(--shadow-sm); border: 1px solid var(--border-color); }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background-color: var(--bg-section); box-shadow: 0 -2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-around; padding: 5px 0; border-top: 1px solid var(--border-color); z-index: 1000; }
        .nav-item { flex: 1; text-align: center; padding: 8px 0; cursor: pointer; color: var(--text-secondary); transition: all 0.2s; position: relative; }
        .nav-item.active { color: var(--border-accent); font-weight: bold; }
        .nav-item.active::before { content: ''; position: absolute; top: 0; left: 10%; width: 80%; height: 3px; background-color: var(--border-accent); border-radius: 0 0 4px 4px; }
        .nav-icon { font-size: 1.4em; }
        .nav-label { font-size: 0.75em; display: block; }
        .nav-item.has-unseen { position: relative; }
        .nav-item.has-unseen::after { content: ''; position: absolute; top: 5px; right: calc(50% - 20px); width: 8px; height: 8px; background-color: var(--danger-color); border-radius: 50%; border: 1px solid var(--bg-section); box-shadow: 0 0 3px var(--danger-color); }
        .home-banner-image { width: 100%; height: auto; max-height: 150px; object-fit: cover; border-radius: 8px; margin-bottom: 15px; box-shadow: var(--shadow-md); }
        .home-cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; }
        .stat-item { text-align: center; background: var(--bg-subtle); padding: 15px; border-radius: 8px; border-left: 5px solid; }
        .stat-item .label { font-size: 0.9em; color: var(--text-secondary); margin-bottom: 5px; }
        .stat-item .value { font-size: 1.8em; font-weight: bold; }
        .stat-item.present { border-left-color: var(--success-color); }
        .stat-item.present .value { color: var(--paid-text); }
        .stat-item.absent { border-left-color: var(--danger-color); }
        .stat-item.absent .value { color: var(--due-text); }
        #home-image-showcase { padding: 0; background-color: transparent; box-shadow: none; border: none; }
        .slideshow-container { position: relative; width: 100%; aspect-ratio: 16 / 9; margin: auto; overflow: hidden; border-radius: 8px; box-shadow: var(--shadow-md); -webkit-user-select: none; -ms-user-select: none; user-select: none; }
        .slide { position: absolute; width: 100%; height: 100%; top: 0; left: 0; opacity: 0; transition: opacity 1.5s ease-in-out; }
        .slide.active { opacity: 1; }
        .slide img { width: 100%; height: 100%; object-fit: cover; vertical-align: middle; }
        .slideshow-dots { text-align: center; padding-top: 10px; }
        .dot { cursor: pointer; height: 10px; width: 10px; margin: 0 4px; background-color: var(--border-color); border-radius: 50%; display: inline-block; transition: background-color: 0.6s ease; }
        .dot.active, .dot:hover { background-color: var(--border-accent); }
        .profile-info-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .profile-info-card { background-color: var(--bg-subtle); border: 1px solid var(--border-color); border-left: 4px solid var(--accent-green); padding: 15px; border-radius: 8px; transition: all 0.3s ease; animation: fadeInUp 0.5s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .profile-info-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); }
        .profile-info-card p { margin: 0; display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color); }
        .profile-info-card p:last-child { border-bottom: none; }
        .profile-info-card p strong { color: var(--text-secondary); }
        .profile-info-card p span { font-weight: bold; word-break: break-all; }
        .profile-action-btn { width: 100%; padding: 12px; margin-top: 15px; border: none; border-radius: 8px; background: linear-gradient(45deg, var(--accent-green), #2ecc71); color: #111; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .profile-action-btn:hover { box-shadow: 0 4px 15px rgba(123, 237, 159, 0.3); transform: translateY(-2px); }
        .yearly-status-chart { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; }
        .month-box { background: var(--bg-subtle); border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; text-align: center; }
        .month-name { font-weight: bold; font-size: 1.1em; margin-bottom: 5px; }
        .month-status { font-size: 0.85em; padding: 3px 8px; border-radius: 10px; font-weight: bold; }
        .month-status.paid { background-color: transparent; color: var(--paid-text); border: 1px solid var(--paid-text); }
        .month-status.due { background-color: transparent; color: var(--due-text); border: 1px solid var(--due-text); }
        .month-status.future { background-color: var(--text-secondary); color: white; }
        .month-status.not-applicable { background-color: var(--not-applicable-color); color: var(--not-applicable-text); border: 1px solid var(--border-color); }
        .upcoming-payment-card { background: linear-gradient(45deg, var(--border-accent), #e67e22); color: white; padding: 20px; border-radius: 8px; text-align: center; }
        .upcoming-payment-card h4 { margin: 0 0 10px; opacity: 0.9; }
        .upcoming-payment-card .month { font-size: 1.8em; font-weight: bold; }
        .history-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em; }
        .history-table tr { border-bottom: 1px solid var(--border-color); transition: background-color: 0.2s; }
        .history-table tr:hover { background-color: var(--bg-hover); }
        .history-table th, .history-table td { padding: 12px 10px; text-align: left; }
        .history-table th { background-color: transparent; border-bottom: 2px solid var(--success-color); color: var(--paid-text); }
        .history-table td:last-child { font-family: monospace; }
        .exam-card { background: var(--bg-subtle); border: 1px solid var(--border-color); border-left: 5px solid var(--accent-green); padding: 15px; border-radius: 8px; }
        .exam-card-content h4 { margin: 0 0 10px; font-size: 1.2em; }
        .exam-stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 0.9em; }
        .exam-stats-grid span { background: var(--bg-section); padding: 8px; border-radius: 6px; }
        .exam-stats-grid strong { color: var(--text-primary); }
        .result-pending { color: var(--warning-color); font-style: italic; }
        .graph-toggle-btn { grid-column: 1 / -1; margin-top: 10px; padding: 8px; background-color: var(--border-accent); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .graph-container { display: none; margin-top: 15px; }
        .calendar-container { padding:0; border:none; box-shadow: none; }
        .calendar-header { display:flex; justify-content: space-between; align-items: center; }
        #calendarMonthYear { margin: 0; font-size: 1.2em; }
        .calendar-header .nav-btn { color: var(--text-primary); border: 1px solid var(--border-color);}
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .day-names { font-weight: bold; color: var(--text-secondary); padding-bottom: 10px; font-size: 0.8em;}
        .calendar-day { padding: 8px 4px; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; margin: auto; font-size: 0.9em;}
        .day-present { background-color: var(--success-color); color: var(--bg-header); }
        .day-absent { background-color: var(--danger-color); color: white; }
        .analysis-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .analysis-card { background-color: var(--bg-subtle); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); }
        .analysis-card h3 { margin-top: 0; border-bottom: 2px solid var(--accent-green); padding-bottom: 8px; font-size: 1.1em; }
        .lottery-result-box { background: linear-gradient(145deg, var(--bg-subtle), #ffffff); border: 1px solid var(--border-color); border-left: 5px solid var(--success-color); border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: var(--shadow-sm); }
        .lottery-result-box.pinned { border-left-color: var(--special-color); background: linear-gradient(145deg, #fffbeb, #ffffff); }
        .lottery-result-box h3 { margin: 0 0 10px; color: var(--bg-header); border-bottom: 1px solid var(--border-color); padding-bottom: 8px; font-size: 1.3em; }
        .lottery-result-box p { font-size: 0.9em; color: var(--text-secondary); margin-bottom: 15px; }
        .lottery-result-box .winner-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 10px; }
        .lottery-result-box .winner-list li { background: rgba(255, 255, 255, 0.7); padding: 10px 15px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid var(--accent-green); }
        .lottery-result-box .winner-list li strong { font-weight: bold; color: var(--text-primary); }
        .lottery-result-box .winner-list li span { color: var(--text-secondary); text-align: right; }
        .latest-notice-card { border: 2px solid var(--special-color); background-color: #fffbeb; }
        .latest-notice-card h3 { color: var(--special-color); }
        .new-badge { background-color: var(--special-color); color: white; padding: 3px 8px; font-size: 0.7em; font-weight: bold; border-radius: 10px; margin-left: 10px; }
        .notice-card { margin-bottom: 15px; border-left: 4px solid var(--border-color); background-color: var(--bg-subtle); padding: 15px; border-radius: 8px; }
        .notice-card h4 { margin: 0 0 8px; }
        .notice-image { width: 100%; max-height: 250px; object-fit: cover; border-radius: 8px; margin-top: 10px; cursor: pointer; }
        .notice-content { white-space: pre-wrap; margin: 10px 0; line-height: 1.6; }
        .notice-timestamp { font-size: 0.8em; color: var(--text-secondary); text-align: right; }
        #image-viewer-modal .modal-content { padding: 5px; background-color: var(--bg-section); }
        #image-viewer-modal img { max-width: 100%; max-height: 85vh; display: block; margin: auto; border-radius: 8px;}
        #image-viewer-modal .modal-header { padding-bottom: 5px; margin-bottom: 5px; }
        .notice-header { display: flex; justify-content: space-between; align-items: baseline; flex-wrap: wrap; gap: 5px; }
        .notice-time-ago { font-size: 0.75em; color: var(--text-secondary); font-style: italic; flex-shrink: 0; margin-left: 10px; }
        #load-more-notices-btn { width: 100%; padding: 12px; border: 1px solid var(--border-accent); color: var(--border-accent); background-color: transparent; border-radius: 8px; font-size: 1em; font-weight: bold; cursor: pointer; margin-top: 10px; transition: all 0.3s; }
        #load-more-notices-btn:hover { background-color: var(--border-accent); color: white; }
        #loader-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:10006;display:none;align-items:center;justify-content:center}.loader{border:5px solid #f3f3f3;border-top:5px solid var(--accent-green);border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        #toast-container{position:fixed;bottom:70px;left:50%;transform:translateX(-50%);z-index:10005;display:flex;flex-direction:column;gap:8px;width:90%;max-width:400px}.toast{padding:12px 15px;border-radius:6px;color:#fff;font-size:0.9em;box-shadow:0 2px 10px rgba(0,0,0,.2);opacity:0;transform:translateY(20px);transition:opacity .3s,transform .3s}.toast.show{opacity:1;transform:translateY(0)}.toast.success{background-color:var(--toast-success-bg)}.toast.error{background-color:var(--toast-error-bg)}.toast.info{background-color:var(--toast-info-bg)}
        .modal-overlay{display:none;position:fixed;z-index:10001;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,.6);backdrop-filter:blur(4px);align-items:center;justify-content:center;}.modal-overlay.visible{display:flex}.modal-content{background-color:var(--bg-section);margin:auto;padding:20px;border-radius:12px;width:95%;max-width:500px;max-height:90vh;display:flex;flex-direction:column;box-shadow:0 5px 15px rgba(0,0,0,.3)}.modal-header{padding-bottom:15px;margin-bottom:15px;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center}.modal-header h2{margin:0;font-size:1.4em}.modal-close-btn{background:none;border:none;font-size:2em;cursor:pointer;color:var(--text-secondary);line-height:1;padding:0 5px;}.modal-body{flex-grow:1;overflow-y:auto;}
        .app-footer { background-color: var(--bg-footer); color: var(--text-footer); padding: 10px 15px 80px; text-align: center; }
        .footer-content { max-width: 1000px; margin: 0 auto; line-height: 1.6; }
        .footer-content p { margin: 1px 0; font-size: 0.8em; }
        .footer-content a { color: var(--text-footer); text-decoration: none; transition: color 0.2s; display: inline-flex; align-items: center; gap: 5px; font-size: 0.8em; }
        .footer-content a:hover { color: var(--border-accent); }
        .footer-socials { display: flex; justify-content: center; flex-wrap: wrap; gap: 10px 15px; align-items: center; margin-top: 5px; }
        .footer-contact { margin-top: 5px; }
        .footer-socials svg, .footer-contact svg { width: 14px; height: 14px; fill: currentColor; }
        .footer-qr-code { width: 40px; height: 40px; border-radius: 4px; object-fit: cover; }
        .id-card-viewer-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(5px); z-index: 10002; display: none; justify-content: center; align-items: center; }
        .id-card-viewer-modal.visible { display: flex; }
        .id-card-viewer-content { background-color: var(--bg-main); padding: 20px; border-radius: 12px; width: 95%; max-width: 800px; max-height: 95vh; overflow-y: auto; }
        .id-card-viewer-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .id-card-viewer-header h2 { margin: 0; font-size: 1.5em; }
        .id-card-controls { display: flex; gap: 10px; }
        #id-card-download-btn { background-color: var(--success-color); color: #fff; padding: 8px 15px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; }
        .id-card-viewer-close-btn { font-size: 2em; line-height: 1; }
        .id-card-preview-area { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; }
        .id-card-container { width: 300px; aspect-ratio: 54 / 86; position: relative; box-shadow: var(--shadow-md); border-radius: 12px; overflow: hidden; font-family: Arial, Helvetica, sans-serif; }
        .id-card-container .bg-img { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }
        .id-card-photo { position: absolute; top: 17.7%; left: 50%; transform: translateX(-50%); width: 50.75%; aspect-ratio: 9.25 / 10; object-fit: cover; border-radius: 15px; }
        .id-card-details-container { position: absolute; top: 53.5%; left: 50%; width: 50%; height: auto; color: #1c1c1c; }
        .id-card-details-container p { font-family: 'Kalpurush', sans-serif; margin: 0; padding: 0; font-size: 12.3px; font-weight: bold; line-height: 1.65; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .id-card-qr-container { position: absolute; top: 48.3%; left: 50%; transform: translateX(-50%); width: 28.5%; background: white; padding: 4px; border-radius: 2px; }
        .id-card-qr-container img { width: 100% !important; height: auto !important; display: block; }
    </style>
</head>
<body data-theme="light">
    <!-- আপনার সম্পূর্ণ HTML বডি কন্টেন্ট এখানে অপরিবর্তিত থাকবে -->
    <!-- ... AUTHENTICATION CONTAINER ... -->
    <!-- ... WELCOME CONTAINER ... -->
    <!-- ... MAIN APP CONTAINER ... -->
    <!-- ... HTML TEMPLATES ... -->
    
<script>
// ================================================================== //
//            FIREBASE CONFIGURATION AND INITIALIZATION             //
// ================================================================== //
const firebaseConfig = {
    apiKey: "AIzaSyAnpbv9WhvOqV8nsbmVOQuBhKDF7D9-Ztc",
    authDomain: "miracle-math-online-software.firebaseapp.com",
    projectId: "miracle-math-online-software",
    storageBucket: "miracle-math-online-software.firebasestorage.app",
    messagingSenderId: "27829239296",
    appId: "1:27829239296:web:108d6b86969c95cea2a2e5",
    measurementId: "G-GSVFRCS9NR",
    databaseURL: "https://miracle-math-online-software-default-rtdb.asia-southeast1.firebasedatabase.app"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const studentAuthRef = db.ref('studentAuth');
const academicYearsRef = db.ref('academicYears');
const noticesRef = db.ref('notices');
const fcmTokensRef = db.ref('fcmTokens');

// ================================================================== //
//                GLOBAL UTILITY FUNCTIONS                          //
// ================================================================== //
function showToast(message, type = 'info', duration = 3000) { const c = document.getElementById('toast-container'); if (!c) return; const t = document.createElement('div'); t.className = `toast ${type}`; t.textContent = message; c.appendChild(t); setTimeout(() => t.classList.add('show'), 10); setTimeout(() => { t.classList.remove('show'); t.addEventListener('transitionend', () => t.remove()); }, duration); }
const showLoader = () => document.getElementById('loader-overlay').style.display = 'flex';
const hideLoader = () => document.getElementById('loader-overlay').style.display = 'none';
function applyTheme(theme) { document.body.setAttribute('data-theme', theme); }
const BENGALI_MONTHS=["জানুয়ারি","ফেব্রুয়ারি","মার্চ","এপ্রিল","মে","জুন","জুলাই","আগস্ট","সেপ্টেম্বর","অক্টোবর","নভেম্বর","ডিসেম্বর"];

function timeAgo(timestamp) {
    const now = new Date();
    const seconds = Math.floor((now - new Date(timestamp)) / 1000);
    if (seconds < 60) return "এইমাত্র";
    let interval = seconds / 31536000;
    if (interval > 1) return Math.floor(interval) + " বছর আগে";
    interval = seconds / 2592000;
    if (interval > 1) return Math.floor(interval) + " মাস আগে";
    interval = seconds / 86400;
    if (interval > 1) return Math.floor(interval) + " দিন আগে";
    interval = seconds / 3600;
    if (interval > 1) return Math.floor(interval) + " ঘন্টা আগে";
    interval = seconds / 60;
    if (interval > 1) return Math.floor(interval) + " মিনিট আগে";
    return Math.floor(seconds) + " সেকেন্ড আগে";
}

// ================================================================== //
//              AUTHENTICATION & SIGNUP SCRIPT                      //
// ================================================================== //
document.addEventListener('DOMContentLoaded', () => {
    const authContainer = document.getElementById('auth-container');
    const welcomeContainer = document.getElementById('welcome-container');
    const appContainer = document.getElementById('app-container');
    
    const loggedInStudent = localStorage.getItem('mcth_student_session') || sessionStorage.getItem('mcth_student_session');
    
    if (loggedInStudent) {
        authContainer.classList.add('hidden');
        appContainer.classList.remove('hidden');
        firebase.auth().signInAnonymously().then(() => {
            initializeAppLogic(JSON.parse(loggedInStudent));
        }).catch(err => {
            console.error("Firebase sign-in failed on session restore:", err);
            localStorage.removeItem('mcth_student_session');
            sessionStorage.removeItem('mcth_student_session');
            location.reload();
        });
        return;
    }

    const loginView = document.getElementById('login-view');
    const signupView = document.getElementById('signup-view');
    const loginForm = document.getElementById('login-form');
    const errorMsgDiv = document.getElementById('auth-error-msg');
    
    document.getElementById('show-signup').addEventListener('click', (e) => {
        e.preventDefault();
        loginView.classList.add('hidden');
        signupView.classList.remove('hidden');
        if (!window.signupInitialized) {
            initializeSignupLogic();
            window.signupInitialized = true;
        }
    });
    document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); signupView.classList.add('hidden'); loginView.classList.remove('hidden'); });

    const passwordToggle = document.getElementById('password-toggle');
    passwordToggle.addEventListener('click', () => {
        const passwordInput = document.getElementById('login-password');
        const isPassword = passwordInput.type === 'password';
        passwordInput.type = isPassword ? 'text' : 'password';
        passwordToggle.textContent = isPassword ? '🙈' : '👁️';
    });

    let activeUserSessionData = null;
    let rememberMeForProceed = false;

    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const contact = document.getElementById('login-contact').value.trim();
        const password = document.getElementById('login-password').value;
        
        errorMsgDiv.textContent = '';
        showLoader();

        try {
            await firebase.auth().signInAnonymously();
            const snapshot = await studentAuthRef.orderByChild('contact').equalTo(contact).once('value');

            if (!snapshot.exists()) {
                errorMsgDiv.textContent = 'এই মোবাইল নম্বর দিয়ে কোনো অ্যাকাউন্ট নেই।';
                hideLoader(); return;
            }

            const studentAuthData = Object.values(snapshot.val())[0];
            if (studentAuthData.password === password) {
                const studentProfileSnapshot = await academicYearsRef.child(`${studentAuthData.academicYear}/data/students`).orderByChild('id').equalTo(studentAuthData.studentId).once('value');
                if(!studentProfileSnapshot.exists()) {
                    errorMsgDiv.textContent = 'ছাত্রের প্রোফাইল খুঁজে পাওয়া যায়নি। অফিসে যোগাযোগ করুন।';
                    hideLoader(); return;
                }
                
                const studentProfile = Object.values(studentProfileSnapshot.val())[0];
                activeUserSessionData = { ...studentProfile, academicYear: studentAuthData.academicYear };
                
                rememberMeForProceed = document.getElementById('remember-me').checked;
                authContainer.classList.add('hidden');
                
                document.getElementById('welcome-profile-pic').src = activeUserSessionData.photoURL || 'images/default_avatar.png';
                const welcomeNameEl = document.getElementById('welcome-profile-name');
                welcomeNameEl.textContent = `স্বাগতম, ${activeUserSessionData.name}`;
                welcomeNameEl.parentElement.classList.remove('typewriter');
                welcomeContainer.classList.remove('hidden');
                
            } else {
                errorMsgDiv.textContent = 'পাসওয়ার্ড সঠিক নয়।';
            }
        } catch (error) {
            console.error("Login error:", error);
            errorMsgDiv.textContent = 'লগইন করার সময় একটি সমস্যা হয়েছে।';
        } finally {
            hideLoader();
        }
    });

    document.getElementById('btn-proceed-to-app').addEventListener('click', () => {
        if (!activeUserSessionData) return;
        const studentDataString = JSON.stringify(activeUserSessionData);
        if (rememberMeForProceed) {
            localStorage.setItem('mcth_student_session', studentDataString);
        } else {
            sessionStorage.setItem('mcth_student_session', studentDataString);
        }
        welcomeContainer.classList.add('hidden');
        appContainer.classList.remove('hidden');
        initializeAppLogic(activeUserSessionData);
    });
    
    function initializeSignupLogic() {
        const signupForm = document.getElementById('signup-form');
        const signupErrorDiv = document.getElementById('signup-error-msg');
        let signupData = { allYearsData: {}, potentialStudents: [], selectedStudent: null, requiresUniqueContact: false };

        function showStep(stepNum) {
            document.querySelectorAll('.signup-step').forEach(step => step.classList.add('hidden'));
            document.getElementById(`step-${stepNum}`).classList.remove('hidden');
            signupErrorDiv.textContent = '';
        }

        const yearSelect = document.getElementById('signup-year');
        const classSelect = document.getElementById('signup-class');
        const batchSelect = document.getElementById('signup-batch');
        const btnNextStep1 = document.getElementById('btn-next-step-1');

        async function initializeSelectors() {
            showLoader();
            try {
                await firebase.auth().signInAnonymously();
                const yearsSnapshot = await academicYearsRef.once('value');
                if (!yearsSnapshot.exists()) { signupErrorDiv.textContent = "কোনো শিক্ষাবর্ষের তথ্য পাওয়া যায়নি।"; return; }
                signupData.allYearsData = yearsSnapshot.val();
                yearSelect.innerHTML = '<option value="">শিক্ষাবর্ষ বাছাই করুন</option>';
                Object.keys(signupData.allYearsData).sort((a,b) => b-a).forEach(year => yearSelect.add(new Option(year, year)));
            } catch(e) { console.error(e); signupErrorDiv.textContent = "তথ্য লোড করতে সমস্যা হয়েছে।"; } finally { hideLoader(); }
        }
        
        yearSelect.onchange = () => {
            const year = yearSelect.value;
            classSelect.innerHTML = '<option value="">ক্লাস বাছাই করুন</option>';
            batchSelect.innerHTML = '<option value="">ব্যাচ বাছাই করুন</option>';
            classSelect.disabled = true; batchSelect.disabled = true; btnNextStep1.disabled = true;
            if (!year) return;
            const classes = (signupData.allYearsData[year]?.data?.mainClassCategories || []).filter(c => c && !c.deletedAt);
            classes.forEach(c => classSelect.add(new Option(c.name, c.id)));
            classSelect.disabled = false;
        };

        classSelect.onchange = () => {
            const year = yearSelect.value;
            const classId = classSelect.value;
            batchSelect.innerHTML = '<option value="">ব্যাচ বাছাই করুন</option>';
            batchSelect.disabled = true; btnNextStep1.disabled = true;
            if (!classId) return;
            const batches = [];
            const yearData = signupData.allYearsData[year]?.data;
            if (yearData?.batchSchedule) {
                yearData.batchSchedule
                    .filter(day => day && !day.deletedAt && day.classes)
                    .forEach(day => {
                        day.classes
                            .filter(cs => cs && !cs.deletedAt && cs.classId === classId && cs.batches)
                            .forEach(cs => {
                                cs.batches
                                    .filter(batch => batch && !batch.deletedAt)
                                    .forEach(batch => { batches.push({ id: batch.id, name: `${day.dayName} (${batch.time})` }); });
                            });
                    });
            }
            const uniqueBatches = [...new Map(batches.map(item => [item.id, item])).values()];
            uniqueBatches.forEach(b => batchSelect.add(new Option(b.name, b.id)));
            batchSelect.disabled = false;
        };
        
        batchSelect.onchange = () => { btnNextStep1.disabled = !batchSelect.value; };
        btnNextStep1.onclick = () => { signupData.year = yearSelect.value; signupData.classId = classSelect.value; signupData.batchId = batchSelect.value; showStep(2); };

        document.getElementById('btn-next-step-2').onclick = async () => {
            signupData.contact = document.getElementById('signup-contact').value.trim();
            if (signupData.contact.length < 11) { signupErrorDiv.textContent = "সঠিক মোবাইল নম্বর দিন।"; return; }
            showLoader();
            try {
                const yearData = signupData.allYearsData[signupData.year]?.data;
                const students = (yearData?.students || []).filter(s => s && !s.deletedAt);
                let studentIdsInBatch = [];
                if (yearData?.batchSchedule) {
                    for (const day of yearData.batchSchedule) {
                        if (!day || day.deletedAt || !day.classes) continue;
                        for (const cs of day.classes) {
                            if (!cs || cs.deletedAt || !cs.batches) continue;
                            const foundBatch = cs.batches.find(b => b && !b.deletedAt && b.id === signupData.batchId);
                            if (foundBatch) { studentIdsInBatch = foundBatch.studentIds || []; break; }
                        }
                        if (studentIdsInBatch.length > 0) break;
                    }
                }
                signupData.potentialStudents = students.filter(s => s.classId === signupData.classId && studentIdsInBatch.includes(s.id) && (s.contact === signupData.contact || s.parentContact === signupData.contact));
                displayStudentMatches(signupData.potentialStudents);
            } catch (e) { console.error(e); signupErrorDiv.textContent = "প্রোফাইল খুঁজতে সমস্যা হয়েছে।"; } 
            finally { hideLoader(); }
        };

        async function displayStudentMatches(students) {
            const listContainer = document.getElementById('student-selection-list');
            listContainer.innerHTML = '';
            if (students.length === 0) { signupErrorDiv.textContent = "এই তথ্যের সাথে কোনো প্রোফাইল মেলেনি।"; return; }
            const authSnapshot = await studentAuthRef.once('value');
            const existingAuths = Object.values(authSnapshot.val() || {}).map(a => a.studentId);
            const availableStudents = students.filter(s => !existingAuths.includes(s.id));
            if (availableStudents.length === 0) { signupErrorDiv.textContent = "আপনার প্রোফাইল দিয়ে ইতিমধ্যে একটি অ্যাকাউন্ট তৈরি করা আছে।"; return; }
            signupData.requiresUniqueContact = availableStudents.length > 1;
            availableStudents.forEach(student => {
                const item = document.createElement('div');
                item.className = 'student-item';
                item.dataset.studentId = student.id;
                item.innerHTML = `<strong>${student.name}</strong><span>রোল: **** | স্কুল: *********</span>`;
                item.onclick = () => {
                    document.querySelectorAll('.student-item').forEach(el => el.classList.remove('selected'));
                    item.classList.add('selected');
                    signupData.selectedStudent = student;
                    document.getElementById('btn-next-step-3').disabled = false;
                };
                listContainer.appendChild(item);
            });
            showStep(3);
        }
        
        document.getElementById('btn-next-step-3').onclick = () => populateRollPuzzle();

        function populateRollPuzzle() {
            const container = document.getElementById('roll-selection');
            container.innerHTML = '';
            const correctRoll = parseInt(signupData.selectedStudent.roll);
            let options = [correctRoll];
            while (options.length < 4) {
                let randomRoll = correctRoll + Math.floor(Math.random() * 20) - 10;
                if (randomRoll > 0 && !options.includes(randomRoll)) {
                    options.push(randomRoll);
                }
            }
            options.sort(() => Math.random() - 0.5);
            options.forEach(roll => {
                const box = document.createElement('div');
                box.className = 'roll-box';
                box.textContent = roll.toLocaleString('bn-BD');
                box.dataset.roll = roll;
                box.onclick = () => {
                    document.querySelectorAll('.roll-box').forEach(el => el.classList.remove('selected'));
                    box.classList.add('selected');
                    document.getElementById('btn-next-step-4').disabled = false;
                }
                container.appendChild(box);
            });
            showStep(4);
        }

        document.getElementById('btn-next-step-4').onclick = () => {
            const selectedRoll = document.querySelector('.roll-box.selected')?.dataset.roll;
            if (parseInt(selectedRoll) === parseInt(signupData.selectedStudent.roll)) {
                showStep(5);
            } else {
                signupErrorDiv.textContent = "রোল নম্বর সঠিক নয়। আবার চেষ্টা করুন।";
            }
        };
        
        document.getElementById('btn-verify-trx').onclick = () => {
            const enteredTrxId = document.getElementById('signup-trxid').value.trim();
            const correctTrxId = signupData.selectedStudent.admissionFee?.token;
            if (enteredTrxId && correctTrxId && enteredTrxId.toLowerCase() === correctTrxId.toLowerCase()) {
                if (signupData.requiresUniqueContact) {
                    document.getElementById('unique-contact-container').classList.remove('hidden');
                }
                showStep(6);
            } else {
                signupErrorDiv.textContent = "Transaction ID সঠিক নয়।";
            }
        };

        signupForm.onsubmit = async (e) => {
            e.preventDefault();
            const password = document.getElementById('signup-password').value;
            const confirmPassword = document.getElementById('signup-confirm-password').value;
            if (password.length < 6) { signupErrorDiv.textContent = "পাসওয়ার্ড কমপক্ষে ৬ অক্ষরের হতে হবে।"; return; }
            if (password !== confirmPassword) { signupErrorDiv.textContent = "দুটি পাসওয়ার্ড মেলেনি।"; return; }
            showLoader();
            let finalContact = signupData.contact; 
            if (signupData.requiresUniqueContact) {
                const newContact = document.getElementById('signup-new-contact').value.trim();
                if (newContact.length < 11 || !/^(01)\d{9}$/.test(newContact)) {
                    signupErrorDiv.textContent = "আপনার স্বতন্ত্র মোবাইল নম্বরটি সঠিক নয় (১১ ডিজিট হতে হবে)।";
                    hideLoader();
                    return;
                }
                 try {
                    const existingUserSnapshot = await studentAuthRef.orderByChild('contact').equalTo(newContact).once('value');
                    if (existingUserSnapshot.exists()) {
                        signupErrorDiv.textContent = "এই মোবাইল নম্বরটি দিয়ে ইতিমধ্যে একটি অ্যাকাউন্ট আছে। অন্য নম্বর দিন।";
                        hideLoader(); return;
                    }
                    finalContact = newContact;
                } catch(err) {
                     signupErrorDiv.textContent = "মোবাইল নম্বর যাচাই করতে সমস্যা হয়েছে।";
                     hideLoader(); return;
                }
            }
            try {
                const newAuthData = { contact: finalContact, password: password, studentId: signupData.selectedStudent.id, academicYear: signupData.year };
                await studentAuthRef.push(newAuthData);
                activeUserSessionData = { ...signupData.selectedStudent, academicYear: signupData.year };
                rememberMeForProceed = true; 
                authContainer.classList.add('hidden');
                document.getElementById('welcome-profile-pic').src = activeUserSessionData.photoURL || 'images/default_avatar.png';
                const welcomeNameEl = document.getElementById('welcome-profile-name');
                welcomeNameEl.textContent = `স্বাগতম, ${activeUserSessionData.name}`;
                welcomeNameEl.parentElement.classList.add('typewriter');
                welcomeContainer.classList.remove('hidden');
            } catch (error) {
                console.error("Signup error:", error);
                signupErrorDiv.textContent = "অ্যাকাউন্ট তৈরি করতে সমস্যা হয়েছে।";
            } finally { hideLoader(); }
        };

        initializeSelectors();
    }
    applyTheme('light');
});

// ================================================================== //
//                  MAIN APP LOGIC AFTER LOGIN                      //
// ================================================================== //
function initializeAppLogic(studentData) {
    let currentPage = 'home'; 
    let fullAcademicData = {};
    let examDataCache = null;
    let lastExamDataFetch = null;
    let activeCharts = {};
    let allRelevantNotices = [];
    let noticesRenderedCount = 0;
    const NOTICES_PER_PAGE = 3;
    let noticeListener = null; 

    const mainContent = document.getElementById('main-content');
    const navItems = document.querySelectorAll('.nav-item');
    const profilePicHeader = document.getElementById('profile-pic-header');
    const profileMenu = document.getElementById('profile-menu');
    const menuToggleBtn = document.getElementById('menu-toggle-btn');
    const notificationBell = document.getElementById('notification-bell');
    
    document.getElementById('header-academic-year').textContent = `শিক্ষাবর্ষ: ${studentData.academicYear}`;
    profilePicHeader.src = studentData.photoURL || 'images/default_avatar.png';

    window.history.replaceState({ page: 'home' }, '', '#home');
    window.onpopstate = (event) => { if (event.state && event.state.page) { renderPage(event.state.page, false); } };
    
    const notificationManager = {
        messaging: null,
        registration: null,
        studentId: studentData.id,
        currentToken: null,

        async init() {
            if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
                console.warn('Push messaging is not supported.');
                notificationBell.style.display = 'none';
                return;
            }
            try {
                this.registration = await navigator.serviceWorker.register('/firebase-messaging-sw.js', { scope: '/' });
                await navigator.serviceWorker.ready;
                console.log('Service Worker is active.');
                this.messaging = firebase.messaging();
                this.setupListeners();
                this.updateUI();
                if (Notification.permission === 'granted') {
                    this.getToken(false);
                }
            } catch (error) {
                console.error('Messaging initialization failed:', error);
                this.updateUI();
            }
        },
        
        setupListeners() {
            notificationBell.addEventListener('click', () => this.handleBellClick());
            this.messaging.onMessage((payload) => this.handleForegroundMessage(payload));
        },

        updateUI() {
            switch (Notification.permission) {
                case 'granted':
                    notificationBell.innerHTML = '✅';
                    notificationBell.title = 'Notifications ON. Click to disable.';
                    notificationBell.classList.add('allowed');
                    notificationBell.classList.remove('denied');
                    break;
                case 'denied':
                    notificationBell.innerHTML = '🚫';
                    notificationBell.title = 'Notifications Blocked. Click for instructions.';
                    notificationBell.classList.add('denied');
                    notificationBell.classList.remove('allowed');
                    break;
                default:
                    notificationBell.innerHTML = '🔔';
                    notificationBell.title = 'Click to Enable Notifications';
                    notificationBell.classList.remove('allowed', 'denied');
            }
        },

        async handleBellClick() {
            if (Notification.permission === 'denied') {
                showToast('ব্রাউজার সেটিংস থেকে নোটিফিকেশন আনব্লক করতে হবে।', 'info', 4000);
                return;
            }
            
            if (Notification.permission === 'granted') {
                if (confirm('আপনি কি এই ডিভাইস থেকে নোটিফিকেশন পাওয়া বন্ধ করতে চান?')) {
                    await this.deleteToken();
                } else {
                    if (!this.currentToken) await this.getToken(true);
                }
            } else {
                try {
                    const permission = await Notification.requestPermission();
                    if (permission === 'granted') {
                        showToast('নোটিফিকেশন সফলভাবে চালু হয়েছে!', 'success');
                        await this.getToken(true);
                    } else {
                        showToast('নোটিফিকেশন পারমিশন দেওয়া হয়নি।', 'warning');
                    }
                } catch (err) {
                    console.error('Error requesting permission:', err);
                    showToast('অনুমতি চাইতে সমস্যা হয়েছে।', 'error');
                } finally {
                    this.updateUI();
                }
            }
        },

        async getToken(showSuccessToast = true) {
            try {
                const token = await this.messaging.getToken({
                    vapidKey: "BAltqdl3v-mMOgYxCYEegyI6c2uCzLJACA5l-M2JPrJiq_vY_wVEOGO4xM8c_Hk8hERLAy2h4wL3G5IFfjxkRvs",
                    serviceWorkerRegistration: this.registration
                });
                if (token) {
                    this.currentToken = token;
                    console.log('✅ FCM Token received:', this.currentToken);
                    await fcmTokensRef.child(this.studentId).child(this.currentToken).set(true);
                    if (showSuccessToast) {
                        showToast('নোটিফিকেশন চালু হয়েছে।', 'success');
                    }
                } else {
                    console.warn('⚠️ Could not get token.');
                }
            } catch (error) {
                console.error('❌ Error getting token:', error);
                showToast('টোকেন পেতে সমস্যা হয়েছে।', 'error');
            } finally {
                this.updateUI();
            }
        },

        async deleteToken() {
            try {
                if (!this.currentToken) {
                    const tokenInDB = await this.messaging.getToken({ vapidKey: "BAltqdl3v-mMOgYxCYEegyI6c2uCzLJACA5l-M2JPrJiq_vY_wVEOGO4xM8c_Hk8hERLAy2h4wL3G5IFfjxkRvs", serviceWorkerRegistration: this.registration });
                    this.currentToken = tokenInDB;
                }
                
                if (this.currentToken) {
                    await this.messaging.deleteToken();
                    await fcmTokensRef.child(this.studentId).child(this.currentToken).remove();
                    this.currentToken = null;
                    console.log('Token deleted.');
                    showToast('নোটিফিকেশন বন্ধ করা হয়েছে। চালু করতে বেল আইকনে ক্লিক করুন।', 'info');
                } else {
                    showToast('বন্ধ করার জন্য কোনো সক্রিয় টোকেন পাওয়া যায়নি।', 'warning');
                }
            } catch (error) {
                console.error('Error deleting token:', error);
                showToast('নোটিফিকেশন বন্ধ করতে সমস্যা হয়েছে।', 'error');
            }
        },

        handleForegroundMessage(payload) {
            console.log('Foreground message received:', payload);
            showToast(`🔔 ${payload.notification.title}`, 'info', 5000);
            const page = payload.data?.click_action?.split('#')[1];
            if (page) {
                const navItem = document.querySelector(`.nav-item[data-page="${page}"]`);
                if (navItem) navItem.classList.add('has-unseen');
            }
        }
    };
    
    const getSeenItems = () => {
        const key = `mcth_seen_items_${studentData.id}`;
        try {
            const data = JSON.parse(localStorage.getItem(key));
            return data || { lastSeenNoticeTimestamp: 0, seenExamIds: [], lastSeenPaymentTimestamp: 0 };
        } catch (e) {
            return { lastSeenNoticeTimestamp: 0, seenExamIds: [], lastSeenPaymentTimestamp: 0 };
        }
    };

    const updateSeenItems = (newData) => {
        const key = `mcth_seen_items_${studentData.id}`;
        const currentData = getSeenItems();
        const updatedData = { ...currentData, ...newData };
        localStorage.setItem(key, JSON.stringify(updatedData));
    };

    function setupGlobalListeners(studentData) {
        if (noticeListener) noticesRef.off('value', noticeListener);
        const latestNoticeRef = noticesRef.orderByChild('timestamp').limitToLast(1);
        
        noticeListener = latestNoticeRef.on('child_added', (snapshot) => {
            const latestNotice = snapshot.val();
            if (!latestNotice || !latestNotice.timestamp) return;
            
            const seenItems = getSeenItems();
            if (latestNotice.timestamp > seenItems.lastSeenNoticeTimestamp) {
                const studentBatches = (fullAcademicData.batchSchedule || [])
                    .flatMap(day => (day.classes || []).flatMap(cls => (cls.batches || [])))
                    .filter(b => b && !b.deletedAt && (b.studentIds || []).includes(studentData.id))
                    .map(b => b.id);
                
                const forAll = (!latestNotice.targetClassIds || latestNotice.targetClassIds.length === 0) && (!latestNotice.targetBatchIds || latestNotice.targetBatchIds.length === 0);
                const classMatch = latestNotice.targetClassIds && latestNotice.targetClassIds.includes(studentData.classId);
                const batchMatch = latestNotice.targetBatchIds && latestNotice.targetBatchIds.some(bId => studentBatches.includes(bId));

                if (forAll || classMatch || batchMatch) {
                    const noticeTab = document.querySelector('.nav-item[data-page="notice"]');
                    if (noticeTab) noticeTab.classList.add('has-unseen');
                    if (currentPage !== 'notice') {
                        showToast(`নতুন নোটিশ: ${latestNotice.title}`, 'info', 5000);
                    }
                }
            }
        });
    }

    async function loadInitialData() {
        showLoader();
        try {
            const snapshot = await academicYearsRef.child(studentData.academicYear).child('data').once('value');
            fullAcademicData = snapshot.val() || {};
            if (!fullAcademicData.attendance) fullAcademicData.attendance = {};
            if (!fullAcademicData.exams) fullAcademicData.exams = {};
            
            await notificationManager.init();
            setupGlobalListeners(studentData); 
            renderPage(currentPage);
        } catch (error) {
            console.error("Failed to load academic data:", error);
            showToast("আপনার তথ্য লোড করা সম্ভব হয়নি।", "error");
        } finally {
            hideLoader();
        }
    }
    
    function renderPage(pageName, pushState = true) {
        Object.values(activeCharts).forEach(chart => chart.destroy());
        activeCharts = {};
        mainContent.innerHTML = '';
        const templateId = `template-${pageName}`;
        const template = document.getElementById(templateId);
        
        if (template) {
            mainContent.appendChild(template.content.cloneNode(true));
            if(pageName === 'notice') document.querySelector('.nav-item[data-page="notice"]').classList.remove('has-unseen');
            
            const pageRenderers = {
                home: renderHome,
                profile: renderProfile,
                attendance: renderAttendance,
                payment: renderPayment,
                exam: renderExam,
                notice: renderNotice,
                lottery: renderLottery
            };
            if(pageRenderers[pageName]) pageRenderers[pageName]();
        } else {
            mainContent.innerHTML = `<p>Error: Page '${pageName}' not found.</p>`;
        }
        
        navItems.forEach(item => { item.classList.toggle('active', item.dataset.page === pageName); });
        currentPage = pageName;
        if(pushState) { window.history.pushState({ page: pageName }, '', `#${pageName}`); }
    }

    function renderHome() {
        const welcomeEl = document.getElementById('home-welcome');
        if (welcomeEl) welcomeEl.textContent = `স্বাগতম, ${studentData.name}`;
        const summaryContainer = document.getElementById('home-summary-cards');
        if (!summaryContainer) return;
        const presentDays = (Object.values(fullAcademicData.attendance?.records || {}).flatMap(Object.values).filter(br => br[studentData.id]?.status === 'present')).length;
        const totalDue = calculateStudentOutstandingAmount();
        summaryContainer.innerHTML = `<div class="stat-item present"><div class="label">মোট উপস্থিতি</div><div class="value">${presentDays.toLocaleString('bn-BD')} দিন</div></div><div class="stat-item absent"><div class="label">মোট বকেয়া (${studentData.academicYear})</div><div class="value">${totalDue.toLocaleString('bn-BD')} ৳</div></div>`;
        initializeShowcaseSlider();
    }
    
    function renderProfile() {
        const nameHeader = document.getElementById('profileNameHeader');
        if (nameHeader) nameHeader.textContent = studentData.name;
        const profilePhoto = document.getElementById('profilePagePhoto');
        if (profilePhoto) { profilePhoto.src = studentData.photoURL || 'images/default_avatar.png';}
        const fields = { 'profileStudentId': studentData.id, 'profileRoll': studentData.roll, 'profileClass': (fullAcademicData.mainClassCategories?.find(c => c.id === studentData.classId)?.name || 'N/A'), 'profileSchool': studentData.schoolName || 'N/A', 'profileParentContact': studentData.parentContact || 'N/A', 'profileAdmissionDate': new Date(studentData.createdAt).toLocaleDateString('bn-BD') };
        for(const id in fields) { const el = document.getElementById(id); if(el) el.textContent = fields[id]; }
        const batchesContainer = document.getElementById('student-profile-batches');
        if (batchesContainer) {
            batchesContainer.innerHTML = '';
            const studentBatches = (fullAcademicData.batchSchedule || []).filter(d => d && !d.deletedAt).flatMap(day => (day.classes || []).filter(c=> c && !c.deletedAt).flatMap(cls => (cls.batches || []).filter(b => b && !b.deletedAt && (b.studentIds || []).includes(studentData.id)).map(b => `${day.dayName} (${b.time})`)));
            if (studentBatches.length > 0) {
                const ul = document.createElement('ul');
                ul.style.cssText = "list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 8px;";
                studentBatches.forEach(batchText => { const li = document.createElement('li'); li.textContent = batchText; li.style.cssText = "background: var(--bg-section); padding: 8px 12px; border-radius: 6px;"; ul.appendChild(li); });
                batchesContainer.appendChild(ul);
            } else { batchesContainer.textContent = 'কোনো ব্যাচে যুক্ত নেই।'; }
        }
        document.getElementById('btn-view-id').addEventListener('click', () => showIdCardViewer(studentData, fullAcademicData));
    }

    function showIdCardViewer(student, academicData) {
        const template = document.getElementById('template-id-card-viewer');
        if (!template) return;
        
        const existingModal = document.querySelector('.id-card-viewer-modal');
        if (existingModal) existingModal.remove();

        document.body.appendChild(template.content.cloneNode(true));
        const modal = document.querySelector('.id-card-viewer-modal');

        const className = academicData.mainClassCategories?.find(c => c.id === student.classId)?.name || 'N/A';
        const studentBatchesText = (academicData.batchSchedule || [])
            .filter(d => d && !d.deletedAt).flatMap(day => (day.classes || []).filter(c=> c && !c.deletedAt).flatMap(cls => (cls.batches || []).filter(b => b && !b.deletedAt && (b.studentIds || []).includes(student.id)).map(b => `${day.dayName} (${b.time})`))).join(', ');

        modal.querySelector('#id-card-photo').src = student.photoURL || 'images/default_avatar.png';
        modal.querySelector('#id-card-name').textContent = student.name || 'N/A';
        modal.querySelector('#id-card-school').textContent = student.schoolName || 'N/A';
        modal.querySelector('#id-card-class').textContent = className;
        modal.querySelector('#id-card-section').textContent = student.section || 'N/A';
        modal.querySelector('#id-card-roll').textContent = student.roll || 'N/A';
        modal.querySelector('#id-card-contact').textContent = student.contact || student.parentContact || 'N/A';
        modal.querySelector('#id-card-batch').textContent = studentBatchesText.split(', ')[0] || 'N/A';
        modal.querySelector('#id-card-sid').textContent = student.id || 'N/A';

        const qrContainer = modal.querySelector('#id-card-qr-container');
        qrContainer.innerHTML = ''; 
        new QRCode(qrContainer, {
            text: `https://miracle-bogura.web.app/verify?id=${student.id}`,
            width: 128,
            height: 128,
            correctLevel: QRCode.CorrectLevel.H
        });

        modal.classList.add('visible');

        const closeModal = () => modal.remove();
        modal.querySelector('.id-card-viewer-close-btn').onclick = closeModal;
        modal.querySelector('#id-card-download-btn').onclick = () => downloadIdCardAsPdf(student.id);
        modal.onclick = (e) => { if (e.target === modal) closeModal(); };
    }

    async function downloadIdCardAsPdf(studentId) {
        showLoader();
        try {
            const { jsPDF } = window.jspdf;
            const frontCardElement = document.getElementById('id-card-front');
            const backCardElement = document.getElementById('id-card-back');

            const frontCanvas = await html2canvas(frontCardElement, { scale: 3 });
            const backCanvas = await html2canvas(backCardElement, { scale: 3 });

            const frontDataUrl = frontCanvas.toDataURL('image/jpeg', 0.95);
            const backDataUrl = backCanvas.toDataURL('image/jpeg', 0.95);

            const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: [54, 86] });
            
            doc.addImage(frontDataUrl, 'JPEG', 0, 0, 54, 86);
            doc.addPage();
            doc.addImage(backDataUrl, 'JPEG', 0, 0, 54, 86);
            
            doc.save(`Miracle_ID_Card_${studentId}.pdf`);

        } catch (error) {
            console.error("Error generating PDF from canvas:", error);
            showToast('PDF তৈরি করতে সমস্যা হয়েছে।', 'error');
        } finally {
            hideLoader();
        }
    }

    function showAboutDeveloperModal() {
        const modalTemplate = document.getElementById('template-about-dev-modal');
        if (!modalTemplate) return;
        document.body.appendChild(modalTemplate.content.cloneNode(true));
        const modal = document.getElementById('aboutDeveloperModal');
        const closeBtn = modal.querySelector('.modal-close-btn');
        const closeModal = () => modal.remove();
        closeBtn.onclick = closeModal;
        modal.onclick = (e) => { if (e.target === modal) closeModal(); };
        modal.classList.add('visible');
    }

    function processStudentAttendanceData(studentId) {
        const allRecords = fullAcademicData.attendance?.records || {};
        let presentCount = 0, absentCount = 0, totalClasses = 0;
        const studentAbsenceByDay = { 0:0, 1:0, 2:0, 3:0, 4:0, 5:0, 6:0 };
        const batchAverages = {}; 
        const studentBatches = new Set();
        (fullAcademicData.batchSchedule || []).forEach(day => { if (day && !day.deletedAt) { (day.classes || []).forEach(cls => { if (cls && !cls.deletedAt) { (cls.batches || []).forEach(batch => { if (batch && !batch.deletedAt && batch.studentIds && batch.studentIds.includes(studentId)) { studentBatches.add(batch.id); } }); } }); } });
        for (const date in allRecords) {
            const dayOfWeek = new Date(date).getUTCDay();
            for (const batchId of studentBatches) {
                if(allRecords[date][batchId]) {
                    const batchRecord = allRecords[date][batchId];
                    if (!batchAverages[batchId]) batchAverages[batchId] = { totalPresents: 0, totalRecords: 0 };
                    Object.values(batchRecord).forEach(rec => { batchAverages[batchId].totalRecords++; if (rec.status === 'present') batchAverages[batchId].totalPresents++; });
                    if (batchRecord[studentId]) { totalClasses++; if (batchRecord[studentId].status === 'present') { presentCount++; } else if (batchRecord[studentId].status === 'absent') { absentCount++; studentAbsenceByDay[dayOfWeek]++; } }
                }
            }
        }
        const studentPercentage = totalClasses > 0 ? (presentCount / totalClasses * 100) : 0;
        let overallBatchPresents = 0, overallBatchRecords = 0;
        Object.values(batchAverages).forEach(b => { overallBatchPresents += b.totalPresents; overallBatchRecords += b.totalRecords; });
        const overallBatchAvg = overallBatchRecords > 0 ? (overallBatchPresents / overallBatchRecords * 100) : 0;
        const dayLabels = ['রবি', 'সোম', 'মঙ্গল', 'বুধ', 'বৃহঃ', 'শুক্র', 'শনি'];
        const dayData = dayLabels.map((_, i) => studentAbsenceByDay[i]);
        if (totalClasses === 0) return null;
        return { presentCount, absentCount, totalClasses, studentPercentage, overallBatchAvg, dayData, dayLabels };
    }

    function renderAttendance() {
        const records = fullAcademicData.attendance?.records || {};
        let presentCount = 0, absentCount = 0;
        for (const date in records) { for (const batchId in records[date]) { if (records[date][batchId][studentData.id]) { const status = records[date][batchId][studentData.id].status; if (status === 'present') presentCount++; else if (status === 'absent') absentCount++; } } }
        const totalClasses = presentCount + absentCount;
        const percentage = totalClasses > 0 ? ((presentCount / totalClasses) * 100).toFixed(1) : 0;
        const summaryContainer = document.getElementById('attendance-summary-cards');
        if (summaryContainer) { summaryContainer.innerHTML = `<div class="stat-item"><div class="label">মোট ক্লাস</div><div class="value">${totalClasses.toLocaleString('bn-BD')}</div></div><div class="stat-item present"><div class="label">উপস্থিত</div><div class="value">${presentCount.toLocaleString('bn-BD')}</div></div><div class="stat-item absent"><div class="label">অনুপস্থিত</div><div class="value">${absentCount.toLocaleString('bn-BD')}</div></div><div class="stat-item present"><div class="label">উপস্থিতি %</div><div class="value">${percentage.toLocaleString('bn-BD')}%</div></div>`; }
        let currentDate = new Date();
        const renderCalendar = (date) => {
            const month = date.getMonth(), year = date.getFullYear();
            const monthYearEl = document.getElementById('calendarMonthYear');
            if(monthYearEl) monthYearEl.textContent = date.toLocaleDateString('bn-BD', { month: 'long', year: 'numeric' });
            const calendarDays = document.getElementById('calendar-days');
            if(!calendarDays) return;
            calendarDays.innerHTML = '';
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let i = 0; i < firstDayOfMonth; i++) calendarDays.innerHTML += `<div></div>`;
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                let dayClass = ''; let status = null; const recordsForDay = records[dateStr];
                if (recordsForDay) { for (const batchId in recordsForDay) { if (recordsForDay[batchId][studentData.id]) { status = recordsForDay[batchId][studentData.id].status; break; } } }
                if (status === 'present') dayClass = 'day-present'; else if (status === 'absent') dayClass = 'day-absent';
                calendarDays.innerHTML += `<div class="calendar-day ${dayClass}">${day.toLocaleString('bn-BD')}</div>`;
            }
        };
        const prevMonthBtn = document.getElementById('prevMonthBtn');
        const nextMonthBtn = document.getElementById('nextMonthBtn');
        if(prevMonthBtn) prevMonthBtn.onclick = () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(currentDate); };
        if(nextMonthBtn) nextMonthBtn.onclick = () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(currentDate); };
        renderCalendar(currentDate);
        const analysisData = processStudentAttendanceData(studentData.id);
        const analysisContainer = document.getElementById('analysis-section-container');
        if (!analysisData) { analysisContainer.innerHTML = '<h3>বিশ্লেষণ</h3><p style="text-align:center; color: var(--text-secondary);">বিশ্লেষণের জন্য পর্যাপ্ত তথ্য নেই।</p>'; return; }
        const chartTextColor = getComputedStyle(document.body).getPropertyValue('--text-primary');
        const successColor = getComputedStyle(document.body).getPropertyValue('--success-color').trim();
        const dangerColor = getComputedStyle(document.body).getPropertyValue('--danger-color').trim();
        const specialColor = getComputedStyle(document.body).getPropertyValue('--special-color').trim();
        activeCharts.personal = new Chart(document.getElementById('personalAttendanceChart'), { type: 'doughnut', data: { labels: ['উপস্থিত', 'অনুপস্থিত'], datasets: [{ data: [analysisData.presentCount, analysisData.absentCount], backgroundColor: [successColor, dangerColor], borderColor: 'var(--bg-section)', borderWidth: 4 }] }, options: { responsive: true, plugins: { legend: { position: 'top', labels: { color: chartTextColor } } } } });
        activeCharts.comparison = new Chart(document.getElementById('comparisonChart'), { type: 'bar', data: { labels: ['আপনার', 'ব্যাচের গড়'], datasets: [{ label: 'অ্যাটেনডেন্স %', data: [analysisData.studentPercentage, analysisData.overallBatchAvg], backgroundColor: [specialColor, 'var(--border-accent)'] }] }, options: { responsive: true, indexAxis: 'y', scales: { x: { beginAtZero: true, max: 100, ticks: { color: chartTextColor, callback: val => val + '%' } }, y: { ticks: { color: chartTextColor }}}, plugins: { legend: { display: false } } } });
        activeCharts.absencePattern = new Chart(document.getElementById('studentDayAbsenceChart'), { type: 'bar', data: { labels: analysisData.dayLabels, datasets: [{ label: 'অনুপস্থিতির দিন', data: analysisData.dayData, backgroundColor: dangerColor }] }, options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { stepSize: 1, color: chartTextColor } }, x: { ticks: { color: chartTextColor }} }, plugins: { legend: { display: false } } } });
    }

    function renderPayment() {
        document.querySelector('.nav-item[data-page="payment"]').classList.remove('has-unseen');
        const allPayments = [];
        if(studentData.admissionFee?.status === 'paid') allPayments.push({ date: new Date(studentData.admissionFee.date)});
        Object.entries(studentData.monthlyPayments || {}).forEach(([_, payment]) => { if(payment.status === 'paid') allPayments.push({ date: new Date(payment.date) }); });
        if (allPayments.length > 0) {
            const latestPaymentTimestamp = Math.max(...allPayments.map(p => p.date.getTime()));
            updateSeenItems({ lastSeenPaymentTimestamp: latestPaymentTimestamp });
        }

        const paymentYearEl = document.getElementById('payment-year');
        if(paymentYearEl) paymentYearEl.textContent = studentData.academicYear.toLocaleString('bn-BD');
        const chartContainer = document.getElementById('yearly-payment-chart');
        const tableBody = document.getElementById('payment-history-table');
        chartContainer.innerHTML = ''; tableBody.innerHTML = ''; let upcomingMonth = null;
        const admissionDate = new Date(studentData.createdAt);
        BENGALI_MONTHS.forEach((month, index) => {
            const monthBox = document.createElement('div'); monthBox.className = 'month-box';
            const monthNameDiv = document.createElement('div'); monthNameDiv.className = 'month-name'; monthNameDiv.textContent = month; monthBox.appendChild(monthNameDiv);
            const statusDiv = document.createElement('div'); statusDiv.className = 'month-status';
            const monthStartDate = new Date(studentData.academicYear, index, 1);
            if (monthStartDate < new Date(admissionDate.getFullYear(), admissionDate.getMonth(), 1)) { statusDiv.classList.add('not-applicable'); statusDiv.textContent = 'N/A'; }
            else {
                const payment = studentData.monthlyPayments?.[month];
                if (payment?.status === 'paid') { statusDiv.classList.add('paid'); statusDiv.textContent = 'Paid'; }
                else if (new Date() > monthStartDate) { statusDiv.classList.add('due'); statusDiv.textContent = 'Due'; if (!upcomingMonth) upcomingMonth = month; }
                else { statusDiv.classList.add('future'); statusDiv.textContent = 'Future'; if (!upcomingMonth) upcomingMonth = month; }
            }
            monthBox.appendChild(statusDiv); chartContainer.appendChild(monthBox);
        });
        const upcomingPaymentSection = document.getElementById('upcoming-payment-section');
        if(upcomingMonth) { upcomingPaymentSection.innerHTML = `<div class="upcoming-payment-card"><h4>আসন্ন পেমেন্ট</h4><div class="month">${upcomingMonth}</div></div>`; upcomingPaymentSection.classList.remove('hidden'); }
        
        allPayments.sort((a, b) => b.date - a.date);
        const paymentList = [];
        if(studentData.admissionFee?.status === 'paid') paymentList.push({ date: new Date(studentData.admissionFee.date), description: 'ভর্তি ফি', amount: studentData.admissionFee.amount, token: studentData.admissionFee.token });
        Object.entries(studentData.monthlyPayments || {}).forEach(([month, payment]) => { if(payment.status === 'paid') paymentList.push({ date: new Date(payment.date), description: `${month} মাসের ফি`, amount: payment.fee, token: payment.token }); });
        paymentList.sort((a,b) => b.date - a.date);

        if (paymentList.length === 0) tableBody.innerHTML = `<tr><td colspan="4" style="text-align:center;">কোনো লেনদেনের তথ্য নেই।</td></tr>`;
        else paymentList.forEach(p => tableBody.innerHTML += `<tr><td>${p.date.toLocaleDateString('bn-BD')}</td><td>${p.description}</td><td>${p.amount.toLocaleString('bn-BD')} ৳</td><td>${p.token || 'N/A'}</td></tr>`);
    }

    async function renderExam() {
        document.querySelector('.nav-item[data-page="exam"]').classList.remove('has-unseen');
        const studentExams = Object.values(fullAcademicData.exams || {}).filter(exam => exam && exam.results && exam.results[studentData.id] !== undefined);
        const studentExamIds = studentExams.map(exam => Object.keys(fullAcademicData.exams).find(key => fullAcademicData.exams[key] === exam));
        updateSeenItems({ seenExamIds: studentExamIds });

        const container = document.getElementById('exam-list-container');
        container.innerHTML = '<div class="page-section"><p style="text-align:center;">ফলাফল লোড হচ্ছে...</p></div>';
        const now = new Date(); const lastFetchTime = lastExamDataFetch ? new Date(lastExamDataFetch) : null; let shouldRefresh = true;
        if(lastFetchTime) { const today3AM = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 3, 0, 0); if (now < today3AM && lastFetchTime >= new Date(today3AM.getTime() - 24 * 60 * 60 * 1000)) { shouldRefresh = false; } else if (now >= today3AM && lastFetchTime >= today3AM) { shouldRefresh = false; } }
        if (shouldRefresh || !examDataCache) { try { const snapshot = await academicYearsRef.child(studentData.academicYear).child('data/exams').once('value'); examDataCache = snapshot.val() || {}; lastExamDataFetch = now.toISOString(); localStorage.setItem('mcth_last_exam_fetch', lastExamDataFetch); } catch(e) { console.error(e); showToast("পরীক্ষার তথ্য লোড করা যায়নি।", "error"); } }
        const exams = examDataCache || {};
        const filteredStudentExams = Object.values(exams).filter(exam => exam && !exam.deletedAt && exam.results && exam.results[studentData.id] !== undefined);
        container.innerHTML = '';
        if (filteredStudentExams.length === 0) { container.innerHTML = `<div class="page-section"><p style="text-align:center; color:var(--text-secondary);">আপনি এখনো কোনো পরীক্ষায় অংশগ্রহণ করেননি।</p></div>`; return; }
        filteredStudentExams.sort((a,b) => new Date(b.date) - new Date(a.date));
        filteredStudentExams.forEach(exam => {
            const cardWrapper = document.createElement('div'); cardWrapper.className = 'exam-card'; const studentMark = exam.results[studentData.id];
            const studentBatches = (fullAcademicData.batchSchedule || []).flatMap(d => d.classes || []).flatMap(c => c.batches || []).filter(b => (b.studentIds || []).includes(studentData.id)).map(b => b.id);
            const batchParticipants = Object.keys(exam.results || {}).filter(id => { const participantBatches = (fullAcademicData.batchSchedule || []).flatMap(d => d.classes || []).flatMap(c => c.batches || []).filter(b => (b.studentIds || []).includes(id)).map(b => b.id); return studentBatches.some(b => participantBatches.includes(b)); });
            let position = "N/A", highestMark = "N/A", averageMark = "N/A";
            if (batchParticipants.length > 0) {
                const batchResults = batchParticipants.map(id => exam.results[id]).filter(m => m != null).sort((a, b) => b - a);
                if (batchResults.length > 0) { highestMark = batchResults[0]; const rank = batchResults.indexOf(studentMark) + 1; position = `${rank.toLocaleString('bn-BD')}/${batchResults.length.toLocaleString('bn-BD')}`; averageMark = (batchResults.reduce((a, b) => a + b, 0) / batchResults.length).toFixed(2); }
            }
            const examId = Object.keys(exams).find(key => exams[key] === exam); const graphContainerId = `graph-${examId}`; const graphCanvasId = `canvas-${examId}`;
            cardWrapper.innerHTML = `<div class="exam-card-content"><h4>${exam.name}</h4><p style="font-size: 0.9em; color: var(--text-secondary);">${new Date(exam.date).toLocaleDateString('bn-BD')}</p><div class="exam-stats-grid"><span>প্রাপ্ত নম্বর: <strong>${studentMark !== null ? `${parseFloat(studentMark).toLocaleString('bn-BD')}/${parseFloat(exam.totalMarks).toLocaleString('bn-BD')}` : '<span class="result-pending">মূল্যায়ন হয়নি</span>'}</strong></span><span>ব্যাচে পজিশন: <strong>${position}</strong></span><span>ব্যাচের সর্বোচ্চ: <strong>${parseFloat(highestMark).toLocaleString('bn-BD')}</strong></span><button class="graph-toggle-btn" data-target="${graphContainerId}">গ্রাফ দেখুন</button></div></div><div class="graph-container" id="${graphContainerId}"><canvas id="${graphCanvasId}"></canvas></div>`;
            container.appendChild(cardWrapper);
            cardWrapper.querySelector('.graph-toggle-btn').addEventListener('click', (e) => {
                const btn = e.target; const targetId = btn.dataset.target; const graphContainer = document.getElementById(targetId); const canvasId = `canvas-${examId}`;
                if (graphContainer.style.display === 'block') { graphContainer.style.display = 'none'; btn.textContent = 'গ্রাফ দেখুন'; if(activeCharts[canvasId]) { activeCharts[canvasId].destroy(); delete activeCharts[canvasId]; } }
                else { graphContainer.style.display = 'block'; btn.textContent = 'গ্রাফ লুকান'; if (studentMark !== null) { renderExamChart(canvasId, parseFloat(studentMark), parseFloat(highestMark), parseFloat(averageMark)); } }
            });
        });
    }

    function renderExamChart(canvasId, studentMark, highestMark, averageMark) { if(activeCharts[canvasId]) { activeCharts[canvasId].destroy(); } const ctx = document.getElementById(canvasId).getContext('2d'); activeCharts[canvasId] = new Chart(ctx, { type: 'bar', data: { labels: ['আপনার নম্বর', 'ব্যাচের সর্বোচ্চ', 'ব্যাচের গড়'], datasets: [{ label: 'নম্বরের তুলনা', data: [studentMark, highestMark, averageMark], backgroundColor: ['var(--special-color)', 'var(--accent-green)', 'var(--warning-color)'], borderWidth: 0 }] }, options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { color: 'var(--text-primary)' } }, x: { ticks: { color: 'var(--text-primary)' } } } } }); }
    
    function calculateStudentOutstandingAmount() { let totalDue = 0; const student = studentData; if (!student || student.deletedAt) return 0; const admissionDate = student.createdAt ? new Date(student.createdAt) : new Date(student.academicYear, 0, 1); if (student.admissionFee?.status !== 'paid' && student.admissionFee?.amount > 0) { totalDue += student.admissionFee.amount; } const now = new Date(); const currentMonthIndex = now.getMonth(); const currentYear = now.getFullYear(); if (parseInt(student.academicYear) === currentYear) { for (let i = 0; i <= currentMonthIndex; i++) { const monthDate = new Date(student.academicYear, i, 1); if (monthDate < new Date(admissionDate.getFullYear(), admissionDate.getMonth(), 1)) continue; const monthName = BENGALI_MONTHS[i]; const payment = student.monthlyPayments?.[monthName]; const defaultFee = student.monthlyFeeDefault || 0; if ((!payment || payment.status !== 'paid') && defaultFee > 0) { totalDue += defaultFee; } } } else if (parseInt(student.academicYear) < currentYear) { for (let i = 0; i < 12; i++) { const monthDate = new Date(student.academicYear, i, 1); if (monthDate < new Date(admissionDate.getFullYear(), admissionDate.getMonth(), 1)) continue; const monthName = BENGALI_MONTHS[i]; const payment = student.monthlyPayments?.[monthName]; const defaultFee = student.monthlyFeeDefault || 0; if ((!payment || payment.status !== 'paid') && defaultFee > 0) { totalDue += defaultFee; } } } return totalDue; }
    
    async function renderLottery() {
        const monthSelector = document.getElementById('lottery-month-selector');
        const pinnedContainer = document.getElementById('latest-lottery-result-pinned');
        
        if (!monthSelector || !pinnedContainer) return;
        
        monthSelector.innerHTML = '';
        BENGALI_MONTHS.forEach((month) => {
            const option = new Option(month, month);
            monthSelector.add(option);
        });

        const allResultsSnapshot = await academicYearsRef.child(`${studentData.academicYear}/data/lotteryResults`).once('value');
        let latestMonthWithResult = null;
        if(allResultsSnapshot.exists()) {
            const allResults = allResultsSnapshot.val();
            const monthsWithResults = Object.keys(allResults).sort((a, b) => BENGALI_MONTHS.indexOf(b) - BENGALI_MONTHS.indexOf(a));
            if(monthsWithResults.length > 0) {
                 latestMonthWithResult = monthsWithResults[0];
            }
        }
        
        monthSelector.value = latestMonthWithResult || BENGALI_MONTHS[new Date().getMonth()];

        if(latestMonthWithResult) {
            await displayLotteryResults(latestMonthWithResult, true);
        } else {
             pinnedContainer.style.display = 'none';
        }
        
        await displayLotteryResults(monthSelector.value, false);

        monthSelector.addEventListener('change', () => {
            displayLotteryResults(monthSelector.value, false);
        });
    }

    async function displayLotteryResults(month, isPinnedView = false) {
        const container = isPinnedView ? document.getElementById('latest-lottery-result-pinned') : document.getElementById('lottery-results-container');
        if (!container) return;

        container.innerHTML = `<p style="text-align:center;">${month} মাসের ফলাফল লোড হচ্ছে...</p>`;
        
        try {
            const studentBatches = (fullAcademicData.batchSchedule || [])
                .flatMap(day => (day.classes || []).flatMap(cls => (cls.batches || [])))
                .filter(b => b && !b.deletedAt && (b.studentIds || []).includes(studentData.id))
                .map(b => b.id);

            if (studentBatches.length === 0 && !isPinnedView) {
                container.innerHTML = '<p style="text-align:center;">আপনি কোনো ব্যাচে অন্তর্ভুক্ত নন, তাই লটারির ফলাফল দেখা সম্ভব নয়।</p>';
                return;
            }

            const snapshot = await academicYearsRef.child(`${studentData.academicYear}/data/lotteryResults/${month}`).once('value');
            if (!snapshot.exists()) {
                container.innerHTML = `<p style="text-align:center; color: var(--text-secondary);">${month} মাসের জন্য এখনো কোনো লটারি অনুষ্ঠিত হয়নি।</p>`;
                if(isPinnedView) container.style.display = 'none';
                return;
            }
            const allBatchResults = snapshot.val();
            const relevantResults = [];

            for (const batchId in allBatchResults) {
                if (studentBatches.includes(batchId)) {
                    let batchDetails = null;
                    for (const day of fullAcademicData.batchSchedule || []) {
                        for (const cls of day.classes || []) {
                            const foundBatch = (cls.batches || []).find(b => b.id === batchId);
                            if (foundBatch) {
                                const className = (fullAcademicData.mainClassCategories.find(c => c.id === cls.classId) || {}).name;
                                batchDetails = { name: `${className} - ${day.dayName} (${foundBatch.time})`, ...allBatchResults[batchId] };
                                break;
                            }
                        }
                        if (batchDetails) break;
                    }
                    if (batchDetails) relevantResults.push(batchDetails);
                }
            }
            
            if (relevantResults.length === 0) {
                 container.innerHTML = `<p style="text-align:center; color: var(--text-secondary);">${month} মাসে আপনার ব্যাচের জন্য কোনো লটারি অনুষ্ঠিত হয়নি।</p>`;
                 if(isPinnedView) container.style.display = 'none';
                return;
            }

            let resultsHtml = '';
            relevantResults.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach(result => {
                const lotteryDate = new Date(result.timestamp).toLocaleString('bn-BD', { day: 'numeric', month: 'long', year: 'numeric', hour: 'numeric', minute: '2-digit' });
                const winnersHtml = (result.winners || []).map(winner => 
                    `<li class="winner-item"><strong>${winner.position}</strong><span>${winner.name} (রোল: ${winner.roll})</span></li>`
                ).join('');

                const cardClass = isPinnedView ? "lottery-result-box pinned" : "lottery-result-box";
                const cardTitle = isPinnedView ? `সর্বশেষ ফলাফল (${month})` : `${result.name}`;

                resultsHtml += `
                    <div class="${cardClass}">
                        <h3>${cardTitle}</h3>
                        <p><strong>অনুষ্ঠিত হয়েছে:</strong> ${lotteryDate}</p>
                        <ul class="winner-list">${winnersHtml}</ul>
                    </div>`;
            });
            
            container.innerHTML = resultsHtml;
            if(isPinnedView && relevantResults.length > 0) {
                container.style.display = 'block';
            }

        } catch (error) {
            console.error("Error fetching lottery results:", error);
            container.innerHTML = '<p style="text-align:center; color: var(--due-text);">ফলাফল লোড করার সময় একটি সমস্যা হয়েছে।</p>';
        }
    }

    function createNoticeCard(notice, isLatest) {
        const date = new Date(notice.timestamp);
        const formattedDate = date.toLocaleString('bn-BD', { day: 'numeric', month: 'long', year: 'numeric', hour: 'numeric', minute: '2-digit' });
        const cardClass = isLatest ? 'page-section latest-notice-card' : 'notice-card';
        const titleHeader = isLatest ? 'h3' : 'h4';
        const imageHtml = notice.imageUrl ? `<img src="${notice.imageUrl}" alt="Notice Image" class="notice-image" data-full-image="${notice.imageUrl}">` : '';
        const timeAgoText = timeAgo(notice.timestamp);

        return `
            <div class="${cardClass}">
                <div class="notice-header">
                    <${titleHeader}>${notice.title} ${isLatest ? '<span class="new-badge">Latest</span>' : ''}</${titleHeader}>
                    <span class="notice-time-ago">${timeAgoText}</span>
                </div>
                <p class="notice-content">${notice.content}</p>
                ${imageHtml}
                <p class="notice-timestamp">${formattedDate}</p>
            </div>
        `;
    }

    function showImageModal(src) {
        if (!document.getElementById('image-viewer-modal')) {
            const modalTemplate = document.getElementById('template-image-viewer-modal');
            if(modalTemplate) document.body.appendChild(modalTemplate.content.cloneNode(true));
        }
        const modal = document.getElementById('image-viewer-modal');
        if(modal) {
            document.getElementById('modal-image-content').src = src;
            modal.classList.add('visible');
            const closeModal = () => modal.classList.remove('visible');
            modal.querySelector('.modal-close-btn').onclick = closeModal;
            modal.onclick = (e) => { if (e.target === modal) closeModal(); };
        }
    }

    function renderMoreNotices() {
        const historyContainer = document.getElementById('notice-history-container');
        const loadMoreContainer = document.getElementById('load-more-container');
        
        const noticesToRender = allRelevantNotices.slice(noticesRenderedCount, noticesRenderedCount + NOTICES_PER_PAGE);
        
        if (noticesToRender.length === 0 && noticesRenderedCount === 0) {
            historyContainer.innerHTML = '<p style="text-align: center;">আপনার জন্য কোনো পুরনো নোটিশ নেই।</p>';
        } else {
            const noticesHtml = noticesToRender.map(notice => createNoticeCard(notice, false)).join('');
            historyContainer.innerHTML += noticesHtml;
        }

        noticesRenderedCount += noticesToRender.length;

        loadMoreContainer.innerHTML = '';
        if (noticesRenderedCount < allRelevantNotices.length) {
            const loadMoreBtn = document.createElement('button');
            loadMoreBtn.id = 'load-more-notices-btn';
            loadMoreBtn.textContent = 'পুরনো নোটিশ দেখুন';
            loadMoreBtn.onclick = renderMoreNotices;
            loadMoreContainer.appendChild(loadMoreBtn);
        }

        document.querySelectorAll('.notice-image').forEach(img => {
            img.addEventListener('click', (e) => {
                const fullImageSrc = e.target.dataset.fullImage;
                if(fullImageSrc) showImageModal(fullImageSrc);
            });
        });
    }

    async function renderNotice() {
        document.querySelector('.nav-item[data-page="notice"]').classList.remove('has-unseen');
        const latestContainer = document.getElementById('latest-notice-container');
        const historyContainer = document.getElementById('notice-history-container');
        latestContainer.innerHTML = '';
        historyContainer.innerHTML = '<p style="text-align:center;">নোটিশ লোড হচ্ছে...</p>';
        
        try {
            if (noticeListener) noticesRef.off('value', noticeListener);

            noticeListener = noticesRef.orderByChild('timestamp').limitToLast(50).on('value', (snapshot) => {
                latestContainer.innerHTML = ''; 
                historyContainer.innerHTML = '';

                if (!snapshot.exists()) {
                    historyContainer.innerHTML = '<p style="text-align: center;">কোনো নোটিশ পাওয়া যায়নি।</p>';
                    return;
                }

                const fetchedNotices = [];
                snapshot.forEach(child => { fetchedNotices.push({ id: child.key, ...child.val() }); });

                const studentBatches = (fullAcademicData.batchSchedule || []).flatMap(day => (day.classes || []).flatMap(cls => (cls.batches || []))).filter(b => b && !b.deletedAt && (b.studentIds || []).includes(studentData.id)).map(b => b.id);
                const filteredNotices = fetchedNotices.filter(notice => {
                    if (notice.targetYear && notice.targetYear.toString() !== studentData.academicYear.toString()) return false;
                    
                    const forAll = (!notice.targetClassIds || notice.targetClassIds.length === 0) && (!notice.targetBatchIds || notice.targetBatchIds.length === 0);
                    if (forAll && !notice.targetYear) return true;
                    if (forAll && notice.targetYear) return true;
                    
                    const classMatch = notice.targetClassIds && notice.targetClassIds.includes(studentData.classId);
                    const batchMatch = notice.targetBatchIds && notice.targetBatchIds.some(bId => studentBatches.includes(bId));
                    return classMatch || batchMatch;
                }).sort((a, b) => b.timestamp - a.timestamp);

                if (filteredNotices.length === 0) {
                    historyContainer.innerHTML = '<p style="text-align: center;">আপনার জন্য কোনো নোটিশ নেই।</p>';
                    return;
                }

                updateSeenItems({ lastSeenNoticeTimestamp: filteredNotices[0].timestamp });

                const latestNotice = filteredNotices.shift();
                latestContainer.innerHTML = createNoticeCard(latestNotice, true);
                
                allRelevantNotices = filteredNotices;
                noticesRenderedCount = 0;

                renderMoreNotices();
                
            }, (error) => {
                 console.error("Firebase read failed:", error);
                 historyContainer.innerHTML = '<p style="text-align: center; color: var(--due-text);">নোটিশ লোড করা সম্ভব হয়নি।</p>';
            });

        } catch (error) {
            console.error("Error setting up notice listener:", error);
            historyContainer.innerHTML = '<p style="text-align: center; color: var(--due-text);">নোটিশ লোড করা সম্ভব হয়নি।</p>';
        }
    }
    
    function initializeShowcaseSlider() {
        const showcaseContainer = document.getElementById('home-image-showcase');
        if (!showcaseContainer) return;

        const images = [ 'images/image3.png', 'images/image4.png', 'images/image7.png', 'images/image8.png', 'images/image9.png' ];
        let slideHtml = '';
        let dotsHtml = '';
        images.forEach((src, index) => {
            const activeClass = index === 0 ? ' active' : '';
            slideHtml += `<div class="slide${activeClass}"><img src="${src}" alt="Showcase image ${index + 1}"></div>`;
            dotsHtml += `<span class="dot${activeClass}" data-slide-to="${index}"></span>`;
        });
        showcaseContainer.innerHTML = `<div class="slideshow-container">${slideHtml}</div><div class="slideshow-dots">${dotsHtml}</div>`;

        let slideIndex = 0;
        let slideInterval;
        const slides = showcaseContainer.getElementsByClassName("slide");
        const dots = showcaseContainer.getElementsByClassName("dot");
        const slider = showcaseContainer.querySelector('.slideshow-container');

        function showSlides(n) {
            slides[slideIndex].classList.remove('active');
            dots[slideIndex].classList.remove('active');
            slideIndex = (n >= slides.length) ? 0 : (n < 0 ? slides.length - 1 : n);
            slides[slideIndex].classList.add('active');
            dots[slideIndex].classList.add('active');
        }

        function autoSlide() { showSlides(slideIndex + 1); }
        function startSlider() { stopSlider(); slideInterval = setInterval(autoSlide, 3000); }
        function stopSlider() { clearInterval(slideInterval); }
        startSlider();

        for (let dot of dots) {
            dot.addEventListener('click', (e) => { showSlides(parseInt(e.target.dataset.slideTo)); startSlider(); });
        }
        
        let touchstartX = 0;
        slider.addEventListener('touchstart', e => { touchstartX = e.changedTouches[0].screenX; stopSlider(); });
        slider.addEventListener('touchend', e => {
            if (e.changedTouches[0].screenX < touchstartX - 50) showSlides(slideIndex + 1);
            if (e.changedTouches[0].screenX > touchstartX + 50) showSlides(slideIndex - 1);
            startSlider();
        });
    }

    navItems.forEach(item => { item.addEventListener('click', () => renderPage(item.dataset.page)); });
    menuToggleBtn.addEventListener('click', (e) => { e.stopPropagation(); profileMenu.classList.toggle('active'); });
    document.body.addEventListener('click', () => profileMenu.classList.remove('active'));
    document.getElementById('btn-view-profile').addEventListener('click', () => { profileMenu.classList.remove('active'); renderPage('profile'); });
    document.getElementById('btn-about-dev').addEventListener('click', () => { profileMenu.classList.remove('active'); showAboutDeveloperModal(); });
    document.getElementById('btn-logout').addEventListener('click', () => { localStorage.removeItem('mcth_student_session'); sessionStorage.removeItem('mcth_student_session'); firebase.auth().signOut().then(() => location.reload()); });

    loadInitialData();
}

</script>
</body>
</html>
