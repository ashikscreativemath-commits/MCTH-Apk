--- START OF FILE portaladmin.html ---

<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Miracle Admin Portal</title>
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">

    <!-- FIREBASE SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    
    <!-- LIBRARIES for PDF ID Card Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        @font-face {
          font-family: 'Kalpurush';
          src: url('fonts/kalpurush.ttf') format('truetype');
        }
        
        :root {
            --bg-main: #e8f5e9; 
            --bg-section: #ffffff;
            --bg-header: #00695c;
            --text-primary: #212121;
            --text-secondary: #757575;
            --text-header: #ffffff;
            --border-color: #e0e0e0;
            --border-accent: #ff9f43; /* Main Orange */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.1);
            --danger-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #feca57;
            --special-color: #ff9f43; /* Orange */
            --info-color: #3498db;
            --toast-success-bg: #27ae60;
            --toast-error-bg: #e74c3c;
            --toast-info-bg: #3498db;
            --footer-bg: #00695c;
            --footer-text: #e0f2f1;
        }

        html { scroll-behavior: smooth; }
        body { margin: 0; padding: 0; font-family: 'Kalpurush', sans-serif; background-color: var(--bg-main); color: var(--text-primary); }
        .hidden { display: none !important; }

        /* Login Page Styles */
        #login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; background-color: var(--bg-main); padding: 15px; box-sizing: border-box; }
        .login-box { background-color: var(--bg-section); padding: 40px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; border: 1px solid var(--border-color); }
        .login-logo { width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--border-accent); object-fit: cover; margin: 0 auto 20px; }
        .login-box h1 { color: var(--text-primary); font-size: 1.8em; margin-bottom: 25px; }
        .login-input-group { position: relative; margin-bottom: 20px; }
        .login-input-group input { width: 100%; padding: 15px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1em; background-color: var(--bg-main); color: var(--text-primary); box-sizing: border-box; }
        .login-options { display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; margin-bottom: 25px; color: var(--text-secondary); }
        .login-button { width: 100%; padding: 15px; border: none; border-radius: 8px; background: linear-gradient(45deg, var(--border-accent), #e67e22); color: white; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: all 0.3s; }
        .login-button:hover { box-shadow: 0 4px 15px rgba(255, 159, 67, 0.4); }
        #login-error-msg { color: var(--danger-color); margin-top: 15px; min-height: 20px; font-weight: bold; }
        .login-footer { margin-top: 25px; font-size: 0.85em; color: var(--text-secondary); text-align: center; }
        .login-footer .copyright-text { font-size: 0.9em; margin-bottom: 15px; }
        .developer-box { border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; background-color: var(--bg-main); }
        .login-footer .developed-by-text { margin-bottom: 8px; font-size: 1.1em; }
        .company-info { display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 15px; }
        .company-logo { width: 40px; height: 40px; object-fit: contain; }
        .company-text { text-align: left; line-height: 1.5; }
        .company-text strong { font-size: 1.2em; color: var(--text-primary); }
        .company-text small { font-size: 0.9em; }
        .social-icons { display: flex; justify-content: center; gap: 20px; align-items: center; }
        .social-icons a { display: inline-block; color: var(--text-secondary); transition: color 0.3s, transform 0.3s; }
        .social-icons a:hover { color: var(--border-accent); transform: scale(1.1); }
        .social-icons svg { width: 28px; height: 28px; fill: currentColor; }
        .login-footer .instruction-text { font-size: 0.8em; font-style: italic; margin-top: 12px; margin-bottom: 0; color: var(--text-secondary); }
        
        /* App Layout */
        #app-container { display: flex; min-height: 100vh; }
        .side-nav { width: 240px; background-color: var(--bg-header); color: var(--text-header); padding-top: 20px; display: flex; flex-direction: column; flex-shrink: 0; position: fixed; height: 100%; z-index: 10; overflow-y: auto; }
        .logo-container { text-align: center; margin-bottom: 30px; }
        .logo { width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--border-accent); object-fit: cover; }
        .nav-link { display: flex; align-items: center; gap: 15px; padding: 15px 20px; color: var(--text-header); text-decoration: none; font-size: 1.1em; border-left: 4px solid transparent; transition: all 0.3s; }
        .nav-link:hover { background-color: rgba(255, 255, 255, 0.1); }
        .nav-link.active { background-color: var(--border-accent); font-weight: bold; }
        .content-wrapper { flex-grow: 1; margin-left: 240px; display: flex; flex-direction: column; }
        
        /* Header */
        header.top-header { background-color: var(--bg-section); padding: 10px 25px; display: flex; justify-content: flex-end; align-items: center; border-bottom: 1px solid var(--border-color); box-shadow: var(--shadow-sm); position: sticky; top: 0; z-index: 5; }
        #year-management-controls { display: flex; align-items: center; gap: 12px; }
        #year-management-controls label { font-weight: bold; font-size: 0.95em; white-space: nowrap; color: var(--text-secondary); }
        #yearSelector { padding: 7px 15px; border-radius: 20px; border: 1px solid var(--border-color); background-color: var(--bg-main); color: var(--text-primary); font-weight: bold; font-size: 0.9em; cursor: pointer; }
        
        /* Main Content */
        main { padding: 25px; flex-grow: 1; }
        .page-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; border-bottom: 2px solid var(--border-accent); padding-bottom: 10px; }
        .page-header h1 { margin: 0; }
        .page-section { background-color: var(--bg-section); padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: var(--shadow-sm); }
        
        /* Forms and Grids */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 8px; font-weight: bold; font-size: 0.9em; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 1em; box-sizing: border-box; font-family: 'Kalpurush', sans-serif; background-color: #f1f8e9; }
        .form-group textarea { min-height: 120px; resize: vertical; }
        .form-group-full { grid-column: 1 / -1; }
        .custom-file-upload { border: 1px solid var(--border-color); display: inline-block; padding: 8px 12px; cursor: pointer; border-radius: 6px; }
        input[type="file"] { display: none; }
        #file-chosen { margin-left: 10px; font-style: italic; color: var(--text-secondary); }
        
        /* Buttons */
        .submit-button, .btn-primary { padding: 12px 25px; border: none; border-radius: 8px; background: linear-gradient(45deg, var(--border-accent), #e67e22); color: white; font-size: 1.1em; cursor: pointer; margin-top: 10px; transition: all .3s; }
        .submit-button:hover:not(:disabled), .btn-primary:hover:not(:disabled) { box-shadow: 0 4px 15px rgba(255, 159, 67, 0.4); transform: translateY(-2px); }
        .submit-button:disabled, .btn-primary:disabled { background: #bdbdbd; color: #757575; cursor: not-allowed; }
        .btn-secondary { background-color: #f1f8e9; color: var(--text-primary); border: 1px solid var(--border-color); padding: 12px 25px; font-size: 1.1em; cursor: pointer; transition: all .3s; }
        .btn-danger { background-color: var(--danger-color); color: white; padding: 12px 25px; font-size: 1.1em; cursor: pointer; transition: all .3s; }
        
        /* Dashboard */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .stat-card { padding: 20px; border-radius: 8px; text-align: center; border-left: 5px solid; background-color: #f1f8e9; }
        .stat-card-label { font-size: 1.1em; color: var(--text-secondary); }
        .stat-card-value { font-size: 2.5em; font-weight: bold; margin-top: 10px; }
        .stat-card.students { border-left-color: var(--border-accent); }
        .stat-card.batches { border-left-color: var(--success-color); }
        .stat-card.notices { border-left-color: var(--warning-color); }
        .filter-container { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; align-items: flex-end; }
        
        /* Tables */
        .results-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .results-table th, .results-table td { padding: 12px; border: 1px solid var(--border-color); text-align: left; }
        .results-table thead { background-color: var(--bg-header); color: var(--text-header); }
        .notice-history-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color); }
        #load-more-notices-btn { width: 100%; margin-top: 20px; }
        
        /* Modals */
        .modal-overlay { display: none; position: fixed; z-index: 10001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,.6); backdrop-filter: blur(4px); align-items: center; justify-content: center; }
        .modal-overlay.visible { display: flex; }
        .modal-content { background-color: var(--bg-section); margin: auto; padding: 25px; border-radius: 12px; width: 95%; max-width: 700px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: var(--shadow-md); }
        .modal-header { padding-bottom: 15px; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { margin: 0; font-size: 1.4em; }
        .modal-close-btn { background: none; border: none; font-size: 2em; cursor: pointer; color: var(--text-secondary); line-height: 1; padding: 0 5px; }
        .modal-body { flex-grow: 1; overflow-y: auto; padding-right: 10px; }
        .modal-footer { margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 10px; }
        
        /* Live Exam Styles */
        .exam-list-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 10px; }
        .exam-list-item h4 { margin: 0; }
        .exam-info { font-size: 0.9em; color: var(--text-secondary); }
        .question-editor { border: 1px solid var(--border-color); padding: 15px; border-radius: 8px; margin-bottom: 15px; background-color: #fafafa; }
        .question-editor textarea { min-height: 60px; }
        .option-group { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .option-group input[type="radio"] { width: auto; flex-shrink: 0; }
        .option-group input[type="text"] { flex-grow: 1; }
        #add-question-btn { background-color: var(--success-color); }
        .publish-status { font-weight: bold; padding: 4px 8px; border-radius: 12px; color: white; font-size: 0.8em; }
        .status-published { background-color: var(--success-color); }
        .status-unpublished { background-color: var(--warning-color); color: #333;}
        
        /* ID Card Specific Styles */
        #id-card-preview-area { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10005; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .id-card-container { width: 300px; aspect-ratio: 54 / 86; position: relative; box-shadow: var(--shadow-md); border-radius: 12px; overflow: hidden; font-family: Arial, Helvetica, sans-serif; background-color: white; }
        .id-card-container .bg-img { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }
        .id-card-photo { position: absolute; top: 17.7%; left: 50%; transform: translateX(-50%); width: 50.75%; aspect-ratio: 9.25 / 10; object-fit: cover; border-radius: 15px; }
        .id-card-details-container { position: absolute; top: 53.5%; left: 50%; width: 50%; height: auto; color: #1c1c1c; }
        .id-card-details-container p { font-family: 'Kalpurush', sans-serif; margin: 0; padding: 0; font-size: 12.3px; font-weight: bold; line-height: 1.65; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .id-card-qr-container { position: absolute; top: 48.3%; left: 50%; transform: translateX(-50%); width: 28.5%; background: white; padding: 4px; border-radius: 2px; }
        #id-card-generation-progress { margin-top: 10px; font-weight: bold; color: var(--info-color); }
        
        /* Lottery Specific Styles */
        .lottery-batch-card { background-color: #fff; border-radius: 8px; padding: 15px; box-shadow: var(--shadow-sm); border-left: 5px solid var(--info-color); transition: all 0.2s; }
        .lottery-batch-card h4 { margin: 0 0 10px; display: flex; justify-content: space-between; align-items: center; }
        .lottery-batch-card .status { font-weight: bold; font-size: 0.9em; padding: 4px 10px; border-radius: 12px; }
        .lottery-batch-card .status.status-ready { background-color: var(--warning-color); color: #333; }
        .lottery-batch-card .status.status-completed { background-color: var(--success-color); color: white; cursor: pointer; }
        .lottery-batch-card button { width: 100%; padding: 10px; font-size: 1em; margin-top: 10px; background-color: var(--border-accent); color: white; border: none; border-radius: 6px; cursor: pointer; }
        .lottery-batch-card.completed { border-left-color: var(--success-color); }
        .lottery-batch-card .winner-list { list-style: decimal inside; padding-left: 5px; font-size: 0.9em; display: none; }
        #lottery-animation-screen { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #2c3e50, #34495e); z-index: 20000; color: white; flex-direction: column; align-items: center; justify-content: center; }
        #lottery-animation-screen.visible { display: flex; }
        .reel-container { width: 80%; height: 150px; overflow: hidden; border: 5px solid var(--border-accent); border-radius: 10px; background: rgba(0,0,0,0.3); margin-bottom: 30px; }
        .names-reel { text-align: center; }
        .names-reel div { font-size: 2.5em; font-weight: bold; padding: 20px; text-shadow: 2px 2px 5px rgba(0,0,0,0.5); }
        @keyframes reel-spin { from { transform: translateY(0); } to { transform: translateY(-90%); } }
        .winner-announcement-box { text-align: center; opacity: 0; transform: scale(0.5); transition: all 0.5s ease-out; }
        .winner-announcement-box.show { opacity: 1; transform: scale(1); }
        #winner-title { font-size: 2em; color: var(--warning-color); }
        #winner-name { font-size: 3.5em; font-weight: bold; margin: 10px 0 30px; }
        #vip-winners-list { list-style: none; padding: 0; text-align: center; font-size: 1.2em; }
        #save-lottery-btn { display: none; background-color: var(--success-color); font-size: 1.2em; padding: 15px 30px; }

        /* General Helper Styles */
        #loader-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:10006;display:none;align-items:center;justify-content:center;color:white;flex-direction:column;}.loader{border:5px solid #f3f3f3;border-top:5px solid var(--border-accent);border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin-bottom:15px;}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        #toast-container{position:fixed;top:20px;right:20px;z-index:10005;display:flex;flex-direction:column;gap:10px;}.toast{padding:15px 20px;border-radius:6px;color:#fff;font-size:1em;box-shadow:var(--shadow-md);opacity:0;transform:translateX(100%);transition:all .4s ease;}.toast.show{opacity:1;transform:translateX(0)}.toast.success{background-color:var(--toast-success-bg)}.toast.error{background-color:var(--toast-error-bg)}.toast.info{background-color:var(--toast-info-bg)}
        .app-footer { background-color: var(--footer-bg); color: var(--footer-text); padding: 30px 20px; text-align: center; }
        .footer-content { max-width: 1000px; margin: 0 auto; line-height: 1.7; }
        .footer-content p { margin: 5px 0; }
        .footer-content a { color: var(--footer-text); text-decoration: none; transition: color 0.2s; display: inline-flex; align-items: center; gap: 6px; }
        .footer-content a:hover { color: var(--border-accent); }
        .footer-content svg { width: 18px; height: 18px; fill: currentColor; }
        .footer-socials { display: flex; justify-content: center; gap: 20px; margin: 15px 0; }
        .footer-contact { margin-top: 10px; }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .side-nav { width: 200px; }
            .content-wrapper { margin-left: 200px; }
            header.top-header { padding: 10px 15px; }
            main { padding: 15px; }
            .page-header { flex-direction: column; align-items: flex-start; }
            .page-header h1 { font-size: 1.5em; }
            .filter-container { flex-direction: column; align-items: stretch; }
            .exam-list-item { flex-direction: column; align-items: stretch; gap: 10px; }
            .exam-list-item div:last-child { display: flex; gap: 10px; }
        }
        @media (max-width: 576px) {
             .side-nav { width: 80px; }
             .content-wrapper { margin-left: 80px; }
             .nav-link { flex-direction: column; gap: 5px; padding: 10px 5px; font-size: 0.9em; }
             .logo-container h3 { display: none; }
             .logo { width: 50px; height: 50px; }
             .login-box { padding: 25px 15px; }
        }
    </style>
</head>
<body data-theme="light">
    
    <div id="login-container">
        <div class="login-box">
            <img src="images/image2.png" alt="Logo" class="login-logo" onerror="this.style.display='none'">
            <h1>Miracle Admin Portal</h1>
            <form id="login-form">
                <div class="login-input-group">
                    <input type="password" id="username" placeholder="সিস্টেম ইউজারনেম" required>
                </div>
                <div class="login-input-group">
                    <input type="password" id="password" placeholder="পাসওয়ার্ড" required>
                </div>
                <div class="login-options">
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="checkbox" id="remember-me"> আমাকে মনে রাখুন
                    </label>
                </div>
                <button type="submit" class="login-button">লগইন করুন</button>
                <div id="login-error-msg"></div>
            </form>
            <div class="login-footer">
                <p class="copyright-text">&copy; Miracle Cadet & Academic Institute 2026</p>
                <div class="developer-box">
                    <p class="developed-by-text">Developed by,</p>
                    <div class="company-info">
                        <img src="images/image5.png" alt="Bindumatra IT Logo" class="company-logo">
                        <div class="company-text">
                            <strong>বিন্দুমাত্রা আইটি</strong><br>
                            <small>CEO : Abdullah Al Rafi </small>
                        </div>
                    </div>
                    <div class="social-icons">
                        <a href="mailto:bindumatrait@gmail.com" title="Email Bindumatra IT Solutions" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg></a>
                        <a href="https://www.facebook.com/profile.php?id=61580476801857" title="Facebook Page" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 2.04c-5.5 0-10 4.49-10 10.02 0 5 3.66 9.15 8.44 9.9v-7.02H7.97v-2.89h2.47V9.9c0-2.45 1.44-3.8 3.65-3.8 1.06 0 2.16.19 2.16.19v2.47h-1.27c-1.2 0-1.56.72-1.56 1.5v1.84h2.78l-.45 2.89h-2.33v7.02c4.78-.75 8.44-4.9 8.44-9.9C22 6.53 17.5 2.04 12 2.04z"/></svg></a>
                        <a href="https://wa.me/8801745938158" title="Contact on WhatsApp" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.894 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.886-.001 2.269.655 4.357 1.846 6.167l-1.117 4.082 4.162-1.085zM9.06 7.426c.14-.364.44-1.13.56-1.293.12-.162.28-.192.42-.192.14 0 .28.096.42.364.14.268.56 1.32.62 1.42.06.1.12.18.2.3.08.12.14.24.26.36s.24.22.4.32c.16.1.34.16.5.24.16.08.3.12.42.14.12.02.26 0 .38-.08.12-.08.5-1.25.62-1.47.12-.22.24-.28.4-.28.16 0 .3.04.42.12.12.08.56 1.13.66 1.31.1.18.18.28.2.32.02.04.04.1.02.18s-.08.24-.16.32c-.08.08-.18.1-.28.14s-.2.08-.32.1c-.12.02-.26.02-.4.02s-.68-.08-1.02-.22c-.34-.14-.7-.34-1.08-.62s-.68-.62-.94-.96c-.26-.34-.48-.74-.62-1.18s-.18-.9-.18-1.46c0-.56.08-1.04.22-1.46z"/></svg></a>
                    </div>
                    <p class="instruction-text">click the icons to visit</p> 
                </div>
            </div>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <nav class="side-nav">
            <div class="logo-container">
                <img src="images/image2.png" alt="Logo" class="logo" onerror="this.style.display='none'">
                <h3 style="margin-top: 10px;">Miracle Admin Portal</h3>
            </div>
            <a href="#dashboard" class="nav-link active" data-page="dashboard">📊 ড্যাশবোর্ড</a>
            <a href="#notices" class="nav-link" data-page="notices">🔔 নোটিশ ম্যানেজমেন্ট</a>
            <a href="#students" class="nav-link" data-page="students">👥 ছাত্রছাত্রী</a>
            <a href="#id-cards" class="nav-link" data-page="id-cards">🆔 আইডি কার্ড</a>
            <a href="#lottery" class="nav-link" data-page="lottery">🏆 লাইভ লটারি</a>
            <a href="#live-exams" class="nav-link" data-page="live-exams">📝 লাইভ পরীক্ষা</a>
        </nav>
        <div class="content-wrapper">
            <header class="top-header">
                <div id="year-management-controls">
                    <label for="yearSelector">শিক্ষাবর্ষ:</label>
                    <select id="yearSelector"></select>
                </div>
            </header>
            <main id="main-content"></main>
            <footer class="app-footer">
                <div class="footer-content">
                    <p>© Miracle Cadet & Academic Institute 2026</p>
                    <p>Developed by বিন্দুমাত্রা আইটি</p>
                     <div class="footer-socials">
                        <a href="https://wa.me/8801745938158" target="_blank" rel="noopener noreferrer"><svg viewBox="0 0 24 24"><path d="M12.04 2C6.58 2 2.13 6.45 2.13 11.91C2.13 13.66 2.61 15.31 3.48 16.76L2 22L7.43 20.48C8.82 21.3 10.39 21.81 12.04 21.81C17.5 21.81 21.95 17.36 21.95 11.9C21.95 9.27 20.92 6.81 19.05 4.94C17.18 3.07 14.72 2 12.04 2M12.04 3.67C14.25 3.67 16.31 4.53 17.87 6.09C19.42 7.65 20.28 9.71 20.28 11.91C20.28 16.47 16.6 20.15 12.04 20.15C10.56 20.15 9.15 19.71 7.96 18.9L7.54 18.64L3.8 19.77L4.95 16.11L4.68 15.68C3.78 14.43 3.32 12.96 3.32 11.91C3.32 7.35 6.99 3.67 12.04 3.67M16.57 14.45C16.37 14.35 15.28 13.81 15.08 13.73C14.88 13.65 14.73 13.61 14.59 13.86C14.44 14.11 13.99 14.65 13.84 14.8C13.69 14.95 13.54 14.96 13.34 14.86C13.14 14.76 12.28 14.47 11.27 13.59C10.49 12.91 9.96 12.06 9.81 11.81C9.66 11.56 9.79 11.45 9.91 11.33C10.02 11.22 10.16 11.03 10.29 10.88C10.41 10.73 10.46 10.61 10.54 10.43C10.61 10.26 10.56 10.11 10.51 10.01C10.46 9.91 10.03 8.82 9.83 8.32C9.64 7.82 9.44 7.86 9.29 7.85H9.01C8.86 7.85 8.64 7.9 8.44 8.1C8.24 8.3 7.79 8.75 7.79 9.76C7.79 10.77 8.48 11.73 8.58 11.88C8.68 12.03 10.03 14.16 12.11 14.99C12.59 15.18 12.95 15.29 13.25 15.38C13.78 15.53 14.28 15.49 14.68 15.43C15.12 15.36 16.11 14.81 16.31 14.71C16.51 14.61 16.57 14.55 16.57 14.45Z"/></svg><span>Chat on Whatsapp</span></a>
                        <a href="https://www.facebook.com/profile.php?id=61580476801857" target="_blank" rel="noopener noreferrer"><svg viewBox="0 0 24 24"><path d="M14 13.5h2.5l1-4H14v-2c0-1.03 0-2 2-2h1.5V2.14c-.326-.043-1.557-.14-2.857-.14C11.928 2 10 3.657 10 6.7v2.8H7v4h3V22h4v-8.5z"/></svg><span>Facebook</span></a>
                        <a href="https://www.instagram.com/abdullah_al.rafi" target="_blank" rel="noopener noreferrer"><svg viewBox="0 0 24 24"><path d="M12 2c2.717 0 3.056.01 4.122.06 1.065.05 1.79.217 2.428.465.66.254 1.216.598 1.772 1.153a4.902 4.902 0 011.153 1.772c.247.637.415 1.363.465 2.428.047 1.066.06 1.405.06 4.122s-.013 3.056-.06 4.122c-.05 1.065-.218 1.79-.465 2.428a4.883 4.883 0 01-1.153 1.772 4.915 4.915 0 01-1.772 1.153c-.637.247-1.363.415-2.428.465-1.066.047-1.405.06-4.122.06s-3.056-.013-4.122-.06c-1.065-.05-1.79-.218-2.428-.465a4.89 4.89 0 01-1.772-1.153 4.904 4.904 0 01-1.153-1.772c-.248-.637-.415-1.363-.465-2.428C2.013 15.056 2 14.717 2 12s.013-3.056.06-4.122c.05-1.065.217-1.79.465-2.428a4.884 4.884 0 011.153-1.772A4.902 4.902 0 016.344 2.525c.637-.248 1.363-.415 2.428-.465C9.844 2.013 10.183 2 12 2zm0 1.8a9.137 9.137 0 00-4.043.06 2.908 2.908 0 00-1.685.43c-.47.18-.86.41-1.2.75-.34.34-.57.73-.75 1.2a2.908 2.908 0 00-.43 1.685c-.046 1.02-.06 1.344-.06 3.96s.014 2.94.06 3.96c.05 1.01.212 1.58.43 1.685.18.47.41.86.75 1.2.34.34.73.57 1.2.75.52.204 1.1.384 1.685.43 1.02.046 1.344.06 3.96.06s2.94-.014 3.96-.06c1.01-.05 1.58-.212 1.685-.43.47-.18.86-.41 1.2-.75.34-.34.57.73.75-1.2.218-.52.38-1.1.43-1.685.046-1.02.06-1.344.06-3.96s-.014-2.94-.06-3.96c-.05-1.01-.212-1.58-.43-1.685-.18-.47-.41-.86-.75-1.2-.34-.34-.73-.57-1.2-.75-.52-.204-1.1-.384-1.685-.43C14.94 3.814 14.616 3.8 12 3.8zm0 3.39a4.81 4.81 0 100 9.62 4.81 4.81 0 000-9.62zM12 15a3 3 0 110-6 3 3 0 010 6zm6.406-9.69a1.2 1.2 0 100 2.4 1.2 1.2 0 000-2.4z"/></svg><span>Executive Director</span></a>
                    </div>
                    <div class="footer-contact">
                        <a href="mailto:bindumatrait@gmail.com"><svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg><span>bindumatrait@gmail.com</span></a>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <div id="loader-overlay"><div class="loader"></div><span id="loader-text"></span></div>
    <div id="toast-container"></div>
    <div id="id-card-preview-area"></div>
    <audio id="lottery-sound" src="songs/spinning-sound.mp3" preload="auto"></audio>

    <!-- HTML TEMPLATES -->
    <template id="template-dashboard">
        <div class="page-header"><h1 id="dashboard-header">ড্যাশবোর্ড</h1></div>
        <div class="dashboard-grid">
            <div class="stat-card students"><div class="stat-card-label">মোট ছাত্রছাত্রী</div><div id="total-students" class="stat-card-value">...</div></div>
            <div class="stat-card batches"><div class="stat-card-label">মোট ব্যাচ</div><div id="total-batches" class="stat-card-value">...</div></div>
            <div class="stat-card notices"><div class="stat-card-label">মোট নোটিশ</div><div id="total-notices" class="stat-card-value">...</div></div>
        </div>
    </template>

    <template id="template-notices">
        <div class="page-header"><h1>নোটিশ ম্যানেজমেন্ট</h1></div>
        <div class="page-section">
            <h2>নতুন নোটিশ পোস্ট করুন</h2>
            <form id="notice-form">
                <div class="form-grid">
                    <div class="form-group form-group-full"><label for="notice-title">শিরোনাম</label><input type="text" id="notice-title" required></div>
                    <div class="form-group form-group-full"><label for="notice-content">বিস্তারিত</label><textarea id="notice-content" required></textarea></div>
                    <div class="form-group form-group-full">
                        <label for="notice-image">ছবি (ঐচ্ছিক, সর্বোচ্চ ৫০০কেবি)</label>
                        <label for="notice-image" class="custom-file-upload">ফাইল বাছাই করুন</label>
                        <input type="file" id="notice-image" accept="image/*"><span id="file-chosen">কোনো ফাইল বাছাই করা হয়নি</span>
                    </div>
                    <div class="form-group form-group-full"><h3>টার্গেট অডিয়েন্স</h3></div>
                    <div class="form-group"><label for="target-year">শিক্ষাবর্ষ</label><select id="target-year"><option value="">সকল শিক্ষাবর্ষ</option></select></div>
                    <div class="form-group"><label for="target-class">ক্লাস</label><select id="target-class" disabled><option value="">সকল ক্লাস</option></select></div>
                    <div class="form-group"><label for="target-batch">ব্যাচ</label><select id="target-batch" disabled><option value="">সকল ব্যাচ</option></select></div>
                </div>
                <button type="submit" class="submit-button">নোটিশ পোস্ট করুন</button>
            </form>
        </div>
        <div class="page-section">
            <h2>পূর্ববর্তী নোটিশসমূহ</h2>
            <div id="notice-history-container"><p>লোড হচ্ছে...</p></div>
            <div id="load-more-container"></div>
        </div>
    </template>

    <template id="template-students">
        <div class="page-header"><h1>ছাত্রছাত্রীর তালিকা</h1></div>
        <div class="page-section">
            <h2>ফিল্টার করুন</h2>
            <div class="filter-container">
                <div class="form-group"><select id="filter-class-student"><option value="">ক্লাস বাছাই</option></select></div>
                <div class="form-group"><select id="filter-batch-student" disabled><option value="">ব্যাচ বাছাই</option></select></div>
                <div class="form-group"><input type="text" id="student-search" placeholder="নাম বা রোল দিয়ে খুঁজুন..."></div>
            </div>
            <div style="overflow-x:auto;"><table class="results-table"><thead><tr><th>রোল</th><th>নাম</th><th>ক্লাস</th><th>অভিভাবকের নম্বর</th></tr></thead><tbody id="student-list-body"><tr><td colspan="4" style="text-align:center;">ফিল্টার ব্যবহার করে ছাত্রছাত্রী দেখুন।</td></tr></tbody></table></div>
        </div>
    </template>
    
    <template id="template-id-cards">
        <div class="page-header">
            <h1>আইডি কার্ড ম্যানেজমেন্ট</h1>
        </div>
        <div class="page-section">
            <h2>ফিল্টার করুন এবং ডাউনলোড করুন</h2>
            <div class="filter-container">
                <div class="form-group"><select id="filter-class-idcard"><option value="">ক্লাস বাছাই</option></select></div>
                <div class="form-group"><select id="filter-batch-idcard" disabled><option value="">ব্যাচ বাছাই</option></select></div>
                <button id="btn-download-batch-idcards" class="btn-primary" disabled style="margin-top: 0;">Download All as PDF</button>
            </div>
            <div id="id-card-generation-progress" style="display:none; margin-top: 10px; font-weight: bold; color: var(--info-color);"></div>
            <div style="overflow-x:auto;">
                <table class="results-table">
                    <thead><tr><th>রোল</th><th>নাম</th><th>ক্লাস</th><th>একশন</th></tr></thead>
                    <tbody id="idcard-student-list-body"><tr><td colspan="4" style="text-align:center;">ফিল্টার ব্যবহার করে ছাত্রছাত্রী দেখুন।</td></tr></tbody>
                </table>
            </div>
        </div>
    </template>
    
    <template id="template-live-exams">
        <div class="page-header">
            <h1>লাইভ পরীক্ষা ম্যানেজমেন্ট</h1>
            <button id="btn-create-new-exam" class="btn-primary" style="margin-top:0;">নতুন পরীক্ষা তৈরি করুন</button>
        </div>
        <div class="page-section">
            <h2>পরীক্ষার তালিকা</h2>
            <div id="live-exam-list-container"><p>কোনো পরীক্ষা পাওয়া যায়নি।</p></div>
        </div>
    </template>
    
    <template id="template-create-exam-modal">
        <div class="modal-overlay" id="create-exam-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="exam-modal-title">নতুন পরীক্ষা তৈরি করুন</h2>
                    <button class="modal-close-btn">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="exam-details-form">
                        <div class="form-grid">
                            <div class="form-group"><label for="exam-title">শিরোনাম</label><input type="text" id="exam-title" required></div>
                            <div class="form-group"><label for="exam-duration">সময় (মিনিট)</label><input type="number" id="exam-duration" value="30" min="1" required></div>
                            <div class="form-group"><label for="exam-total-marks">মোট নম্বর (স্বয়ংক্রিয়)</label><input type="number" id="exam-total-marks" readonly></div>
                            <div class="form-group"><label for="exam-negative-marking">নেগেটিভ মার্কিং (প্রতি ভুলের জন্য)</label><select id="exam-negative-marking"><option value="0">না</option><option value="0.25">0.25</option><option value="0.5">0.5</option><option value="1">1</option></select></div>
                            <div class="form-group"><label for="exam-type">পরীক্ষার ধরণ</label><select id="exam-type"><option value="scheduled">Scheduled</option><option value="always_open">Always Open</option></select></div>
                            <div class="form-group" id="exam-schedule-group">
                                <label>সময়সূচী (কখন শুরু হবে)</label>
                                <input type="datetime-local" id="exam-start-time" required>
                            </div>
                        </div>
                    </form>
                    <hr style="margin: 20px 0;">
                    <h3>প্রশ্ন যোগ করুন</h3>
                    <div id="questions-container"></div>
                    <button id="add-question-btn" class="submit-button" style="background-color: var(--success-color); margin-top: 15px;">+ প্রশ্ন যোগ করুন</button>
                </div>
                <div class="modal-footer">
                    <button id="save-exam-btn" class="btn-primary" style="width:100%;">পরীক্ষা সংরক্ষণ করুন</button>
                </div>
            </div>
        </div>
    </template>

    <template id="template-exam-results-modal">
        <div class="modal-overlay" id="exam-results-modal">
            <div class="modal-content" style="max-width: 900px;">
                <div class="modal-header">
                    <h2 id="results-modal-title"></h2>
                    <button class="modal-close-btn">&times;</button>
                </div>
                <div class="modal-body">
                    <div style="overflow-x:auto;">
                        <table class="results-table">
                            <thead><tr><th>পজিশন</th><th>নাম</th><th>রোল</th><th>ব্যাচ</th><th>প্রাপ্ত নম্বর</th></tr></thead>
                            <tbody id="exam-results-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <template id="template-id-card-single-front">
        <div class="id-card-container">
            <img src="images/id1.png" class="bg-img" alt="ID Card Front Template">
            <img data-id-field="photo" src="images/default_avatar.png" class="id-card-photo" alt="Student Photo" onerror="this.src='images/default_avatar.png';">
            <div class="id-card-details-container">
                <p data-id-field="name">N/A</p>
                <p data-id-field="school">N/A</p>
                <p data-id-field="class">N/A</p>
                <p data-id-field="section">N/A</p>
                <p data-id-field="roll">N/A</p>
                <p data-id-field="contact">N/A</p>
                <p data-id-field="batch">N/A</p>
                <p data-id-field="sid">N/A</p>
            </div>
        </div>
    </template>
    
    <template id="template-id-card-single-back">
        <div class="id-card-container">
            <img src="images/id2.png" class="bg-img" alt="ID Card Back Template">
            <div data-id-field="qr" class="id-card-qr-container"></div>
        </div>
    </template>

    <template id="template-lottery">
        <div class="page-header"><h1>লাইভ লটারি ম্যানেজমেন্ট</h1></div>
        <div class="page-section">
            <div class="filter-container">
                <div class="form-group">
                    <label for="lottery-month-selector">মাস নির্বাচন করুন</label>
                    <select id="lottery-month-selector"></select>
                </div>
            </div>
            <div id="lottery-batch-grid-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                <p>মাস নির্বাচন করুন...</p>
            </div>
        </div>
    </template>
    
    <template id="template-lottery-modal">
        <div class="modal-overlay visible" id="lottery-run-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="lottery-modal-title">Run Lottery</h2>
                    <button class="modal-close-btn">&times;</button>
                </div>
                <div class="modal-body">
                    <p>এই লটারিটি শুধুমাত্র সেইসব ছাত্রছাত্রীদের জন্য যারা এই মাসের পেমেন্ট পরিশোধ করেছে।</p>
                    <div class="form-group">
                        <label for="lottery-winner-count">কতজন বিজয়ী নির্বাচন করবেন?</label>
                        <select id="lottery-winner-count">
                            <option value="1">১ জন</option>
                            <option value="2">২ জন</option>
                            <option value="3" selected>৩ জন</option>
                            <option value="4">৪ জন</option>
                            <option value="5">৫ জন</option>
                        </select>
                    </div>
                    <div class="form-group">
                         <label style="display:flex; align-items:center; gap: 8px;">
                            <input type="checkbox" id="lottery-present-only"> শুধুমাত্র আজকের উপস্থিত ছাত্রছাত্রীদের অন্তর্ভুক্ত করুন
                        </label>
                    </div>
                    <p>মোট অংশগ্রহণকারী: <strong id="participant-count">0</strong></p>
                </div>
                <div class="modal-footer">
                    <button id="start-lottery-btn" class="btn-primary" style="width:100%;" disabled>লটারি শুরু করুন</button>
                </div>
            </div>
        </div>
    </template>

    <template id="template-lottery-animation">
        <div id="lottery-animation-screen">
            <div class="reel-container">
                <div class="names-reel"></div>
            </div>
            <div class="winner-announcement-box">
                <h2 id="winner-title"></h2>
                <h1 id="winner-name"></h1>
            </div>
            <button id="find-winner-btn" class="btn-primary" style="font-size: 1.2em; padding: 15px 30px;">Find Winner</button>
            <button id="save-lottery-btn" class="btn-primary">ফলাফল সংরক্ষণ করুন</button>
            <div style="margin-top: 20px; text-align:center;">
                <h3>বিজয়ীর তালিকা</h3>
                <ul id="vip-winners-list"></ul>
            </div>
        </div>
    </template>
    
<script>
// ================================================================== //
//            FIREBASE CONFIGURATION AND INITIALIZATION             //
// ================================================================== //
const firebaseConfig = {
    apiKey: "AIzaSyAnpbv9WhvOqV8nsbmVOQuBhKDF7D9-Ztc",
    authDomain: "miracle-math-online-software.firebaseapp.com",
    projectId: "miracle-math-online-software",
    storageBucket: "miracle-math-online-software.firebasestorage.app",
    messagingSenderId: "27829239296",
    appId: "1:27829239296:web:108d6b86969c95cea2a2e5",
    databaseURL: "https://miracle-math-online-software-default-rtdb.asia-southeast1.firebasedatabase.app"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const credsRef = db.ref('credentials');
const academicYearsRef = db.ref('academicYears');
const noticesRef = db.ref('notices');


// ================================================================== //
//                LOGIN SCRIPT START                                //
// ================================================================== //
document.addEventListener('DOMContentLoaded', () => {
    const REMEMBER_KEY = 'miracle_admin_rem_creds'; 
    const SESSION_KEY = 'miracle_admin_is_logged_in';

    const loginContainer = document.getElementById('login-container');
    const appContainer = document.getElementById('app-container');
    const loginForm = document.getElementById('login-form');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const rememberMeCheckbox = document.getElementById('remember-me');
    const errorMsgDiv = document.getElementById('login-error-msg');
    
    if (sessionStorage.getItem(SESSION_KEY) === 'true') {
        loginContainer.style.display = 'none';
        appContainer.classList.remove('hidden');
        firebase.auth().signInAnonymously().then(() => {
            initializeAppLogic();
        }).catch(err => {
            console.error("Anonymous sign-in failed on session restore:", err);
            errorMsgDiv.textContent = 'Authentication session restore failed.';
        });
        return;
    }

    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = usernameInput.value;
        const password = passwordInput.value;
        errorMsgDiv.textContent = ''; 

        try {
            await firebase.auth().signInAnonymously();
            const snapshot = await credsRef.once('value');
            let correctCreds;
            if (snapshot.exists()) {
                correctCreds = snapshot.val();
            } else {
                correctCreds = { username: "ashik'smathhome@602", password: "jaleswaritolamath25" };
            }

            if (username === correctCreds.username && password === correctCreds.password) {
                if (rememberMeCheckbox.checked) {
                    localStorage.setItem(REMEMBER_KEY, JSON.stringify({ user: username, pass: password }));
                } else {
                    localStorage.removeItem(REMEMBER_KEY);
                }
                sessionStorage.setItem(SESSION_KEY, 'true'); 
                
                loginContainer.style.display = 'none';
                appContainer.classList.remove('hidden');
                initializeAppLogic();
            } else {
                errorMsgDiv.textContent = 'ইউজারনেম বা পাসওয়ার্ড সঠিক নয়।';
                firebase.auth().signOut();
            }
        } catch (error) {
            console.error("Firebase login error:", error);
            errorMsgDiv.textContent = 'ডাটাবেস কানেক্ট করা যায়নি বা অনুমতি নেই।';
            if (firebase.auth().currentUser) {
                firebase.auth().signOut();
            }
        }
    });

    const rememberedCreds = localStorage.getItem(REMEMBER_KEY);
    if (rememberedCreds) {
        try {
            const creds = JSON.parse(rememberedCreds);
            usernameInput.value = creds.user;
            passwordInput.value = creds.pass;
            rememberMeCheckbox.checked = true;
        } catch(e) {
            localStorage.removeItem(REMEMBER_KEY);
        }
    }
});


// ================================================================== //
//                GLOBAL UTILITY FUNCTIONS                          //
// ================================================================== //
function showToast(message, type = 'info', duration = 3000) { const c=document.getElementById('toast-container');if(!c)return;const t=document.createElement('div');t.className=`toast ${type}`;t.textContent=message;c.appendChild(t);setTimeout(()=>t.classList.add('show'),10);setTimeout(()=>{t.classList.remove('show');t.addEventListener('transitionend',()=>t.remove())},duration)}
const showLoader = (text = 'লোড হচ্ছে...') => { document.getElementById('loader-text').textContent = text; document.getElementById('loader-overlay').style.display = 'flex'; };
const hideLoader = () => document.getElementById('loader-overlay').style.display = 'none';
const BENGALI_MONTHS=["জানুয়ারি","ফেব্রুয়ারি","মার্চ","এপ্রিল","মে","জুন","জুলাই","আগস্ট","সেপ্টেম্বর","অক্টোবর","নভেম্বর","ডিসেম্বর"];
function getOrdinal(n) { const s=["th","st","nd","rd"], v=n%100; return n+(s[(v-20)%10]||s[v]||s[0]); }


// ================================================================== //
//                  MAIN APP LOGIC INITIALIZATION                   //
// ================================================================== //
function initializeAppLogic() {
    const mainContent = document.getElementById('main-content');
    const navLinks = document.querySelectorAll('.nav-link');
    const yearSelector = document.getElementById('yearSelector');
    let fullDataCache = {}; 
    let currentPage = 'dashboard';
    let viewedYear = localStorage.getItem('adminViewedYear') || new Date().getFullYear();
    let liveExamsRef;

    async function initialize() {
        showLoader('প্রয়োজনীয় তথ্য লোড হচ্ছে...');
        try {
            const yearsSnapshot = await academicYearsRef.once('value');
            const yearsData = yearsSnapshot.val() || {};
            const availableYears = Object.keys(yearsData).sort((a,b) => b-a);
            
            yearSelector.innerHTML = '';
            availableYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelector.appendChild(option);
            });

            if (availableYears.includes(String(viewedYear))) {
                yearSelector.value = viewedYear;
            } else if (availableYears.length > 0) {
                viewedYear = availableYears[0];
                yearSelector.value = viewedYear;
            }
            liveExamsRef = db.ref(`academicYears/${viewedYear}/data/liveExams`);
            
            await fetchDataForYear(viewedYear);
            renderPage(currentPage);
        } catch (error) {
            console.error(error);
            showToast("প্রাথমিক তথ্য লোড করা সম্ভব হয়নি।", "error");
        } finally {
            hideLoader();
        }
    }

    yearSelector.addEventListener('change', () => {
        const selectedYear = yearSelector.value;
        if (selectedYear !== viewedYear) {
            viewedYear = selectedYear;
            localStorage.setItem('adminViewedYear', viewedYear);
            fullDataCache[viewedYear] = null;
            liveExamsRef = db.ref(`academicYears/${viewedYear}/data/liveExams`);
            fetchDataForYear(viewedYear).then(() => {
                renderPage(currentPage);
            });
        }
    });

    navLinks.forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); const page = e.currentTarget.dataset.page; if (page) { navLinks.forEach(l => l.classList.remove('active')); e.currentTarget.classList.add('active'); currentPage = page; renderPage(page); } }); });
    
    async function fetchDataForYear(year) { if (fullDataCache[year]) return fullDataCache[year]; showLoader(`শিক্ষাবর্ষ ${year} এর তথ্য লোড হচ্ছে...`); try { const snapshot = await academicYearsRef.child(year).child('data').once('value'); fullDataCache[year] = snapshot.val() || {}; return fullDataCache[year]; } catch (e) { showToast(`শিক্ষাবর্ষ ${year} এর তথ্য লোড করা যায়নি।`, 'error'); return null; } finally { hideLoader(); } }
    
    function renderPage(page) { 
        const template = document.getElementById(`template-${page}`); 
        if (template) { 
            mainContent.innerHTML = ''; 
            mainContent.appendChild(template.content.cloneNode(true)); 
            const pageRenderers = {
                'dashboard': renderDashboard,
                'notices': renderNotices,
                'students': renderStudents,
                'id-cards': renderIdCards,
                'lottery': renderLottery,
                'live-exams': renderLiveExams
            };
            if (pageRenderers[page]) {
                pageRenderers[page]();
            }
        } 
    }
    
    function findBatchById(batchId) {
        const data = fullDataCache[viewedYear] || {};
        if (!data.batchSchedule) return null;
        for (const day of data.batchSchedule) {
            for (const cls of (day.classes || [])) {
                const batch = (cls.batches || []).find(b => b.id === batchId);
                if (batch) {
                    const classInfo = (data.mainClassCategories || []).find(c => c.id === cls.classId);
                    return { batch, class: classInfo, day };
                }
            }
        }
        return null;
    }
    
    async function renderDashboard() {
        showLoader();
        try {
            document.getElementById('dashboard-header').textContent = `ড্যাশবোর্ড (শিক্ষাবর্ষ: ${viewedYear})`;
            const yearData = await fetchDataForYear(viewedYear);
            let totalStudents = 0, totalBatches = 0;
            if(yearData && yearData.students) {
                totalStudents = yearData.students.filter(s => s && !s.deletedAt).length;
            }
            if(yearData && yearData.batchSchedule) {
                yearData.batchSchedule.forEach(day => {
                    (day.classes || []).forEach(cls => {
                        totalBatches += (cls.batches || []).filter(b => b && !b.deletedAt).length;
                    });
                });
            }
            const noticesSnapshot = await noticesRef.once('value');
            let totalNotices = 0;
            if(noticesSnapshot.exists()){
                noticesSnapshot.forEach(child => {
                    const notice = child.val();
                    if(!notice.targetYear || notice.targetYear == viewedYear){
                        totalNotices++;
                    }
                });
            }
            document.getElementById('total-students').textContent = totalStudents.toLocaleString('bn-BD');
            document.getElementById('total-batches').textContent = totalBatches.toLocaleString('bn-BD');
            document.getElementById('total-notices').textContent = totalNotices.toLocaleString('bn-BD');
        } catch(e) { console.error(e); showToast("ড্যাশবোর্ডের তথ্য লোড করা যায়নি", "error"); }
        finally { hideLoader(); }
    }

    async function renderNotices() {
        const yearSelect = document.getElementById('target-year');
        const classSelect = document.getElementById('target-class');
        const batchSelect = document.getElementById('target-batch');
        const noticeForm = document.getElementById('notice-form');
        const fileInput = document.getElementById('notice-image');
        const fileChosen = document.getElementById('file-chosen');

        fileInput.addEventListener('change', () => { fileChosen.textContent = fileInput.files.length > 0 ? fileInput.files[0].name : 'কোনো ফাইল বাছাই করা হয়নি'; });

        const yearsSnapshot = await academicYearsRef.once('value');
        const years = Object.keys(yearsSnapshot.val() || {}).sort((a,b) => b-a);
        years.forEach(y => yearSelect.add(new Option(y, y)));
        
        const lastSelectedNoticeYear = localStorage.getItem('lastSelectedNoticeYear');
        if (lastSelectedNoticeYear && years.includes(lastSelectedNoticeYear)) {
            yearSelect.value = lastSelectedNoticeYear;
        } else {
            yearSelect.value = viewedYear;
        }

        yearSelect.onchange = async () => {
            const year = yearSelect.value;
            localStorage.setItem('lastSelectedNoticeYear', year);
            classSelect.innerHTML = '<option value="">সকল ক্লাস</option>'; classSelect.disabled = !year;
            batchSelect.innerHTML = '<option value="">সকল ব্যাচ</option>'; batchSelect.disabled = true;
            if (!year) return;
            const data = await fetchDataForYear(year);
            if (data && data.mainClassCategories) {
                (data.mainClassCategories || []).filter(c => c && !c.deletedAt).forEach(c => classSelect.add(new Option(c.name, c.id)));
            }
        };
        if (yearSelect.value) yearSelect.dispatchEvent(new Event('change'));
        
        classSelect.onchange = async () => {
            const year = yearSelect.value; const classId = classSelect.value;
            batchSelect.innerHTML = '<option value="">সকল ব্যাচ</option>'; batchSelect.disabled = !classId;
            if (!year || !classId) return;
            const data = await fetchDataForYear(year);
            if (data && data.batchSchedule) {
                const batches = new Map();
                (data.batchSchedule || []).forEach(day => (day.classes || []).filter(c => c && c.classId === classId).forEach(cls => (cls.batches || []).forEach(b => { if (b && !b.deletedAt && !batches.has(b.id)) batches.set(b.id, `${day.dayName} (${b.time})`); })));
                batches.forEach((name, id) => batchSelect.add(new Option(name, id)));
            }
        };

        noticeForm.onsubmit = async (e) => {
            e.preventDefault(); showLoader("নোটিশ পোস্ট করা হচ্ছে..."); let imageUrlAsBase64 = null;
            if (fileInput.files[0]) { try { imageUrlAsBase64 = await resizeAndEncodeImage(fileInput.files[0], 800, 500 * 1024); } catch (error) { showToast(error.message, "error"); hideLoader(); return; } }
            const noticeData = { title: document.getElementById('notice-title').value, content: document.getElementById('notice-content').value, imageUrl: imageUrlAsBase64, timestamp: firebase.database.ServerValue.TIMESTAMP, targetYear: yearSelect.value || null, targetClassIds: classSelect.value ? [classSelect.value] : null, targetBatchIds: batchSelect.value ? [batchSelect.value] : null };
            try { await noticesRef.push(noticeData); showToast("নোটিশ সফলভাবে পোস্ট করা হয়েছে!", "success"); noticeForm.reset(); fileChosen.textContent = 'কোনো ফাইল বাছাই করা হয়নি'; yearSelect.value = localStorage.getItem('lastSelectedNoticeYear') || viewedYear; yearSelect.dispatchEvent(new Event('change')); } catch (error) { showToast("নোটিশ পোস্ট করা যায়নি।", "error"); } finally { hideLoader(); }
        };

        function resizeAndEncodeImage(file, maxWidth, maxSizeBytes) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = (event) => { const img = new Image(); img.src = event.target.result; img.onload = () => { const canvas = document.createElement('canvas'); let width = img.width; let height = img.height; if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; } canvas.width = width; canvas.height = height; canvas.getContext('2d').drawImage(img, 0, 0, width, height); let quality = 0.9; let dataUrl = canvas.toDataURL('image/jpeg', quality); while (dataUrl.length > maxSizeBytes && quality > 0.1) { quality -= 0.1; dataUrl = canvas.toDataURL('image/jpeg', quality); } if (dataUrl.length > maxSizeBytes) return reject(new Error('ছবি রিসাইজ করার পরেও ৫০০কেবি-র বেশি।')); resolve(dataUrl); }; img.onerror = () => reject(new Error('ছবি লোড করা সম্ভব হয়নি।')); }; reader.onerror = error => reject(error); }); }
        
        const historyContainer = document.getElementById('notice-history-container');
        noticesRef.orderByChild('timestamp').limitToLast(50).on('value', snapshot => { historyContainer.innerHTML = ''; if(!snapshot.exists()){ historyContainer.innerHTML = '<p>কোনো নোটিশের ইতিহাস পাওয়া যায়নি।</p>'; return; } const notices = []; snapshot.forEach(child => notices.push({id: child.key, ...child.val()})); notices.reverse().forEach(notice => { const item = document.createElement('div'); item.className = 'notice-history-item'; item.innerHTML = `<div><strong>${notice.title}</strong><br><small>${new Date(notice.timestamp).toLocaleString('bn-BD')}</small></div><button class="btn-danger" style="padding: 5px 10px; font-size:0.9em; margin:0;" data-id="${notice.id}">ডিলিট</button>`; item.querySelector('button').addEventListener('click', async () => { if(confirm(`আপনি কি '${notice.title}' নোটিশটি মুছে ফেলতে চান?`)){ await noticesRef.child(notice.id).remove(); showToast('নোটিশ ডিলিট করা হয়েছে।', 'info'); } }); historyContainer.appendChild(item); }); });
    }

    async function renderStudents() {
        const classSelect = document.getElementById('filter-class-student');
        const batchSelect = document.getElementById('filter-batch-student');
        const searchInput = document.getElementById('student-search');
        const tableBody = document.getElementById('student-list-body');
        let currentStudentList = [];

        const data = await fetchDataForYear(viewedYear);
        classSelect.innerHTML = '<option value="">ক্লাস বাছাই</option>';
        if (data && data.mainClassCategories) {
            (data.mainClassCategories || []).filter(c => c && !c.deletedAt).forEach(c => classSelect.add(new Option(c.name, c.id)));
        }
        
        classSelect.onchange = async () => {
            const classId = classSelect.value;
            batchSelect.innerHTML = '<option value="">ব্যাচ বাছাই</option>'; batchSelect.disabled = !classId;
            if (!classId) { tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">ক্লাস বাছাই করুন</td></tr>'; return; }
            if (data && data.batchSchedule) {
                const batches = new Map();
                (data.batchSchedule || []).forEach(day => (day.classes || []).filter(c => c && c.classId === classId).forEach(cls => (cls.batches || []).forEach(b => { if (b && !b.deletedAt && !batches.has(b.id)) batches.set(b.id, `${day.dayName} (${b.time})`); })));
                batches.forEach((name, id) => batchSelect.add(new Option(name, id)));
            }
        };

        const displayStudents = () => { tableBody.innerHTML = ''; const searchTerm = searchInput.value.toLowerCase(); const filtered = currentStudentList.filter(s => s.name.toLowerCase().includes(searchTerm) || s.roll.toString().includes(searchTerm)); if (filtered.length === 0) { tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">কোনো ছাত্রছাত্রী পাওয়া যায়নি।</td></tr>'; return; } filtered.forEach(s => { tableBody.innerHTML += `<tr><td>${s.roll}</td><td>${s.name}</td><td>${s.className}</td><td>${s.parentContact || 'N/A'}</td></tr>`; }); };
        batchSelect.onchange = async () => {
            const batchId = batchSelect.value; 
            tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">লোড হচ্ছে...</td></tr>';
            if (!batchId) { currentStudentList = []; tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">ব্যাচ বাছাই করুন</td></tr>'; return; }
            if (!data || !data.students) { tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">এই শিক্ষাবর্ষে ছাত্রছাত্রীর তথ্য নেই।</td></tr>'; return; }
            
            const batchInfo = findBatchById(batchId);
            const studentIds = batchInfo?.batch?.studentIds || [];
            
            const classMap = new Map((data.mainClassCategories || []).map(c => [c.id, c.name]));
            currentStudentList = (data.students || []).filter(s => s && !s.deletedAt && studentIds.includes(s.id)).map(s => ({...s, className: classMap.get(s.classId) || 'N/A'})).sort((a, b) => (parseInt(a.roll) || 0) - (parseInt(b.roll) || 0));
            displayStudents();
        };
        searchInput.onkeyup = displayStudents;
    }

    // --- ID Card Logic ---
    function renderIdCards() {
        const classSelect = document.getElementById('filter-class-idcard');
        const batchSelect = document.getElementById('filter-batch-idcard');
        const tableBody = document.getElementById('idcard-student-list-body');
        const downloadAllBtn = document.getElementById('btn-download-batch-idcards');
        let currentBatchStudents = [];

        const data = fullDataCache[viewedYear];
        classSelect.innerHTML = '<option value="">ক্লাস বাছাই</option>';
        if (data && data.mainClassCategories) {
            (data.mainClassCategories || []).filter(c => c && !c.deletedAt).forEach(c => classSelect.add(new Option(c.name, c.id)));
        }
        
        classSelect.onchange = async () => {
            const classId = classSelect.value;
            batchSelect.innerHTML = '<option value="">ব্যাচ বাছাই</option>';
            batchSelect.disabled = !classId;
            downloadAllBtn.disabled = true;
            tableBody.innerHTML = `<tr><td colspan="4" style="text-align:center;">${classId ? 'ব্যাচ বাছাই করুন' : 'ক্লাস বাছাই করুন'}</td></tr>`;
            if (!classId) return;

            if (data && data.batchSchedule) {
                const batches = new Map();
                (data.batchSchedule || []).forEach(day => (day.classes || []).filter(c => c && c.classId === classId).forEach(cls => (cls.batches || []).forEach(b => { if (b && !b.deletedAt && !batches.has(b.id)) batches.set(b.id, `${day.dayName} (${b.time})`); })));
                batches.forEach((name, id) => batchSelect.add(new Option(name, id)));
            }
        };

        batchSelect.onchange = async () => {
            const batchId = batchSelect.value;
            tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">লোড হচ্ছে...</td></tr>';
            downloadAllBtn.disabled = !batchId;
            if (!batchId) { tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">ব্যাচ বাছাই করুন</td></tr>'; return; }
            
            const batchInfo = findBatchById(batchId);
            const studentIds = batchInfo?.batch?.studentIds || [];
            const classMap = new Map((data.mainClassCategories || []).map(c => [c.id, c.name]));
            currentBatchStudents = (data.students || []).filter(s => s && !s.deletedAt && studentIds.includes(s.id)).map(s => ({...s, className: classMap.get(s.classId) || 'N/A'})).sort((a, b) => (parseInt(a.roll) || 0) - (parseInt(b.roll) || 0));
            
            tableBody.innerHTML = '';
            if (currentBatchStudents.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">এই ব্যাচে কোনো ছাত্রছাত্রী নেই।</td></tr>';
                return;
            }
            currentBatchStudents.forEach(s => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${s.roll}</td><td>${s.name}</td><td>${s.className}</td>
                <td>
                    <button class="btn-secondary" style="font-size: 0.8em; padding: 5px 10px; margin:0;" data-action="view" data-id="${s.id}">View</button>
                    <button class="btn-primary" style="font-size: 0.8em; padding: 5px 10px; margin:0;" data-action="download" data-id="${s.id}">Download PDF</button>
                </td>`;
                tableBody.appendChild(tr);
            });
        };

        tableBody.addEventListener('click', async (e) => {
            const button = e.target.closest('button[data-action]');
            if (!button) return;
            const studentId = button.dataset.id;
            const student = currentBatchStudents.find(s => s.id === studentId);
            if (!student) return;

            if (button.dataset.action === 'view') {
                await generateIdCardPreview(student);
            } else if (button.dataset.action === 'download') {
                showLoader(`Generating PDF for ${student.name}...`);
                await downloadIdCardAsPdf(student);
                hideLoader();
            }
        });

        downloadAllBtn.addEventListener('click', async () => {
            if (currentBatchStudents.length === 0) return showToast('No students to generate ID cards for.', 'info');
            const batchName = batchSelect.options[batchSelect.selectedIndex].text.replace(/[():]/g, '').trim();
            const className = classSelect.options[classSelect.selectedIndex].text;
            const fileName = `${className}_${batchName}_ID_Cards.pdf`;
            await downloadAllBatchIdCards(currentBatchStudents, fileName);
        });
    }

    async function generateIdCardDOM(student) {
        const data = fullDataCache[viewedYear];
        const studentBatchesText = (data.batchSchedule || [])
            .filter(d => d && !d.deletedAt).flatMap(day => (day.classes || []).filter(c=> c && !c.deletedAt).flatMap(cls => (cls.batches || []).filter(b => b && !b.deletedAt && (b.studentIds || []).includes(student.id)).map(b => `${day.dayName} (${b.time})`))).join(', ');
        
        const frontTemplate = document.getElementById('template-id-card-single-front').content.cloneNode(true);
        const backTemplate = document.getElementById('template-id-card-single-back').content.cloneNode(true);

        const frontCard = frontTemplate.querySelector('.id-card-container');
        const backCard = backTemplate.querySelector('.id-card-container');
        
        frontCard.querySelector('[data-id-field="photo"]').src = student.photoURL || 'images/default_avatar.png';
        frontCard.querySelector('[data-id-field="name"]').textContent = student.name || 'N/A';
        frontCard.querySelector('[data-id-field="school"]').textContent = student.schoolName || 'N/A';
        frontCard.querySelector('[data-id-field="class"]').textContent = student.className || 'N/A';
        frontCard.querySelector('[data-id-field="roll"]').textContent = student.roll || 'N/A';
        frontCard.querySelector('[data-id-field="contact"]').textContent = student.parentContact || 'N/A';
        frontCard.querySelector('[data-id-field="batch"]').textContent = studentBatchesText.split(', ')[0] || 'N/A';
        frontCard.querySelector('[data-id-field="sid"]').textContent = student.id || 'N/A';
        
        const qrContainer = backCard.querySelector('[data-id-field="qr"]');
        qrContainer.innerHTML = '';
        new QRCode(qrContainer, { text: `https://miracle-bogura.web.app/verify?id=${student.id}`, width: 128, height: 128, correctLevel: QRCode.CorrectLevel.H });

        return { front: frontCard, back: backCard };
    }

    async function generateIdCardPreview(student) {
        const previewArea = document.getElementById('id-card-preview-area');
        previewArea.innerHTML = '';
        const { front, back } = await generateIdCardDOM(student);
        const container = document.createElement('div');
        container.style.display = 'flex';
        container.style.gap = '20px';
        container.appendChild(front);
        container.appendChild(back);
        previewArea.appendChild(container);
        previewArea.style.display = 'flex';
        previewArea.onclick = () => previewArea.style.display = 'none';
    }

    async function downloadIdCardAsPdf(student) {
        const { front, back } = await generateIdCardDOM(student);
        const tempContainer = document.createElement('div');
        tempContainer.style.position = 'absolute'; tempContainer.style.left = '-9999px';
        tempContainer.appendChild(front);
        tempContainer.appendChild(back);
        document.body.appendChild(tempContainer);
        
        const { jsPDF } = window.jspdf;
        const frontCanvas = await html2canvas(front, { scale: 3 });
        const backCanvas = await html2canvas(back, { scale: 3 });
        
        const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: [54, 86] });
        doc.addImage(frontCanvas.toDataURL('image/jpeg', 0.95), 'JPEG', 0, 0, 54, 86);
        doc.addPage();
        doc.addImage(backCanvas.toDataURL('image/jpeg', 0.95), 'JPEG', 0, 0, 54, 86);
        
        doc.save(`Miracle_ID_Card_${student.name}_${student.roll}.pdf`);
        document.body.removeChild(tempContainer);
    }
    
    async function downloadAllBatchIdCards(students, fileName) {
        const progressDiv = document.getElementById('id-card-generation-progress');
        progressDiv.style.display = 'block';
        showLoader('Preparing PDF...');

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: [54, 86] });
        
        for (let i = 0; i < students.length; i++) {
            const student = students[i];
            progressDiv.textContent = `Processing ${i + 1} of ${students.length}: ${student.name}`;
            
            const { front, back } = await generateIdCardDOM(student);
            const tempContainer = document.createElement('div');
            tempContainer.style.position = 'absolute'; tempContainer.style.left = '-9999px';
            tempContainer.appendChild(front);
            tempContainer.appendChild(back);
            document.body.appendChild(tempContainer);

            const frontCanvas = await html2canvas(front, { scale: 3 });
            const backCanvas = await html2canvas(back, { scale: 3 });
            
            if (i > 0) doc.addPage();
            doc.addImage(frontCanvas.toDataURL('image/jpeg', 0.95), 'JPEG', 0, 0, 54, 86);
            doc.addPage();
            doc.addImage(backCanvas.toDataURL('image/jpeg', 0.95), 'JPEG', 0, 0, 54, 86);
            
            document.body.removeChild(tempContainer);
        }

        progressDiv.textContent = 'Saving PDF...';
        doc.save(fileName);
        progressDiv.style.display = 'none';
        hideLoader();
    }
    
    // --- Lottery Logic ---
    async function renderLottery() {
        const monthSelector = document.getElementById('lottery-month-selector');
        
        monthSelector.innerHTML = '';
        BENGALI_MONTHS.forEach((month, index) => {
            const option = new Option(month, month);
            monthSelector.add(option);
        });
        monthSelector.value = BENGALI_MONTHS[new Date().getMonth()];

        monthSelector.addEventListener('change', () => {
            displayBatchesForLottery(monthSelector.value);
        });

        displayBatchesForLottery(monthSelector.value);
    }

    async function displayBatchesForLottery(month) {
        const gridContainer = document.getElementById('lottery-batch-grid-container');
        gridContainer.innerHTML = '<p>ব্যাচগুলোর তথ্য লোড হচ্ছে...</p>';
        const yearData = await fetchDataForYear(viewedYear);
        if (!yearData || !yearData.batchSchedule) {
            gridContainer.innerHTML = '<p>এই শিক্ষাবর্ষে কোনো ব্যাচ পাওয়া যায়নি।</p>';
            return;
        }

        const allBatches = [];
        yearData.batchSchedule.forEach(day => {
            if(!day || !day.classes) return;
            day.classes.forEach(cls => {
                const className = (yearData.mainClassCategories.find(c => c.id === cls.classId) || {}).name;
                (cls.batches || []).forEach(b => {
                    if (b && !b.deletedAt) {
                        allBatches.push({ ...b, dayName: day.dayName, className: className });
                    }
                });
            });
        });

        if(allBatches.length === 0) {
            gridContainer.innerHTML = '<p>কোনো সক্রিয় ব্যাচ নেই।</p>';
            return;
        }

        gridContainer.innerHTML = '';
        const lotteryResultsSnapshot = await academicYearsRef.child(`${viewedYear}/data/lotteryResults/${month}`).once('value');
        const lotteryResults = lotteryResultsSnapshot.val() || {};

        const uniqueBatches = [...new Map(allBatches.map(item => [item.id, item])).values()];

        uniqueBatches.forEach(batch => {
            const card = document.createElement('div');
            card.className = 'lottery-batch-card';
            const result = lotteryResults[batch.id];

            let content = `<h4>${batch.className} - ${batch.dayName} (${batch.time})`;

            if (result) {
                card.classList.add('completed');
                content += `<span>✔️</span></h4>
                            <span class="status status-completed">See Winners</span>
                            <p><strong>বিজয়ীরা:</strong></p>
                            <ol class="winner-list">
                                ${result.winners.map(w => `<li>${w.position} Prize: ${w.name} (রোল: ${w.roll})</li>`).join('')}
                            </ol>`;
            } else {
                content += `</h4><span class="status status-ready">Ready to Run</span>
                            <p>এই ব্যাচের জন্য ${month} মাসের লটারি এখনো অনুষ্ঠিত হয়নি।</p>
                            <button data-batch-id="${batch.id}" data-month="${month}">Run Lottery</button>`;
            }
            card.innerHTML = content;
            gridContainer.appendChild(card);
        });

        gridContainer.querySelectorAll('button[data-batch-id]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                showLotteryModal(btn.dataset.batchId, btn.dataset.month);
            });
        });
        
        gridContainer.querySelectorAll('.lottery-batch-card.completed').forEach(card => {
            card.addEventListener('click', () => {
                card.querySelector('.winner-list').style.display = card.querySelector('.winner-list').style.display === 'block' ? 'none' : 'block';
            });
        });
    }

    async function showLotteryModal(batchId, month) {
        if(document.getElementById('lottery-run-modal')) document.getElementById('lottery-run-modal').remove();
        
        const modalTemplate = document.getElementById('template-lottery-modal');
        document.body.appendChild(modalTemplate.content.cloneNode(true));
        const modal = document.getElementById('lottery-run-modal');
        const closeModalBtn = modal.querySelector('.modal-close-btn');
        
        const yearData = await fetchDataForYear(viewedYear);
        const batchDetails = findBatchById(batchId);

        if (!batchDetails) {
            showToast('Batch details could not be found.', 'error');
            modal.remove();
            return;
        }

        modal.querySelector('#lottery-modal-title').textContent = `Run Lottery for ${batchDetails.class.name} (${batchDetails.batch.time}) - ${month}`;
        
        const presentOnlyCheckbox = modal.querySelector('#lottery-present-only');
        const participantCountSpan = modal.querySelector('#participant-count');
        const startLotteryBtn = modal.querySelector('#start-lottery-btn');
        
        let allEligibleStudents = [];

        const getEligibleStudents = async (presentOnly = false) => {
            showLoader('Fetching participants...');
            const allStudents = yearData.students || [];
            
            let presentStudentIds = new Set();
            if (presentOnly) {
                const today = new Date().toISOString().split('T')[0];
                const attendanceSnapshot = await academicYearsRef.child(`${viewedYear}/data/attendance/records/${today}/${batchId}`).once('value');
                const attendanceData = attendanceSnapshot.val() || {};
                Object.keys(attendanceData).forEach(studentId => {
                    if (attendanceData[studentId].status === 'present') {
                        presentStudentIds.add(studentId);
                    }
                });
            }

            const paidStudents = allStudents.filter(s => {
                if (!s || s.deletedAt) return false;
                const payment = s.monthlyPayments?.[month];
                const isInBatch = (batchDetails.batch.studentIds || []).includes(s.id);
                const isPaid = payment?.status === 'paid';
                const isPresent = presentOnly ? presentStudentIds.has(s.id) : true;
                return isInBatch && isPaid && isPresent;
            });
            hideLoader();
            return paidStudents;
        };

        const updateParticipantsUI = async (presentOnly) => {
            const students = await getEligibleStudents(presentOnly);
            allEligibleStudents = students;
            participantCountSpan.textContent = students.length;
            startLotteryBtn.disabled = students.length === 0;
        };

        await updateParticipantsUI(false);

        presentOnlyCheckbox.addEventListener('change', async () => {
            await updateParticipantsUI(presentOnlyCheckbox.checked);
        });

        startLotteryBtn.addEventListener('click', () => {
            const winnerCount = parseInt(modal.querySelector('#lottery-winner-count').value, 10);
            if(allEligibleStudents.length < winnerCount) {
                showToast(`অংশগ্রহণকারীর সংখ্যা (${allEligibleStudents.length}) বিজয়ীর সংখ্যা (${winnerCount}) থেকে কম।`, 'error');
                return;
            }
            modal.remove();
            startLotteryAnimation(batchId, month, allEligibleStudents, winnerCount);
        });

        closeModalBtn.onclick = () => modal.remove();
    }

    async function startLotteryAnimation(batchId, month, participants, winnerCount) {
        if(document.getElementById('lottery-animation-screen')) document.getElementById('lottery-animation-screen').remove();
        const animationTemplate = document.getElementById('template-lottery-animation');
        document.body.appendChild(animationTemplate.content.cloneNode(true));
        
        const screen = document.getElementById('lottery-animation-screen');
        const namesReel = screen.querySelector('.names-reel');
        const winnerBox = screen.querySelector('.winner-announcement-box');
        const winnerTitle = screen.querySelector('#winner-title');
        const winnerName = screen.querySelector('#winner-name');
        const vipList = screen.querySelector('#vip-winners-list');
        const findBtn = screen.querySelector('#find-winner-btn');
        const saveBtn = screen.querySelector('#save-lottery-btn');
        const lotterySound = document.getElementById('lottery-sound');

        screen.classList.add('visible');

        let reelHtml = '';
        for(let i = 0; i < 50; i++) {
            reelHtml += `<div>${participants[Math.floor(Math.random() * participants.length)].name}</div>`;
        }
        namesReel.innerHTML = reelHtml;

        let winners = [];
        let currentParticipants = [...participants];

        const lotteryHistorySnapshot = await academicYearsRef.child(`${viewedYear}/data/lotteryResults`).once('value');
        const lotteryHistory = lotteryHistorySnapshot.val() || {};
        const pastWinnerIds = new Set();
        Object.values(lotteryHistory).forEach(monthData => {
            Object.values(monthData).forEach(batchData => {
                batchData.winners.forEach(winner => pastWinnerIds.add(winner.id));
            });
        });

        function getWeightedRandomWinner() {
            if (currentParticipants.length === 0) return null;
            const weights = currentParticipants.map(p => pastWinnerIds.has(p.id) ? 0.8 : 1.0); // 20% luck reduction for past winners
            const totalWeight = weights.reduce((sum, weight) => sum + weight, 0);
            let random = Math.random() * totalWeight;
            for (let i = 0; i < currentParticipants.length; i++) {
                random -= weights[i];
                if (random < 0) return currentParticipants[i];
            }
            return currentParticipants[currentParticipants.length - 1]; // Fallback
        }
        
        function updateFindButtonText() {
            const prizeNumber = getOrdinal(winnerCount - winners.length);
            findBtn.textContent = `Find ${prizeNumber} Prize Winner`;
        }
        
        findBtn.onclick = () => {
            if (winners.length >= winnerCount) return;

            winnerBox.classList.remove('show');
            namesReel.style.animation = 'reel-spin 0.1s linear infinite';
            lotterySound.currentTime = 0;
            lotterySound.play().catch(e => console.log("Audio play failed"));
            findBtn.disabled = true;

            setTimeout(() => {
                lotterySound.pause();
                namesReel.style.animation = 'none';
                
                const winner = getWeightedRandomWinner();
                if(!winner) {
                    showToast("No more participants left.", "warning");
                    findBtn.style.display = 'none';
                    saveBtn.style.display = 'inline-block';
                    return;
                }

                const prizeNumber = winnerCount - winners.length;
                const prizeText = `${getOrdinal(prizeNumber)} Prize`;

                winners.unshift({ position: prizeText, name: winner.name, roll: winner.roll, id: winner.id });
                currentParticipants = currentParticipants.filter(p => p.id !== winner.id);
                
                winnerTitle.textContent = `${prizeText} বিজয়ী`;
                winnerName.textContent = `${winner.name} (রোল: ${winner.roll})`;
                winnerBox.classList.add('show');

                const li = document.createElement('li');
                li.innerHTML = `<strong>${prizeText}:</strong> ${winner.name}`;
                vipList.appendChild(li);
                
                findBtn.disabled = false;
                
                if (winners.length >= winnerCount) {
                    findBtn.style.display = 'none';
                    saveBtn.style.display = 'inline-block';
                } else {
                    updateFindButtonText();
                }

            }, 10000); // 10 seconds of spinning
        };

        saveBtn.onclick = async () => {
            showLoader('Saving results...');
            const finalWinnersData = {
                timestamp: new Date().toISOString(),
                winners: winners
            };
            try {
                await academicYearsRef.child(`${viewedYear}/data/lotteryResults/${month}/${batchId}`).set(finalWinnersData);
                showToast('ফলাফল সফলভাবে সেভ হয়েছে!', 'success');
                screen.remove();
                displayBatchesForLottery(month);
            } catch (error) {
                showToast('Failed to save results.', 'error');
            } finally {
                hideLoader();
            }
        };

        updateFindButtonText();
    }

    
    // --- Live Exam Logic ---
    function renderLiveExams() {
        document.getElementById('btn-create-new-exam').addEventListener('click', () => openCreateExamModal());
        liveExamsRef.on('value', snapshot => {
            const exams = snapshot.val() || {};
            const container = document.getElementById('live-exam-list-container');
            container.innerHTML = '';
            if (Object.keys(exams).length === 0) {
                container.innerHTML = '<p>কোনো পরীক্ষা তৈরি করা হয়নি।</p>';
                return;
            }
            Object.entries(exams).sort(([, a], [, b]) => (b.createdAt || 0) - (a.createdAt || 0)).forEach(([id, exam]) => {
                const item = document.createElement('div');
                item.className = 'exam-list-item';
                const isPublished = exam.resultsPublished;
                item.innerHTML = `
                    <div>
                        <h4>${exam.title}</h4>
                        <div class="exam-info">
                            <span>সময়: ${exam.duration} মিনিট</span> |
                            <span>স্ট্যাটাস: <span class="publish-status ${isPublished ? 'status-published' : 'status-unpublished'}">${isPublished ? 'Published' : 'Unpublished'}</span></span>
                        </div>
                    </div>
                    <div>
                        <button class="btn-secondary" data-action="results" data-id="${id}" style="margin-top:0;font-size:0.9em;padding:8px 15px;">ফলাফল</button>
                        <button class="btn-primary" data-action="publish" data-id="${id}" ${isPublished ? 'disabled' : ''} style="margin-top:0;font-size:0.9em;padding:8px 15px;">${isPublished ? 'Published' : 'Publish Result'}</button>
                    </div>`;
                container.appendChild(item);
            });
            container.addEventListener('click', handleExamListAction);
        });
    }

    function openCreateExamModal(examId = null) {
        if (document.getElementById('create-exam-modal')) {
            document.getElementById('create-exam-modal').remove();
        }
        const modalTemplate = document.getElementById('template-create-exam-modal');
        if (!modalTemplate) {
            return showToast('Exam modal template not found!', 'error');
        }
        document.body.appendChild(modalTemplate.content.cloneNode(true));

        const modal = document.getElementById('create-exam-modal');
        const form = document.getElementById('exam-details-form');
        form.reset();
        document.getElementById('questions-container').innerHTML = '';

        const examTypeSelect = document.getElementById('exam-type');
        const scheduleGroup = document.getElementById('exam-schedule-group');
        const startTimeInput = document.getElementById('exam-start-time');
        
        examTypeSelect.onchange = (e) => {
            const isScheduled = e.target.value === 'scheduled';
            scheduleGroup.style.display = isScheduled ? 'block' : 'none';
            startTimeInput.required = isScheduled;
        };
        examTypeSelect.dispatchEvent(new Event('change'));

        modal.querySelector('.modal-close-btn').onclick = () => modal.classList.remove('visible');
        document.getElementById('add-question-btn').onclick = () => addQuestionField();
        document.getElementById('save-exam-btn').onclick = () => saveExam(examId);

        addQuestionField();
        modal.classList.add('visible');
    }

    function addQuestionField(question = { text: '', options: ['', '', '', ''], correct: 0 }) {
        const container = document.getElementById('questions-container');
        const qIndex = container.children.length;
        const editor = document.createElement('div');
        editor.className = 'question-editor';
        editor.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <label style="font-weight:bold;">প্রশ্ন ${qIndex + 1}</label>
                <button type="button" class="btn-danger" style="padding: 3px 8px; font-size: 0.8em; margin:0;" onclick="this.parentElement.parentElement.remove()">মুছুন</button>
            </div>
            <div class="form-group">
                <textarea class="question-text" required placeholder="প্রশ্নটি এখানে লিখুন...">${question.text}</textarea>
            </div>
            ${[0, 1, 2, 3].map(i => `
                <div class="option-group">
                    <input type="radio" name="correct-option-${qIndex}" value="${i}" ${i === question.correct ? 'checked' : ''} required>
                    <input type="text" class="option-text" placeholder="অপশন ${i + 1}" value="${question.options[i]}" required>
                </div>
            `).join('')}
        `;
        container.appendChild(editor);
        container.addEventListener('input', () => {
             document.getElementById('exam-total-marks').value = container.children.length;
        });
        document.getElementById('exam-total-marks').value = container.children.length;
    }
    
    async function saveExam(examId) {
        const title = document.getElementById('exam-title').value.trim();
        const duration = parseInt(document.getElementById('exam-duration').value, 10);
        const negativeMarking = parseFloat(document.getElementById('exam-negative-marking').value);
        const examType = document.getElementById('exam-type').value;
        const startTime = document.getElementById('exam-start-time').value;

        if (!title || !duration) return showToast('শিরোনাম এবং সময় আবশ্যক।', 'error');
        if (examType === 'scheduled' && !startTime) return showToast('সময়সূচী পরীক্ষার জন্য শুরুর সময় আবশ্যক।', 'error');

        const questions = [];
        const questionEditors = document.querySelectorAll('#questions-container .question-editor');
        for (const editor of questionEditors) {
            const text = editor.querySelector('.question-text').value.trim();
            const options = [...editor.querySelectorAll('.option-text')].map(input => input.value.trim());
            const correct = parseInt(editor.querySelector('input[type="radio"]:checked')?.value, 10);
            if (!text || options.some(opt => !opt) || isNaN(correct)) {
                return showToast('অনুগ্রহ করে সব প্রশ্ন এবং অপশন পূরণ করুন।', 'error');
            }
            questions.push({ text, options, correct });
        }
        
        if (questions.length === 0) return showToast('অনুগ্রহ করে অন্তত একটি প্রশ্ন যোগ করুন।', 'error');

        const examData = {
            title, duration, negativeMarking, examType,
            questions,
            totalMarks: questions.length,
            createdAt: firebase.database.ServerValue.TIMESTAMP,
            resultsPublished: false
        };

        if (examType === 'scheduled') {
            examData.startTime = new Date(startTime).getTime();
        }

        showLoader('Saving exam...');
        try {
            const ref = examId ? liveExamsRef.child(examId) : liveExamsRef.push();
            await ref.set(examData);
            showToast('পরীক্ষা সফলভাবে সংরক্ষণ করা হয়েছে!', 'success');
            document.getElementById('create-exam-modal').classList.remove('visible');
        } catch (error) {
            showToast('পরীক্ষা সংরক্ষণ করতে সমস্যা হয়েছে।', 'error');
        } finally {
            hideLoader();
        }
    }

    function handleExamListAction(e) {
        const button = e.target.closest('button[data-action]');
        if (!button) return;
        const examId = button.dataset.id;
        const action = button.dataset.action;

        if (action === 'results') {
            showExamResults(examId);
        } else if (action === 'publish') {
            if (confirm('আপনি কি ফলাফল প্রকাশ করতে চান? এরপর ছাত্রছাত্রীরা তাদের পোর্টালে ফলাফল দেখতে পাবে।')) {
                liveExamsRef.child(examId).child('resultsPublished').set(true)
                    .then(() => showToast('ফলাফল সফলভাবে প্রকাশ করা হয়েছে!', 'success'));
            }
        }
    }

    function showExamResults(examId) {
        liveExamsRef.child(examId).once('value', snapshot => {
            const exam = snapshot.val();
            if (!exam) return;
            
            const modalTemplate = document.getElementById('template-exam-results-modal');
            if(!modalTemplate) return;
            if(document.getElementById('exam-results-modal')) document.getElementById('exam-results-modal').remove();

            document.body.appendChild(modalTemplate.content.cloneNode(true));
            const resultsModal = document.getElementById('exam-results-modal');
            
            resultsModal.querySelector('#results-modal-title').textContent = `${exam.title} - ফলাফল`;
            const tbody = resultsModal.querySelector('#exam-results-tbody');
            tbody.innerHTML = '';
            
            const results = Object.entries(exam.submissions || {}).map(([studentId, data]) => ({ studentId, ...data }));
            results.sort((a, b) => b.score - a.score);

            if (results.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">এখনো কোনো ছাত্রছাত্রী পরীক্ষায় অংশগ্রহণ করেনি।</td></tr>';
            } else {
                let rank = 0;
                let lastScore = -Infinity;
                results.forEach((result, index) => {
                    if (result.score !== lastScore) {
                        rank = index + 1;
                        lastScore = result.score;
                    }
                    const student = (fullDataCache[viewedYear].students || []).find(s => s.id === result.studentId);
                    const studentBatches = (fullDataCache[viewedYear].batchSchedule || [])
                        .flatMap(day => (day.classes || []).flatMap(c => c.batches.map(b => ({ ...b, className: fullDataCache[viewedYear].mainClassCategories.find(mc => mc.id === c.classId)?.name, dayName: day.dayName }))))
                        .filter(b => b.studentIds?.includes(result.studentId))
                        .map(b => `${b.dayName.substring(0,3)} (${b.time})`)
                        .join(', ');

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${rank}</td>
                        <td>${student ? student.name : 'Unknown Student'}</td>
                        <td>${student ? student.roll : 'N/A'}</td>
                        <td>${studentBatches || 'N/A'}</td>
                        <td>${result.score.toFixed(2)} / ${exam.totalMarks}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }
            resultsModal.querySelector('.modal-close-btn').onclick = () => resultsModal.remove();
            resultsModal.classList.add('visible');
        });
    }

    initialize();
}

</script>
</body>
</html>
--- END OF FILE portaladmin.html ---